Rules Found: 1348
NamE: Query Registry using Built-in Tools
	description: 
		     This rule identifies the execution of commands
		     that can be used to query the Windows Registry. Adversaries may
		     query the registry to gain situational awareness about the
		     host, like installed security software, programs and settings.
	query: 
		     host.os.type:windows and event.category:process and
		     event.type:start and   (     (process.name.caseless:"reg.exe"
		     and process.args:"query") or
		     (process.name.caseless:("powershell.exe" or
		     "powershell_ise.exe" or "pwsh.exe") and      process.args:(
		     ("get-childitem" or "Get-ChildItem" or "gci" or "dir" or "ls"
		     or         "get-item" or "Get-Item" or "gi" or         "get-
		     itemproperty" or "Get-ItemProperty" or "gp") and        ("hkcu"
		     or "HKCU" or "hkey_current_user" or "HKEY_CURRENT_USER" or
		     "hkey_local_machine" or "HKEY_LOCAL_MACHINE" or         "hklm"
		     or "HKLM" or registry\:\:*)       )     )   ) and   not
		     process.command_line : (     "C:\\Windows\\system32\\reg.exe
		     query
		     hklm\\software\\microsoft\\windows\\softwareinventorylogging /v
		     collectionstate /reg:64" or     "reg  query
		     \"HKLM\\Software\\WOW6432Node\\Npcap\" /ve  "   )

NamE: Stolen Credentials Used to Login to Okta Account After MFA Reset
	description: 
		     Detects a sequence of suspicious activities on
		     Windows hosts indicative of credential compromise, followed by
		     efforts to undermine multi-factor authentication (MFA) and
		     single sign-on (SSO) mechanisms for an Okta user account.
	query: 
		     sequence by user.name with maxspan=12h     [any where
		     host.os.type == "windows" and signal.rule.threat.tactic.name ==
		     "Credential Access"]     [any where event.dataset ==
		     "okta.system" and okta.event_type == "user.mfa.factor.update"]
		     [any where event.dataset == "okta.system" and okta.event_type:
		     ("user.session.start", "user.authentication*")]

NamE: MFA Deactivation with no Re-Activation for Okta User Account
	description: 
		     Detects multi-factor authentication (MFA)
		     deactivation with no subsequent re-activation for an Okta user
		     account. An adversary may deactivate MFA for an Okta user
		     account in order to weaken the authentication requirements for
		     the account.
	query: 
		     sequence by okta.actor.id with maxspan=12h     [any
		     where event.dataset == "okta.system" and okta.event_type in
		     ("user.mfa.factor.deactivate", "user.mfa.factor.reset_all")
		     and okta.outcome.reason != "User reset SECURITY_QUESTION
		     factor" and okta.outcome.result == "SUCCESS"]     ![any where
		     event.dataset == "okta.system" and okta.event_type ==
		     "user.mfa.factor.activate"]

NamE: Okta Sign-In Events via Third-Party IdP
	description: 
		     Detects sign-in events where authentication is
		     carried out via a third-party Identity Provider (IdP).
	query: 
		     event.dataset:okta.system and okta.debug_context.debug
		     _data.request_uri:/oauth2/v1/authorize/callback and     (not
		     okta.authentication_context.issuer.id:Okta and
		     event.action:(user.authentication.auth_via_IDP         or
		     user.authentication.auth_via_inbound_SAML         or
		     user.authentication.auth_via_mfa         or
		     user.authentication.auth_via_social)         or
		     event.action:user.session.start) or
		     (event.action:user.authentication.auth_via_IDP and
		     okta.outcome.result:FAILURE         and okta.outcome.reason:("A
		     SAML assert with the same ID has already been processed by Okta
		     for a previous request"             or "Unable to match
		     transformed username"             or "Unable to resolve IdP
		     endpoint"             or "Unable to validate SAML Response"
		     or "Unable to validate incoming SAML Assertion"))

NamE: PowerShell Script with Password Policy Discovery Capabilities
	description: 
		     Identifies the use of Cmdlets and methods
		     related to remote execution activities using WinRM. Attackers
		     can abuse WinRM to perform lateral movement using built-in
		     tools.
	query: 
		     event.category: "process" and host.os.type:windows and
		     (   powershell.file.script_block_text: (     "Get-
		     ADDefaultDomainPasswordPolicy" or     "Get-
		     ADFineGrainedPasswordPolicy" or     "Get-
		     ADUserResultantPasswordPolicy" or     "Get-DomainPolicy" or
		     "Get-GPPPassword" or     "Get-PassPol"   )   or
		     powershell.file.script_block_text: (
		     ("defaultNamingContext" or "ActiveDirectory.DirectoryContext"
		     or "ActiveDirectory.DirectorySearcher") and     (       (
		     ".MinLengthPassword" or         ".MinPasswordAge" or
		     ".MaxPasswordAge"       ) or       (         "minPwdAge" or
		     "maxPwdAge" or         "minPwdLength"       ) or       (
		     "msDS-PasswordSettings"       )     )   ) ) and not
		     powershell.file.script_block_text : (     "sentinelbreakpoints"
		     and "Set-PSBreakpoint" and "PowerSploitIndicators"   )   and
		     not    (     powershell.file.script_block_text :
		     ("43c15630-959c-49e4-a977-758c5cc93408" and "CmdletsToExport"
		     and "ActiveDirectory.Types.ps1xml")   )   and not user.id :
		     "S-1-5-18"

NamE: Unusual Process Spawned from Web Server Parent
	description: 
		     This rule detects unusual processes spawned from
		     a web server parent process by identifying low frequency counts
		     of process spawning activity. Unusual process spawning activity
		     may indicate an attacker attempting to establish persistence,
		     execute malicious commands, or establish command and control
		     channels on the host system. ES|QL rules have limited fields
		     available in its alert documents. Make sure to review the
		     original documents to aid in the investigation of this alert.
	query: 
		     from logs-endpoint.events.process-* | keep @timestamp,
		     host.os.type, event.type, event.action, process.parent.name,
		     user.name, user.id, process.working_directory, process.name,
		     process.executable, process.command_line,
		     process.parent.executable, agent.id | where @timestamp > now()
		     - 1 hours | where host.os.type == "linux" and event.type ==
		     "start" and event.action == "exec" and (   process.parent.name
		     in (     "apache", "nginx", "apache2", "httpd", "lighttpd",
		     "caddy", "node", "mongrel_rails", "java", "gunicorn",
		     "uwsgi", "openresty", "cherokee", "h2o", "resin", "puma",
		     "unicorn", "traefik", "tornado", "hypercorn",     "daphne",
		     "twistd", "yaws", "webfsd", "httpd.worker", "flask", "rails",
		     "mongrel"   ) or   process.parent.name like "php-*" or
		     process.parent.name like "python*" or   process.parent.name
		     like "ruby*" or   process.parent.name like "perl*" or
		     user.name in (     "apache", "www-data", "httpd", "nginx",
		     "lighttpd", "tomcat", "tomcat8", "tomcat9", "ftp", "ftpuser",
		     "ftpd"   ) or   user.id in ("99", "33", "498", "48") or
		     process.working_directory like "/var/www/*" ) and not (
		     process.working_directory like "/home/*" or
		     process.working_directory like "/" or
		     process.parent.executable like "/vscode/vscode-server/*" ) |
		     stats cc = count(), agent_count = count_distinct(agent.id) by
		     process.executable, process.working_directory,
		     process.parent.executable | where agent_count == 1 and cc < 5 |
		     sort cc asc | limit 100

NamE: Unusual File Transfer Utility Launched
	description: 
		     This rule leverages ES|QL to detect the
		     execution of unusual file transfer utilities on Linux systems.
		     Attackers may use these utilities to exfiltrate data from a
		     compromised system. ES|QL rules have limited fields available
		     in its alert documents. Make sure to review the original
		     documents to aid in the investigation of this alert.
	query: 
		     from logs-endpoint.events.process-* | keep @timestamp,
		     host.os.type, event.type, event.action, process.name,
		     process.executable, process.parent.executable,
		     process.command_line, agent.id | where @timestamp > now() - 1
		     hours | where host.os.type == "linux" and event.type == "start"
		     and event.action == "exec" and   process.name in ("scp", "ftp",
		     "sftp", "vsftpd", "sftp-server", "rsync") | stats cc = count(),
		     agent_count = count_distinct(agent.id) by process.executable,
		     process.parent.executable, process.command_line | where
		     agent_count == 1 and cc < 5 | sort cc asc | limit 100

NamE: PowerShell Script with Log Clear Capabilities
	description: 
		     Identifies the use of Cmdlets and methods
		     related to Windows event log deletion activities. This is often
		     done by attackers in an attempt to evade detection or destroy
		     forensic evidence on a system.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (     "Clear-EventLog" or
		     "Remove-EventLog" or     ("Eventing.Reader.EventLogSession" and
		     ".ClearLog") or     ("Diagnostics.EventLog" and ".Clear")   )
		     and   not powershell.file.script_block_text : (
		     "CmdletsToExport=@(\"Add-Content\""   ) and   not
		     file.directory : "C:\Program Files\WindowsAdminCenter\PowerShel
		     lModules\Microsoft.WindowsAdminCenter.Configuration"

NamE: Service Path Modification via sc.exe
	description: 
		     Identifies attempts to modify a service path
		     setting using sc.exe. Attackers may attempt to modify existing
		     services for persistence or privilege escalation.
	query: 
		     process where event.type == "start" and process.name :
		     "sc.exe" and   process.args : "*config*" and process.args :
		     "*binPath*"

NamE: Unsigned DLL Loaded by a Trusted Process
	description: 
		     Identifies digitally signed (trusted) processes
		     loading unsigned DLLs. Attackers may plant their payloads into
		     the application folder and invoke the legitimate application to
		     execute the payload, masking actions they perform under a
		     legitimate, trusted, and potentially elevated system or
		     software process.
	query: 
		     library where host.os.type == "windows" and
		     (dll.Ext.relative_file_creation_time <= 500 or
		     dll.Ext.relative_file_name_modify_time <= 500 or
		     dll.Ext.device.product_id : ("Virtual DVD-ROM", "Virtual
		     Disk")) and dll.hash.sha256 != null and
		     process.code_signature.status :"trusted" and not
		     dll.code_signature.status : ("trusted", "errorExpired",
		     "errorCode_endpoint*") and     /* DLL loaded from the
		     process.executable current directory */
		     endswith~(substring(dll.path, 0, length(dll.path) -
		     (length(dll.name) + 1)), substring(process.executable, 0,
		     length(process.executable) - (length(process.name) + 1)))
		     and not user.id : "S-1-5-18" and     not dll.hash.sha256 : (
		     "19588e6a318894abe8094374bee233e666f319de909c69f12a6047b14473e2
		     99",         "6e8bee250c8cc1b65150522f33794759f5c65f58fff17c5cb
		     f6422ad68b421d2",         "55de11531dc0e566cb91f26e48d1301a161a
		     4b8b24abed42304d711412368760",         "56a5148d00c2d9e58415be2
		     d64eca922a58063fe26d9af1c87084aa383c9058e",         "83ee0ff920
		     144edb2c2f4ea10130f55443493290886985a63233fa2431e450f9",
		     "0d0d8f2eaff6b5f75e63d9721d5a0480b30e70792fe0d3a24d76fd3e61b059
		     82",         "8b6ce3a640e2d6f36b0001be2a1abb765ae51e62c314a1591
		     1e75138cbb544bb",         "ea02a19dd824cb7d611b8821d1b9e6a07671
		     4a195d027d1ff918128a64ac5220",         "02a6d001e6dd944738e09b7
		     20e49dcb1272cb782b870e5ae319d4600bc192225",         "e7714a1d6a
		     c3f4c4ae22564b9ca301e486f5f42691859c0a687246c47b5cf5c9",
		     "17f0f709fb7f6190c03b19b6198fd863b6f0d79f46ccfebac6064be747a4cb
		     3e",         "cb7ab3788d10940df874acd97b1821bbb5ee4a91f3eec1198
		     2bb5bf7a3c96443",         "c944ee510721a1d30d42227cc3061dfdcbc1
		     44c952381afcfe4f6e82c5435ffc",         "967189adfbc889fde89aafc
		     867f7a1f02731f8592cf6fd5a4ace1929213e2e13",         "4a82452674
		     9790603eb66777f79787128dd282162a3904a4c1135de43b14d029",
		     "620a7e658af05cc848091b8a639854b9b15700a9061b4a3d078523653133a4
		     af",         "cb220267fb0116b298bab6a09a764420d630c52026f7d750f
		     8ffca4818389327",         "0da1f856d92d6b95f10ed8c3f629cd15468c
		     906de9352fb4ae629139d1412eed",         "e1646c7778c24407a178819
		     08037a49ecfcb5a980d155212d544302653a3ef62",         "e102c9c5b2
		     2ceb60dc516ab4124bea8ec8e808b08eec48ea7ac674d13fca82ef",
		     "c7544e1f9927afdf6e8cd7063020b572e60fe8f00af39227eb831d331df382
		     25",         "3668c6749db59a6cbc5293d0a4f904f76d6fb5048704449dd
		     53894916f408a57",         "7705851ba047a8154402aca92621b60be0e0
		     e9d9b52b19bf8be540305bd53dba",         "b5acf358ff97127eac9ef4c
		     664a980b937376b5295ef23d77ee338225de10d60",         "394d2d862f
		     2ddce71f28d9b933b21a7d6c621c80ef28652574f758f77f01f716",
		     "e958d03db79e9f1d2770c70a5bc24904aa3e2d27a8d5637684cf8166b38908
		     f2",         "284701380f33a30b25e8eb9822e7f47179238e91d08bd3fb5
		     a117145de7e0d8d",         "497471497886f18ca16f7facab7d76dc9bfa
		     dd69deb9c6e4ea9bdc0869a15628",         "739bedcfc8eb860927eb205
		     7474be5b39518aaaa6703f9f85307a432fa1f236e",         "8f4c72e3c7
		     de1ab5d894ec7813f65c5298ecafc183f31924b44a427433ffca42",
		     "1ac4753056179b358132c55ca3086d550849ae30259ba94f334826c2fbf6c5
		     7e",         "53e8fecd7d4b1b74064eba9bfa6a361d52929f440954931b4
		     ba65615148bf0ea",         "e9088afd8871dbad5eda47a9d8abf3b08dd2
		     e17c423ba8a05f9b6ad6751f9b7c",         "ab27eb05130db2f92499234
		     b69ff97ee6429c7824efcb7324ae3e404e2b405bf",         "5534510085
		     20a5f0110d84192cba40208fb001c27454f946e85e6fb2e6553292"     )

NamE: File or Directory Deletion Command
	description: 
		     This rule identifies the execution of commands
		     that can be used to delete files and directories. Adversaries
		     may delete files and directories on a host system, such as
		     logs, browser history, or malware.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  (   (process.name: "rundll32.exe" and
		     process.args: "*InetCpl.cpl,Clear*") or    (process.name:
		     "reg.exe" and process.args:"delete") or    (     process.name:
		     "cmd.exe" and process.args: ("*rmdir*", "*rm *", "rm") and
		     not process.args : (
		     "*\\AppData\\Local\\Microsoft\\OneDrive\\*",
		     "*\\AppData\\Local\\Temp\\DockerDesktop\\*",
		     "*\\AppData\\Local\\Temp\\Report.*",
		     "*\\AppData\\Local\\Temp\\*.PackageExtraction"     )   ) or
		     (process.name: "powershell.exe" and process.args: ("*rmdir",
		     "rm", "rd", "*Remove-Item*", "del", "*]::Delete(*")) ) and not
		     user.id : "S-1-5-18"

NamE: Process Discovery via Built-In Applications
	description: 
		     Identifies the use of built-in tools attackers
		     can use to discover running processes on an endpoint.
	query: 
		     process where event.type == "start" and event.action
		     in ("exec", "exec_event") and process.name in (   "ps",
		     "pstree", "htop", "pgrep" ) and  not process.parent.name in
		     ("amazon-ssm-agent", "snap")

NamE: PowerShell Script with Discovery Capabilities
	description: 
		     Identifies the use of Cmdlets and methods
		     related to discovery activities. Attackers can use these to
		     perform various situational awareness related activities, like
		     enumerating users, shares, sessions, domain trusts, groups,
		     etc.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (     (       "Get-
		     ADDefaultDomainPasswordPolicy" or       "Get-ADDomain" or "Get-
		     ComputerInfo" or       "Get-Disk" or "Get-DnsClientCache" or
		     "Get-GPOReport" or "Get-HotFix" or       "Get-LocalUser" or
		     "Get-NetFirewallProfile" or       "get-nettcpconnection" or
		     "Get-NetAdapter" or       "Get-PhysicalDisk" or "Get-Process"
		     or       "Get-PSDrive" or "Get-Service" or       "Get-SmbShare"
		     or "Get-WinEvent"     ) or     (       ("Get-WmiObject" or
		     "gwmi" or "Get-CimInstance" or        "gcim" or
		     "Management.ManagementObjectSearcher" or
		     "System.Management.ManagementClass" or        "[WmiClass]") and
		     (         "AntiVirusProduct" or "CIM_BIOSElement" or
		     "CIM_ComputerSystem" or "CIM_Product" or "CIM_DiskDrive" or
		     "CIM_LogicalDisk" or "CIM_NetworkAdapter" or
		     "CIM_StorageVolume" or "CIM_OperatingSystem" or
		     "CIM_Process" or "CIM_Service" or "MSFT_DNSClientCache" or
		     "Win32_BIOS" or "Win32_ComputerSystem" or
		     "Win32_ComputerSystemProduct" or "Win32_DiskDrive" or
		     "win32_environment" or "Win32_Group" or
		     "Win32_groupuser" or "Win32_IP4RouteTable" or
		     "Win32_logicaldisk" or "Win32_MappedLogicalDisk" or
		     "Win32_NetworkAdapterConfiguration" or "win32_ntdomain" or
		     "Win32_OperatingSystem" or         "Win32_PnPEntity" or
		     "Win32_Process" or "Win32_Product" or
		     "Win32_quickfixengineering" or         "win32_service" or
		     "Win32_Share" or "Win32_UserAccount"       )     ) or     (
		     ("ADSI" and "WinNT") or       ("Get-ChildItem" and
		     "sysmondrv.sys") or       ("::GetIPGlobalProperties()" and
		     "GetActiveTcpConnections()") or
		     ("ServiceProcess.ServiceController" and "::GetServices") or
		     ("Diagnostics.Process" and "::GetProcesses") or
		     ("DirectoryServices.Protocols.GroupPolicy" and
		     ".GetGPOReport()") or
		     ("DirectoryServices.AccountManagement" and "PrincipalSearcher")
		     or       ("NetFwTypeLib.NetFwMgr" and "CurrentProfile") or
		     ("NetworkInformation.NetworkInterface" and
		     "GetAllNetworkInterfaces") or       ("Automation.PSDriveInfo")
		     or       ("Microsoft.Win32.RegistryHive")     ) or     (
		     "Get-ItemProperty" and       (
		     "\Control\SecurityProviders\WDigest" or
		     "\microsoft\windows\currentversion\explorer\runmru" or         
		     "\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Par
		     ameters" or
		     "\Microsoft\Windows\CurrentVersion\Uninstall" or
		     "\Microsoft\Windows\WindowsUpdate" or
		     "Policies\Microsoft\Windows\Installer" or
		     "Software\Microsoft\Windows\CurrentVersion\Policies" or
		     ("\Services\SharedAccess\Parameters\FirewallPolicy" and
		     "EnableFirewall") or
		     ("Microsoft\Windows\CurrentVersion\Internet Settings" and
		     "proxyEnable")       )     ) or     (
		     ("Directoryservices.Activedirectory" or
		     "DirectoryServices.AccountManagement") and        (
		     "Domain Admins" or "DomainControllers" or
		     "FindAllGlobalCatalogs" or "GetAllTrustRelationships" or
		     "GetCurrentDomain" or "GetCurrentForest"       ) or
		     "DirectoryServices.DirectorySearcher" and       (
		     "samAccountType=805306368" or
		     "samAccountType=805306369" or         "objectCategory=group" or
		     "objectCategory=groupPolicyContainer" or
		     "objectCategory=site" or         "objectCategory=subnet" or
		     "objectClass=trustedDomain"       )     ) or     (       "Get-
		     Process" and       (         "mcshield" or "windefend" or
		     "savservice" or         "TMCCSF" or "symantec antivirus" or
		     "CSFalcon" or "TmPfw" or "kvoop"       )     )   ) and   not
		     powershell.file.script_block_text : (     (
		     "__cmdletization_BindCommonParameters" and
		     "Microsoft.PowerShell.Core\Export-ModuleMember" and
		     "Microsoft.PowerShell.Cmdletization.Cim.CimCmdletAdapter"     )
		     or     "CmdletsToExport=@(\"Add-Content\"," or
		     ("cmdletization" and "cdxml-Help.xml")   ) and   not user.id :
		     ("S-1-5-18" or "S-1-5-19" or "S-1-5-20")

NamE: Accessing Outlook Data Files
	description: 
		     Identifies commands containing references to
		     Outlook data files extensions, which can potentially indicate
		     the search, access, or modification of these files.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and process.args : ("*.ost", "*.pst") and   not
		     process.name : "outlook.exe" and   not (         process.name :
		     "rundll32.exe" and         process.args :
		     "*davclnt.dll,DavSetCookie*"   )

NamE: PowerShell Script with Remote Execution Capabilities via WinRM
	description: 
		     Identifies the use of Cmdlets and methods
		     related to remote execution activities using WinRM. Attackers
		     can abuse WinRM to perform lateral movement using built-in
		     tools.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (     ("Invoke-WmiMethod"
		     or "Invoke-Command" or "Enter-PSSession") and "ComputerName"
		     ) and   not user.id : "S-1-5-18" and   not file.directory : (
		     "C:\\Program Files\\LogicMonitor\\Agent\\tmp" or
		     "C:\\Program Files\\WindowsPowerShell\\Modules\\icinga-
		     powershell-framework\\cache" or     "C:\\Program
		     Files\\WindowsPowerShell\\Modules\\SmartCardTools\\1.2.2"   )
		     and not   powershell.file.script_block_text : (     "Export-
		     ModuleMember -Function @('Invoke-Expression''Invoke-Command')"
		     and     "function Invoke-Command {"   )

NamE: Execution of File Written or Modified by Microsoft Office
	description: 
		     Identifies an executable created by a Microsoft
		     Office application and subsequently executed. These processes
		     are often launched via scripts inside documents or during
		     exploitation of Microsoft Office applications.
	query: 
		     sequence with maxspan=2h   [file where host.os.type ==
		     "windows" and event.type != "deletion" and file.extension :
		     "exe" and      (process.name : "WINWORD.EXE" or
		     process.name : "EXCEL.EXE" or       process.name :
		     "OUTLOOK.EXE" or       process.name : "POWERPNT.EXE" or
		     process.name : "eqnedt32.exe" or       process.name :
		     "fltldr.exe" or       process.name : "MSPUB.EXE" or
		     process.name : "MSACCESS.EXE")   ] by host.id, file.path
		     [process where host.os.type == "windows" and event.type ==
		     "start" and     not (process.name : "NewOutlookInstaller.exe"
		     and process.code_signature.subject_name : "Microsoft
		     Corporation" and process.code_signature.trusted == true) and
		     not (process.name : "ShareFileForOutlook-v*.exe" and
		     process.code_signature.subject_name : "Citrix Systems, Inc."
		     and process.code_signature.trusted == true)   ] by host.id,
		     process.executable

NamE: Image Loaded with Invalid Signature
	description: 
		     Identifies binaries that are loaded and with an
		     invalid code signature. This may indicate an attempt to
		     masquerade as a signed binary.
	query: 
		     library where host.os.type == "windows" and
		     event.action == "load" and   dll.code_signature.status :
		     ("errorUntrustedRoot", "errorBadDigest", "errorUntrustedRoot")
		     and   (dll.Ext.relative_file_creation_time <= 500 or
		     dll.Ext.relative_file_name_modify_time <= 500) and   not
		     startswith~(dll.name, process.name) and   not dll.path : (
		     "?:\\Windows\\System32\\DriverStore\\FileRepository\\*"   )

NamE: At.exe Command Lateral Movement
	description: 
		     Identifies use of at.exe to interact with the
		     task scheduler on remote hosts. Remote task creations,
		     modifications or execution could be indicative of adversary
		     lateral movement.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and process.name : "at.exe" and process.args :
		     "\\\\*"

NamE: Unusual Command Execution from Web Server Parent
	description: 
		     This rule detects potential command execution
		     from a web server parent process on a Linux host. Adversaries
		     may attempt to execute commands from a web server parent
		     process to blend in with normal web server activity and evade
		     detection. This behavior is commonly observed in web shell
		     attacks where adversaries exploit web server vulnerabilities to
		     execute arbitrary commands on the host. The detection rule
		     identifies unusual command execution from web server parent
		     processes, which may indicate a compromised host or an ongoing
		     attack. ES|QL rules have limited fields available in its alert
		     documents. Make sure to review the original documents to aid in
		     the investigation of this alert.
	query: 
		     from logs-endpoint.events.process-* | keep @timestamp,
		     host.os.type, event.type, event.action, process.parent.name,
		     user.name, user.id, process.working_directory, process.name,
		     process.command_line, process.parent.executable, agent.id |
		     where @timestamp > now() - 1 hours | where host.os.type ==
		     "linux" and event.type == "start" and event.action == "exec"
		     and (   process.parent.name in (     "apache", "nginx",
		     "apache2", "httpd", "lighttpd", "caddy", "node",
		     "mongrel_rails", "java", "gunicorn",     "uwsgi", "openresty",
		     "cherokee", "h2o", "resin", "puma", "unicorn", "traefik",
		     "tornado", "hypercorn",     "daphne", "twistd", "yaws",
		     "webfsd", "httpd.worker", "flask", "rails", "mongrel"   ) or
		     process.parent.name like "php-*" or   process.parent.name like
		     "python*" or   process.parent.name like "ruby*" or
		     process.parent.name like "perl*" or   user.name in (
		     "apache", "www-data", "httpd", "nginx", "lighttpd", "tomcat",
		     "tomcat8", "tomcat9", "ftp", "ftpuser", "ftpd"   ) or   user.id
		     in ("99", "33", "498", "48") or   process.working_directory
		     like "/var/www/*" ) and   process.name in ("bash", "dash",
		     "sh", "tcsh", "csh", "zsh", "ksh", "fish") and
		     process.command_line like "* -c *" and   not (
		     process.working_directory like "/home/*" or
		     process.working_directory like "/" or
		     process.working_directory like "/vscode/vscode-server/*" or
		     process.parent.executable like "/vscode/vscode-server/*" or
		     process.parent.executable == "/usr/bin/xfce4-terminal" ) |
		     stats cc = count(), agent_count = count_distinct(agent.id) by
		     process.command_line, process.working_directory,
		     process.parent.executable | where agent_count == 1 and cc < 5 |
		     sort cc asc | limit 100

NamE: Execution of File Written or Modified by PDF Reader
	description: 
		     Identifies a suspicious file that was written by
		     a PDF reader application and subsequently executed. These
		     processes are often launched via exploitation of PDF
		     applications.
	query: 
		     sequence with maxspan=2h   [file where host.os.type ==
		     "windows" and event.type != "deletion" and file.extension :
		     "exe" and      (process.name : "AcroRd32.exe" or
		     process.name : "rdrcef.exe" or       process.name :
		     "FoxitPhantomPDF.exe" or       process.name :
		     "FoxitReader.exe") and      not (file.name :
		     "FoxitPhantomPDF.exe" or           file.name :
		     "FoxitPhantomPDFUpdater.exe" or           file.name :
		     "FoxitReader.exe" or           file.name :
		     "FoxitReaderUpdater.exe" or           file.name :
		     "AcroRd32.exe" or           file.name : "rdrcef.exe")   ] by
		     host.id, file.path   [process where host.os.type == "windows"
		     and event.type == "start"] by host.id, process.executable

NamE: Suspicious Troubleshooting Pack Cabinet Execution
	description: 
		     Identifies the execution of the Microsoft
		     Diagnostic Wizard to open a diagcab file from a suspicious path
		     and with an unusual parent process. This may indicate an
		     attempt to execute malicious Troubleshooting Pack Cabinet
		     files.
	query: 
		     process where host.os.type == "windows" and
		     event.action == "start" and   (process.name : "msdt.exe" or
		     ?process.pe.original_file_name == "msdt.exe") and process.args
		     : "/cab" and   process.parent.name : (     "firefox.exe",
		     "chrome.exe", "msedge.exe", "explorer.exe", "brave.exe",
		     "whale.exe", "browser.exe",     "dragon.exe", "vivaldi.exe",
		     "opera.exe", "iexplore", "firefox.exe", "waterfox.exe",
		     "iexplore.exe",     "winrar.exe", "winrar.exe", "7zFM.exe",
		     "outlook.exe", "winword.exe", "excel.exe"   ) and
		     process.args : (     "?:\\Users\\*",     "\\\\*",     "http*",
		     "ftp://*"   )

NamE: Attempted Private Key Access
	description: 
		     Attackers may try to access private keys, e.g.
		     ssh, in order to gain further authenticated access to the
		     environment.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.command_line : ("*.pem *", "*.pem",
		     "*.id_rsa*") and   not process.args : (         "--rootcert",
		     "--cert",         "--crlfile"   ) and   not
		     process.command_line : (         "*--cacert*",         "*--ssl-
		     cert*",         "*--tls-cert*",         "*--tls_server_certs*"
		     ) and   not process.executable : (     "?:\\ProgramData\\Logish
		     rd\\LogiOptions\\Software\\*\\LogiLuUpdater.exe",
		     "?:\\Program Files\\Elastic\\Agent\\data\\*\\osqueryd.exe",
		     "?:\\Program Files\\Git\\cmd\\git.exe",     "?:\\Program
		     Files\\Git\\mingw64\\bin\\git.exe",     "?:\\Program
		     Files\\Guardicore\\gc-controller.exe",     "?:\\Program
		     Files\\Guardicore\\gc-deception-agent.exe",     "?:\\Program
		     Files\\Guardicore\\gc-detection-agent.exe",     "?:\\Program
		     Files\\Guardicore\\gc-enforcement-agent.exe",     "?:\\Program
		     Files\\Guardicore\\gc-guest-agent.exe",     "?:\\Program
		     Files\\Logi\\LogiBolt\\LogiBoltUpdater.exe",     "?:\\Program
		     Files (x86)\\Schneider Electric EcoStruxure\\Building Operation
		     5.0\\Device Administrator\\Python\\python.exe",
		     "?:\\Program Files\\Splunk\\bin\\openssl.exe",     "?:\\Program
		     Files\\SplunkUniversalForwarder\\bin\\openssl.exe",     "?:\\Us
		     ers\\*\\AppData\\Local\\Logi\\LogiBolt\\LogiBoltUpdater.exe",
		     "?:\\Windows\\system32\\icacls.exe",
		     "?:\\Windows\\System32\\OpenSSH\\*"   )

NamE: WMIC Remote Command
	description: 
		     Identifies the use of wmic.exe to run commands
		     on remote hosts. While this can be used by administrators
		     legitimately, attackers can abuse this built-in utility to
		     achieve lateral movement.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : "WMIC.exe" and   process.args :
		     "*node:*" and   process.args : ("call", "set", "get") and   not
		     process.args : ("*/node:localhost*", "*/node:\"127.0.0.1\"*",
		     "/node:127.0.0.1")

NamE: Execution via Microsoft DotNet ClickOnce Host
	description: 
		     Identifies the execution of DotNet ClickOnce
		     installer via Dfsvc.exe trampoline. Adversaries may take
		     advantage of ClickOnce to proxy execution of malicious payloads
		     via trusted Microsoft processes.
	query: 
		     sequence by user.id with maxspan=5s  [process where
		     host.os.type == "windows" and event.action == "start" and
		     process.name : "rundll32.exe" and process.command_line :
		     ("*dfshim*ShOpenVerbApplication*", "*dfshim*#*")]  [network
		     where host.os.type == "windows" and process.name : "dfsvc.exe"]

NamE: Potential Non-Standard Port HTTP/HTTPS connection
	description: 
		     Identifies potentially malicious processes
		     communicating via a port paring typically not associated with
		     HTTP/HTTPS. For example, HTTP over port 8443 or port 440 as
		     opposed to the traditional port 80 , 443. Adversaries may make
		     changes to the standard port a protocol uses to bypass
		     filtering or muddle analysis/parsing of network data.
	query: 
		     network where process.name : ("http", "https") and
		     destination.port not in (80, 443) and event.action in (
		     "connection_attempted", "ipv4_connection_attempt_event",
		     "connection_accepted", "ipv4_connection_accept_event" ) and
		     destination.ip != "127.0.0.1"

NamE: Linux System Information Discovery via Getconf
	description: 
		     This rule identifies Linux system information
		     discovery via the `getconf` command. The `getconf` command is
		     used to query system configuration variables and system limits.
		     Adversaries may use this command to gather information about
		     the system, such as the page size, maximum number of open
		     files, and other system limits, to aid in further exploration
		     and exploitation of the system.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event",
		     "executed", "process_started") and process.name == "getconf"

NamE: Trap Signals Execution
	description: 
		     Identify activity related where adversaries can
		     include a trap command which then allows programs and shells to
		     specify commands that will be executed upon receiving interrupt
		     signals.
	query: 
		     process where event.type == "start" and event.action
		     in ("exec", "exec_event", "executed", "process_started") and
		     process.name == "trap" and process.args : "SIG*"

NamE: Processes with Trailing Spaces
	description: 
		     Identify instances where adversaries include
		     trailing space characters to mimic regular files, disguising
		     their activity to evade default file handling mechanisms.
	query: 
		     process where event.type == "start" and event.action
		     in ("exec", "exec_event", "executed", "process_started") and
		     process.name : "* "

NamE: Account or Group Discovery via Built-In Tools
	description: 
		     Adversaries may use built-in applications to get
		     a listing of local system or domain accounts and groups.
	query: 
		     process where event.type == "start" and event.action
		     in ("exec", "exec_event", "executed", "process_started") and (
		     (process.name in ("groups", "id")) or    (process.name ==
		     "dscl" and process.args : ("/Active Directory/*", "/Users*",
		     "/Groups*")) or   (process.name == "dscacheutil" and
		     process.args in ("user", "group")) or   (process.args in
		     ("/etc/passwd", "/etc/master.passwd", "/etc/sudoers")) or
		     (process.name == "getent" and process.args in ("passwd",
		     "group")) )

NamE: Compression DLL Loaded by Unusual Process
	description: 
		     Identifies the image load of a compression DLL.
		     Adversaries will often compress and encrypt data in preparation
		     for exfiltration.
	query: 
		     library where host.os.type == "windows" and
		     event.action == "load" and   dll.name :
		     ("System.IO.Compression.FileSystem.ni.dll",
		     "System.IO.Compression.ni.dll") and   not    (     (
		     process.executable : (         "?:\\Program Files\\*",
		     "?:\\Program Files (x86)\\*",
		     "?:\\Windows\\Microsoft.NET\\Framework*\\mscorsvw.exe",
		     "?:\\Windows\\System32\\sdiagnhost.exe",
		     "?:\\Windows\\System32\\inetsrv\\w3wp.exe",
		     "?:\\Windows\\SysWOW64\\inetsrv\\w3wp.exe",
		     "?:\\ProgramData\\Microsoft\\Windows Defender Advanced Threat
		     Protection\\DataCollection\\*\\OpenHandleCollector.exe"       )
		     and process.code_signature.trusted == true     ) or     (
		     process.name : "NuGet.exe" and process.code_signature.trusted
		     == true and user.id : ("S-1-5-18", "S-1-5-20")     )   )

NamE: Unsigned BITS Service Client Process
	description: 
		     Identifies an unsigned Windows Background
		     Intelligent Transfer Service (BITS) client process. Attackers
		     may abuse BITS functionality to download or upload data using
		     the BITS service.
	query: 
		     library where dll.name : "Bitsproxy.dll" and
		     process.executable != null and not
		     process.code_signature.trusted == true and not
		     process.code_signature.status : ("errorExpired",
		     "errorCode_endpoint*")

NamE: Suspicious Execution via MSIEXEC
	description: 
		     Identifies suspicious execution of the built-in
		     Windows Installer, msiexec.exe, to install a package from usual
		     paths or parent process. Adversaries may abuse msiexec.exe to
		     launch malicious local MSI files.
	query: 
		     process where host.os.type == "windows" and
		     event.action == "start" and   process.name : "msiexec.exe" and
		     user.id : ("S-1-5-21*", "S-1-12-*") and
		     process.parent.executable != null and   (     (process.args :
		     "/i" and process.args : ("/q", "/quiet") and process.args_count
		     == 4 and      process.args : ("?:\\Users\\*",
		     "?:\\ProgramData\\*") and      not process.parent.executable :
		     ("?:\\Program Files (x86)\\*.exe",
		     "?:\\Program Files\\*.exe",
		     "?:\\Windows\\explorer.exe",
		     "?:\\Users\\*\\Desktop\\*",
		     "?:\\Users\\*\\Downloads\\*",
		     "?:\\programdata\\*")) or      (process.args_count == 1 and not
		     process.parent.executable : ("?:\\Windows\\explorer.exe",
		     "?:\\Windows\\SysWOW64\\explorer.exe")) or      (process.args :
		     "/i" and process.args : ("/q", "/quiet") and process.args_count
		     == 4 and      (process.parent.args : "Schedule" or
		     process.parent.name : "wmiprvse.exe" or
		     process.parent.executable : "?:\\Users\\*\\AppData\\*" or
		     (process.parent.name : ("powershell.exe", "cmd.exe") and
		     length(process.parent.command_line) >= 200))) or
		     (process.args : "/i" and process.args : ("/q", "/quiet") and
		     process.args_count == 4 and      ?process.working_directory :
		     "?:\\" and process.parent.name : ("cmd.exe", "powershell.exe"))
		     ) and    /* noisy pattern */   not (process.parent.executable :
		     "?:\\Users\\*\\AppData\\Local\\Temp\\*" and
		     ?process.parent.args_count >= 2 and        process.args :
		     "?:\\Users\\*\\AppData\\Local\\Temp\\*\\*.msi") and    not
		     process.args : ("?:\\Program Files (x86)\\*", "?:\\Program
		     Files\\*")

NamE: Potential Port Scanning Activity from Compromised Host
	description: 
		     This rule detects potential port scanning
		     activity from a compromised host. Port scanning is a common
		     reconnaissance technique used by attackers to identify open
		     ports and services on a target system. A compromised host may
		     exhibit port scanning behavior when an attacker is attempting
		     to map out the network topology, identify vulnerable services,
		     or prepare for further exploitation. This rule identifies
		     potential port scanning activity by monitoring network
		     connection attempts from a single host to a large number of
		     ports within a short time frame. ES|QL rules have limited
		     fields available in its alert documents. Make sure to review
		     the original documents to aid in the investigation of this
		     alert.
	query: 
		     from logs-endpoint.events.network-* | keep @timestamp,
		     host.os.type, event.type, event.action, destination.port,
		     process.executable, destination.ip, agent.id | where @timestamp
		     > now() - 1 hours | where host.os.type == "linux" and
		     event.type == "start" and event.action ==
		     "connection_attempted" | stats cc = count(), port_count =
		     count_distinct(destination.port), agent_count =
		     count_distinct(agent.id) by process.executable, destination.ip
		     | where agent_count == 1 and port_count > 100 | sort cc asc |
		     limit 100

NamE: Unusual Child Processes of RunDLL32
	description: 
		     Identifies child processes of unusual instances
		     of RunDLL32 where the command line parameters were suspicious.
		     Misuse of RunDLL32 could indicate malicious activity.
	query: 
		     sequence with maxspan=1h   [process where host.os.type
		     == "windows" and event.type == "start" and      (process.name :
		     "rundll32.exe" or process.pe.original_file_name ==
		     "RUNDLL32.EXE") and       process.args_count == 1   ] by
		     process.entity_id   [process where host.os.type == "windows"
		     and event.type == "start" and process.parent.name :
		     "rundll32.exe"   ] by process.parent.entity_id

NamE: Potential Outgoing RDP Connection by Unusual Process
	description: 
		     Adversaries may attempt to connect to a remote
		     system over Windows Remote Desktop Protocol (RDP) to achieve
		     lateral movement. Adversaries may avoid using the Microsoft
		     Terminal Services Client (mstsc.exe) binary to establish an RDP
		     connection to evade detection.
	query: 
		     network where host.os.type == "windows" and
		     event.action == "connection_attempted" and destination.port ==
		     3389 and   destination.ip != "::1" and destination.ip !=
		     "127.0.0.1" and   not (     process.executable : (
		     "?:\\Windows\\System32\\mstsc.exe",       "?:\\Program Files
		     (x86)\\mRemoteNG\\mRemoteNG.exe",       "?:\\Program Files
		     (x86)\\PRTG Network Monitor\\PRTG Probe.exe",
		     "?:\\Program Files\\Azure Advanced Threat Protection
		     Sensor\\*\\Microsoft.Tri.Sensor.exe",       "?:\\Program Files
		     (x86)\\Microsoft\\Remote Desktop Connection
		     Manager\\RDCMan.exe",       "?:\\Program
		     Files\\SentinelOne\\Sentinel
		     Agent*\\Ranger\\SentinelRanger.exe",       "?:\\Program
		     Files\\Devolutions\\Remote Desktop
		     Manager\\RemoteDesktopManager.exe",       "?:\\Program Files
		     (x86)\\Devolutions\\Remote Desktop
		     Manager\\RemoteDesktopManager.exe"     ) and
		     process.code_signature.trusted == true   )

NamE: Discovery of Domain Groups
	description: 
		     Identifies the execution of Linux built-in
		     commands related to account or group enumeration. Adversaries
		     may use account and group information to orient themselves
		     before deciding how to act.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event",
		     "executed", "process_started")  and (   process.name in
		     ("ldapsearch", "dscacheutil") or (process.name == "dscl" and
		     process.args : "*-list*") )

NamE: Creation of Kernel Module
	description: 
		     Identifies activity related to loading kernel
		     modules on Linux via creation of new ko files in the LKM
		     directory.
	query: 
		     file where host.os.type == "linux" and event.type in
		     ("change", "creation") and file.path : "/lib/modules/*" and
		     file.extension == "ko" and not process.name : (   "dpkg",
		     "systemd", "falcon-sensor*", "dnf", "yum", "rpm", "cp" )

NamE: File with Suspicious Extension Downloaded
	description: 
		     Identifies unusual files downloaded from outside
		     the local network that have the potential to be abused for code
		     execution.
	query: 
		     file where host.os.type == "windows" and event.type ==
		     "creation" and   file.extension : (     "appinstaller",
		     "application", "appx", "appxbundle", "cpl", "diagcab",
		     "diagpkg", "diagcfg", "manifest",     "msix", "pif", "search-
		     ms", "searchConnector-ms", "settingcontent-ms", "symlink",
		     "theme", "themepack"    ) and file.Ext.windows.zone_identifier
		     > 1 and   not   (     (       file.extension : "msix" and
		     file.path : (         "?:\\Users\\*\\AppData\\Local\\Temp\\WinG
		     et\\Microsoft.Winget.Source*",         "?:\\Windows\\system32\\
		     config\\systemprofile\\AppData\\Local\\Microsoft\\WinGet\\State
		     \\defaultState\\Microsoft.PreIndexed.Package\\Microsoft.Winget.
		     Source*"       )     ) or     (       process.name :
		     "Teams.exe" and process.code_signature.trusted == true and
		     file.extension : "msix" and        file.path :
		     "?:\\Users\\*\\AppData\\Roaming\\Microsoft\\Teams\\tmp\\*"
		     )   )

NamE: High Number of Egress Network Connections from Unusual Executable
	description: 
		     This rule detects a high number of egress
		     network connections from an unusual executable on a Linux
		     system. This could indicate a command and control (C2)
		     communication attempt, a brute force attack via a malware
		     infection, or other malicious activity. ES|QL rules have
		     limited fields available in its alert documents. Make sure to
		     review the original documents to aid in the investigation of
		     this alert.
	query: 
		     from logs-endpoint.events.network-* | keep @timestamp,
		     host.os.type, event.type, event.action, process.name,
		     process.executable, destination.ip, agent.id | where @timestamp
		     > now() - 1 hours | where host.os.type == "linux" and
		     event.type == "start" and event.action ==
		     "connection_attempted" and (      (        process.executable
		     like "/tmp/*" or        process.executable like "/var/tmp/*" or
		     process.executable like "/dev/shm/*"      ) or
		     (process.name like ".*") ) and not (      CIDR_MATCH(
		     destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16",
		     "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29",
		     "192.0.0.8/32", "192.0.0.9/32",        "192.0.0.10/32",
		     "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24",
		     "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16",
		     "192.88.99.0/24",        "224.0.0.0/4", "100.64.0.0/10",
		     "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24",
		     "203.0.113.0/24", "224.0.0.0/4", "240.0.0.0/4", "::1",
		     "FE80::/10", "FF00::/8"      ) or      process.executable like
		     "/nix/store/*" or      process.executable like "/tmp/newroot/*"
		     or      process.executable like "/tmp/.mount*" or
		     process.executable like "/tmp/go-build*"    ) | stats cc =
		     count(), agent_count = count_distinct(agent.id) by
		     process.executable | where agent_count == 1 and cc > 15 | sort
		     cc asc | limit 100

NamE: File and Directory Permissions Modification
	description: 
		     Identifies the change of permissions/ownership
		     of files/folders through built-in Windows utilities. Threat
		     actors may require permission modification of files/folders to
		     change, modify or delete them.
	query: 
		     process where event.type == "start" and host.os.type
		     == "windows" and (   ((process.name: "icacls.exe" or
		     process.pe.original_file_name == "iCACLS.EXE") and
		     process.args: ("*:F", "/reset", "/setowner", "*grant*")) or
		     ((process.name: "cacls.exe" or process.pe.original_file_name ==
		     "CACLS.EXE") and process.args: ("/g", "*:f")) or
		     ((process.name: "takeown.exe" or process.pe.original_file_name
		     == "takeown.exe") and process.args: ("/F")) or
		     ((process.name: "attrib.exe" or process.pe.original_file_name==
		     "ATTRIB.EXE") and process.args: "-r") ) and not user.id :
		     "S-1-5-18" and not (   process.args :
		     ("C:\\ProgramData\\Lenovo\\*", "C:\\ProgramData\\Adobe\\*",
		     "C:\\ProgramData\\ASUS\\ASUS*") )

NamE: Windows Installer with Suspicious Properties
	description: 
		     Identifies the execution of an installer from an
		     archive or with suspicious properties. Adversaries may abuse
		     msiexec.exe to launch local or network accessible MSI files in
		     an attempt to bypass application whitelisting.
	query: 
		     sequence with maxspan=1m   [registry where
		     host.os.type == "windows" and event.type == "change" and
		     process.name : "msiexec.exe" and    (     (registry.value :
		     "InstallSource" and      registry.data.strings :
		     ("?:\\Users\\*\\Temp\\Temp?_*.zip\\*",
		     "?:\\Users\\*\\*.7z\\*",
		     "?:\\Users\\*\\*.rar\\*")) or      (registry.value :
		     ("DisplayName", "ProductName") and registry.data.strings :
		     "SetupTest")     )]   [process where host.os.type == "windows"
		     and event.action == "start" and     process.parent.name :
		     "msiexec.exe" and     not process.name : "msiexec.exe" and
		     not (process.executable : ("?:\\Program Files (x86)\\*.exe",
		     "?:\\Program Files\\*.exe") and process.code_signature.trusted
		     == true)]

NamE: InstallUtil Activity
	description: 
		     InstallUtil is a command-line utility that
		     allows for installation and uninstallation of resources by
		     executing specific installer components specified in .NET
		     binaries. Adversaries may use InstallUtil to proxy the
		     execution of code through a trusted Windows utility.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : "installutil.exe" and not
		     user.id : "S-1-5-18"

NamE: Binary Content Copy via Cmd.exe
	description: 
		     Attackers may abuse cmd.exe commands to
		     reassemble binary fragments into a malicious payload.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : "cmd.exe" and (
		     (process.args : "type" and process.args : (">", ">>")) or
		     (process.args : "copy" and process.args : "/b"))

NamE: File Staged in Root Folder of Recycle Bin
	description: 
		     Identifies files written to the root of the
		     Recycle Bin folder instead of subdirectories. Adversaries may
		     place files in the root of the Recycle Bin in preparation for
		     exfiltration or to evade defenses.
	query: 
		     file where host.os.type == "windows" and event.type ==
		     "creation" and   file.path : "?:\\$RECYCLE.BIN\\*" and   not
		     file.path : "?:\\$RECYCLE.BIN\\*\\*" and   not file.name :
		     "desktop.ini"

NamE: Unusual File Creation by Web Server
	description: 
		     This rule detects unusual file creations from a
		     web server parent process. Adversaries may attempt to create
		     files from a web server parent process to establish
		     persistence, execute malicious scripts, or exfiltrate data.
		     ES|QL rules have limited fields available in its alert
		     documents. Make sure to review the original documents to aid in
		     the investigation of this alert.
	query: 
		     from logs-endpoint.events.file-* | keep @timestamp,
		     host.os.type, event.type, event.action, user.name, user.id,
		     process.name, process.executable, file.path, agent.id | where
		     @timestamp > now() - 1 hours | where host.os.type == "linux"
		     and event.type == "change" and event.action in ("rename",
		     "creation") and (      user.name in (       "apache", "www-
		     data", "httpd", "nginx", "lighttpd", "tomcat", "tomcat8",
		     "tomcat9", "ftp", "ftpuser", "ftpd"      ) or      user.id in
		     ("99", "33", "498", "48")    ) and (    process.name in (
		     "apache", "nginx", "apache2", "httpd", "lighttpd", "caddy",
		     "node", "mongrel_rails", "java", "gunicorn",     "uwsgi",
		     "openresty", "cherokee", "h2o", "resin", "puma", "unicorn",
		     "traefik", "tornado", "hypercorn",     "daphne", "twistd",
		     "yaws", "webfsd", "httpd.worker", "flask", "rails", "mongrel"
		     ) or     process.name like "php-*" or     process.name like
		     "python*" or     process.name like "ruby*" or     process.name
		     like "perl*"    ) | stats cc = count(), agent_count =
		     count_distinct(agent.id) by process.executable, file.path |
		     where agent_count == 1 and cc < 5 | sort cc asc | limit 100

NamE: Potential Process Injection from Malicious Document
	description: 
		     Identifies child processes of frequently
		     targeted Microsoft Office applications (Word, PowerPoint,
		     Excel) with unusual process arguments and path. This behavior
		     is often observed during exploitation of Office applications or
		     from documents with malicious macros.
	query: 
		     process where host.os.type == "windows" and
		     event.action == "start" and   process.parent.name :
		     ("excel.exe", "powerpnt.exe", "winword.exe") and
		     process.args_count == 1 and   process.executable : (
		     "?:\\Windows\\SysWOW64\\*.exe", "?:\\Windows\\system32\\*.exe"
		     ) and   not (process.executable :
		     "?:\\Windows\\System32\\spool\\drivers\\x64\\*" and
		     process.code_signature.trusted == true and not
		     process.code_signature.subject_name : "Microsoft *") and   not
		     process.executable : (     "?:\\Windows\\Sys*\\Taskmgr.exe",
		     "?:\\Windows\\Sys*\\ctfmon.exe",
		     "?:\\Windows\\System32\\notepad.exe")

NamE: System Hosts File Access
	description: 
		     Identifies the use of built-in tools to read the
		     contents of \etc\hosts on a local machine. Attackers may use
		     this data to discover remote machines in an environment that
		     may be used for Lateral Movement from the current system.
	query: 
		     process where event.type == "start" and event.action
		     in ("exec", "exec_event", "executed", "process_started") and
		     process.name in ("vi", "nano", "cat", "more", "less") and
		     process.args == "/etc/hosts"

NamE: System Network Connections Discovery
	description: 
		     Adversaries may attempt to get a listing of
		     network connections to or from a compromised system.
	query: 
		     process where event.type == "start" and event.action
		     in ("exec", "exec_event", "executed", "process_started") and
		     process.name in ("netstat", "lsof", "who", "w")

NamE: Unusual Base64 Encoding/Decoding Activity
	description: 
		     This rule leverages ES|QL to detect unusual
		     base64 encoding/decoding activity on Linux systems. Attackers
		     may use base64 encoding/decoding to obfuscate data, such as
		     command and control traffic or payloads, to evade detection by
		     host- or network-based security controls. ES|QL rules have
		     limited fields available in its alert documents. Make sure to
		     review the original documents to aid in the investigation of
		     this alert.
	query: 
		     from logs-endpoint.events.process-* | keep @timestamp,
		     host.os.type, event.type, event.action, process.name,
		     process.args, process.command_line, agent.id | where @timestamp
		     > now() - 1 hours | where host.os.type == "linux" and
		     event.type == "start" and event.action == "exec" and (
		     (process.name in ("base64", "base64plain", "base64url",
		     "base64mime", "base64pem", "base32", "base16") and
		     process.command_line like "*-*d*") or   (process.name ==
		     "openssl" and process.args == "enc" and process.args in ("-d",
		     "-base64", "-a")) or   (process.name like "python*" and
		     (process.args == "base64" and process.args in ("-d", "-u",
		     "-t")) or     (process.args == "-c" and process.command_line
		     like "*base64*" and process.command_line like "*b64decode*")
		     ) or   (process.name like "perl*" and process.command_line like
		     "*decode_base64*") or   (process.name like "ruby*" and
		     process.args == "-e" and process.command_line like
		     "*Base64.decode64*") ) | stats cc = count(), agent_count =
		     count_distinct(agent.id) by process.name, process.command_line
		     | where agent_count == 1 and cc < 15 | sort cc asc | limit 100

NamE: WRITEDAC Access on Active Directory Object
	description: 
		     Identifies the access on an object with WRITEDAC
		     permissions. With the WRITEDAC permission, the user can perform
		     a Write Discretionary Access Control List (WriteDACL)
		     operation, which is used to modify the access control rules
		     associated with a specific object within Active Directory.
		     Attackers may abuse this privilege to grant themselves or other
		     compromised accounts additional rights, ultimately compromising
		     the target object, resulting in privilege escalation, lateral
		     movement, and persistence.
	query: 
		     host.os.type: "windows" and event.action : ("Directory
		     Service Access" or "object-operation-performed") and
		     event.code : "4662" and winlog.event_data.AccessMask:"0x40000"

NamE: WMI WBEMTEST Utility Execution
	description: 
		     Adversaries may abuse the WMI diagnostic tool,
		     wbemtest.exe, to enumerate WMI object instances or invoke
		     methods against local or remote endpoints.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and process.name : "wbemtest.exe"

NamE: Potential Subnet Scanning Activity from Compromised Host
	description: 
		     This rule detects potential subnet scanning
		     activity from a compromised host. Subnet scanning is a common
		     reconnaissance technique used by attackers to identify live
		     hosts within a network range. A compromised host may exhibit
		     subnet scanning behavior when an attacker is attempting to map
		     out the network topology, identify vulnerable hosts, or prepare
		     for further exploitation. This rule identifies potential subnet
		     scanning activity by monitoring network connection attempts
		     from a single host to a large number of hosts within a short
		     time frame. ES|QL rules have limited fields available in its
		     alert documents. Make sure to review the original documents to
		     aid in the investigation of this alert.
	query: 
		     from logs-endpoint.events.network-* | keep @timestamp,
		     host.os.type, event.type, event.action, process.executable,
		     destination.ip, agent.id | where @timestamp > now() - 1 hours |
		     where host.os.type == "linux" and event.type == "start" and
		     event.action == "connection_attempted" | stats cc = count(),
		     dest_count = count_distinct(destination.ip), agent_count =
		     count_distinct(agent.id) by process.executable | where
		     agent_count == 1 and dest_count > 250 | sort cc asc | limit 100

NamE: Service Path Modification
	description: 
		     Identifies attempts to modify a service path by
		     an unusual process. Attackers may attempt to modify existing
		     services for persistence or privilege escalation.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.path : (
		     "HKLM\\SYSTEM\\*ControlSet*\\Services\\*\\ImagePath",     "\\RE
		     GISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Services\\*\\ImagePath"
		     ) and not (     process.executable : (       "?:\\Program
		     Files\\*.exe",       "?:\\Program Files (x86)\\*.exe",
		     "?:\\Windows\\System32\\services.exe",
		     "?:\\Windows\\WinSxS\\*"     )   )

NamE: Multi-Factor Authentication Disabled for an Azure User
	description: 
		     Identifies when multi-factor authentication
		     (MFA) is disabled for an Azure user account. An adversary may
		     disable MFA for a user account in order to weaken the
		     authentication requirements for the account.
	query: 
		     event.dataset:azure.auditlogs and
		     azure.auditlogs.operation_name:"Disable Strong Authentication"
		     and event.outcome:(Success or success)

NamE: Downloaded Shortcut Files
	description: 
		     Identifies .lnk shortcut file downloaded from
		     outside the local network. These shortcut files are commonly
		     used in phishing campaigns.
	query: 
		     file where host.os.type == "windows" and event.type ==
		     "creation" and file.extension == "lnk" and
		     file.Ext.windows.zone_identifier > 1

NamE: Elastic Agent Service Terminated
	description: 
		     Identifies the Elastic endpoint agent has
		     stopped and is no longer running on the host. Adversaries may
		     attempt to disable security monitoring tools in an attempt to
		     evade detection or prevention capabilities during an intrusion.
		     This may also indicate an issue with the agent itself and
		     should be addressed to ensure defensive measures are back in a
		     stable state.
	query: 
		     process where /* net, sc or wmic stopping or deleting
		     Elastic Agent on Windows */ (event.type == "start" and
		     process.name : ("net.exe", "sc.exe", "wmic.exe","powershell.exe
		     ","taskkill.exe","PsKill.exe","ProcessHacker.exe") and
		     process.args : ("stopservice","uninstall", "stop",
		     "disabled","Stop-Process","terminate","suspend") and
		     process.args : ("elasticendpoint", "Elastic Agent","elastic-
		     agent","elastic-endpoint")) or /* service or systemctl used to
		     stop Elastic Agent on Linux */ (event.type == "end" and
		     (process.name : ("systemctl", "service") and     process.args :
		     "elastic-agent" and     process.args : ("stop", "disable"))
		     or   /* pkill , killall used to stop Elastic Agent on Linux */
		     ( event.type == "end" and process.name : ("pkill", "killall")
		     and process.args: "elastic-agent")   or   /* Unload Elastic
		     Agent extension on MacOS */   (process.name : "kextunload" and
		     process.args : "com.apple.iokit.EndpointSecurity" and
		     event.action : "end"))

NamE: Systemd Shell Execution During Boot
	description: 
		     This rule detects the execution of shell
		     commands by systemd during the boot process on Linux systems.
		     Systemd is a system and service manager for Linux operating
		     systems. Attackers may execute shell commands during the boot
		     process to maintain persistence on the system. This may be a
		     sign of malicious systemd services, initramfs or GRUB
		     bootloader manipulation, or other persistence mechanisms.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "info" and event.action == "already_running" and
		     process.parent.name == "systemd" and process.name in ("bash",
		     "sh", "tcsh", "csh", "zsh", "ksh", "fish") and
		     process.parent.command_line == "/sbin/init" and
		     process.args_count >= 2

NamE: Kernel Module Load via insmod
	description: 
		     Detects the use of the insmod binary to load a
		     Linux kernel object file. Threat actors can use this binary,
		     given they have root privileges, to load a rootkit on a system
		     providing them with complete control and the ability to hide
		     from security products. Manually loading a kernel module in
		     this manner should not be at all common and can indicate
		     suspcious or malicious behavior.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and process.name == "insmod" and process.args :
		     "*.ko" and not process.parent.executable like (
		     "/opt/ds_agent/*", "/usr/sbin/veeamsnap-loader",
		     "/opt/TrendMicro/vls_agent/*", "/opt/intel/oneapi/*",
		     "/opt/commvault/Base/linux_drv", "/bin/falcoctl" )

NamE: Indirect Command Execution via Forfiles/Pcalua
	description: 
		     Identifies indirect command execution via
		     Program Compatibility Assistant (pcalua.exe) or forfiles.exe.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.name : ("pcalua.exe",
		     "forfiles.exe")

NamE: Hosts File Modified
	description: 
		     The hosts file on endpoints is used to control
		     manual IP address to hostname resolutions. The hosts file is
		     the first point of lookup for DNS hostname resolution so if
		     adversaries can modify the endpoint hosts file, they can route
		     traffic to malicious infrastructure. This rule detects
		     modifications to the hosts file on Microsoft Windows, Linux
		     (Ubuntu or RHEL) and macOS systems.
	query: 
		     any where    /* file events for creation; file change
		     events are not captured by some of the included sources for
		     linux and so may      miss this, which is the purpose of the
		     process + command line args logic below */   (
		     event.category == "file" and event.type in ("change",
		     "creation") and      file.path : ("/private/etc/hosts",
		     "/etc/hosts", "?:\\Windows\\System32\\drivers\\etc\\hosts") and
		     not process.name in ("dockerd", "rootlesskit", "podman",
		     "crio")   )   or    /* process events for change targeting
		     linux only */   (    event.category == "process" and event.type
		     in ("start") and      process.name in ("nano", "vim", "vi",
		     "emacs", "echo", "sed") and      process.args : ("/etc/hosts")
		     and       not process.parent.name in ("dhclient-script",
		     "google_set_hostname")   )

NamE: Kernel Seeking Activity
	description: 
		     This rule detects kernel seeking activity
		     through several built-in Linux utilities. Attackers may use
		     these utilities to search the Linux kernel for available
		     symbols, functions, and other information that can be used to
		     exploit the kernel.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action == "exec" and (process.parent.args
		     like "/boot/*" or process.args like "/boot/*") and (
		     (process.name == "tail" and (process.args like "-c*" or
		     process.args == "--bytes")) or   (process.name == "cmp" and
		     process.args == "-i") or   (process.name in ("hexdump", "xxd")
		     and process.args == "-s") or   (process.name == "dd" and
		     process.args like "seek*") )

NamE: Suspicious SolarWinds Child Process
	description: 
		     A suspicious SolarWinds child process was
		     detected, which may indicate an attempt to execute malicious
		     programs.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  process.parent.name:
		     ("SolarWinds.BusinessLayerHost.exe",
		     "SolarWinds.BusinessLayerHostx64.exe") and  not (
		     process.name : (         "APMServiceControl*.exe",
		     "ExportToPDFCmd*.Exe",
		     "SolarWinds.Credentials.Orion.WebApi*.exe",
		     "SolarWinds.Orion.Topology.Calculator*.exe",         "Database-
		     Maint.exe",         "SolarWinds.Orion.ApiPoller.Service.exe",
		     "WerFault.exe",         "WerMgr.exe",
		     "SolarWinds.BusinessLayerHost.exe",
		     "SolarWinds.BusinessLayerHostx64.exe",
		     "SolarWinds.Topology.Calculator.exe",
		     "SolarWinds.Topology.Calculatorx64.exe",
		     "SolarWinds.APM.RealTimeProcessPoller.exe") and
		     process.code_signature.trusted == true  ) and  not
		     process.executable : ("?:\\Windows\\SysWOW64\\ARP.EXE",
		     "?:\\Windows\\SysWOW64\\lodctr.exe",
		     "?:\\Windows\\SysWOW64\\unlodctr.exe")

NamE: First Occurrence of IP Address For GitHub User
	description: 
		     Detects a new IP address used for a GitHub user
		     not previously seen in the last 14 days.
	query: 
		     event.dataset:"github.audit" and
		     event.category:"configuration" and github.actor_ip:* and
		     user.name:*

NamE: Service Disabled via Registry Modification
	description: 
		     Identifies attempts to modify services start
		     settings using processes other than services.exe. Attackers may
		     attempt to modify security and monitoring services to avoid
		     detection or delay response.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.path : (
		     "HKLM\\SYSTEM\\*ControlSet*\\Services\\*\\Start",
		     "\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Services\\*\\Start"
		     ) and registry.data.strings : ("3", "4") and   not      (
		     process.name : "services.exe" and user.id : "S-1-5-18"     )
		     and not registry.path :
		     "HKLM\\SYSTEM\\ControlSet001\\Services\\MrxSmb10\\Start"

NamE: Unusual Process Extension
	description: 
		     Identifies processes running with unusual
		     extensions that are not typically valid for Windows
		     executables.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.executable : "?*" and    not
		     process.name : ("*.exe", "*.com", "*.scr", "*.tmp", "*.dat")
		     and   not process.executable :      (       "MemCompression",
		     "Registry",       "vmmem",       "vmmemWSL",       "?:\\Program
		     Files\\Dell\\SupportAssistAgent\\*.p5x",       "?:\\Program
		     Files\\Docker\\Docker\\com.docker.service",       "?:\\Users\\*
		     \\AppData\\Local\\Intel\\AGS\\Libs\\AGSRunner.bin",
		     "\\Device\\Mup\\*\\Software Management\\Select.Html.dep",
		     "?:\\DJJApplications\\MedicalRecords\\bin\\Select.Html.dep",
		     "?:\\ProgramData\\Software Management\\Select.Html.dep",
		     "?:\\Program Files (x86)\\EnCase Applications\\Examiner
		     Service\\EnCase64\\enhkey.dll",       "?:\\Program Files
		     (x86)\\Panda Security\\WAC\\PSNAEInj64.dll",       "?:\\Program
		     Files (x86)\\Johnson Controls\\LicenseActivator\\crp32002.ngn"
		     ) and   not (     (process.name :
		     "C9632CF058AE4321B6B0B5EA39B710FE" and
		     process.code_signature.subject_name == "Dell Inc") or
		     (process.name : "*.upd" and process.code_signature.subject_name
		     == "Bloomberg LP") or     (process.name:
		     "FD552E21-686E-413C-931D-3B82A9D29F3B" and
		     process.code_signature.subject_name: "Adobe Inc.") or
		     (process.name: "3B91051C-AE82-43C9-BCEF-0309CD2DD9EB" and
		     process.code_signature.subject_name: "McAfee, LLC") or
		     (process.name: "soffice.bin" and
		     process.code_signature.subject_name: "The Document Foundation")
		     or     (process.name: ("VeeamVixProxy_*",
		     "{????????-????-????-????-????????????}") and
		     process.code_signature.subject_name: "Veeam Software Group
		     GmbH") or     (process.name: "1cv8p64.bin" and
		     process.code_signature.subject_name: "LLC 1C-Soft") or
		     (process.name: "AGSRunner.bin" and
		     process.code_signature.subject_name: "Intel Corporation")   )

NamE: Persistence via Hidden Run Key Detected
	description: 
		     Identifies a persistence mechanism that utilizes
		     the NtSetValueKey native API to create a hidden (null
		     terminated) registry key. An adversary may use this method to
		     hide from system utilities such as the Registry Editor
		     (regedit).
	query: 
		     /* Registry Path ends with backslash */ registry where
		     host.os.type == "windows" and event.type == "change" and
		     length(registry.data.strings) > 0 and  registry.path : ("HKEY_U
		     SERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\",
		     "HKU\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\",
		     "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\",
		     "HKLM\\Software\\WOW6432Node\\Microsoft\\Windows\\CurrentVersio
		     n\\Run\\",                   "HKEY_USERS\\*\\Software\\Microsof
		     t\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\",
		     "HKU\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies
		     \\Explorer\\Run\\",                   "\\REGISTRY\\MACHINE\\Sof
		     tware\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\
		     Run\\",                   "\\REGISTRY\\USER\\*\\Software\\Micro
		     soft\\Windows\\CurrentVersion\\Run\\",                   "\\REG
		     ISTRY\\MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\R
		     un\\",                   "\\REGISTRY\\MACHINE\\Software\\WOW643
		     2Node\\Microsoft\\Windows\\CurrentVersion\\Run\\",
		     "\\REGISTRY\\USER\\*\\Software\\Microsoft\\Windows\\CurrentVers
		     ion\\Policies\\Explorer\\Run\\",                   "\\REGISTRY\
		     \MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Policie
		     s\\Explorer\\Run\\")

NamE: Execution via MS VisualStudio Pre/Post Build Events
	description: 
		     Identifies the execution of a command via
		     Microsoft Visual Studio Pre or Post build events. Adversaries
		     may backdoor a trusted visual studio project to execute a
		     malicious command during the project build process.
	query: 
		     sequence with maxspan=1m   [process where host.os.type
		     == "windows" and event.action == "start" and    process.name :
		     "cmd.exe" and process.parent.name : "MSBuild.exe" and
		     process.args :
		     "?:\\Users\\*\\AppData\\Local\\Temp\\tmp*.exec.cmd"] by
		     process.entity_id   [process where host.os.type == "windows"
		     and event.action == "start" and     process.name : (
		     "cmd.exe", "powershell.exe",       "MSHTA.EXE", "CertUtil.exe",
		     "CertReq.exe", "rundll32.exe",       "regsvr32.exe",
		     "MSbuild.exe",       "cscript.exe", "wscript.exe",
		     "installutil.exe"     ) and     not      (       process.name :
		     ("cmd.exe", "powershell.exe") and       process.args : (
		     "*\\vcpkg\\scripts\\buildsystems\\msbuild\\applocal.ps1",
		     "HKLM\\SOFTWARE\\Microsoft\\VisualStudio\\SxS\\VS?",
		     "process.versions.node*",         "?:\\Program
		     Files\\nodejs\\node.exe",         "HKEY_LOCAL_MACHINE\\SOFTWARE
		     \\Microsoft\\MSBuild\\ToolsVersions\\*",         "*Get-
		     ChildItem*Tipasplus.css*",
		     "Build\\GenerateResourceScripts.ps1",
		     "Shared\\Common\\..\\..\\BuildTools\\ConfigBuilder.ps1\"",
		     "?:\\Projets\\*\\PostBuild\\MediaCache.ps1"       )     ) and
		     not process.executable : "?:\\Program Files*\\Microsoft Visual
		     Studio\\*\\MSBuild.exe" and     not (process.name : "cmd.exe"
		     and          process.command_line :
		     ("*vswhere.exe -property catalog_productSemanticVersion*",
		     "*git log --pretty=format*", "*\\.nuget\\packages\\vswhere\\*",
		     "*Common\\..\\..\\BuildTools\\*"))   ] by
		     process.parent.entity_id

NamE: Executable File with Unusual Extension
	description: 
		     Identifies the creation or modification of an
		     executable file with an unexpected file extension. Attackers
		     may attempt to evade detection by masquerading files using the
		     file extension values used by image, audio, or document file
		     types.
	query: 
		     file where host.os.type == "windows" and event.action
		     != "deletion" and   /* MZ header or its common base64
		     equivalent TVqQ */  file.Ext.header_bytes : ("4d5a*",
		     "54567151*") and   (    /* common image file extensions */
		     file.extension : ("jpg", "jpeg", "emf", "tiff", "gif", "png",
		     "bmp", "fpx", "eps", "svg", "inf") or     /* common audio and
		     video file extensions */    file.extension : ("mp3", "wav",
		     "avi", "mpeg", "flv", "wma", "wmv", "mov", "mp4", "3gp") or
		     /* common document file extensions */    file.extension :
		     ("txt", "pdf", "doc", "docx", "rtf", "ppt", "pptx", "xls",
		     "xlsx", "hwp", "html")   ) and   not process.pid == 4 and   not
		     process.executable : "?:\\Program Files (x86)\\Trend
		     Micro\\Client Server Security Agent\\Ntrtscan.exe"

NamE: Threat Intel URL Indicator Match
	description: 
		     This rule is triggered when a URL indicator from
		     the Threat Intel Filebeat module or integrations has a match
		     against an event that contains URL data, like DNS events,
		     network logs, etc.
	query: 
		     url.full:*

NamE: Microsoft IIS Connection Strings Decryption
	description: 
		     Identifies use of aspnet_regiis to decrypt
		     Microsoft IIS connection strings. An attacker with Microsoft
		     IIS web server access via a webshell or alike can decrypt and
		     dump any hardcoded connection strings, such as the MSSQL
		     service account password using aspnet_regiis command.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (process.name : "aspnet_regiis.exe" or
		     ?process.pe.original_file_name == "aspnet_regiis.exe") and
		     process.args : "connectionStrings" and process.args : "-pdf"

NamE: Machine Learning Detected a Suspicious Windows Event with a High Malicious Probability Score
	description: 
		     A supervised machine learning model
		     (ProblemChild) has identified a suspicious Windows process
		     event with high probability of it being malicious activity.
		     Alternatively, the model's blocklist identified the event as
		     being malicious.
	query: 
		     process where ((problemchild.prediction == 1 and
		     problemchild.prediction_probability > 0.98) or blocklist_label
		     == 1) and not process.args :
		     ("*C:\\WINDOWS\\temp\\nessus_*.txt*",
		     "*C:\\WINDOWS\\temp\\nessus_*.tmp*")

NamE: Suspicious Microsoft Diagnostics Wizard Execution
	description: 
		     Identifies potential abuse of the Microsoft
		     Diagnostics Troubleshooting Wizard (MSDT) to proxy malicious
		     command or binary execution via malicious process arguments.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and    (process.pe.original_file_name == "msdt.exe"
		     or process.name : "msdt.exe") and    (     process.args :
		     ("IT_RebrowseForFile=*", "ms-msdt:/id", "ms-msdt:-id",
		     "*FromBase64*") or      (process.args : "-af" and process.args
		     : "/skip" and      process.parent.name : ("explorer.exe",
		     "cmd.exe", "powershell.exe", "cscript.exe", "wscript.exe",
		     "mshta.exe", "rundll32.exe", "regsvr32.exe") and
		     process.args :
		     ("?:\\WINDOWS\\diagnostics\\index\\PCWDiagnostic.xml",
		     "PCWDiagnostic.xml", "?:\\Users\\Public\\*",
		     "?:\\Windows\\Temp\\*")) or      (process.pe.original_file_name
		     == "msdt.exe" and not process.name : "msdt.exe" and
		     process.name != null) or      (process.pe.original_file_name ==
		     "msdt.exe" and not process.executable :
		     ("?:\\Windows\\system32\\msdt.exe",
		     "?:\\Windows\\SysWOW64\\msdt.exe"))     )

NamE: Command Prompt Network Connection
	description: 
		     Identifies cmd.exe making a network connection.
		     Adversaries could abuse cmd.exe to download or execute malware
		     from a remote URL.
	query: 
		     sequence by process.entity_id   [process where
		     host.os.type == "windows" and process.name : "cmd.exe" and
		     event.type == "start"]   [network where host.os.type ==
		     "windows" and process.name : "cmd.exe" and      not
		     cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8",
		     "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24",
		     "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32",
		     "192.0.0.10/32", "192.0.0.170/32",
		     "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24",
		     "192.52.193.0/24",
		     "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4",
		     "100.64.0.0/10", "192.175.48.0/24",
		     "198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24",
		     "240.0.0.0/4", "::1",
		     "FE80::/10", "FF00::/8") and     not dns.question.name : (
		     "wpad", "localhost", "ocsp.comodoca.com", "ocsp.digicert.com",
		     "ocsp.sectigo.com", "crl.comodoca.com"     )]

NamE: Potential Linux Tunneling and/or Port Forwarding
	description: 
		     This rule monitors for a set of Linux utilities
		     that can be used for tunneling and port forwarding. Attackers
		     can leverage tunneling and port forwarding techniques to bypass
		     network defenses, establish hidden communication channels, and
		     gain unauthorized access to internal resources, facilitating
		     data exfiltration, lateral movement, and remote control.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2") and (   (     // gost & pivotnacci - spawned
		     without process.parent.name     (process.name == "gost" and
		     process.args : ("-L*", "-C*", "-R*")) or (process.name ==
		     "pivotnacci")) or (     // ssh     (process.name in ("ssh",
		     "sshd") and (process.args in ("-R", "-L", "-D", "-w") and
		     process.args_count >= 4 and       not process.args : "chmod"))
		     or     // sshuttle     (process.name == "sshuttle" and
		     process.args in ("-r", "--remote", "-l", "--listen") and
		     process.args_count >= 4) or     // socat     (process.name ==
		     "socat" and process.args : ("TCP4-LISTEN:*", "SOCKS*") and
		     process.args_count >= 3) or     // chisel     (process.name :
		     "chisel*" and process.args in ("client", "server")) or     //
		     iodine(d), dnscat, hans, ptunnel-ng, ssf, 3proxy & ngrok
		     (process.name in ("iodine", "iodined", "dnscat", "hans", "hans-
		     ubuntu", "ptunnel-ng", "ssf", "3proxy", "ngrok"))   ) and
		     process.parent.name in ("bash", "dash", "ash", "sh", "tcsh",
		     "csh", "zsh", "ksh", "fish") )

NamE: Potential Suspicious DebugFS Root Device Access
	description: 
		     This rule monitors for the usage of the built-in
		     Linux DebugFS utility to access a disk device without root
		     permissions. Linux users that are part of the "disk" group have
		     sufficient privileges to access all data inside of the machine
		     through DebugFS. Attackers may leverage DebugFS in conjunction
		     with "disk" permissions to read sensitive files owned by root,
		     such as the shadow file, root ssh private keys or other
		     sensitive files that may allow them to further escalate
		     privileges.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action == "exec" and process.name ==
		     "debugfs" and process.args : "/dev/sd*" and not process.args ==
		     "-R" and not user.Ext.real.id == "0" and not group.Ext.real.id
		     == "0"

NamE: Potential Foxmail Exploitation
	description: 
		     Identifies the Foxmail client spawning a child
		     process with argument pointing to the Foxmail temp directory.
		     This may indicate the successful exploitation of a Foxmail
		     vulnerability for initial access and execution via a malicious
		     email.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  process.parent.name : "Foxmail.exe" and
		     process.args : ("?:\\Users\\*\\AppData\\*", "\\\\*")

NamE: Windows Firewall Disabled via PowerShell
	description: 
		     Identifies when the Windows Firewall is disabled
		     using PowerShell cmdlets, which can help attackers evade
		     network constraints, like internet and network lateral
		     communication restrictions.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (     process.name : ("powershell.exe",
		     "pwsh.exe", "powershell_ise.exe") or
		     ?process.pe.original_file_name in ("powershell.exe",
		     "pwsh.dll", "powershell_ise.exe")   ) and   process.args :
		     "*Set-NetFirewallProfile*" and   process.args : "*-Enabled*"
		     and process.args : "*False*" and   process.args : ("*-All*",
		     "*Public*", "*Domain*", "*Private*")

NamE: Potential Privilege Escalation via Service ImagePath Modification
	description: 
		     Identifies registry modifications to default
		     services that could enable privilege escalation to SYSTEM.
		     Attackers with privileges from groups like Server Operators may
		     change the ImagePath of services to executables under their
		     control or to execute commands.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and process.executable != null and
		     event.action == "modification" and registry.value ==
		     "ImagePath" and   registry.key : (     "*\\ADWS",
		     "*\\AppHostSvc", "*\\AppReadiness", "*\\AudioEndpointBuilder",
		     "*\\AxInstSV", "*\\camsvc", "*\\CertSvc",     "*\\COMSysApp",
		     "*\\CscService", "*\\defragsvc", "*\\DeviceAssociationService",
		     "*\\DeviceInstall", "*\\DevQueryBroker",     "*\\Dfs",
		     "*\\DFSR", "*\\diagnosticshub.standardcollector.service",
		     "*\\DiagTrack", "*\\DmEnrollmentSvc", "*\\DNS",
		     "*\\dot3svc", "*\\Eaphost", "*\\GraphicsPerfSvc", "*\\hidserv",
		     "*\\HvHost", "*\\IISADMIN", "*\\IKEEXT",
		     "*\\InstallService", "*\\iphlpsvc", "*\\IsmServ",
		     "*\\LanmanServer", "*\\MSiSCSI", "*\\NcbService",
		     "*\\Netlogon",     "*\\Netman", "*\\NtFrs", "*\\PlugPlay",
		     "*\\Power", "*\\PrintNotify", "*\\ProfSvc", "*\\PushToInstall",
		     "*\\RSoPProv",     "*\\sacsvr", "*\\SENS",
		     "*\\SensorDataService", "*\\SgrmBroker", "*\\ShellHWDetection",
		     "*\\shpamsvc", "*\\StorSvc",     "*\\svsvc", "*\\swprv",
		     "*\\SysMain", "*\\Themes", "*\\TieringEngineService",
		     "*\\TokenBroker", "*\\TrkWks",     "*\\UALSVC",
		     "*\\UserManager", "*\\vm3dservice", "*\\vmicguestinterface",
		     "*\\vmicheartbeat", "*\\vmickvpexchange",     "*\\vmicrdv",
		     "*\\vmicshutdown", "*\\vmicvmsession", "*\\vmicvss",
		     "*\\vmvss", "*\\VSS", "*\\w3logsvc", "*\\W3SVC",
		     "*\\WalletService", "*\\WAS", "*\\wercplsupport", "*\\WerSvc",
		     "*\\Winmgmt", "*\\wisvc", "*\\wmiApSrv",     "*\\WPDBusEnum",
		     "*\\WSearch"   ) and   not (     registry.data.strings : (
		     "?:\\Windows\\system32\\*.exe",
		     "%systemroot%\\system32\\*.exe",
		     "%windir%\\system32\\*.exe",
		     "%SystemRoot%\\system32\\svchost.exe -k *",
		     "%windir%\\system32\\svchost.exe -k *"     ) and         not
		     registry.data.strings : (             "*\\cmd.exe",
		     "*\\cscript.exe",             "*\\ieexec.exe",
		     "*\\iexpress.exe",             "*\\installutil.exe",
		     "*\\Microsoft.Workflow.Compiler.exe",
		     "*\\msbuild.exe",             "*\\mshta.exe",
		     "*\\msiexec.exe",             "*\\msxsl.exe",
		     "*\\net.exe",             "*\\powershell.exe",
		     "*\\pwsh.exe",             "*\\reg.exe",
		     "*\\RegAsm.exe",             "*\\RegSvcs.exe",
		     "*\\regsvr32.exe",             "*\\rundll32.exe",
		     "*\\vssadmin.exe",             "*\\wbadmin.exe",
		     "*\\wmic.exe",             "*\\wscript.exe"         )   )

NamE: Deprecated - Suspicious File Creation in /etc for Persistence
	description: 
		     Detects the manual creation of files in specific
		     etc directories, via user root, used by Linux malware to
		     persist and elevate privileges on compromised systems. File
		     creation in these directories should not be entirely common and
		     could indicate a malicious binary or script installing
		     persistence mechanisms for long term access.
	query: 
		     file where host.os.type == "linux" and event.type in
		     ("creation", "file_create_event") and user.id == "0" and
		     file.path : ("/etc/ld.so.conf.d/*", "/etc/cron.d/*",
		     "/etc/sudoers.d/*", "/etc/init.d/*", "/etc/systemd/system/*",
		     "/usr/lib/systemd/system/*") and not (   (process.name : (
		     "chef-client", "ruby", "pacman", "packagekitd", "python*",
		     "platform-python", "dpkg", "yum", "apt", "dnf", "rpm",
		     "systemd", "snapd", "dnf-automatic", "yum-cron", "elastic-
		     agent", "dnfdaemon-system", "dockerd", "executor",
		     "rhn_check"     )   ) or    (file.extension in ("swp", "swpx",
		     "tmp")) )

NamE: Persistence via WMI Event Subscription
	description: 
		     An adversary can use Windows Management
		     Instrumentation (WMI) to install event filters, providers,
		     consumers, and bindings that execute code when a defined event
		     occurs. Adversaries may use the capabilities of WMI to
		     subscribe to an event and execute arbitrary code when that
		     event occurs, providing persistence on a system.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (process.name : "wmic.exe" or
		     ?process.pe.original_file_name == "wmic.exe") and
		     process.args : "create" and   process.args :
		     ("ActiveScriptEventConsumer", "CommandLineEventConsumer")

NamE: Potential File Transfer via Certreq
	description: 
		     Identifies Certreq making an HTTP Post request.
		     Adversaries could abuse Certreq to download files or upload
		     data to a remote URL.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  (process.name : "CertReq.exe" or
		     ?process.pe.original_file_name == "CertReq.exe") and
		     process.args : "-Post"

NamE: Deleting Backup Catalogs with Wbadmin
	description: 
		     Identifies use of the wbadmin.exe to delete the
		     backup catalog. Ransomware and other malware may do this to
		     prevent system recovery.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (process.name : "wbadmin.exe" or
		     ?process.pe.original_file_name == "WBADMIN.EXE") and
		     process.args : "catalog" and process.args : "delete"

NamE: Suspicious Path Invocation from Command Line
	description: 
		     This rule detects the execution of a PATH
		     variable in a command line invocation by a shell process. This
		     behavior is unusual and may indicate an attempt to execute a
		     command from a non-standard location. This technique may be
		     used to evade detection or perform unauthorized actions on the
		     system.
	query: 
		     event.category:process and host.os.type:linux and
		     event.type:start and event.action:exec and process.name:(bash
		     or csh or dash or fish or ksh or sh or tcsh or zsh) and
		     process.args:-c and process.command_line:(*PATH=* and not
		     sh*/run/motd.dynamic.new)

NamE: Multiple Alerts in Different ATT&CK Tactics on a Single Host
	description: 
		     This rule uses alert data to determine when
		     multiple alerts in different phases of an attack involving the
		     same host are triggered. Analysts can use this to prioritize
		     triage and response, as these hosts are more likely to be
		     compromised.
	query: 
		     signal.rule.name:* and
		     kibana.alert.rule.threat.tactic.id:*

NamE: AWS STS Role Assumption by Service
	description: 
		     Identifies when a service has assumed a role in
		     AWS Security Token Service (STS). Services can assume a role to
		     obtain temporary credentials and access AWS resources.
		     Adversaries can use this technique for credential access and
		     privilege escalation. This is a [New
		     Terms](https://www.elastic.co/guide/en/security/current/rules-
		     ui-create.html#create-new-terms-rule) rule that identifies when
		     a service assumes a role in AWS Security Token Service (STS) to
		     obtain temporary credentials and access AWS resources. While
		     often legitimate, adversaries may use this technique for
		     unauthorized access, privilege escalation, or lateral movement
		     within an AWS environment.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "sts.amazonaws.com"     and event.action:
		     "AssumeRole"     and event.outcome: "success"     and
		     aws.cloudtrail.user_identity.type: "AWSService"     and
		     aws.cloudtrail.user_identity.invoked_by: (
		     "ec2.amazonaws.com" or           "lambda.amazonaws.com" or
		     "rds.amazonaws.com" or           "ssm.amazonaws.com" or
		     "ecs-tasks.amazonaws.com" or           "ecs.amazonaws.com" or
		     "eks.amazonaws.com" or           "eks-fargate.amazonaws.com" or
		     "codepipeline.amazonaws.com" or
		     "codebuild.amazonaws.com" or
		     "autoscaling.amazonaws.com")

NamE: PowerShell Suspicious Script with Screenshot Capabilities
	description: 
		     Detects PowerShell scripts that can take
		     screenshots, which is a common feature in post-exploitation
		     kits and remote access tools (RATs).
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (     CopyFromScreen and
		     ("System.Drawing.Bitmap" or "Drawing.Bitmap")   ) and not
		     user.id : "S-1-5-18"

NamE: Google Workspace Restrictions for Marketplace Modified to Allow Any App
	description: 
		     Detects when the Google Marketplace restrictions
		     are changed to allow any application for users in Google
		     Workspace. Malicious APKs created by adversaries may be
		     uploaded to the Google marketplace but not installed on devices
		     managed within Google Workspace. Administrators should set
		     restrictions to not allow any application from the marketplace
		     for security reasons. Adversaries may enable any app to be
		     installed and executed on mobile devices within a Google
		     Workspace environment prior to distributing the malicious APK
		     to the end user.
	query: 
		     event.dataset:"google_workspace.admin" and
		     event.action:"CHANGE_APPLICATION_SETTING" and
		     event.category:(iam or configuration)     and
		     google_workspace.event.type:"APPLICATION_SETTINGS" and
		     google_workspace.admin.application.name:"Google Workspace
		     Marketplace"         and
		     google_workspace.admin.setting.name:"Apps Access Setting
		     Allowlist access"  and
		     google_workspace.admin.new_value:"ALLOW_ALL"

NamE: Potential Network Sweep Detected
	description: 
		     This rule identifies a potential network sweep.
		     A network sweep is a method used by attackers to scan a target
		     network, identifying active hosts, open ports, and available
		     services to gather information on vulnerabilities and
		     weaknesses. This reconnaissance helps them plan subsequent
		     attacks and exploit potential entry points for unauthorized
		     access, data theft, or other malicious activities. This rule
		     defines a threshold-based approach to detect multiple
		     connection attempts from a single host to numerous destination
		     hosts over commonly used network services.
	query: 
		     event.action:network_flow and destination.port:(21 or
		     22 or 23 or 25 or 139 or 445 or 3389 or 5985 or 5986) and
		     source.ip:(10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16)

NamE: Potential Sudo Token Manipulation via Process Injection
	description: 
		     This rule detects potential sudo token
		     manipulation attacks through process injection by monitoring
		     the use of a debugger (gdb) process followed by a successful
		     uid change event during the execution of the sudo process. A
		     sudo token manipulation attack is performed by injecting into a
		     process that has a valid sudo token, which can then be used by
		     attackers to activate their own sudo token. This attack
		     requires ptrace to be enabled in conjunction with the existence
		     of a living process that has a valid sudo token with the same
		     uid as the current user.
	query: 
		     sequence by host.id, process.session_leader.entity_id
		     with maxspan=15s [ process where host.os.type == "linux" and
		     event.type == "start" and event.action == "exec" and
		     process.name == "gdb" and process.user.id != "0" and
		     process.group.id != "0" ] [ process where host.os.type ==
		     "linux" and event.action == "uid_change" and event.type ==
		     "change" and   process.name == "sudo" and process.user.id ==
		     "0" and process.group.id == "0" ]

NamE: Potential Defense Evasion via Doas
	description: 
		     This rule detects the creation or rename of the
		     Doas configuration file on a Linux system. Adversaries may
		     create or modify the Doas configuration file to elevate
		     privileges and execute commands as other users while attempting
		     to evade detection.
	query: 
		     file where host.os.type == "linux" and event.type !=
		     "deletion" and file.path == "/etc/doas.conf"

NamE: ROT Encoded Python Script Execution
	description: 
		     Identifies the execution of a Python script that
		     uses the ROT cipher for letters substitution. Adversaries may
		     use this method to encode and obfuscate part of their malicious
		     code in legit python packages.
	query: 
		     sequence by process.entity_id with maxspan=1m
		     [process where host.os.type in ("windows", "macos") and
		     event.type == "start" and process.name : "python*"]  [file
		     where host.os.type in ("windows", "macos") and   event.action
		     != "deletion" and process.name : "python*" and file.name :
		     "rot_??.cpython-*.pyc*"]

NamE: Linux User Account Credential Modification
	description: 
		     This rule detects Linux user account credential
		     modification events where the echo command is used to directly
		     echo a password into the passwd utility. This technique is used
		     by malware to automate the process of user account credential
		     modification on Linux systems post-infection.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action == "exec" and process.name in
		     ("bash", "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish") and
		     process.command_line like~ "*echo*passwd*" and not (
		     process.parent.command_line == "runc init" or
		     process.parent.executable in ("/usr/bin/make", "/bin/make") )

NamE: Virtual Machine Fingerprinting via Grep
	description: 
		     An adversary may attempt to get detailed
		     information about the operating system and hardware. This rule
		     identifies common locations used to discover virtual machine
		     hardware by a non-root user. This technique has been used by
		     the Pupy RAT and other malware.
	query: 
		     process where event.type == "start" and  process.name
		     in ("grep", "egrep") and user.id != "0" and  process.args :
		     ("parallels*", "vmware*", "virtualbox*") and process.args :
		     "Manufacturer*" and  not process.parent.executable in
		     ("/Applications/Docker.app/Contents/MacOS/Docker",
		     "/usr/libexec/kcare/virt-what")

NamE: Werfault ReflectDebugger Persistence
	description: 
		     Identifies the registration of a Werfault
		     Debugger. Attackers may abuse this mechanism to execute
		     malicious payloads every time the utility is executed with the
		     "-pr" parameter.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.path : (
		     "HKLM\\Software\\Microsoft\\Windows\\Windows Error
		     Reporting\\Hangs\\ReflectDebugger",
		     "\\REGISTRY\\MACHINE\\Software\\Microsoft\\Windows\\Windows
		     Error Reporting\\Hangs\\ReflectDebugger",
		     "MACHINE\\Software\\Microsoft\\Windows\\Windows Error
		     Reporting\\Hangs\\ReflectDebugger"   )

NamE: Potential Protocol Tunneling via Chisel Client
	description: 
		     This rule monitors for common command line flags
		     leveraged by the Chisel client utility followed by a connection
		     attempt. Chisel is a command-line utility used for creating and
		     managing TCP and UDP tunnels, enabling port forwarding and
		     secure communication between machines. Attackers can abuse the
		     Chisel utility to establish covert communication channels,
		     bypass network restrictions, and carry out malicious activities
		     by creating tunnels that allow unauthorized access to internal
		     systems.
	query: 
		     sequence by host.id, process.entity_id with maxspan=3s
		     [process where host.os.type == "linux" and event.type ==
		     "start" and event.action == "exec" and     process.args ==
		     "client" and process.args : ("R*", "*:*", "*socks*", "*.*") and
		     process.args_count >= 4 and     process.parent.name in ("bash",
		     "dash", "ash", "sh", "tcsh", "csh", "zsh", "ksh", "fish") and
		     not process.name in ("velociraptor", "nbemmcmd", "redis-cli",
		     "ipa")]   [network where host.os.type == "linux" and
		     event.action == "connection_attempted" and event.type ==
		     "start" and     destination.ip != null and destination.ip !=
		     "127.0.0.1" and destination.ip != "::1" and     not
		     process.name : (      "python*", "php*", "perl", "ruby",
		     "lua*", "openssl", "nc", "netcat", "ncat", "telnet", "awk",
		     "java", "telnet",      "ftp", "socat", "curl", "wget", "dpkg",
		     "docker", "dockerd", "yum", "apt", "rpm", "dnf", "ssh",
		     "sshd")]

NamE: Remote File Copy to a Hidden Share
	description: 
		     Identifies a remote file copy attempt to a
		     hidden network share. This may indicate lateral movement or
		     data staging activity.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : ("cmd.exe", "powershell.exe",
		     "xcopy.exe", "pwsh.exe", "powershell_ise.exe") and
		     process.command_line : "*\\\\*\\*$*" and process.command_line :
		     ("*copy*", "*move*", "* cp *", "* mv *")

NamE: Windows Subsystem for Linux Enabled via Dism Utility
	description: 
		     Detects attempts to enable the Windows Subsystem
		     for Linux using Microsoft Dism utility. Adversaries may enable
		     and use WSL for Linux to avoid detection.
	query: 
		     process where host.os.type == "windows" and event.type
		     : "start" and  (process.name : "Dism.exe" or
		     ?process.pe.original_file_name == "DISM.EXE") and
		     process.command_line : "*Microsoft-Windows-Subsystem-Linux*"

NamE: OpenSSL Password Hash Generation
	description: 
		     This rule detects the usage of the `openssl`
		     binary to generate password hashes on Linux systems. The
		     `openssl` command is a cryptographic utility that can be used
		     to generate password hashes. Attackers may use `openssl` to
		     generate password hashes for new user accounts or to change the
		     password of existing accounts, which can be leveraged to
		     maintain persistence on a Linux system.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed") and process.name == "openssl" and
		     process.args == "passwd"

NamE: Suspicious Explorer Child Process
	description: 
		     Identifies a suspicious Windows explorer child
		     process. Explorer.exe can be abused to launch malicious scripts
		     or executables from a trusted parent process.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (    process.name : ("cscript.exe",
		     "wscript.exe", "powershell.exe", "rundll32.exe", "cmd.exe",
		     "mshta.exe", "regsvr32.exe") or
		     ?process.pe.original_file_name in ("cscript.exe",
		     "wscript.exe", "PowerShell.EXE", "RUNDLL32.EXE", "Cmd.Exe",
		     "MSHTA.EXE", "REGSVR32.EXE")   ) and   /* Explorer started via
		     DCOM */   process.parent.name : "explorer.exe" and
		     process.parent.args : "-Embedding" and   not
		     process.parent.args:           (             /* Noisy
		     CLSID_SeparateSingleProcessExplorerHost Explorer COM Class IDs
		     */
		     "/factory,{5BD95610-9434-43C2-886C-57852CC8A120}",
		     "/factory,{ceff45ee-c862-41de-aee2-a022c81eda92}"           )

NamE: Potential Shadow File Read via Command Line Utilities
	description: 
		     Identifies access to the /etc/shadow file via
		     the commandline using standard system utilities. After
		     elevating privileges to root, threat actors may attempt to read
		     or dump this file in order to gain valid credentials. They may
		     utilize these to move laterally undetected and access
		     additional resources.
	query: 
		     host.os.type : "linux" and event.category : "process"
		     and event.action : ("exec" or "exec_event") and (process.args :
		     "/etc/shadow" or (process.working_directory: "/etc" and
		     process.args: "shadow")) and not (   (process.executable :
		     ("/bin/chown" or "/usr/bin/chown") and process.args :
		     "root:shadow") or   (process.executable : ("/bin/chmod" or
		     "/usr/bin/chmod") and process.args : "640") or
		     process.executable:(/vz/* or /var/lib/docker/* or
		     /run/containerd/* or /tmp/.criu* or /tmp/newroot/*) or
		     process.parent.name:(gen_passwd_sets or scc_* or wazuh-
		     modulesd) )

NamE: Deprecated - Sensitive Files Compression Inside A Container
	description: 
		     Identifies the use of a compression utility to
		     collect known files containing sensitive information, such as
		     credentials and system configurations inside a container.
	query: 
		     process where container.id: "*" and event.type==
		     "start" and  /*account for tools that execute utilities as a
		     subprocess, in this case the target utility name will appear as
		     a process arg*/ (process.name: ("zip", "tar", "gzip",
		     "hdiutil", "7z") or process.args: ("zip", "tar", "gzip",
		     "hdiutil", "7z")) and process.args: ( "/root/.ssh/id_rsa",
		     "/root/.ssh/id_rsa.pub", "/root/.ssh/id_ed25519",
		     "/root/.ssh/id_ed25519.pub", "/root/.ssh/authorized_keys",
		     "/root/.ssh/authorized_keys2", "/root/.ssh/known_hosts",
		     "/root/.bash_history", "/etc/hosts", "/home/*/.ssh/id_rsa",
		     "/home/*/.ssh/id_rsa.pub", "/home/*/.ssh/id_ed25519",
		     "/home/*/.ssh/id_ed25519.pub", "/home/*/.ssh/authorized_keys",
		     "/home/*/.ssh/authorized_keys2", "/home/*/.ssh/known_hosts",
		     "/home/*/.bash_history", "/root/.aws/credentials",
		     "/root/.aws/config", "/home/*/.aws/credentials",
		     "/home/*/.aws/config", "/root/.docker/config.json",
		     "/home/*/.docker/config.json", "/etc/group", "/etc/passwd",
		     "/etc/shadow", "/etc/gshadow")

NamE: Excessive AWS S3 Object Encryption with SSE-C
	description: 
		     Identifies a high-volume of AWS S3 objects
		     stored in a bucket using using Server-Side Encryption with
		     Customer-Provided Keys (SSE-C). Adversaries with compromised
		     AWS credentials can encrypt objects in an S3 bucket using their
		     own encryption keys, rendering the objects unreadable or
		     recoverable without the key. This can be used as a form of
		     ransomware to extort the bucket owner for the decryption key.
		     This is a [Threshold](https://www.elastic.co/guide/en/security/
		     current/rules-ui-create.html#create-threshold-rule) rule that
		     flags when this behavior is observed for a specific bucket more
		     than 15 times in a short time-window.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "s3.amazonaws.com"     and event.action:
		     "PutObject"     and event.outcome: "success"     and
		     aws.cloudtrail.flattened.request_parameters.x-amz-server-side-
		     encryption-customer-algorithm: "AES256"     and
		     aws.cloudtrail.flattened.additional_eventdata.SSEApplied:
		     "SSE_C"

NamE: Privilege Escalation via Rogue Named Pipe Impersonation
	description: 
		     Identifies a privilege escalation attempt via
		     rogue named pipe impersonation. An adversary may abuse this
		     technique by masquerading as a known named pipe and
		     manipulating a privileged process to connect to it.
	query: 
		     file where host.os.type == "windows" and
		     event.provider == "Microsoft-Windows-Sysmon" and      /* Named
		     Pipe Creation */   event.code == "17" and      /* Sysmon
		     truncates the "Pipe" keyword in normal named pipe creation
		     events */   file.name : "\\*\\Pipe\\*"

NamE: First Occurrence of IP Address For GitHub Personal Access Token (PAT)
	description: 
		     Detects a new IP address used for a GitHub PAT
		     not previously seen in the last 14 days.
	query: 
		     event.dataset:"github.audit" and
		     event.category:"configuration" and github.actor_ip:* and
		     github.hashed_token:* and
		     github.programmatic_access_type:("OAuth access token" or "Fine-
		     grained personal access token")

NamE: Suspicious Process Creation CallTrace
	description: 
		     Identifies when a process is created and
		     immediately accessed from an unknown memory code region and by
		     the same parent process. This may indicate a code injection
		     attempt.
	query: 
		     sequence by host.id with maxspan=1m   [process where
		     host.os.type == "windows" and event.code == "1" and    /*
		     sysmon process creation */    process.parent.name :
		     ("winword.exe", "excel.exe", "outlook.exe", "powerpnt.exe",
		     "eqnedt32.exe", "fltldr.exe",
		     "mspub.exe", "msaccess.exe","cscript.exe", "wscript.exe",
		     "rundll32.exe", "regsvr32.exe",
		     "mshta.exe", "wmic.exe", "cmstp.exe", "msxsl.exe") and     /*
		     noisy FP patterns */    not (process.parent.name : "EXCEL.EXE"
		     and process.executable : "?:\\Program Files\\Microsoft
		     Office\\root\\Office*\\ADDINS\\*.exe") and    not
		     (process.executable : "?:\\Windows\\splwow64.exe" and
		     process.args in ("8192", "12288") and process.parent.name :
		     ("winword.exe", "excel.exe", "outlook.exe", "powerpnt.exe"))
		     and    not (process.parent.name : "rundll32.exe" and
		     process.parent.args : ("?:\\WINDOWS\\Installer\\MSI*.tmp,zzzzIn
		     vokeManagedCustomActionOutOfProc", "--no-sandbox")) and    not
		     (process.executable :             ("?:\\Program Files (x86)\\Mi
		     crosoft\\EdgeWebView\\Application\\*\\msedgewebview2.exe",
		     "?:\\Program Files\\Adobe\\Acrobat DC\\Acrobat\\Acrobat.exe",
		     "?:\\Windows\\SysWOW64\\DWWIN.EXE") and
		     process.parent.name : ("winword.exe", "excel.exe",
		     "outlook.exe", "powerpnt.exe")) and    not (process.parent.name
		     : "regsvr32.exe" and process.parent.args : ("?:\\Program
		     Files\\*", "?:\\Program Files (x86)\\*"))    ] by
		     process.parent.entity_id, process.entity_id   [process where
		     host.os.type == "windows" and event.code == "10" and    /*
		     Sysmon process access event from unknown module */
		     winlog.event_data.CallTrace : "*UNKNOWN*"] by
		     process.entity_id, winlog.event_data.TargetProcessGUID

NamE: Attempt to Disable IPTables or Firewall
	description: 
		     Adversaries may attempt to disable the iptables
		     or firewall service in an attempt to affect how a host is
		     allowed to receive or send network traffic.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start")
		     and   (    /* disable FW */    (      (process.name == "ufw"
		     and process.args == "disable") or      (process.name ==
		     "iptables" and process.args in ("-F", "--flush", "-X", "--
		     delete-chain") and process.args_count == 2) or
		     (process.name in ("iptables", "ip6tables") and
		     process.parent.args == "force-stop")    ) or     /* stop FW
		     service */    (      ((process.name == "service" and
		     process.args == "stop") or        (process.name == "chkconfig"
		     and process.args == "off") or        (process.name ==
		     "systemctl" and process.args in ("disable", "stop", "kill")))
		     and     process.args in ("firewalld", "ip6tables", "iptables",
		     "firewalld.service", "ip6tables.service", "iptables.service")
		     )   )

NamE: Potential Masquerading as Business App Installer
	description: 
		     Identifies executables with names resembling
		     legitimate business applications but lacking signatures from
		     the original developer. Attackers may trick users into
		     downloading malicious executables that masquerade as legitimate
		     applications via malicious ads, forum posts, and tutorials,
		     effectively gaining initial access.
	query: 
		     process where host.os.type == "windows" and
		     event.type == "start" and process.executable :
		     "?:\\Users\\*\\Downloads\\*" and   not
		     process.code_signature.status : ("errorCode_endpoint*",
		     "errorUntrustedRoot", "errorChaining") and   (     /* Slack */
		     (process.name : "*slack*.exe" and not
		     (process.code_signature.subject_name in (         "Slack
		     Technologies, Inc.",         "Slack Technologies, LLC"        )
		     and process.code_signature.trusted == true)     ) or      /*
		     WebEx */     (process.name : "*webex*.exe" and not
		     (process.code_signature.subject_name in ("Cisco WebEx LLC",
		     "Cisco Systems, Inc.") and process.code_signature.trusted ==
		     true)     ) or      /* Teams */     (process.name :
		     "teams*.exe" and not       (process.code_signature.subject_name
		     == "Microsoft Corporation" and process.code_signature.trusted
		     == true)     ) or      /* Discord */     (process.name :
		     "*discord*.exe" and not
		     (process.code_signature.subject_name == "Discord Inc." and
		     process.code_signature.trusted == true)     ) or      /*
		     WhatsApp */     (process.name : "*whatsapp*.exe" and not
		     (process.code_signature.subject_name in (         "WhatsApp
		     LLC",         "WhatsApp, Inc",
		     "24803D75-212C-471A-BC57-9EF86AB91435"        ) and
		     process.code_signature.trusted == true)     ) or      /* Zoom
		     */     (process.name : ("*zoom*installer*.exe",
		     "*zoom*setup*.exe", "zoom.exe")  and not
		     (process.code_signature.subject_name == "Zoom Video
		     Communications, Inc." and process.code_signature.trusted ==
		     true)     ) or      /* Outlook */     (process.name :
		     "*outlook*.exe" and not       (
		     (process.code_signature.subject_name == "Microsoft Corporation"
		     and process.code_signature.trusted == true) or         (
		     process.name: "MSOutlookHelp-PST-Viewer.exe" and
		     process.code_signature.subject_name == "Aryson Technologies
		     Pvt. Ltd" and           process.code_signature.trusted == true
		     )       )     ) or      /* Thunderbird */     (process.name :
		     "*thunderbird*.exe" and not
		     (process.code_signature.subject_name == "Mozilla Corporation"
		     and process.code_signature.trusted == true)     ) or      /*
		     Grammarly */     (process.name : "*grammarly*.exe" and not
		     (process.code_signature.subject_name == "Grammarly, Inc." and
		     process.code_signature.trusted == true)     ) or      /*
		     Dropbox */     (process.name : "*dropbox*.exe" and not
		     (process.code_signature.subject_name == "Dropbox, Inc" and
		     process.code_signature.trusted == true)     ) or      /*
		     Tableau */     (process.name : "*tableau*.exe" and not
		     (process.code_signature.subject_name == "Tableau Software LLC"
		     and process.code_signature.trusted == true)     ) or      /*
		     Google Drive */     (process.name : "*googledrive*.exe" and not
		     (process.code_signature.subject_name == "Google LLC" and
		     process.code_signature.trusted == true)     ) or      /*
		     MSOffice */     (process.name : "*office*setup*.exe" and not
		     (process.code_signature.subject_name == "Microsoft Corporation"
		     and process.code_signature.trusted == true)     ) or      /*
		     Okta */     (process.name : "*okta*.exe" and not
		     (process.code_signature.subject_name == "Okta, Inc." and
		     process.code_signature.trusted == true)     ) or      /*
		     OneDrive */     (process.name : "*onedrive*.exe" and not
		     (process.code_signature.subject_name == "Microsoft Corporation"
		     and process.code_signature.trusted == true)     ) or      /*
		     Chrome */     (process.name : "*chrome*.exe" and not
		     (process.code_signature.subject_name in ("Google LLC", "Google
		     Inc") and process.code_signature.trusted == true)     ) or
		     /* Firefox */     (process.name : "*firefox*.exe" and not
		     (process.code_signature.subject_name == "Mozilla Corporation"
		     and process.code_signature.trusted == true)     ) or      /*
		     Edge */     (process.name : ("*microsoftedge*.exe",
		     "*msedge*.exe") and not
		     (process.code_signature.subject_name == "Microsoft Corporation"
		     and process.code_signature.trusted == true)     ) or      /*
		     Brave */     (process.name : "*brave*.exe" and not
		     (process.code_signature.subject_name == "Brave Software, Inc."
		     and process.code_signature.trusted == true)     ) or      /*
		     GoogleCloud Related Tools */     (process.name :
		     "*GoogleCloud*.exe" and not
		     (process.code_signature.subject_name == "Google LLC" and
		     process.code_signature.trusted == true)     ) or      /* Github
		     Related Tools */     (process.name : "*github*.exe" and not
		     (process.code_signature.subject_name == "GitHub, Inc." and
		     process.code_signature.trusted == true)     ) or      /* Notion
		     */     (process.name : "*notion*.exe" and not
		     (process.code_signature.subject_name == "Notion Labs, Inc." and
		     process.code_signature.trusted == true)     )   )

NamE: Apple Scripting Execution with Administrator Privileges
	description: 
		     Identifies execution of the Apple script
		     interpreter (osascript) without a password prompt and with
		     administrator privileges.
	query: 
		     process where host.os.type == "macos" and event.type
		     in ("start", "process_started") and process.name : "osascript"
		     and   process.command_line : "osascript*with administrator
		     privileges" and   not process.parent.name : "Electron" and
		     not process.Ext.effective_parent.executable :
		     ("/Applications/Visual Studio
		     Code.app/Contents/MacOS/Electron",
		     "/Applications/OpenVPN Connect/Uninstall OpenVPN
		     Connect.app/Contents/MacOS/uninstaller")

NamE: Deprecated - Potential Container Escape via Modified release_agent File
	description: 
		     This rule detects modification of the CGroup
		     release_agent file from inside a privileged container. The
		     release_agent is a script that is executed at the termination
		     of any process on that CGroup and is invoked from the host. A
		     privileged container with SYS_ADMIN capabilities, enables a
		     threat actor to mount a CGroup directory and modify the
		     release_agent which could be used for further privilege
		     escalation and container escapes to the host machine.
	query: 
		     file where event.module == "cloud_defend" and
		     event.action == "open" and event.type == "change" and file.name
		     : "release_agent"

NamE: AWS EC2 Snapshot Activity
	description: 
		     An attempt was made to modify AWS EC2 snapshot
		     attributes. Snapshots are sometimes shared by threat actors in
		     order to exfiltrate bulk data from an EC2 fleet. If the
		     permissions were modified, verify the snapshot was not shared
		     with an unauthorized or unexpected AWS account.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:ec2.amazonaws.com and
		     event.action:ModifySnapshotAttribute

NamE: Azure Storage Account Key Regenerated
	description: 
		     Identifies a rotation to storage account access
		     keys in Azure. Regenerating access keys can affect any
		     applications or Azure services that are dependent on the
		     storage account key. Adversaries may regenerate a key as a
		     means of acquiring credentials to access systems and resources.
	query: 
		     event.dataset:azure.activitylogs and azure.activitylog
		     s.operation_name:"MICROSOFT.STORAGE/STORAGEACCOUNTS/REGENERATEK
		     EY/ACTION" and event.outcome:(Success or success)

NamE: GitHub App Deleted
	description: 
		     Detects the deletion of a GitHub app either from
		     a repo or an organization.
	query: 
		     configuration where event.dataset == "github.audit"
		     and github.category == "integration_installation" and
		     event.type == "deletion"

NamE: Linux System Information Discovery
	description: 
		     Enrich process events with uname and other
		     command lines that imply Linux system information discovery.
	query: 
		     process where event.type == "start" and event.action
		     in ("exec", "exec_event", "executed", "process_started") and (
		     process.name: "uname" or (   process.name: ("cat", "more",
		     "less") and process.args: ("*issue*", "*version*", "*profile*",
		     "*services*", "*cpuinfo*")   ) )

NamE: Enable Host Network Discovery via Netsh
	description: 
		     Identifies use of the netsh.exe program to
		     enable host discovery via the network. Attackers can use this
		     command-line tool to weaken the host firewall settings.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and process.name : "netsh.exe" and process.args :
		     ("firewall", "advfirewall") and process.args : "group=Network
		     Discovery" and process.args : "enable=Yes"

NamE: Execution of an Unsigned Service
	description: 
		     This rule identifies the execution of unsigned
		     executables via service control manager (SCM). Adversaries may
		     abuse SCM to execute malware or escalate privileges.
	query: 
		     host.os.type:windows and event.category:process and
		     event.type:start and
		     process.parent.executable:"C:\\Windows\\System32\\services.exe"
		     and  (process.code_signature.exists:false or
		     process.code_signature.trusted:false) and not
		     process.code_signature.status : (errorCode_endpoint* or
		     "errorChaining")

NamE: Remote SSH Login Enabled via systemsetup Command
	description: 
		     Detects use of the systemsetup command to enable
		     remote SSH Login.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:(start or process_started) and
		     process.name:systemsetup and  process.args:("-setremotelogin"
		     and on) and  not process.parent.executable :
		     /usr/local/jamf/bin/jamf

NamE: Okta FastPass Phishing Detection
	description: 
		     Detects when Okta FastPass prevents a user from
		     authenticating to a phishing website.
	query: 
		     event.dataset:okta.system and
		     event.category:authentication and
		     okta.event_type:user.authentication.auth_via_mfa and
		     event.outcome:failure and okta.outcome.reason:"FastPass
		     declined phishing attempt"

NamE: Suspicious .NET Reflection via PowerShell
	description: 
		     Detects the use of Reflection.Assembly to load
		     PEs and DLLs in memory in PowerShell scripts. Attackers use
		     this method to load executables and DLLs without writing to the
		     disk, bypassing security solutions.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (
		     "[System.Reflection.Assembly]::Load" or
		     "[Reflection.Assembly]::Load" or     "Assembly.Load(" or
		     "System.Reflection"   ) and   not
		     powershell.file.script_block_text : (
		     ("CommonWorkflowParameters" or "RelatedLinksHelpInfo") and
		     "HelpDisplayStrings"   ) and   not
		     (powershell.file.script_block_text :         ("Get-
		     SolutionFiles" or "Get-VisualStudio" or "Select-MSBuildPath")
		     and         file.name : "PathFunctions.ps1"   ) and   not
		     powershell.file.script_block_text : (
		     "Microsoft.PowerShell.Workflow.ServiceCore" and
		     "ExtractPluginProperties([string]$pluginDir"   ) and       not
		     powershell.file.script_block_text :
		     ("reflection.assembly]::Load('System." or
		     "LoadWithPartialName('Microsoft." or "::Load(\"Microsoft." or
		     "Microsoft.Build.Utilities.Core.dll") and       not user.id :
		     "S-1-5-18"

NamE: AWS Signin Single Factor Console Login with Federated User
	description: 
		     Identifies when a federated user logs into the
		     AWS Management Console without using multi-factor
		     authentication (MFA). Federated users are typically given
		     temporary credentials to access AWS services. If a federated
		     user logs into the AWS Management Console without using MFA, it
		     may indicate a security risk, as MFA adds an additional layer
		     of security to the authentication process. This could also
		     indicate the abuse of STS tokens to bypass MFA requirements.
	query: 
		     from logs-aws.cloudtrail-* metadata _id, _version,
		     _index | where     event.provider == "signin.amazonaws.com"
		     and event.action == "GetSigninToken"     and
		     aws.cloudtrail.event_type == "AwsConsoleSignIn"     and
		     aws.cloudtrail.user_identity.type == "FederatedUser" | dissect
		     aws.cloudtrail.additional_eventdata
		     "{%{?mobile_version_key}=%{mobile_version},
		     %{?mfa_used_key}=%{mfa_used}}" | where mfa_used == "No" | keep
		     @timestamp, event.action, aws.cloudtrail.event_type,
		     aws.cloudtrail.user_identity.type

NamE: Suspicious File Renamed via SMB
	description: 
		     Identifies an incoming SMB connection followed
		     by a suspicious file rename operation. This may indicate a
		     remote ransomware attack via the SMB protocol.
	query: 
		     sequence by host.id with maxspan=1s  [network where
		     host.os.type == "windows" and   event.action ==
		     "connection_accepted" and destination.port == 445 and
		     source.port >= 49152 and process.pid == 4 and   source.ip !=
		     "127.0.0.1" and source.ip != "::1" and   network.type == "ipv4"
		     and not endswith(source.address, destination.address)]  [file
		     where host.os.type == "windows" and   event.action == "rename"
		     and process.pid == 4 and user.id : ("S-1-5-21*", "S-1-12-*")
		     and   file.extension != null and file.Ext.entropy >= 6 and
		     file.path : "C:\\Users\\*" and   file.Ext.original.name :
		     ("*.jpg", "*.bmp", "*.png", "*.pdf", "*.doc", "*.docx",
		     "*.xls", "*.xlsx", "*.ppt", "*.pptx", "*.lnk") and   not
		     file.extension : ("jpg", "bmp", "png", "pdf", "doc", "docx",
		     "xls", "xlsx", "ppt", "pptx", "*.lnk")] with runs=3

NamE: Potential Privilege Escalation via PKEXEC
	description: 
		     Identifies an attempt to exploit a local
		     privilege escalation in polkit pkexec (CVE-2021-4034) via
		     unsecure environment variable injection. Successful
		     exploitation allows an unprivileged user to escalate to the
		     root user.
	query: 
		     file where host.os.type == "linux" and file.path :
		     "/*GCONV_PATH*"

NamE: New Okta Authentication Behavior Detected
	description: 
		     Detects events where Okta behavior detection has
		     identified a new authentication behavior.
	query: 
		     event.dataset:okta.system and
		     okta.debug_context.debug_data.risk_behaviors:*

NamE: Microsoft 365 Exchange Transport Rule Creation
	description: 
		     Identifies a transport rule creation in
		     Microsoft 365. As a best practice, Exchange Online mail
		     transport rules should not be set to forward email to domains
		     outside of your organization. An adversary may create transport
		     rules to exfiltrate data.
	query: 
		     event.dataset:o365.audit and event.provider:Exchange
		     and event.category:web and event.action:"New-TransportRule" and
		     event.outcome:success

NamE: PowerShell Suspicious Script with Audio Capture Capabilities
	description: 
		     Detects PowerShell scripts that can record
		     audio, a common feature in popular post-exploitation tooling.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (     "Get-MicrophoneAudio"
		     or     "WindowsAudioDevice-Powershell-Cmdlet" or
		     (waveInGetNumDevs and mciSendStringA)   )   and not
		     powershell.file.script_block_text : (     "sentinelbreakpoints"
		     and "Set-PSBreakpoint" and "PowerSploitIndicators"   )   and
		     not user.id : "S-1-5-18"

NamE: GCP Service Account Key Creation
	description: 
		     Identifies when a new key is created for a
		     service account in Google Cloud Platform (GCP). A service
		     account is a special type of account used by an application or
		     a virtual machine (VM) instance, not a person. Applications use
		     service accounts to make authorized API calls, authorized as
		     either the service account itself, or as G Suite or Cloud
		     Identity users through domain-wide delegation. If private keys
		     are not tracked and managed properly, they can present a
		     security risk. An adversary may create a new key for a service
		     account in order to attempt to abuse the permissions assigned
		     to that account and evade detection.
	query: 
		     event.dataset:gcp.audit and event.action:google.iam.ad
		     min.v*.CreateServiceAccountKey and event.outcome:success

NamE: SeDebugPrivilege Enabled by a Suspicious Process
	description: 
		     Identifies the creation of a process running as
		     SYSTEM and impersonating a Windows core binary privileges.
		     Adversaries may create a new process with a different token to
		     escalate privileges and bypass access controls.
	query: 
		     any where host.os.type == "windows" and
		     event.provider: "Microsoft-Windows-Security-Auditing" and
		     event.action : "Token Right Adjusted Events" and
		     winlog.event_data.EnabledPrivilegeList : "SeDebugPrivilege" and
		     /* exclude processes with System Integrity  */  not
		     winlog.event_data.SubjectUserSid : ("S-1-5-18", "S-1-5-19",
		     "S-1-5-20") and   not winlog.event_data.ProcessName :
		     ("?:\\Windows\\System32\\msiexec.exe",
		     "?:\\Windows\\SysWOW64\\msiexec.exe",
		     "?:\\Windows\\System32\\lsass.exe",
		     "?:\\Windows\\WinSxS\\*",           "?:\\Program Files\\*",
		     "?:\\Program Files (x86)\\*",
		     "?:\\Windows\\System32\\MRT.exe",
		     "?:\\Windows\\System32\\cleanmgr.exe",
		     "?:\\Windows\\System32\\taskhostw.exe",
		     "?:\\Windows\\System32\\mmc.exe",
		     "?:\\Users\\*\\AppData\\Local\\Temp\\*-*\\DismHost.exe",
		     "?:\\Windows\\System32\\auditpol.exe",
		     "?:\\Windows\\System32\\wbem\\WmiPrvSe.exe",
		     "?:\\Windows\\SysWOW64\\wbem\\WmiPrvSe.exe")

NamE: Attempted Bypass of Okta MFA
	description: 
		     Detects attempts to bypass Okta multi-factor
		     authentication (MFA). An adversary may attempt to bypass the
		     Okta MFA policies configured for an organization in order to
		     obtain unauthorized access to an application.
	query: 
		     event.dataset:okta.system and
		     event.action:user.mfa.attempt_bypass

NamE: Process Spawned from Message-of-the-Day (MOTD)
	description: 
		     Message of the day (MOTD) is the message that is
		     presented to the user when a user connects to a Linux server
		     via SSH or a serial connection. Linux systems contain several
		     default MOTD files located in the "/etc/update-motd.d/"
		     directory. These scripts run as the root user every time a user
		     connects over SSH or a serial connection. Adversaries may
		     create malicious MOTD files that grant them persistence onto
		     the target every time a user connects to the system by
		     executing a backdoor script or command. This rule detects the
		     execution of potentially malicious processes through the MOTD
		     utility.
	query: 
		     process where event.type == "start" and host.os.type
		     == "linux" and event.action : ("exec", "exec_event", "start")
		     and   process.parent.executable : "/etc/update-motd.d/*" and
		     (     (       process.name in ("bash", "dash", "sh", "tcsh",
		     "csh", "zsh", "ksh", "fish") and       (         process.args :
		     ("-i", "-l") or         (process.parent.name == "socat" and
		     process.parent.args : "*exec*")       )     ) or     (
		     process.name : ("nc", "ncat", "netcat", "nc.openbsd") and
		     process.args_count >= 3 and        not process.args : ("-*z*",
		     "-*l*")     ) or     (       process.name : "python*" and
		     process.args : "-c" and process.args : (
		     "*import*pty*spawn*", "*import*subprocess*call*"       )     )
		     or     (       process.name : "perl*" and process.args : "-e"
		     and process.args : "*socket*" and process.args : (
		     "*exec*", "*system*"       )     ) or     (       process.name
		     : "ruby*" and process.args : ("-e", "-rsocket") and
		     process.args : (         "*TCPSocket.new*", "*TCPSocket.open*"
		     )     ) or     (       process.name : "lua*" and process.args :
		     "-e" and process.args : "*socket.tcp*" and process.args : (
		     "*io.popen*", "*os.execute*"       )     ) or     (process.name
		     : "php*" and process.args : "-r" and process.args :
		     "*fsockopen*" and process.args : "*/bin/*sh*") or
		     (process.name : ("awk", "gawk", "mawk", "nawk") and
		     process.args : "*/inet/tcp/*") or      (process.name in
		     ("openssl", "telnet")) or     (       process.args : (
		     "./*", "/boot/*", "/dev/shm/*", "/etc/cron.*/*",
		     "/etc/init.d/*", "/etc/update-motd.d/*", "/run/*", "/srv/*",
		     "/tmp/*", "/var/tmp/*", "/var/log/*", "/opt/*"       ) and
		     process.args_count == 1     )   ) and    not (
		     process.parent.args == "--force" or     process.args in
		     ("/usr/games/lolcat", "/usr/bin/screenfetch") or
		     process.parent.name == "system-crash-notification"   )

NamE: Suspicious JetBrains TeamCity Child Process
	description: 
		     Identifies suspicious processes being spawned by
		     the JetBrain TeamCity process. This activity could be related
		     to JetBrains remote code execution vulnerabilities.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.executable :
		     ("?:\\TeamCity\\jre\\bin\\java.exe",
		     "?:\\Program Files\\TeamCity\\jre\\bin\\java.exe",
		     "?:\\Program Files (x86)\\TeamCity\\jre\\bin\\java.exe",
		     "?:\\TeamCity\\BuildAgent\\jre\\bin\\java.exe") and
		     process.name : ("cmd.exe", "powershell.exe", "msiexec.exe",
		     "certutil.exe", "bitsadmin.exe", "wmic.exe", "curl.exe",
		     "ssh.exe",                    "rundll32.exe", "regsvr32.exe",
		     "mshta.exe", "certreq.exe", "net.exe", "nltest.exe",
		     "whoami.exe", "hostname.exe",
		     "tasklist.exe", "arp.exe", "nbtstat.exe", "netstat.exe",
		     "reg.exe", "tasklist.exe", "Microsoft.Workflow.Compiler.exe",
		     "arp.exe", "atbroker.exe", "bginfo.exe", "bitsadmin.exe",
		     "cdb.exe", "cmstp.exe", "control.exe", "cscript.exe",
		     "csi.exe",                    "dnx.exe", "dsget.exe",
		     "dsquery.exe", "forfiles.exe", "fsi.exe", "ftp.exe",
		     "gpresult.exe", "ieexec.exe", "iexpress.exe",
		     "installutil.exe", "ipconfig.exe","msxsl.exe", "netsh.exe",
		     "odbcconf.exe", "ping.exe", "pwsh.exe", "qprocess.exe",
		     "quser.exe", "qwinsta.exe", "rcsi.exe", "regasm.exe",
		     "regsvcs.exe", "regsvr32.exe", "sc.exe", "schtasks.exe",
		     "systeminfo.exe", "tracert.exe", "wmic.exe",
		     "wscript.exe","xwizard.exe", "explorer.exe", "msdt.exe") and
		     not (process.name : "powershell.exe" and process.args :
		     "-ExecutionPolicy" and process.args :
		     "?:\\TeamCity\\buildAgent\\work\\*.ps1") and  not (process.name
		     : "cmd.exe" and process.args : "dir" and process.args : "/-c")

NamE: Suspicious Dynamic Linker Discovery via od
	description: 
		     Monitors for dynamic linker discovery via the od
		     utility. od (octal dump) is a command-line utility in Unix
		     operating systems used for displaying data in various formats,
		     including octal, hexadecimal, decimal, and ASCII, primarily
		     used for examining and debugging binary files or data streams.
		     Attackers can leverage od to analyze the dynamic linker by
		     identifying injection points and craft exploits based on the
		     observed behaviors and structures within these files.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed", "process_started")  and
		     process.name == "od" and process.args in (
		     "/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2",
		     "/etc/ld.so.preload", "/lib64/ld-linux-x86-64.so.2",
		     "/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2",
		     "/usr/lib64/ld-linux-x86-64.so.2" )

NamE: EggShell Backdoor Execution
	description: 
		     Identifies the execution of and EggShell
		     Backdoor. EggShell is a known post exploitation tool for macOS
		     and Linux.
	query: 
		     event.category:process and event.type:(process_started
		     or start) and process.name:espl and process.args:eyJkZWJ1ZyI6*

NamE: Chkconfig Service Add
	description: 
		     Detects the use of the chkconfig binary to
		     manually add a service for management by chkconfig. Threat
		     actors may utilize this technique to maintain persistence on a
		     system. When a new service is added, chkconfig ensures that the
		     service has either a start or a kill entry in every runlevel
		     and when the system is rebooted the service file added will run
		     providing long-term persistence.
	query: 
		     process where host.os.type == "linux" and event.action
		     in ("exec", "exec_event", "start") and (    (process.executable
		     : "/usr/sbin/chkconfig" and process.args : "--add") or
		     (process.args : "*chkconfig" and process.args : "--add") ) and
		     not (   process.parent.name in ("rpm", "qualys-scan-util",
		     "qualys-cloud-agent", "update-alternatives") or
		     process.parent.args : ("/var/tmp/rpm*", "/var/lib/waagent/*")
		     or   process.args in ("jexec", "sapinit", "httpd", "dbora") )

NamE: Attempt to Mount SMB Share via Command Line
	description: 
		     Identifies the execution of macOS built-in
		     commands to mount a Server Message Block (SMB) network share.
		     Adversaries may use valid accounts to interact with a remote
		     network share using SMB.
	query: 
		     process where host.os.type == "macos" and event.type
		     in ("start", "process_started") and   (     process.name :
		     "mount_smbfs" or     (process.name : "open" and process.args :
		     "smb://*") or     (process.name : "mount" and process.args :
		     "smbfs") or     (process.name : "osascript" and
		     process.command_line : "osascript*mount volume*smb://*")   )
		     and   not process.parent.executable : "/Applications/Google
		     Drive.app/Contents/MacOS/Google Drive"

NamE: Potential Malware-Driven SSH Brute Force Attempt
	description: 
		     This detection identifies a Linux host that has
		     potentially been infected with malware and is being used to
		     conduct brute-force attacks against external systems over SSH
		     (port 22 and common alternative SSH ports). The detection looks
		     for a high volume of outbound connection attempts to non-
		     private IP addresses from a single process. A compromised host
		     may be part of a botnet or controlled by an attacker,
		     attempting to gain unauthorized access to remote systems. This
		     behavior is commonly observed in SSH brute-force campaigns
		     where malware hijacks vulnerable machines to expand its attack
		     surface. ES|QL rules have limited fields available in its alert
		     documents. Make sure to review the original documents to aid in
		     the investigation of this alert.
	query: 
		     from logs-endpoint.events.network-* | keep @timestamp,
		     host.os.type, event.type, event.action, destination.port,
		     process.executable, destination.ip, agent.id | where @timestamp
		     > now() - 1 hours | where host.os.type == "linux" and
		     event.type == "start" and event.action ==
		     "connection_attempted" and   destination.port in (22, 222,
		     2222, 10022, 2022, 2200, 62612, 8022) and not      CIDR_MATCH(
		     destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16",
		     "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29",
		     "192.0.0.8/32", "192.0.0.9/32",        "192.0.0.10/32",
		     "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24",
		     "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16",
		     "192.88.99.0/24",        "224.0.0.0/4", "100.64.0.0/10",
		     "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24",
		     "203.0.113.0/24", "224.0.0.0/4", "240.0.0.0/4", "::1",
		     "FE80::/10", "FF00::/8"      ) | stats cc = count(),
		     agent_count = count_distinct(agent.id) by process.executable,
		     destination.port | where agent_count == 1 and cc > 15 | sort cc
		     asc | limit 100

NamE: Deprecated - Mount Launched Inside a Privileged Container
	description: 
		     This rule detects the use of the mount utility
		     from inside a privileged container. The mount command is used
		     to make a device or file system accessible to the system, and
		     then to connect its root directory to a specified mount point
		     on the local file system. When launched inside a privileged
		     container--a container deployed with all the capabilities of
		     the host machine-- an attacker can access sensitive host level
		     files which could be used for further privilege escalation and
		     container escapes to the host machine. Any usage of mount
		     inside a running privileged container should be further
		     investigated.
	query: 
		     process where event.module == "cloud_defend" and
		     event.type== "start" and (process.name== "mount" or
		     process.args== "mount") and
		     container.security_context.privileged == true

NamE: SNS Topic Message Publish by Rare User
	description: 
		     Identifies when an SNS topic message is
		     published by a rare user in AWS. Adversaries may publish
		     messages to SNS topics for phishing campaigns, data
		     exfiltration, or lateral movement within the AWS environment.
		     SNS topics are used to send notifications and messages to
		     subscribed endpoints such as applications, devices or email
		     addresses, making them a valuable target for adversaries to
		     distribute malicious content or exfiltrate sensitive data. This
		     is a [New
		     Terms](https://www.elastic.co/guide/en/security/current/rules-
		     ui-create.html#create-new-terms-rule) rule that only flags when
		     this behavior is observed for the first time on a user in the
		     last 14 days.
	query: 
		     event.dataset:"aws.cloudtrail"     and
		     event.provider:"sns.amazonaws.com"     and
		     event.action:"Publish"     and event.outcome:"success"

NamE: Adobe Hijack Persistence
	description: 
		     Detects writing executable files that will be
		     automatically launched by Adobe on launch.
	query: 
		     file where host.os.type == "windows" and event.type ==
		     "creation" and   file.path : ("?:\\Program Files
		     (x86)\\Adobe\\Acrobat Reader DC\\Reader\\AcroCEF\\RdrCEF.exe",
		     "?:\\Program Files\\Adobe\\Acrobat Reader
		     DC\\Reader\\AcroCEF\\RdrCEF.exe") and   not process.name :
		     "msiexec.exe"

NamE: Disabling Windows Defender Security Settings via PowerShell
	description: 
		     Identifies use of the Set-MpPreference
		     PowerShell command to disable or weaken certain Windows
		     Defender settings.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (     process.name : ("powershell.exe",
		     "pwsh.exe", "powershell_ise.exe") or
		     ?process.pe.original_file_name in ("powershell.exe",
		     "pwsh.dll", "powershell_ise.exe")   ) and   process.args :
		     "Set-MpPreference" and process.args : ("-Disable*", "Disabled",
		     "NeverSend", "-Exclusion*")

NamE: InstallUtil Process Making Network Connections
	description: 
		     Identifies InstallUtil.exe making outbound
		     network connections. This may indicate adversarial activity as
		     InstallUtil is often leveraged by adversaries to execute code
		     and evade detection.
	query: 
		     /* the benefit of doing this as an eql sequence vs kql
		     is this will limit to alerting only on the first network
		     connection */  sequence by process.entity_id   [process where
		     host.os.type == "windows" and event.type == "start" and
		     process.name : "installutil.exe"]   [network where host.os.type
		     == "windows" and process.name : "installutil.exe" and
		     network.direction : ("outgoing", "egress")]

NamE: NetworkManager Dispatcher Script Creation
	description: 
		     This rule detects the creation of a
		     NetworkManager dispatcher script on a Linux system.
		     NetworkManager dispatcher scripts are shell scripts that
		     NetworkManager executes when network interfaces change state.
		     Attackers can abuse NetworkManager dispatcher scripts to
		     maintain persistence on a system by executing malicious code
		     whenever a network event occurs.
	query: 
		     file where host.os.type == "linux" and event.type ==
		     "creation" and file.path like~
		     "/etc/NetworkManager/dispatcher.d/*" and not (
		     process.executable in (     "/bin/dpkg", "/usr/bin/dpkg",
		     "/bin/dockerd", "/usr/bin/dockerd", "/usr/sbin/dockerd",
		     "/bin/microdnf",     "/usr/bin/microdnf", "/bin/rpm",
		     "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd", "/bin/yum",
		     "/usr/bin/yum",     "/bin/dnf", "/usr/bin/dnf", "/bin/podman",
		     "/usr/bin/podman", "/bin/dnf-automatic", "/usr/bin/dnf-
		     automatic",     "/bin/pacman", "/usr/bin/pacman",
		     "/usr/bin/dpkg-divert", "/bin/dpkg-divert", "/sbin/apk",
		     "/usr/sbin/apk",     "/usr/local/sbin/apk", "/usr/bin/apt",
		     "/usr/sbin/pacman", "/bin/podman", "/usr/bin/podman",
		     "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/lib/snapd/snapd", "/usr/local/bin/dockerd",
		     "/usr/bin/crio", "/usr/sbin/crond",
		     "/opt/puppetlabs/puppet/bin/ruby", "/usr/libexec/platform-
		     python", "/kaniko/kaniko-executor",
		     "/usr/local/bin/dockerd", "/usr/bin/podman", "/bin/install",
		     "/proc/self/exe", "/usr/lib/systemd/systemd",
		     "/usr/sbin/sshd", "/usr/bin/gitlab-runner",
		     "/opt/gitlab/embedded/bin/ruby", "/usr/sbin/gdm",
		     "/usr/bin/install",
		     "/usr/local/manageengine/uems_agent/bin/dcregister",
		     "/usr/local/bin/pacman"   ) or   process.executable like~ (
		     "/nix/store/*", "/var/lib/dpkg/*", "/tmp/vmis.*", "/snap/*",
		     "/dev/fd/*", "/usr/lib/virtualbox/*"   ) or   file.extension in
		     ("swp", "swpx", "swx", "dpkg-remove") or   (process.name ==
		     "sed" and file.name : "sed*") )

NamE: Encrypting Files with WinRar or 7z
	description: 
		     Identifies use of WinRar or 7z to create an
		     encrypted files. Adversaries will often compress and encrypt
		     data in preparation for exfiltration.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and (   (     (       process.name:"rar.exe" or
		     ?process.code_signature.subject_name == "win.rar GmbH" or
		     ?process.pe.original_file_name == "Command line RAR"     ) and
		     process.args == "a" and process.args : ("-hp*", "-p*", "/hp*",
		     "/p*")   ) or   (     (process.name : ("7z.exe", "7za.exe") or
		     ?process.pe.original_file_name in ("7z.exe", "7za.exe")) and
		     process.args == "a" and process.args : "-p*"   ) ) and   not
		     process.parent.executable : (         "C:\\Program
		     Files\\*.exe",         "C:\\Program Files (x86)\\*.exe",
		     "?:\\ManageEngine\\*\\jre\\bin\\java.exe",
		     "?:\\Nox\\bin\\Nox.exe",
		     "\\Device\\HarddiskVolume?\\Program Files\\*.exe",
		     "\\Device\\HarddiskVolume?\\Program Files (x86)\\*.exe",
		     "\\Device\\HarddiskVolume?\\ManageEngine\\*\\jre\\bin\\java.exe
		     ",         "\\Device\\HarddiskVolume?\\Nox\\bin\\Nox.exe"
		     )

NamE: Registry Persistence via AppInit DLL
	description: 
		     AppInit DLLs are dynamic-link libraries (DLLs)
		     that are loaded into every process that creates a user
		     interface (loads user32.dll) on Microsoft Windows operating
		     systems. The AppInit DLL mechanism is used to load custom code
		     into user-mode processes, allowing for the customization of the
		     user interface and the behavior of Windows-based applications.
		     Attackers who add those DLLs to the registry locations can
		     execute code with elevated privileges, similar to process
		     injection, and provide a solid and constant persistence on the
		     machine.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.path : (
		     "HKLM\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Windows\\AppInit_Dlls",
		     "HKLM\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows
		     NT\\CurrentVersion\\Windows\\AppInit_Dlls",
		     "\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Windows\\AppInit_Dlls",
		     "\\REGISTRY\\MACHINE\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows
		     NT\\CurrentVersion\\Windows\\AppInit_Dlls",
		     "MACHINE\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Windows\\AppInit_Dlls",
		     "MACHINE\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows
		     NT\\CurrentVersion\\Windows\\AppInit_Dlls"   ) and   not
		     process.executable : (      "?:\\Windows\\System32\\DriverStore
		     \\FileRepository\\*\\Display.NvContainer\\NVDisplay.Container.e
		     xe",      "?:\\Windows\\System32\\msiexec.exe",
		     "?:\\Windows\\SysWOW64\\msiexec.exe",      "?:\\Program
		     Files\\Commvault\\Base\\cvd.exe",      "?:\\Program
		     Files\\Commvault\\ContentStore*\\Base\\cvd.exe",
		     "?:\\Program Files (x86)\\Commvault\\Base\\cvd.exe",
		     "?:\\Program Files
		     (x86)\\Commvault\\ContentStore*\\Base\\cvd.exe",
		     "?:\\Program Files\\NVIDIA
		     Corporation\\Display.NvContainer\\NVDisplay.Container.exe"   )

NamE: Security File Access via Common Utilities
	description: 
		     This rule detects sensitive security file access
		     via common utilities on Linux systems. Adversaries may attempt
		     to read from sensitive files using common utilities to gather
		     information about the system and its security configuration.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2") and   process.name in ("cat",
		     "grep", "less", "more", "strings", "awk", "find", "xargs") and
		     process.args like (     "/etc/security/*", "/etc/pam.d/*",
		     "/etc/login.defs", "/lib/security/*", "/lib64/security/*",
		     "/usr/lib/security/*", "/usr/lib64/security/*",
		     "/usr/lib/x86_64-linux-gnu/security/*",
		     "/home/*/.aws/credentials", "/home/*/.aws/config",
		     "/home/*/.config/gcloud/*credentials.json",
		     "/home/*/.config/gcloud/configurations/config_default",
		     "/home/*/.azure/accessTokens.json",
		     "/home/*/.azure/azureProfile.json"   ) and  not
		     process.parent.name in ("wazuh-modulesd", "lynis")

NamE: Attempt to Establish VScode Remote Tunnel
	description: 
		     Detects the execution of the VScode portable
		     binary with the tunnel command line option indicating an
		     attempt to establish a remote tunnel session to Github or a
		     remote VScode instance.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.args : "tunnel" and (process.args : "
		     --accept-server-license-terms" or process.name : "code*.exe")
		     and   not (process.name == "code-tunnel.exe" and process.args
		     == "status" and process.parent.name == "Code.exe")

NamE: Unusual AWS S3 Object Encryption with SSE-C
	description: 
		     Identifies when AWS S3 objects stored in a
		     bucket are encrypted using Server-Side Encryption with
		     Customer-Provided Keys (SSE-C). Adversaries with compromised
		     AWS credentials can encrypt objects in an S3 bucket using their
		     own encryption keys, rendering the objects unreadable or
		     recoverable without the key. This can be used as a form of
		     ransomware to extort the bucket owner for the decryption key.
		     This is a [New
		     Terms](https://www.elastic.co/guide/en/security/current/rules-
		     ui-create.html#create-new-terms-rule) rule that flags when this
		     behavior is observed for the first time in the last 14 days by
		     the user ARN and target bucket name.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "s3.amazonaws.com"     and event.action:
		     "PutObject"     and event.outcome: "success"     and
		     aws.cloudtrail.flattened.request_parameters.x-amz-server-side-
		     encryption-customer-algorithm: "AES256"     and
		     aws.cloudtrail.flattened.additional_eventdata.SSEApplied:
		     "SSE_C"

NamE: GCP IAM Service Account Key Deletion
	description: 
		     Identifies the deletion of an Identity and
		     Access Management (IAM) service account key in Google Cloud
		     Platform (GCP). Each service account is associated with two
		     sets of public/private RSA key pairs that are used to
		     authenticate. If a key is deleted, the application will no
		     longer be able to access Google Cloud resources using that key.
		     A security best practice is to rotate your service account keys
		     regularly.
	query: 
		     event.dataset:gcp.audit and event.action:google.iam.ad
		     min.v*.DeleteServiceAccountKey and event.outcome:success

NamE: Potential DLL Side-Loading via Microsoft Antimalware Service Executable
	description: 
		     Identifies a Windows trusted program that is
		     known to be vulnerable to DLL Search Order Hijacking starting
		     after being renamed or from a non-standard path. This is
		     uncommon behavior and may indicate an attempt to evade defenses
		     via side-loading a malicious DLL within the memory space of one
		     of those processes.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and (   (process.pe.original_file_name ==
		     "MsMpEng.exe" and not process.name : "MsMpEng.exe") or
		     (process.name : "MsMpEng.exe" and not
		     process.executable : ("?:\\ProgramData\\Microsoft\\Windows
		     Defender\\*.exe",                               "?:\\Program
		     Files\\Windows Defender\\*.exe",
		     "?:\\Program Files (x86)\\Windows Defender\\*.exe",
		     "?:\\Program Files\\Microsoft Security Client\\*.exe",
		     "?:\\Program Files (x86)\\Microsoft Security Client\\*.exe")) )

NamE: Volume Shadow Copy Deletion via PowerShell
	description: 
		     Identifies the use of the Win32_ShadowCopy class
		     and related cmdlets to achieve shadow copy deletion. This
		     commonly occurs in tandem with ransomware or other destructive
		     attacks.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : ("powershell.exe", "pwsh.exe",
		     "powershell_ise.exe") and   process.args : ("*Get-WmiObject*",
		     "*gwmi*", "*Get-CimInstance*", "*gcim*") and   process.args :
		     ("*Win32_ShadowCopy*") and   process.args : ("*.Delete()*",
		     "*Remove-WmiObject*", "*rwmi*", "*Remove-CimInstance*",
		     "*rcim*")

NamE: Potential Linux Hack Tool Launched
	description: 
		     Monitors for the execution of different
		     processes that might be used by attackers for malicious intent.
		     An alert from this rule should be investigated further, as hack
		     tools are commonly used by blue teamers and system
		     administrators as well.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed", "process_started") and
		     process.name in~ (   // exploitation frameworks
		     "crackmapexec", "msfconsole", "msfvenom", "sliver-client",
		     "sliver-server", "havoc",   // network scanners (nmap left out
		     to reduce noise)   "zenmap", "nuclei", "netdiscover", "legion",
		     // web enumeration   "gobuster", "dirbuster", "dirb", "wfuzz",
		     "ffuf", "whatweb", "eyewitness",   // web vulnerability
		     scanning   "wpscan", "joomscan", "droopescan", "nikto",   //
		     exploitation tools   "sqlmap", "commix", "yersinia",   //
		     cracking and brute forcing   "john", "hashcat", "hydra",
		     "ncrack", "cewl", "fcrackzip", "rainbowcrack",   // host and
		     network   "linenum.sh", "linpeas.sh", "pspy32", "pspy32s",
		     "pspy64", "pspy64s", "binwalk", "evil-winrm",   "linux-exploit-
		     suggester-2.pl", "linux-exploit-suggester.sh", "panix.sh" )

NamE: Azure Alert Suppression Rule Created or Modified
	description: 
		     Identifies the creation of suppression rules in
		     Azure. Suppression rules are a mechanism used to suppress
		     alerts previously identified as false positives or too noisy to
		     be in production. This mechanism can be abused or mistakenly
		     configured, resulting in defense evasions and loss of security
		     visibility.
	query: 
		     event.dataset:azure.activitylogs and azure.activitylog
		     s.operation_name:"MICROSOFT.SECURITY/ALERTSSUPPRESSIONRULES/WRI
		     TE" and event.outcome: "success"

NamE: Microsoft 365 Exchange DKIM Signing Configuration Disabled
	description: 
		     Identifies when a DomainKeys Identified Mail
		     (DKIM) signing configuration is disabled in Microsoft 365. With
		     DKIM in Microsoft 365, messages that are sent from Exchange
		     Online will be cryptographically signed. This will allow the
		     receiving email system to validate that the messages were
		     generated by a server that the organization authorized and were
		     not spoofed.
	query: 
		     event.dataset:o365.audit and event.provider:Exchange
		     and event.category:web and event.action:"Set-DkimSigningConfig"
		     and o365.audit.Parameters.Enabled:False and
		     event.outcome:success

NamE: Potential Pass-the-Hash (PtH) Attempt
	description: 
		     Adversaries may pass the hash using stolen
		     password hashes to move laterally within an environment,
		     bypassing normal system access controls. Pass the hash (PtH) is
		     a method of authenticating as a user without having access to
		     the user's cleartext password.
	query: 
		     host.os.type:"windows" and event.category :
		     "authentication" and event.action : "logged-in" and
		     winlog.logon.type : "NewCredentials" and event.outcome :
		     "success" and user.id : (S-1-5-21-* or S-1-12-1-*) and
		     winlog.event_data.LogonProcessName : "seclogo"

NamE: Suspicious LSASS Access via MalSecLogon
	description: 
		     Identifies suspicious access to LSASS handle
		     from a call trace pointing to seclogon.dll and with a
		     suspicious access rights value. This may indicate an attempt to
		     leak an LSASS handle via abusing the Secondary Logon service in
		     preparation for credential access.
	query: 
		     process where host.os.type == "windows" and event.code
		     == "10" and   winlog.event_data.TargetImage :
		     "?:\\WINDOWS\\system32\\lsass.exe" and     /* seclogon service
		     accessing lsass */   winlog.event_data.CallTrace :
		     "*seclogon.dll*" and process.name : "svchost.exe" and     /*
		     PROCESS_CREATE_PROCESS & PROCESS_DUP_HANDLE &
		     PROCESS_QUERY_INFORMATION */   winlog.event_data.GrantedAccess
		     == "0x14c0"

NamE: PowerShell Kerberos Ticket Request
	description: 
		     Detects PowerShell scripts that have the
		     capability of requesting kerberos tickets, which is a common
		     step in Kerberoasting toolkits to crack service accounts.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (
		     KerberosRequestorSecurityToken   ) and not user.id :
		     ("S-1-5-18" or "S-1-5-20") and   not
		     powershell.file.script_block_text : (
		     ("sentinelbreakpoints" and ("Set-PSBreakpoint" or "Set-
		     HookFunctionTabs")) or     ("function global" and
		     "\\windows\\sentinel\\4")   )

NamE: AWS EC2 Multi-Region DescribeInstances API Calls
	description: 
		     Identifies when a single AWS resource is making
		     `DescribeInstances` API calls in more than 10 regions within a
		     30-second window. This could indicate a potential threat actor
		     attempting to discover the AWS infrastructure across multiple
		     regions using compromised credentials or a compromised
		     instance. Adversaries may use this information to identify
		     potential targets for further exploitation or to gain a better
		     understanding of the target's infrastructure.
	query: 
		     from logs-aws.cloudtrail-*  // filter for
		     DescribeInstances API calls | where event.dataset ==
		     "aws.cloudtrail" and event.provider == "ec2.amazonaws.com" and
		     event.action == "DescribeInstances"  // truncate the timestamp
		     to a 30-second window | eval target_time_window = DATE_TRUNC(30
		     seconds, @timestamp)  // keep only the relevant fields | keep
		     target_time_window, aws.cloudtrail.user_identity.arn,
		     cloud.region  // count the number of unique regions and total
		     API calls within the 30-second window | stats region_count =
		     count_distinct(cloud.region), window_count = count(*) by
		     target_time_window, aws.cloudtrail.user_identity.arn  // filter
		     for resources making DescribeInstances API calls in more than
		     10 regions within the 30-second window | where region_count >=
		     10 and window_count >= 10  // sort the results by time windows
		     in descending order | sort target_time_window desc

NamE: Entra ID Device Code Auth with Broker Client
	description: 
		     Identifies device code authentication with an
		     Azure broker client for Entra ID. Adversaries abuse Primary
		     Refresh Tokens (PRTs) to bypass multi-factor authentication
		     (MFA) and gain unauthorized access to Azure resources. PRTs are
		     used in Conditional Access policies to enforce device-based
		     controls. Compromising PRTs allows attackers to bypass these
		     policies and gain unauthorized access. This rule detects
		     successful sign-ins using device code authentication with the
		     Entra ID broker client application ID
		     (29d9ed98-a469-4536-ade2-f981bc1d605e).
	query: 
		      event.dataset:(azure.activitylogs or
		     azure.signinlogs)     and
		     azure.signinlogs.properties.authentication_protocol:deviceCode
		     and azure.signinlogs.properties.conditional_access_audiences.ap
		     plication_id:29d9ed98-a469-4536-ade2-f981bc1d605e     and
		     event.outcome:success or (         azure.activitylogs.propertie
		     s.appId:29d9ed98-a469-4536-ade2-f981bc1d605e         and azure.
		     activitylogs.properties.authentication_protocol:deviceCode)

NamE: AWS SNS Topic Created by Rare User
	description: 
		     Identifies when an SNS topic is created by a
		     user who does not typically perform this action. Adversaries
		     may create SNS topics to stage capabilities for data
		     exfiltration or other malicious activities.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "sns.amazonaws.com"     and event.action:
		     "CreateTopic"     and event.outcome: "success"     and
		     aws.cloudtrail.user_identity.type: "AssumedRole"     and
		     aws.cloudtrail.user_identity.arn: *i-*

NamE: Potential Chroot Container Escape via Mount
	description: 
		     Monitors for the execution of a file system
		     mount followed by a chroot execution. Given enough permissions,
		     a user within a container is capable of mounting the root file
		     system of the host, and leveraging chroot to escape its
		     containarized environment. This behavior pattern is very
		     uncommon and should be investigated.
	query: 
		     sequence by host.id, process.parent.entity_id with
		     maxspan=5m   [process where host.os.type == "linux" and
		     event.type == "start" and event.action in ("exec", "start") and
		     process.name == "mount" and process.args : "/dev/sd*" and
		     process.args_count >= 3 and    process.parent.name in ("bash",
		     "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish")]   [process
		     where host.os.type == "linux" and event.type == "start" and
		     event.action in ("exec", "start") and    process.name ==
		     "chroot"]

NamE: Kernel Unpacking Activity
	description: 
		     This rule detects kernel unpacking activity
		     through several built-in Linux utilities. Attackers may use
		     these utilities to unpack kernel images and modules to search
		     for vulnerabilities or to modify the kernel.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action == "exec" and (process.parent.args
		     like "/boot/*" or process.args like "/boot/*") and (
		     (process.name in ("file", "unlzma", "gunzip", "unxz",
		     "bunzip2", "unzstd", "unzip", "tar")) or   (process.name ==
		     "grep" and process.args == "ELF") or   (process.name in
		     ("lzop", "lz4") and process.args in ("-d", "--decode")) ) and
		     not process.parent.name == "mkinitramfs"

NamE: Unsigned DLL Loaded by Svchost
	description: 
		     Identifies an unsigned library created in the
		     last 5 minutes and subsequently loaded by a shared windows
		     service (svchost). Adversaries may use this technique to
		     maintain persistence or run with System privileges.
	query: 
		     library where host.os.type == "windows" and
		     process.executable :
		     ("?:\\Windows\\System32\\svchost.exe",
		     "?:\\Windows\\Syswow64\\svchost.exe") and
		     dll.code_signature.trusted != true and   not
		     dll.code_signature.status : ("trusted", "errorExpired",
		     "errorCode_endpoint*") and   dll.hash.sha256 != null and   (
		     /* DLL created within 5 minutes of the library load event -
		     compatible with Elastic Endpoint 8.4+ */
		     dll.Ext.relative_file_creation_time <= 300 or         /*
		     unusual paths */        dll.path :("?:\\ProgramData\\*",
		     "?:\\Users\\*",                   "?:\\PerfLogs\\*",
		     "?:\\Windows\\Tasks\\*",                   "?:\\Intel\\*",
		     "?:\\AMD\\Temp\\*",
		     "?:\\Windows\\AppReadiness\\*",
		     "?:\\Windows\\ServiceState\\*",
		     "?:\\Windows\\security\\*",
		     "?:\\Windows\\IdentityCRL\\*",
		     "?:\\Windows\\Branding\\*",
		     "?:\\Windows\\csc\\*",
		     "?:\\Windows\\DigitalLocker\\*",
		     "?:\\Windows\\en-US\\*",
		     "?:\\Windows\\wlansvc\\*",
		     "?:\\Windows\\Prefetch\\*",
		     "?:\\Windows\\Fonts\\*",
		     "?:\\Windows\\diagnostics\\*",
		     "?:\\Windows\\TAPI\\*",
		     "?:\\Windows\\INF\\*",
		     "?:\\Windows\\System32\\Speech\\*",
		     "?:\\windows\\tracing\\*",
		     "?:\\windows\\IME\\*",
		     "?:\\Windows\\Performance\\*",
		     "?:\\windows\\intel\\*",
		     "?:\\windows\\ms\\*",
		     "?:\\Windows\\dot3svc\\*",
		     "?:\\Windows\\panther\\*",
		     "?:\\Windows\\RemotePackages\\*",
		     "?:\\Windows\\OCR\\*",
		     "?:\\Windows\\appcompat\\*",
		     "?:\\Windows\\apppatch\\*",
		     "?:\\Windows\\addins\\*",
		     "?:\\Windows\\Setup\\*",
		     "?:\\Windows\\Help\\*",
		     "?:\\Windows\\SKB\\*",                   "?:\\Windows\\Vss\\*",
		     "?:\\Windows\\servicing\\*",
		     "?:\\Windows\\CbsTemp\\*",
		     "?:\\Windows\\Logs\\*",
		     "?:\\Windows\\WaaS\\*",
		     "?:\\Windows\\twain_32\\*",
		     "?:\\Windows\\ShellExperiences\\*",
		     "?:\\Windows\\ShellComponents\\*",
		     "?:\\Windows\\PLA\\*",
		     "?:\\Windows\\Migration\\*",
		     "?:\\Windows\\debug\\*",
		     "?:\\Windows\\Cursors\\*",
		     "?:\\Windows\\Containers\\*",
		     "?:\\Windows\\Boot\\*",
		     "?:\\Windows\\bcastdvr\\*",
		     "?:\\Windows\\TextInput\\*",
		     "?:\\Windows\\security\\*",
		     "?:\\Windows\\schemas\\*",
		     "?:\\Windows\\SchCache\\*",
		     "?:\\Windows\\Resources\\*",
		     "?:\\Windows\\rescache\\*",
		     "?:\\Windows\\Provisioning\\*",
		     "?:\\Windows\\PrintDialog\\*",
		     "?:\\Windows\\PolicyDefinitions\\*",
		     "?:\\Windows\\media\\*",
		     "?:\\Windows\\Globalization\\*",
		     "?:\\Windows\\L2Schemas\\*",
		     "?:\\Windows\\LiveKernelReports\\*",
		     "?:\\Windows\\ModemLogs\\*",
		     "?:\\Windows\\ImmersiveControlPanel\\*",
		     "?:\\$Recycle.Bin\\*")   ) and    not dll.hash.sha256 :
		     ("3ed33e71641645367442e65dca6dab0d326b22b48ef9a4c2a2488e67383aa
		     9a6",              "b4db053f6032964df1b254ac44cb995ffaeb4f3ade0
		     9597670aba4f172cf65e4",              "214c75f678bc596bbe667a3b5
		     20aaaf09a0e50c364a28ac738a02f867a085eba",              "23aa95b
		     637a1bf6188b386c21c4e87967ede80242327c55447a5bb70d9439244",
		     "5050b025909e81ae5481db37beb807a80c52fc6dd30c8aa47c9f7841e2a31b
		     e7")

NamE: Suspicious WMI Event Subscription Created
	description: 
		     Detects the creation of a WMI Event
		     Subscription. Attackers can abuse this mechanism for
		     persistence or to elevate to SYSTEM privileges.
	query: 
		     any where  (    (event.dataset ==
		     "windows.sysmon_operational" and event.code == "21" and
		     winlog.event_data.Operation : "Created" and
		     winlog.event_data.Consumer :
		     ("*subscription:CommandLineEventConsumer*",
		     "*subscription:ActiveScriptEventConsumer*")) or
		     (event.dataset == "endpoint.events.api" and event.provider ==
		     "Microsoft-Windows-WMI-Activity" and process.Ext.api.name ==
		     "IWbemServices::PutInstance" and
		     process.Ext.api.parameters.consumer_type in
		     ("ActiveScriptEventConsumer", "CommandLineEventConsumer"))  )

NamE: Boot File Copy
	description: 
		     This rule detects the process of copying or
		     moving files from or to the `/boot` directory on Linux systems.
		     The `/boot` directory contains files that are essential for the
		     system to boot, such as the kernel and initramfs images.
		     Attackers may copy or move files to the `/boot` directory to
		     modify the boot process, which can be leveraged to maintain
		     access to the system.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed") and process.name in ("cp", "mv")
		     and process.parent.executable != null and process.args like~
		     "/boot/*" and not (   process.parent.name in ("update-
		     initramfs", "dracut", "grub-mkconfig", "shim-install", "sudo",
		     "activate-theme", "update-grub-gfxpayload", "grub-pc.postinst")
		     or   process.parent.executable like~
		     ("/usr/lib/kernel/install.d/*", "/tmp/newroot/*",
		     "/var/lib/dpkg/info/*") or   process.parent.args like~
		     ("/usr/bin/mkinitcpio", "/var/tmp/rpm-tmp.*") )

NamE: System Information Discovery via Windows Command Shell
	description: 
		     Identifies the execution of discovery commands
		     to enumerate system information, files, and folders using the
		     Windows Command Shell.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : "cmd.exe" and process.args :
		     "/c" and process.args : ("set", "dir") and   not
		     process.parent.executable : (     "?:\\Program Files\\*",
		     "?:\\Program Files (x86)\\*",     "?:\\PROGRA~1\\*",
		     "?:\\TeamCity\\jre\\bin\\java.exe"   ) and   not process.args :
		     (     "*\\db\\rabbit@*", "*/db/rabbit@*",     "*rabbitmq/db/*",
		     "*RabbitMQ\\db*"   ) and   not process.parent.args :
		     "*C:\\Program Files (x86)\\Tanium\\Tanium
		     Client\\TPython\\TPython.bat*"

NamE: Base64 Decoded Payload Piped to Interpreter
	description: 
		     This rule detects when a base64 decoded payload
		     is piped to an interpreter on Linux systems. Adversaries may
		     use base64 encoding to obfuscate data and pipe it to an
		     interpreter to execute malicious code. This technique may be
		     used to evade detection by host- or network-based security
		     controls.
	query: 
		     sequence by host.id, process.parent.entity_id with
		     maxspan=3s   [process where host.os.type == "linux" and
		     event.type == "start" and event.action == "exec" and (
		     (process.name in ("base64", "base64plain", "base64url",
		     "base64mime", "base64pem", "base32", "base16") and
		     process.command_line like~ "*-*d*") or     (process.name ==
		     "openssl" and process.args == "enc" and process.args in ("-d",
		     "-base64", "-a")) or     (process.name like "python*" and
		     (process.args == "base64" and process.args in ("-d", "-u",
		     "-t")) or     (process.args == "-c" and process.args like
		     "*base64*" and process.command_line like~ "*b64decode*")     )
		     or     (process.name like "perl*" and process.command_line
		     like~ "*decode_base64*") or     (process.name like "ruby*" and
		     process.args == "-e" and process.command_line like~
		     "*Base64.decode64*")   )]  [process where host.os.type ==
		     "linux" and event.type == "start" and event.action == "exec"
		     and process.name like~ (     "bash", "dash", "sh", "tcsh",
		     "csh", "zsh", "ksh", "fish", "python*", "perl*", "ruby*",
		     "lua*", "php*"  )]

NamE: Connection to Commonly Abused Web Services
	description: 
		     Adversaries may implement command and control
		     (C2) communications that use common web services to hide their
		     activity. This attack technique is typically targeted at an
		     organization and uses web services common to the victim
		     network, which allows the adversary to blend into legitimate
		     traffic activity. These popular services are typically targeted
		     since they have most likely been used before compromise, which
		     helps malicious traffic blend in.
	query: 
		     network where host.os.type == "windows" and
		     network.protocol == "dns" and     process.name != null and
		     user.id not in ("S-1-5-18", "S-1-5-19", "S-1-5-20") and     /*
		     Add new WebSvc domains here */     dns.question.name :        (
		     "raw.githubusercontent.*",         "pastebin.*",
		     "paste4btc.com",         "paste.ee",         "ghostbin.com",
		     "drive.google.com",         "?.docs.live.net",
		     "api.dropboxapi.*",         "content.dropboxapi.*",
		     "dl.dropboxusercontent.*",         "api.onedrive.com",
		     "*.onedrive.org",         "onedrive.live.com",
		     "filebin.net",         "*.ngrok.io",         "ngrok.com",
		     "*.portmap.*",         "*serveo.net",
		     "*localtunnel.me",         "*pagekite.me",
		     "*localxpose.io",         "*notabug.org",
		     "rawcdn.githack.*",         "paste.nrecom.net",
		     "zerobin.net",         "controlc.com",
		     "requestbin.net",         "slack.com",         "api.slack.com",
		     "slack-redir.net",         "slack-files.com",
		     "cdn.discordapp.com",         "discordapp.com",
		     "discord.com",         "apis.azureedge.net",
		     "cdn.sql.gg",         "?.top4top.io",         "top4top.io",
		     "www.uplooder.net",         "*.cdnmegafiles.com",
		     "transfer.sh",         "gofile.io",
		     "updates.peer2profit.com",         "api.telegram.org",
		     "t.me",         "meacz.gq",         "rwrd.org",
		     "*.publicvm.com",         "*.blogspot.com",
		     "api.mylnikov.org",         "file.io",
		     "stackoverflow.com",         "*files.1drv.com",
		     "api.anonfile.com",         "*hosting-profi.de",
		     "ipbase.com",         "ipfs.io",         "*up.freeo*.space",
		     "api.mylnikov.org",         "script.google.com",
		     "script.googleusercontent.com",         "api.notion.com",
		     "graph.microsoft.com",         "*.sharepoint.com",
		     "mbasic.facebook.com",         "login.live.com",
		     "api.gofile.io",         "api.anonfiles.com",
		     "api.notion.com",         "api.trello.com",
		     "gist.githubusercontent.com",         "files.pythonhosted.org",
		     "g.live.com",         "*.zulipchat.com",
		     "webhook.site",         "run.mocky.io",         "mockbin.org",
		     "www.googleapis.com",          "googleapis.com",
		     "global.rel.tunnels.api.visualstudio.com",
		     "*.devtunnels.ms") and              /* Insert noisy false
		     positives here */     not (       (         process.executable
		     : (           "?:\\Program Files\\*.exe",
		     "?:\\Program Files (x86)\\*.exe",
		     "?:\\Windows\\System32\\WWAHost.exe",
		     "?:\\Windows\\System32\\smartscreen.exe",
		     "?:\\Windows\\System32\\MicrosoftEdgeCP.exe",
		     "?:\\ProgramData\\Microsoft\\Windows
		     Defender\\Platform\\*\\MsMpEng.exe",           "?:\\Users\\*\\A
		     ppData\\Local\\Google\\Chrome\\Application\\chrome.exe",
		     "?:\\Users\\*\\AppData\\Local\\BraveSoftware\\*\\Application\\b
		     rave.exe",           "?:\\Users\\*\\AppData\\Local\\Vivaldi\\Ap
		     plication\\vivaldi.exe",
		     "?:\\Users\\*\\AppData\\Local\\Programs\\Opera*\\opera.exe",
		     "?:\\Users\\*\\AppData\\Local\\Programs\\Fiddler\\Fiddler.exe",
		     "?:\\Users\\*\\AppData\\Local\\Programs\\Microsoft VS
		     Code\\Code.exe",           "?:\\Users\\*\\AppData\\Local\\Micro
		     soft\\OneDrive\\OneDrive.exe",
		     "?:\\Windows\\system32\\mobsync.exe",
		     "?:\\Windows\\SysWOW64\\mobsync.exe"         )       ) or
		     /* Discord App */       (process.name : "Discord.exe" and
		     (process.code_signature.subject_name : "Discord Inc." and
		     process.code_signature.trusted == true) and dns.question.name :
		     ("discord.com", "cdn.discordapp.com", "discordapp.com")       )
		     or         /* MS Sharepoint */       (process.name :
		     "Microsoft.SharePoint.exe" and
		     (process.code_signature.subject_name : "Microsoft Corporation"
		     and        process.code_signature.trusted == true) and
		     dns.question.name : "onedrive.live.com"       ) or         /*
		     Firefox */       (process.name : "firefox.exe" and
		     (process.code_signature.subject_name : "Mozilla Corporation"
		     and        process.code_signature.trusted == true)       ) or
		     /* Dropbox */       (process.name : "Dropbox.exe" and
		     (process.code_signature.subject_name : "Dropbox, Inc" and
		     process.code_signature.trusted == true) and dns.question.name :
		     ("api.dropboxapi.com", "*.dropboxusercontent.com")       ) or
		     /* Obsidian - Plugins are stored on raw.githubusercontent.com
		     */       (process.name : "Obsidian.exe" and
		     (process.code_signature.subject_name : "Dynalist Inc" and
		     process.code_signature.trusted == true) and dns.question.name :
		     "raw.githubusercontent.com"       ) or         /*
		     WebExperienceHostApp */       (process.name :
		     "WebExperienceHostApp.exe" and
		     (process.code_signature.subject_name : "Microsoft Windows" and
		     process.code_signature.trusted == true) and dns.question.name :
		     ("onedrive.live.com", "skyapi.onedrive.live.com")       ) or
		     (process.code_signature.subject_name : "Microsoft *" and
		     process.code_signature.trusted == true and
		     dns.question.name : ("*.sharepoint.com", "graph.microsoft.com",
		     "g.live.com", "login.live.com", "login.live.com")) or
		     (process.code_signature.trusted == true and
		     process.code_signature.subject_name :
		     ("Johannes Schindelin",                               "Redis
		     Inc.",                               "Slack Technologies, LLC",
		     "Cisco Systems, Inc.",                               "Dropbox,
		     Inc",                               "Amazon.com Services LLC"))
		     )

NamE: Unusual Process Execution on WBEM Path
	description: 
		     Identifies unusual processes running from the
		     WBEM path, uncommon outside WMI-related Windows processes.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.executable :
		     ("?:\\Windows\\System32\\wbem\\*",
		     "?:\\Windows\\SysWow64\\wbem\\*") and   not process.name : (
		     "mofcomp.exe",     "scrcons.exe",     "unsecapp.exe",
		     "wbemtest.exe",     "winmgmt.exe",     "wmiadap.exe",
		     "wmiapsrv.exe",     "wmic.exe",     "wmiprvse.exe"   )

NamE: Suspicious Execution from INET Cache
	description: 
		     Identifies the execution of a process with
		     arguments pointing to the INetCache Folder. Adversaries may
		     deliver malicious content via WININET during initial access.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.name : ("explorer.exe",
		     "winrar.exe", "7zFM.exe", "Bandizip.exe") and   (
		     process.args : "?:\\Users\\*\\AppData\\Local\\Microsoft\\Window
		     s\\INetCache\\IE\\*" or     process.executable : (       "?:\\U
		     sers\\*\\AppData\\Local\\Microsoft\\Windows\\INetCache\\IE\\*",
		     "\\Device\\HarddiskVolume?\\Users\\*\\AppData\\Local\\Microsoft
		     \\Windows\\INetCache\\IE\\*"     )   )

NamE: High Number of Process Terminations
	description: 
		     This rule identifies a high number (10) of
		     process terminations via pkill from the same host within a
		     short time period.
	query: 
		     event.category:process and host.os.type:linux and
		     event.type:start and process.name:"pkill" and process.args:"-f"

NamE: Svchost spawning Cmd
	description: 
		     Identifies a suspicious parent child process
		     relationship with cmd.exe descending from svchost.exe
	query: 
		     host.os.type:windows and event.category:process and
		     event.type:start and process.parent.name:"svchost.exe" and
		     process.name:("cmd.exe" or "Cmd.exe" or "CMD.EXE") and not
		     process.command_line : "\"cmd.exe\" /C sc control
		     hptpsmarthealthservice 211"

NamE: PowerShell Suspicious Discovery Related Windows API Functions
	description: 
		     This rule detects the use of discovery-related
		     Windows API functions in PowerShell Scripts. Attackers can use
		     these functions to perform various situational awareness
		     related activities, like enumerating users, shares, sessions,
		     domain trusts, groups, etc.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (     NetShareEnum or
		     NetWkstaUserEnum or     NetSessionEnum or     NetLocalGroupEnum
		     or     NetLocalGroupGetMembers or     DsGetSiteName or
		     DsEnumerateDomainTrusts or     WTSEnumerateSessionsEx or
		     WTSQuerySessionInformation or     LsaGetLogonSessionData or
		     QueryServiceObjectSecurity or     GetComputerNameEx or
		     NetWkstaGetInfo or     GetUserNameEx or     NetUserEnum or
		     NetUserGetInfo or     NetGroupEnum or     NetGroupGetInfo or
		     NetGroupGetUsers or     NetWkstaTransportEnum or
		     NetServerGetInfo or     LsaEnumerateTrustedDomains  or
		     NetScheduleJobEnum or     NetUserModalsGet   ) and   not
		     powershell.file.script_block_text : (     ("DsGetSiteName" and
		     ("DiscoverWindowsComputerProperties.ps1" and
		     "param($SourceType, $SourceId, $ManagedEntityId,
		     $ComputerIdentity)")) or     ("# Copyright: (c) 2018, Ansible
		     Project" and "#Requires -Module Ansible.ModuleUtils.AddType"
		     and "#AnsibleRequires -CSharpUtil Ansible.Basic") or
		     ("Ansible.Windows.Setup" and "Ansible.Windows.Setup" and
		     "NativeMethods.NetWkstaGetInfo(null, 100, out netBuffer);")   )

NamE: Deprecated - Potential Container Escape via Modified notify_on_release File
	description: 
		     This rule detects modification of the cgroup
		     notify_on_release file from inside a container. When the
		     notify_on_release flag is enabled (1) in a cgroup, then
		     whenever the last task in the cgroup exits or attaches to
		     another cgroup, the command specified in the release_agent file
		     is run and invoked from the host. A privileged container with
		     SYS_ADMIN capabilities, enables a threat actor to mount a
		     cgroup directory and modify the notify_on_release flag in order
		     to take advantage of this feature, which could be used for
		     further privilege escalation and container escapes to the host
		     machine.
	query: 
		     file where event.module == "cloud_defend" and
		     event.action == "open" and event.type == "change" and file.name
		     : "notify_on_release"

NamE: Potential Successful Linux FTP Brute Force Attack Detected
	description: 
		     An FTP (file transfer protocol) brute force
		     attack is a method where an attacker systematically tries
		     different combinations of usernames and passwords to gain
		     unauthorized access to an FTP server, and if successful, the
		     impact can include unauthorized data access, manipulation, or
		     theft, compromising the security and integrity of the server
		     and potentially exposing sensitive information. This rule
		     identifies multiple consecutive authentication failures
		     targeting a specific user account from the same source address
		     and within a short time interval, followed by a successful
		     authentication.
	query: 
		     sequence by host.id, auditd.data.addr, related.user
		     with maxspan=5s   [authentication where host.os.type == "linux"
		     and event.action == "authenticated" and    auditd.data.terminal
		     == "ftp" and event.outcome == "failure" and auditd.data.addr !=
		     null and    auditd.data.addr != "0.0.0.0" and auditd.data.addr
		     != "::"] with runs=10   [authentication where host.os.type ==
		     "linux" and event.action  == "authenticated" and
		     auditd.data.terminal == "ftp" and event.outcome == "success"
		     and auditd.data.addr != null and    auditd.data.addr !=
		     "0.0.0.0" and auditd.data.addr != "::"] | tail 1

NamE: System Shells via Services
	description: 
		     Windows services typically run as SYSTEM and can
		     be used as a privilege escalation opportunity. Malware or
		     penetration testers may run a shell as a service to gain SYSTEM
		     permissions.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.name : "services.exe" and
		     process.name : ("cmd.exe", "powershell.exe", "pwsh.exe",
		     "powershell_ise.exe") and    /* Third party FP's */   not
		     process.args : "NVDisplay.ContainerLocalSystem"

NamE: Persistence via KDE AutoStart Script or Desktop File Modification
	description: 
		     Identifies the creation or modification of a K
		     Desktop Environment (KDE) AutoStart script or desktop file that
		     will execute upon each user logon. Adversaries may abuse this
		     method for persistence.
	query: 
		     file where host.os.type == "linux" and event.type !=
		     "deletion" and   file.extension in ("sh", "desktop") and
		     file.path :     (       "/home/*/.config/autostart/*",
		     "/root/.config/autostart/*",       "/home/*/.kde/Autostart/*",
		     "/root/.kde/Autostart/*",       "/home/*/.kde4/Autostart/*",
		     "/root/.kde4/Autostart/*",
		     "/home/*/.kde/share/autostart/*",
		     "/root/.kde/share/autostart/*",
		     "/home/*/.kde4/share/autostart/*",
		     "/root/.kde4/share/autostart/*",
		     "/home/*/.local/share/autostart/*",
		     "/root/.local/share/autostart/*",
		     "/home/*/.config/autostart-scripts/*",
		     "/root/.config/autostart-scripts/*",
		     "/etc/xdg/autostart/*", "/usr/share/autostart/*"     ) and
		     not process.name in (       "yum", "dpkg", "install", "dnf",
		     "teams", "yum-cron", "dnf-automatic", "docker", "dockerd",
		     "rpm", "pacman",       "podman", "nautilus", "remmina",
		     "cinnamon-settings.py", "executor", "xfce4-clipman",
		     "jetbrains-toolbox",       "ansible-admin", "apk"     )

NamE: Renamed Utility Executed with Short Program Name
	description: 
		     Identifies the execution of a process with a
		     single character process name, differing from the original file
		     name. This is often done by adversaries while staging,
		     executing temporary utilities, or trying to bypass security
		     detections based on the process name.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and length(process.name) > 0 and
		     length(process.name) == 5 and
		     length(process.pe.original_file_name) > 5

NamE: Potential Hidden Process via Mount Hidepid
	description: 
		     Identifies the execution of mount process with
		     hidepid parameter, which can make processes invisible to other
		     users from the system. Adversaries using Linux kernel version
		     3.2+ (or RHEL/CentOS v6.5+ above) can hide the process from
		     other users. When hidepid=2 option is executed to mount the
		     /proc filesystem, only the root user can see all processes and
		     the logged-in user can only see their own process. This
		     provides a defense evasion mechanism for the adversaries to
		     hide their process executions from all other commands such as
		     ps, top, pgrep and more. With the Linux kernel hardening
		     hidepid option all the user has to do is remount the /proc
		     filesystem with the option, which can now be monitored and
		     detected.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "executed", "process_started") and   process.name ==
		     "mount" and process.args == "/proc" and process.args == "-o"
		     and process.args : "*hidepid=2*" and   not
		     process.parent.command_line like "/opt/cloudlinux/*"

NamE: Unusual Execution via Microsoft Common Console File
	description: 
		     Identifies the execution of a child process from
		     a Microsoft Common Console file. Adversaries may embed a
		     malicious command in an MSC file in order to trick victims into
		     executing malicious commands.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  process.parent.executable :
		     "?:\\Windows\\System32\\mmc.exe" and
		     endswith~(process.parent.args, ".msc") and  not
		     process.parent.args : ("?:\\Windows\\System32\\*.msc",
		     "?:\\Windows\\SysWOW64\\*.msc", "?:\\Program files\\*.msc",
		     "?:\\Program Files (x86)\\*.msc")

NamE: ESXI Timestomping using Touch Command
	description: 
		     Identifies instances where the 'touch' command
		     is executed on a Linux system with the "-r" flag, which is used
		     to modify the timestamp of a file based on another file's
		     timestamp. The rule targets specific VM-related paths, such as
		     "/etc/vmware/", "/usr/lib/vmware/", or "/vmfs/*". These paths
		     are associated with VMware virtualization software, and their
		     presence in the touch command arguments may indicate that a
		     threat actor is attempting to tamper with timestamps of VM-
		     related files and configurations on the system.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and  event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed", "process_started") and
		     process.name == "touch" and process.args == "-r" and
		     process.args : ("/etc/vmware/*", "/usr/lib/vmware/*",
		     "/vmfs/*")

NamE: Microsoft Exchange Transport Agent Install Script
	description: 
		     Identifies the use of Cmdlets and methods
		     related to Microsoft Exchange Transport Agents install.
		     Adversaries may leverage malicious Microsoft Exchange Transport
		     Agents to execute tasks in response to adversary-defined
		     criteria, establishing persistence.
	query: 
		     event.category: "process" and host.os.type:windows and
		     powershell.file.script_block_text : (     (     "Install-
		     TransportAgent" or     "Enable-TransportAgent"     )   ) and
		     not user.id : "S-1-5-18" and   not
		     powershell.file.script_block_text : (     "'Install-
		     TransportAgent', 'Invoke-MonitoringProbe', 'Mount-Database',
		     'Move-ActiveMailboxDatabase'," or     "'Enable-TransportAgent',
		     'Enable-TransportRule', 'Export-ActiveSyncLog', 'Export-
		     AutoDiscoverConfig'," or     ("scriptCmd.GetSteppablePipeline"
		     and "ForwardHelpTargetName Install-TransportAgent")   )

NamE: Multiple Okta User Authentication Events with Same Device Token Hash
	description: 
		     Detects when a high number of Okta user
		     authentication events are reported for multiple users in a
		     short time frame. Adversaries may attempt to launch a
		     credential stuffing or password spraying attack from the same
		     device by using a list of known usernames and passwords to gain
		     unauthorized access to user accounts.
	query: 
		     FROM logs-okta* | WHERE     event.dataset ==
		     "okta.system"     AND (event.action RLIKE
		     "user\\.authentication(.*)" OR event.action ==
		     "user.session.start")     AND
		     okta.debug_context.debug_data.dt_hash != "-"     AND
		     okta.outcome.reason == "INVALID_CREDENTIALS" | KEEP
		     event.action, okta.debug_context.debug_data.dt_hash,
		     okta.actor.id, okta.actor.alternate_id, okta.outcome.reason |
		     STATS     target_auth_count = COUNT_DISTINCT(okta.actor.id)
		     BY okta.debug_context.debug_data.dt_hash,
		     okta.actor.alternate_id | WHERE     target_auth_count > 20 |
		     SORT     target_auth_count DESC

NamE: First Occurrence of User Agent For a GitHub Personal Access Token (PAT)
	description: 
		     Detects a new user agent used for a GitHub PAT
		     not previously seen in the last 14 days.
	query: 
		     event.dataset:"github.audit" and
		     event.category:"configuration" and github.user_agent:* and
		     github.hashed_token:* and
		     github.programmatic_access_type:("OAuth access token" or "Fine-
		     grained personal access token")

NamE: Microsoft 365 Potential ransomware activity
	description: 
		     Identifies when Microsoft Cloud App Security
		     reports that a user has uploaded files to the cloud that might
		     be infected with ransomware.
	query: 
		     event.dataset:o365.audit and
		     event.provider:SecurityComplianceCenter and event.category:web
		     and event.action:"Potential ransomware activity" and
		     event.outcome:success

NamE: Potentially Suspicious Process Started via tmux or screen
	description: 
		     This rule monitors for the execution of
		     suspicious commands via screen and tmux. When launching a
		     command and detaching directly, the commands will be executed
		     in the background via its parent process. Attackers may
		     leverage screen or tmux to execute commands while attempting to
		     evade detection.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2") and   process.parent.name in
		     ("screen", "tmux") and process.name like (     "nmap", "nc",
		     "ncat", "netcat", "socat", "nc.openbsd", "ngrok", "ping",
		     "java", "php*", "perl", "ruby", "lua*",     "openssl",
		     "telnet", "wget", "curl", "id"   )

NamE: Suspicious Execution via Windows Subsystem for Linux
	description: 
		     Detects Linux Bash commands from the the Windows
		     Subsystem for Linux. Adversaries may enable and use WSL for
		     Linux to avoid detection.
	query: 
		     process where host.os.type == "windows" and event.type
		     : "start" and   (     (       (process.executable :
		     "?:\\Windows\\System32\\bash.exe" or
		     ?process.pe.original_file_name == "Bash.exe") and       not
		     process.command_line : ("bash", "bash.exe")     ) or
		     process.executable : "?:\\Users\\*\\AppData\\Local\\Packages\\*
		     \\rootfs\\usr\\bin\\bash" or     (       process.parent.name :
		     "wsl.exe" and process.parent.command_line : "bash*" and not
		     process.name : "wslhost.exe"     ) or     (       process.name
		     : "wsl.exe" and process.args : (         "curl", "/etc/shadow",
		     "/etc/passwd", "cat", "--system", "root", "-e", "--exec",
		     "bash", "/mnt/c/*"       ) and not process.args : ("wsl-
		     bootstrap", "docker-desktop-data", "*.vscode-server*")     )
		     ) and     not process.parent.executable : ("?:\\Program
		     Files\\Docker\\*.exe", "?:\\Program Files
		     (x86)\\Docker\\*.exe")

NamE: AWS IAM AdministratorAccess Policy Attached to Group
	description: 
		     An adversary with access to a set of compromised
		     credentials may attempt to persist or escalate privileges by
		     attaching additional permissions to user groups the compromised
		     user account belongs to. This rule looks for use of the IAM
		     `AttachGroupPolicy` API operation to attach the highly
		     permissive `AdministratorAccess` AWS managed policy to an
		     existing IAM user group.
	query: 
		     from logs-aws.cloudtrail-* metadata _id, _version,
		     _index | where event.provider == "iam.amazonaws.com" and
		     event.action == "AttachGroupPolicy" and event.outcome ==
		     "success" | dissect aws.cloudtrail.request_parameters "{%{?poli
		     cyArn}=%{?arn}:%{?aws}:%{?iam}::%{?aws}:%{?policy}/%{policyName
		     },%{?groupName}=%{group.name}}" | where policyName ==
		     "AdministratorAccess" | keep @timestamp, event.provider,
		     event.action, event.outcome, policyName, group.name

NamE: AWS Discovery API Calls via CLI from a Single Resource
	description: 
		     Detects when a single AWS resource is running
		     multiple `Describe` and `List` API calls in a 10-second window.
		     This behavior could indicate an actor attempting to discover
		     the AWS infrastructure using compromised credentials or a
		     compromised instance. Adversaries may use this information to
		     identify potential targets for further exploitation or to gain
		     a better understanding of the target's infrastructure.
	query: 
		     from logs-aws.cloudtrail*  // create time window
		     buckets of 10 seconds | eval time_window = date_trunc(10
		     seconds, @timestamp) | where     event.dataset ==
		     "aws.cloudtrail"      // filter on CloudTrail audit logs for
		     IAM, EC2, and S3 events only     and event.provider in (
		     "iam.amazonaws.com",       "ec2.amazonaws.com",
		     "s3.amazonaws.com",       "rds.amazonaws.com",
		     "lambda.amazonaws.com",       "dynamodb.amazonaws.com",
		     "kms.amazonaws.com",       "cloudfront.amazonaws.com",
		     "elasticloadbalancing.amazonaws.com",
		     "cloudfront.amazonaws.com"     )      // ignore AWS service
		     actions     and aws.cloudtrail.user_identity.type !=
		     "AWSService"      // filter for aws-cli specifically     and
		     user_agent.name == "aws-cli"      // exclude
		     DescribeCapacityReservations events related to AWS Config
		     and not event.action in ("DescribeCapacityReservations")  //
		     filter for Describe, Get, List, and Generate API calls | where
		     true in (     starts_with(event.action, "Describe"),
		     starts_with(event.action, "Get"),     starts_with(event.action,
		     "List"),     starts_with(event.action, "Generate") ) // extract
		     owner, identity type, and actor from the ARN | dissect
		     aws.cloudtrail.user_identity.arn
		     "%{}::%{owner}:%{identity_type}/%{actor}" | where
		     starts_with(actor, "AWSServiceRoleForConfig") != true | keep
		     @timestamp, time_window, event.action,
		     aws.cloudtrail.user_identity.arn | stats     // count the
		     number of unique API calls per time window and actor
		     unique_api_count = count_distinct(event.action) by time_window,
		     aws.cloudtrail.user_identity.arn  // filter for more than 5
		     unique API calls per time window | where unique_api_count > 5
		     // sort the results by the number of unique API calls in
		     descending order | sort unique_api_count desc

NamE: AWS EventBridge Rule Disabled or Deleted
	description: 
		     Identifies when a user has disabled or deleted
		     an EventBridge rule. This activity can result in an unintended
		     loss of visibility in applications or a break in the flow with
		     other AWS services.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:eventbridge.amazonaws.com and
		     event.action:(DeleteRule or DisableRule) and
		     event.outcome:success

NamE: Azure Automation Webhook Created
	description: 
		     Identifies when an Azure Automation webhook is
		     created. Azure Automation runbooks can be configured to execute
		     via a webhook. A webhook uses a custom URL passed to Azure
		     Automation along with a data payload specific to the runbook.
		     An adversary may create a webhook in order to trigger a runbook
		     that contains malicious code.
	query: 
		     event.dataset:azure.activitylogs and
		     azure.activitylogs.operation_name:     (
		     "MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/WEBHOOKS/ACTION" or
		     "MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/WEBHOOKS/WRITE"     )
		     and   event.outcome:(Success or success)

NamE: Possible Consent Grant Attack via Azure-Registered Application
	description: 
		     Detects when a user grants permissions to an
		     Azure-registered application or when an administrator grants
		     tenant-wide permissions to an application. An adversary may
		     create an Azure-registered application that requests access to
		     data such as contact information, email, or documents.
	query: 
		     event.dataset:(azure.activitylogs or azure.auditlogs
		     or o365.audit) and   (
		     azure.activitylogs.operation_name:"Consent to application" or
		     azure.auditlogs.operation_name:"Consent to application" or
		     event.action:"Consent to application."   ) and
		     event.outcome:(Success or success)

NamE: AWS EC2 Security Group Configuration Change
	description: 
		     Identifies a change to an AWS Security Group
		     Configuration. A security group is like a virtual firewall, and
		     modifying configurations may allow unauthorized access. Threat
		     actors may abuse this to establish persistence, exfiltrate
		     data, or pivot in an AWS environment.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "ec2.amazonaws.com"     and event.action:(
		     "AuthorizeSecurityGroupEgress" or
		     "CreateSecurityGroup" or             "ModifyInstanceAttribute"
		     or             "ModifySecurityGroupRules" or
		     "RevokeSecurityGroupEgress" or
		     "RevokeSecurityGroupIngress")     and event.outcome: "success"

NamE: Tampering of Shell Command-Line History
	description: 
		     Adversaries may attempt to clear or disable the
		     Bash command-line history in an attempt to evade detection or
		     forensic investigations.
	query: 
		     process where event.action in ("exec", "exec_event",
		     "executed", "process_started") and event.type == "start" and  (
		     ((process.args : ("rm", "echo") or     (process.args : "ln" and
		     process.args : "-sf" and process.args : "/dev/null") or
		     (process.args : "truncate" and process.args : "-s0"))     and
		     process.args : (".bash_history", "/root/.bash_history",
		     "/home/*/.bash_history","/Users/.bash_history",
		     "/Users/*/.bash_history",
		     ".zsh_history", "/root/.zsh_history", "/home/*/.zsh_history",
		     "/Users/.zsh_history", "/Users/*/.zsh_history")) or
		     (process.args : "history" and process.args : "-c") or
		     (process.args : "export" and process.args :
		     ("HISTFILE=/dev/null", "HISTFILESIZE=0")) or   (process.args :
		     "unset" and process.args : "HISTFILE") or   (process.args :
		     "set" and process.args : "history" and process.args : "+o")  )

NamE: Suspicious Sysctl File Event
	description: 
		     Monitors file events on sysctl configuration
		     files (e.g., /etc/sysctl.conf, /etc/sysctl.d/*.conf) to
		     identify potential unauthorized access or manipulation of
		     system-level configuration settings. Attackers may tamper with
		     the sysctl configuration files to modify kernel parameters,
		     potentially compromising system stability, performance, or
		     security.
	query: 
		     host.os.type:linux and event.category:file and
		     event.action:("opened-file" or "read-file" or "wrote-to-file")
		     and file.path : ("/etc/sysctl.conf" or "/etc/sysctl.d" or
		     /etc/sysctl.d/*) and not process.name:(   dpkg or dockerd or
		     unattended-upg or systemd-sysctl or python* or auditbeat or
		     dpkg or pool* )

NamE: Account Password Reset Remotely
	description: 
		     Identifies an attempt to reset a potentially
		     privileged account password remotely. Adversaries may
		     manipulate account passwords to maintain access or evade
		     password duration policies and preserve compromised
		     credentials.
	query: 
		     sequence by winlog.computer_name with maxspan=1m
		     [authentication where event.action == "logged-in" and     /*
		     event 4624 need to be logged */     winlog.logon.type :
		     "Network" and event.outcome == "success" and source.ip != null
		     and     source.ip != "127.0.0.1" and source.ip != "::1" and
		     not winlog.event_data.TargetUserName : ("svc*", "PIM_*", "_*_",
		     "*-*-*", "*$")] by winlog.event_data.TargetLogonId    /* event
		     4724 need to be logged */   [iam where event.action == "reset-
		     password" and    (     /*        This rule is very noisy if not
		     scoped to privileged accounts, duplicate the        rule and
		     add your own naming convention and accounts of interest here.
		     */     winlog.event_data.TargetUserName: ("*Admin*", "*super*",
		     "*SVC*", "*DC0*", "*service*", "*DMZ*", "*ADM*") or
		     winlog.event_data.TargetSid : ("S-1-5-21-*-500",
		     "S-1-12-1-*-500")     )   ] by winlog.event_data.SubjectLogonId

NamE: Execution of Persistent Suspicious Program
	description: 
		     Identifies execution of suspicious persistent
		     programs (scripts, rundll32, etc.) by looking at process
		     lineage and command line usage.
	query: 
		     /* userinit followed by explorer followed by early
		     child process of explorer (unlikely to be launched
		     interactively) within 1m */ sequence by host.id, user.name with
		     maxspan=1m   [process where host.os.type == "windows" and
		     event.type == "start" and process.name : "userinit.exe" and
		     process.parent.name : "winlogon.exe"]   [process where
		     host.os.type == "windows" and event.type == "start" and
		     process.name : "explorer.exe"]   [process where host.os.type ==
		     "windows" and event.type == "start" and process.parent.name :
		     "explorer.exe" and    /* add suspicious programs here */
		     process.pe.original_file_name in ("cscript.exe",
		     "wscript.exe",
		     "PowerShell.EXE",
		     "MSHTA.EXE",
		     "RUNDLL32.EXE",
		     "REGSVR32.EXE",
		     "RegAsm.exe",
		     "MSBuild.exe",
		     "InstallUtil.exe") and     /* add potential suspicious paths
		     here */     process.args : ("C:\\Users\\*",
		     "C:\\ProgramData\\*", "C:\\Windows\\Temp\\*",
		     "C:\\Windows\\Tasks\\*", "C:\\PerfLogs\\*", "C:\\Intel\\*")
		     ]

NamE: Startup Folder Persistence via Unsigned Process
	description: 
		     Identifies files written or modified in the
		     startup folder by unsigned processes. Adversaries may abuse
		     this technique to maintain persistence in an environment.
	query: 
		     sequence by host.id, process.entity_id with maxspan=5s
		     [process where host.os.type == "windows" and event.type ==
		     "start" and process.code_signature.trusted == false and   /*
		     suspicious paths can be added here  */    process.executable :
		     ("C:\\Users\\*.exe",
		     "C:\\ProgramData\\*.exe",
		     "C:\\Windows\\Temp\\*.exe",
		     "C:\\Windows\\Tasks\\*.exe",
		     "C:\\Intel\\*.exe",
		     "C:\\PerfLogs\\*.exe")    ]    [file where host.os.type ==
		     "windows" and event.type != "deletion" and user.domain != "NT
		     AUTHORITY" and     file.path :
		     ("C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Windows\\Start
		     Menu\\Programs\\Startup\\*",
		     "C:\\ProgramData\\Microsoft\\Windows\\Start
		     Menu\\Programs\\StartUp\\*")    ]

NamE: Registry Persistence via AppCert DLL
	description: 
		     Detects attempts to maintain persistence by
		     creating registry keys using AppCert DLLs. AppCert DLLs are
		     loaded by every process using the common API functions to
		     create processes.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.path : (
		     "HKLM\\SYSTEM\\*ControlSet*\\Control\\Session
		     Manager\\AppCertDLLs\\*",
		     "\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Control\\Session
		     Manager\\AppCertDLLs\\*",
		     "MACHINE\\SYSTEM\\*ControlSet*\\Control\\Session
		     Manager\\AppCertDLLs\\*"   )

NamE: Incoming DCOM Lateral Movement with ShellBrowserWindow or ShellWindows
	description: 
		     Identifies use of Distributed Component Object
		     Model (DCOM) to run commands from a remote host, which are
		     launched via the ShellBrowserWindow or ShellWindows Application
		     COM Object. This behavior may indicate an attacker abusing a
		     DCOM application to stealthily move laterally.
	query: 
		     sequence by host.id with maxspan=5s  [network where
		     host.os.type == "windows" and event.type == "start" and
		     process.name : "explorer.exe" and   network.direction :
		     ("incoming", "ingress") and network.transport == "tcp" and
		     source.port > 49151 and destination.port > 49151 and source.ip
		     != "127.0.0.1" and source.ip != "::1"  ] by process.entity_id
		     [process where host.os.type == "windows" and event.type ==
		     "start" and   process.parent.name : "explorer.exe"  ] by
		     process.parent.entity_id

NamE: Potential Linux Local Account Brute Force Detected
	description: 
		     Identifies multiple consecutive login attempts
		     executed by one process targeting a local linux user account
		     within a short time interval. Adversaries might brute force
		     login attempts across different users with a default wordlist
		     or a set of customly crafted passwords in an attempt to gain
		     access to these accounts.
	query: 
		     sequence by host.id, process.parent.executable,
		     user.id with maxspan=1s   [process where host.os.type ==
		     "linux" and event.type == "start" and event.action == "exec"
		     and process.name == "su" and    not process.parent.name in (
		     "bash", "dash", "ash", "sh", "tcsh", "csh", "zsh", "ksh",
		     "fish", "clickhouse-server", "ma", "gitlab-runner",
		     "updatedb.findutils", "cron", "perl", "sudo", "java", "cloud-
		     app-identify", "ambari-sudo.sh"    )   ] with runs=10

NamE: Potential Masquerading as Communication Apps
	description: 
		     Identifies suspicious instances of
		     communications apps, both unsigned and renamed ones, that can
		     indicate an attempt to conceal malicious activity, bypass
		     security features such as allowlists, or trick users into
		     executing malware.
	query: 
		     process where host.os.type == "windows" and
		     event.type == "start" and   (     /* Slack */     (process.name
		     : "slack.exe" and not
		     (process.code_signature.subject_name in (         "Slack
		     Technologies, Inc.",         "Slack Technologies, LLC"        )
		     and process.code_signature.trusted == true)     ) or      /*
		     WebEx */     (process.name : "WebexHost.exe" and not
		     (process.code_signature.subject_name in ("Cisco WebEx LLC",
		     "Cisco Systems, Inc.") and process.code_signature.trusted ==
		     true)     ) or      /* Teams */     (process.name : "Teams.exe"
		     and not       (process.code_signature.subject_name ==
		     "Microsoft Corporation" and process.code_signature.trusted ==
		     true)     ) or      /* Discord */     (process.name :
		     "Discord.exe" and not
		     (process.code_signature.subject_name == "Discord Inc." and
		     process.code_signature.trusted == true)     ) or      /*
		     RocketChat */     (process.name : "Rocket.Chat.exe" and not
		     (process.code_signature.subject_name == "Rocket.Chat
		     Technologies Corp." and process.code_signature.trusted == true)
		     ) or      /* Mattermost */     (process.name : "Mattermost.exe"
		     and not       (process.code_signature.subject_name ==
		     "Mattermost, Inc." and process.code_signature.trusted == true)
		     ) or      /* WhatsApp */     (process.name : "WhatsApp.exe" and
		     not       (process.code_signature.subject_name in (
		     "WhatsApp LLC",         "WhatsApp, Inc",
		     "24803D75-212C-471A-BC57-9EF86AB91435"        ) and
		     process.code_signature.trusted == true)     ) or      /* Zoom
		     */     (process.name : "Zoom.exe" and not
		     (process.code_signature.subject_name == "Zoom Video
		     Communications, Inc." and process.code_signature.trusted ==
		     true)     ) or      /* Outlook */     (process.name :
		     "outlook.exe" and not
		     (process.code_signature.subject_name == "Microsoft Corporation"
		     and process.code_signature.trusted == true)     ) or      /*
		     Thunderbird */     (process.name : "thunderbird.exe" and not
		     (process.code_signature.subject_name == "Mozilla Corporation"
		     and process.code_signature.trusted == true)     )   )

NamE: Potential Remote Desktop Tunneling Detected
	description: 
		     Identifies potential use of an SSH utility to
		     establish RDP over a reverse SSH Tunnel. This can be used by
		     attackers to enable routing of network packets that would
		     otherwise not reach their intended destination.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   /* RDP port and usual SSH tunneling related
		     switches in command line */   process.args : "*:3389" and
		     process.args : ("-L", "-P", "-R", "-pw", "-ssh")

NamE: Discovery of Internet Capabilities via Built-in Tools
	description: 
		     Identifies the use of built-in tools attackers
		     can use to check for Internet connectivity on compromised
		     systems. These results may be used to determine communication
		     capabilities with C2 servers, or to identify routes,
		     redirectors, and proxy servers.
	query: 
		     host.os.type:windows and event.category:process and
		     event.type:start and  process.name.caseless:("ping.exe" or
		     "tracert.exe" or "pathping.exe") and not
		     process.args:("127.0.0.1" or "0.0.0.0" or "localhost" or "::1")

NamE: Network Traffic Capture via CAP_NET_RAW
	description: 
		     Identifies the ability of a process to be able
		     to create RAW and PACKET socket types for the available network
		     namespaces by a non-root user. A malicious process with this
		     capability may exploit routing between hosts, bypass network
		     access controls, and otherwise tamper with host networking if a
		     firewall is not in place to limit the packet types and
		     contents. The CAP_NET_RAW capability allows the process to bind
		     to any address within the available namespaces, which allows
		     network traffic sniffing by a non root user. The rule
		     identifies previously unknown processes executing with
		     CAP_NET_RAW capabilities through the use of the new terms rule
		     type.
	query: 
		     event.category:"process" and host.os.type:"linux" and
		     event.type:"start" and event.action:"exec" and process.name:*
		     and (process.thread.capabilities.effective:"CAP_NET_RAW" or
		     process.thread.capabilities.permitted:"CAP_NET_RAW") and not
		     user.id:"0"

NamE: Azure Global Administrator Role Addition to PIM User
	description: 
		     Identifies an Azure Active Directory (AD) Global
		     Administrator role addition to a Privileged Identity Management
		     (PIM) user account. PIM is a service that enables you to
		     manage, control, and monitor access to important resources in
		     an organization. Users who are assigned to the Global
		     administrator role can read and modify any administrative
		     setting in your Azure AD organization.
	query: 
		     event.dataset:azure.auditlogs and
		     azure.auditlogs.properties.category:RoleManagement and
		     azure.auditlogs.operation_name:("Add eligible member to role in
		     PIM completed (permanent)" or
		     "Add member to role in PIM completed (timebound)") and     azur
		     e.auditlogs.properties.target_resources.*.display_name:"Global
		     Administrator" and     event.outcome:(Success or success)

NamE: Potential ADIDNS Poisoning via Wildcard Record Creation
	description: 
		     Active Directory Integrated DNS (ADIDNS) is one
		     of the core components of AD DS, leveraging AD's access control
		     and replication to maintain domain consistency. It stores DNS
		     zones as AD objects, a feature that, while robust, introduces
		     some security issues, such as wildcard records, mainly because
		     of the default permission (Any authenticated users) to create
		     DNS-named records. Attackers can create wildcard records to
		     redirect traffic that doesn't explicitly match records
		     contained in the zone, becoming the Man-in-the-Middle and being
		     able to abuse DNS similarly to LLMNR/NBNS spoofing.
	query: 
		     any where host.os.type == "windows" and event.code ==
		     "5137" and     startsWith(winlog.event_data.ObjectDN, "DC=*,")

NamE: Attempt to Delete an Okta Network Zone
	description: 
		     Detects attempts to delete an Okta network zone.
		     Okta network zones can be configured to limit or restrict
		     access to a network based on IP addresses or geolocations. An
		     adversary may attempt to modify, delete, or deactivate an Okta
		     network zone in order to remove or weaken an organization's
		     security controls.
	query: 
		     event.dataset:okta.system and event.action:zone.delete

NamE: Ransomware - Detected - Elastic Endgame
	description: 
		     Elastic Endgame detected ransomware. Click the
		     Elastic Endgame icon in the event.module column or the link in
		     the rule.reference column for additional information.
	query: 
		     event.kind:alert and event.module:endgame and
		     endgame.metadata.type:detection and
		     (event.action:ransomware_event or
		     endgame.event_subtype_full:ransomware_event)

NamE: Attempt to Deactivate an Okta Policy Rule
	description: 
		     Detects attempts to deactivate a rule within an
		     Okta policy. An adversary may attempt to deactivate a rule
		     within an Okta policy in order to remove or weaken an
		     organization's security controls.
	query: 
		     event.dataset:okta.system and
		     event.action:policy.rule.deactivate

NamE: AWS EC2 Admin Credential Fetch via Assumed Role
	description: 
		     Identifies the first occurrence of a user
		     identity in AWS using `GetPassword` for the administrator
		     password of an EC2 instance with an assumed role. Adversaries
		     may use this API call to escalate privileges or move laterally
		     within EC2 instances.
	query: 
		     event.dataset:"aws.cloudtrail"     and
		     event.provider:"ec2.amazonaws.com" and
		     event.action:"GetPasswordData"     and
		     aws.cloudtrail.user_identity.type:"AssumedRole" and
		     aws.cloudtrail.error_code:"Client.UnauthorizedOperation"

NamE: Azure OpenAI Insecure Output Handling
	description: 
		     Detects when Azure OpenAI requests result in
		     zero response length, potentially indicating issues in output
		     handling that might lead to security exploits such as data
		     leaks or code execution. This can occur in cases where the API
		     fails to handle outputs correctly under certain input
		     conditions.
	query: 
		     from logs-azure_openai.logs-* | where
		     azure.open_ai.properties.response_length == 0 and
		     azure.open_ai.result_signature == "200" and
		     azure.open_ai.operation_name == "ChatCompletions_Create" | keep
		     azure.open_ai.properties.request_length,
		     azure.open_ai.result_signature, cloud.account.id,
		     azure.resource.name | stats count = count() by
		     azure.resource.name | where count >= 10 | sort count desc

NamE: Dumping of Keychain Content via Security Command
	description: 
		     Adversaries may dump the content of the keychain
		     storage data from a system to acquire credentials. Keychains
		     are the built-in way for macOS to keep track of users'
		     passwords and credentials for many services and features,
		     including Wi-Fi and website passwords, secure notes,
		     certificates, and Kerberos.
	query: 
		     process where host.os.type == "macos" and event.type
		     in ("start", "process_started") and process.args : "dump-
		     keychain" and process.args : "-d"

NamE: PsExec Network Connection
	description: 
		     Identifies use of the SysInternals tool
		     PsExec.exe making a network connection. This could be an
		     indication of lateral movement.
	query: 
		     sequence by process.entity_id   [process where
		     host.os.type == "windows" and process.name : "PsExec.exe" and
		     event.type == "start" and     /* This flag suppresses the
		     display of the license dialog and may       indicate that
		     psexec executed for the first time in the machine */
		     process.args : "-accepteula" and     not process.executable : (
		     "?:\\ProgramData\\Docusnap\\Discovery\\discovery\\plugins\\17\\
		     Bin\\psexec.exe",                              "?:\\Docusnap
		     11\\Bin\\psexec.exe",                              "?:\\Program
		     Files\\Docusnap X\\Bin\\psexec.exe",
		     "?:\\Program Files\\Docusnap X\\Tools\\dsDNS.exe") and    not
		     process.parent.executable : "?:\\Program Files
		     (x86)\\Cynet\\Cynet Scanner\\CynetScanner.exe"]   [network
		     where host.os.type == "windows" and process.name :
		     "PsExec.exe"]

NamE: AWS IAM Password Recovery Requested
	description: 
		     Identifies AWS IAM password recovery requests.
		     An adversary may attempt to gain unauthorized AWS access by
		     abusing password recovery mechanisms.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:signin.amazonaws.com and
		     event.action:PasswordRecoveryRequested and
		     event.outcome:success

NamE: Group Policy Discovery via Microsoft GPResult Utility
	description: 
		     Detects the usage of gpresult.exe to query group
		     policy objects. Attackers may query group policy objects during
		     the reconnaissance phase after compromising a system to gain a
		     better understanding of the active directory environment and
		     possible methods to escalate privileges or move laterally.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and (process.name: "gpresult.exe" or
		     ?process.pe.original_file_name == "gprslt.exe") and
		     process.args: ("/z", "/v", "/r", "/x")

NamE: SUID/SGID Bit Set
	description: 
		     An adversary may add the setuid or setgid bit to
		     a file or directory in order to run a file with the privileges
		     of the owning user or group. An adversary can take advantage of
		     this to either do a shell escape or exploit a vulnerability in
		     an application with the setuid or setgid bit to get code
		     running in a different user’s context. Additionally,
		     adversaries can use this mechanism on their own malware to make
		     sure they're able to execute in elevated contexts in the
		     future.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action == "exec" and (   (process.name ==
		     "chmod" and (process.args : ("+s", "u+s", "g+s") or
		     process.args regex "[24][0-9]{3}")) or   (process.name ==
		     "install" and process.args : "-m" and   (process.args : ("+s",
		     "u+s", "g+s") or process.args regex "[24][0-9]{3}")) ) and not
		     (   process.parent.executable : (     "/usr/NX/*",
		     "/var/lib/docker/*", "/var/lib/dpkg/info*", "/tmp/newroot/*",
		     "/System/Library/PrivateFrameworks/PackageKit.framework/Version
		     s/A/XPCServices/package_script_service.xpc/Contents/MacOS/packa
		     ge_script_service"   ) or   process.args : (     "/run/*",
		     "/var/run/*", "/usr/bin/keybase-redirector",
		     "/usr/local/share/fonts", "/usr/bin/ssh-agent"   ) )

NamE: Modification of AmsiEnable Registry Key
	description: 
		     Identifies modifications of the AmsiEnable
		     registry key to 0, which disables the Antimalware Scan
		     Interface (AMSI). An adversary can modify this key to disable
		     AMSI protections.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.value : "AmsiEnable" and
		     registry.data.strings: ("0", "0x00000000")    /*     Full
		     registry key path omitted due to data source variations:
		     HKEY_USERS\\*\\Software\\Microsoft\\Windows
		     Script\\Settings\\AmsiEnable"   */

NamE: Unusual Child Process from a System Virtual Process
	description: 
		     Identifies a suspicious child process of the
		     Windows virtual system process, which could indicate code
		     injection.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.pid == 4 and process.executable
		     : "?*" and   not process.executable : ("Registry",
		     "MemCompression", "?:\\Windows\\System32\\smss.exe")

NamE: Attempt to Enable the Root Account
	description: 
		     Identifies attempts to enable the root account
		     using the dsenableroot command. This command may be abused by
		     adversaries for persistence, as the root account is disabled by
		     default.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:(start or process_started) and
		     process.name:dsenableroot and not process.args:"-d"

NamE: Network-Level Authentication (NLA) Disabled
	description: 
		     Identifies the attempt to disable Network-Level
		     Authentication (NLA) via registry modification. Network Level
		     Authentication (NLA) is a feature on Windows that provides an
		     extra layer of security for Remote Desktop (RDP) connections,
		     as it requires users to authenticate before allowing a full RDP
		     session. Attackers can disable NLA to enable persistence
		     methods that require access to the Windows sign-in screen
		     without authenticating, such as Accessibility Features
		     persistence methods, like Sticky Keys.
	query: 
		     registry where host.os.type == "windows" and
		     event.action != "deletion" and registry.value :
		     "UserAuthentication" and   registry.path : (
		     "HKLM\\SYSTEM\\ControlSet*\\Control\\Terminal
		     Server\\WinStations\\RDP-Tcp\\UserAuthentication",
		     "\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Control\\Terminal
		     Server\\WinStations\\RDP-Tcp\\UserAuthentication",
		     "MACHINE\\SYSTEM\\*ControlSet*\\Control\\Terminal
		     Server\\WinStations\\RDP-Tcp\\UserAuthentication"   ) and
		     registry.data.strings :  ("0", "0x00000000")

NamE: Privilege Escalation via Root Crontab File Modification
	description: 
		     Identifies modifications to the root crontab
		     file. Adversaries may overwrite this file to gain code
		     execution with root privileges by exploiting privileged file
		     write or move related vulnerabilities.
	query: 
		     event.category:file and host.os.type:macos and not
		     event.type:deletion and  file.path:/private/var/at/tabs/root
		     and not process.executable:/usr/bin/crontab

NamE: Kernel Load or Unload via Kexec Detected
	description: 
		     This detection rule identifies the usage of
		     kexec, helping to uncover unauthorized kernel replacements and
		     potential compromise of the system's integrity. Kexec is a
		     Linux feature that enables the loading and execution of a
		     different kernel without going through the typical boot
		     process. Malicious actors can abuse kexec to bypass security
		     measures, escalate privileges, establish persistence or hide
		     their activities by loading a malicious kernel, enabling them
		     to tamper with the system's trusted state, allowing e.g. a VM
		     Escape.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2", "executed", "process_started") and
		     process.name == "kexec" and process.args in ("--exec", "-e", "
		     --load", "-l", "--unload", "-u") and   not process.parent.name
		     in ("kdumpctl", "unload.sh")

NamE: Systemd Service Started by Unusual Parent Process
	description: 
		     Systemctl is a process used in Linux systems to
		     manage systemd processes through service configuration files.
		     Malicious actors can leverage systemd services to achieve
		     persistence by creating or modifying service files to execute
		     malicious commands or payloads during system startup. This
		     allows them to maintain unauthorized access, execute additional
		     malicious activities, or evade detection.
	query: 
		     host.os.type:linux and event.category:process and
		     event.type:start and event.action:exec and
		     process.executable:/usr/bin/systemctl and process.args:(enable
		     or reenable or start) and
		     process.entry_leader.entry_meta.type:* and not (
		     process.entry_leader.entry_meta.type:(container or init or
		     unknown) or   process.parent.pid:1 or
		     process.parent.executable:(     /bin/adduser or /bin/dnf or
		     /bin/dnf-automatic or /bin/dockerd or /bin/dpkg or
		     /bin/microdnf or /bin/pacman or     /bin/podman or /bin/rpm or
		     /bin/snapd or /bin/sudo or /bin/useradd or /bin/yum or
		     /usr/bin/dnf or     /usr/bin/dnf-automatic or /usr/bin/dockerd
		     or /usr/bin/dpkg or /usr/bin/microdnf or /usr/bin/pacman or
		     /usr/bin/podman or /usr/bin/rpm or /usr/bin/snapd or
		     /usr/bin/sudo or /usr/bin/yum or /usr/sbin/adduser or
		     /usr/sbin/invoke-rc.d or /usr/sbin/useradd or /var/lib/dpkg/*
		     ) or   process.args_count >= 5 )

NamE: Sudoers File Modification
	description: 
		     A sudoers file specifies the commands that users
		     or groups can run and from which terminals. Adversaries can
		     take advantage of these configurations to execute commands as
		     other users or spawn processes with higher privileges.
	query: 
		     event.category:file and event.type:change and
		     file.path:(/etc/sudoers* or /private/etc/sudoers*) and not
		     process.name:(dpkg or platform-python or puppet or yum or dnf)
		     and not process.executable:(/opt/chef/embedded/bin/ruby or
		     /opt/puppetlabs/puppet/bin/ruby or /usr/bin/dockerd)

NamE: Threat Intel Hash Indicator Match
	description: 
		     This rule is triggered when a hash indicator
		     from the Threat Intel Filebeat module or integrations has a
		     match against an event that contains file hashes, such as
		     antivirus alerts, process creation, library load, and file
		     operation events.
	query: 
		     file.hash.*:* or process.hash.*:* or dll.hash.*:*

NamE: AWS S3 Bucket Policy Added to Share with External Account
	description: 
		     Identifies an AWS S3 bucket policy change to
		     share permissions with an external account. Adversaries may
		     attempt to backdoor an S3 bucket by sharing it with an external
		     account. This can be used to exfiltrate data or to provide
		     access to other adversaries. This rule identifies changes to a
		     bucket policy via the `PutBucketPolicy` API call where the
		     policy includes an `Effect=Allow` statement that does not
		     contain the AWS account ID of the bucket owner.
	query: 
		     any where event.dataset == "aws.cloudtrail"     and
		     event.provider == "s3.amazonaws.com"     and event.action ==
		     "PutBucketPolicy" and event.outcome == "success"     and
		     stringContains(aws.cloudtrail.request_parameters,
		     "Effect=Allow")     and not
		     stringContains(aws.cloudtrail.request_parameters,
		     aws.cloudtrail.recipient_account_id)

NamE: Attempt to Revoke Okta API Token
	description: 
		     Identifies attempts to revoke an Okta API token.
		     An adversary may attempt to revoke or delete an Okta API token
		     to disrupt an organization's business operations.
	query: 
		     event.dataset:okta.system and
		     event.action:system.api_token.revoke

NamE: AWS Config Resource Deletion
	description: 
		     Identifies attempts to delete an AWS Config
		     Service resource. An adversary may tamper with Config services
		     in order to reduce visibility into the security posture of an
		     account and / or its workload instances.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:config.amazonaws.com and
		     event.action:(DeleteConfigRule or DeleteOrganizationConfigRule
		     or DeleteConfigurationAggregator or
		     DeleteConfigurationRecorder or DeleteConformancePack or
		     DeleteOrganizationConformancePack or     DeleteDeliveryChannel
		     or DeleteRemediationConfiguration or
		     DeleteRetentionConfiguration)

NamE: Potential Network Scan Detected
	description: 
		     This rule identifies a potential port scan. A
		     port scan is a method utilized by attackers to systematically
		     scan a target system or network for open ports, allowing them
		     to identify available services and potential vulnerabilities.
		     By mapping out the open ports, attackers can gather critical
		     information to plan and execute targeted attacks, gaining
		     unauthorized access, compromising security, and potentially
		     leading to data breaches, unauthorized control, or further
		     exploitation of the targeted system or network. This rule
		     defines a threshold-based approach to detect connection
		     attempts from a single source to a wide range of destination
		     ports.
	query: 
		     event.action:network_flow and destination.port:* and
		     source.ip:(10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16)

NamE: RPC (Remote Procedure Call) from the Internet
	description: 
		     This rule detects network events that may
		     indicate the use of RPC traffic from the Internet. RPC is
		     commonly used by system administrators to remotely control a
		     system for maintenance or to use shared resources. It should
		     almost never be directly exposed to the Internet, as it is
		     frequently targeted and exploited by threat actors as an
		     initial access or backdoor vector.
	query: 
		     (event.dataset: network_traffic.flow or
		     (event.category: (network or network_traffic))) and
		     network.transport:tcp and (destination.port:135 or
		     event.dataset:zeek.dce_rpc) and   not source.ip:(
		     10.0.0.0/8 or     127.0.0.0/8 or     169.254.0.0/16 or
		     172.16.0.0/12 or     192.0.0.0/24 or     192.0.0.0/29 or
		     192.0.0.8/32 or     192.0.0.9/32 or     192.0.0.10/32 or
		     192.0.0.170/32 or     192.0.0.171/32 or     192.0.2.0/24 or
		     192.31.196.0/24 or     192.52.193.0/24 or     192.168.0.0/16 or
		     192.88.99.0/24 or     224.0.0.0/4 or     100.64.0.0/10 or
		     192.175.48.0/24 or     198.18.0.0/15 or     198.51.100.0/24 or
		     203.0.113.0/24 or     240.0.0.0/4 or     "::1" or
		     "FE80::/10" or     "FF00::/8"   ) and   destination.ip:(
		     10.0.0.0/8 or     172.16.0.0/12 or     192.168.0.0/16   )

NamE: Azure AD Global Administrator Role Assigned
	description: 
		     In Azure Active Directory (Azure AD),
		     permissions to manage resources are assigned using roles. The
		     Global Administrator is a role that enables users to have
		     access to all administrative features in Azure AD and services
		     that use Azure AD identities like the Microsoft 365 Defender
		     portal, the Microsoft 365 compliance center, Exchange,
		     SharePoint Online, and Skype for Business Online. Attackers can
		     add users as Global Administrators to maintain access and
		     manage all subscriptions and their settings and resources.
	query: 
		     event.dataset:azure.auditlogs and
		     azure.auditlogs.properties.category:RoleManagement and
		     azure.auditlogs.operation_name:"Add member to role" and azure.a
		     uditlogs.properties.target_resources.0.modified_properties.1.ne
		     w_value:"\"Global Administrator\""

NamE: Potential Reverse Shell Activity via Terminal
	description: 
		     Identifies the execution of a shell process with
		     suspicious arguments which may be indicative of reverse shell
		     activity.
	query: 
		     process where event.type in ("start",
		     "process_started") and   process.name in ("sh", "bash", "zsh",
		     "dash", "zmodload") and   process.args : ("*/dev/tcp/*",
		     "*/dev/udp/*", "*zsh/net/tcp*", "*zsh/net/udp*") and    /*
		     noisy FPs */   not (process.parent.name : "timeout" and
		     process.executable : "/var/lib/docker/overlay*") and   not
		     process.command_line : (     "*/dev/tcp/sirh_db/*",
		     "*/dev/tcp/remoteiot.com/*", "*dev/tcp/elk.stag.one/*",
		     "*dev/tcp/kafka/*",     "*/dev/tcp/$0/$1*", "*/dev/tcp/127.*",
		     "*/dev/udp/127.*", "*/dev/tcp/localhost/*", "*/dev/tcp/itom-
		     vault/*") and   not process.parent.command_line : "runc init"

NamE: Potential Enumeration via Active Directory Web Service
	description: 
		     Identifies processes loading Active Directory
		     related modules followed by a network connection to the ADWS
		     dedicated TCP port. Adversaries may abuse the ADWS Windows
		     service that allows Active Directory to be queried via this web
		     service.
	query: 
		     sequence by process.entity_id with maxspan=3m
		     [library where host.os.type == "windows" and   dll.name :
		     ("System.DirectoryServices*.dll", "System.IdentityModel*.dll")
		     and   not user.id in ("S-1-5-18", "S-1-5-19", "S-1-5-20") and
		     not process.executable :
		     ("?:\\windows\\system32\\dsac.exe",
		     "?:\\program files\\powershell\\?\\pwsh.exe",
		     "?:\\windows\\system32\\windowspowershell\\*.exe",
		     "?:\\windows\\syswow64\\windowspowershell\\*.exe",
		     "?:\\program files\\microsoft monitoring agent\\*.exe",
		     "?:\\windows\\adws\\microsoft.activedirectory.webservices.exe")
		     ]  [network where host.os.type == "windows" and
		     destination.port == 9389 and source.port >= 49152 and
		     network.direction == "egress" and network.transport == "tcp"
		     and not cidrmatch(destination.ip, "127.0.0.0/8", "::1/128")]

NamE: Potential File Download via a Headless Browser
	description: 
		     Identifies the use of a browser to download a
		     file from a remote URL and from a suspicious parent process.
		     Adversaries may use browsers to avoid ingress tool transfer
		     restrictions.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  process.name : ("chrome.exe", "msedge.exe",
		     "brave.exe", "browser.exe", "dragon.exe", "vivaldi.exe") and
		     (process.args : "--headless*" or process.args :
		     "data:text/html;base64,*") and   process.parent.name :
		     ("cmd.exe", "powershell.exe", "wscript.exe", "cscript.exe",
		     "mshta.exe", "conhost.exe", "msiexec.exe",
		     "explorer.exe", "rundll32.exe", "winword.exe", "excel.exe",
		     "onenote.exe", "hh.exe", "powerpnt.exe", "forfiles.exe",
		     "pcalua.exe", "wmiprvse.exe")

NamE: Microsoft Build Engine Started an Unusual Process
	description: 
		     An instance of MSBuild, the Microsoft Build
		     Engine, started a PowerShell script or the Visual C# Command
		     Line Compiler. This technique is sometimes used to deploy a
		     malicious payload using the Build Engine.
	query: 
		     host.os.type:windows and event.category:process and
		     event.type:start and process.parent.name:("MSBuild.exe" or
		     "msbuild.exe") and process.name:("csc.exe" or "iexplore.exe" or
		     "powershell.exe")

NamE: Deprecated - Suspicious Network Tool Launched Inside A Container
	description: 
		     This rule detects commonly abused network
		     utilities running inside a container. Network utilities like
		     nc, nmap, dig, tcpdump, ngrep, telnet, mitmproxy, zmap can be
		     used for malicious purposes such as network reconnaissance,
		     monitoring, or exploitation, and should be monitored closely
		     within a container.
	query: 
		     process where container.id: "*" and event.type==
		     "start" and ( (process.name: ("nc", "ncat", "nmap", "dig",
		     "nslookup", "tcpdump", "tshark", "ngrep", "telnet",
		     "mitmproxy", "socat", "zmap", "masscan", "zgrab")) or /*account
		     for tools that execute utilities as a subprocess, in this case
		     the target utility name will appear as a process arg*/
		     (process.args: ("nc", "ncat", "nmap", "dig", "nslookup",
		     "tcpdump", "tshark", "ngrep", "telnet", "mitmproxy", "socat",
		     "zmap", "masscan", "zgrab")) )

NamE: Potential Credential Access via DCSync
	description: 
		     This rule identifies when a User Account starts
		     the Active Directory Replication Process. Attackers can use the
		     DCSync technique to get credential information of individual
		     accounts or the entire domain, thus compromising the entire
		     domain.
	query: 
		     any where event.code == "4662" and
		     winlog.event_data.Properties : (      /* Control Access
		     Rights/Permissions Symbol */      "*DS-Replication-Get-
		     Changes*",     "*DS-Replication-Get-Changes-All*",     "*DS-
		     Replication-Get-Changes-In-Filtered-Set*",      /* Identifying
		     GUID used in ACE */
		     "*1131f6ad-9c07-11d1-f79f-00c04fc2dcd2*",
		     "*1131f6aa-9c07-11d1-f79f-00c04fc2dcd2*",
		     "*89e95b76-444d-4c62-991a-0facbeda640c*")      /* The right to
		     perform an operation controlled by an extended access right. */
		     and winlog.event_data.AccessMask : "0x100" and     not
		     winlog.event_data.SubjectUserName : (           "*$", "MSOL_*",
		     "OpenDNS_Connector", "adconnect", "SyncADConnect",
		     "SyncADConnectCM", "aadsync", "svcAzureADSync", "-"         )
		     /* The Umbrella AD Connector uses the OpenDNS_Connector account
		     to perform replication */

NamE: Windows System Network Connections Discovery
	description: 
		     This rule identifies the execution of commands
		     that can be used to enumerate network connections. Adversaries
		     may attempt to get a listing of network connections to or from
		     a compromised system to identify targets within an environment.
	query: 
		     process where event.type == "start" and (
		     process.name : "netstat.exe" or   (    (     (process.name :
		     "net.exe" or process.pe.original_file_name == "net.exe") or
		     (      (process.name : "net1.exe" or
		     process.pe.original_file_name == "net1.exe") and      not
		     process.parent.name : "net.exe"     )    ) and process.args :
		     ("use", "user", "session", "config") and not process.args:
		     ("/persistent:*", "/delete", "\\\\*")   ) or   (process.name :
		     "nbtstat.exe" and process.args : "-s*") ) and not user.id :
		     "S-1-5-18"

NamE: ESXI Discovery via Find
	description: 
		     Identifies instances where the 'find' command is
		     started on a Linux system with arguments targeting specific VM-
		     related paths, such as "/etc/vmware/", "/usr/lib/vmware/", or
		     "/vmfs/*". These paths are associated with VMware
		     virtualization software, and their presence in the find command
		     arguments may indicate that a threat actor is attempting to
		     search for, analyze, or manipulate VM-related files and
		     configurations on the system.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "executed", "process_started") and   process.name ==
		     "find" and process.args : ("/etc/vmware/*",
		     "/usr/lib/vmware/*", "/vmfs/*") and   not
		     process.parent.executable ==
		     "/usr/lib/vmware/viewagent/bin/uninstall_viewagent.sh"

NamE: Persistence via Microsoft Office AddIns
	description: 
		     Detects attempts to establish persistence on an
		     endpoint by abusing Microsoft Office add-ins.
	query: 
		     file where host.os.type == "windows" and event.type !=
		     "deletion" and  file.extension :
		     ("wll","xll","ppa","ppam","xla","xlam") and  file.path :     (
		     "C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Word\\Startup\\*",
		     "C:\\Users\\*\\AppData\\Roaming\\Microsoft\\AddIns\\*",
		     "C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Excel\\XLSTART\\*"
		     )

NamE: Systemd-udevd Rule File Creation
	description: 
		     Monitors for the creation of rule files that are
		     used by systemd-udevd to manage device nodes and handle kernel
		     device events in the Linux operating system. Systemd-udevd can
		     be exploited for persistence by adversaries by creating
		     malicious udev rules that trigger on specific events, executing
		     arbitrary commands or payloads whenever a certain device is
		     plugged in or recognized by the system.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("rename", "creation") and process.executable != null and
		     file.extension == "rules" and file.path : (   "/lib/udev/*",
		     "/etc/udev/rules.d/*", "/usr/lib/udev/rules.d/*",
		     "/run/udev/rules.d/*", "/usr/local/lib/udev/rules.d/*" ) and
		     not (   process.executable in (     "/bin/dpkg",
		     "/usr/bin/dpkg", "/bin/dockerd", "/usr/bin/dockerd",
		     "/usr/sbin/dockerd", "/bin/microdnf",     "/usr/bin/microdnf",
		     "/bin/rpm", "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd",
		     "/bin/yum", "/usr/bin/yum",     "/bin/dnf", "/usr/bin/dnf",
		     "/bin/podman", "/usr/bin/podman", "/bin/dnf-automatic",
		     "/usr/bin/dnf-automatic",     "/bin/pacman", "/usr/bin/pacman",
		     "/usr/bin/dpkg-divert", "/bin/dpkg-divert", "/sbin/apk",
		     "/usr/sbin/apk",     "/usr/local/sbin/apk", "/usr/bin/apt",
		     "/usr/sbin/pacman", "/bin/podman", "/usr/bin/podman",
		     "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/lib/snapd/snapd", "/usr/local/bin/dockerd",
		     "/usr/libexec/netplan/generate",     "/lib/systemd/system-
		     generators/netplan", "/lib/systemd/systemd",
		     "/usr/bin/containerd", "/usr/sbin/sshd",     "/kaniko/executor"
		     ) or   file.Ext.original.extension == "dpkg-new" or
		     process.executable : (     "/nix/store/*", "/var/lib/dpkg/*",
		     "/snap/*", "/dev/fd/*", "/usr/lib/*", "/usr/libexec/*"   ) or
		     process.name in (     "systemd", "netplan", "apt-get", "vmware-
		     config-tools.pl", "systemd-hwdb", "ssm-agent-worker", "crio",
		     "cloud-init", "convert2rhel"    ) or   (process.name == "sed"
		     and file.name : "sed*") or   (process.name == "perl" and
		     file.name : "e2scrub_all.tmp*") )

NamE: Suspicious Execution via Scheduled Task
	description: 
		     Identifies execution of a suspicious program via
		     scheduled tasks by looking at process lineage and command line
		     usage.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and     /* Schedule service cmdline on Win10+ */
		     process.parent.name : "svchost.exe" and process.parent.args :
		     "Schedule" and     /* add suspicious programs here */
		     process.pe.original_file_name in
		     (                                   "cscript.exe",
		     "wscript.exe",
		     "PowerShell.EXE",                                   "Cmd.Exe",
		     "MSHTA.EXE",                                   "RUNDLL32.EXE",
		     "REGSVR32.EXE",
		     "MSBuild.exe",
		     "InstallUtil.exe",
		     "RegAsm.exe",                                   "RegSvcs.exe",
		     "msxsl.exe",                                   "CONTROL.EXE",
		     "EXPLORER.EXE",
		     "Microsoft.Workflow.Compiler.exe",
		     "msiexec.exe"                                   ) and     /*
		     add suspicious paths here */     process.args : (
		     "C:\\Users\\*",        "C:\\ProgramData\\*",
		     "C:\\Windows\\Temp\\*",        "C:\\Windows\\Tasks\\*",
		     "C:\\PerfLogs\\*",        "C:\\Intel\\*",
		     "C:\\Windows\\Debug\\*",        "C:\\HP\\*") and       not
		     (process.name : "cmd.exe" and process.args : "?:\\*.bat" and
		     process.working_directory : "?:\\Windows\\System32\\") and
		     not (process.name : "cscript.exe" and process.args :
		     "?:\\Windows\\system32\\calluxxprovider.vbs") and      not
		     (process.name : "powershell.exe" and process.args : ("-File",
		     "-PSConsoleFile") and user.id : "S-1-5-18") and      not
		     (process.name : "msiexec.exe" and user.id : "S-1-5-18")

NamE: Host Files System Changes via Windows Subsystem for Linux
	description: 
		     Detects files creation and modification on the
		     host system from the the Windows Subsystem for Linux.
		     Adversaries may enable and use WSL for Linux to avoid
		     detection.
	query: 
		     sequence by process.entity_id with maxspan=5m
		     [process where host.os.type == "windows" and event.type ==
		     "start" and   process.name : "dllhost.exe" and    /*
		     Plan9FileSystem CLSID - WSL Host File System Worker */
		     process.command_line :
		     "*{DFB65C4C-B34F-435D-AFE9-A86218684AA8}*"]  [file where
		     host.os.type == "windows" and process.name : "dllhost.exe" and
		     not file.path : "?:\\Users\\*\\Downloads\\*"]

NamE: Service Command Lateral Movement
	description: 
		     Identifies use of sc.exe to create, modify, or
		     start services on remote hosts. This could be indicative of
		     adversary lateral movement but will be noisy if commonly done
		     by admins.
	query: 
		     sequence by process.entity_id with maxspan = 1m
		     [process where host.os.type == "windows" and event.type ==
		     "start" and      (process.name : "sc.exe" or
		     process.pe.original_file_name : "sc.exe") and
		     process.args : "\\\\*" and process.args : ("binPath=*",
		     "binpath=*") and       process.args : ("create", "config",
		     "failure", "start")]   [network where host.os.type == "windows"
		     and process.name : "sc.exe" and destination.ip != "127.0.0.1"]

NamE: UAC Bypass via DiskCleanup Scheduled Task Hijack
	description: 
		     Identifies User Account Control (UAC) bypass via
		     hijacking DiskCleanup Scheduled Task. Attackers bypass UAC to
		     stealthily execute code with elevated permissions.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  process.args : "/autoclean" and process.args :
		     "/d" and process.executable != null and  not process.executable
		     : (         "C:\\Windows\\System32\\cleanmgr.exe",
		     "C:\\Windows\\SysWOW64\\cleanmgr.exe",
		     "C:\\Windows\\System32\\taskhostw.exe",
		     "\\Device\\HarddiskVolume?\\Windows\\System32\\cleanmgr.exe",
		     "\\Device\\HarddiskVolume?\\Windows\\SysWOW64\\cleanmgr.exe",
		     "\\Device\\HarddiskVolume?\\Windows\\System32\\taskhostw.exe" )

NamE: Malware - Detected - Elastic Endgame
	description: 
		     Elastic Endgame detected Malware. Click the
		     Elastic Endgame icon in the event.module column or the link in
		     the rule.reference column for additional information.
	query: 
		     event.kind:alert and event.module:endgame and
		     endgame.metadata.type:detection and
		     (event.action:file_classification_event or
		     endgame.event_subtype_full:file_classification_event)

NamE: Systemd Timer Created
	description: 
		     Detects the creation of a systemd timer within
		     any of the default systemd timer directories. Systemd timers
		     can be used by an attacker to gain persistence, by scheduling
		     the execution of a command or script. Similarly to cron/at,
		     systemd timers can be set up to execute on boot time, or on a
		     specific point in time, which allows attackers to regain access
		     in case the connection to the infected asset was lost.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("rename", "creation") and file.path : (
		     "/etc/systemd/system/*", "/etc/systemd/user/*",
		     "/usr/local/lib/systemd/system/*",   "/lib/systemd/system/*",
		     "/usr/lib/systemd/system/*", "/usr/lib/systemd/user/*",
		     "/home/*/.config/systemd/user/*",
		     "/home/*/.local/share/systemd/user/*",
		     "/root/.config/systemd/user/*",
		     "/root/.local/share/systemd/user/*" ) and file.extension ==
		     "timer" and not (   process.executable in (     "/bin/dpkg",
		     "/usr/bin/dpkg", "/bin/dockerd", "/usr/bin/dockerd",
		     "/usr/sbin/dockerd", "/bin/microdnf",     "/usr/bin/microdnf",
		     "/bin/rpm", "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd",
		     "/bin/yum", "/usr/bin/yum",     "/bin/dnf", "/usr/bin/dnf",
		     "/bin/podman", "/usr/bin/podman", "/bin/dnf-automatic",
		     "/usr/bin/dnf-automatic",     "/bin/pacman", "/usr/bin/pacman",
		     "/usr/bin/dpkg-divert", "/bin/dpkg-divert", "/sbin/apk",
		     "/usr/sbin/apk",     "/usr/local/sbin/apk", "/usr/bin/apt",
		     "/usr/sbin/pacman", "/bin/podman", "/usr/bin/podman",
		     "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/lib/snapd/snapd", "/usr/local/bin/dockerd",
		     "/usr/bin/crio", "/usr/sbin/crond",
		     "/opt/puppetlabs/puppet/bin/ruby", "/usr/libexec/platform-
		     python", "/kaniko/kaniko-executor",
		     "/usr/local/bin/dockerd", "/usr/bin/podman", "/bin/install",
		     "/proc/self/exe", "/kaniko/executor"   ) or   process.name like
		     (     "python*", "crio", "apt-get", "install", "snapd",
		     "cloudflared", "sshd", "convert-usrmerge", "docker-init",
		     "google_metadata_script_runner", "ssm-agent-worker", "pacman",
		     "convert2rhel", "platform-python"   ) or   file.extension in
		     ("swp", "swpx", "swx", "dpkg-remove") or
		     file.Ext.original.extension == "dpkg-new" or
		     process.executable : (     "/nix/store/*", "/var/lib/dpkg/*",
		     "/tmp/vmis.*", "/snap/*", "/dev/fd/*", "/usr/lib/virtualbox/*"
		     ) or   process.executable == null or   (process.name == "sed"
		     and file.name : "sed*") or   (process.name == "perl" and
		     file.name : "e2scrub_all.tmp*")  )

NamE: Suspicious Print Spooler SPL File Created
	description: 
		     Detects attempts to exploit privilege escalation
		     vulnerabilities related to the Print Spooler service including
		     CVE-2020-1048 and CVE-2020-1337.
	query: 
		     file where host.os.type == "windows" and event.type !=
		     "deletion" and   file.extension : "spl" and   file.path :
		     "?:\\Windows\\System32\\spool\\PRINTERS\\*" and   not
		     process.name : ("spoolsv.exe",
		     "printfilterpipelinesvc.exe",
		     "PrintIsolationHost.exe",                       "splwow64.exe",
		     "msiexec.exe",                       "poqexec.exe",
		     "System") and   not user.id : "S-1-5-18" and   not
		     process.executable :
		     ("?:\\Windows\\System32\\mmc.exe",
		     "\\Device\\Mup\\*.exe",
		     "?:\\Windows\\System32\\svchost.exe",
		     "?:\\Windows\\System32\\mmc.exe",
		     "?:\\Windows\\System32\\printui.exe",
		     "?:\\Windows\\System32\\mstsc.exe",
		     "?:\\Windows\\System32\\spool\\*.exe",
		     "?:\\Program Files\\*.exe",              "?:\\Program Files
		     (x86)\\*.exe",              "?:\\PROGRA~1\\*.exe",
		     "?:\\PROGRA~2\\*.exe",
		     "?:\\Windows\\System32\\rundll32.exe")

NamE: Git Hook Child Process
	description: 
		     This rule detects child processes spawned by Git
		     hooks. Git hooks are scripts that Git executes before or after
		     events such as commit, push, and receive. The rule identifies
		     child processes spawned by Git hooks that are not typically
		     spawned by the Git process itself. This behavior may indicate
		     an attacker attempting to hide malicious activity by leveraging
		     the legitimate Git process to execute unauthorized commands.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2") and   process.parent.name in (
		     "applypatch-msg", "commit-msg", "fsmonitor-watchman", "post-
		     update", "post-checkout", "post-commit",     "pre-applypatch",
		     "pre-commit", "pre-merge-commit", "prepare-commit-msg", "pre-
		     push", "pre-rebase", "pre-receive",     "push-to-checkout",
		     "update", "post-receive", "pre-auto-gc", "post-rewrite",
		     "sendemail-validate", "p4-pre-submit",     "post-index-change",
		     "post-merge", "post-applypatch"   ) and   (     process.name in
		     ("nohup", "setsid", "disown", "bash", "dash", "sh", "tcsh",
		     "csh", "zsh", "ksh", "fish") or     process.name : ("php*",
		     "perl*", "ruby*", "lua*") or     process.executable : (
		     "/boot/*", "/dev/shm/*", "/etc/cron.*/*", "/etc/init.d/*",
		     "/etc/update-motd.d/*",       "/run/*", "/srv/*", "/tmp/*",
		     "/var/tmp/*", "/var/log/*"     )   ) and   not process.name in
		     ("git", "dirname")

NamE: Initramfs Extraction via CPIO
	description: 
		     This rule detects the extraction of an initramfs
		     image using the `cpio` command on Linux systems. The `cpio`
		     command is used to create or extract cpio archives. Attackers
		     may extract the initramfs image to modify the contents or add
		     malicious files, which can be leveraged to maintain persistence
		     on the system.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed") and process.name == "cpio" and
		     process.args in ("-H", "--format") and process.args == "newc"
		     and not (   process.parent.name in ("mkinitramfs", "dracut") or
		     process.parent.executable like~ ("/usr/share/initramfs-
		     tools/*", "/nix/store/*") )

NamE: Web Application Suspicious Activity: sqlmap User Agent
	description: 
		     This is an example of how to detect an unwanted
		     web client user agent. This search matches the user agent for
		     sqlmap 1.3.11, which is a popular FOSS tool for testing web
		     applications for SQL injection vulnerabilities.
	query: 
		     user_agent.original:"sqlmap/1.3.11#stable
		     (http://sqlmap.org)"

NamE: Suspicious Access to LDAP Attributes
	description: 
		     Identify read access to a high number of Active
		     Directory object attributes. The knowledge of objects
		     properties can help adversaries find vulnerabilities, elevate
		     privileges or collect sensitive information.
	query: 
		     any where event.code == "4662" and not
		     winlog.event_data.SubjectUserSid : "S-1-5-18" and
		     winlog.event_data.AccessMaskDescription == "Read Property" and
		     length(winlog.event_data.Properties) >= 2000

NamE: AWS EC2 User Data Retrieval for EC2 Instance
	description: 
		     Identifies discovery request
		     `DescribeInstanceAttribute` with the attribute userData and
		     instanceId in AWS CloudTrail logs. This may indicate an attempt
		     to retrieve user data from an EC2 instance. Adversaries may use
		     this information to gather sensitive data from the instance
		     such as hardcoded credentials or to identify potential
		     vulnerabilities. This is a [New
		     Terms](https://www.elastic.co/guide/en/security/current/rules-
		     ui-create.html#create-new-terms-rule) rule that identifies when
		     `aws.cloudtrail.user_identity.arn` requests the user data for a
		     specific
		     `aws.cloudtrail.flattened.request_parameters.instanceId` from
		     an EC2 instance in the last 14 days.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "ec2.amazonaws.com"     and event.action:
		     "DescribeInstanceAttribute"     and event.outcome: "success"
		     and aws.cloudtrail.request_parameters: (*attribute=userData*
		     and *instanceId*)     and not
		     aws.cloudtrail.user_identity.invoked_by: (         "AWS
		     Internal" or         "cloudformation.amazonaws.com"     )

NamE: PowerShell Suspicious Script with Clipboard Retrieval Capabilities
	description: 
		     Detects PowerShell scripts that can get the
		     contents of the clipboard, which attackers can abuse to
		     retrieve sensitive information like credentials, messages, etc.
	query: 
		     event.category:process and host.os.type:windows and
		     (powershell.file.script_block_text : (     "Windows.Clipboard"
		     or     "Windows.Forms.Clipboard" or     "Windows.Forms.TextBox"
		     ) and    powershell.file.script_block_text : (     "]::GetText"
		     or     ".Paste()"   )) or powershell.file.script_block_text :
		     "Get-Clipboard" and   not powershell.file.script_block_text : (
		     "sentinelbreakpoints" and "Set-PSBreakpoint" and
		     "PowerSploitIndicators"   ) and   not user.id : "S-1-5-18" and
		     not (     file.path :
		     C\:\\Program?Files\\WindowsPowerShell\\*Modules*.ps1 and
		     file.name : ("Convert-ExcelRangeToImage.ps1" or "Read-
		     Clipboard.ps1")   )

NamE: Attempt to Create Okta API Token
	description: 
		     Detects attempts to create an Okta API token. An
		     adversary may create an Okta API token to maintain access to an
		     organization's network while they work to achieve their
		     objectives. An attacker may abuse an API token to execute
		     techniques such as creating user accounts or disabling security
		     rules or policies.
	query: 
		     event.dataset:okta.system and
		     event.action:system.api_token.create

NamE: Suspicious Portable Executable Encoded in Powershell Script
	description: 
		     Detects the presence of a portable executable
		     (PE) in a PowerShell script by looking for its encoded header.
		     Attackers embed PEs into PowerShell scripts to inject them into
		     memory, avoiding defences by not writing to disk.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (     TVqQAAMAAAAEAAAA   )
		     and not user.id : "S-1-5-18"

NamE: Unauthorized Access to an Okta Application
	description: 
		     Identifies unauthorized access attempts to Okta
		     applications.
	query: 
		     event.dataset:okta.system and
		     event.action:app.generic.unauth_app_access_attempt

NamE: Azure Frontdoor Web Application Firewall (WAF) Policy Deleted
	description: 
		     Identifies the deletion of a Frontdoor Web
		     Application Firewall (WAF) Policy in Azure. An adversary may
		     delete a Frontdoor Web Application Firewall (WAF) Policy in an
		     attempt to evade defenses and/or to eliminate barriers to their
		     objective.
	query: 
		     event.dataset:azure.activitylogs and azure.activitylog
		     s.operation_name:"MICROSOFT.NETWORK/FRONTDOORWEBAPPLICATIONFIRE
		     WALLPOLICIES/DELETE" and event.outcome:(Success or success)

NamE: Potential macOS SSH Brute Force Detected
	description: 
		     Identifies a high number (20) of macOS SSH
		     KeyGen process executions from the same host. An adversary may
		     attempt a brute force attack to obtain unauthorized access to
		     user accounts.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:start and process.name:"sshd-keygen-wrapper" and
		     process.parent.name:launchd

NamE: Unusual High Denied Sensitive Information Policy Blocks Detected
	description: 
		     Detects repeated compliance violation 'BLOCKED'
		     actions coupled with specific policy name such as
		     'sensitive_information_policy', indicating persistent misuse or
		     attempts to probe the model's denied topics.
	query: 
		     from logs-aws_bedrock.invocation-* | MV_EXPAND
		     gen_ai.policy.name | where gen_ai.policy.action == "BLOCKED"
		     and gen_ai.compliance.violation_detected == "true" and
		     gen_ai.policy.name == "sensitive_information_policy" | keep
		     user.id | stats sensitive_information_block = count() by
		     user.id | where sensitive_information_block > 5 | sort
		     sensitive_information_block desc

NamE: Network Connection from Binary with RWX Memory Region
	description: 
		     Monitors for the execution of a unix binary with
		     read, write and execute memory region permissions, followed by
		     a network connection. The mprotect() system call is used to
		     change the access protections on a region of memory that has
		     already been allocated. This syscall allows a process to modify
		     the permissions of pages in its virtual address space, enabling
		     or disabling permissions such as read, write, and execute for
		     those pages. RWX permissions on memory is in many cases overly
		     permissive, and should (especially in conjunction with an
		     outbound network connection) be analyzed thoroughly.
	query: 
		     sample by host.id, process.pid, process.name   /*
		     auditd.data.a2 == "7" translates to RWX memory region
		     protection (PROT_READ | PROT_WRITE | PROT_EXEC) */   [process
		     where host.os.type == "linux" and auditd.data.syscall ==
		     "mprotect" and auditd.data.a2 == "7" and    not process.name ==
		     "httpd"]   [network where host.os.type == "linux" and
		     event.type == "start" and event.action ==
		     "connection_attempted" and    not cidrmatch(destination.ip,
		     "127.0.0.0/8", "169.254.0.0/16", "224.0.0.0/4", "::1")]

NamE: Azure Command Execution on Virtual Machine
	description: 
		     Identifies command execution on a virtual
		     machine (VM) in Azure. A Virtual Machine Contributor role lets
		     you manage virtual machines, but not access them, nor access
		     the virtual network or storage account they’re connected to.
		     However, commands can be run via PowerShell on the VM, which
		     execute as System. Other roles, such as certain Administrator
		     roles may be able to execute commands on a VM as well.
	query: 
		     event.dataset:azure.activitylogs and azure.activitylog
		     s.operation_name:"MICROSOFT.COMPUTE/VIRTUALMACHINES/RUNCOMMAND/
		     ACTION" and event.outcome:(Success or success)

NamE: Multiple Logon Failure Followed by Logon Success
	description: 
		     Identifies multiple logon failures followed by a
		     successful one from the same source address. Adversaries will
		     often brute force login attempts across multiple users with a
		     common or known password, in an attempt to gain access to
		     accounts.
	query: 
		     sequence by winlog.computer_name, source.ip with
		     maxspan=5s   [authentication where event.action == "logon-
		     failed" and     /* event 4625 need to be logged */
		     winlog.logon.type : "Network" and user.id != null and
		     source.ip != null and source.ip != "127.0.0.1" and source.ip !=
		     "::1" and      not winlog.event_data.TargetUserSid : "S-1-0-0"
		     and not user.id : "S-1-0-0" and      not user.name :
		     ("ANONYMOUS LOGON", "-", "*$") and not user.domain == "NT
		     AUTHORITY" and      /* noisy failure status codes often
		     associated to authentication misconfiguration */     not
		     winlog.event_data.Status : ("0xC000015B", "0XC000005E",
		     "0XC0000133", "0XC0000192")] with runs=5   [authentication
		     where event.action == "logged-in" and     /* event 4624 need to
		     be logged */     winlog.logon.type : "Network" and
		     source.ip != null and source.ip != "127.0.0.1" and source.ip !=
		     "::1" and     not user.name : ("ANONYMOUS LOGON", "-", "*$")
		     and not user.domain == "NT AUTHORITY"]

NamE: Potential Shadow Credentials added to AD Object
	description: 
		     Identify the modification of the msDS-
		     KeyCredentialLink attribute in an Active Directory Computer or
		     User Object. Attackers can abuse control over the object and
		     create a key pair, append to raw public key in the attribute,
		     and obtain persistent and stealthy access to the target user or
		     computer object.
	query: 
		     event.code:"5136" and
		     winlog.event_data.AttributeLDAPDisplayName:"msDS-
		     KeyCredentialLink" and   winlog.event_data.AttributeValue
		     :B\:828* and   not winlog.event_data.SubjectUserName: MSOL_*

NamE: Multiple Okta User Authentication Events with Client Address
	description: 
		     Detects when a certain threshold of Okta user
		     authentication events are reported for multiple users from the
		     same client address. Adversaries may attempt to launch a
		     credential stuffing or password spraying attack from the same
		     device by using a list of known usernames and passwords to gain
		     unauthorized access to user accounts.
	query: 
		     FROM logs-okta* | WHERE     event.dataset ==
		     "okta.system"     AND (event.action == "user.session.start" OR
		     event.action RLIKE "user\\.authentication(.*)")     AND
		     okta.outcome.reason == "INVALID_CREDENTIALS" | KEEP
		     okta.client.ip, okta.actor.alternate_id, okta.actor.id,
		     event.action, okta.outcome.reason | STATS     source_auth_count
		     = COUNT_DISTINCT(okta.actor.id)     BY okta.client.ip,
		     okta.actor.alternate_id | WHERE     source_auth_count > 5 |
		     SORT     source_auth_count DESC

NamE: Microsoft 365 Exchange Anti-Phish Rule Modification
	description: 
		     Identifies the modification of an anti-phishing
		     rule in Microsoft 365. By default, Microsoft 365 includes
		     built-in features that help protect users from phishing
		     attacks. Anti-phishing rules increase this protection by
		     refining settings to better detect and prevent attacks.
	query: 
		     event.dataset:o365.audit and event.provider:Exchange
		     and event.category:web and event.action:("Remove-AntiPhishRule"
		     or "Disable-AntiPhishRule") and event.outcome:success

NamE: Unusual User Privilege Enumeration via id
	description: 
		     This rule monitors for a sequence of 20 "id"
		     command executions within 1 second by the same parent process.
		     This behavior is unusual, and may be indicative of the
		     execution of an enumeration script such as LinPEAS or LinEnum.
		     These scripts leverage the "id" command to enumerate the
		     privileges of all users present on the system.
	query: 
		     sequence by host.id, process.parent.entity_id with
		     maxspan=1s   [process where host.os.type == "linux" and
		     event.type == "start" and event.action == "exec" and
		     process.name == "id" and process.args_count == 2 and    not (
		     process.parent.name in ("rpm", "snarftmp", "quota_copy",
		     "java") or      process.parent.args : "/var/tmp/rpm-tmp*"
		     )] with runs=20

NamE: Potential File Transfer via Curl for Windows
	description: 
		     Identifies Curl for Windows making an HTTP
		     request. Adversaries could abuse Curl to download files or
		     upload data to a remote URL.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.executable : (
		     "?:\\Windows\\System32\\curl.exe",
		     "?:\\Windows\\SysWOW64\\curl.exe"   ) and
		     process.command_line : "*http*" and   process.parent.name : (
		     "cmd.exe", "powershell.exe",     "rundll32.exe",
		     "explorer.exe",     "conhost.exe", "forfiles.exe",
		     "wscript.exe", "cscript.exe",     "mshta.exe", "hh.exe",
		     "mmc.exe"   ) and    not (     user.id == "S-1-5-18" and     /*
		     Don't apply the user.id exclusion to Sysmon for compatibility
		     */     not event.dataset : ("windows.sysmon_operational",
		     "windows.sysmon")   ) and   /* Exclude System Integrity
		     Processes for Sysmon */   not ?winlog.event_data.IntegrityLevel
		     == "System"

NamE: Potential LSA Authentication Package Abuse
	description: 
		     Adversaries can use the autostart mechanism
		     provided by the Local Security Authority (LSA) authentication
		     packages for privilege escalation or persistence by placing a
		     reference to a binary in the Windows registry. The binary will
		     then be executed by SYSTEM when the authentication packages are
		     loaded.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.path : (
		     "HKLM\\SYSTEM\\*ControlSet*\\Control\\Lsa\\Authentication
		     Packages",       "\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Co
		     ntrol\\Lsa\\Authentication Packages"   ) and   /* exclude
		     SYSTEM SID - look for changes by non-SYSTEM user */   not
		     user.id : "S-1-5-18"

NamE: ProxyChains Activity
	description: 
		     This rule monitors for the execution of the
		     ProxyChains utility. ProxyChains is a command-line tool that
		     enables the routing of network connections through intermediary
		     proxies, enhancing anonymity and enabling access to restricted
		     resources. Attackers can exploit the ProxyChains utility to
		     hide their true source IP address, evade detection, and perform
		     malicious activities through a chain of proxy servers,
		     potentially masking their identity and intentions.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed", "process_started")  and
		     process.name == "proxychains"

NamE: Shell Configuration Creation or Modification
	description: 
		     This rule monitors the creation/alteration of a
		     shell configuration file. Unix systems use shell configuration
		     files to set environment variables, create aliases, and
		     customize the user's environment. Adversaries may modify or add
		     a shell configuration file to execute malicious code and gain
		     persistence in the system. This behavior is consistent with the
		     Kaiji malware family.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("rename", "creation") and file.path : (   // system-wide
		     configurations   "/etc/profile", "/etc/profile.d/*",
		     "/etc/bash.bashrc", "/etc/bash.bash_logout", "/etc/zsh/*",
		     "/etc/csh.cshrc", "/etc/csh.login", "/etc/fish/config.fish",
		     "/etc/ksh.kshrc",   // root and user configurations
		     "/home/*/.profile", "/home/*/.bashrc", "/home/*/.bash_login",
		     "/home/*/.bash_logout", "/home/*/.bash_profile",
		     "/root/.profile", "/root/.bashrc", "/root/.bash_login",
		     "/root/.bash_logout", "/root/.bash_profile",
		     "/home/*/.zprofile", "/home/*/.zshrc", "/root/.zprofile",
		     "/root/.zshrc",   "/home/*/.cshrc", "/home/*/.login",
		     "/home/*/.logout", "/root/.cshrc", "/root/.login",
		     "/root/.logout",   "/home/*/.config/fish/config.fish",
		     "/root/.config/fish/config.fish",   "/home/*/.kshrc",
		     "/root/.kshrc" ) and not (   process.executable in (
		     "/bin/dpkg", "/usr/bin/dpkg", "/bin/dockerd",
		     "/usr/bin/dockerd", "/usr/sbin/dockerd", "/bin/microdnf",
		     "/usr/bin/microdnf", "/bin/rpm", "/usr/bin/rpm", "/bin/snapd",
		     "/usr/bin/snapd", "/bin/yum", "/usr/bin/yum",     "/bin/dnf",
		     "/usr/bin/dnf", "/bin/podman", "/usr/bin/podman", "/bin/dnf-
		     automatic", "/usr/bin/dnf-automatic",     "/bin/pacman",
		     "/usr/bin/pacman", "/usr/bin/dpkg-divert", "/bin/dpkg-divert",
		     "/sbin/apk", "/usr/sbin/apk",     "/usr/local/sbin/apk",
		     "/usr/bin/apt", "/usr/sbin/pacman", "/bin/podman",
		     "/usr/bin/podman", "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/lib/snapd/snapd", "/usr/sbin/adduser",
		     "/usr/sbin/useradd", "/usr/local/bin/dockerd",
		     "/usr/sbin/gdm", "/usr/bin/unzip", "/usr/bin/gnome-shell",
		     "/sbin/mkhomedir_helper", "/usr/sbin/sshd",
		     "/opt/puppetlabs/puppet/bin/ruby", "/usr/bin/xfce4-session",
		     "/usr/libexec/oddjob/mkhomedir", "/sbin/useradd",
		     "/usr/lib/systemd/systemd", "/usr/sbin/crond", "/usr/bin/pamac-
		     daemon", "/usr/sbin/mkhomedir_helper",
		     "/opt/pbis/sbin/lwsmd", "/usr/sbin/oddjobd"   ) or
		     file.extension in ("swp", "swpx", "swx", "dpkg-remove") or
		     file.Ext.original.extension == "dpkg-new" or
		     process.executable : (     "/nix/store/*", "/var/lib/dpkg/*",
		     "/tmp/vmis.*", "/snap/*", "/dev/fd/*", "/usr/lib/virtualbox/*",
		     "/usr/libexec/platform-python*"   ) or   process.executable ==
		     null or   process.name in ("adclient", "mkhomedir_helper",
		     "teleport", "mkhomedir", "adduser", "desktopDaemon",
		     "executor", "crio") or   (process.name == "sed" and file.name :
		     "sed*") or   (process.name == "perl" and file.name :
		     "e2scrub_all.tmp*") )

NamE: Azure Automation Account Created
	description: 
		     Identifies when an Azure Automation account is
		     created. Azure Automation accounts can be used to automate
		     management tasks and orchestrate actions across systems. An
		     adversary may create an Automation account in order to maintain
		     persistence in their target's environment.
	query: 
		     event.dataset:azure.activitylogs and azure.activitylog
		     s.operation_name:"MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/WRITE
		     " and event.outcome:(Success or success)

NamE: Service Creation via Local Kerberos Authentication
	description: 
		     Identifies a suspicious local successful logon
		     event where the Logon Package is Kerberos, the remote address
		     is set to localhost, followed by a sevice creation from the
		     same LogonId. This may indicate an attempt to leverage a
		     Kerberos relay attack variant that can be used to elevate
		     privilege locally from a domain joined user to local System
		     privileges.
	query: 
		     sequence by winlog.computer_name with maxspan=5m
		     [authentication where    /* event 4624 need to be logged */
		     event.action == "logged-in" and event.outcome == "success" and
		     /* authenticate locally using relayed kerberos Ticket */
		     winlog.event_data.AuthenticationPackageName :"Kerberos" and
		     winlog.logon.type == "Network" and   cidrmatch(source.ip,
		     "127.0.0.0/8", "::1") and source.port > 0] by
		     winlog.event_data.TargetLogonId    [any where    /* event 4697
		     need to be logged */    event.action : "service-installed"] by
		     winlog.event_data.SubjectLogonId

NamE: User Added to Privileged Group
	description: 
		     Identifies a user being added to a privileged
		     group in Active Directory. Privileged accounts and groups in
		     Active Directory are those to which powerful rights,
		     privileges, and permissions are granted that allow them to
		     perform nearly any action in Active Directory and on domain-
		     joined systems.
	query: 
		     iam where winlog.api == "wineventlog" and event.action
		     == "added-member-to-group" and (     (         group.name : (
		     "Admin*",             "Local Administrators",
		     "Domain Admins",             "Enterprise Admins",
		     "Backup Admins",             "Schema Admins",
		     "DnsAdmins",             "Exchange Organization
		     Administrators",             "Print Operators",
		     "Server Operators",             "Account Operators"         )
		     ) or     (         group.id : (             "S-1-5-32-544",
		     "S-1-5-21-*-544",             "S-1-5-21-*-512",
		     "S-1-5-21-*-519",             "S-1-5-21-*-551",
		     "S-1-5-21-*-518",             "S-1-5-21-*-1101",
		     "S-1-5-21-*-1102",             "S-1-5-21-*-550",
		     "S-1-5-21-*-549",             "S-1-5-21-*-548"         )     )
		     )

NamE: Halfbaked Command and Control Beacon
	description: 
		     Halfbaked is a malware family used to establish
		     persistence in a contested network. This rule detects a network
		     activity algorithm leveraged by Halfbaked implant beacons for
		     command and control.
	query: 
		     (event.dataset: (network_traffic.tls OR
		     network_traffic.http) OR   (event.category: (network OR
		     network_traffic) AND network.protocol: http)) AND
		     network.transport:tcp AND url.full:/http:\/\/[0-9]{1,3}.[0-
		     9]{1,3}.[0-9]{1,3}.[0-9]{1,3}\/cd/ AND   destination.port:(53
		     OR 80 OR 8080 OR 443)

NamE: AWS IAM User Created Access Keys For Another User
	description: 
		     An adversary with access to a set of compromised
		     credentials may attempt to persist or escalate privileges by
		     creating a new set of credentials for an existing user. This
		     rule looks for use of the IAM `CreateAccessKey` API operation
		     to create new programmatic access keys for another IAM user.
	query: 
		     from logs-aws.cloudtrail-* metadata _id, _version,
		     _index | where event.provider == "iam.amazonaws.com"     and
		     event.action == "CreateAccessKey"     and event.outcome ==
		     "success"     and user.name != user.target.name | keep
		     @timestamp,     cloud.region,     event.provider,
		     event.action,     event.outcome,     user.name,
		     source.address,     user.target.name,     user_agent.original,
		     aws.cloudtrail.request_parameters,
		     aws.cloudtrail.response_elements,
		     aws.cloudtrail.user_identity.arn,
		     aws.cloudtrail.user_identity.type

NamE: Suspicious Mining Process Creation Event
	description: 
		     Identifies service creation events of common
		     mining services, possibly indicating the infection of a system
		     with a cryptominer.
	query: 
		     file where host.os.type == "linux" and event.type ==
		     "creation" and event.action : ("creation", "file_create_event")
		     and file.name : ("aliyun.service", "moneroocean_miner.service",
		     "c3pool_miner.service", "pnsd.service", "apache4.service",
		     "pastebin.service", "xvf.service")

NamE: Persistence via Docker Shortcut Modification
	description: 
		     An adversary can establish persistence by
		     modifying an existing macOS dock property list in order to
		     execute a malicious application instead of the intended one
		     when invoked.
	query: 
		     event.category:file and host.os.type:macos and
		     event.action:modification and
		     file.path:/Users/*/Library/Preferences/com.apple.dock.plist and
		     not process.name:(xpcproxy or cfprefsd or plutil or jamf or
		     PlistBuddy or InstallerRemotePluginService) and  not
		     process.executable:(/Library/Addigy/download-cache/* or
		     "/Library/Kandji/Kandji Agent.app/Contents/MacOS/kandji-
		     library-manager")

NamE: Google Workspace API Access Granted via Domain-Wide Delegation
	description: 
		     Detects when a domain-wide delegation of
		     authority is granted to a service account. Domain-wide
		     delegation can be configured to grant third-party and internal
		     applications to access the data of Google Workspace users. An
		     adversary may configure domain-wide delegation to maintain
		     access to their target’s data.
	query: 
		     event.dataset:google_workspace.admin   and
		     event.provider:admin   and event.category:iam   and
		     event.action:AUTHORIZE_API_CLIENT_ACCESS   and
		     event.outcome:success

NamE: Bitsadmin Activity
	description: 
		     Windows Background Intelligent Transfer Service
		     (BITS) is a low-bandwidth, asynchronous file transfer
		     mechanism. Adversaries may abuse BITS to persist, download,
		     execute, and even clean up after running malicious code.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (    (process.name : "bitsadmin.exe" and
		     process.args : (         "*Transfer*", "*Create*", "AddFile",
		     "*SetNotifyFlags*", "*SetNotifyCmdLine*",
		     "*SetMinRetryDelay*", "*SetCustomHeaders*", "*Resume*")    ) or
		     (process.name : "powershell.exe" and process.args : (
		     "*Start-BitsTransfer*", "*Add-BitsFile*",         "*Resume-
		     BitsTransfer*", "*Set-BitsTransfer*", "*BITS.Manager*")    )
		     )

NamE: MFA Disabled for Google Workspace Organization
	description: 
		     Detects when multi-factor authentication (MFA)
		     is disabled for a Google Workspace organization. An adversary
		     may attempt to modify a password policy in order to weaken an
		     organization’s security controls.
	query: 
		     event.dataset:google_workspace.admin and
		     event.provider:admin and event.category:iam and
		     event.action:(ENFORCE_STRONG_AUTHENTICATION or
		     ALLOW_STRONG_AUTHENTICATION) and
		     google_workspace.admin.new_value:false

NamE: Potential Reverse Shell via UDP
	description: 
		     This detection rule identifies suspicious
		     network traffic patterns associated with UDP reverse shell
		     activity. This activity consists of a sample of an execve,
		     socket and connect syscall executed by the same process, where
		     the auditd.data.a0-1 indicate a UDP connection, ending with an
		     egress connection event. An attacker may establish a Linux UDP
		     reverse shell to bypass traditional firewall restrictions and
		     gain remote access to a target system covertly.
	query: 
		     sample by host.id, process.pid, process.parent.pid
		     [process where host.os.type == "linux" and event.type ==
		     "start" and event.action == "executed" and process.name : (
		     "bash", "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish",
		     "perl", "python*", "nc", "ncat", "netcat", "php*",     "ruby",
		     "openssl", "awk", "telnet", "lua*", "socat"     )]   [process
		     where host.os.type == "linux" and auditd.data.syscall ==
		     "socket" and process.name : (     "bash", "dash", "sh", "tcsh",
		     "csh", "zsh", "ksh", "fish", "perl", "python*", "nc", "ncat",
		     "netcat", "php*",     "ruby", "openssl", "awk", "telnet",
		     "lua*", "socat"     ) and auditd.data.a1 == "2"]   [network
		     where host.os.type == "linux" and event.type == "start" and
		     event.action == "connected-to" and    process.name : (
		     "bash", "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish",
		     "perl", "python*", "nc", "ncat", "netcat", "php*",     "ruby",
		     "openssl", "awk", "telnet", "lua*", "socat"     ) and
		     network.direction == "egress" and destination.ip != null and
		     not cidrmatch(destination.ip, "127.0.0.0/8", "169.254.0.0/16",
		     "224.0.0.0/4", "::1")]

NamE: Kubernetes Container Created with Excessive Linux Capabilities
	description: 
		     This rule detects a container deployed with one
		     or more dangerously permissive Linux capabilities. An attacker
		     with the ability to deploy a container with added capabilities
		     could use this for further execution, lateral movement, or
		     privilege escalation within a cluster. The capabilities
		     detected in this rule have been used in container escapes to
		     the host machine.
	query: 
		     event.dataset: kubernetes.audit_logs   and kubernetes.
		     audit.annotations.authorization_k8s_io/decision:"allow"   and
		     kubernetes.audit.verb: create   and
		     kubernetes.audit.objectRef.resource: pods   and kubernetes.audi
		     t.requestObject.spec.containers.securityContext.capabilities.ad
		     d: ("BPF" or "DAC_READ_SEARCH"  or "NET_ADMIN" or "SYS_ADMIN"
		     or "SYS_BOOT" or "SYS_MODULE" or "SYS_PTRACE" or "SYS_RAWIO"
		     or "SYSLOG")   and not
		     kubernetes.audit.requestObject.spec.containers.image :
		     ("docker.elastic.co/beats/elastic-agent:8.4.0" or
		     "rancher/klipper-lb:v0.3.5" or "")

NamE: Microsoft 365 Exchange Anti-Phish Policy Deletion
	description: 
		     Identifies the deletion of an anti-phishing
		     policy in Microsoft 365. By default, Microsoft 365 includes
		     built-in features that help protect users from phishing
		     attacks. Anti-phishing polices increase this protection by
		     refining settings to better detect and prevent attacks.
	query: 
		     event.dataset:o365.audit and event.provider:Exchange
		     and event.category:web and event.action:"Remove-
		     AntiPhishPolicy" and event.outcome:success

NamE: Suspicious Process Access via Direct System Call
	description: 
		     Identifies suspicious process access events from
		     an unknown memory region. Endpoint security solutions usually
		     hook userland Windows APIs in order to decide if the code that
		     is being executed is malicious or not. It's possible to bypass
		     hooked functions by writing malicious functions that call
		     syscalls directly.
	query: 
		     process where host.os.type == "windows" and event.code
		     == "10" and  length(winlog.event_data.CallTrace) > 0 and   /*
		     Sysmon CallTrace starting with unknown memory module instead of
		     ntdll which host Windows NT Syscalls */  not
		     winlog.event_data.CallTrace :
		     ("?:\\WINDOWS\\SYSTEM32\\ntdll.dll*",
		     "?:\\WINDOWS\\SysWOW64\\ntdll.dll*",
		     "?:\\Windows\\System32\\wow64cpu.dll*",
		     "?:\\WINDOWS\\System32\\wow64win.dll*",
		     "?:\\Windows\\System32\\win32u.dll*") and   not
		     winlog.event_data.TargetImage :             ("?:\\Program Files
		     (x86)\\Malwarebytes Anti-Exploit\\mbae-svc.exe",
		     "?:\\Program Files\\Cisco\\AMP\\*\\sfc.exe",
		     "?:\\Program Files (x86)\\Microsoft\\EdgeWebView\\Application\\
		     *\\msedgewebview2.exe",              "?:\\Program
		     Files\\Adobe\\Acrobat DC\\Acrobat\\*\\AcroCEF.exe") and   not
		     (process.executable : ("?:\\Program Files\\Adobe\\Acrobat
		     DC\\Acrobat\\Acrobat.exe",
		     "?:\\Program Files (x86)\\World of
		     Warcraft\\_classic_\\WowClassic.exe") and       not
		     winlog.event_data.TargetImage :
		     "?:\\WINDOWS\\system32\\lsass.exe")

NamE: Kernel Driver Load by non-root User
	description: 
		     Detects the loading of a Linux kernel module by
		     a non-root user through system calls. Threat actors may
		     leverage Linux kernel modules to load a rootkit on a system
		     providing them with complete control and the ability to hide
		     from security products. As other rules monitor for the addition
		     of Linux kernel modules through system utilities or .ko files,
		     this rule covers the gap that evasive rootkits leverage by
		     monitoring for kernel module additions on the lowest level
		     through auditd_manager.
	query: 
		     driver where host.os.type == "linux" and event.action
		     == "loaded-kernel-module" and auditd.data.syscall in
		     ("init_module", "finit_module") and user.id != "0"

NamE: Potential LSASS Clone Creation via PssCaptureSnapShot
	description: 
		     Identifies the creation of an LSASS process
		     clone via PssCaptureSnapShot where the parent process is the
		     initial LSASS process instance. This may indicate an attempt to
		     evade detection and dump LSASS memory for credential access.
	query: 
		     process where host.os.type == "windows" and
		     event.code:"4688" and   process.executable :
		     "?:\\Windows\\System32\\lsass.exe" and
		     process.parent.executable : "?:\\Windows\\System32\\lsass.exe"

NamE: GCP Firewall Rule Modification
	description: 
		     Identifies when a firewall rule is modified in
		     Google Cloud Platform (GCP) for Virtual Private Cloud (VPC) or
		     App Engine. These firewall rules can be modified to allow or
		     deny connections to or from virtual machine (VM) instances or
		     specific applications. An adversary may modify an existing
		     firewall rule in order to weaken their target's security
		     controls and allow more permissive ingress or egress traffic
		     flows for their benefit.
	query: 
		     event.dataset:gcp.audit and
		     event.action:(*.compute.firewalls.patch or
		     google.appengine.*.Firewall.Update*Rule)

NamE: O365 Exchange Suspicious Mailbox Right Delegation
	description: 
		     Identifies the assignment of rights to access
		     content from another mailbox. An adversary may use the
		     compromised account to send messages to other accounts in the
		     network of the target organization while creating inbox rules,
		     so messages can evade spam/phishing detection mechanisms.
	query: 
		     event.dataset:o365.audit and event.provider:Exchange
		     and event.action:Add-MailboxPermission and
		     o365.audit.Parameters.AccessRights:(FullAccess or SendAs or
		     SendOnBehalf) and event.outcome:success and not user.id : "NT
		     AUTHORITY\SYSTEM (Microsoft.Exchange.Servicehost)"

NamE: Potential Execution via XZBackdoor
	description: 
		     It identifies potential malicious shell
		     executions through remote SSH and detects cases where the sshd
		     service suddenly terminates soon after successful execution,
		     suggesting suspicious behavior similar to the XZ backdoor.
	query: 
		     sequence by host.id, user.id with maxspan=1s  [process
		     where host.os.type == "linux" and event.type == "start" and
		     event.action == "exec" and process.name == "sshd" and
		     process.args == "-D" and process.args == "-R"] by process.pid,
		     process.entity_id  [process where host.os.type == "linux" and
		     event.type == "start" and event.action == "exec" and
		     process.parent.name == "sshd" and   process.executable != null
		     and not (     process.executable in ("/usr/sbin/sshd",
		     "/usr/sbin/unix_chkpwd", "/usr/bin/google_authorized_keys",
		     "/usr/bin/fipscheck") or     process.args like ("rsync*",
		     "systemctl*", "/usr/sbin/unix_chkpwd",
		     "/usr/bin/google_authorized_keys",
		     "/usr/sbin/aad_certhandler*") or     process.command_line like
		     "sh -c /usr/bin/env -i PATH=*"   )] by process.parent.pid,
		     process.parent.entity_id  [process where host.os.type ==
		     "linux" and event.action == "end" and process.name == "sshd"
		     and process.exit_code != 0] by process.pid, process.entity_id
		     [network where host.os.type == "linux" and event.type == "end"
		     and event.action == "disconnect_received" and process.name ==
		     "sshd"] by process.pid, process.entity_id

NamE: Potential Masquerading as VLC DLL
	description: 
		     Identifies instances of VLC-related DLLs which
		     are not signed by the original developer. Attackers may name
		     their payload as legitimate applications to blend into the
		     environment, or embedding its malicious code within legitimate
		     applications to deceive machine learning algorithms by
		     incorporating authentic and benign code.
	query: 
		     library where host.os.type == "windows" and
		     event.action == "load" and   dll.name : ("libvlc.dll",
		     "libvlccore.dll", "axvlc.dll") and   not (
		     dll.code_signature.subject_name : ("VideoLAN",
		     "716F2E5E-A03A-486B-BC67-9B18474B9D51")     and
		     dll.code_signature.trusted == true   )

NamE: Local Account TokenFilter Policy Disabled
	description: 
		     Identifies registry modification to the
		     LocalAccountTokenFilterPolicy policy. If this value exists
		     (which doesn't by default) and is set to 1, then remote
		     connections from all local members of Administrators are
		     granted full high-integrity tokens during negotiation.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.value :
		     "LocalAccountTokenFilterPolicy" and   registry.path : (
		     "HKLM\\*\\LocalAccountTokenFilterPolicy",
		     "\\REGISTRY\\MACHINE\\*\\LocalAccountTokenFilterPolicy",
		     "MACHINE\\*\\LocalAccountTokenFilterPolicy"   ) and
		     registry.data.strings : ("1", "0x00000001")

NamE: Unusual Instance Metadata Service (IMDS) API Request
	description: 
		     This rule identifies potentially malicious
		     processes attempting to access the cloud service provider's
		     instance metadata service (IMDS) API endpoint, which can be
		     used to retrieve sensitive instance-specific information such
		     as instance ID, public IP address, and even temporary security
		     credentials if role's are assumed by that instance. The rule
		     monitors for various tools and scripts like curl, wget, python,
		     and perl that might be used to interact with the metadata API.
	query: 
		     sequence by host.id,  process.parent.entity_id with
		     maxspan=1s [process where host.os.type == "linux" and
		     event.type == "start" and event.action == "exec" and
		     process.parent.executable != null and   (   process.name : (
		     "curl", "wget", "python*", "perl*", "php*", "ruby*", "lua*",
		     "telnet", "pwsh",     "openssl", "nc", "ncat", "netcat", "awk",
		     "gawk", "mawk", "nawk", "socat", "node"     ) or
		     process.executable : (       "./*", "/tmp/*", "/var/tmp/*",
		     "/var/www/*", "/dev/shm/*", "/etc/init.d/*", "/etc/rc*.d/*",
		     "/etc/cron*", "/etc/update-motd.d/*", "/boot/*", "/srv/*",
		     "/run/*", "/etc/rc.local"     ) or   process.command_line:
		     "*169.254.169.254*"    )     and not process.working_directory:
		     (           "/opt/rapid7*",           "/opt/nessus*",
		     "/snap/amazon-ssm-agent*",           "/var/snap/amazon-ssm-
		     agent/*",           "/var/log/amazon/ssm/*",
		     "/srv/snp/docker/overlay2*",
		     "/opt/nessus_agent/var/nessus/*")    and not
		     process.executable: (           "/opt/rumble/bin/rumble-
		     agent*",           "/opt/aws/inspector/bin/inspectorssmplugin",
		     "/snap/oracle-cloud-agent/*",           "/lusr/libexec/oracle-
		     cloud-agent/*")    and not process.parent.executable: (
		     "/usr/bin/setup-policy-routes",
		     "/usr/share/ec2-instance-connect/*",
		     "/var/lib/amazon/ssm/*",            "/etc/update-
		     motd.d/30-banner",            "/usr/sbin/dhclient-script",
		     "/usr/local/bin/uwsgi",            "/usr/lib/skylight/al-
		     extras") ] [network where host.os.type == "linux" and
		     event.action == "connection_attempted" and destination.ip ==
		     "169.254.169.254"]

NamE: Network Activity Detected via cat
	description: 
		     This rule monitors for the execution of the cat
		     command, followed by a connection attempt by the same process.
		     Cat is capable of transfering data via tcp/udp channels by
		     redirecting its read output to a /dev/tcp or /dev/udp channel.
		     This activity is highly suspicious, and should be investigated.
		     Attackers may leverage this capability to transfer tools or
		     files to another host in the network or exfiltrate data while
		     attempting to evade detection in the process.
	query: 
		     sequence by host.id, process.entity_id with maxspan=1s
		     [process where host.os.type == "linux" and event.type ==
		     "start" and event.action == "exec" and    process.name == "cat"
		     and process.parent.name in ("bash", "dash", "sh", "tcsh",
		     "csh", "zsh", "ksh", "fish")]   [network where host.os.type ==
		     "linux" and event.action in ("connection_attempted",
		     "disconnect_received") and    process.name == "cat" and not
		     (destination.ip == null or destination.ip == "0.0.0.0" or
		     cidrmatch(      destination.ip, "10.0.0.0/8", "127.0.0.0/8",
		     "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24",
		     "192.0.0.0/29",      "192.0.0.8/32", "192.0.0.9/32",
		     "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32",
		     "192.0.2.0/24",      "192.31.196.0/24", "192.52.193.0/24",
		     "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4",
		     "100.64.0.0/10",      "192.175.48.0/24","198.18.0.0/15",
		     "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1",
		     "FE80::/10",      "FF00::/8"      )    )]

NamE: Potential Admin Group Account Addition
	description: 
		     Identifies attempts to add an account to the
		     admin group via the command line. This could be an indication
		     of privilege escalation activity.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:(start or process_started) and  process.name:(dscl
		     or dseditgroup) and process.args:(("/Groups/admin" or admin)
		     and ("-a" or "-append")) and  not
		     process.Ext.effective_parent.executable :
		     ("/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/Jam
		     fDaemon.app/Contents/MacOS/JamfDaemon" or
		     "/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/Jamf
		     ManagementService.app/Contents/MacOS/JamfManagementService" or
		     "/opt/jc/bin/jumpcloud-agent" or
		     "/Library/Addigy/go-agent")

NamE: File with Right-to-Left Override Character (RTLO) Created/Executed
	description: 
		     Identifies the creation or execution of files or
		     processes with names containing the Right-to-Left Override
		     (RTLO) character, which can be used to disguise the file
		     extension and trick users into executing malicious files.
	query: 
		     any where host.os.type == "windows" and event.category
		     in ("file", "process") and    (     (event.type == "creation"
		     and file.path : "*\u{202E}*") or      (event.type == "start"
		     and process.name : "*\u{202E}*")   )

NamE: Windows System Information Discovery
	description: 
		     Detects the execution of commands used to
		     discover information about the system, which attackers may use
		     after compromising a system to gain situational awareness.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and (   (     process.name : "cmd.exe" and
		     process.args : "ver*" and not     process.parent.executable : (
		     "?:\\Users\\*\\AppData\\Local\\Keybase\\upd.exe",
		     "?:\\Users\\*\\python*.exe"     )   ) or    process.name :
		     ("systeminfo.exe", "hostname.exe") or    (process.name :
		     "wmic.exe" and process.args : "os" and process.args : "get") )
		     and not process.parent.executable : (     "?:\\Program
		     Files\\*",     "?:\\Program Files (x86)\\*",
		     "?:\\ProgramData\\*" ) and not user.id : "S-1-5-18"

NamE: UAC Bypass Attempt via Elevated COM Internet Explorer Add-On Installer
	description: 
		     Identifies User Account Control (UAC) bypass
		     attempts by abusing an elevated COM Interface to launch a
		     malicious program. Attackers may attempt to bypass UAC to
		     stealthily execute code with elevated permissions.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  process.executable :
		     "C:\\*\\AppData\\*\\Temp\\IDC*.tmp\\*.exe" and
		     process.parent.name : "ieinstal.exe" and process.parent.args :
		     "-Embedding"   /* uncomment once in winlogbeat */  /* and not
		     (process.code_signature.subject_name == "Microsoft Corporation"
		     and process.code_signature.trusted == true) */

NamE: Potential Hex Payload Execution
	description: 
		     This rule detects potential hex payload
		     execution on Linux systems. Adversaries may use hex encoding to
		     obfuscate payloads and evade detection mechanisms.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2") and   (     (process.name == "xxd"
		     and process.args like ("-r*", "-p*")) or     (process.name like
		     "python*" and process.command_line like "*fromhex*" and
		     process.command_line like ("*decode*", "*encode*")) or
		     (process.name like "php*" and process.command_line like
		     "*hex2bin*") or     (process.name like "ruby*" and
		     process.command_line like "*].pack(\"H*\")*") or
		     (process.name like "perl*" and process.command_line like
		     "*pack(\"H*\",*") or     (process.name like "lua*" and
		     process.command_line like "*tonumber(cc, 16)*")   )

NamE: Potential Kerberos Attack via Bifrost
	description: 
		     Identifies use of Bifrost, a known macOS
		     Kerberos pentesting tool, which can be used to dump cached
		     Kerberos tickets or attempt unauthorized authentication
		     techniques such as pass-the-ticket/hash and kerberoasting.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:start and  process.args:("-action" and
		     ("-kerberoast" or askhash or asktgs or asktgt or s4u or
		     ("-ticket" and ptt) or (dump and (tickets or keytab))))

NamE: System Log File Deletion
	description: 
		     Identifies the deletion of sensitive Linux
		     system logs. This may indicate an attempt to evade detection or
		     destroy forensic evidence on a system.
	query: 
		     file where host.os.type == "linux" and event.type ==
		     "deletion" and   file.path :     (     "/var/run/utmp",
		     "/var/log/wtmp",     "/var/log/btmp",     "/var/log/lastlog",
		     "/var/log/faillog",     "/var/log/syslog",
		     "/var/log/messages",     "/var/log/secure",
		     "/var/log/auth.log",     "/var/log/boot.log",
		     "/var/log/kern.log",     "/var/log/dmesg"     ) and     not
		     process.name in ("gzip", "executor", "dockerd")

NamE: Okta User Sessions Started from Different Geolocations
	description: 
		     Detects when a specific Okta actor has multiple
		     sessions started from different geolocations. Adversaries may
		     attempt to launch an attack by using a list of known usernames
		     and passwords to gain unauthorized access to user accounts from
		     different locations.
	query: 
		     FROM logs-okta* | WHERE     event.dataset ==
		     "okta.system"     AND (event.action RLIKE
		     "user\\.authentication(.*)" OR event.action ==
		     "user.session.start")     AND okta.security_context.is_proxy !=
		     true and okta.actor.id != "unknown"     AND event.outcome ==
		     "success" | KEEP event.action, okta.security_context.is_proxy,
		     okta.actor.id, event.outcome, client.geo.country_name,
		     okta.actor.alternate_id | STATS     geo_auth_counts =
		     COUNT_DISTINCT(client.geo.country_name)     BY okta.actor.id,
		     okta.actor.alternate_id | WHERE     geo_auth_counts >= 2

NamE: Unauthorized Scope for Public App OAuth2 Token Grant with Client Credentials
	description: 
		     Identifies a failed OAuth 2.0 token grant
		     attempt for a public client app using client credentials. This
		     event is generated when a public client app attempts to
		     exchange a client credentials grant for an OAuth 2.0 access
		     token, but the request is denied due to the lack of required
		     scopes. This could indicate compromised client credentials in
		     which an adversary is attempting to obtain an access token for
		     unauthorized scopes. This is a [New
		     Terms](https://www.elastic.co/guide/en/security/current/rules-
		     ui-create.html#create-new-terms-rule) rule where the
		     `okta.actor.display_name` field value has not been seen in the
		     last 14 days regarding this event.
	query: 
		     event.dataset: okta.system     and event.action:
		     "app.oauth2.as.token.grant"     and okta.actor.type:
		     "PublicClientApp"     and
		     okta.debug_context.debug_data.flattened.grantType:
		     "client_credentials"     and okta.outcome.result: "FAILURE"
		     and not okta.client.user_agent.raw_user_agent: "Okta-
		     Integrations"     and not okta.actor.display_name: (Okta* or
		     Datadog)     and not
		     okta.debug_context.debug_data.flattened.requestedScopes:
		     ("okta.logs.read" or "okta.eventHooks.read" or
		     "okta.inlineHooks.read")     and okta.outcome.reason:
		     "no_matching_scope"

NamE: First Occurrence GitHub Event for a Personal Access Token (PAT)
	description: 
		     Detects a first occurrence event for a personal
		     access token (PAT) not seen in the last 14 days.
	query: 
		     event.dataset:"github.audit" and
		     event.category:"configuration" and event.action:* and
		     github.hashed_token:* and
		     github.programmatic_access_type:("OAuth access token" or "Fine-
		     grained personal access token")

NamE: Process Capability Set via setcap Utility
	description: 
		     This rule detects the use of the setcap utility
		     to set capabilities on a process. The setcap utility is used to
		     set the capabilities of a binary to allow it to perform
		     privileged operations without needing to run as root. This can
		     be used by attackers to establish persistence by creating a
		     backdoor, or escalate privileges by abusing a misconfiguration
		     on a system.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start")
		     and process.name == "setcap" and not (
		     process.parent.executable == null or
		     process.parent.executable : ("/var/lib/dpkg/*",
		     "/var/lib/docker/*", "/tmp/newroot/*", "/var/tmp/newroot/*") or
		     process.parent.name in ("jem", "vzctl") )

NamE: Suspicious Memory grep Activity
	description: 
		     Monitors for grep activity related to memory
		     mapping. The /proc/*/maps file in Linux provides a memory map
		     for a specific process, detailing the memory segments,
		     permissions, and what files are mapped to these segments.
		     Attackers may read a process's memory map to identify memory
		     addresses for code injection or process hijacking.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2") and   process.name in ("grep",
		     "egrep", "fgrep", "rgrep") and process.args in ("[stack]",
		     "[vdso]", "[heap]")

NamE: Keychain Password Retrieval via Command Line
	description: 
		     Adversaries may collect keychain storage data
		     from a system to in order to acquire credentials. Keychains are
		     the built-in way for macOS to keep track of users' passwords
		     and credentials for many services and features, including Wi-Fi
		     and website passwords, secure notes, certificates, and
		     Kerberos.
	query: 
		     process where host.os.type == "macos" and event.action
		     == "exec" and  process.name : "security" and  process.args :
		     ("-wa", "-ga") and process.args : ("find-generic-password",
		     "find-internet-password") and  process.command_line :
		     ("*Chrome*", "*Chromium*", "*Opera*", "*Safari*", "*Brave*",
		     "*Microsoft Edge*", "*Firefox*") and  not
		     process.parent.executable : "/Applications/Keeper Password
		     Manager.app/Contents/Frameworks/Keeper Password Manager
		     Helper*/Contents/MacOS/Keeper Password Manager Helper*"

NamE: Possible Okta DoS Attack
	description: 
		     Detects possible Denial of Service (DoS) attacks
		     against an Okta organization. An adversary may attempt to
		     disrupt an organization's business operations by performing a
		     DoS attack against its Okta service.
	query: 
		     event.dataset:okta.system and event.action:(applicatio
		     n.integration.rate_limit_exceeded or
		     system.org.rate_limit.warning or
		     system.org.rate_limit.violation or
		     core.concurrency.org.limit.violation)

NamE: MacOS Installer Package Spawns Network Event
	description: 
		     Detects the execution of a MacOS installer
		     package with an abnormal child process (e.g bash) followed
		     immediately by a network connection via a suspicious process
		     (e.g curl). Threat actors will build and distribute malicious
		     MacOS installer packages, which have a .pkg extension, many
		     times imitating valid software in order to persuade and infect
		     their victims often using the package files (e.g pre/post
		     install scripts etc.) to download additional tools or malicious
		     software. If this rule fires it should indicate the
		     installation of a malicious or suspicious package.
	query: 
		     sequence by host.id with maxspan=15s [process where
		     host.os.type == "macos" and event.type == "start" and
		     event.action == "exec" and process.parent.name : ("installer",
		     "package_script_service") and process.name : ("bash", "sh",
		     "zsh", "python", "osascript", "tclsh*")] by process.entity_id
		     [network where host.os.type == "macos" and event.type ==
		     "start" and process.name : ("curl", "osascript", "wget",
		     "python", "java", "ruby", "node")] by process.parent.entity_id

NamE: Enumeration of Administrator Accounts
	description: 
		     Identifies instances of lower privilege accounts
		     enumerating Administrator accounts or groups using built-in
		     Windows tools.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and (   (     (       (process.name : "net.exe" or
		     ?process.pe.original_file_name == "net.exe") or
		     ((process.name : "net1.exe" or ?process.pe.original_file_name
		     == "net1.exe") and not process.parent.name : "net.exe")     )
		     and     process.args : ("group", "user", "localgroup") and
		     process.args : ("*admin*", "Domain Admins", "Remote Desktop
		     Users", "Enterprise Admins", "Organization Management")     and
		     not process.args : ("/add", "/delete")   ) or   (
		     (process.name : "wmic.exe" or ?process.pe.original_file_name ==
		     "wmic.exe") and     process.args : ("group", "useraccount")   )
		     ) and not user.id : ("S-1-5-18", "S-1-5-19", "S-1-5-20")

NamE: Potential Shell via Wildcard Injection Detected
	description: 
		     This rule monitors for the execution of a set of
		     linux binaries, that are potentially vulnerable to wildcard
		     injection, with suspicious command line flags followed by a
		     shell spawn event. Linux wildcard injection is a type of
		     security vulnerability where attackers manipulate commands or
		     input containing wildcards (e.g., *, ?, []) to execute
		     unintended operations or access sensitive data by tricking the
		     system into interpreting the wildcard characters in unexpected
		     ways.
	query: 
		     sequence by host.id with maxspan=1s   [process where
		     host.os.type == "linux" and event.type == "start" and
		     event.action in ("exec", "start") and (     (process.name ==
		     "tar" and process.args : "--checkpoint=*" and process.args : "
		     --checkpoint-action=*") or     (process.name == "rsync" and
		     process.args : "-e*") or     (process.name == "zip" and
		     process.args == "--unzip-command")    ) and not
		     process.executable : "/tmp/newroot/*"   ]  by process.entity_id
		     [process where host.os.type == "linux" and event.type ==
		     "start" and event.action in ("exec", "start") and
		     process.parent.name : ("tar", "rsync", "zip") and
		     process.name : ("bash", "dash", "sh", "tcsh", "csh", "zsh",
		     "ksh", "fish")   ] by process.parent.entity_id

NamE: Potential Disabling of AppArmor
	description: 
		     This rule monitors for potential attempts to
		     disable AppArmor. AppArmor is a Linux security module that
		     enforces fine-grained access control policies to restrict the
		     actions and resources that specific applications and processes
		     can access. Adversaries may disable security tools to avoid
		     possible detection of their tools and activities.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and  event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed", "process_started") and  (
		     (process.name == "systemctl" and process.args in ("stop",
		     "disable", "kill") and process.args in ("apparmor",
		     "apparmor.service")) or   (process.name == "service" and
		     process.args == "apparmor" and process.args == "stop") or
		     (process.name == "chkconfig" and process.args == "apparmor" and
		     process.args == "off") or   (process.name == "ln" and
		     process.args : "/etc/apparmor.d/*" and process.args ==
		     "/etc/apparmor.d/disable/") )

NamE: LSASS Memory Dump Creation
	description: 
		     Identifies the creation of a Local Security
		     Authority Subsystem Service (lsass.exe) default memory dump.
		     This may indicate a credential access attempt via trusted
		     system utilities such as Task Manager (taskmgr.exe) and SQL
		     Dumper (sqldumper.exe) or known pentesting tools such as
		     Dumpert and AndrewSpecial.
	query: 
		     file where host.os.type == "windows" and event.action
		     != "deletion" and   file.name : ("lsass*.dmp", "dumpert.dmp",
		     "Andrew.dmp", "SQLDmpr*.mdmp", "Coredump.dmp") and    not (
		     process.executable : (           "?:\\Program Files\\Microsoft
		     SQL Server\\*\\Shared\\SqlDumper.exe",           "?:\\Program
		     Files\\Microsoft SQL Server Reporting
		     Services\\SSRS\\ReportServer\\bin\\SqlDumper.exe",
		     "?:\\Windows\\System32\\dllhost.exe"         ) and
		     file.path : (           "?:\\*\\Reporting
		     Services\\Logfiles\\SQLDmpr*.mdmp",           "?:\\Program
		     Files\\Microsoft SQL Server Reporting
		     Services\\SSRS\\Logfiles\\SQLDmpr*.mdmp",
		     "?:\\Program Files\\Microsoft SQL
		     Server\\*\\Shared\\ErrorDumps\\SQLDmpr*.mdmp",
		     "?:\\Program Files\\Microsoft SQL
		     Server\\*\\MSSQL\\LOG\\SQLDmpr*.mdmp"         )       ) and
		     not (         process.executable : (
		     "?:\\Windows\\system32\\WerFault.exe",
		     "?:\\Windows\\System32\\WerFaultSecure.exe"           ) and
		     file.path : (           "?:\\Windows\\System32\\config\\systemp
		     rofile\\AppData\\Local\\CrashDumps\\lsass.exe.*.dmp",
		     "?:\\Windows\\System32\\%LOCALAPPDATA%\\CrashDumps\\lsass.exe.*
		     .dmp"         )   )

NamE: Suspicious pbpaste High Volume Activity
	description: 
		     Identifies a high volume of `pbpaste`
		     executions, which may indicate a bash loop continuously
		     collecting clipboard contents, potentially allowing an attacker
		     to harvest user credentials or other sensitive information.
	query: 
		     sequence by host.hostname, host.id with maxspan=1m
		     [process where host.os.type == "macos" and event.type ==
		     "start" and event.action == "exec" and process.name: "pbpaste"]
		     with runs = 5

NamE: Printer User (lp) Shell Execution
	description: 
		     This detection rule addresses multiple
		     vulnerabilities in the CUPS printing system, including
		     CVE-2024-47176, CVE-2024-47076, CVE-2024-47175, and
		     CVE-2024-47177. Specifically, this rule detects shell
		     executions from the foomatic-rip parent process through the
		     default printer user (lp). These flaws impact components like
		     cups-browsed, libcupsfilters, libppd, and foomatic-rip,
		     allowing remote unauthenticated attackers to manipulate IPP
		     URLs or inject malicious data through crafted UDP packets or
		     network spoofing. This can result in arbitrary command
		     execution when a print job is initiated.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event") and
		     user.name == "lp" and   process.parent.name in ("cupsd",
		     "foomatic-rip", "bash", "dash", "sh", "tcsh", "csh", "zsh",
		     "ksh", "fish") and   process.name in ("bash", "dash", "sh",
		     "tcsh", "csh", "zsh", "ksh", "fish") and not (
		     process.command_line like (       "*/tmp/foomatic-*",
		     "*-sDEVICE=ps2write*", "*printf*", "/bin/sh -e -c cat",
		     "/bin/bash -c cat",       "/bin/bash -e -c cat"     ) or
		     process.args like "gs*"   )

NamE: Uncommon Destination Port Connection by Web Server
	description: 
		     This rule identifies unusual destination port
		     network activity originating from a web server process. The
		     rule is designed to detect potential web shell activity or
		     unauthorized communication from a web server process to
		     external systems.
	query: 
		     network where host.os.type == "linux" and event.type
		     == "start" and event.action == "connection_attempted" and (
		     user.name in (       "apache", "www-data", "httpd", "nginx",
		     "lighttpd", "tomcat", "tomcat8", "tomcat9", "ftp", "ftpuser",
		     "ftpd"      ) or      user.id in ("99", "33", "498", "48")    )
		     and (    process.name in (     "apache", "nginx", "apache2",
		     "httpd", "lighttpd", "caddy", "node", "mongrel_rails", "java",
		     "gunicorn",     "uwsgi", "openresty", "cherokee", "h2o",
		     "resin", "puma", "unicorn", "traefik", "tornado", "hypercorn",
		     "daphne", "twistd", "yaws", "webfsd", "httpd.worker", "flask",
		     "rails", "mongrel"   ) or     process.name like ("php-*",
		     "python*", "ruby*", "perl*") ) and network.direction ==
		     "egress" and destination.ip != null and not destination.port in
		     (80, 443, 8080, 8443, 8000, 8888, 3128, 3306) and not
		     cidrmatch(destination.ip, "127.0.0.0/8", "::1","FE80::/10",
		     "FF00::/8")  /*  This rule does not exclude local IP ranges by
		     default. To exclude these, use the following exclusion
		     statement: cidrmatch(destination.ip, "10.0.0.0/8",
		     "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24",
		     "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32",
		     "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32",
		     "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24",
		     "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4",
		     "100.64.0.0/10", "192.175.48.0/24","198.18.0.0/15",
		     "198.51.100.0/24", "203.0.113.0/24", "224.0.0.0/4",
		     "240.0.0.0/4") */

NamE: DNS Global Query Block List Modified or Disabled
	description: 
		     Identifies changes to the DNS Global Query Block
		     List (GQBL), a security feature that prevents the resolution of
		     certain DNS names often exploited in attacks like WPAD
		     spoofing. Attackers with certain privileges, such as DNSAdmins,
		     can modify or disable the GQBL, allowing exploitation of hosts
		     running WPAD with default settings for privilege escalation and
		     lateral movement.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and (   (registry.value :
		     "EnableGlobalQueryBlockList" and registry.data.strings : ("0",
		     "0x00000000")) or   (registry.value : "GlobalQueryBlockList"
		     and not registry.data.strings : "wpad") )

NamE: Port Forwarding Rule Addition
	description: 
		     Identifies the creation of a new port forwarding
		     rule. An adversary may abuse this technique to bypass network
		     segmentation restrictions.
	query: 
		     registry where host.os.type == "windows" and
		     registry.path : (
		     "HKLM\\SYSTEM\\*ControlSet*\\Services\\PortProxy\\v4tov4\\*",
		     "\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Services\\PortProxy
		     \\v4tov4\\*",
		     "MACHINE\\SYSTEM\\*ControlSet*\\Services\\PortProxy\\v4tov4\\*"
		     )

NamE: First Occurrence of GitHub Repo Interaction From a New IP
	description: 
		     Detects an interaction with a private GitHub
		     repository from a new IP address not seen in the last 14 days.
	query: 
		     event.dataset:"github.audit" and
		     event.category:"configuration" and github.actor_ip:* and
		     github.repo:* and  github.repository_public:false

NamE: Potential Remote File Execution via MSIEXEC
	description: 
		     Identifies the execution of the built-in Windows
		     Installer, msiexec.exe, to install a remote package.
		     Adversaries may abuse msiexec.exe to launch local or network
		     accessible MSI files.
	query: 
		     sequence with maxspan=1m  [process where host.os.type
		     == "windows" and event.action == "start" and     process.name :
		     "msiexec.exe" and process.args : "/V"] by process.entity_id
		     [network where host.os.type == "windows" and process.name :
		     "msiexec.exe" and     event.action == "connection_attempted"]
		     by process.entity_id  [process where host.os.type == "windows"
		     and event.action == "start" and   process.parent.name :
		     "msiexec.exe" and user.id : ("S-1-5-21-*", "S-1-5-12-1-*") and
		     not process.executable : ("?:\\Windows\\SysWOW64\\msiexec.exe",
		     "?:\\Windows\\System32\\msiexec.exe",
		     "?:\\Windows\\System32\\srtasks.exe",
		     "?:\\Windows\\SysWOW64\\srtasks.exe",
		     "?:\\Windows\\System32\\taskkill.exe",
		     "?:\\Windows\\Installer\\MSI*.tmp",
		     "?:\\Program Files\\*.exe",
		     "?:\\Program Files (x86)\\*.exe",
		     "?:\\Windows\\System32\\ie4uinit.exe",
		     "?:\\Windows\\SysWOW64\\ie4uinit.exe",
		     "?:\\Windows\\System32\\sc.exe",
		     "?:\\Windows\\system32\\Wbem\\mofcomp.exe",
		     "?:\\Windows\\twain_32\\fjscan32\\SOP\\crtdmprc.exe",
		     "?:\\Windows\\SysWOW64\\taskkill.exe",
		     "?:\\Windows\\SysWOW64\\schtasks.exe",
		     "?:\\Windows\\system32\\schtasks.exe",
		     "?:\\Windows\\System32\\sdbinst.exe") and   not
		     (process.code_signature.subject_name == "Citrix Systems, Inc."
		     and process.code_signature.trusted == true) and   not
		     (process.name : ("regsvr32.exe", "powershell.exe",
		     "rundll32.exe", "wscript.exe") and
		     process.Ext.token.integrity_level_name == "high" and
		     process.args : ("?:\\Program Files\\*", "?:\\Program Files
		     (x86)\\*")) and   not (process.executable : ("?:\\Program
		     Files\\*.exe", "?:\\Program Files (x86)\\*.exe") and
		     process.code_signature.trusted == true) and   not (process.name
		     : "rundll32.exe" and process.args : "printui.dll,PrintUIEntry")
		     ] by process.parent.entity_id

NamE: Windows Script Interpreter Executing Process via WMI
	description: 
		     Identifies use of the built-in Windows script
		     interpreters (cscript.exe or wscript.exe) being used to execute
		     a process via Windows Management Instrumentation (WMI). This
		     may be indicative of malicious activity.
	query: 
		     sequence by host.id with maxspan = 5s     [any where
		     host.os.type == "windows" and      (event.category :
		     ("library", "driver") or (event.category == "process" and
		     event.action : "Image loaded*")) and      (?dll.name :
		     "wmiutils.dll" or file.name : "wmiutils.dll") and process.name
		     : ("wscript.exe", "cscript.exe")]     [process where
		     host.os.type == "windows" and event.type == "start" and
		     process.parent.name : "wmiprvse.exe" and      user.domain !=
		     "NT AUTHORITY" and      (process.pe.original_file_name :
		     (           "cscript.exe",           "wscript.exe",
		     "PowerShell.EXE",           "Cmd.Exe",           "MSHTA.EXE",
		     "RUNDLL32.EXE",           "REGSVR32.EXE",
		     "MSBuild.exe",           "InstallUtil.exe",
		     "RegAsm.exe",           "RegSvcs.exe",           "msxsl.exe",
		     "CONTROL.EXE",           "EXPLORER.EXE",
		     "Microsoft.Workflow.Compiler.exe",           "msiexec.exe"
		     ) or       process.executable : ("C:\\Users\\*.exe",
		     "C:\\ProgramData\\*.exe")      )     ]

NamE: WDAC Policy File by an Unusual Process
	description: 
		     Identifies the creation of a Windows Defender
		     Application Control (WDAC) policy file by an unusual process.
		     Adversaries may use a secially crafted WDAC policy to restrict
		     the execution of security products.
	query: 
		     file where host.os.type == "windows" and event.action
		     != "deletion" and  file.path :
		     ("?:\\Windows\\System32\\CodeIntegrity\\*.p7b", "?:\\Windows\\S
		     ystem32\\CodeIntegrity\\CiPolicies\\Active\\*.cip") and  not
		     process.executable : "C:\\Windows\\System32\\poqexec.exe"

NamE: Unusual Process Network Connection
	description: 
		     Identifies network activity from unexpected
		     system applications. This may indicate adversarial activity as
		     these applications are often leveraged by adversaries to
		     execute code and evade detection.
	query: 
		     sequence by process.entity_id   [process where
		     host.os.type == "windows" and (process.name :
		     "Microsoft.Workflow.Compiler.exe" or
		     process.name : "bginfo.exe" or                   process.name :
		     "cdb.exe" or                   process.name : "cmstp.exe" or
		     process.name : "csi.exe" or                   process.name :
		     "dnx.exe" or                   process.name : "fsi.exe" or
		     process.name : "ieexec.exe" or                   process.name :
		     "iexpress.exe" or                   process.name :
		     "odbcconf.exe" or                   process.name : "rcsi.exe"
		     or                   process.name : "xwizard.exe") and
		     event.type == "start"]   [network where host.os.type ==
		     "windows" and (process.name : "Microsoft.Workflow.Compiler.exe"
		     or                   process.name : "bginfo.exe" or
		     process.name : "cdb.exe" or                   process.name :
		     "cmstp.exe" or                   process.name : "csi.exe" or
		     process.name : "dnx.exe" or                   process.name :
		     "fsi.exe" or                   process.name : "ieexec.exe" or
		     process.name : "iexpress.exe" or                   process.name
		     : "odbcconf.exe" or                   process.name : "rcsi.exe"
		     or                   process.name : "xwizard.exe")]

NamE: Component Object Model Hijacking
	description: 
		     Identifies Component Object Model (COM)
		     hijacking via registry modification. Adversaries may establish
		     persistence by executing malicious content triggered by
		     hijacked references to COM objects.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   /* not necessary but good for
		     filtering privileged installations */   user.domain != "NT
		     AUTHORITY" and process.executable != null and    (     (
		     registry.path : "HK*\\InprocServer32\\" and
		     registry.data.strings: ("scrobj.dll", "?:\\*\\scrobj.dll") and
		     not registry.path :
		     "*\\{06290BD*-48AA-11D2-8432-006008C3FBFC}\\*"     ) or      (
		     registry.path : "HKLM\\*\\InProcServer32\\*" and
		     registry.data.strings : ("*\\Users\\*", "*\\ProgramData\\*")
		     ) or      /* in general COM Registry changes on Users Hive is
		     less noisy and worth alerting */     (       registry.path : (
		     "HKEY_USERS\\*\\InprocServer32\\",
		     "HKEY_USERS\\*\\LocalServer32\\",
		     "HKEY_USERS\\*\\DelegateExecute",
		     "HKEY_USERS\\*\\TreatAs\\",
		     "HKEY_USERS\\*\\ScriptletURL*"       )       )   ) and
		     not  (             process.code_signature.trusted == true and
		     process.code_signature.subject_name in
		     ("Island Technology Inc.", "Google LLC", "Grammarly, Inc.",
		     "Dropbox, Inc", "REFINITIV US LLC", "HP Inc.",
		     "Citrix Systems, Inc.", "Adobe Inc.", "Veeam Software Group
		     GmbH", "Zhuhai Kingsoft Office Software Co., Ltd.",
		     "Oracle America, Inc.")         ) and     /* excludes Microsoft
		     signed noisy processes */   not   (     process.name :
		     ("OneDrive.exe", "OneDriveSetup.exe", "FileSyncConfig.exe",
		     "Teams.exe", "MicrosoftEdgeUpdate.exe", "msrdcw.exe",
		     "MicrosoftEdgeUpdateComRegisterShell64.exe") and
		     process.code_signature.trusted == true and
		     process.code_signature.subject_name in ("Microsoft Windows",
		     "Microsoft Corporation")   ) and      not process.executable :
		     ("?:\\Program Files (x86)\\*.exe",
		     "?:\\Program Files\\*.exe",
		     "?:\\Windows\\System32\\svchost.exe",
		     "?:\\Windows\\System32\\msiexec.exe",
		     "?:\\Windows\\SysWOW64\\regsvr32.exe",
		     "?:\\Windows\\System32\\regsvr32.exe",
		     "?:\\Windows\\System32\\DriverStore\\FileRepository\\*.exe",
		     "?:\\ProgramData\\Microsoft\\Windows
		     Defender\\Platform\\*\\MsMpEng.exe")

NamE: Execution via Windows Command Debugging Utility
	description: 
		     An adversary can use the Windows command line
		     debugging utility cdb.exe to execute commands or shellcode.
		     This rule looks for those instances and where the cdb.exe
		     binary is outside of the normal WindowsKit installation paths.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  (?process.pe.original_file_name == "CDB.Exe" or
		     process.name : "cdb.exe") and   process.args : ("-cf", "-c",
		     "-pd") and   not process.executable : (         "?:\\Program
		     Files (x86)\\*\\cdb.exe",         "?:\\Program
		     Files\\*\\cdb.exe",         "\\Device\\HarddiskVolume?\\Program
		     Files (x86)\\*\\cdb.exe",
		     "\\Device\\HarddiskVolume?\\Program Files\\*\\cdb.exe"   )

NamE: Suspicious Endpoint Security Parent Process
	description: 
		     A suspicious Endpoint Security parent process
		     was detected. This may indicate a process hollowing or other
		     form of code injection.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : ("esensor.exe", "elastic-
		     endpoint.exe") and   process.parent.executable != null and   /*
		     add FPs here */   not process.parent.executable : (
		     "?:\\Program Files\\Elastic\\*",
		     "?:\\Windows\\System32\\services.exe",
		     "?:\\Windows\\System32\\WerFault*.exe",
		     "?:\\Windows\\System32\\wermgr.exe",
		     "?:\\Windows\\explorer.exe"   ) and   not (
		     process.parent.executable : (
		     "?:\\Windows\\System32\\cmd.exe",
		     "?:\\Windows\\System32\\SecurityHealthHost.exe",         "?:\\W
		     indows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"
		     ) and     process.args : (         "test", "version",
		     "top", "run",         "*help", "status",         "upgrade",
		     "/launch",         "/enable"     )   )

NamE: Suspicious Zoom Child Process
	description: 
		     A suspicious Zoom child process was detected,
		     which may indicate an attempt to run unnoticed. Verify process
		     details such as command line, network connections, file writes
		     and associated file signature details as well.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  process.parent.name : "Zoom.exe" and
		     process.name : ("cmd.exe", "powershell.exe", "pwsh.exe",
		     "powershell_ise.exe")

NamE: Credential Acquisition via Registry Hive Dumping
	description: 
		     Identifies attempts to export a registry hive
		     which may contain credentials using the Windows reg.exe tool.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  (?process.pe.original_file_name == "reg.exe" or
		     process.name : "reg.exe") and  process.args : ("save",
		     "export") and  process.args : ("hklm\\sam", "hklm\\security")

NamE: System Owner/User Discovery Linux
	description: 
		     Identifies the use of built-in tools which
		     adversaries may use to enumerate the system owner/user of a
		     compromised system.
	query: 
		     process where event.type == "start" and event.action
		     in ("exec", "exec_event", "executed", "process_started") and
		     process.name : ("whoami", "w", "who", "users", "id")

NamE: Suspicious Utility Launched via ProxyChains
	description: 
		     This rule monitors for the execution of
		     suspicious linux tools through ProxyChains. ProxyChains is a
		     command-line tool that enables the routing of network
		     connections through intermediary proxies, enhancing anonymity
		     and enabling access to restricted resources. Attackers can
		     exploit the ProxyChains utility to hide their true source IP
		     address, evade detection, and perform malicious activities
		     through a chain of proxy servers, potentially masking their
		     identity and intentions.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed", "process_started")  and
		     process.name == "proxychains" and process.args : (   "ssh",
		     "sshd", "sshuttle", "socat", "iodine", "iodined", "dnscat",
		     "hans", "hans-ubuntu", "ptunnel-ng",   "ssf", "3proxy",
		     "ngrok", "gost", "pivotnacci", "chisel*", "nmap", "ping",
		     "python*", "php*", "perl", "ruby",   "lua*", "openssl", "nc",
		     "netcat", "ncat", "telnet", "awk", "java", "telnet", "ftp",
		     "curl", "wget" )

NamE: Microsoft Exchange Worker Spawning Suspicious Processes
	description: 
		     Identifies suspicious processes being spawned by
		     the Microsoft Exchange Server worker process (w3wp). This
		     activity may indicate exploitation activity or access to an
		     existing web shell backdoor.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.name : "w3wp.exe" and
		     process.parent.args : "MSExchange*AppPool" and   (process.name
		     : ("cmd.exe", "powershell.exe", "pwsh.exe",
		     "powershell_ise.exe") or   ?process.pe.original_file_name in
		     ("cmd.exe", "powershell.exe", "pwsh.dll",
		     "powershell_ise.exe"))

NamE: Network Logon Provider Registry Modification
	description: 
		     Identifies the modification of the network logon
		     provider registry. Adversaries may register a rogue network
		     logon provider module for persistence and/or credential access
		     via intercepting the authentication credentials in clear text
		     during user logon.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.data.strings : "?*" and
		     registry.value : "ProviderPath" and   registry.path : (     "HK
		     LM\\SYSTEM\\*ControlSet*\\Services\\*\\NetworkProvider\\Provide
		     rPath",     "\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Service
		     s\\*\\NetworkProvider\\ProviderPath"   ) and   /* Excluding
		     default NetworkProviders RDPNP, LanmanWorkstation and
		     webclient. */   not (     user.id : "S-1-5-18" and
		     registry.data.strings : (
		     "%SystemRoot%\\System32\\ntlanman.dll",
		     "%SystemRoot%\\System32\\drprov.dll",
		     "%SystemRoot%\\System32\\davclnt.dll",
		     "%SystemRoot%\\System32\\vmhgfs.dll",         "?:\\Program
		     Files (x86)\\Citrix\\ICA Client\\x64\\pnsson.dll",
		     "?:\\Program
		     Files\\Dell\\SARemediation\\agent\\DellMgmtNP.dll",
		     "?:\\Program Files (x86)\\CheckPoint\\Endpoint
		     Connect\\\\epcgina.dll"     )   )

NamE: Clearing Windows Event Logs
	description: 
		     Identifies attempts to clear or disable Windows
		     event log stores using Windows wevetutil command. This is often
		     done by attackers in an attempt to evade detection or destroy
		     forensic evidence on a system.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and (   (     (process.name : "wevtutil.exe" or
		     ?process.pe.original_file_name == "wevtutil.exe") and
		     process.args : ("/e:false", "cl", "clear-log")   ) or   (     (
		     process.name : ("powershell.exe", "pwsh.exe",
		     "powershell_ise.exe") or       ?process.pe.original_file_name
		     in ("powershell.exe", "pwsh.dll", "powershell_ise.exe")     )
		     and     process.args : "Clear-EventLog"   ) )

NamE: Windows Defender Exclusions Added via PowerShell
	description: 
		     Identifies modifications to the Windows Defender
		     configuration settings using PowerShell to add exclusions at
		     the folder directory or process level.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  (process.name : ("powershell.exe", "pwsh.exe",
		     "powershell_ise.exe") or ?process.pe.original_file_name in
		     ("powershell.exe", "pwsh.dll", "powershell_ise.exe")) and
		     process.args : ("*Add-MpPreference*", "*Set-MpPreference*") and
		     process.args : ("*-Exclusion*")

NamE: Service Control Spawned via Script Interpreter
	description: 
		     Identifies Service Control (sc.exe) spawning
		     from script interpreter processes to create, modify, or start
		     services. This can potentially indicate an attempt to elevate
		     privileges or maintain persistence.
	query: 
		     /* This rule is not compatible with Sysmon due to
		     user.id issues */  process where host.os.type == "windows" and
		     event.type == "start" and   (process.name : "sc.exe" or
		     ?process.pe.original_file_name == "sc.exe") and
		     process.parent.name : ("cmd.exe", "wscript.exe",
		     "rundll32.exe", "regsvr32.exe",
		     "wmic.exe", "mshta.exe","powershell.exe", "pwsh.exe") and
		     process.args:("config", "create", "start", "delete", "stop",
		     "pause") and   /* exclude SYSTEM SID - look for service
		     creations by non-SYSTEM user */   not user.id : "S-1-5-18"

NamE: Google Workspace Role Modified
	description: 
		     Detects when a custom admin role or its
		     permissions are modified. An adversary may modify a custom
		     admin role in order to elevate the permissions of other user
		     accounts and persist in their target’s environment.
	query: 
		     event.dataset:google_workspace.admin and
		     event.provider:admin and event.category:iam and
		     event.action:(ADD_PRIVILEGE or UPDATE_ROLE)

NamE: Credential Manipulation - Detected - Elastic Endgame
	description: 
		     Elastic Endgame detected Credential
		     Manipulation. Click the Elastic Endgame icon in the
		     event.module column or the link in the rule.reference column
		     for additional information.
	query: 
		     event.kind:alert and event.module:endgame and
		     endgame.metadata.type:detection and
		     (event.action:token_manipulation_event or
		     endgame.event_subtype_full:token_manipulation_event)

NamE: Azure Active Directory High Risk Sign-in
	description: 
		     Identifies high risk Azure Active Directory (AD)
		     sign-ins by leveraging Microsoft's Identity Protection machine
		     learning and heuristics. Identity Protection categorizes risk
		     into three tiers: low, medium, and high. While Microsoft does
		     not provide specific details about how risk is calculated, each
		     level brings higher confidence that the user or sign-in is
		     compromised.
	query: 
		     event.dataset:azure.signinlogs and   (azure.signinlogs
		     .properties.risk_level_during_signin:high or
		     azure.signinlogs.properties.risk_level_aggregated:high) and
		     event.outcome:(success or Success)

NamE: Polkit Policy Creation
	description: 
		     This rule monitors for the creation of Polkit
		     policy files on Linux systems. Polkit policy files are used to
		     define the permissions for system-wide services and
		     applications. The creation of new Polkit policy files may
		     indicate an attempt to modify the authentication process, which
		     could be used for persistence by an adversary.
	query: 
		     file where host.os.type == "linux" and event.type ==
		     "creation" and process.executable != null and file.extension in
		     ("rules", "pkla", "policy") and file.path like~ (    // Rule
		     files   "/etc/polkit-1/rules.d/*",
		     "/usr/share/polkit-1/rules.d/*",    // pkla files
		     "/etc/polkit-1/localauthority/*",
		     "/var/lib/polkit-1/localauthority/*",    // Action files
		     "/usr/share/polkit-1/actions/*",    // Misc. legacy paths
		     "/lib/polkit-1/rules.d/*", "/lib64/polkit-1/rules.d/*",
		     "/var/lib/polkit-1/rules.d/*" ) and not (   process.executable
		     in (     "/bin/dpkg", "/usr/bin/dpkg", "/bin/dockerd",
		     "/usr/bin/dockerd", "/usr/sbin/dockerd", "/bin/microdnf",
		     "/usr/bin/microdnf", "/bin/rpm", "/usr/bin/rpm", "/bin/snapd",
		     "/usr/bin/snapd", "/bin/yum", "/usr/bin/yum",     "/bin/dnf",
		     "/usr/bin/dnf", "/bin/podman", "/usr/bin/podman", "/bin/dnf-
		     automatic", "/usr/bin/dnf-automatic",     "/bin/pacman",
		     "/usr/bin/pacman", "/usr/bin/dpkg-divert", "/bin/dpkg-divert",
		     "/sbin/apk", "/usr/sbin/apk",     "/usr/local/sbin/apk",
		     "/usr/bin/apt", "/usr/sbin/pacman", "/bin/podman",
		     "/usr/bin/podman", "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/lib/snapd/snapd", "/usr/local/bin/dockerd",
		     "/usr/bin/crio", "/usr/sbin/crond",
		     "/opt/puppetlabs/puppet/bin/ruby", "/usr/libexec/platform-
		     python", "/kaniko/kaniko-executor",
		     "/usr/local/bin/dockerd", "/usr/bin/podman", "/bin/install",
		     "/proc/self/exe", "/usr/lib/systemd/systemd",
		     "/usr/sbin/sshd", "/usr/bin/gitlab-runner",
		     "/opt/gitlab/embedded/bin/ruby", "/usr/sbin/gdm",
		     "/usr/bin/install",
		     "/usr/local/manageengine/uems_agent/bin/dcregister",
		     "/usr/local/bin/pacman"   ) or process.executable like~ (
		     "/nix/store/*", "/var/lib/dpkg/*", "/tmp/vmis.*", "/snap/*",
		     "/dev/fd/*", "/usr/lib/virtualbox/*"   ) )

NamE: Modification of WDigest Security Provider
	description: 
		     Identifies attempts to modify the WDigest
		     security provider in the registry to force the user's password
		     to be stored in clear text in memory. This behavior can be
		     indicative of an adversary attempting to weaken the security
		     configuration of an endpoint. Once the UseLogonCredential value
		     is modified, the adversary may attempt to dump clear text
		     passwords from memory.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "creation" and     registry.path : (         "HKL
		     M\\SYSTEM\\*ControlSet*\\Control\\SecurityProviders\\WDigest\\U
		     seLogonCredential",         "\\REGISTRY\\MACHINE\\SYSTEM\\*Cont
		     rolSet*\\Control\\SecurityProviders\\WDigest\\UseLogonCredentia
		     l"     ) and registry.data.strings : ("1", "0x00000001") and
		     not (process.executable : "?:\\Windows\\System32\\svchost.exe"
		     and user.id : "S-1-5-18")

NamE: Azure Conditional Access Policy Modified
	description: 
		     Identifies when an Azure Conditional Access
		     policy is modified. Azure Conditional Access policies control
		     access to resources via if-then statements. For example, if a
		     user wants to access a resource, then they must complete an
		     action such as using multi-factor authentication to access it.
		     An adversary may modify a Conditional Access policy in order to
		     weaken their target's security controls.
	query: 
		     event.dataset:(azure.activitylogs or azure.auditlogs)
		     and event.action:"Update conditional access policy" and
		     event.outcome:(Success or success)

NamE: First Occurrence of Private Repo Event from Specific GitHub Personal Access Token (PAT)
	description: 
		     Detects a new private repo interaction for a
		     GitHub PAT not seen in the last 14 days.
	query: 
		     event.dataset:"github.audit" and
		     event.category:"configuration" and github.repo:* and
		     github.hashed_token:* and
		     github.programmatic_access_type:("OAuth access token" or "Fine-
		     grained personal access token") and
		     github.repository_public:false

NamE: Potential Process Injection via PowerShell
	description: 
		     Detects the use of Windows API functions that
		     are commonly abused by malware and security tools to load
		     malicious code or inject it into remote processes.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (    (VirtualAlloc or
		     VirtualAllocEx or VirtualProtect or LdrLoadDll or LoadLibrary
		     or LoadLibraryA or       LoadLibraryEx or GetProcAddress or
		     OpenProcess or OpenProcessToken or AdjustTokenPrivileges) and
		     (WriteProcessMemory or CreateRemoteThread or NtCreateThreadEx
		     or CreateThread or QueueUserAPC or       SuspendThread or
		     ResumeThread or GetDelegateForFunctionPointer)   ) and not
		     file.directory: (     "C:\ProgramData\Microsoft\Windows
		     Defender Advanced Threat Protection\SenseCM" or
		     "C:\ProgramData\Microsoft\Windows Defender Advanced Threat
		     Protection\Downloads"   )

NamE: Potential PowerShell HackTool Script by Author
	description: 
		     Detects known PowerShell offensive tooling
		     author's name in PowerShell scripts. Attackers commonly use
		     out-of-the-box offensive tools without modifying the code,
		     which may still contain the author artifacts. This rule
		     identifies common author handles found in popular PowerShell
		     scripts used for red team exercises.
	query: 
		     host.os.type:windows and event.category:process and
		     powershell.file.script_block_text : (       "mattifestation" or
		     "JosephBialek" or       "harmj0y" or "ukstufus" or
		     "SecureThisShit" or "Matthew Graeber" or       "secabstraction"
		     or "mgeeky" or       "oddvarmoe" or "am0nsec" or
		     "obscuresec" or "sixdub" or       "darkoperator" or "funoverip"
		     or       "rvrsh3ll" or "kevin_robertson" or       "dafthack" or
		     "r4wd3r" or       "danielhbohannon" or "OneLogicalMyth" or
		     "cobbr_io" or "xorrior" or       "PetrMedonos" or "citronneur"
		     or       "eladshamir" or "RastaMouse" or       "enigma0x3" or
		     "FuzzySec" or       "424f424f" or "jaredhaight" or
		     "fullmetalcache" or "Hubbl3" or       "curi0usJack" or "Cx01N"
		     or       "itm4n" or "nurfed1" or       "cfalta" or "Scott
		     Sutherland" or       "_nullbind" or "_tmenochet" or
		     "jaredcatkinson" or "ChrisTruncer" or       "monoxgas" or
		     "TheRealWover" or       "splinter_code"   )

NamE: Unusual Discovery Signal Alert with Unusual Process Executable
	description: 
		     This rule leverages Discovery building block
		     rule alert data to alert on signals with unusual unique
		     host.id, user.id and process.executable entries.
	query: 
		     host.os.type:windows and event.kind:signal and kibana.
		     alert.rule.rule_id:"1d72d014-e2ab-4707-b056-9b96abe7b511"

NamE: Azure Diagnostic Settings Deletion
	description: 
		     Identifies the deletion of diagnostic settings
		     in Azure, which send platform logs and metrics to different
		     destinations. An adversary may delete diagnostic settings in an
		     attempt to evade defenses.
	query: 
		     event.dataset:azure.activitylogs and azure.activitylog
		     s.operation_name:"MICROSOFT.INSIGHTS/DIAGNOSTICSETTINGS/DELETE"
		     and event.outcome:(Success or success)

NamE: Exporting Exchange Mailbox via PowerShell
	description: 
		     Identifies the use of the Exchange PowerShell
		     cmdlet, New-MailBoxExportRequest, to export the contents of a
		     primary mailbox or archive to a .pst file. Adversaries may
		     target user email to collect sensitive information.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name: ("powershell.exe", "pwsh.exe",
		     "powershell_ise.exe") and   process.command_line :
		     ("*MailboxExportRequest*", "*-Mailbox*-ContentFilter*")

NamE: Symbolic Link to Shadow Copy Created
	description: 
		     Identifies the creation of symbolic links to a
		     shadow copy. Symbolic links can be used to access files in the
		     shadow copy, including sensitive files such as ntds.dit, System
		     Boot Key and browser offline credentials.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  (     (?process.pe.original_file_name in
		     ("Cmd.Exe","PowerShell.EXE")) or     (process.name :
		     ("cmd.exe", "powershell.exe"))  ) and   /* Create Symbolic Link
		     to Shadow Copies */  process.args : ("*mklink*",
		     "*SymbolicLink*") and process.command_line :
		     ("*HarddiskVolumeShadowCopy*")

NamE: New or Modified Federation Domain
	description: 
		     Identifies a new or modified federation domain,
		     which can be used to create a trust between O365 and an
		     external identity provider.
	query: 
		     event.dataset:o365.audit and event.provider:Exchange
		     and event.category:web and event.action:("Set-AcceptedDomain"
		     or "Set-MsolDomainFederationSettings" or "Add-FederatedDomain"
		     or "New-AcceptedDomain" or "Remove-AcceptedDomain" or "Remove-
		     FederatedDomain") and event.outcome:success

NamE: Member Removed From GitHub Organization
	description: 
		     A member was removed or their invitation to join
		     was removed from a GitHub Organization.
	query: 
		     configuration where event.dataset == "github.audit"
		     and event.action == "org.remove_member"

NamE: Netsh Helper DLL
	description: 
		     Identifies the addition of a Netsh Helper DLL,
		     netsh.exe supports the addition of these DLLs to extend its
		     functionality. Attackers may abuse this mechanism to execute
		     malicious payloads every time the utility is executed, which
		     can be done by administrators or a scheduled task.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.path : (
		     "HKLM\\Software\\Microsoft\\netsh\\*",
		     "\\REGISTRY\\MACHINE\\Software\\Microsoft\\netsh\\*",
		     "MACHINE\\Software\\Microsoft\\netsh\\*"   )

NamE: Searching for Saved Credentials via VaultCmd
	description: 
		     Windows Credential Manager allows you to create,
		     view, or delete saved credentials for signing into websites,
		     connected applications, and networks. An adversary may abuse
		     this to list or dump credentials stored in the Credential
		     Manager for saved usernames and passwords. This may also be
		     performed in preparation of lateral movement.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (?process.pe.original_file_name:"vaultcmd.exe"
		     or process.name:"vaultcmd.exe") and   process.args:"/list*"

NamE: Potential Credential Access via Windows Utilities
	description: 
		     Identifies the execution of known Windows
		     utilities often abused to dump LSASS memory or the Active
		     Directory database (NTDS.dit) in preparation for credential
		     access.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and (   (     (?process.pe.original_file_name :
		     "procdump" or process.name : "procdump.exe") and process.args :
		     "-ma"   ) or   (     process.name : "ProcessDump.exe" and not
		     process.parent.executable regex~ """C:\\Program Files(
		     \(x86\))?\\Cisco Systems\\.*"""   ) or   (
		     (?process.pe.original_file_name : "WriteMiniDump.exe" or
		     process.name : "WriteMiniDump.exe") and       not
		     process.parent.executable regex~ """C:\\Program Files(
		     \(x86\))?\\Steam\\.*"""   ) or   (
		     (?process.pe.original_file_name : "RUNDLL32.EXE" or
		     process.name : "RUNDLL32.exe") and       (process.args :
		     "MiniDump*" or process.command_line : "*comsvcs.dll*#24*")   )
		     or   (     (?process.pe.original_file_name : "RdrLeakDiag.exe"
		     or process.name : "RdrLeakDiag.exe") and       process.args :
		     "/fullmemdmp"   ) or   (     (?process.pe.original_file_name :
		     "SqlDumper.exe" or process.name : "SqlDumper.exe") and
		     process.args : "0x01100*") or   (
		     (?process.pe.original_file_name : "TTTracer.exe" or
		     process.name : "TTTracer.exe") and       process.args :
		     "-dumpFull" and process.args : "-attach") or   (
		     (?process.pe.original_file_name : "ntdsutil.exe" or
		     process.name : "ntdsutil.exe") and       process.args :
		     "create*full*") or   (     (?process.pe.original_file_name :
		     "diskshadow.exe" or process.name : "diskshadow.exe") and
		     process.args : "/s") )

NamE: Volume Shadow Copy Deleted or Resized via VssAdmin
	description: 
		     Identifies use of vssadmin.exe for shadow copy
		     deletion or resizing on endpoints. This commonly occurs in
		     tandem with ransomware or other destructive attacks.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (process.name : "vssadmin.exe" or
		     ?process.pe.original_file_name == "VSSADMIN.EXE") and
		     process.args : ("delete", "resize") and process.args :
		     "shadows*"

NamE: ImageLoad via Windows Update Auto Update Client
	description: 
		     Identifies abuse of the Windows Update Auto
		     Update Client (wuauclt.exe) to load an arbitrary DLL. This
		     behavior is used as a defense evasion technique to blend-in
		     malicious activity with legitimate Windows software.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (?process.pe.original_file_name ==
		     "wuauclt.exe" or process.name : "wuauclt.exe") and    /*
		     necessary windows update client args to load a dll */
		     process.args : "/RunHandlerComServer" and process.args :
		     "/UpdateDeploymentProvider" and    /* common paths writeable by
		     a standard user where the target DLL can be placed */
		     process.args : ("C:\\Users\\*.dll", "C:\\ProgramData\\*.dll",
		     "C:\\Windows\\Temp\\*.dll", "C:\\Windows\\Tasks\\*.dll")

NamE: Potential Exploitation of an Unquoted Service Path Vulnerability
	description: 
		     Adversaries may leverage unquoted service path
		     vulnerabilities to escalate privileges. By placing an
		     executable in a higher-level directory within the path of an
		     unquoted service executable, Windows will natively launch this
		     executable from its defined path variable instead of the benign
		     one in a deeper directory, thus leading to code execution.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (     process.executable : "?:\\Program.exe"
		     or     process.executable regex """(C:\\Program Files
		     \(x86\)\\|C:\\Program Files\\)\w+.exe"""   )

NamE: Potential Network Share Discovery
	description: 
		     Adversaries may look for folders and drives
		     shared on remote systems to identify sources of information to
		     gather as a precursor for collection and identify potential
		     systems of interest for Lateral Movement.
	query: 
		     sequence by user.name, source.port, source.ip with
		     maxspan=15s   [file where event.action == "network-share-
		     object-access-checked" and    winlog.event_data.ShareName in
		     ("\\\\*\\ADMIN$", "\\\\*\\C$") and    source.ip != null and
		     source.ip != "0.0.0.0" and source.ip != "::1" and source.ip !=
		     "::" and source.ip != "127.0.0.1"]  [file where event.action ==
		     "network-share-object-access-checked" and
		     winlog.event_data.ShareName in ("\\\\*\\ADMIN$", "\\\\*\\C$")
		     and    source.ip != null and source.ip != "0.0.0.0" and
		     source.ip != "::1" and source.ip != "::" and source.ip !=
		     "127.0.0.1"]

NamE: AWS RDS Snapshot Export
	description: 
		     Identifies the export of an Amazon Relational
		     Database Service (RDS) Aurora database snapshot.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:rds.amazonaws.com and
		     event.action:StartExportTask and event.outcome:success

NamE: GCP Storage Bucket Permissions Modification
	description: 
		     Identifies when the Identity and Access
		     Management (IAM) permissions are modified for a Google Cloud
		     Platform (GCP) storage bucket. An adversary may modify the
		     permissions on a storage bucket to weaken their target's
		     security controls or an administrator may inadvertently modify
		     the permissions, which could lead to data exposure or loss.
	query: 
		     event.dataset:gcp.audit and
		     event.action:"storage.setIamPermissions" and
		     event.outcome:success

NamE: WebServer Access Logs Deleted
	description: 
		     Identifies the deletion of WebServer access
		     logs. This may indicate an attempt to evade detection or
		     destroy forensic evidence on a system.
	query: 
		     file where event.type == "deletion" and   file.path :
		     ("C:\\inetpub\\logs\\LogFiles\\*.log",
		     "/var/log/apache*/access.log",
		     "/etc/httpd/logs/access_log",
		     "/var/log/httpd/access_log",
		     "/var/www/*/logs/access.log")

NamE: File Permission Modification in Writable Directory
	description: 
		     Identifies file permission modifications in
		     common writable directories by a non-root user. Adversaries
		     often drop files or payloads into a writable directory and
		     change permissions prior to execution.
	query: 
		     host.os.type:linux and event.category:process and
		     event.type:start and process.name:(chattr or chgrp or chmod or
		     chown) and process.working_directory:(/dev/shm or /tmp or
		     /var/tmp) and not process.parent.name:(   apt-key or update-
		     motd-updates-available or apt-get or java or pilot or
		     PassengerAgent or nginx )

NamE: Delayed Execution via Ping
	description: 
		     Identifies the execution of commonly abused
		     Windows utilities via a delayed Ping execution. This behavior
		     is often observed during malware installation and is consistent
		     with an attacker attempting to evade detection.
	query: 
		     sequence by process.parent.entity_id with maxspan=1m
		     [process where host.os.type == "windows" and event.action ==
		     "start" and process.name : "ping.exe" and    process.args :
		     "-n" and process.parent.name : "cmd.exe" and not user.id :
		     "S-1-5-18"]   [process where host.os.type == "windows" and
		     event.action == "start" and    process.parent.name : "cmd.exe"
		     and    (         process.name : (             "rundll32.exe",
		     "powershell.exe",             "mshta.exe", "msbuild.exe",
		     "certutil.exe", "regsvr32.exe",             "powershell.exe",
		     "cscript.exe",             "wscript.exe", "wmic.exe",
		     "installutil.exe", "msxsl.exe",
		     "Microsoft.Workflow.Compiler.exe",             "ieexec.exe",
		     "iexpress.exe",             "RegAsm.exe", "installutil.exe",
		     "RegSvcs.exe", "RegAsm.exe"         ) or
		     (process.executable : "?:\\Users\\*\\AppData\\*.exe" and not
		     process.code_signature.trusted == true)     ) and      not
		     process.args : ("?:\\Program Files\\*", "?:\\Program Files
		     (x86)\\*") and     not (process.name : ("openssl.exe",
		     "httpcfg.exe", "certutil.exe") and process.parent.command_line
		     : "*ScreenConnectConfigurator.cmd*") and     not
		     (process.pe.original_file_name : "DPInst.exe" and
		     process.command_line : "driver\\DPInst_x64  /f ") and     not
		     (process.name : "powershell.exe" and process.args : "Write-Host
		     ======*") and     not (process.name : "wscript.exe" and
		     process.args : "launchquiet_args.vbs" and process.parent.args :
		     "?:\\Windows\\TempInst\\7z*") and     not (process.name :
		     "regsvr32.exe" and process.args :
		     ("?:\\windows\\syswow64\\msxml?.dll", "msxml?.dll",
		     "?:\\Windows\\SysWOW64\\mschrt20.ocx")) and     not
		     (process.name : "wscript.exe" and
		     process.working_directory :
		     ("?:\\Windows\\TempInst\\*",                      "?:\\Users\\*
		     \\AppData\\Local\\Temp\\BackupBootstrapper\\Logs\\",
		     "?:\\Users\\*\\AppData\\Local\\Temp\\QBTools\\"))     ]

NamE: New GitHub App Installed
	description: 
		     This rule detects when a new GitHub App has been
		     installed in your organization account. GitHub Apps extend
		     GitHub's functionality both within and outside of GitHub. When
		     an app is installed it is granted permissions to read or modify
		     your repository and organization data. Only trusted apps should
		     be installed and any newly installed apps should be
		     investigated to verify their legitimacy. Unauthorized app
		     installation could lower your organization's security posture
		     and leave you exposed for future attacks.
	query: 
		     configuration where event.dataset == "github.audit"
		     and event.action == "integration_installation.create"

NamE: Sensitive Audit Policy Sub-Category Disabled
	description: 
		     Identifies attempts to disable auditing for some
		     security sensitive audit policy sub-categories. This is often
		     done by attackers in an attempt to evade detection and
		     forensics on a system.
	query: 
		     event.code : "4719" and host.os.type : "windows" and
		     winlog.event_data.AuditPolicyChangesDescription : "Success
		     removed" and   winlog.event_data.SubCategory : (      "Logon"
		     or      "Audit Policy Change" or      "Process Creation" or
		     "Audit Other System Events" or      "Audit Security Group
		     Management" or      "Audit User Account Management"   )

NamE: AWS Bedrock Detected Multiple Attempts to use Denied Models by a Single User
	description: 
		     Identifies multiple successive failed attempts
		     to use denied model resources within AWS Bedrock. This could
		     indicated attempts to bypass limitations of other approved
		     models, or to force an impact on the environment by incurring
		     exhorbitant costs.
	query: 
		     from logs-aws_bedrock.invocation-* | where
		     gen_ai.response.error_code == "AccessDeniedException" | keep
		     user.id, gen_ai.request.model.id, cloud.account.id,
		     gen_ai.response.error_code | stats total_denials = count(*) by
		     user.id, gen_ai.request.model.id, cloud.account.id | where
		     total_denials > 3 | sort total_denials desc

NamE: AWS IAM User Addition to Group
	description: 
		     Identifies the addition of a user to a specified
		     group in AWS Identity and Access Management (IAM).
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:iam.amazonaws.com and
		     event.action:AddUserToGroup and event.outcome:success

NamE: CyberArk Privileged Access Security Error
	description: 
		     Identifies the occurrence of a CyberArk
		     Privileged Access Security (PAS) error level audit event. The
		     event.code correlates to the CyberArk Vault Audit Action Code.
	query: 
		     event.dataset:cyberarkpas.audit and event.type:error

NamE: AWS RDS DB Instance or Cluster Deletion Protection Disabled
	description: 
		     Identifies the modification of an AWS RDS DB
		     instance or cluster to remove the deletionProtection feature.
		     Deletion protection is enabled automatically for instances set
		     up through the console and can be used to protect them from
		     unintentional deletion activity. If disabled an instance or
		     cluster can be deleted, destroying sensitive or critical
		     information. Adversaries with the proper permissions can take
		     advantage of this to set up future deletion events against a
		     compromised environment.
	query: 
		     any where event.dataset == "aws.cloudtrail"     and
		     event.provider == "rds.amazonaws.com"     and event.action in
		     ("ModifyDBInstance", "ModifyDBCluster")     and event.outcome
		     == "success"     and
		     stringContains(aws.cloudtrail.request_parameters,
		     "deletionProtection=false")

NamE: Potential Privilege Escalation via CVE-2023-4911
	description: 
		     This rule detects potential privilege escalation
		     attempts through Looney Tunables (CVE-2023-4911). Looney
		     Tunables is a buffer overflow vulnerability in GNU C Library's
		     dynamic loader's processing of the GLIBC_TUNABLES environment
		     variable.
	query: 
		     sequence by host.id, process.parent.entity_id,
		     process.executable with maxspan=5s  [process where host.os.type
		     == "linux" and event.type == "start" and event.action == "exec"
		     and   process.env_vars : "*GLIBC_TUNABLES=glibc.*=glibc.*=*"]
		     with runs=5

NamE: Systemd Generator Created
	description: 
		     This rule detects the creation of a systemd
		     generator file. Generators are small executables executed by
		     systemd at bootup and during configuration reloads. Their main
		     role is to convert non-native configuration and execution
		     parameters into dynamically generated unit files, symlinks, or
		     drop-ins, extending the unit file hierarchy for the service
		     manager. Systemd generators can be used to execute arbitrary
		     code at boot time, which can be leveraged by attackers to
		     maintain persistence on a Linux system.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("rename", "creation") and file.path : ( "/run/systemd/system-
		     generators/*", "/etc/systemd/system-generators/*",
		     "/usr/local/lib/systemd/system-generators/*",
		     "/lib/systemd/system-generators/*", "/usr/lib/systemd/system-
		     generators/*", "/etc/systemd/user-generators/*",
		     "/usr/local/lib/systemd/user-generators/*",
		     "/usr/lib/systemd/user-generators/*", "/lib/systemd/user-
		     generators/*" ) and not (   process.executable in (
		     "/bin/dpkg", "/usr/bin/dpkg", "/bin/dockerd",
		     "/usr/bin/dockerd", "/usr/sbin/dockerd", "/bin/microdnf",
		     "/usr/bin/microdnf", "/bin/rpm", "/usr/bin/rpm", "/bin/snapd",
		     "/usr/bin/snapd", "/bin/yum", "/usr/bin/yum",     "/bin/dnf",
		     "/usr/bin/dnf", "/bin/podman", "/usr/bin/podman", "/bin/dnf-
		     automatic", "/usr/bin/dnf-automatic",     "/bin/pacman",
		     "/usr/bin/pacman", "/usr/bin/dpkg-divert", "/bin/dpkg-divert",
		     "/sbin/apk", "/usr/sbin/apk",     "/usr/local/sbin/apk",
		     "/usr/bin/apt", "/usr/sbin/pacman", "/bin/podman",
		     "/usr/bin/podman", "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client", "/usr/sbin/sshd",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/lib/snapd/snapd", "/usr/local/bin/dockerd",
		     "/usr/libexec/platform-python"   ) or   process.name like~
		     ("ssm-agent-worker", "crio", "docker-init", "systemd",
		     "pacman", "python*", "platform-python*") or   file.extension in
		     ("swp", "swpx", "swx", "dpkg-remove") or
		     file.Ext.original.extension == "dpkg-new" or
		     process.executable == null )

NamE: Potential Defense Evasion via PRoot
	description: 
		     Identifies the execution of the PRoot utility,
		     an open-source tool for user-space implementation of chroot,
		     mount --bind, and binfmt_misc. Adversaries can leverage an
		     open-source tool PRoot to expand the scope of their operations
		     to multiple Linux distributions and simplify their necessary
		     efforts. In a normal threat scenario, the scope of an attack is
		     limited by the varying configurations of each Linux
		     distribution. With PRoot, it provides an attacker with a
		     consistent operational environment across different Linux
		     distributions, such as Ubuntu, Fedora, and Alpine. PRoot also
		     provides emulation capabilities that allow for malware built on
		     other architectures, such as ARM, to be run.The post-
		     exploitation technique called bring your own filesystem (BYOF),
		     can be used by the threat actors to execute malicious payload
		     or elevate privileges or perform network scans or orchestrate
		     another attack on the environment. Although PRoot was
		     originally not developed with malicious intent it can be easily
		     tuned to work for one.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2") and process.parent.name == "proot"

NamE: Yum/DNF Plugin Status Discovery
	description: 
		     This rule detects the execution of the `grep`
		     command with the `plugins` argument on Linux systems. This
		     command is used to search for YUM/DNF configurations and/or
		     plugins with an enabled state. This behavior may indicate an
		     attacker is attempting to establish persistence in a YUM or DNF
		     plugin.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2") and   process.name == "grep" and
		     process.args : "plugins*" and process.args : (
		     "/etc/yum.conf", "/usr/lib/yum-plugins/*",
		     "/etc/yum/pluginconf.d/*",     "/usr/lib/python*/site-
		     packages/dnf-plugins/*", "/etc/dnf/plugins/*",
		     "/etc/dnf/dnf.conf"   )

NamE: Azure Entra ID Rare Authentication Requirement for Principal User
	description: 
		     Identifies rare instances of authentication
		     requirements for Azure Entra ID principal users. An adversary
		     with stolen credentials may attempt to authenticate with
		     unusual authentication requirements, which is a rare event and
		     may indicate an attempt to bypass conditional access policies
		     (CAP) and multi-factor authentication (MFA) requirements. The
		     authentication requirements specified may not be commonly used
		     by the user based on their historical sign-in activity.
	query: 
		     event.dataset: "azure.signinlogs" and event.category:
		     "authentication"     and azure.signinlogs.properties.user_type:
		     "Member"     and not
		     azure.signinlogs.properties.client_app_used: "Browser"     and
		     not source.as.organization.name: "MICROSOFT-CORP-MSN-AS-BLOCK"

NamE: First Time Seen AWS Secret Value Accessed in Secrets Manager
	description: 
		     An adversary with access to a compromised AWS
		     service such as an EC2 instance, Lambda function, or other
		     service may attempt to leverage the compromised service to
		     access secrets in AWS Secrets Manager. This rule looks for the
		     first time a specific user identity has programmatically
		     retrieved a secret value from Secrets Manager using the
		     `GetSecretValue` or `BatchGetSecretValue` actions. This rule
		     assumes that AWS services such as Lambda functions and EC2
		     instances are setup with IAM role's assigned that have the
		     necessary permissions to access the secrets in Secrets Manager.
		     An adversary with access to a compromised AWS service such as
		     an EC2 instance, Lambda function, or other service would rely
		     on the compromised service's IAM role to access the secrets in
		     Secrets Manager.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:secretsmanager.amazonaws.com and
		     event.action: (GetSecretValue or BatchGetSecretValue) and
		     event.outcome:success and     not user_agent.name: ("Chrome" or
		     "Firefox" or "Safari" or "Edge" or "Brave" or "Opera")

NamE: Group Policy Abuse for Privilege Addition
	description: 
		     Detects the first occurrence of a modification
		     to Group Policy Object Attributes to add privileges to user
		     accounts or use them to add users as local admins.
	query: 
		     any where host.os.type == "windows" and event.code:
		     "5136" and   winlog.event_data.AttributeLDAPDisplayName:
		     "gPCMachineExtensionNames" and
		     winlog.event_data.AttributeValue:
		     "*827D319E-6EAC-11D2-A4EA-00C04F79F83A*" and
		     winlog.event_data.AttributeValue:
		     "*803E14A0-B4FB-11D0-A0D0-00A0C90F574B*"

NamE: Attempt to Modify an Okta Application
	description: 
		     Detects attempts to modify an Okta application.
		     An adversary may attempt to modify, deactivate, or delete an
		     Okta application in order to weaken an organization's security
		     controls or disrupt their business operations.
	query: 
		     event.dataset:okta.system and
		     event.action:application.lifecycle.update

NamE: AWS Systems Manager SecureString Parameter Request with Decryption Flag
	description: 
		     Detects the first occurrence of a user identity
		     accessing AWS Systems Manager (SSM) SecureString parameters
		     using the GetParameter or GetParameters API actions with
		     credentials in the request parameters. This could indicate that
		     the user is accessing sensitive information. This rule detects
		     when a user accesses a SecureString parameter with the
		     `withDecryption` parameter set to true. This is a [NewTerms](ht
		     tps://www.elastic.co/guide/en/security/current/rules-ui-
		     create.html#create-new-terms-rule) rule that detects the first
		     occurrence of a specific AWS ARN accessing SecureString
		     parameters with decryption within the last 10 days.
	query: 
		     event.dataset: aws.cloudtrail     and event.provider:
		     "ssm.amazonaws.com"     and event.action: (GetParameters or
		     GetParameter)     and event.outcome: success     and
		     aws.cloudtrail.flattened.request_parameters.withDecryption:
		     true     and not source.address: (
		     "cloudformation.amazonaws.com" or
		     "servicecatalog.amazonaws.com"     )

NamE: Azure Firewall Policy Deletion
	description: 
		     Identifies the deletion of a firewall policy in
		     Azure. An adversary may delete a firewall policy in an attempt
		     to evade defenses and/or to eliminate barriers to their
		     objective.
	query: 
		     event.dataset:azure.activitylogs and azure.activitylog
		     s.operation_name:"MICROSOFT.NETWORK/FIREWALLPOLICIES/DELETE"
		     and event.outcome:(Success or success)

NamE: Program Files Directory Masquerading
	description: 
		     Identifies execution from a directory
		     masquerading as the Windows Program Files directories. These
		     paths are trusted and usually host trusted third party
		     programs. An adversary may leverage masquerading, along with
		     low privileges to bypass detections allowlisting those folders.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.executable : (
		     "C:\\*Program*Files*\\*.exe",
		     "\\Device\\HarddiskVolume?\\*Program*Files*\\*.exe"   ) and
		     not process.executable : (         "?:\\Program Files\\*.exe",
		     "?:\\Program Files (x86)\\*.exe",         "?:\\Users\\*.exe",
		     "?:\\ProgramData\\*.exe",         "?:\\Windows\\Downloaded
		     Program Files\\*.exe",         "?:\\Windows\\Temp\\.opera\\????
		     ????????\\CProgram?FilesOpera*\\*.exe",         "?:\\Windows\\T
		     emp\\.opera\\????????????\\CProgram?Files?(x86)Opera*\\*.exe"
		     ) and   not (     event.dataset == "crowdstrike.fdr" and
		     process.executable : (
		     "\\Device\\HarddiskVolume?\\Program Files\\*.exe",
		     "\\Device\\HarddiskVolume?\\Program Files (x86)\\*.exe",
		     "\\Device\\HarddiskVolume?\\Users\\*.exe",
		     "\\Device\\HarddiskVolume?\\ProgramData\\*.exe",
		     "\\Device\\HarddiskVolume?\\Windows\\Downloaded Program
		     Files\\*.exe",         "\\Device\\HarddiskVolume?\\Windows\\Tem
		     p\\.opera\\????????????\\CProgram?FilesOpera*\\*.exe",         
		     "\\Device\\HarddiskVolume?\\Windows\\Temp\\.opera\\????????????
		     \\CProgram?Files?(x86)Opera*\\*.exe"       )   )

NamE: Command Shell Activity Started via RunDLL32
	description: 
		     Identifies command shell activity started via
		     RunDLL32, which is commonly abused by attackers to host
		     malicious code.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  process.name : ("cmd.exe", "powershell.exe")
		     and   process.parent.name : "rundll32.exe" and
		     process.parent.command_line != null and   /* common FPs can be
		     added here */   not process.parent.args :
		     ("C:\\Windows\\System32\\SHELL32.dll,RunAsNewUser_RunDLL",
		     "C:\\WINDOWS\\*.tmp,zzzzInvokeManagedCustomActionOutOfProc")

NamE: Multiple Okta Sessions Detected for a Single User
	description: 
		     Detects when a user has started multiple Okta
		     sessions with the same user account and different session IDs.
		     This may indicate that an attacker has stolen the user's
		     session cookie and is using it to access the user's account
		     from a different location.
	query: 
		     event.dataset:okta.system     and
		     okta.event_type:user.session.start     and
		     okta.authentication_context.external_session_id:*     and not
		     (okta.actor.id: okta* or okta.actor.display_name: okta*)

NamE: Scheduled Task Execution at Scale via GPO
	description: 
		     Detects the modification of Group Policy Object
		     attributes to execute a scheduled task in the objects
		     controlled by the GPO.
	query: 
		     any where host.os.type == "windows" and event.code in
		     ("5136", "5145") and (   (
		     winlog.event_data.AttributeLDAPDisplayName : (
		     "gPCMachineExtensionNames",       "gPCUserExtensionNames"     )
		     and     winlog.event_data.AttributeValue :
		     "*CAB54552-DEEA-4691-817E-ED4A4D1AFC72*" and
		     winlog.event_data.AttributeValue :
		     "*AADCED64-746C-4633-A97C-D61349046527*"   ) or   (
		     winlog.event_data.ShareName : "\\\\*\\SYSVOL" and
		     winlog.event_data.RelativeTargetName : "*ScheduledTasks.xml"
		     and     winlog.event_data.AccessList:"*%%4417*"   ) )

NamE: Modification or Removal of an Okta Application Sign-On Policy
	description: 
		     Detects attempts to modify or delete a sign on
		     policy for an Okta application. An adversary may attempt to
		     modify or delete the sign on policy for an Okta application in
		     order to remove or weaken an organization's security controls.
	query: 
		     event.dataset:okta.system and
		     event.action:(application.policy.sign_on.update or
		     application.policy.sign_on.rule.delete)

NamE: Remote Windows Service Installed
	description: 
		     Identifies a network logon followed by Windows
		     service creation with same LogonId. This could be indicative of
		     lateral movement, but will be noisy if commonly done by
		     administrators."
	query: 
		     sequence by winlog.logon.id, winlog.computer_name with
		     maxspan=1m [authentication where event.action == "logged-in"
		     and winlog.logon.type : "Network" and event.outcome=="success"
		     and source.ip != null and source.ip != "127.0.0.1" and
		     source.ip != "::1"] [iam where event.action == "service-
		     installed" and  not winlog.event_data.SubjectLogonId : "0x3e7"
		     and  not winlog.event_data.ServiceFileName :
		     ("?:\\Windows\\ADCR_Agent\\adcrsvc.exe",
		     "?:\\Windows\\System32\\VSSVC.exe",
		     "?:\\Windows\\servicing\\TrustedInstaller.exe",
		     "?:\\Windows\\System32\\svchost.exe",
		     "?:\\Program Files (x86)\\*.exe",                 "?:\\Program
		     Files\\*.exe",                 "?:\\Windows\\PSEXESVC.EXE",
		     "?:\\Windows\\System32\\sppsvc.exe",
		     "?:\\Windows\\System32\\wbem\\WmiApSrv.exe",
		     "?:\\WINDOWS\\RemoteAuditService.exe",
		     "?:\\Windows\\VeeamVssSupport\\VeeamGuestHelper.exe",
		     "?:\\Windows\\VeeamLogShipper\\VeeamLogShipper.exe",
		     "?:\\Windows\\CAInvokerService.exe",
		     "?:\\Windows\\System32\\upfc.exe",
		     "?:\\Windows\\AdminArsenal\\PDQ*.exe",
		     "?:\\Windows\\System32\\vds.exe",
		     "?:\\Windows\\Veeam\\Backup\\VeeamDeploymentSvc.exe",
		     "?:\\Windows\\ProPatches\\Scheduler\\STSchedEx.exe",
		     "?:\\Windows\\System32\\certsrv.exe",
		     "?:\\Windows\\eset-remote-install-service.exe",
		     "?:\\Pella Corporation\\Pella Order Management\\GPAutoSvc.exe",
		     "?:\\Pella
		     Corporation\\OSCToGPAutoService\\OSCToGPAutoSvc.exe",
		     "?:\\Pella Corporation\\Pella Order Management\\GPAutoSvc.exe",
		     "?:\\Windows\\SysWOW64\\NwxExeSvc\\NwxExeSvc.exe",
		     "?:\\Windows\\System32\\taskhostex.exe")]

NamE: Potential Antimalware Scan Interface Bypass via PowerShell
	description: 
		     Identifies the execution of PowerShell script
		     with keywords related to different Antimalware Scan Interface
		     (AMSI) bypasses. An adversary may attempt first to disable AMSI
		     before executing further malicious powershell scripts to evade
		     detection.
	query: 
		     event.category:"process" and host.os.type:windows and
		     (     powershell.file.script_block_text : (
		     "System.Management.Automation.AmsiUtils" or
		     amsiInitFailed or                          "Invoke-AmsiBypass"
		     or                          "Bypass.AMSI" or
		     "amsi.dll" or                          AntimalwareProvider  or
		     amsiSession or                          amsiContext or
		     AmsiInitialize or                          unloadobfuscated or
		     unloadsilent or                          AmsiX64 or
		     AmsiX32 or                          FindAmsiFun or
		     "AllocHGlobal((9076" or                     "[cHAr](65)+[cHaR](
		     [byTe]0x6d)+[ChaR]([ByTe]0x73)+[CHaR]([BYte]0x69"     ) or     
		     powershell.file.script_block_text:("[Ref].Assembly.GetType(('Sy
		     stem.Management.Automation" and ".SetValue(") or
		     powershell.file.script_block_text:("::AllocHGlobal((" and
		     ".SetValue(" and "-replace" and ".NoRMALiZe(")   ) and   not
		     powershell.file.script_block_text : (     "sentinelbreakpoints"
		     and "Set-PSBreakpoint"   )

NamE: Creation or Modification of Root Certificate
	description: 
		     Identifies the creation or modification of a
		     local trusted root certificate in Windows. The install of a
		     malicious root certificate would allow an attacker the ability
		     to masquerade malicious files as valid signed components from
		     any entity (for example, Microsoft). It could also allow an
		     attacker to decrypt SSL traffic.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and registry.value : "Blob" and
		     registry.path :     (       "HKLM\\Software\\Microsoft\\SystemC
		     ertificates\\Root\\Certificates\\*\\Blob",       "HKLM\\Softwar
		     e\\Microsoft\\SystemCertificates\\AuthRoot\\Certificates\\*\\Bl
		     ob",       "HKLM\\Software\\Policies\\Microsoft\\SystemCertific
		     ates\\Root\\Certificates\\*\\Blob",       "HKLM\\Software\\Poli
		     cies\\Microsoft\\SystemCertificates\\AuthRoot\\Certificates\\*\
		     \Blob",       "\\REGISTRY\\MACHINE\\Software\\Microsoft\\System
		     Certificates\\Root\\Certificates\\*\\Blob",       "\\REGISTRY\\
		     MACHINE\\Software\\Microsoft\\SystemCertificates\\AuthRoot\\Cer
		     tificates\\*\\Blob",       "\\REGISTRY\\MACHINE\\Software\\Poli
		     cies\\Microsoft\\SystemCertificates\\Root\\Certificates\\*\\Blo
		     b",       "\\REGISTRY\\MACHINE\\Software\\Policies\\Microsoft\\
		     SystemCertificates\\AuthRoot\\Certificates\\*\\Blob",       "MA
		     CHINE\\Software\\Microsoft\\SystemCertificates\\Root\\Certifica
		     tes\\*\\Blob",       "MACHINE\\Software\\Microsoft\\SystemCerti
		     ficates\\AuthRoot\\Certificates\\*\\Blob",       "MACHINE\\Soft
		     ware\\Policies\\Microsoft\\SystemCertificates\\Root\\Certificat
		     es\\*\\Blob",       "MACHINE\\Software\\Policies\\Microsoft\\Sy
		     stemCertificates\\AuthRoot\\Certificates\\*\\Blob"     ) and
		     not process.executable : (           "?:\\ProgramData\\Lenovo\\
		     Vantage\\Addins\\LenovoHardwareScanAddin\\*\\LdeApi.Server.exe"
		     ,           "?:\\ProgramData\\Logishrd\\LogiOptionsPlus\\Plugin
		     s\\64\\certmgr.exe",
		     "?:\\ProgramData\\Microsoft\\Windows
		     Defender\\Platform\\*\\MpDefenderCoreService.exe",
		     "?:\\ProgramData\\Microsoft\\Windows
		     Defender\\Platform\\*\\MsMpEng.exe",           "?:\\ProgramData
		     \\Quest\\KACE\\modules\\clientidentifier\\clientidentifier.exe"
		     ,           "?:\\ProgramData\\Sophos\\AutoUpdate\\Cache\\sophos
		     _autoupdate1.dir\\SophosUpdate.exe",           "?:\\Program
		     Files (x86)\\*.exe",           "?:\\Program Files\\*.exe",
		     "?:\\Windows\\CCM\\CcmExec.exe",
		     "?:\\Windows\\ccmsetup\\cache\\ccmsetup.exe",
		     "?:\\Windows\\Cluster\\clussvc.exe",
		     "?:\\Windows\\ImmersiveControlPanel\\SystemSettings.exe",
		     "?:\\Windows\\Lenovo\\ImController\\PluginHost86\\Lenovo.Modern
		     .ImController.PluginHost.Device.exe",           "?:\\Windows\\L
		     enovo\\ImController\\Service\\Lenovo.Modern.ImController.exe",
		     "?:\\Windows\\Sysmon.exe",
		     "?:\\Windows\\Sysmon64.exe",
		     "?:\\Windows\\System32\\*.exe",
		     "?:\\Windows\\SysWOW64\\*.exe",
		     "?:\\Windows\\UUS\\amd64\\MoUsoCoreWorker.exe",
		     "?:\\Windows\\WinSxS\\*.exe"   )

NamE: Remote File Download via MpCmdRun
	description: 
		     Identifies the Windows Defender configuration
		     utility (MpCmdRun.exe) being used to download a remote file.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (process.name : "MpCmdRun.exe" or
		     ?process.pe.original_file_name == "MpCmdRun.exe") and
		     process.args : "-DownloadFile" and process.args : "-url" and
		     process.args : "-path"

NamE: Kill Command Execution
	description: 
		     This rule detects the execution of kill, pkill,
		     and killall commands on Linux systems. These commands are used
		     to terminate processes on a system. Attackers may use these
		     commands to kill security tools or other processes to evade
		     detection or disrupt system operations.
	query: 
		     event.category:process and host.os.type:linux and
		     event.type:start and event.action:exec and process.name:(kill
		     or pkill or killall)

NamE: Windows CryptoAPI Spoofing Vulnerability (CVE-2020-0601 - CurveBall)
	description: 
		     A spoofing vulnerability exists in the way
		     Windows CryptoAPI (Crypt32.dll) validates Elliptic Curve
		     Cryptography (ECC) certificates. An attacker could exploit the
		     vulnerability by using a spoofed code-signing certificate to
		     sign a malicious executable, making it appear the file was from
		     a trusted, legitimate source.
	query: 
		     event.provider:"Microsoft-Windows-Audit-CVE" and
		     message:"[CVE-2020-0601]" and host.os.type:windows

NamE: GCP IAM Custom Role Creation
	description: 
		     Identifies an Identity and Access Management
		     (IAM) custom role creation in Google Cloud Platform (GCP).
		     Custom roles are user-defined, and allow for the bundling of
		     one or more supported permissions to meet specific needs.
		     Custom roles will not be updated automatically and could lead
		     to privilege creep if not carefully scrutinized.
	query: 
		     event.dataset:gcp.audit and
		     event.action:google.iam.admin.v*.CreateRole and
		     event.outcome:success

NamE: AWS IAM AdministratorAccess Policy Attached to User
	description: 
		     An adversary with access to a set of compromised
		     credentials may attempt to persist or escalate privileges by
		     attaching additional permissions to compromised user accounts.
		     This rule looks for use of the IAM `AttachUserPolicy` API
		     operation to attach the highly permissive `AdministratorAccess`
		     AWS managed policy to an existing IAM user.
	query: 
		     from logs-aws.cloudtrail-* metadata _id, _version,
		     _index | where event.provider == "iam.amazonaws.com" and
		     event.action == "AttachUserPolicy" and event.outcome ==
		     "success" | dissect aws.cloudtrail.request_parameters "{%{?poli
		     cyArn}=%{?arn}:%{?aws}:%{?iam}::%{?aws}:%{?policy}/%{policyName
		     },%{?userName}=%{target.userName}}" | where policyName ==
		     "AdministratorAccess" | keep     @timestamp,     cloud.region,
		     event.provider,     event.action,     event.outcome,
		     policyName,     target.userName,
		     aws.cloudtrail.request_parameters,
		     aws.cloudtrail.user_identity.arn,     related.user,
		     user_agent.original,     user.name,     source.address

NamE: Tainted Out-Of-Tree Kernel Module Load
	description: 
		     This rule monitors the syslog log file for
		     messages related to instances of a out-of-tree kernel module
		     load, indicating the taining of the kernel. Rootkits often
		     leverage kernel modules as their main defense evasion
		     technique. Detecting tainted kernel module loads is crucial for
		     ensuring system security and integrity, as malicious or
		     unauthorized modules can compromise the kernel and lead to
		     system vulnerabilities or unauthorized access.
	query: 
		     host.os.type:linux and event.dataset:"system.syslog"
		     and process.name:kernel and message:"loading out-of-tree module
		     taints kernel."

NamE: Potential LSASS Memory Dump via PssCaptureSnapShot
	description: 
		     Identifies suspicious access to an LSASS handle
		     via PssCaptureSnapShot where two successive process accesses
		     are performed by the same process and target two different
		     instances of LSASS. This may indicate an attempt to evade
		     detection and dump LSASS memory for credential access.
	query: 
		     event.category:process and host.os.type:windows and
		     event.code:10 and  winlog.event_data.TargetImage:("C:\\Windows\
		     \system32\\lsass.exe" or
		     "c:\\Windows\\system32\\lsass.exe" or
		     "c:\\Windows\\System32\\lsass.exe")

NamE: Interactive Terminal Spawned via Python
	description: 
		     Identifies when a terminal (tty) is spawned via
		     Python. Attackers may upgrade a simple reverse shell to a fully
		     interactive tty after obtaining initial access to a host.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start")
		     and (   (process.parent.name : "python*" and process.name in
		     ("bash", "dash", "ash", "sh", "tcsh", "csh", "zsh", "ksh",
		     "fish") and process.parent.args_count >= 3 and
		     process.parent.args : "*pty.spawn*" and process.parent.args :
		     "-c") or   (process.parent.name : "python*" and process.name in
		     ("bash", "dash", "ash", "sh", "tcsh", "csh", "zsh", "ksh",
		     "fish") and process.args : "*sh" and process.args_count == 1
		     and process.parent.args_count == 1) )

NamE: Code Signing Policy Modification Through Built-in tools
	description: 
		     Identifies attempts to disable/modify the code
		     signing policy through system native utilities. Code signing
		     provides authenticity on a program, and grants the user with
		     the ability to check whether the program has been tampered
		     with. By allowing the execution of unsigned or self-signed
		     code, threat actors can craft and execute malicious code.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (process.name: "bcdedit.exe" or
		     ?process.pe.original_file_name == "bcdedit.exe") and
		     process.args: ("-set", "/set") and    process.args:
		     ("TESTSIGNING", "nointegritychecks", "loadoptions",
		     "DISABLE_INTEGRITY_CHECKS")

NamE: Attempt to Disable Auditd Service
	description: 
		     Adversaries may attempt to disable the Auditd
		     service to evade detection. Auditd is a Linux service that
		     provides system auditing and logging. Disabling the Auditd
		     service can prevent the system from logging important security
		     events, which can be used to detect malicious activity.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2") and (   (process.name == "service" and
		     process.args == "stop") or   (process.name == "chkconfig" and
		     process.args == "off") or   (process.name == "systemctl" and
		     process.args in ("disable", "stop", "kill")) ) and process.args
		     in ("auditd", "auditd.service") and  not process.parent.name ==
		     "auditd.prerm"

NamE: Pluggable Authentication Module (PAM) Creation in Unusual Directory
	description: 
		     This rule detects the creation of Pluggable
		     Authentication Module (PAM) shared object files in unusual
		     directories. Attackers may compile PAM shared object files in
		     temporary directories, to move them to system directories
		     later, potentially allowing them to maintain persistence on a
		     compromised system, or harvest account credentials.
	query: 
		     file where host.os.type == "linux" and event.type ==
		     "creation" and file.name like "pam_*.so" and not file.path like
		     (   "/lib/security/*",   "/lib64/security/*",
		     "/lib/x86_64-linux-gnu/security/*",   "/usr/lib/security/*",
		     "/usr/lib64/security/*",   "/usr/lib/x86_64-linux-
		     gnu/security/*" ) and not (   process.name in ("dockerd",
		     "containerd", "steam", "buildkitd", "unsquashfs", "pacman") or
		     file.path like (     "/build/rootImage/nix/store/*",
		     "/home/*/.local/share/containers/*", "/nix/store/*",
		     "/var/lib/containerd/*",     "/var/snap/*",
		     "/usr/share/nix/nix/store/*", "/tmp/cura/squashfs-root/*",
		     "/home/*/docker/*", "/tmp/containerd*"   ) )

NamE: Unusual Network Activity from a Windows System Binary
	description: 
		     Identifies network activity from unexpected
		     system applications. This may indicate adversarial activity as
		     these applications are often leveraged by adversaries to
		     execute code and evade detection.
	query: 
		     sequence by process.entity_id with maxspan=5m
		     [process where host.os.type == "windows" and event.type ==
		     "start" and       /* known applocker bypasses */
		     (process.name : "bginfo.exe" or       process.name : "cdb.exe"
		     or       process.name : "control.exe" or       process.name :
		     "cmstp.exe" or       process.name : "csi.exe" or
		     process.name : "dnx.exe" or       process.name : "fsi.exe" or
		     process.name : "ieexec.exe" or       process.name :
		     "iexpress.exe" or       process.name : "installutil.exe" or
		     process.name : "Microsoft.Workflow.Compiler.exe" or
		     process.name : "MSBuild.exe" or       process.name : "msdt.exe"
		     or       process.name : "mshta.exe" or       process.name :
		     "wscript.exe" or       process.name : "msiexec.exe" or
		     process.name : "msxsl.exe" or       process.name :
		     "odbcconf.exe" or       process.name : "rcsi.exe" or
		     process.name : "regsvr32.exe" or       process.name :
		     "xwizard.exe")]   [network where      (process.name :
		     "bginfo.exe" or       process.name : "cdb.exe" or
		     process.name : "control.exe" or       process.name :
		     "cmstp.exe" or       process.name : "csi.exe" or
		     process.name : "dnx.exe" or       process.name : "fsi.exe" or
		     process.name : "ieexec.exe" or       process.name :
		     "iexpress.exe" or       process.name : "installutil.exe" or
		     process.name : "Microsoft.Workflow.Compiler.exe" or       (
		     process.name : "msbuild.exe" and           destination.ip !=
		     "127.0.0.1"       ) or       process.name : "msdt.exe" or
		     process.name : "mshta.exe" or       (         process.name :
		     "msiexec.exe" and not         dns.question.name : (
		     "ocsp.digicert.com", "ocsp.verisign.com", "ocsp.comodoca.com",
		     "ocsp.entrust.net", "ocsp.usertrust.com",
		     "ocsp.godaddy.com", "ocsp.camerfirma.com",
		     "ocsp.globalsign.com", "ocsp.sectigo.com", "*.local"         )
		     and         /* Localhost, DigiCert and Comodo CA IP addresses
		     */         not cidrmatch(destination.ip, "127.0.0.1",
		     "192.229.211.108/32", "192.229.221.95/32",
		     "152.195.38.76/32", "104.18.14.101/32")       ) or
		     process.name : "msxsl.exe" or       process.name :
		     "odbcconf.exe" or       process.name : "rcsi.exe" or
		     process.name : "regsvr32.exe" or       process.name :
		     "xwizard.exe") and               not dns.question.name :
		     ("localhost", "setup.officetimeline.com",
		     "us.deployment.endpoint.ingress.rapid7.com",
		     "ctldl.windowsupdate.com", "crl?.digicert.com",
		     "ocsp.digicert.com", "addon-cms-asl.eu.goskope.com",
		     "crls.ssl.com",          "evcs-ocsp.ws.symantec.com",
		     "s.symcd.com", "s?.symcb.com", "crl.verisign.com",
		     "oneocsp.microsoft.com", "crl.verisign.com",          "aka.ms",
		     "crl.comodoca.com", "acroipm2.adobe.com", "sv.symcd.com") and
		     /* host query itself */       not
		     startswith~(dns.question.name, host.name)       ]

NamE: Egress Connection from Entrypoint in Container
	description: 
		     This rule identifies a sequence of events where
		     a process named `entrypoint.sh` is started in a container,
		     followed by a network connection attempt. This sequence
		     indicates a potential egress connection from an entrypoint in a
		     container. An entrypoint is a command or script specified in
		     the Dockerfile and executed when the container starts.
		     Attackers can use this technique to establish a foothold in the
		     environment, escape from a container to the host, or establish
		     persistence.
	query: 
		     sequence by host.id with maxspan=3s   [process where
		     host.os.type == "linux" and event.type == "start" and
		     event.action == "exec" and
		     process.entry_leader.entry_meta.type == "container" and
		     process.name == "entrypoint.sh"] by process.entity_id
		     [network where event.type == "start" and event.action ==
		     "connection_attempted" and not (      destination.ip == null or
		     destination.ip == "0.0.0.0" or cidrmatch(
		     destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16",
		     "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29",
		     "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32",
		     "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24",
		     "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16",
		     "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10",
		     "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24",
		     "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10",
		     "FF00::/8", "172.31.0.0/16"        )     )] by
		     process.parent.entity_id

NamE: Linux init (PID 1) Secret Dump via GDB
	description: 
		     This rule monitors for the potential memory dump
		     of the init process (PID 1) through gdb. Attackers may leverage
		     memory dumping techniques to attempt secret extraction from
		     privileged processes. Tools that display this behavior include
		     "truffleproc" and "bash-memory-dump". This behavior should not
		     happen by default, and should be investigated thoroughly.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2") and process.name == "gdb" and process.args in
		     ("--pid", "-p") and process.args == "1"

NamE: Machine Learning Detected a DNS Request With a High DGA Probability Score
	description: 
		     A supervised machine learning model has
		     identified a DNS question name with a high probability of
		     sourcing from a Domain Generation Algorithm (DGA), which could
		     indicate command and control network activity.
	query: 
		     ml_is_dga.malicious_probability > 0.98

NamE: PowerShell MiniDump Script
	description: 
		     This rule detects PowerShell scripts capable of
		     dumping process memory using WindowsErrorReporting or
		     Dbghelp.dll MiniDumpWriteDump. Attackers can use this tooling
		     to dump LSASS and get access to credentials.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text:(MiniDumpWriteDump or
		     MiniDumpWithFullMemory or pmuDetirWpmuDiniM) and not user.id :
		     "S-1-5-18"

NamE: Suspicious rc.local Error Message
	description: 
		     This rule monitors the syslog log file for error
		     messages related to the rc.local process. The rc.local file is
		     a script that is executed during the boot process on Linux
		     systems. Attackers may attempt to modify the rc.local file to
		     execute malicious commands or scripts during system startup.
		     This rule detects error messages such as "Connection refused,"
		     "No such file or directory," or "command not found" in the
		     syslog log file, which may indicate that the rc.local file has
		     been tampered with.
	query: 
		     host.os.type:linux and event.dataset:system.syslog and
		     process.name:rc.local and message:("Connection refused" or "No
		     such file or directory" or "command not found")

NamE: GCP Service Account Creation
	description: 
		     Identifies when a new service account is created
		     in Google Cloud Platform (GCP). A service account is a special
		     type of account used by an application or a virtual machine
		     (VM) instance, not a person. Applications use service accounts
		     to make authorized API calls, authorized as either the service
		     account itself, or as G Suite or Cloud Identity users through
		     domain-wide delegation. If service accounts are not tracked and
		     managed properly, they can present a security risk. An
		     adversary may create a new service account to use during their
		     operations in order to avoid using a standard user account and
		     attempt to evade detection.
	query: 
		     event.dataset:gcp.audit and
		     event.action:google.iam.admin.v*.CreateServiceAccount and
		     event.outcome:success

NamE: Attempts to Brute Force a Microsoft 365 User Account
	description: 
		     Identifies potential brute-force attempts
		     against Microsoft 365 user accounts by detecting a high number
		     of failed login attempts or login sources within a 30-minute
		     window. Attackers may attempt to brute force user accounts to
		     gain unauthorized access to Microsoft 365 services.
	query: 
		     from logs-o365.audit-* // truncate the timestamp to a
		     30-minute window | eval target_time_window = DATE_TRUNC(30
		     minutes, @timestamp) | mv_expand event.category | where
		     event.dataset == "o365.audit"   and event.category ==
		     "authentication"    // filter only on Entra ID or Exchange
		     audit logs in O365 integration   and event.provider in
		     ("AzureActiveDirectory", "Exchange")    // filter only for
		     UserLoginFailed or partial failures   and event.action in
		     ("UserLoginFailed", "PasswordLogonInitialAuthUsingPassword")
		     // ignore specific logon errors   and not o365.audit.LogonError
		     in (     "EntitlementGrantsNotFound",
		     "UserStrongAuthEnrollmentRequired",
		     "UserStrongAuthClientAuthNRequired",     "InvalidReplyTo",
		     "SsoArtifactExpiredDueToConditionalAccess",
		     "PasswordResetRegistrationRequiredInterrupt",
		     "SsoUserAccountNotFoundInResourceTenant",
		     "UserStrongAuthExpired",     "CmsiInterrupt" )    // ignore
		     unavailable   and o365.audit.UserId != "Not Available"    //
		     filters out non user or application logins based on target
		     and o365.audit.Target.Type in ("0", "2", "3", "5", "6", "10")
		     // filters only for logins from user or application, ignoring
		     oauth:token   and
		     to_lower(o365.audit.ExtendedProperties.RequestType) rlike
		     "(.*)login(.*)"  // keep only relevant fields | keep
		     event.provider, event.dataset, event.category,
		     o365.audit.UserId, event.action, source.ip,
		     o365.audit.LogonError,
		     o365.audit.ExtendedProperties.RequestType,
		     o365.audit.Target.Type, target_time_window  // count the number
		     of login sources and failed login attempts | stats
		     login_source_count = count(source.ip),   failed_login_count =
		     count(*) by target_time_window, o365.audit.UserId  // filter
		     for users with more than 20 login sources or failed login
		     attempts | where (login_source_count >= 20 or
		     failed_login_count >= 20)

NamE: Kubernetes Privileged Pod Created
	description: 
		     This rule detects when a user creates a
		     pod/container running in privileged mode. A highly privileged
		     container has access to the node's resources and breaks the
		     isolation between containers. If compromised, an attacker can
		     use the privileged container to gain access to the underlying
		     host. Gaining access to the host may provide the adversary with
		     the opportunity to achieve follow-on objectives, such as
		     establishing persistence, moving laterally within the
		     environment, or setting up a command and control channel on the
		     host.
	query: 
		     event.dataset : "kubernetes.audit_logs"   and kubernet
		     es.audit.annotations.authorization_k8s_io/decision:"allow"
		     and kubernetes.audit.objectRef.resource:pods   and
		     kubernetes.audit.verb:create   and kubernetes.audit.requestObje
		     ct.spec.containers.securityContext.privileged:true   and not
		     kubernetes.audit.requestObject.spec.containers.image:
		     ("docker.elastic.co/beats/elastic-agent:8.4.0")

NamE: Potential Successful Linux RDP Brute Force Attack Detected
	description: 
		     An RDP (Remote Desktop Protocol) brute force
		     attack involves an attacker repeatedly attempting various
		     username and password combinations to gain unauthorized access
		     to a remote computer via RDP, and if successful, the potential
		     impact can include unauthorized control over the compromised
		     system, data theft, or the ability to launch further attacks
		     within the network, jeopardizing the security and
		     confidentiality of the targeted system and potentially
		     compromising the entire network infrastructure. This rule
		     identifies multiple consecutive authentication failures
		     targeting a specific user account within a short time interval,
		     followed by a successful authentication.
	query: 
		     sequence by host.id, related.user with maxspan=5s
		     [authentication where host.os.type == "linux" and event.action
		     == "authenticated" and    auditd.data.terminal : "*rdp*" and
		     event.outcome == "failure"] with runs=10   [authentication
		     where host.os.type == "linux" and event.action  ==
		     "authenticated" and    auditd.data.terminal : "*rdp*" and
		     event.outcome == "success"] | tail 1

NamE: First Occurrence of Personal Access Token (PAT) Use For a GitHub User
	description: 
		     A new PAT was used for a GitHub user not
		     previously seen in the last 14 days.
	query: 
		     event.dataset:"github.audit" and
		     event.category:"configuration" and github.hashed_token:* and
		     user.name:* and github.programmatic_access_type:("OAuth access
		     token" or "Fine-grained personal access token")

NamE: Git Hook Created or Modified
	description: 
		     This rule detects the creation or modification
		     of a Git hook file on a Linux system. Git hooks are scripts
		     that Git executes before or after events such as commit, push,
		     and receive. They are used to automate tasks, enforce policies,
		     and customize Git's behavior. Attackers can abuse Git hooks to
		     maintain persistence on a system by executing malicious code
		     whenever a specific Git event occurs.
	query: 
		     file where host.os.type == "linux" and event.type ==
		     "creation" and file.path : "*.git/hooks/*" and file.extension
		     == null and process.executable != null and not (
		     process.executable in (     "/bin/dpkg", "/usr/bin/dpkg",
		     "/bin/dockerd", "/usr/bin/dockerd", "/usr/sbin/dockerd",
		     "/bin/microdnf",     "/usr/bin/microdnf", "/bin/rpm",
		     "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd", "/bin/yum",
		     "/usr/bin/yum",     "/bin/dnf", "/usr/bin/dnf", "/bin/podman",
		     "/usr/bin/podman", "/bin/dnf-automatic", "/usr/bin/dnf-
		     automatic",     "/bin/pacman", "/usr/bin/pacman",
		     "/usr/bin/dpkg-divert", "/bin/dpkg-divert", "/sbin/apk",
		     "/usr/sbin/apk",     "/usr/local/sbin/apk", "/usr/bin/apt",
		     "/usr/sbin/pacman", "/bin/podman", "/usr/bin/podman",
		     "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/usr/bin/pamac-
		     daemon", "/bin/pamac-daemon",     "/usr/local/bin/dockerd",
		     "/sbin/dockerd"   ) or   process.executable : ("/nix/store/*",
		     "/var/lib/dpkg/*", "/snap/*", "/dev/fd/*") or   process.name in
		     ("git", "dirname", "tar", "gitea", "git-lfs") or
		     (process.name == "sed" and file.name : "sed*") or
		     (process.name == "perl" and file.name : "e2scrub_all.tmp*") )

NamE: RDP Enabled via Registry
	description: 
		     Identifies registry write modifications to
		     enable Remote Desktop Protocol (RDP) access. This could be
		     indicative of adversary lateral movement preparation.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.path : (
		     "HKLM\\SYSTEM\\*ControlSet*\\Control\\Terminal
		     Server\\fDenyTSConnections",
		     "\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Control\\Terminal
		     Server\\fDenyTSConnections",
		     "MACHINE\\*ControlSet*\\Control\\Terminal
		     Server\\fDenyTSConnections"   ) and   registry.data.strings :
		     ("0", "0x00000000") and   not process.executable :
		     ("?:\\Windows\\System32\\SystemPropertiesRemote.exe",
		     "?:\\Windows\\System32\\SystemPropertiesComputerName.exe",
		     "?:\\Windows\\System32\\SystemPropertiesAdvanced.exe",
		     "?:\\Windows\\System32\\SystemSettingsAdminFlows.exe",
		     "?:\\Windows\\WinSxS\\*\\TiWorker.exe",
		     "?:\\Windows\\system32\\svchost.exe")

NamE: System Service Discovery through built-in Windows Utilities
	description: 
		     Detects the usage of commonly used system
		     service discovery techniques, which attackers may use during
		     the reconnaissance phase after compromising a system in order
		     to gain a better understanding of the environment and/or
		     escalate privileges.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (   ((process.name: "net.exe" or
		     process.pe.original_file_name == "net.exe" or (process.name :
		     "net1.exe" and      not process.parent.name : "net.exe")) and
		     process.args : ("start", "use") and process.args_count == 2) or
		     ((process.name: "sc.exe" or process.pe.original_file_name ==
		     "sc.exe") and process.args: ("query", "q*")) or
		     ((process.name: "tasklist.exe" or process.pe.original_file_name
		     == "tasklist.exe") and process.args: "/svc") or   (process.name
		     : "psservice.exe" or process.pe.original_file_name ==
		     "psservice.exe")   ) and not user.id : "S-1-5-18"

NamE: Finder Sync Plugin Registered and Enabled
	description: 
		     Finder Sync plugins enable users to extend
		     Finder’s functionality by modifying the user interface.
		     Adversaries may abuse this feature by adding a rogue Finder
		     Plugin to repeatedly execute malicious payloads for
		     persistence.
	query: 
		     process where host.os.type == "macos" and event.type
		     in ("start", "process_started") and process.name : "pluginkit"
		     and   process.args : "-e" and process.args : "use" and
		     process.args : "-i" and   not process.args :   (
		     "com.google.GoogleDrive.FinderSyncAPIExtension",
		     "com.google.drivefs.findersync",
		     "com.boxcryptor.osx.Rednif",
		     "com.adobe.accmac.ACCFinderSync",
		     "com.microsoft.OneDrive.FinderSync",
		     "com.insynchq.Insync.Insync-Finder-Integration",
		     "com.box.desktop.findersyncext"   ) and   not
		     process.parent.executable : ("/Library/Application Support/IDri
		     veforMac/IDriveHelperTools/FinderPluginApp.app/Contents/MacOS/F
		     inderPluginApp",
		     "/Applications/Google Drive.app/Contents/MacOS/Google Drive")
		     and   not process.Ext.effective_parent.executable :
		     ("/Applications/Google Drive.app/Contents/MacOS/Google Drive",
		     "/usr/local/jamf/bin/jamf",
		     "/Applications/Nextcloud.app/Contents/MacOS/Nextcloud",
		     "/Library/Application Support/Checkpoint/Endpoint Security/AMFi
		     nderExtensions.app/Contents/MacOS/AMFinderExtensions",
		     "/Applications/pCloud Drive.app/Contents/MacOS/pCloud Drive")

NamE: Executable File Creation with Multiple Extensions
	description: 
		     Masquerading can allow an adversary to evade
		     defenses and better blend in with the environment. One way it
		     occurs is when the name or location of a file is manipulated as
		     a means of tricking a user into executing what they think is a
		     benign file type but is actually executable code.
	query: 
		     file where host.os.type == "windows" and event.type ==
		     "creation" and file.extension : "exe" and   file.name regex~ ""
		     ".*\.(vbs|vbe|bat|js|cmd|wsh|ps1|pdf|docx?|xlsx?|pptx?|txt|rtf|
		     gif|jpg|png|bmp|hta|txt|img|iso)\.exe""" and   not
		     (process.executable : ("?:\\Windows\\System32\\msiexec.exe",
		     "C:\\Users\\*\\QGIS_SCCM\\Files\\QGIS-
		     OSGeo4W-*-Setup-x86_64.exe") and        file.path :
		     "?:\\Program Files\\QGIS *\\apps\\grass\\*.exe")

NamE: Network Activity Detected via Kworker
	description: 
		     This rule monitors for network connections from
		     a kworker process. kworker, or kernel worker, processes are
		     part of the kernel's workqueue mechanism. They are responsible
		     for executing work that has been scheduled to be done in kernel
		     space, which might include tasks like handling interrupts,
		     background activities, and other kernel-related tasks.
		     Attackers may attempt to evade detection by masquerading as a
		     kernel worker process.
	query: 
		     host.os.type:linux and event.category:network and
		     event.action:(connection_attempted or connection_accepted) and
		     process.name:kworker* and not destination.ip:(   10.0.0.0/8 or
		     127.0.0.0/8 or   169.254.0.0/16 or   172.16.0.0/12 or
		     192.168.0.0/16 or   224.0.0.0/4 or   "::1" or   "FE80::/10" or
		     "FF00::/8" or   "0.0.0.0" ) and not destination.port:("2049" or
		     "111" or "892" or "597")

NamE: Administrator Role Assigned to an Okta User
	description: 
		     Identifies when an administrator role is
		     assigned to an Okta user. An adversary may attempt to assign an
		     administrator role to an Okta user in order to assign
		     additional permissions to a user account and maintain access to
		     their target's environment.
	query: 
		     event.dataset:okta.system and
		     event.action:user.account.privilege.grant

NamE: LSASS Memory Dump Handle Access
	description: 
		     Identifies handle requests for the Local
		     Security Authority Subsystem Service (LSASS) object access with
		     specific access masks that many tools with a capability to dump
		     memory to disk use (0x1fffff, 0x1010, 0x120089). This rule is
		     tool agnostic as it has been validated against a host of
		     various LSASS dump tools such as SharpDump, Procdump, Mimikatz,
		     Comsvcs etc. It detects this behavior at a low level and does
		     not depend on a specific tool or dump file name.
	query: 
		     any where event.code == "4656" and
		     winlog.event_data.ObjectName : (
		     "?:\\Windows\\System32\\lsass.exe",
		     "\\Device\\HarddiskVolume?\\Windows\\System32\\lsass.exe",
		     "\\Device\\HarddiskVolume??\\Windows\\System32\\lsass.exe") and
		     /* The right to perform an operation controlled by an extended
		     access right. */      (winlog.event_data.AccessMask :
		     ("0x1fffff" , "0x1010", "0x120089", "0x1F3FFF") or
		     winlog.event_data.AccessMaskDescription : ("READ_CONTROL",
		     "Read from process memory"))       /* Common Noisy False
		     Positives */      and not winlog.event_data.ProcessName : (
		     "?:\\Program Files\\*.exe",         "?:\\Program Files
		     (x86)\\*.exe",
		     "?:\\Windows\\system32\\wbem\\WmiPrvSE.exe",
		     "?:\\Windows\\System32\\dllhost.exe",
		     "?:\\Windows\\System32\\svchost.exe",
		     "?:\\Windows\\System32\\msiexec.exe",
		     "?:\\ProgramData\\Microsoft\\Windows Defender\\*.exe",
		     "?:\\Windows\\explorer.exe",
		     "?:\\Windows\\System32\\poqexec.exe")

NamE: AWS STS Role Chaining
	description: 
		     Identifies role chaining activity. Role chaining
		     is when you use one assumed role to assume a second role
		     through the AWS CLI or API. While this a recognized
		     functionality in AWS, role chaining can be abused for privilege
		     escalation if the subsequent assumed role provides additional
		     privileges. Role chaining can also be used as a persistence
		     mechanism as each AssumeRole action results in a refreshed
		     session token with a 1 hour maximum duration. This rule looks
		     for role chaining activity happening within a single account,
		     to eliminate false positives produced by common cross-account
		     behavior.
	query: 
		     from logs-aws.cloudtrail-* metadata _id, _version,
		     _index  // filter for AssumeRole API calls where access key id
		     is a short term token beginning with ASIA | where event.dataset
		     == "aws.cloudtrail" and event.provider == "sts.amazonaws.com"
		     and event.action == "AssumeRole" and
		     aws.cloudtrail.resources.account_id ==
		     aws.cloudtrail.recipient_account_id and
		     aws.cloudtrail.user_identity.access_key_id like "ASIA*"  //
		     keep only the relevant fields | keep
		     aws.cloudtrail.user_identity.arn, cloud.region,
		     aws.cloudtrail.resources.account_id,
		     aws.cloudtrail.recipient_account_id,
		     aws.cloudtrail.user_identity.access_key_id

NamE: GCP Service Account Deletion
	description: 
		     Identifies when a service account is deleted in
		     Google Cloud Platform (GCP). A service account is a special
		     type of account used by an application or a virtual machine
		     (VM) instance, not a person. Applications use service accounts
		     to make authorized API calls, authorized as either the service
		     account itself, or as G Suite or Cloud Identity users through
		     domain-wide delegation. An adversary may delete a service
		     account in order to disrupt their target's business operations.
	query: 
		     event.dataset:gcp.audit and
		     event.action:google.iam.admin.v*.DeleteServiceAccount and
		     event.outcome:success

NamE: Attempt to Delete an Okta Policy Rule
	description: 
		     Detects attempts to delete a rule within an Okta
		     policy. An adversary may attempt to delete an Okta policy rule
		     in order to weaken an organization's security controls.
	query: 
		     event.dataset:okta.system and
		     event.action:policy.rule.delete

NamE: High Number of Okta User Password Reset or Unlock Attempts
	description: 
		     Identifies a high number of Okta user password
		     reset or account unlock attempts. An adversary may attempt to
		     obtain unauthorized access to Okta user accounts using these
		     methods and attempt to blend in with normal activity in their
		     target's environment and evade detection.
	query: 
		     event.dataset:okta.system and
		     event.action:(system.email.account_unlock.sent_message or
		     system.email.password_reset.sent_message or
		     system.sms.send_account_unlock_message or
		     system.sms.send_password_reset_message or
		     system.voice.send_account_unlock_call or
		     system.voice.send_password_reset_call or
		     user.account.unlock_token)

NamE: User account exposed to Kerberoasting
	description: 
		     Detects when a user account has the
		     servicePrincipalName attribute modified. Attackers can abuse
		     write privileges over a user to configure Service Principle
		     Names (SPNs) so that they can perform Kerberoasting.
		     Administrators can also configure this for legitimate purposes,
		     exposing the account to Kerberoasting.
	query: 
		     event.code:5136 and
		     winlog.event_data.OperationType:"%%14674" and
		     winlog.event_data.ObjectClass:"user" and   winlog.event_data.At
		     tributeLDAPDisplayName:"servicePrincipalName"

NamE: Azure Application Credential Modification
	description: 
		     Identifies when a new credential is added to an
		     application in Azure. An application may use a certificate or
		     secret string to prove its identity when requesting a token.
		     Multiple certificates and secrets can be added for an
		     application and an adversary may abuse this by creating an
		     additional authentication method to evade defenses or persist
		     in an environment.
	query: 
		     event.dataset:azure.auditlogs and
		     azure.auditlogs.operation_name:"Update application -
		     Certificates and secrets management" and event.outcome:(success
		     or Success)

NamE: PowerShell Script with Webcam Video Capture Capabilities
	description: 
		     Detects PowerShell scripts that can be used to
		     record webcam video. Attackers can capture this information to
		     extort or spy on victims.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (
		     "NewFrameEventHandler" or     "VideoCaptureDevice" or
		     "DirectX.Capture.Filters" or     "VideoCompressors" or
		     "Start-WebcamRecorder" or     (
		     ("capCreateCaptureWindowA" or        "capCreateCaptureWindow"
		     or        "capGetDriverDescription") and       ("avicap32.dll"
		     or "avicap32")     )   )

NamE: Suspicious Execution from a Mounted Device
	description: 
		     Identifies when a script interpreter or signed
		     binary is launched via a non-standard working directory. An
		     attacker may use this technique to evade defenses.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and process.executable : "C:\\*" and
		     (process.working_directory : "?:\\" and not
		     process.working_directory: "C:\\") and   process.parent.name :
		     "explorer.exe" and   process.name : ("rundll32.exe",
		     "mshta.exe", "powershell.exe", "pwsh.exe", "cmd.exe",
		     "regsvr32.exe",                   "cscript.exe", "wscript.exe")

NamE: Apple Script Execution followed by Network Connection
	description: 
		     Detects execution via the Apple script
		     interpreter (osascript) followed by a network connection from
		     the same process within a short time period. Adversaries may
		     use malicious scripts for execution and command and control.
	query: 
		     sequence by host.id, process.entity_id with
		     maxspan=30s  [process where host.os.type == "macos" and
		     event.type == "start" and process.name == "osascript"]
		     [network where host.os.type == "macos" and event.type ==
		     "start" and process.name == "osascript" and destination.ip !=
		     "::1" and   not cidrmatch(destination.ip,     "10.0.0.0/8",
		     "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12",
		     "192.0.0.0/24", "192.0.0.0/29", "192.0.0.8/32",
		     "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32",
		     "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24",
		     "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24",
		     "224.0.0.0/4", "100.64.0.0/10", "192.175.48.0/24",
		     "198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24",
		     "240.0.0.0/4", "::1", "FE80::/10", "FF00::/8")]

NamE: VNC (Virtual Network Computing) to the Internet
	description: 
		     This rule detects network events that may
		     indicate the use of VNC traffic to the Internet. VNC is
		     commonly used by system administrators to remotely control a
		     system for maintenance or to use shared resources. It should
		     almost never be directly exposed to the Internet, as it is
		     frequently targeted and exploited by threat actors as an
		     initial access or backdoor vector.
	query: 
		     (event.dataset: network_traffic.flow  or
		     (event.category: (network or network_traffic))) and
		     network.transport:tcp and destination.port >= 5800 and
		     destination.port <= 5810 and   source.ip:(     10.0.0.0/8 or
		     172.16.0.0/12 or     192.168.0.0/16   ) and   not
		     destination.ip:(     10.0.0.0/8 or     127.0.0.0/8 or
		     169.254.0.0/16 or     172.16.0.0/12 or     192.0.0.0/24 or
		     192.0.0.0/29 or     192.0.0.8/32 or     192.0.0.9/32 or
		     192.0.0.10/32 or     192.0.0.170/32 or     192.0.0.171/32 or
		     192.0.2.0/24 or     192.31.196.0/24 or     192.52.193.0/24 or
		     192.168.0.0/16 or     192.88.99.0/24 or     224.0.0.0/4 or
		     100.64.0.0/10 or     192.175.48.0/24 or     198.18.0.0/15 or
		     198.51.100.0/24 or     203.0.113.0/24 or     240.0.0.0/4 or
		     "::1" or     "FE80::/10" or     "FF00::/8"   )

NamE: Potential Okta MFA Bombing via Push Notifications
	description: 
		     Detects when an attacker abuses the Multi-Factor
		     authentication mechanism by repeatedly issuing login requests
		     until the user eventually accepts the Okta push notification.
		     An adversary may attempt to bypass the Okta MFA policies
		     configured for an organization to obtain unauthorized access.
	query: 
		     sequence by okta.actor.id with maxspan=10m
		     [authentication where event.dataset == "okta.system"     and
		     okta.event_type == "user.mfa.okta_verify.deny_push"] with
		     runs=5   until [authentication where event.dataset ==
		     "okta.system"     and (okta.event_type: (
		     "user.authentication.sso",
		     "user.authentication.auth_via_mfa",
		     "user.authentication.verify",       "user.session.start") and
		     okta.outcome.result == "SUCCESS")]

NamE: Microsoft 365 Exchange DLP Policy Removed
	description: 
		     Identifies when a Data Loss Prevention (DLP)
		     policy is removed in Microsoft 365. An adversary may remove a
		     DLP policy to evade existing DLP monitoring.
	query: 
		     event.dataset:o365.audit and event.provider:Exchange
		     and event.category:web and event.action:"Remove-DlpPolicy" and
		     event.outcome:success

NamE: AWS RDS DB Snapshot Shared with Another Account
	description: 
		     Identifies an AWS RDS DB snapshot being shared
		     with another AWS account. DB snapshots contain a full backup of
		     an entire DB instance including sensitive data that can be
		     abused if shared with unauthorized accounts or made public.
		     Adversaries may use snapshots to restore a DB Instance in an
		     environment they control as a means of data exfiltration.
	query: 
		     any where event.dataset == "aws.cloudtrail"     and
		     event.provider == "rds.amazonaws.com"     and event.outcome ==
		     "success"     and event.action in ("ModifyDBSnapshotAttribute",
		     "ModifyDBClusterSnapshotAttribute")     and
		     stringContains(aws.cloudtrail.request_parameters,
		     "attributeName=restore")     and
		     stringContains(aws.cloudtrail.request_parameters,
		     "valuesToAdd=[*]")

NamE: Shadow File Modification by Unusual Process
	description: 
		     This rule monitors for Linux Shadow file
		     modifications. These modifications are indicative of a
		     potential password change or user addition event. Threat actors
		     may attempt to create new users or change the password of a
		     user account to maintain access to a system.
	query: 
		     file where host.os.type == "linux" and event.type ==
		     "change" and event.action == "rename" and file.path ==
		     "/etc/shadow" and file.Ext.original.path != null and  not
		     process.name in (   "usermod", "useradd", "passwd", "chage",
		     "systemd-sysusers", "chpasswd", "userdel", "adduser", "update-
		     passwd", "perl" )

NamE: Masquerading Space After Filename
	description: 
		     This rules identifies a process created from an
		     executable with a space appended to the end of the filename.
		     This may indicate an attempt to masquerade a malicious file as
		     benign to gain user execution. When a space is added to the end
		     of certain files, the OS will execute the file according to
		     it's true filetype instead of it's extension. Adversaries can
		     hide a program's true filetype by changing the extension of the
		     file. They can then add a space to the end of the name so that
		     the OS automatically executes the file when it's double-
		     clicked.
	query: 
		     process where host.os.type:("linux","macos") and
		     event.type == "start" and process.executable regex~
		     """/[a-z0-9\s_\-\\./]+\s""" and not (   process.name in ("ls",
		     "find", "grep", "xkbcomp") or   process.executable like
		     ("/opt/nessus_agent/*", "/opt/gitlab/sv/gitlab-exporter/*",
		     "/tmp/ansible-admin/*") or   process.parent.args in (
		     "./check_rubrik", "/usr/bin/check_mk_agent",
		     "/etc/rubrik/start_stop_bootstrap.sh",
		     "/etc/rubrik/start_stop_agent.sh"   ) )

NamE: Installation of Custom Shim Databases
	description: 
		     Identifies the installation of custom
		     Application Compatibility Shim databases. This Windows
		     functionality has been abused by attackers to stealthily gain
		     persistence and arbitrary code execution in legitimate Windows
		     processes.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and     registry.path : (
		     "HKLM\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\AppCompatFlags\\Custom\\*.sdb",
		     "\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\AppCompatFlags\\Custom\\*.sdb",
		     "MACHINE\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\AppCompatFlags\\Custom\\*.sdb"     ) and
		     not process.executable :                        ("?:\\Program
		     Files
		     (x86)\\DesktopCentral_Agent\\swrepository\\1\\swuploads\\SAP-
		     SLC\\SAPSetupSLC02_14-80001954\\Setup\\NwSapSetup.exe",
		     "?:\\$WINDOWS.~BT\\Sources\\SetupPlatform.exe",
		     "?:\\Program Files
		     (x86)\\SAP\\SAPsetup\\setup\\NwSapSetup.exe",
		     "?:\\Program Files (x86)\\SAP\\SapSetup\\OnRebootSvc\\NWSAPSetu
		     pOnRebootInstSvc.exe",                          "?:\\Program
		     Files (x86)\\Kaspersky Lab\\Kaspersky Security for Windows
		     Server\\kavfs.exe")

NamE: Network Connection via Recently Compiled Executable
	description: 
		     This rule monitors a sequence involving a
		     program compilation event followed by its execution and a
		     subsequent network connection event. This behavior can indicate
		     the set up of a reverse tcp connection to a command-and-control
		     server. Attackers may spawn reverse shells to establish
		     persistence onto a target system.
	query: 
		     sequence by host.id with maxspan=1m   [process where
		     host.os.type == "linux" and event.type == "start" and
		     event.action == "exec" and    process.name in ("gcc", "g++",
		     "cc")] by process.args   [file where host.os.type == "linux"
		     and event.action == "creation" and process.name == "ld"] by
		     file.name   [process where host.os.type == "linux" and
		     event.type == "start" and event.action == "exec"] by
		     process.name   [network where host.os.type == "linux" and
		     event.action == "connection_attempted" and destination.ip !=
		     null and not (      cidrmatch(destination.ip, "127.0.0.0/8",
		     "169.254.0.0/16", "224.0.0.0/4", "::1") or      process.name in
		     ("simpleX", "conftest", "ssh", "python", "ispnull", "pvtui",
		     "npreal2d", "ruby", "source", "ssh")    )] by process.name

NamE: Suspicious ScreenConnect Client Child Process
	description: 
		     Identifies suspicious processes being spawned by
		     the ScreenConnect client processes. This activity may indicate
		     execution abusing unauthorized access to the ScreenConnect
		     remote access software.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.name :
		     ("ScreenConnect.ClientService.exe",
		     "ScreenConnect.WindowsClient.exe",
		     "ScreenConnect.WindowsBackstageShell.exe",
		     "ScreenConnect.WindowsFileManager.exe") and   (
		     (process.name : "powershell.exe" and     process.args :
		     ("-enc", "-ec", "-e", "*downloadstring*",
		     "*Reflection.Assembly*", "*http*")) or    (process.name :
		     "cmd.exe" and process.args : "/c") or    (process.name :
		     "net.exe" and process.args : "/add") or    (process.name :
		     "schtasks.exe" and process.args : ("/create", "-create")) or
		     (process.name : "sc.exe" and process.args : "create") or
		     (process.name : "rundll32.exe" and not process.args :
		     "url.dll,FileProtocolHandler") or    (process.name :
		     "msiexec.exe" and process.args : ("/i", "-i") and
		     process.args : ("/q", "/quiet", "/qn", "-q", "-quiet", "-qn",
		     "-Q+")) or    process.name : ("mshta.exe", "certutil.exe",
		     "bistadmin.exe", "certreq.exe", "wscript.exe", "cscript.exe",
		     "curl.exe",                    "ssh.exe", "scp.exe",
		     "wevtutil.exe", "wget.exe", "wmic.exe")    )

NamE: GitHub PAT Access Revoked
	description: 
		     Access to private GitHub organization resources
		     was revoked for a PAT.
	query: 
		     configuration where event.dataset == "github.audit"
		     and event.action == "personal_access_token.access_revoked"

NamE: Loadable Kernel Module Configuration File Creation
	description: 
		     This rule detects the creation of Loadable
		     Kernel Module (LKM) configuration files. Attackers may create
		     or modify these files to allow their LKMs to be loaded upon
		     reboot, ensuring persistence on a compromised system.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("rename", "creation") and process.executable != null and
		     file.path like~ (   "/etc/modules", "/etc/modprobe.d/*",
		     "/usr/lib/modprobe.d/*", "/etc/modules-load.d/*",
		     "/run/modules-load.d/*", "/usr/local/lib/modules-load.d/*",
		     "/usr/lib/modules-load.d/*" ) and not (   process.executable in
		     (     "/bin/dpkg", "/usr/bin/dpkg", "/bin/dockerd",
		     "/usr/bin/dockerd", "/usr/sbin/dockerd", "/bin/microdnf",
		     "/usr/bin/microdnf", "/bin/rpm", "/usr/bin/rpm", "/bin/snapd",
		     "/usr/bin/snapd", "/bin/yum", "/usr/bin/yum",     "/bin/dnf",
		     "/usr/bin/dnf", "/bin/podman", "/usr/bin/podman", "/bin/dnf-
		     automatic", "/usr/bin/dnf-automatic",     "/bin/pacman",
		     "/usr/bin/pacman", "/usr/bin/dpkg-divert", "/bin/dpkg-divert",
		     "/sbin/apk", "/usr/sbin/apk",     "/usr/local/sbin/apk",
		     "/usr/bin/apt", "/usr/sbin/pacman", "/bin/podman",
		     "/usr/bin/podman", "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/local/bin/dockerd", "/opt/elasticbeanstalk/bin/platform-
		     engine",     "/opt/puppetlabs/puppet/bin/ruby",
		     "/usr/libexec/platform-python",
		     "/opt/imunify360/venv/bin/python3",
		     "/opt/eset/efs/lib/utild", "/usr/sbin/anacron",
		     "/usr/bin/podman", "/kaniko/kaniko-executor", "/usr/bin/prime-
		     select"   ) or   file.extension in ("swp", "swpx", "swx",
		     "dpkg-remove") or   file.Ext.original.extension == "dpkg-new"
		     or   process.executable like (     "/nix/store/*",
		     "/var/lib/dpkg/info/kmod.postinst", "/tmp/vmis.*", "/snap/*",
		     "/dev/fd/*",     "/usr/libexec/platform-python*"   ) or
		     process.executable == null or   process.name in (     "crond",
		     "executor", "puppet", "droplet-agent.postinst", "cf-agent",
		     "schedd", "imunify-notifier", "perl",     "jumpcloud-agent",
		     "crio", "dnf_install", "utild"   ) or   (process.name == "sed"
		     and file.name : "sed*") or   (process.name == "perl" and
		     file.name : "e2scrub_all.tmp*") )

NamE: MsiExec Service Child Process With Network Connection
	description: 
		     Identifies the execution of an MsiExec service
		     child process followed by network or dns lookup activity.
		     Adversaries may abuse Windows Installers for initial access and
		     delivery of malware.
	query: 
		     sequence by process.entity_id with maxspan=1m
		     [process where host.os.type == "windows" and event.type :
		     "start" and   process.parent.name : "msiexec.exe" and
		     process.parent.args : "/v" and   not process.executable :
		     ("?:\\Windows\\System32\\msiexec.exe",
		     "?:\\Windows\\sysWOW64\\msiexec.exe",
		     "?:\\Windows\\system32\\srtasks.exe",
		     "?:\\Windows\\syswow64\\srtasks.exe",
		     "?:\\Windows\\sys*\\taskkill.exe",          "?:\\Program
		     Files\\*.exe",          "?:\\Program Files (x86)\\*.exe",
		     "?:\\Windows\\Installer\\MSI*.tmp",
		     "?:\\Windows\\Microsoft.NET\\Framework*\\RegSvcs.exe") and  not
		     (process.name : ("rundll32.exe", "regsvr32.exe") and
		     process.args : ("?:\\Program Files\\*", "?:\\Program Files
		     (x86)\\*"))] [any where host.os.type == "windows" and
		     event.category in ("network", "dns") and process.name != null]

NamE: Command Execution via ForFiles
	description: 
		     Detects attempts to execute a command via the
		     forfiles Windows utility. Adversaries may use this utility to
		     proxy execution via a trusted parent process.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  (process.name : "forfiles.exe" or
		     ?process.pe.original_file_name == "forfiles.exe") and
		     process.args : ("/c", "-c")

NamE: Kubernetes Pod Created With HostPID
	description: 
		     This rule detects an attempt to create or modify
		     a pod attached to the host PID namespace. HostPID allows a pod
		     to access all the processes running on the host and could allow
		     an attacker to take malicious action. When paired with ptrace
		     this can be used to escalate privileges outside of the
		     container. When paired with a privileged container, the pod can
		     see all of the processes on the host. An attacker can enter the
		     init system (PID 1) on the host. From there, they could execute
		     a shell and continue to escalate privileges to root.
	query: 
		     event.dataset : "kubernetes.audit_logs"   and kubernet
		     es.audit.annotations.authorization_k8s_io/decision:"allow"
		     and kubernetes.audit.objectRef.resource:"pods"   and
		     kubernetes.audit.verb:("create" or "update" or "patch")   and
		     kubernetes.audit.requestObject.spec.hostPID:true   and not
		     kubernetes.audit.requestObject.spec.containers.image:
		     ("docker.elastic.co/beats/elastic-agent:8.4.0")

NamE: AWS IAM Group Deletion
	description: 
		     Identifies the deletion of a specified AWS
		     Identity and Access Management (IAM) resource group. Deleting a
		     resource group does not delete resources that are members of
		     the group; it only deletes the group structure.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:iam.amazonaws.com and event.action:DeleteGroup
		     and event.outcome:success

NamE: Roshal Archive (RAR) or PowerShell File Downloaded from the Internet
	description: 
		     Detects a Roshal Archive (RAR) file or
		     PowerShell script downloaded from the internet by an internal
		     host. Gaining initial access to a system and then downloading
		     encoded or encrypted tools to move laterally is a common
		     practice for adversaries as a way to protect their more
		     valuable tools and tactics, techniques, and procedures (TTPs).
		     This may be atypical behavior for a managed network and can be
		     indicative of malware, exfiltration, or command and control.
	query: 
		     (event.dataset: (network_traffic.http or
		     network_traffic.tls) or   (event.category: (network or
		     network_traffic) and network.protocol: http)) and
		     (url.extension:(ps1 or rar) or url.path:(*.ps1 or *.rar)) and
		     not destination.ip:(       10.0.0.0/8 or       127.0.0.0/8 or
		     169.254.0.0/16 or       172.16.0.0/12 or       192.0.0.0/24 or
		     192.0.0.0/29 or       192.0.0.8/32 or       192.0.0.9/32 or
		     192.0.0.10/32 or       192.0.0.170/32 or       192.0.0.171/32
		     or       192.0.2.0/24 or       192.31.196.0/24 or
		     192.52.193.0/24 or       192.168.0.0/16 or       192.88.99.0/24
		     or       224.0.0.0/4 or       100.64.0.0/10 or
		     192.175.48.0/24 or       198.18.0.0/15 or       198.51.100.0/24
		     or       203.0.113.0/24 or       240.0.0.0/4 or       "::1" or
		     "FE80::/10" or       "FF00::/8"     ) and     source.ip:(
		     10.0.0.0/8 or       172.16.0.0/12 or       192.168.0.0/16     )

NamE: Azure Active Directory High Risk User Sign-in Heuristic
	description: 
		     Identifies high risk Azure Active Directory (AD)
		     sign-ins by leveraging Microsoft Identity Protection machine
		     learning and heuristics.
	query: 
		     event.dataset:azure.signinlogs and   azure.signinlogs.
		     properties.risk_state:("confirmedCompromised" or "atRisk") and
		     event.outcome:(success or Success)

NamE: AWS EC2 Instance Interaction with IAM Service
	description: 
		     Identifies when an EC2 instance interacts with
		     the AWS IAM service via an assumed role. This is uncommon
		     behavior and could indicate an attacker using compromised
		     credentials to further exploit an environment. For example, an
		     assumed role could be used to create new users for persistence
		     or add permissions for privilege escalation. An EC2 instance
		     assumes a role using their EC2 ID as the session name. This
		     rule looks for the pattern "i-" which is the beginning pattern
		     for assumed role sessions started by an EC2 instance. This is a
		     [building block](https://www.elastic.co/guide/en/security/curre
		     nt/building-block-rule.html) rule and does not generate alerts
		     on its own. It is meant to be used for correlation with other
		     rules to detect suspicious activity.
	query: 
		     any where event.dataset == "aws.cloudtrail"     and
		     event.provider == "iam.amazonaws.com"     and
		     aws.cloudtrail.user_identity.type == "AssumedRole"     and
		     stringContains(user.id, ":i-")     and (
		     startsWith(event.action, "Update")             or
		     startsWith(event.action, "Attach")             or
		     startsWith(event.action, "Detach")             or
		     startsWith(event.action, "Create")             or
		     startsWith(event.action, "Delete")             or
		     startsWith(event.action, "Add")             or
		     startsWith(event.action, "Remove")             or
		     startsWith(event.action, "Put")             or
		     startsWith(event.action, "Tag")     )

NamE: Permission Theft - Prevented - Elastic Endgame
	description: 
		     Elastic Endgame prevented Permission Theft.
		     Click the Elastic Endgame icon in the event.module column or
		     the link in the rule.reference column for additional
		     information.
	query: 
		     event.kind:alert and event.module:endgame and
		     endgame.metadata.type:prevention and
		     (event.action:token_protection_event or
		     endgame.event_subtype_full:token_protection_event)

NamE: Sensitive Privilege SeEnableDelegationPrivilege assigned to a User
	description: 
		     Identifies the assignment of the
		     SeEnableDelegationPrivilege sensitive "user right" to a user.
		     The SeEnableDelegationPrivilege "user right" enables computer
		     and user accounts to be trusted for delegation. Attackers can
		     abuse this right to compromise Active Directory accounts and
		     elevate their privileges.
	query: 
		     event.code:4704 and winlog.event_data.PrivilegeList:"S
		     eEnableDelegationPrivilege"

NamE: AWS WAF Access Control List Deletion
	description: 
		     Identifies the deletion of a specified AWS Web
		     Application Firewall (WAF) access control list.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.action:DeleteWebACL and event.outcome:success

NamE: Privilege Escalation via Named Pipe Impersonation
	description: 
		     Identifies a privilege escalation attempt via
		     named pipe impersonation. An adversary may abuse this technique
		     by utilizing a framework such Metasploit's meterpreter
		     getsystem command.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  (process.name : ("Cmd.Exe", "PowerShell.EXE")
		     or ?process.pe.original_file_name in ("Cmd.Exe",
		     "PowerShell.EXE")) and  process.args : "echo" and process.args
		     : ">" and process.args : "\\\\.\\pipe\\*"

NamE: MsBuild Making Network Connections
	description: 
		     Identifies MsBuild.exe making outbound network
		     connections. This may indicate adversarial activity as MsBuild
		     is often leveraged by adversaries to execute code and evade
		     detection.
	query: 
		     sequence by process.entity_id with maxspan=30s    /*
		     Look for MSBuild.exe process execution */   /* The events for
		     this first sequence may be noisy, consider adding exceptions */
		     [process where host.os.type == "windows" and event.type ==
		     "start" and     (       process.pe.original_file_name:
		     "MSBuild.exe" or       process.name: "MSBuild.exe"     ) and
		     not user.id == "S-1-5-18"]    /* Followed by a network
		     connection to an external address */   /* Exclude domains that
		     are known to be benign */   [network where host.os.type ==
		     "windows" and     event.action: ("connection_attempted",
		     "lookup_requested") and     (
		     process.pe.original_file_name: "MSBuild.exe" or
		     process.name: "MSBuild.exe"     ) and     not user.id ==
		     "S-1-5-18" and     not cidrmatch(destination.ip, "127.0.0.1",
		     "::1") and     not dns.question.name : (       "localhost",
		     "dc.services.visualstudio.com",
		     "vortex.data.microsoft.com",       "api.nuget.org")]

NamE: Persistence via PowerShell profile
	description: 
		     Identifies the creation or modification of a
		     PowerShell profile. PowerShell profile is a script that is
		     executed when PowerShell starts to customize the user
		     environment, which can be abused by attackers to persist in a
		     environment where PowerShell is common.
	query: 
		     file where host.os.type == "windows" and event.type !=
		     "deletion" and   file.path :
		     ("?:\\Users\\*\\Documents\\WindowsPowerShell\\*",
		     "?:\\Users\\*\\Documents\\PowerShell\\*",
		     "?:\\Windows\\System32\\WindowsPowerShell\\*") and   file.name
		     : ("profile.ps1", "Microsoft.Powershell_profile.ps1")

NamE: Process Discovery Using Built-in Tools
	description: 
		     This rule identifies the execution of commands
		     that can be used to enumerate running processes. Adversaries
		     may enumerate processes to identify installed applications and
		     security solutions.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and process.args != null and   (     process.name
		     :("PsList.exe", "qprocess.exe") or     (process.name :
		     "powershell.exe" and process.args : ("*get-process*",
		     "*Win32_Process*")) or     (process.name : "wmic.exe" and
		     process.args : ("process", "*Win32_Process*")) or
		     (process.name : "tasklist.exe" and not process.args : ("pid
		     eq*")) or    (process.name : "query.exe" and process.args :
		     "process")   ) and not user.id : "S-1-5-18"

NamE: Persistence via TelemetryController Scheduled Task Hijack
	description: 
		     Detects the successful hijack of Microsoft
		     Compatibility Appraiser scheduled task to establish persistence
		     with an integrity level of system.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.name : "CompatTelRunner.exe"
		     and process.args : "-cv*" and   not process.name :
		     ("conhost.exe",                       "DeviceCensus.exe",
		     "CompatTelRunner.exe",                       "DismHost.exe",
		     "rundll32.exe",                       "powershell.exe")

NamE: Unusual Discovery Signal Alert with Unusual Process Command Line
	description: 
		     This rule leverages alert data from various
		     Discovery building block rules to alert on signals with unusual
		     unique host.id, user.id and process.command_line entries.
	query: 
		     host.os.type:windows and event.kind:signal and
		     kibana.alert.rule.rule_id:(
		     "d68e95ad-1c82-4074-a12a-125fe10ac8ba" or
		     "7b8bfc26-81d2-435e-965c-d722ee397ef1" or
		     "0635c542-1b96-4335-9b47-126582d2c19a" or
		     "6ea55c81-e2ba-42f2-a134-bccf857ba922" or
		     "e0881d20-54ac-457f-8733-fe0bc5d44c55" or
		     "06568a02-af29-4f20-929c-f3af281e41aa" or
		     "c4e9ed3e-55a2-4309-a012-bc3c78dad10a" or
		     "51176ed2-2d90-49f2-9f3d-17196428b169" )

NamE: Potential Privilege Escalation via Sudoers File Modification
	description: 
		     A sudoers file specifies the commands users or
		     groups can run and from which terminals. Adversaries can take
		     advantage of these configurations to execute commands as other
		     users or spawn processes with higher privileges.
	query: 
		     event.category:process and event.type:start and
		     process.args:(echo and *NOPASSWD*ALL*)

NamE: Unusual File Creation - Alternate Data Stream
	description: 
		     Identifies suspicious creation of Alternate Data
		     Streams on highly targeted files. This is uncommon for
		     legitimate files and sometimes done by adversaries to hide
		     malware.
	query: 
		     file where host.os.type == "windows" and event.type ==
		     "creation" and    file.path : "C:\\*:*" and   not file.path :
		     ("C:\\*:zone.identifier*",            "C:\\users\\*\\appdata\\r
		     oaming\\microsoft\\teams\\old_weblogs_*:$DATA",
		     "C:\\Windows\\CSC\\*:CscBitmapStream") and    not
		     process.executable : (           "?:\\Program Files
		     (x86)\\Dropbox\\Client\\Dropbox.exe",           "?:\\Program
		     Files (x86)\\Google\\Chrome\\Application\\chrome.exe",
		     "?:\\Program Files (x86)\\Microsoft
		     Office\\root\\*\\EXCEL.EXE",           "?:\\Program Files
		     (x86)\\Microsoft Office\\root\\*\\OUTLOOK.EXE",
		     "?:\\Program Files (x86)\\Microsoft
		     Office\\root\\*\\POWERPNT.EXE",           "?:\\Program Files
		     (x86)\\Microsoft Office\\root\\*\\WINWORD.EXE",
		     "?:\\Program Files
		     (x86)\\Microsoft\\Edge\\Application\\msedge.exe",
		     "?:\\Program
		     Files\\ExpressConnect\\ExpressConnectNetworkService.exe",
		     "?:\\Program Files\\Google\\Chrome\\Application\\chrome.exe",
		     "?:\\Program Files\\Microsoft Office\\root\\*\\EXCEL.EXE",
		     "?:\\Program Files\\Microsoft Office\\root\\*\\OUTLOOK.EXE",
		     "?:\\Program Files\\Microsoft Office\\root\\*\\POWERPNT.EXE",
		     "?:\\Program Files\\Microsoft Office\\root\\*\\WINWORD.EXE",
		     "?:\\Program Files\\Mozilla Firefox\\firefox.exe",
		     "?:\\Program Files\\Rivet
		     Networks\\SmartByte\\SmartByteNetworkService.exe",
		     "?:\\Windows\\explorer.exe",
		     "?:\\Windows\\System32\\DataExchangeHost.exe",           "?:\\W
		     indows\\System32\\drivers\\Intel\\ICPS\\IntelConnectivityNetwor
		     kService.exe",           "?:\\Windows\\System32\\drivers\\Rivet
		     Networks\\Killer\\KillerNetworkService.exe",
		     "?:\\Windows\\System32\\inetsrv\\w3wp.exe",
		     "?:\\Windows\\System32\\PickerHost.exe",
		     "?:\\Windows\\System32\\RuntimeBroker.exe",
		     "?:\\Windows\\System32\\SearchProtocolHost.exe",
		     "?:\\Windows\\System32\\sihost.exe",
		     "?:\\windows\\System32\\svchost.exe"   ) and    file.extension
		     :     (       "pdf", "dll", "exe", "dat", "com", "bat", "cmd",
		     "sys", "vbs", "ps1", "hta", "txt", "vbe", "js",       "wsh",
		     "docx", "doc", "xlsx", "xls", "pptx", "ppt", "rtf", "gif",
		     "jpg", "png", "bmp", "img", "iso"     )

NamE: Suspicious which Enumeration
	description: 
		     This rule monitors for the usage of the which
		     command with an unusual amount of process arguments. Attackers
		     may leverage the which command to enumerate the system for
		     useful installed utilities that may be used after compromising
		     a system to escalate privileges or move latteraly across the
		     network.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start") and   process.name == "which" and process.args_count
		     >= 10 and not (     process.parent.name == "jem" or
		     process.parent.executable like ("/vz/root/*",
		     "/var/lib/docker/*") or     process.args == "--tty-only"   )
		     /* potential tuning if rule would turn out to be noisy and
		     process.args in ("nmap", "nc", "ncat", "netcat",
		     nc.traditional", "gcc", "g++", "socat") and process.parent.name
		     in ("bash", "dash", "ash", "sh", "tcsh", "csh", "zsh", "ksh",
		     "fish") */

NamE: Potential Sudo Privilege Escalation via CVE-2019-14287
	description: 
		     This rule monitors for the execution of a
		     suspicious sudo command that is leveraged in CVE-2019-14287 to
		     escalate privileges to root. Sudo does not verify the presence
		     of the designated user ID and proceeds to execute using a user
		     ID that can be chosen arbitrarily. By using the sudo
		     privileges, the command "sudo -u#-1" translates to an ID of 0,
		     representing the root user. This exploit may work for sudo
		     versions prior to v1.28.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2", "executed", "process_started") and
		     process.name == "sudo" and process.args == "-u#-1"

NamE: Installation of Security Support Provider
	description: 
		     Identifies registry modifications related to the
		     Windows Security Support Provider (SSP) configuration.
		     Adversaries may abuse this to establish persistence in an
		     environment.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and    registry.path : (
		     "HKLM\\SYSTEM\\*ControlSet*\\Control\\Lsa\\Security Packages*",
		     "HKLM\\SYSTEM\\*ControlSet*\\Control\\Lsa\\OSConfig\\Security
		     Packages*",       "\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\C
		     ontrol\\Lsa\\Security Packages*",       "\\REGISTRY\\MACHINE\\S
		     YSTEM\\*ControlSet*\\Control\\Lsa\\OSConfig\\Security
		     Packages*",
		     "MACHINE\\SYSTEM\\*ControlSet*\\Control\\Lsa\\Security
		     Packages*",       "MACHINE\\SYSTEM\\*ControlSet*\\Control\\Lsa\
		     \OSConfig\\Security Packages*"    ) and    not
		     process.executable : ("C:\\Windows\\System32\\msiexec.exe",
		     "C:\\Windows\\SysWOW64\\msiexec.exe")

NamE: Execution with Explicit Credentials via Scripting
	description: 
		     Identifies execution of the
		     security_authtrampoline process via a scripting interpreter.
		     This occurs when programs use AuthorizationExecute-
		     WithPrivileges from the Security.framework to run another
		     program with root privileges. It should not be run by itself,
		     as this is a sign of execution with explicit logon credentials.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:(start or process_started) and
		     process.name:"security_authtrampoline" and
		     process.parent.name:(osascript or com.apple.automator.runner or
		     sh or bash or dash or zsh or python* or Python or perl* or php*
		     or ruby or pwsh)

NamE: Potential Successful SSH Brute Force Attack
	description: 
		     Identifies multiple SSH login failures followed
		     by a successful one from the same source address. Adversaries
		     can attempt to login into multiple users with a common or known
		     password to gain access to accounts.
	query: 
		     sequence by host.id, source.ip, user.name with
		     maxspan=15s   [authentication where host.os.type == "linux" and
		     event.action  in ("ssh_login", "user_login") and
		     event.outcome == "failure" and source.ip != null and source.ip
		     != "0.0.0.0" and source.ip != "::" ] with runs=10
		     [authentication where host.os.type == "linux" and event.action
		     in ("ssh_login", "user_login") and    event.outcome ==
		     "success" and source.ip != null and source.ip != "0.0.0.0" and
		     source.ip != "::" ]

NamE: AWS STS AssumeRoot by Rare User and Member Account
	description: 
		     Identifies when the STS `AssumeRoot` action is
		     performed by a rare user in AWS. The AssumeRoot action allows
		     users to assume the root member account role, granting elevated
		     but specific permissions based on the task policy specified.
		     Adversaries whom may have compromised user credentials, such as
		     access and secret keys, can use this technique to escalate
		     privileges and gain unauthorized access to AWS resources. This
		     is a [New
		     Terms](https://www.elastic.co/guide/en/security/current/rules-
		     ui-create.html#create-new-terms-rule) rule that identifies when
		     the STS `AssumeRoot` action is performed by a user that rarely
		     assumes this role and specific member account.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "sts.amazonaws.com"     and event.action:
		     "AssumeRoot"     and event.outcome: "success"

NamE: At Job Created or Modified
	description: 
		     This rule monitors for at jobs being created or
		     renamed. Linux at jobs are scheduled tasks that can be
		     leveraged by system administrators to set up scheduled tasks,
		     but may be abused by malicious actors for persistence,
		     privilege escalation and command execution. By creating or
		     modifying cron job configurations, attackers can execute
		     malicious commands or scripts at predefined intervals, ensuring
		     their continued presence and enabling unauthorized activities.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("rename", "creation") and file.path :
		     "/var/spool/cron/atjobs/*" and not (   process.executable in (
		     "/bin/dpkg", "/usr/bin/dpkg", "/bin/dockerd",
		     "/usr/bin/dockerd", "/usr/sbin/dockerd", "/bin/microdnf",
		     "/usr/bin/microdnf", "/bin/rpm", "/usr/bin/rpm", "/bin/snapd",
		     "/usr/bin/snapd", "/bin/yum", "/usr/bin/yum",     "/bin/dnf",
		     "/usr/bin/dnf", "/bin/podman", "/usr/bin/podman", "/bin/dnf-
		     automatic", "/usr/bin/dnf-automatic",     "/bin/pacman",
		     "/usr/bin/pacman", "/usr/bin/dpkg-divert", "/bin/dpkg-divert",
		     "/sbin/apk", "/usr/sbin/apk",     "/usr/local/sbin/apk",
		     "/usr/bin/apt", "/usr/sbin/pacman", "/bin/podman",
		     "/usr/bin/podman", "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/local/bin/dockerd"   ) or   file.extension in ("swp",
		     "swpx", "swx", "dpkg-remove") or   file.Ext.original.extension
		     == "dpkg-new" or   process.executable : ("/nix/store/*",
		     "/var/lib/dpkg/*", "/tmp/vmis.*", "/snap/*", "/dev/fd/*") or
		     process.executable == null or   (process.name == "sed" and
		     file.name : "sed*") or   (process.name == "perl" and file.name
		     : "e2scrub_all.tmp*") )

NamE: Statistical Model Detected C2 Beaconing Activity with High Confidence
	description: 
		     A statistical model has identified command-and-
		     control (C2) beaconing activity with high confidence. Beaconing
		     can help attackers maintain stealthy communication with their
		     C2 servers, receive instructions and payloads, exfiltrate data
		     and maintain persistence in a network.
	query: 
		     beacon_stats.beaconing_score: 3

NamE: Privilege Escalation via Windir Environment Variable
	description: 
		     Identifies a privilege escalation attempt via a
		     rogue Windows directory (Windir) environment variable. This is
		     a known primitive that is often combined with other
		     vulnerabilities to elevate privileges.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and registry.value : ("windir",
		     "systemroot") and registry.path : (
		     "HKEY_USERS\\*\\Environment\\windir",
		     "HKEY_USERS\\*\\Environment\\systemroot",
		     "HKU\\*\\Environment\\windir",
		     "HKU\\*\\Environment\\systemroot",
		     "HKCU\\*\\Environment\\windir",
		     "HKCU\\*\\Environment\\systemroot",
		     "\\REGISTRY\\USER\\*\\Environment\\windir",
		     "\\REGISTRY\\USER\\*\\Environment\\systemroot",
		     "USER\\*\\Environment\\windir",
		     "USER\\*\\Environment\\systemroot"     ) and  not
		     registry.data.strings : ("C:\\windows", "%SystemRoot%")

NamE: Suspicious Script Object Execution
	description: 
		     Identifies scrobj.dll loaded into unusual
		     Microsoft processes. This usually means a malicious scriptlet
		     is being executed in the target process.
	query: 
		     any where host.os.type == "windows" and
		     (event.category : ("library", "driver") or (event.category ==
		     "process" and event.action : "Image loaded*")) and  (?dll.name
		     : "scrobj.dll" or ?file.name : "scrobj.dll") and
		     process.executable : ("?:\\Windows\\System32\\*.exe",
		     "?:\\Windows\\SysWOW64\\*.exe") and  not process.executable : (
		     "?:\\Windows\\System32\\cscript.exe",
		     "?:\\Windows\\SysWOW64\\cscript.exe",
		     "?:\\Windows\\system32\\msiexec.exe",
		     "?:\\Windows\\SysWOW64\\msiexec.exe",
		     "?:\\Windows\\System32\\smartscreen.exe",
		     "?:\\Windows\\system32\\taskhostw.exe",
		     "?:\\windows\\system32\\inetsrv\\w3wp.exe",
		     "?:\\windows\\SysWOW64\\inetsrv\\w3wp.exe",
		     "?:\\Windows\\system32\\wscript.exe",
		     "?:\\Windows\\SysWOW64\\wscript.exe",
		     "?:\\Windows\\System32\\mshta.exe",
		     "?:\\Windows\\system32\\mobsync.exe",
		     "?:\\Windows\\SysWOW64\\mobsync.exe",
		     "?:\\Windows\\System32\\cmd.exe",
		     "?:\\Windows\\SysWOW64\\cmd.exe",
		     "?:\\Windows\\System32\\OpenWith.exe",
		     "?:\\Windows\\System32\\wbem\\WMIADAP.exe",        "?:\\Windows
		     \\System32\\WindowsPowerShell\\v1.0\\powershell.exe")

NamE: GCP Firewall Rule Creation
	description: 
		     Identifies when a firewall rule is created in
		     Google Cloud Platform (GCP) for Virtual Private Cloud (VPC) or
		     App Engine. These firewall rules can be configured to allow or
		     deny connections to or from virtual machine (VM) instances or
		     specific applications. An adversary may create a new firewall
		     rule in order to weaken their target's security controls and
		     allow more permissive ingress or egress traffic flows for their
		     benefit.
	query: 
		     event.dataset:gcp.audit and
		     event.action:(*.compute.firewalls.insert or
		     google.appengine.*.Firewall.Create*Rule)

NamE: File Creation Time Changed
	description: 
		     Identifies modification of a file creation time.
		     Adversaries may modify file time attributes to blend malicious
		     content with existing files. Timestomping is a technique that
		     modifies the timestamps of a file often to mimic files that are
		     in trusted directories.
	query: 
		     file where host.os.type == "windows" and
		     event.provider == "Microsoft-Windows-Sysmon" and   /* File
		     creation time change */   event.code == "2" and   not
		     process.executable :            ("?:\\Program Files\\*",
		     "?:\\Program Files (x86)\\*",
		     "?:\\Windows\\system32\\cleanmgr.exe",
		     "?:\\Windows\\system32\\msiexec.exe",
		     "?:\\Windows\\syswow64\\msiexec.exe",
		     "?:\\Windows\\system32\\svchost.exe",
		     "?:\\WINDOWS\\system32\\backgroundTaskHost.exe",             "?
		     :\\Users\\*\\AppData\\Local\\Google\\Chrome\\Application\\chrom
		     e.exe",             "?:\\Users\\*\\AppData\\Local\\Mozilla
		     Firefox\\firefox.exe",
		     "?:\\Users\\*\\AppData\\Local\\slack\\app-*\\slack.exe",
		     "?:\\Users\\*\\AppData\\Local\\GitHubDesktop\\app-
		     *\\GitHubDesktop.exe",             "?:\\Users\\*\\AppData\\Loca
		     l\\Microsoft\\Teams\\current\\Teams.exe",             "?:\\User
		     s\\*\\AppData\\Local\\Microsoft\\OneDrive\\OneDrive.exe") and
		     not file.extension : ("temp", "tmp", "~tmp", "xml", "newcfg")
		     and not user.name : ("SYSTEM", "Local Service", "Network
		     Service") and   not file.name : ("LOG", "temp-index",
		     "license.rtf", "iconcache_*.db")

NamE: Unsigned DLL loaded by DNS Service
	description: 
		     Identifies unusual DLLs loaded by the DNS Server
		     process, potentially indicating the abuse of the
		     ServerLevelPluginDll functionality. This can lead to privilege
		     escalation and remote code execution with SYSTEM privileges.
	query: 
		     any where host.os.type == "windows" and event.category
		     : ("library", "process") and   event.type : ("start", "change")
		     and event.action : ("load", "Image loaded*") and
		     process.executable : "?:\\windows\\system32\\dns.exe" and   not
		     ?dll.code_signature.trusted == true and   not
		     file.code_signature.status == "Valid"

NamE: Network Connection via Compiled HTML File
	description: 
		     Compiled HTML files (.chm) are commonly
		     distributed as part of the Microsoft HTML Help system.
		     Adversaries may conceal malicious code in a CHM file and
		     deliver it to a victim for execution. CHM content is loaded by
		     the HTML Help executable program (hh.exe).
	query: 
		     sequence by process.entity_id   [process where
		     host.os.type == "windows" and process.name : "hh.exe" and
		     event.type == "start"]   [network where host.os.type ==
		     "windows" and process.name : "hh.exe" and      not
		     cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8",
		     "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24",
		     "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32",
		     "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32",
		     "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24",
		     "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4",
		     "100.64.0.0/10", "192.175.48.0/24","198.18.0.0/15",
		     "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1",
		     "FE80::/10", "FF00::/8") and      not dns.question.name :
		     "localhost"]

NamE: Potential Windows Error Manager Masquerading
	description: 
		     Identifies suspicious instances of the Windows
		     Error Reporting process (WerFault.exe or Wermgr.exe) with
		     matching command-line and process executable values performing
		     outgoing network connections. This may be indicative of a
		     masquerading attempt to evade suspicious child process behavior
		     detections.
	query: 
		     sequence by host.id, process.entity_id with maxspan =
		     5s   [process where host.os.type == "windows" and
		     event.type:"start" and process.name : ("wermgr.exe",
		     "WerFault.exe") and process.args_count == 1]   [network where
		     host.os.type == "windows" and process.name : ("wermgr.exe",
		     "WerFault.exe") and network.protocol != "dns" and
		     network.direction : ("outgoing", "egress") and destination.ip
		     !="::1" and destination.ip !="127.0.0.1"   ]

NamE: Windows Script Executing PowerShell
	description: 
		     Identifies a PowerShell process launched by
		     either cscript.exe or wscript.exe. Observing Windows scripting
		     processes executing a PowerShell script, may be indicative of
		     malicious activity.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.name : ("cscript.exe",
		     "wscript.exe") and process.name : "powershell.exe" and   not (
		     process.parent.name : "wscript.exe" and     process.parent.args
		     : "?:\\ProgramData\\intune-drive-mapping-
		     generator\\IntuneDriveMapping-VBSHelper.vbs" and
		     process.parent.args : "?:\\ProgramData\\intune-drive-mapping-
		     generator\\DriveMapping.ps1"   )

NamE: AWS EC2 Network Access Control List Deletion
	description: 
		     Identifies the deletion of an Amazon Elastic
		     Compute Cloud (EC2) network access control list (ACL) or one of
		     its ingress/egress entries.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:ec2.amazonaws.com and
		     event.action:(DeleteNetworkAcl or DeleteNetworkAclEntry) and
		     event.outcome:success

NamE: Active Directory Group Modification by SYSTEM
	description: 
		     Identifies a user being added to an active
		     directory group by the SYSTEM (S-1-5-18) user. This behavior
		     can indicate that the attacker has achieved SYSTEM privileges
		     in a domain controller, which attackers can obtain by
		     exploiting vulnerabilities or abusing default group privileges
		     (e.g., Server Operators), and is attempting to pivot to a
		     domain account.
	query: 
		     iam where winlog.api == "wineventlog" and event.code
		     == "4728" and winlog.event_data.SubjectUserSid : "S-1-5-18" and
		     /* DOMAIN_USERS and local groups */ not group.id :
		     "S-1-5-21-*-513"

NamE: AWS ElastiCache Security Group Created
	description: 
		     Identifies when an ElastiCache security group
		     has been created.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:elasticache.amazonaws.com and
		     event.action:"Create Cache Security Group" and
		     event.outcome:success

NamE: Suspicious Windows Command Shell Arguments
	description: 
		     Identifies the execution of the Windows Command
		     Shell process (cmd.exe) with suspicious argument values. This
		     behavior is often observed during malware installation.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  process.name : "cmd.exe" and  (
		     process.command_line : ("*).Run(*", "*GetObject*", "*
		     curl*regsvr32*", "*echo*wscript*", "*echo*ZONE.identifier*",
		     "*ActiveXObject*", "*dir /s /b *echo*", "*unescape(*",
		     "*findstr*TVNDRgAAAA*", "*findstr*passw*",
		     "*start*\\\\*\\DavWWWRoot\\*",   "* explorer*%CD%*",
		     "*%cd%\\*.js*", "*attrib*%CD%*", "*/?cMD<*",
		     "*/AutoIt3ExecuteScript*..*", "*&cls&cls&cls&cls&cls&*",
		     "*&#*;&#*;&#*;&#*;*", "* &&s^eT*", "*& ChrW(*", "*&explorer
		     /root*", "*start __ & __\\*", "*findstr /V /L *forfiles*",
		     "*=wscri& set *", "*http*!COmpUternaME!*", "*start *.pdf *
		     start /min cmd.exe /c *\\\\*", "*pip
		     install*System.Net.WebClient*",   "*Invoke-WebReques*Start-
		     Process*", "*-command (Invoke-webrequest*", "*copy /b *\\\\*
		     ping *-n*", "*echo*.ToCharArray*") or    (process.args : "echo"
		     and process.parent.name : ("wscript.exe", "mshta.exe")) or
		     process.args : ("1>?:\\*.vbs", "1>?:\\*.js") or
		     (process.args : "explorer.exe" and process.args : "type" and
		     process.args : ">" and process.args : "start") or
		     (process.parent.name : "explorer.exe" and
		     process.command_line :            ("*&&S^eT *",
		     "*&& set *&& set *&& set *&& set *&& set *&& call*",
		     "**\\u00??\\u00??\\u00??\\u00??\\u00??\\u00??\\u00??\\u00??*"))
		     or     (process.parent.name : "explorer.exe" and process.args :
		     "copy" and process.args : "&&" and process.args : "\\\\*@*\\*")
		     ) and    /* false positives */   not (process.args :
		     "%TEMP%\\Spiceworks\\*" and process.parent.name :
		     "wmiprvse.exe") and   not process.parent.executable :
		     ("?:\\Perl64\\bin\\perl.exe",                  "?:\\Program
		     Files\\nodejs\\node.exe",                  "?:\\Program
		     Files\\HP\\RS\\pgsql\\bin\\pg_dumpall.exe",
		     "?:\\Program Files (x86)\\PRTG Network Monitor\\64 bit\\PRTG
		     Server.exe",                  "?:\\Program Files
		     (x86)\\Spiceworks\\bin\\spiceworks-finder.exe",
		     "?:\\Program Files (x86)\\Zuercher
		     Suite\\production\\leds\\leds.exe",
		     "?:\\Program
		     Files\\Tripwire\\Agent\\Plugins\\twexec\\twexec.exe",
		     "D:\\Agents\\?\\_work\\_tasks\\*\\SonarScanner.MSBuild.exe",
		     "?:\\Program Files\\Microsoft VS Code\\Code.exe",
		     "?:\\programmiweb\\NetBeans-*\\netbeans\\bin\\netbeans64.exe",
		     "?:\\Program Files (x86)\\Public Safety Suite
		     Professional\\production\\leds\\leds.exe",
		     "?:\\Program Files (x86)\\Tier2Tickets\\button_gui.exe",
		     "?:\\Program Files\\NetBeans-*\\netbeans\\bin\\netbeans*.exe",
		     "?:\\Program Files (x86)\\Public Safety Suite
		     Professional\\production\\leds\\leds.exe",
		     "?:\\Program Files (x86)\\Tier2Tickets\\button_gui.exe",
		     "?:\\Program Files (x86)\\Helpdesk Button\\button_gui.exe",
		     "?:\\VTSPortable\\VTS\\jre\\bin\\javaw.exe",
		     "?:\\Program Files\\Bot Framework Composer\\Bot Framework
		     Composer.exe",                  "?:\\Program Files\\KMSYS
		     Worldwide\\eQuate\\*\\SessionMgr.exe",
		     "?:\\Program Files (x86)\\Craneware\\Pricing
		     Analyzer\\Craneware.Pricing.Shell.exe",
		     "?:\\Program Files (x86)\\jumpcloud-agent-app\\jumpcloud-agent-
		     app.exe",                  "?:\\Program
		     Files\\PostgreSQL\\*\\bin\\pg_dumpall.exe",
		     "?:\\Program Files (x86)\\Vim\\vim*\\vimrun.exe") and   not
		     (process.args :  "?:\\Program Files\\Citrix\\Secure Access
		     Client\\nsauto.exe" and process.parent.name : "userinit.exe")
		     and   not process.args :             ("?:\\Program Files
		     (x86)\\PCMatic\\PCPitstopScheduleService.exe",
		     "?:\\Program Files (x86)\\AllesTechnologyAgent\\*",
		     "https://auth.axis.com/oauth2/oauth-authorize*") and   not
		     process.command_line :                ("\"cmd\" /c
		     %NETBEANS_MAVEN_COMMAND_LINE%",
		     "?:\\Windows\\system32\\cmd.exe /q /d /s /c \"npm.cmd
		     ^\"install^\" ^\"--no-bin-links^\" ^\"--production^\"\"") and
		     not (process.name : "cmd.exe" and process.args :
		     "%TEMP%\\Spiceworks\\*" and process.args :
		     "http*/dataloader/persist_netstat_data") and   not
		     (process.args == "echo" and process.args == "GEQ" and
		     process.args == "1073741824")

NamE: RPC (Remote Procedure Call) to the Internet
	description: 
		     This rule detects network events that may
		     indicate the use of RPC traffic to the Internet. RPC is
		     commonly used by system administrators to remotely control a
		     system for maintenance or to use shared resources. It should
		     almost never be directly exposed to the Internet, as it is
		     frequently targeted and exploited by threat actors as an
		     initial access or backdoor vector.
	query: 
		     (event.dataset: network_traffic.flow or
		     (event.category: (network or network_traffic))) and
		     network.transport:tcp and (destination.port:135 or
		     event.dataset:zeek.dce_rpc) and   source.ip:(     10.0.0.0/8 or
		     172.16.0.0/12 or     192.168.0.0/16   ) and   not
		     destination.ip:(     10.0.0.0/8 or     127.0.0.0/8 or
		     169.254.0.0/16 or     172.16.0.0/12 or     192.0.0.0/24 or
		     192.0.0.0/29 or     192.0.0.8/32 or     192.0.0.9/32 or
		     192.0.0.10/32 or     192.0.0.170/32 or     192.0.0.171/32 or
		     192.0.2.0/24 or     192.31.196.0/24 or     192.52.193.0/24 or
		     192.168.0.0/16 or     192.88.99.0/24 or     224.0.0.0/4 or
		     100.64.0.0/10 or     192.175.48.0/24 or     198.18.0.0/15 or
		     198.51.100.0/24 or     203.0.113.0/24 or     240.0.0.0/4 or
		     "::1" or     "FE80::/10" or     "FF00::/8"   )

NamE: Unknown Execution of Binary with RWX Memory Region
	description: 
		     Monitors for the execution of a previously
		     unknown unix binary with read, write and execute memory region
		     permissions. The mprotect() system call is used to change the
		     access protections on a region of memory that has already been
		     allocated. This syscall allows a process to modify the
		     permissions of pages in its virtual address space, enabling or
		     disabling permissions such as read, write, and execute for
		     those pages. RWX permissions on memory is in many cases overly
		     permissive, and should be analyzed thoroughly.
	query: 
		     event.category:process and host.os.type:linux and
		     auditd.data.syscall:mprotect and auditd.data.a2:7 and not (
		     process.executable:(     "/usr/share/kibana/node/bin/node" or
		     "/usr/share/elasticsearch/jdk/bin/java" or "/usr/sbin/apache2"
		     ) or   process.name:(httpd or java) )

NamE: SUNBURST Command and Control Activity
	description: 
		     The malware known as SUNBURST targets the
		     SolarWind's Orion business software for command and control.
		     This rule detects post-exploitation command and control
		     activity of the SUNBURST backdoor.
	query: 
		     network where host.os.type == "windows" and event.type
		     == "protocol" and network.protocol == "http" and   process.name
		     : ("ConfigurationWizard.exe",
		     "NetFlowService.exe",
		     "NetflowDatabaseMaintenance.exe",
		     "SolarWinds.Administration.exe",
		     "SolarWinds.BusinessLayerHost.exe",
		     "SolarWinds.BusinessLayerHostx64.exe",
		     "SolarWinds.Collector.Service.exe",
		     "SolarwindsDiagnostics.exe") and   (     (
		     (http.request.body.content : "*/swip/Upload.ashx*" and
		     http.request.body.content : ("POST*", "PUT*")) or
		     (http.request.body.content : ("*/swip/SystemDescription*",
		     "*/swip/Events*") and http.request.body.content : ("GET*",
		     "HEAD*"))     ) and     not http.request.body.content :
		     "*solarwinds.com*"   )

NamE: Suspicious ImagePath Service Creation
	description: 
		     Identifies the creation of a suspicious
		     ImagePath value. This could be an indication of an adversary
		     attempting to stealthily persist or escalate privileges through
		     abnormal service creation.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.value : "ImagePath" and
		     registry.path : (
		     "HKLM\\SYSTEM\\ControlSet*\\Services\\*\\ImagePath",     "\\REG
		     ISTRY\\MACHINE\\SYSTEM\\ControlSet*\\Services\\*\\ImagePath"
		     ) and   /* add suspicious registry ImagePath values here */
		     registry.data.strings : ("%COMSPEC%*", "*\\.\\pipe\\*")

NamE: Persistence via Update Orchestrator Service Hijack
	description: 
		     Identifies potential hijacking of the Microsoft
		     Update Orchestrator Service to establish persistence with an
		     integrity level of SYSTEM.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.executable :
		     "C:\\Windows\\System32\\svchost.exe" and   process.parent.args
		     : "UsoSvc" and   not process.executable :           ("?:\\Progr
		     amData\\Microsoft\\Windows\\UUS\\Packages\\*\\amd64\\MoUsoCoreW
		     orker.exe",           "?:\\Windows\\System32\\UsoClient.exe",
		     "?:\\Windows\\System32\\MusNotification.exe",
		     "?:\\Windows\\System32\\MusNotificationUx.exe",
		     "?:\\Windows\\System32\\MusNotifyIcon.exe",
		     "?:\\Windows\\System32\\WerFault.exe",
		     "?:\\Windows\\System32\\WerMgr.exe",
		     "?:\\Windows\\UUS\\amd64\\MoUsoCoreWorker.exe",
		     "?:\\Windows\\System32\\MoUsoCoreWorker.exe",
		     "?:\\Windows\\UUS\\amd64\\UsoCoreWorker.exe",
		     "?:\\Windows\\System32\\UsoCoreWorker.exe",
		     "?:\\Program Files\\Common Files\\microsoft
		     shared\\ClickToRun\\OfficeC2RClient.exe") and   not
		     process.name : ("MoUsoCoreWorker.exe", "OfficeC2RClient.exe")

NamE: AWS S3 Bucket Server Access Logging Disabled
	description: 
		     Identifies when server access logging is
		     disabled for an Amazon S3 bucket. Server access logs provide a
		     detailed record of requests made to an S3 bucket. When server
		     access logging is disabled for a bucket, it could indicate an
		     adversary's attempt to impair defenses by disabling logs that
		     contain evidence of malicious activity.
	query: 
		     any where event.dataset == "aws.cloudtrail"    and
		     event.action == "PutBucketLogging"    and event.outcome ==
		     "success"    and not
		     stringContains(aws.cloudtrail.request_parameters,
		     "LoggingEnabled")

NamE: Attempt to Modify an Okta Policy
	description: 
		     Detects attempts to modify an Okta policy. An
		     adversary may attempt to modify an Okta policy in order to
		     weaken an organization's security controls. For example, an
		     adversary may attempt to modify an Okta multi-factor
		     authentication (MFA) policy in order to weaken the
		     authentication requirements for user accounts.
	query: 
		     event.dataset:okta.system and
		     event.action:policy.lifecycle.update

NamE: Suspicious Browser Child Process
	description: 
		     Identifies the execution of a suspicious browser
		     child process. Adversaries may gain access to a system through
		     a user visiting a website over the normal course of browsing.
		     With this technique, the user's web browser is typically
		     targeted for exploitation.
	query: 
		     process where host.os.type == "macos" and event.type
		     in ("start", "process_started") and   process.parent.name :
		     ("Google Chrome", "Google Chrome Helper*", "firefox", "Opera",
		     "Safari", "com.apple.WebKit.WebContent", "Microsoft Edge") and
		     process.name : ("sh", "bash", "dash", "ksh", "tcsh", "zsh",
		     "curl", "wget", "python*", "perl*", "php*", "osascript",
		     "pwsh") and   process.command_line != null and   not
		     process.command_line : "*/Library/Application
		     Support/Microsoft/MAU*/Microsoft
		     AutoUpdate.app/Contents/MacOS/msupdate*" and   not process.args
		     :     (       "hw.model",       "IOPlatformExpertDevice",
		     "/Volumes/Google Chrome/Google
		     Chrome.app/Contents/Frameworks/*/Resources/install.sh",
		     "/Applications/Google Chrome.app/Contents/Frameworks/Google
		     Chrome Framework.framework/Versions/*/Helpers/Google Chrome
		     Helper (Renderer).app/Contents/MacOS/Google Chrome Helper
		     (Renderer)",
		     "/Applications/Firefox.app/Contents/MacOS/plugin-
		     container.app/Contents/MacOS/plugin-container",       "--
		     defaults-torrc",       "*Chrome.app",       "Framework.framewor
		     k/Versions/*/Resources/keystone_promote_preflight.sh",
		     "/Users/*/Library/Application
		     Support/Google/Chrome/recovery/*/ChromeRecovery",
		     "$DISPLAY",       "*GIO_LAUNCHED_DESKTOP_FILE_PID=$$*",
		     "/opt/homebrew/*",       "/usr/local/*brew*"     )

NamE: Incoming Execution via PowerShell Remoting
	description: 
		     Identifies remote execution via Windows
		     PowerShell remoting. Windows PowerShell remoting allows a user
		     to run any Windows PowerShell command on one or more remote
		     computers. This could be an indication of lateral movement.
	query: 
		     sequence by host.id with maxspan = 30s    [network
		     where host.os.type == "windows" and network.direction :
		     ("incoming", "ingress") and destination.port in (5985, 5986)
		     and     network.protocol == "http" and source.ip != "127.0.0.1"
		     and source.ip != "::1"]    [process where host.os.type ==
		     "windows" and     event.type == "start" and process.parent.name
		     : "wsmprovhost.exe" and not process.executable :
		     "?:\\Windows\\System32\\conhost.exe"]

NamE: SSH Key Generated via ssh-keygen
	description: 
		     This rule identifies the creation of SSH keys
		     using the ssh-keygen tool, which is the standard utility for
		     generating SSH keys. Users often create SSH keys for
		     authentication with remote services. However, threat actors can
		     exploit this tool to move laterally across a network or
		     maintain persistence by generating unauthorized SSH keys,
		     granting them SSH access to systems.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("creation", "file_create_event") and process.executable ==
		     "/usr/bin/ssh-keygen" and file.path : ("/home/*/.ssh/*",
		     "/root/.ssh/*", "/etc/ssh/*") and not file.name :
		     "known_hosts.*"

NamE: Creation or Modification of Domain Backup DPAPI private key
	description: 
		     Identifies the creation or modification of
		     Domain Backup private keys. Adversaries may extract the Data
		     Protection API (DPAPI) domain backup key from a Domain
		     Controller (DC) to be able to decrypt any domain user master
		     key file.
	query: 
		     file where host.os.type == "windows" and event.type !=
		     "deletion" and file.name : ("ntds_capi_*.pfx",
		     "ntds_capi_*.pvk")

NamE: AWS RDS DB Instance or Cluster Password Modified
	description: 
		     Identifies the modification of the master
		     password for an AWS RDS DB instance or cluster. DB instances
		     may contain sensitive data that can be abused if accessed by
		     unauthorized actors. Amazon RDS API operations never return the
		     password, so this operation provides a means to regain access
		     if the password is lost. Adversaries with the proper
		     permissions can take advantage of this to evade defenses and
		     gain unauthorized access to a DB instance or cluster to support
		     persistence mechanisms or privilege escalation.
	query: 
		     any where event.dataset == "aws.cloudtrail"     and
		     event.provider == "rds.amazonaws.com"     and event.action in
		     ("ModifyDBInstance", "ModifyDBCluster")     and event.outcome
		     == "success"     and
		     stringContains(aws.cloudtrail.request_parameters,
		     "masterUserPassword=*")

NamE: AWS IAM Roles Anywhere Trust Anchor Created with External CA
	description: 
		     Identifies when an AWS IAM Roles Anywhere Trust
		     Anchor with an external certificate authority is created. AWS
		     Roles Anywhere profiles are legitimate profiles that can be
		     created by administrators to allow access from any location.
		     This rule detects when a trust anchor is created with an
		     external certificate authority that is not managed by AWS
		     Certificate Manager Private Certificate Authority (ACM PCA).
		     Adversaries may accomplish this to maintain persistence in the
		     environment.
	query: 
		     event.dataset: aws.cloudtrail     and event.provider:
		     rolesanywhere.amazonaws.com     and event.action:
		     CreateTrustAnchor     and event.outcome: success     and not
		     aws.cloudtrail.request_parameters: *sourceType=AWS_ACM_PCA*

NamE: Rapid Secret Retrieval Attempts from AWS SecretsManager
	description: 
		     This rule attempts to identify rapid secret
		     retrieval attempts from AWS SecretsManager. Adversaries may
		     attempt to retrieve secrets from the Secrets Manager
		     programmatically using the `GetSecretValue` or
		     `BatchGetSecretValue` API actions.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:secretsmanager.amazonaws.com and
		     event.action: (GetSecretValue or BatchGetSecretValue) and
		     event.outcome:success and     not user_agent.name: ("Chrome" or
		     "Firefox" or "Safari" or "Edge" or "Brave" or "Opera")

NamE: AWS S3 Unauthenticated Bucket Access by Rare Source
	description: 
		     Identifies AWS CloudTrail events where an
		     unauthenticated source is attempting to access an S3 bucket.
		     This activity may indicate a misconfigured S3 bucket policy
		     that allows public access to the bucket, potentially exposing
		     sensitive data to unauthorized users. Adversaries can specify
		     `--no-sign-request` in the AWS CLI to retrieve objects from an
		     S3 bucket without authentication. This is a [New
		     Terms](https://www.elastic.co/guide/en/security/current/rules-
		     ui-create.html#create-new-terms-rule) rule, which means it will
		     only trigger once for each unique value of the `source.address`
		     field that has not been seen making this API request within the
		     last 7 days. This field contains the IP address of the source
		     making the request.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "s3.amazonaws.com"     and event.action: (
		     "GetObject" or         "PutObject" or         "ListObjects" or
		     "DeleteObject" or         "ListBucket")     and event.outcome:
		     "success"     and aws.cloudtrail.user_identity.type:
		     ("AWSAccount" or "Unknown")     and cloud.account.id:
		     "anonymous"

NamE: Downloaded URL Files
	description: 
		     Identifies .url shortcut files downloaded from
		     outside the local network. These shortcut files are commonly
		     used in phishing campaigns.
	query: 
		     file where host.os.type == "windows" and event.type ==
		     "creation" and file.extension == "url"    and
		     file.Ext.windows.zone_identifier > 1 and not process.name :
		     "explorer.exe"

NamE: Potential Linux Ransomware Note Creation Detected
	description: 
		     This rule identifies a sequence of a mass file
		     encryption event in conjunction with the creation of a .txt
		     file with a file name containing ransomware keywords executed
		     by the same process in a 1 second timespan. Ransomware is a
		     type of malware that encrypts a victim's files or systems and
		     demands payment (usually in cryptocurrency) in exchange for the
		     decryption key. One important indicator of a ransomware attack
		     is the mass encryption of the file system, after which a new
		     file extension is added to the file.
	query: 
		     sequence by process.entity_id, host.id with maxspan=1s
		     [file where host.os.type == "linux" and event.type == "change"
		     and event.action == "rename" and file.extension : "?*"    and
		     process.executable : ("./*", "/tmp/*", "/var/tmp/*",
		     "/dev/shm/*", "/var/run/*", "/boot/*") and    file.path : (
		     "/home/*/Downloads/*", "/home/*/Documents/*", "/root/*",
		     "/bin/*", "/usr/bin/*", "/var/log/*", "/var/lib/log/*",
		     "/var/backup/*", "/var/www/*") and    not process.name : (
		     "dpkg", "yum", "dnf", "rpm", "dockerd", "go", "java", "pip*",
		     "python*", "node", "containerd", "php", "p4d",      "conda",
		     "chrome", "imap", "cmake", "firefox", "semanage", "semodule",
		     "ansible-galaxy", "fc-cache", "jammy", "git",
		     "systemsettings", "vmis-launcher", "bundle", "kudu-tserver",
		     "suldownloader", "rustup-init", "bun"     )   ] with runs=25
		     [file where host.os.type == "linux" and event.action ==
		     "creation" and    file.name : ("*restore*", "*lock*",
		     "*recovery*", "*read*", "*instruction*", "*how_to*",
		     "*ransom*")   ]

NamE: Python Path File (pth) Creation
	description: 
		     This rule detects the creation of .pth files in
		     system-wide and user-specific Python package directories, which
		     can be abused for persistent code execution. .pth files
		     automatically execute Python code when the interpreter starts,
		     making them a stealthy persistence mechanism. Monitoring these
		     paths helps identify unauthorized modifications that could
		     indicate persistence by an attacker or malicious package
		     injection.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("creation", "rename") and file.extension == "pth" and
		     file.path like~ (   "/usr/local/lib/python*/dist-packages/*",
		     "/usr/lib/python*/dist-packages/*",
		     "/usr/local/lib/python*/site-packages/*",
		     "/usr/lib/python*/site-packages/*",
		     "/home/*/.local/lib/python*/site-packages/*",
		     "/opt/*/lib/python*/site-packages/*" ) and process.executable
		     != null and not (   process.executable in (
		     "/usr/local/bin/pip2", "/usr/bin/restic", "/usr/bin/pacman",
		     "/usr/bin/dockerd", "/usr/local/bin/pip3",     "/usr/bin/pip3",
		     "/usr/local/bin/pip", "/usr/bin/pip", "/usr/bin/podman",
		     "/usr/local/bin/poetry",     "/usr/bin/poetry",
		     "/usr/bin/pamac-daemon", "/opt/venv/bin/pip", "/usr/bin/dnf",
		     "./venv/bin/pip",     "/usr/bin/dnf5", "/bin/dnf5", "/bin/pip",
		     "/bin/podman"   ) or   process.executable like~ (
		     "/usr/bin/python*", "/usr/local/bin/python*",
		     "/opt/venv/bin/python*",
		     "/nix/store/*libexec/docker/dockerd", "/snap/docker/*dockerd"
		     ) )

NamE: Hidden Directory Creation via Unusual Parent
	description: 
		     This rule detects the creation of a hidden
		     directory via an unusual parent executable. Hidden directories
		     are directories that are not visible to the user by default.
		     They are often used by attackers to hide malicious files or
		     tools.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "start", "exec_event")
		     and process.name == "mkdir" and process.parent.executable like
		     (   "/dev/shm/*", "/tmp/*", "/var/tmp/*", "/var/run/*",
		     "/root/*", "/boot/*", "/var/www/html/*", "/opt/.*" ) and
		     process.args like (".*", "/*/.*") and process.args_count <= 3
		     and not (   process.parent.executable like ("/tmp/newroot/*",
		     "/run/containerd/*") or   process.command_line like ("mkdir -p
		     .", "mkdir ./*") or   process.args == "/root/.ssh" or
		     process.parent.executable like (     "/tmp/pear/temp/*",
		     "/var/tmp/buildah*", "/tmp/python-build.*", "/tmp/cliphist-
		     wofi-img", "/tmp/snap.rootfs_*"   ) )

NamE: Executable Masquerading as Kernel Process
	description: 
		     Monitors for kernel processes with associated
		     process executable fields that are not empty. Unix kernel
		     processes such as kthreadd and kworker typically do not have
		     process.executable fields associated to them. Attackers may
		     attempt to hide their malicious programs by masquerading as
		     legitimate kernel processes.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2") and process.name : ("kworker*", "kthread*")
		     and process.executable != null

NamE: Bash Shell Profile Modification
	description: 
		     Both ~/.bash_profile and ~/.bashrc are files
		     containing shell commands that are run when Bash is invoked.
		     These files are executed in a user's context, either
		     interactively or non-interactively, when a user logs in so that
		     their environment is set correctly. Adversaries may abuse this
		     to establish persistence by executing malicious content
		     triggered by a user’s shell.
	query: 
		     event.category:file and event.type:change and
		     process.name:(* and not (sudo or vim or zsh or env or nano or
		     bash or Terminal or xpcproxy or login or cat or cp or
		     launchctl or java or dnf or tailwatchd or ldconfig or yum or
		     semodule or cpanellogd or dockerd or authselect or chmod or
		     dnf-automatic or git or dpkg or platform-python)) and   not
		     process.executable:(/Applications/* or /private/var/folders/*
		     or /usr/local/* or /opt/saltstack/salt/bin/*) and
		     file.path:(/private/etc/rc.local or              /etc/rc.local
		     or              /home/*/.profile or
		     /home/*/.profile1 or              /home/*/.bash_profile or
		     /home/*/.bash_profile1 or              /home/*/.bashrc or
		     /Users/*/.bash_profile or              /Users/*/.zshenv)

NamE: Suspicious Cmd Execution via WMI
	description: 
		     Identifies suspicious command execution (cmd)
		     via Windows Management Instrumentation (WMI) on a remote host.
		     This could be indicative of adversary lateral movement.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  process.parent.name : "WmiPrvSE.exe" and
		     process.name : "cmd.exe" and  process.args : "\\\\127.0.0.1\\*"
		     and process.args : ("2>&1", "1>")

NamE: Unusual Service Host Child Process - Childless Service
	description: 
		     Identifies unusual child processes of Service
		     Host (svchost.exe) that traditionally do not spawn any child
		     processes. This may indicate a code injection or an equivalent
		     form of exploitation.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.name : "svchost.exe" and    /*
		     based on svchost service arguments -s svcname where the service
		     is known to be childless */   process.parent.args : (
		     "WdiSystemHost", "LicenseManager", "StorSvc", "CDPSvc",
		     "cdbhsvc", "BthAvctpSvc", "SstpSvc", "WdiServiceHost",
		     "imgsvc", "TrkWks", "WpnService", "IKEEXT", "PolicyAgent",
		     "CryptSvc", "netprofm", "ProfSvc", "StateRepository",
		     "camsvc", "LanmanWorkstation", "NlaSvc", "EventLog", "hidserv",
		     "DisplayEnhancementService", "ShellHWDetection",
		     "AppHostSvc", "fhsvc", "CscService", "PushToInstall"   ) and
		     /* unknown FPs can be added here */   not process.name :
		     ("WerFault.exe", "WerFaultSecure.exe", "wermgr.exe") and   not
		     (process.executable : "?:\\Windows\\System32\\RelPost.exe" and
		     process.parent.args : "WdiSystemHost") and   not (
		     process.name : "rundll32.exe" and     process.args : "?:\\WINDO
		     WS\\System32\\winethc.dll,ForceProxyDetectionOnNextRun" and
		     process.parent.args : "WdiServiceHost"   ) and   not (
		     process.executable : (       "?:\\Program Files\\*",
		     "?:\\Program Files (x86)\\*",
		     "?:\\Windows\\System32\\Kodak\\kds_?????\\lib\\lexexe.exe"
		     ) and process.parent.args : "imgsvc"   )

NamE: Microsoft Build Engine Started by an Office Application
	description: 
		     An instance of MSBuild, the Microsoft Build
		     Engine, was started by Excel or Word. This is unusual behavior
		     for the Build Engine and could have been caused by an Excel or
		     Word document executing a malicious script payload.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : "MSBuild.exe" and
		     process.parent.name : ("eqnedt32.exe",
		     "excel.exe",                          "fltldr.exe",
		     "msaccess.exe",                          "mspub.exe",
		     "outlook.exe",                          "powerpnt.exe",
		     "winword.exe" )

NamE: Execution via MSSQL xp_cmdshell Stored Procedure
	description: 
		     Identifies execution via MSSQL xp_cmdshell
		     stored procedure. Malicious users may attempt to elevate their
		     privileges by using xp_cmdshell, which is disabled by default,
		     thus, it's important to review the context of it's use.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and process.parent.name : "sqlservr.exe" and    (
		     (process.name : "cmd.exe" and      not process.args : ("\\\\*",
		     "diskfree", "rmdir", "mkdir", "dir", "del", "rename", "bcp",
		     "*XMLNAMESPACES*",
		     "?:\\MSSQL\\Backup\\Jobs\\sql_agent_backup_job.ps1",
		     "K:\\MSSQL\\Backup\\msdb", "K:\\MSSQL\\Backup\\Logins")) or
		     (process.name : "vpnbridge.exe" or
		     ?process.pe.original_file_name : "vpnbridge.exe") or
		     (process.name : "certutil.exe" or
		     ?process.pe.original_file_name == "CertUtil.exe") or
		     (process.name : "bitsadmin.exe" or
		     ?process.pe.original_file_name == "bitsadmin.exe")   )

NamE: Suspicious PrintSpooler Service Executable File Creation
	description: 
		     Detects attempts to exploit privilege escalation
		     vulnerabilities related to the Print Spooler service. For more
		     information refer to the following CVE's - CVE-2020-1048,
		     CVE-2020-1337 and CVE-2020-1300 and verify that the impacted
		     system is patched.
	query: 
		     event.category : "file" and host.os.type : "windows"
		     and event.type : "creation" and   process.name : "spoolsv.exe"
		     and file.extension : "dll"

NamE: AWS EC2 EBS Snapshot Shared or Made Public
	description: 
		     Identifies AWS EC2 EBS snaphots being shared
		     with another AWS account or made public. EBS virtual disks can
		     be copied into snapshots, which can then be shared with an
		     external AWS account or made public. Adversaries may attempt
		     this in order to copy the snapshot into an environment they
		     control, to access the data.
	query: 
		     from logs-aws.cloudtrail-* metadata _id, _version,
		     _index | where event.provider == "ec2.amazonaws.com" and
		     event.action == "ModifySnapshotAttribute" and event.outcome ==
		     "success" | dissect aws.cloudtrail.request_parameters "{%{?snap
		     shotId}=%{snapshotId},%{?attributeType}=%{attributeType},%{?cre
		     ateVolumePermission}={%{operationType}={%{?items}=[{%{?userId}=
		     %{userId}}]}}}" | where operationType == "add" and
		     cloud.account.id != userId | keep @timestamp,
		     aws.cloudtrail.user_identity.arn, cloud.account.id,
		     event.action, snapshotId, attributeType, operationType, userId

NamE: Azure Blob Container Access Level Modification
	description: 
		     Identifies changes to container access levels in
		     Azure. Anonymous public read access to containers and blobs in
		     Azure is a way to share data broadly, but can present a
		     security risk if access to sensitive data is not managed
		     judiciously.
	query: 
		     event.dataset:azure.activitylogs and azure.activitylog
		     s.operation_name:"MICROSOFT.STORAGE/STORAGEACCOUNTS/BLOBSERVICE
		     S/CONTAINERS/WRITE" and event.outcome:(Success or success)

NamE: Potential Privileged Escalation via SamAccountName Spoofing
	description: 
		     Identifies a suspicious computer account name
		     rename event, which may indicate an attempt to exploit
		     CVE-2021-42278 to elevate privileges from a standard domain
		     user to a user with domain admin privileges. CVE-2021-42278 is
		     a security vulnerability that allows potential attackers to
		     impersonate a domain controller via samAccountName attribute
		     spoofing.
	query: 
		     iam where event.action == "renamed-user-account" and
		     /* machine account name renamed to user like account name */
		     winlog.event_data.OldTargetUserName : "*$" and not
		     winlog.event_data.NewTargetUserName : "*$"

NamE: High Number of Cloned GitHub Repos From PAT
	description: 
		     Detects a high number of unique private repo
		     clone events originating from a single personal access token
		     within a short time period.
	query: 
		     event.dataset:"github.audit" and
		     event.category:"configuration" and event.action:"git.clone" and
		     github.programmatic_access_type:("OAuth access token" or "Fine-
		     grained personal access token") and
		     github.repository_public:false

NamE: PowerShell Script with Veeam Credential Access Capabilities
	description: 
		     Identifies PowerShell scripts that can access
		     and decrypt Veeam credentials stored in MSSQL databases.
		     Attackers can use Veeam Credentials to target backups as part
		     of destructive operations such as Ransomware attacks.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (     (
		     "[dbo].[Credentials]" and       ("Veeam" or "VeeamBackup")
		     ) or     "ProtectedStorage]::GetLocalString"   )

NamE: AWS STS AssumeRole with New MFA Device
	description: 
		     Identifies when a user has assumed a role using
		     a new MFA device. Users can assume a role to obtain temporary
		     credentials and access AWS resources using the AssumeRole API
		     of AWS Security Token Service (STS). While a new MFA device is
		     not always indicative of malicious behavior it should be
		     verified as adversaries can use this technique for persistence
		     and privilege escalation.
	query: 
		     event.dataset:aws.cloudtrail     and
		     event.provider:sts.amazonaws.com     and
		     event.action:(AssumeRole or AssumeRoleWithSAML or
		     AssumeRoleWithWebIdentity)     and event.outcome:success
		     and user.id:*     and
		     aws.cloudtrail.flattened.request_parameters.serialNumber:*

NamE: Git Hook Command Execution
	description: 
		     This rule detects the execution of a potentially
		     malicious process from a Git hook. Git hooks are scripts that
		     Git executes before or after events such as: commit, push, and
		     receive. An attacker can abuse Git hooks to execute arbitrary
		     commands on the system and establish persistence.
	query: 
		     sequence by host.id with maxspan=3s   [process where
		     host.os.type == "linux" and event.type == "start" and
		     event.action in ("exec", "start") and    process.parent.name ==
		     "git" and process.args : ".git/hooks/*" and    process.name in
		     ("bash", "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish")   ]
		     by process.entity_id   [process where host.os.type == "linux"
		     and event.type == "start" and event.action in ("exec", "start")
		     and    process.parent.name in ("bash", "dash", "sh", "tcsh",
		     "csh", "zsh", "ksh", "fish")] by process.parent.entity_id

NamE: System Binary Path File Permission Modification
	description: 
		     This rule identifies file permission
		     modification events on files located in common system binary
		     paths. Adversaries may attempt to hide their payloads in the
		     default Linux system directories, and modify the file
		     permissions of these payloads prior to execution.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action == "exec" and process.name in
		     ("chmod", "chown") and process.args like~ (   "/bin/*",
		     "/usr/bin/*", "/usr/local/bin/*", "/sbin/*", "/usr/sbin/*",
		     "/usr/local/sbin/*",   "/lib/*", "/usr/lib/*", "/lib64/*",
		     "/usr/lib64/*" ) and process.args in ("4755", "755", "000",
		     "777", "444", "-x", "+x") and not (   process.args in
		     ("/bin/chmod", "/usr/bin/chmod", "/usr/local/bin/chmod") or
		     process.parent.executable like~ ("/tmp/newroot/*",
		     "/var/lib/dpkg/info/*") or   process.parent.name in ("udevadm",
		     "systemd", "entrypoint", "sudo", "dart") or
		     process.parent.command_line == "runc init" or
		     process.parent.args like "/var/tmp/rpm-tmp.*" )

NamE: Git Hook Egress Network Connection
	description: 
		     This rule detects a suspicious egress network
		     connection attempt from a Git hook script. Git hooks are
		     scripts that Git executes before or after events such as:
		     commit, push, and receive. An attacker can abuse these features
		     to execute arbitrary commands on the system, establish
		     persistence or to initialize a network connection to a remote
		     server and exfiltrate data or download additional payloads.
	query: 
		     sequence by host.id with maxspan=3s   [process where
		     host.os.type == "linux" and event.type == "start" and
		     event.action == "exec" and    process.parent.name == "git" and
		     process.args : ".git/hooks/*" and    process.name in ("bash",
		     "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish")] by
		     process.entity_id   [network where host.os.type == "linux" and
		     event.type == "start" and event.action ==
		     "connection_attempted" and not (      destination.ip == null or
		     destination.ip == "0.0.0.0" or cidrmatch(
		     destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16",
		     "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29",
		     "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32",
		     "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24",
		     "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16",
		     "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10",
		     "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24",
		     "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10",
		     "FF00::/8", "172.31.0.0/16"      )    )   ] by
		     process.parent.entity_id

NamE: Temporarily Scheduled Task Creation
	description: 
		     Indicates the creation and deletion of a
		     scheduled task within a short time interval. Adversaries can
		     use these to proxy malicious execution via the schedule service
		     and perform clean up.
	query: 
		     sequence by winlog.computer_name,
		     winlog.event_data.TaskName with maxspan=5m    [iam where
		     event.action == "scheduled-task-created" and not user.name :
		     "*$"]    [iam where event.action == "scheduled-task-deleted"
		     and not user.name : "*$"]

NamE: Browser Extension Install
	description: 
		     Identifies the install of browser extensions.
		     Malicious browser extensions can be installed via app store
		     downloads masquerading as legitimate extensions, social
		     engineering, or by an adversary that has already compromised a
		     system.
	query: 
		     file where host.os.type == "windows" and event.type :
		     "creation" and (   /* Firefox-Based Browsers */   (
		     file.name : "*.xpi" and     file.path : "?:\\Users\\*\\AppData\
		     \Roaming\\*\\Profiles\\*\\Extensions\\*.xpi" and     not     (
		     process.name : "firefox.exe" and       file.name :
		     ("langpack-*@firefox.mozilla.org.xpi",
		     "*@dictionaries.addons.mozilla.org.xpi")     )   ) or   /*
		     Chromium-Based Browsers */   (     file.name : "*.crx" and
		     file.path : "?:\\Users\\*\\AppData\\Local\\*\\*\\User
		     Data\\Webstore Downloads\\*"   ) )

NamE: Security Software Discovery using WMIC
	description: 
		     Identifies the use of Windows Management
		     Instrumentation Command (WMIC) to discover certain System
		     Security Settings such as AntiVirus or Host Firewall details.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and (process.name : "wmic.exe" or
		     ?process.pe.original_file_name : "wmic.exe") and process.args :
		     "/namespace:\\\\root\\SecurityCenter2" and process.args : "Get"

NamE: Systemd Service Created
	description: 
		     This rule detects the creation or renaming of a
		     new Systemd file in all of the common Systemd service locations
		     for both root and regular users. Systemd service files are
		     configuration files in Linux systems used to define and manage
		     system services. Malicious actors can leverage systemd service
		     files to achieve persistence by creating or modifying services
		     to execute malicious commands or payloads during system startup
		     or at a predefined interval by adding a systemd timer. This
		     allows them to maintain unauthorized access, execute additional
		     malicious activities, or evade detection.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("rename", "creation") and file.path : (
		     "/etc/systemd/system/*", "/etc/systemd/user/*",
		     "/usr/local/lib/systemd/system/*",   "/lib/systemd/system/*",
		     "/usr/lib/systemd/system/*", "/usr/lib/systemd/user/*",
		     "/home/*/.config/systemd/user/*",
		     "/home/*/.local/share/systemd/user/*",
		     "/root/.config/systemd/user/*",
		     "/root/.local/share/systemd/user/*" ) and file.extension ==
		     "service" and not (   process.executable in (     "/bin/dpkg",
		     "/usr/bin/dpkg", "/bin/dockerd", "/usr/bin/dockerd",
		     "/usr/sbin/dockerd", "/bin/microdnf",     "/usr/bin/microdnf",
		     "/bin/rpm", "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd",
		     "/bin/yum", "/usr/bin/yum",     "/bin/dnf", "/usr/bin/dnf",
		     "/bin/podman", "/usr/bin/podman", "/bin/dnf-automatic",
		     "/usr/bin/dnf-automatic",     "/usr/bin/dpkg-divert",
		     "/bin/dpkg-divert", "/sbin/apk", "/usr/sbin/apk",
		     "/usr/local/sbin/apk", "/usr/bin/apt", "/bin/podman",
		     "/usr/bin/podman", "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/lib/snapd/snapd", "/usr/local/bin/dockerd",
		     "/usr/bin/crio", "/usr/sbin/crond",
		     "/opt/puppetlabs/puppet/bin/ruby", "/usr/libexec/platform-
		     python", "/kaniko/kaniko-executor",
		     "/usr/local/bin/dockerd", "/usr/bin/podman", "/bin/install",
		     "/proc/self/exe", "/usr/lib/systemd/systemd",
		     "/usr/sbin/sshd", "/usr/bin/gitlab-runner",
		     "/opt/gitlab/embedded/bin/ruby", "/usr/sbin/gdm",
		     "/usr/bin/install",
		     "/usr/local/manageengine/uems_agent/bin/dcregister"   ) or
		     file.extension in ("swp", "swpx", "swx", "dpkg-remove") or
		     file.Ext.original.extension == "dpkg-new" or
		     process.executable : (     "/nix/store/*", "/var/lib/dpkg/*",
		     "/tmp/vmis.*", "/snap/*", "/dev/fd/*", "/usr/lib/virtualbox/*"
		     ) or   process.executable == null or   process.name like (
		     "ssm-agent-worker", "python*", "platform-python*",
		     "dnf_install", "cloudflared", "lxc-pve-prestart-hook",
		     "convert-usrmerge", "elastic-agent",
		     "google_metadata_script_runner", "update-alternatives",
		     "gitlab-runner",     "install", "crio", "apt-get", "package-
		     cleanup", "dcservice", "dcregister", "jumpcloud-agent",
		     "executor",     "pacman", "convert2rhel", "packagekitd"   ) or
		     (process.name == "sed" and file.name : "sed*") or
		     (process.name == "perl" and file.name : "e2scrub_all.tmp*")  )

NamE: Potential Sudo Hijacking
	description: 
		     Identifies the creation of a sudo binary located
		     at /usr/bin/sudo. Attackers may hijack the default sudo binary
		     and replace it with a custom binary or script that can read the
		     user's password in clear text to escalate privileges or enable
		     persistence onto the system every time the sudo binary is
		     executed.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("creation", "rename") and file.path in ("/usr/bin/sudo",
		     "/bin/sudo") and not (   file.Ext.original.path in
		     ("/usr/bin/sudo", "/bin/sudo") or   process.executable in (
		     "/bin/dpkg", "/usr/bin/dpkg", "/bin/dockerd",
		     "/usr/bin/dockerd", "/usr/sbin/dockerd", "/bin/microdnf",
		     "/bin/rpm", "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd",
		     "/bin/yum", "/usr/bin/yum", "/bin/dnf", "/usr/bin/dnf",
		     "/bin/podman", "/usr/bin/podman", "/bin/dnf-automatic",
		     "/usr/bin/dnf-automatic", "/bin/pacman", "/usr/bin/pacman",
		     "/usr/bin/dpkg-divert", "/bin/dpkg-divert", "/sbin/apk",
		     "/usr/sbin/apk", "/usr/local/sbin/apk", "/usr/bin/apt",
		     "/usr/sbin/pacman", "/usr/bin/microdnf",
		     "/usr/local/bin/dockerd", "/usr/local/bin/podman",
		     "/usr/local/bin/dnf",     "/kaniko/executor", "/proc/self/exe",
		     "/usr/bin/apt-get", "/usr/bin/apt-cache", "/usr/bin/apt-mark"
		     ) or   file.Ext.original.extension == "dpkg-new" or
		     process.executable : (     "/nix/store/*", "/var/lib/dpkg/*",
		     "/tmp/vmis.*", "/snap/*", "/dev/fd/*", "/var/lib/docker/*"   )
		     or   process.executable == null or   (process.name == "sed" and
		     file.name : "sed*") )

NamE: Local Scheduled Task Creation
	description: 
		     Indicates the creation of a scheduled task.
		     Adversaries can use these to establish persistence, move
		     laterally, and/or escalate privileges.
	query: 
		     sequence with maxspan=1m   [process where host.os.type
		     == "windows" and event.type == "start" and     ((process.name :
		     ("cmd.exe", "wscript.exe", "rundll32.exe", "regsvr32.exe",
		     "wmic.exe", "mshta.exe",
		     "powershell.exe", "pwsh.exe", "powershell_ise.exe",
		     "WmiPrvSe.exe", "wsmprovhost.exe", "winrshost.exe") or
		     process.pe.original_file_name : ("cmd.exe", "wscript.exe",
		     "rundll32.exe", "regsvr32.exe", "wmic.exe", "mshta.exe",
		     "powershell.exe", "pwsh.dll", "powershell_ise.exe",
		     "WmiPrvSe.exe", "wsmprovhost.exe",
		     "winrshost.exe")) or     ?process.code_signature.trusted ==
		     false)] by process.entity_id   [process where host.os.type ==
		     "windows" and event.type == "start" and     (process.name :
		     "schtasks.exe" or process.pe.original_file_name ==
		     "schtasks.exe") and     process.args : ("/create", "-create")
		     and process.args : ("/RU", "/SC", "/TN", "/TR", "/F", "/XML")
		     and     /* exclude SYSTEM Integrity Level - look for task
		     creations by non-SYSTEM user */     not
		     (?process.Ext.token.integrity_level_name : "System" or
		     ?winlog.event_data.IntegrityLevel : "System")   ] by
		     process.parent.entity_id

NamE: Attempt to Disable Syslog Service
	description: 
		     Adversaries may attempt to disable the syslog
		     service in an attempt to an attempt to disrupt event logging
		     and evade detection by security controls.
	query: 
		     process where host.os.type == "linux" and event.action
		     in ("exec", "exec_event", "start", "ProcessRollup2") and  (
		     (process.name == "service" and process.args == "stop") or
		     (process.name == "chkconfig" and process.args == "off") or
		     (process.name == "systemctl" and process.args in ("disable",
		     "stop", "kill"))  ) and process.args in ("syslog", "rsyslog",
		     "syslog-ng", "syslog.service", "rsyslog.service", "syslog-
		     ng.service") and not process.parent.name == "rsyslog-rotate"

NamE: Attempt to Install Kali Linux via WSL
	description: 
		     Detects attempts to install or use Kali Linux
		     via Windows Subsystem for Linux. Adversaries may enable and use
		     WSL for Linux to avoid detection.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and (   (process.name : "wsl.exe" and process.args :
		     ("-d", "--distribution", "-i", "--install") and process.args :
		     "kali*") or   process.executable : (
		     "?:\\Users\\*\\AppData\\Local\\packages\\kalilinux*",     "?:\\
		     Users\\*\\AppData\\Local\\Microsoft\\WindowsApps\\kali.exe",
		     "?:\\Program Files*\\WindowsApps\\KaliLinux.*\\kali.exe",     "
		     \\Device\\HarddiskVolume?\\Users\\*\\AppData\\Local\\packages\\
		     kalilinux*",     "\\Device\\HarddiskVolume?\\Users\\*\\AppData\
		     \Local\\Microsoft\\WindowsApps\\kali.exe",
		     "\\Device\\HarddiskVolume?\\Program
		     Files*\\WindowsApps\\KaliLinux.*\\kali.exe"   ) )

NamE: Potential Credential Access via Trusted Developer Utility
	description: 
		     An instance of MSBuild, the Microsoft Build
		     Engine, loaded DLLs (dynamically linked libraries) responsible
		     for Windows credential management. This technique is sometimes
		     used for credential dumping.
	query: 
		     sequence by process.entity_id  [process where
		     host.os.type == "windows" and event.type == "start" and
		     (process.name : "MSBuild.exe" or process.pe.original_file_name
		     == "MSBuild.exe")]  [any where host.os.type == "windows" and
		     (event.category == "library" or (event.category == "process"
		     and event.action : "Image loaded*")) and   (?dll.name :
		     ("vaultcli.dll", "SAMLib.DLL") or file.name : ("vaultcli.dll",
		     "SAMLib.DLL"))]

NamE: Google Workspace Admin Role Deletion
	description: 
		     Detects when a custom admin role is deleted. An
		     adversary may delete a custom admin role in order to impact the
		     permissions or capabilities of system administrators.
	query: 
		     event.dataset:google_workspace.admin and
		     event.provider:admin and event.category:iam and
		     event.action:DELETE_ROLE

NamE: Google Workspace Suspended User Account Renewed
	description: 
		     Detects when a previously suspended user's
		     account is renewed in Google Workspace. An adversary may renew
		     a suspended user account to maintain access to the Google
		     Workspace organization with a valid account.
	query: 
		     event.dataset:google_workspace.admin and
		     event.category:iam and event.action:UNSUSPEND_USER

NamE: Tainted Kernel Module Load
	description: 
		     This rule monitors the syslog log file for
		     messages related to instances of a tainted kernel module load.
		     Rootkits often leverage kernel modules as their main defense
		     evasion technique. Detecting tainted kernel module loads is
		     crucial for ensuring system security and integrity, as
		     malicious or unauthorized modules can compromise the kernel and
		     lead to system vulnerabilities or unauthorized access.
	query: 
		     host.os.type:linux and event.dataset:"system.syslog"
		     and process.name:kernel and message:"module verification
		     failed: signature and/or required key missing - tainting
		     kernel"

NamE: Kubernetes Pod created with a Sensitive hostPath Volume
	description: 
		     This rule detects when a pod is created with a
		     sensitive volume of type hostPath. A hostPath volume type
		     mounts a sensitive file or folder from the node to the
		     container. If the container gets compromised, the attacker can
		     use this mount for gaining access to the node. There are many
		     ways a container with unrestricted access to the host
		     filesystem can escalate privileges, including reading data from
		     other containers, and accessing tokens of more privileged pods.
	query: 
		     event.dataset : "kubernetes.audit_logs"   and kubernet
		     es.audit.annotations.authorization_k8s_io/decision:"allow"
		     and kubernetes.audit.objectRef.resource:"pods"   and
		     kubernetes.audit.verb:("create" or "update" or "patch")   and
		     kubernetes.audit.requestObject.spec.volumes.hostPath.path:
		     ("/" or   "/proc" or   "/root" or   "/var" or   "/var/run" or
		     "/var/run/docker.sock" or   "/var/run/crio/crio.sock" or
		     "/var/run/cri-dockerd.sock" or   "/var/lib/kubelet" or
		     "/var/lib/kubelet/pki" or   "/var/lib/docker/overlay2" or
		     "/etc" or   "/etc/kubernetes" or   "/etc/kubernetes/manifests"
		     or   "/etc/kubernetes/pki" or   "/home/admin")   and not
		     kubernetes.audit.requestObject.spec.containers.image:
		     ("docker.elastic.co/beats/elastic-agent:8.4.0")

NamE: Microsoft 365 Exchange Safe Attachment Rule Disabled
	description: 
		     Identifies when a safe attachment rule is
		     disabled in Microsoft 365. Safe attachment rules can extend
		     malware protections to include routing all messages and
		     attachments without a known malware signature to a special
		     hypervisor environment. An adversary or insider threat may
		     disable a safe attachment rule to exfiltrate data or evade
		     defenses.
	query: 
		     event.dataset:o365.audit and event.provider:Exchange
		     and event.category:web and event.action:"Disable-
		     SafeAttachmentRule" and event.outcome:success

NamE: Unusual DPKG Execution
	description: 
		     This rule detects the execution of the DPKG
		     command by processes not associated with the DPKG package
		     manager. The DPKG command is used to install, remove, and
		     manage Debian packages on a Linux system. Attackers can abuse
		     the DPKG command to install malicious packages on a system.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action == "exec" and process.executable :
		     "/var/lib/dpkg/info/*" and process.session_leader.name != null
		     and process.group_leader.name != null and not (
		     process.parent.name in ("dpkg", "dpkg-reconfigure", "frontend")
		     or   process.session_leader.name == "dpkg" or
		     process.group_leader.name == "dpkg" or
		     process.parent.executable in ("/usr/share/debconf/frontend",
		     "/usr/bin/unattended-upgrade") )

NamE: Potential Protocol Tunneling via Chisel Server
	description: 
		     This rule monitors for common command line flags
		     leveraged by the Chisel server utility followed by a received
		     connection within a timespan of 1 minute. Chisel is a command-
		     line utility used for creating and managing TCP and UDP
		     tunnels, enabling port forwarding and secure communication
		     between machines. Attackers can abuse the Chisel utility to
		     establish covert communication channels, bypass network
		     restrictions, and carry out malicious activities by creating
		     tunnels that allow unauthorized access to internal systems.
	query: 
		     sequence by host.id, process.entity_id with maxspan=1m
		     [process where host.os.type == "linux" and event.type ==
		     "start" and event.action == "exec" and     process.args ==
		     "server" and process.args in ("--port", "-p", "--reverse", "--
		     backend", "--socks5") and     process.args_count >= 3 and
		     process.parent.name in ("bash", "dash", "ash", "sh", "tcsh",
		     "csh", "zsh", "ksh", "fish")]   [network where host.os.type ==
		     "linux" and event.type == "start" and event.action ==
		     "connection_accepted" and     destination.ip != null and
		     destination.ip != "127.0.0.1" and destination.ip != "::1" and
		     not process.name : (      "python*", "php*", "perl", "ruby",
		     "lua*", "openssl", "nc", "netcat", "ncat", "telnet", "awk",
		     "java", "telnet",      "ftp", "socat", "curl", "wget", "dpkg",
		     "docker", "dockerd", "yum", "apt", "rpm", "dnf", "ssh", "sshd",
		     "hugo")]

NamE: Remote Scheduled Task Creation via RPC
	description: 
		     Identifies scheduled task creation from a remote
		     source. This could be indicative of adversary lateral movement.
	query: 
		     iam where event.action == "scheduled-task-created" and
		     winlog.event_data.RpcCallClientLocality : "0" and
		     winlog.event_data.ClientProcessId : "0"

NamE: Private Key Searching Activity
	description: 
		     This rule detects private key searching activity
		     on Linux systems. Searching for private keys can be an
		     indication of an attacker attempting to escalate privileges or
		     exfiltrate sensitive information.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2") and process.name == "find" and
		     process.command_line like ("*id_dsa*", "*id_rsa*", "*id_ed*",
		     "*id_ecdsa*", "*id_xmss*", "*id_dh*") and
		     process.command_line like ("*/home/*", "*/etc/ssh*",
		     "*/root/*", "/")

NamE: Dynamic Linker Copy
	description: 
		     Detects the copying of the Linux dynamic loader
		     binary and subsequent file creation for the purpose of creating
		     a backup copy. This technique was seen recently being utilized
		     by Linux malware prior to patching the dynamic loader in order
		     to inject and preload a malicious shared object file. This
		     activity should never occur and if it does then it should be
		     considered highly suspicious or malicious.
	query: 
		     sequence by process.entity_id with maxspan=1m [process
		     where host.os.type == "linux" and event.type == "start" and
		     process.name in ("cp", "rsync") and    process.args in (
		     "/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2",
		     "/etc/ld.so.preload", "/lib64/ld-linux-x86-64.so.2",
		     "/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2",
		     "/usr/lib64/ld-linux-x86-64.so.2"     )] [file where
		     host.os.type == "linux" and event.action == "creation" and
		     file.extension == "so"]

NamE: File made Immutable by Chattr
	description: 
		     Detects a file being made immutable using the
		     chattr binary. Making a file immutable means it cannot be
		     deleted or renamed, no link can be created to this file, most
		     of the file's metadata can not be modified, and the file can
		     not be opened in write mode. Threat actors will commonly
		     utilize this to prevent tampering or modification of their
		     malicious files or any system files they have modified for
		     purposes of persistence (e.g .ssh, /etc/passwd, etc.).
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and process.parent.executable != null and
		     process.executable : "/usr/bin/chattr" and process.args :
		     ("-*i*", "+*i*") and not (   process.parent.executable:
		     ("/lib/systemd/systemd", "/usr/local/uems_agent/bin/*",
		     "/usr/lib/systemd/systemd") or   process.parent.name in (
		     "systemd", "cf-agent", "ntpdate", "xargs", "px", "preinst",
		     "auth", "cf-agent", "dcservice", "dcagentupgrader",     "sudo",
		     "ephemeral-disk-warning"   ) )

NamE: Creation of a Hidden Local User Account
	description: 
		     Identifies the creation of a hidden local user
		     account by appending the dollar sign to the account name. This
		     is sometimes done by attackers to increase access to a system
		     and avoid appearing in the results of accounts listing using
		     the net users command.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.path : (
		     "HKLM\\SAM\\SAM\\Domains\\Account\\Users\\Names\\*$\\",     "\\
		     REGISTRY\\MACHINE\\SAM\\SAM\\Domains\\Account\\Users\\Names\\*$
		     \\",
		     "MACHINE\\SAM\\SAM\\Domains\\Account\\Users\\Names\\*$\\" )

NamE: Modification of Safari Settings via Defaults Command
	description: 
		     Identifies changes to the Safari configuration
		     using the built-in defaults command. Adversaries may attempt to
		     enable or disable certain Safari settings, such as enabling
		     JavaScript from Apple Events to ease in the hijacking of the
		     users browser.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:start and   process.name:defaults and process.args:
		     (com.apple.Safari and write and not       (
		     UniversalSearchEnabled or       SuppressSearchSuggestions or
		     WebKitTabToLinksPreferenceKey or
		     ShowFullURLInSmartSearchField or
		     com.apple.Safari.ContentPageGroupIdentifier.WebKit2TabsToLinks
		     )     )

NamE: Privilege Escalation via GDB CAP_SYS_PTRACE
	description: 
		     Identifies instances where GDB (granted the
		     CAP_SYS_PTRACE capability) is executed, after which the user's
		     access is elevated to UID/GID 0 (root). In Linux, the
		     CAP_SYS_PTRACE capability grants a process the ability to use
		     the ptrace system call, which is typically used for debugging
		     and allows the process to trace and control other processes.
		     Attackers may leverage this capability to hook and inject into
		     a process that is running with root permissions in order to
		     escalate their privileges to root.
	query: 
		     sequence by host.id, process.entry_leader.entity_id
		     with maxspan=1m   [process where host.os.type == "linux" and
		     event.type == "start" and event.action == "exec" and
		     process.name == "gdb" and
		     (process.thread.capabilities.effective : "CAP_SYS_PTRACE" or
		     process.thread.capabilities.permitted : "CAP_SYS_PTRACE") and
		     user.id != "0"]   [process where host.os.type == "linux" and
		     event.type == "start" and event.action == "exec" and
		     process.name != null and user.id == "0"]

NamE: Expired or Revoked Driver Loaded
	description: 
		     Identifies an attempt to load a revoked or
		     expired driver. Adversaries may bring outdated drivers with
		     vulnerabilities to gain code execution in kernel mode or abuse
		     revoked certificates to sign their drivers.
	query: 
		     driver where host.os.type == "windows" and process.pid
		     == 4 and   dll.code_signature.status : ("errorExpired",
		     "errorRevoked")

NamE: Command Execution via SolarWinds Process
	description: 
		     A suspicious SolarWinds child process (Cmd.exe
		     or Powershell.exe) was detected.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and process.name: ("cmd.exe", "powershell.exe") and
		     process.parent.name: (      "ConfigurationWizard*.exe",
		     "NetflowDatabaseMaintenance*.exe",      "NetFlowService*.exe",
		     "SolarWinds.Administration*.exe",
		     "SolarWinds.Collector.Service*.exe",
		     "SolarwindsDiagnostics*.exe"      )

NamE: Alternate Data Stream Creation/Execution at Volume Root Directory
	description: 
		     Identifies the creation of an Alternate Data
		     Stream (ADS) at a volume root directory, which can indicate the
		     attempt to hide tools and malware, as ADSs created in this
		     directory are not displayed by system utilities.
	query: 
		     any where host.os.type == "windows" and event.category
		     in ("file", "process") and   (     (event.type == "creation"
		     and file.path regex~ """[A-Z]:\\:.+""") or     (event.type ==
		     "start" and process.executable regex~ """[A-Z]:\\:.+""")   )

NamE: Connection to External Network via Telnet
	description: 
		     Telnet provides a command line interface for
		     communication with a remote device or server. This rule
		     identifies Telnet network connections to publicly routable IP
		     addresses.
	query: 
		     sequence by process.entity_id   [process where
		     host.os.type == "linux" and process.name == "telnet" and
		     event.type == "start"]   [network where host.os.type == "linux"
		     and process.name == "telnet" and not cidrmatch(
		     destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16",
		     "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29",
		     "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32",
		     "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24",
		     "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16",
		     "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10",
		     "192.175.48.0/24", "198.18.0.0/15", "198.51.100.0/24",
		     "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10",
		     "FF00::/8"     )   ]

NamE: Multiple Alerts Involving a User
	description: 
		     This rule uses alert data to determine when
		     multiple different alerts involving the same user are
		     triggered. Analysts can use this to prioritize triage and
		     response, as these users are more likely to be compromised.
	query: 
		     signal.rule.name:* and user.name:* and not
		     user.id:("S-1-5-18" or "S-1-5-19" or "S-1-5-20")

NamE: Whoami Process Activity
	description: 
		     Identifies suspicious use of whoami.exe which
		     displays user, group, and privileges information for the user
		     who is currently logged on to the local system.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and process.name : "whoami.exe" and (   (     /*
		     scoped for whoami execution under system privileges */     (
		     (         user.domain : ("NT *", "* NT", "IIS APPPOOL") and
		     user.id : ("S-1-5-18", "S-1-5-19", "S-1-5-20", "S-1-5-82-*")
		     and         not ?winlog.event_data.SubjectUserName : "*$" and
		     /* Sysmon will always populate user.id as S-1-5-18, leading to
		     FPs */         not event.dataset :
		     ("windows.sysmon_operational", "windows.sysmon")       ) or
		     (?process.Ext.token.integrity_level_name : "System" or
		     ?winlog.event_data.IntegrityLevel : "System")     ) and     not
		     (       process.parent.name : "cmd.exe" and
		     process.parent.args : (           "chcp 437>nul 2>&1 &
		     C:\\WINDOWS\\System32\\whoami.exe  /groups",           "chcp
		     437>nul 2>&1 & %systemroot%\\system32\\whoami /user",
		     "C:\\WINDOWS\\System32\\whoami.exe /groups",
		     "*WINDOWS\\system32\\config\\systemprofile*"       )     ) and
		     not (process.parent.executable :
		     "C:\\Windows\\system32\\inetsrv\\appcmd.exe" and
		     process.parent.args : "LIST") and     not
		     process.parent.executable : (         "C:\\Program
		     Files\\Microsoft Monitoring Agent\\Agent\\MonitoringHost.exe",
		     "C:\\Program
		     Files\\Cohesity\\cohesity_windows_agent_service.exe"     )   )
		     or   process.parent.name : ("wsmprovhost.exe", "w3wp.exe",
		     "wmiprvse.exe", "rundll32.exe", "regsvr32.exe") )

NamE: IIS HTTP Logging Disabled
	description: 
		     Identifies when Internet Information Services
		     (IIS) HTTP Logging is disabled on a server. An attacker with
		     IIS server access via a webshell or other mechanism can disable
		     HTTP Logging as an effective anti-forensics measure.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (process.name : "appcmd.exe" or
		     ?process.pe.original_file_name == "appcmd.exe") and
		     process.args : "/dontLog*:*True" and   not process.parent.name
		     : "iissetup.exe"

NamE: Enumeration of Kernel Modules
	description: 
		     Loadable Kernel Modules (or LKMs) are pieces of
		     code that can be loaded and unloaded into the kernel upon
		     demand. They extend the functionality of the kernel without the
		     need to reboot the system. This identifies attempts to
		     enumerate information about a kernel module.
	query: 
		     event.category:process and host.os.type:linux and
		     event.type:start and event.action:(exec or exec_event) and (
		     (process.name:(lsmod or modinfo)) or  (process.name:kmod and
		     process.args:list) or  (process.name:depmod and
		     process.args:(--all or -a)) ) and not (   process.parent.name:(
		     mkinitramfs or cryptroot or framebuffer or dracut or jem or
		     thin-provisioning-tools or readykernel or lvm2 or     vz-start
		     or iscsi or mdadm or ovalprobes or bcache or plymouth or dkms
		     or overlayroot or weak-modules or zfs or     systemd or
		     whoopsie-upload-all or kdumpctl or apport-gtk or casper or rear
		     or kernel-install or newrelic-infra   ) or
		     process.parent.executable:/var/lib/dpkg/info/linux-
		     modules*-generic.post* )

NamE: Persistence via DirectoryService Plugin Modification
	description: 
		     Identifies the creation or modification of a
		     DirectoryService PlugIns (dsplug) file. The DirectoryService
		     daemon launches on each system boot and automatically reloads
		     after crash. It scans and executes bundles that are located in
		     the DirectoryServices PlugIns folder and can be abused by
		     adversaries to maintain persistence.
	query: 
		     event.category:file and host.os.type:macos and not
		     event.type:deletion and
		     file.path:/Library/DirectoryServices/PlugIns/*.dsplug

NamE: Potential Privilege Escalation via Linux DAC permissions
	description: 
		     Identifies potential privilege escalation
		     exploitation of DAC (Discretionary access control) file
		     permissions. The rule identifies exploitation of DAC checks on
		     sensitive file paths via suspicious processes whose
		     capabilities include CAP_DAC_OVERRIDE (where a process can
		     bypass all read write and execution checks) or
		     CAP_DAC_READ_SEARCH (where a process can read any file or
		     perform any executable permission on the directories).
	query: 
		     event.category:process and host.os.type:linux and
		     event.type:start and event.action:exec and
		     (process.thread.capabilities.permitted:CAP_DAC_* or
		     process.thread.capabilities.effective: CAP_DAC_*) and
		     process.command_line:(*sudoers* or *passwd* or *shadow* or
		     */root/.ssh*) and not (   user.id : "0" or   process.name : (
		     "tar" or "getent" or "su" or "stat" or "dirname" or "chown" or
		     "sudo" or "dpkg-split" or "dpkg-deb" or "dpkg" or     "podman"
		     or "awk" or "passwd" or "dpkg-maintscript-helper" or
		     "mutt_dotlock" or "nscd" or "logger" or "gpasswd"   ) or
		     process.executable : /usr/lib/*/lxc/rootfs/* or
		     process.parent.name : (     "dpkg" or "java" or *postinst or
		     "dpkg-preconfigure" or "gnome-shell"   ) )

NamE: AWS RDS Cluster Creation
	description: 
		     Identifies the creation of a new Amazon
		     Relational Database Service (RDS) Aurora DB cluster or global
		     database spread across multiple regions.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:rds.amazonaws.com and
		     event.action:(CreateDBCluster or CreateGlobalCluster) and
		     event.outcome:success

NamE: Credential Dumping - Prevented - Elastic Endgame
	description: 
		     Elastic Endgame prevented Credential Dumping.
		     Click the Elastic Endgame icon in the event.module column or
		     the link in the rule.reference column for additional
		     information.
	query: 
		     event.kind:alert and event.module:endgame and
		     endgame.metadata.type:prevention and
		     (event.action:cred_theft_event or
		     endgame.event_subtype_full:cred_theft_event)

NamE: Untrusted DLL Loaded by Azure AD Sync Service
	description: 
		     Identifies the load of a DLL without a valid
		     code signature by the Azure AD Sync process, which may indicate
		     an attempt to persist or collect sensitive credentials passing
		     through the Azure AD synchronization server.
	query: 
		     any where host.os.type == "windows" and process.name :
		     "AzureADConnectAuthenticationAgentService.exe" and (
		     (event.category == "library" and event.action == "load") or
		     (event.category == "process" and event.action : "Image
		     loaded*") ) and  not (?dll.code_signature.trusted == true or
		     file.code_signature.status == "Valid") and not    (    /*
		     Elastic defend DLL path */    ?dll.path :
		     ("?:\\Windows\\assembly\\NativeImages*",
		     "?:\\Windows\\Microsoft.NET\\*",
		     "?:\\Windows\\WinSxS\\*",
		     "?:\\Windows\\System32\\DriverStore\\FileRepository\\*") or
		     /* Sysmon DLL path is mapped to file.path */    file.path :
		     ("?:\\Windows\\assembly\\NativeImages*",
		     "?:\\Windows\\Microsoft.NET\\*",
		     "?:\\Windows\\WinSxS\\*",
		     "?:\\Windows\\System32\\DriverStore\\FileRepository\\*")   )

NamE: New ActiveSyncAllowedDeviceID Added via PowerShell
	description: 
		     Identifies the use of the Exchange PowerShell
		     cmdlet, Set-CASMailbox, to add a new ActiveSync allowed device.
		     Adversaries may target user email to collect sensitive
		     information.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name: ("powershell.exe", "pwsh.exe",
		     "powershell_ise.exe") and process.args : "Set-
		     CASMailbox*ActiveSyncAllowedDeviceIDs*"

NamE: Potential Windows Session Hijacking via CcmExec
	description: 
		     This detection rule identifies when
		     'SCNotification.exe' loads an untrusted DLL, which is a
		     potential indicator of an attacker attempt to
		     hijack/impersonate a Windows user session.
	query: 
		     library where host.os.type == "windows" and
		     process.name : "SCNotification.exe" and
		     (dll.Ext.relative_file_creation_time < 86400 or
		     dll.Ext.relative_file_name_modify_time <= 500) and
		     dll.code_signature.status != "trusted"

NamE: Office Test Registry Persistence
	description: 
		     Identifies the modification of the Microsoft
		     Office "Office Test" Registry key, a registry location that can
		     be used to specify a DLL which will be executed every time an
		     MS Office application is started. Attackers can abuse this to
		     gain persistence on a compromised host.
	query: 
		     registry where host.os.type == "windows" and
		     event.action != "deletion" and     registry.path :
		     "*\\Software\\Microsoft\\Office Test\\Special\\Perf\\*"

NamE: Quarantine Attrib Removed by Unsigned or Untrusted Process
	description: 
		     Detects deletion of the quarantine attribute by
		     an unusual process (xattr). In macOS, when applications or
		     programs are downloaded from the internet, there is a
		     quarantine flag set on the file. This attribute is read by
		     Apple's Gatekeeper defense program at execution time. An
		     adversary may disable this attribute to evade defenses.
	query: 
		     file where event.action ==
		     "extended_attributes_delete" and host.os.type == "macos" and
		     process.executable != null and (process.code_signature.trusted
		     == false or process.code_signature.exists == false) and not
		     process.executable : ("/usr/bin/xattr",
		     "/System/*",
		     "/private/tmp/KSInstallAction.*/*/Install Google Software
		     Update.app/Contents/Helpers/ksinstall",
		     "/Applications/CEWE Fotoschau.app/Contents/MacOS/FotoPlus",
		     "/Applications/.com.bomgar.scc.*/Remote Support Customer
		     Client.app/Contents/MacOS/sdcust") and not file.path :
		     "/private/var/folders/*"

NamE: Encoded Executable Stored in the Registry
	description: 
		     Identifies registry write modifications to hide
		     an encoded portable executable. This could be indicative of
		     adversary defense evasion by avoiding the storing of malicious
		     content directly on disk.
	query: 
		     registry where host.os.type == "windows" and /* update
		     here with encoding combinations */  registry.data.strings :
		     "TVqQAAMAAAAEAAAA*"

NamE: Potential Privilege Escalation through Writable Docker Socket
	description: 
		     This rule monitors for the usage of Docker
		     runtime sockets to escalate privileges on Linux systems. Docker
		     sockets by default are only be writable by the root user and
		     docker group. Attackers that have permissions to write to these
		     sockets may be able to create and run a container that allows
		     them to escalate privileges and gain further access onto the
		     host file system.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action == "exec" and (   (process.name ==
		     "docker" and process.args : "run" and process.args : "-it"  and
		     process.args : ("unix://*/docker.sock",
		     "unix://*/dockershim.sock")) or   (process.name == "socat" and
		     process.args : ("UNIX-CONNECT:*/docker.sock", "UNIX-
		     CONNECT:*/dockershim.sock")) ) and not user.Ext.real.id : "0"
		     and not group.Ext.real.id : "0"

NamE: Statistical Model Detected C2 Beaconing Activity
	description: 
		     A statistical model has identified command-and-
		     control (C2) beaconing activity. Beaconing can help attackers
		     maintain stealthy communication with their C2 servers, receive
		     instructions and payloads, exfiltrate data and maintain
		     persistence in a network.
	query: 
		     beacon_stats.is_beaconing: true and not process.name:
		     ("WaAppAgent.exe" or "metricbeat.exe" or "packetbeat.exe" or
		     "WindowsAzureGuestAgent.exe" or "HealthService.exe" or
		     "Widgets.exe" or "lsass.exe" or "msedgewebview2.exe" or
		     "MsMpEng.exe" or "OUTLOOK.EXE" or "msteams.exe" or
		     "FileSyncHelper.exe" or "SearchProtocolHost.exe" or "Creative
		     Cloud.exe" or "ms-teams.exe" or "ms-teamsupdate.exe" or
		     "curl.exe" or "rundll32.exe" or "MsSense.exe" or "wermgr.exe"
		     or "java" or "olk.exe" or "iexplore.exe" or "NetworkManager" or
		     "packetbeat" or "Ssms.exe" or "NisSrv.exe" or
		     "gamingservices.exe" or "appidcertstorecheck.exe" or
		     "POWERPNT.EXE" or "miiserver.exe" or "Grammarly.Desktop.exe" or
		     "SnagitEditor.exe" or "CRWindowsClientService.exe" or
		     "agentbeat" or "dnf" or "yum" or "apt"                   )

NamE: CyberArk Privileged Access Security Recommended Monitor
	description: 
		     Identifies the occurrence of a CyberArk
		     Privileged Access Security (PAS) non-error level audit event
		     which is recommended for monitoring by the vendor. The
		     event.code correlates to the CyberArk Vault Audit Action Code.
	query: 
		     event.dataset:cyberarkpas.audit and   event.code:(4 or
		     22 or 24 or 31 or 38 or 57 or 60 or 130 or 295 or 300 or 302 or
		     308 or 319 or 344 or 346 or 359 or 361 or 378 or 380 or 411)
		     and   not event.type:error

NamE: Account Configured with Never-Expiring Password
	description: 
		     Detects the creation and modification of an
		     account with the "Don't Expire Password" option Enabled.
		     Attackers can abuse this misconfiguration to persist in the
		     domain and maintain long-term access using compromised accounts
		     with this property.
	query: 
		     any where host.os.type == "windows" and (   (
		     event.code == "4738" and winlog.event_data.NewUACList ==
		     "USER_DONT_EXPIRE_PASSWORD" and not user.id == "S-1-5-18"   )
		     or   (     event.code == "5136" and
		     winlog.event_data.AttributeLDAPDisplayName ==
		     "userAccountControl" and     winlog.event_data.AttributeValue
		     in ("66048", "66080") and winlog.event_data.OperationType ==
		     "%%14674" and     not (       winlog.event_data.SubjectUserName
		     : "*svc*" or       winlog.event_data.ObjectDN : "*Service*"
		     )   ) )

NamE: First Time Seen Google Workspace OAuth Login from Third-Party Application
	description: 
		     Detects the first time a third-party application
		     logs in and authenticated with OAuth. OAuth is used to grant
		     permissions to specific resources and services in Google
		     Workspace. Compromised credentials or service accounts could
		     allow an adversary to authenticate to Google Workspace as a
		     valid user and inherit their privileges.
	query: 
		     event.dataset: "google_workspace.token" and
		     event.action: "authorize" and
		     google_workspace.token.scope.data: *Login and
		     google_workspace.token.client.id: *apps.googleusercontent.com

NamE: AWS IAM Group Creation
	description: 
		     Identifies the creation of a group in AWS
		     Identity and Access Management (IAM). Groups specify
		     permissions for multiple users. Any user in a group
		     automatically has the permissions that are assigned to the
		     group.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:iam.amazonaws.com and event.action:CreateGroup
		     and event.outcome:success

NamE: Google Workspace 2SV Policy Disabled
	description: 
		     Google Workspace admins may setup 2-step
		     verification (2SV) to add an extra layer of security to user
		     accounts by asking users to verify their identity when they use
		     login credentials. Admins have the ability to enforce 2SV from
		     the admin console as well as the methods acceptable for
		     verification and enrollment period. 2SV requires enablement on
		     admin accounts prior to it being enabled for users within
		     organization units. Adversaries may disable 2SV to lower the
		     security requirements to access a valid account.
	query: 
		     event.dataset:"google_workspace.login" and
		     event.action:"2sv_disable"

NamE: Application Removed from Blocklist in Google Workspace
	description: 
		     Google Workspace administrators may be aware of
		     malicious applications within the Google marketplace and block
		     these applications for user security purposes. An adversary,
		     with administrative privileges, may remove this application
		     from the explicit block list to allow distribution of the
		     application amongst users. This may also indicate the
		     unauthorized use of an application that had been previously
		     blocked before by a user with admin privileges.
	query: 
		     event.dataset:"google_workspace.admin" and
		     event.category:"iam" and event.type:"change"  and
		     event.action:"CHANGE_APPLICATION_SETTING" and
		     google_workspace.admin.application.name:"Google Workspace
		     Marketplace" and   google_workspace.admin.old_value:
		     *allowed*false* and google_workspace.admin.new_value:
		     *allowed*true*

NamE: AWS CLI Command with Custom Endpoint URL
	description: 
		     Detects the use of the AWS CLI with the
		     `--endpoint-url` argument, which allows users to specify a
		     custom endpoint URL for AWS services. This can be leveraged by
		     adversaries to redirect API requests to non-standard or
		     malicious endpoints, potentially bypassing typical security
		     controls and logging mechanisms. This behavior may indicate an
		     attempt to interact with unauthorized or compromised
		     infrastructure, exfiltrate data, or perform other malicious
		     activities under the guise of legitimate AWS operations.
	query: 
		     host.os.type: "linux" and event.category: "process"
		     and process.name: "aws" and process.args:  "--endpoint-url"

NamE: Attempt to Reset MFA Factors for an Okta User Account
	description: 
		     Detects attempts to reset an Okta user's
		     enrolled multi-factor authentication (MFA) factors. An
		     adversary may attempt to reset the MFA factors for an Okta
		     user's account in order to register new MFA factors and abuse
		     the account to blend in with normal activity in the victim's
		     environment.
	query: 
		     event.dataset:okta.system and
		     event.action:user.mfa.factor.reset_all

NamE: Windows Defender Disabled via Registry Modification
	description: 
		     Identifies modifications to the Windows Defender
		     registry settings to disable the service or set the service to
		     be started manually.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   (     (       registry.path: (
		     "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows
		     Defender\\DisableAntiSpyware",
		     "\\REGISTRY\\MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows
		     Defender\\DisableAntiSpyware"       ) and
		     registry.data.strings: ("1", "0x00000001")    ) or    (
		     registry.path: (
		     "HKLM\\System\\*ControlSet*\\Services\\WinDefend\\Start",
		     "\\REGISTRY\\MACHINE\\System\\*ControlSet*\\Services\\WinDefend
		     \\Start"       ) and       registry.data.strings in ("3", "4",
		     "0x00000003", "0x00000004")    )   ) and    not     (
		     process.executable : (
		     "?:\\WINDOWS\\system32\\services.exe",
		     "?:\\Windows\\System32\\svchost.exe",           "?:\\Program
		     Files (x86)\\Trend Micro\\Security Agent\\NTRmv.exe"       )
		     and user.id : "S-1-5-18"     )

NamE: Suspicious Print Spooler File Deletion
	description: 
		     Detects deletion of print driver files by an
		     unusual process. This may indicate a clean up attempt post
		     successful privilege escalation via Print Spooler service
		     related vulnerabilities.
	query: 
		     file where host.os.type == "windows" and event.type ==
		     "deletion" and   file.extension : "dll" and file.path :
		     "?:\\Windows\\System32\\spool\\drivers\\x64\\3\\*.dll" and
		     not process.name : ("spoolsv.exe", "dllhost.exe",
		     "explorer.exe")

NamE: Potential Credential Access via LSASS Memory Dump
	description: 
		     Identifies suspicious access to LSASS handle
		     from a call trace pointing to DBGHelp.dll or DBGCore.dll, which
		     both export the MiniDumpWriteDump method that can be used to
		     dump LSASS memory content in preparation for credential access.
	query: 
		     process where host.os.type == "windows" and event.code
		     == "10" and   winlog.event_data.TargetImage :
		     "?:\\WINDOWS\\system32\\lsass.exe" and     /* DLLs exporting
		     MiniDumpWriteDump API to create an lsass mdmp*/
		     winlog.event_data.CallTrace : ("*dbghelp*", "*dbgcore*") and
		     /* case of lsass crashing */   not process.executable : (
		     "?:\\Windows\\System32\\WerFault.exe",
		     "?:\\Windows\\SysWOW64\\WerFault.exe",
		     "?:\\Windows\\System32\\WerFaultSecure.exe"       )

NamE: Creation of a DNS-Named Record
	description: 
		     Active Directory Integrated DNS (ADIDNS) is one
		     of the core components of AD DS, leveraging AD's access control
		     and replication to maintain domain consistency. It stores DNS
		     zones as AD objects, a feature that, while robust, introduces
		     some security issues because of the default permission (Any
		     authenticated users) to create DNS-named records. Attackers can
		     perform Dynamic Spoofing attacks, where they monitor LLMNR/NBT-
		     NS requests and create DNS-named records to target systems that
		     are requested from multiple systems. They can also create
		     specific records to target specific services, such as wpad, for
		     spoofing attacks.
	query: 
		     any where host.os.type == "windows" and event.code ==
		     "5137" and winlog.event_data.ObjectClass == "dnsNode" and
		     not winlog.event_data.SubjectUserName : "*$"

NamE: GCP Pub/Sub Subscription Deletion
	description: 
		     Identifies the deletion of a subscription in
		     Google Cloud Platform (GCP). In GCP, the publisher-subscriber
		     relationship (Pub/Sub) is an asynchronous messaging service
		     that decouples event-producing and event-processing services. A
		     subscription is a named resource representing the stream of
		     messages to be delivered to the subscribing application.
	query: 
		     event.dataset:gcp.audit and event.action:google.pubsub
		     .v*.Subscriber.DeleteSubscription and event.outcome:success

NamE: AWS EC2 Route Table Modified or Deleted
	description: 
		     Identifies AWS CloudTrail events where an EC2
		     route table or association has been modified or deleted. Route
		     table or association modifications can be used by attackers to
		     disrupt network traffic, reroute communications, or maintain
		     persistence in a compromised environment. This is a [New
		     Terms](https://www.elastic.co/guide/en/security/current/rules-
		     ui-create.html#create-new-terms-rule) rule that detects the
		     first instance of this behavior by the
		     `aws.cloudtrail.user_identity.arn` field in the last 10 days.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "ec2.amazonaws.com"     and event.action:(
		     "ReplaceRoute" or         "ReplaceRouteTableAssociation" or
		     "DeleteRouteTable" or         "DeleteRoute" or
		     "DisassociateRouteTable"     )     and event.outcome: "success"
		     and not source.address: (
		     "cloudformation.amazonaws.com" or
		     "servicecatalog.amazonaws.com" or         "fsx.amazonaws.com"
		     )

NamE: Suspicious Remote Registry Access via SeBackupPrivilege
	description: 
		     Identifies remote access to the registry using
		     an account with Backup Operators group membership. This may
		     indicate an attempt to exfiltrate credentials by dumping the
		     Security Account Manager (SAM) registry hive in preparation for
		     credential access and privileges elevation.
	query: 
		     sequence by winlog.computer_name,
		     winlog.event_data.SubjectLogonId with maxspan=1m  [iam where
		     event.action == "logged-in-special"  and
		     winlog.event_data.PrivilegeList : "SeBackupPrivilege" and    /*
		     excluding accounts with existing privileged access */   not
		     winlog.event_data.PrivilegeList : "SeDebugPrivilege"]  [any
		     where event.code == "5145" and
		     winlog.event_data.RelativeTargetName : "winreg"]

NamE: Potential Non-Standard Port SSH connection
	description: 
		     Identifies potentially malicious processes
		     communicating via a port paring typically not associated with
		     SSH. For example, SSH over port 2200 or port 2222 as opposed to
		     the traditional port 22. Adversaries may make changes to the
		     standard port a protocol uses to bypass filtering or muddle
		     analysis/parsing of network data.
	query: 
		     sequence by process.entity_id with maxspan=1m
		     [process where event.action == "exec" and process.name in
		     ("ssh", "sshd") and not process.parent.name in (    "rsync",
		     "pyznap", "git", "ansible-playbook", "scp", "pgbackrest", "git-
		     lfs", "expect", "Sourcetree", "ssh-copy-id",    "run"    )   ]
		     [network where process.name:"ssh" and event.action in
		     ("connection_attempted", "connection_accepted") and
		     destination.port != 22 and network.transport == "tcp" and not (
		     destination.ip == null or destination.ip == "0.0.0.0" or
		     cidrmatch(        destination.ip, "10.0.0.0/8", "127.0.0.0/8",
		     "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24",
		     "192.0.0.0/29",        "192.0.0.8/32", "192.0.0.9/32",
		     "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32",
		     "192.0.2.0/24",        "192.31.196.0/24", "192.52.193.0/24",
		     "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4",
		     "100.64.0.0/10",        "192.175.48.0/24","198.18.0.0/15",
		     "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1",
		     "FE80::/10",        "FF00::/8"      )    )   ]

NamE: Kerberos Traffic from Unusual Process
	description: 
		     Identifies network connections to the standard
		     Kerberos port from an unusual process. On Windows, the only
		     process that normally performs Kerberos traffic from a domain
		     joined host is lsass.exe.
	query: 
		     network where host.os.type == "windows" and event.type
		     == "start" and network.direction == "egress" and
		     destination.port == 88 and source.port >= 49152 and process.pid
		     != 4 and destination.address : "*" and   not    (
		     process.executable : (
		     "\\device\\harddiskvolume?\\program files
		     (x86)\\nmap\\nmap.exe",
		     "\\device\\harddiskvolume?\\program files (x86)\\nmap
		     oem\\nmap.exe",
		     "\\device\\harddiskvolume?\\windows\\system32\\lsass.exe",
		     "?:\\Program Files\\Amazon Corretto\\jdk1*\\bin\\java.exe",
		     "?:\\Program Files\\BlackBerry\\UEM\\Proxy
		     Server\\bin\\prunsrv.exe",         "?:\\Program
		     Files\\BlackBerry\\UEM\\Core\\tomcat-core\\bin\\tomcat9.exe",
		     "?:\\Program Files\\DBeaver\\dbeaver.exe",         "?:\\Program
		     Files\\Docker\\Docker\\resources\\com.docker.backend.exe",
		     "?:\\Program
		     Files\\Docker\\Docker\\resources\\com.docker.vpnkit.exe",
		     "?:\\Program Files\\Docker\\Docker\\resources\\vpnkit.exe",
		     "?:\\Program Files\\Google\\Chrome\\Application\\chrome.exe",
		     "?:\\Program Files\\Internet Explorer\\iexplore.exe",
		     "?:\\Program Files\\JetBrains\\PyCharm Community
		     Edition*\\bin\\pycharm64.exe",         "?:\\Program
		     Files\\Mozilla Firefox\\firefox.exe",         "?:\\Program
		     Files\\Oracle\\VirtualBox\\VirtualBoxVM.exe",
		     "?:\\Program Files\\Puppet
		     Labs\\Puppet\\puppet\\bin\\ruby.exe",         "?:\\Program
		     Files\\rapid7\\nexpose\\nse\\.DLLCACHE\\nseserv.exe",
		     "?:\\Program Files\\Silverfort\\Silverfort AD
		     Adapter\\SilverfortServer.exe",         "?:\\Program
		     Files\\Tenable\\Nessus\\nessusd.exe",         "?:\\Program
		     Files\\VMware\\VMware View\\Server\\bin\\ws_TomcatService.exe",
		     "?:\\Program Files (x86)\\Advanced Port
		     Scanner\\advanced_port_scanner.exe",         "?:\\Program Files
		     (x86)\\DesktopCentral_Agent\\bin\\dcpatchscan.exe",
		     "?:\\Program Files (x86)\\GFI\\LanGuard 12
		     Agent\\lnsscomm.exe",         "?:\\Program Files
		     (x86)\\Google\\Chrome\\Application\\chrome.exe",
		     "?:\\Program Files (x86)\\Internet Explorer\\iexplore.exe",
		     "?:\\Program Files
		     (x86)\\Microsoft\\Edge\\Application\\msedge.exe",
		     "?:\\Program Files
		     (x86)\\Microsoft\\EdgeUpdate\\MicrosoftEdgeUpdate.exe",
		     "?:\\Program Files (x86)\\Microsoft
		     Silverlight\\sllauncher.exe",         "?:\\Program Files
		     (x86)\\Nmap\\nmap.exe",         "?:\\Program Files (x86)\\Nmap
		     OEM\\nmap.exe",         "?:\\Program Files
		     (x86)\\nwps\\NetScanTools Pro\\NSTPRO.exe",
		     "?:\\Program Files (x86)\\SAP
		     BusinessObjects\\tomcat\\bin\\tomcat9.exe",
		     "?:\\Program Files (x86)\\SuperScan\\scanner.exe",
		     "?:\\Program Files (x86)\\Zscaler\\ZSATunnel\\ZSATunnel.exe",
		     "?:\\Windows\\System32\\lsass.exe",
		     "?:\\Windows\\System32\\MicrosoftEdgeCP.exe",
		     "?:\\Windows\\System32\\svchost.exe",
		     "?:\\Windows\\SysWOW64\\vmnat.exe",         "?:\\Windows\\Syste
		     mApps\\Microsoft.MicrosoftEdge_*\\MicrosoftEdge.exe",
		     "System"     ) and process.code_signature.trusted == true   )
		     and  destination.address != "127.0.0.1" and destination.address
		     != "::1"

NamE: Message-of-the-Day (MOTD) File Creation
	description: 
		     This rule detects the creation of potentially
		     malicious files within the default MOTD file directories.
		     Message of the day (MOTD) is the message that is presented to
		     the user when a user connects to a Linux server via SSH or a
		     serial connection. Linux systems contain several default MOTD
		     files located in the "/etc/update-motd.d/" directory. These
		     scripts run as the root user every time a user connects over
		     SSH or a serial connection. Adversaries may create malicious
		     MOTD files that grant them persistence onto the target every
		     time a user connects to the system by executing a backdoor
		     script or command.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("rename", "creation") and file.path : "/etc/update-motd.d/*"
		     and not (   process.executable in (     "/bin/dpkg",
		     "/usr/bin/dpkg", "/bin/dockerd", "/usr/bin/dockerd",
		     "/usr/sbin/dockerd", "/bin/microdnf",     "/usr/bin/microdnf",
		     "/bin/rpm", "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd",
		     "/bin/yum", "/usr/bin/yum",     "/bin/dnf", "/usr/bin/dnf",
		     "/bin/podman", "/usr/bin/podman", "/bin/dnf-automatic",
		     "/usr/bin/dnf-automatic",     "/bin/pacman", "/usr/bin/pacman",
		     "/usr/bin/dpkg-divert", "/bin/dpkg-divert", "/sbin/apk",
		     "/usr/sbin/apk",     "/usr/local/sbin/apk", "/usr/bin/apt",
		     "/usr/sbin/pacman", "/bin/podman", "/usr/bin/podman",
		     "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/lib/snapd/snapd", "/usr/local/bin/dockerd"   ) or
		     file.extension in ("swp", "swpx", "swx", "dpkg-remove") or
		     file.Ext.original.extension == "dpkg-new" or
		     process.executable : (     "/nix/store/*", "/var/lib/dpkg/*",
		     "/tmp/vmis.*", "/snap/*", "/dev/fd/*", "/usr/lib/virtualbox/*"
		     ) or   process.executable == null or   process.name in
		     ("executor", "dockerd", "crio") or   (process.name == "sed" and
		     file.name : "sed*") or   (process.name == "perl" and file.name
		     : "e2scrub_all.tmp*")  )

NamE: Microsoft Exchange Server UM Writing Suspicious Files
	description: 
		     Identifies suspicious files being written by the
		     Microsoft Exchange Server Unified Messaging (UM) service. This
		     activity has been observed exploiting CVE-2021-26858.
	query: 
		     file where host.os.type == "windows" and event.type ==
		     "creation" and   process.name : ("UMWorkerProcess.exe",
		     "umservice.exe") and   file.extension : ("php", "jsp", "js",
		     "aspx", "asmx", "asax", "cfm", "shtml") and   (     file.path :
		     "?:\\inetpub\\wwwroot\\aspnet_client\\*" or      (file.path :
		     "?:\\*\\Microsoft\\Exchange
		     Server*\\FrontEnd\\HttpProxy\\owa\\auth\\*" and        not
		     (file.path : "?:\\*\\Microsoft\\Exchange
		     Server*\\FrontEnd\\HttpProxy\\owa\\auth\\version\\*" or
		     file.name : ("errorFE.aspx", "expiredpassword.aspx",
		     "frowny.aspx", "GetIdToken.htm", "logoff.aspx",
		     "logon.aspx", "OutlookCN.aspx", "RedirSuiteServiceProxy.aspx",
		     "signout.aspx"))) or      (file.path :
		     "?:\\*\\Microsoft\\Exchange
		     Server*\\FrontEnd\\HttpProxy\\ecp\\auth\\*" and        not
		     file.name : "TimeoutLogoff.aspx")   )

NamE: Unusual Process For MSSQL Service Accounts
	description: 
		     Identifies unusual process executions using
		     MSSQL Service accounts, which can indicate the
		     exploitation/compromise of SQL instances. Attackers may exploit
		     exposed MSSQL instances for initial access or lateral movement.
	query: 
		     process where event.type == "start" and host.os.type
		     == "windows" and   user.name : (     "SQLSERVERAGENT",
		     "SQLAGENT$*",     "MSSQLSERVER", "MSSQL$*",
		     "MSSQLServerOLAPService",     "ReportServer*",
		     "MsDtsServer150",     "MSSQLFDLauncher*",
		     "SQLServer2005SQLBrowserUser$*",     "SQLWriter", "winmgmt"   )
		     and user.domain : "NT SERVICE" and   not (     (
		     process.name : (         "sqlceip.exe", "sqlservr.exe",
		     "sqlagent.exe",         "msmdsrv.exe",
		     "ReportingServicesService.exe",         "MsDtsSrvr.exe",
		     "sqlbrowser.exe", "DTExec.exe",         "SQLPS.exe",
		     "fdhost.exe", "fdlauncher.exe",         "SqlDumper.exe",
		     "sqlsqm.exe", "DatabaseMail.exe",         "ISServerExec.exe",
		     "Microsoft.ReportingServices.Portal.WebHost.exe",
		     "bcp.exe", "SQLCMD.exe", "DatabaseMail.exe"       ) or
		     process.executable : (
		     "?:\\Windows\\System32\\wermgr.exe",
		     "?:\\Windows\\System32\\conhost.exe",
		     "?:\\Windows\\System32\\WerFault.exe"       )     ) and     (
		     process.code_signature.subject_name : ("Microsoft Corporation",
		     "Microsoft Windows") and       process.code_signature.trusted
		     == true     )   ) and   not (     (process.name : "cmd.exe" and
		     process.parent.name : "sqlservr.exe") or     (process.name :
		     "cmd.exe" and process.parent.name : "forfiles.exe" and
		     process.command_line : "/c echo *")   )

NamE: AWS Configuration Recorder Stopped
	description: 
		     Identifies an AWS configuration change to stop
		     recording a designated set of resources.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:config.amazonaws.com and
		     event.action:StopConfigurationRecorder and
		     event.outcome:success

NamE: Potential Masquerading as System32 DLL
	description: 
		     Identifies suspicious instances of default
		     system32 DLLs either unsigned or signed with non-MS
		     certificates. This can potentially indicate the attempt to
		     masquerade as system DLLs, perform DLL Search Order Hijacking
		     or backdoor and resign legitimate DLLs.
	query: 
		     library where event.action == "load" and
		     dll.Ext.relative_file_creation_time <= 3600 and     not (
		     dll.path : (         "?:\\Windows\\System32\\*",
		     "?:\\Windows\\SysWOW64\\*",
		     "?:\\Windows\\SystemTemp\\*",
		     "?:\\$WINDOWS.~BT\\NewOS\\Windows\\WinSxS\\*",
		     "?:\\$WINDOWS.~BT\\NewOS\\Windows\\System32\\*",
		     "?:\\$WINDOWS.~BT\\Sources\\*",
		     "?:\\$WINDOWS.~BT\\Work\\*",         "?:\\Windows\\WinSxS\\*",
		     "?:\\Windows\\SoftwareDistribution\\Download\\*",
		     "?:\\Windows\\assembly\\NativeImages_v*"       )     ) and
		     not (       dll.code_signature.subject_name in (
		     "Microsoft Windows",         "Microsoft Corporation",
		     "Microsoft Windows Hardware Abstraction Layer Publisher",
		     "Microsoft Windows Publisher",         "Microsoft Windows 3rd
		     party Component",         "Microsoft 3rd Party Application
		     Component"       ) and dll.code_signature.trusted == true     )
		     and not dll.code_signature.status : ("errorCode_endpoint*",
		     "errorUntrustedRoot", "errorChaining") and     dll.name : (
		     "aadauthhelper.dll", "aadcloudap.dll", "aadjcsp.dll",
		     "aadtb.dll", "aadwamextension.dll", "aarsvc.dll",
		     "abovelockapphost.dll", "accessibilitycpl.dll",
		     "accountaccessor.dll", "accountsrt.dll", "acgenral.dll",
		     "aclayers.dll", "acledit.dll", "aclui.dll", "acmigration.dll",
		     "acppage.dll", "acproxy.dll", "acspecfc.dll",
		     "actioncenter.dll", "actioncentercpl.dll", "actionqueue.dll",
		     "activationclient.dll", "activeds.dll", "activesynccsp.dll",
		     "actxprxy.dll", "acwinrt.dll", "acxtrnal.dll",
		     "adaptivecards.dll", "addressparser.dll", "adhapi.dll",
		     "adhsvc.dll", "admtmpl.dll", "adprovider.dll", "adrclient.dll",
		     "adsldp.dll", "adsldpc.dll", "adsmsext.dll", "adsnt.dll",
		     "adtschema.dll", "advancedemojids.dll", "advapi32.dll",
		     "advapi32res.dll", "advpack.dll", "aeevts.dll", "aeinv.dll",
		     "aepic.dll", "ajrouter.dll", "altspace.dll", "amsi.dll",
		     "amsiproxy.dll", "amstream.dll", "apds.dll",
		     "aphostclient.dll", "aphostres.dll", "aphostservice.dll",
		     "apisampling.dll", "apisetschema.dll", "apmon.dll",
		     "apmonui.dll", "appcontracts.dll", "appextension.dll",
		     "apphelp.dll", "apphlpdm.dll", "appidapi.dll", "appidsvc.dll",
		     "appinfo.dll", "appinfoext.dll", "applicationframe.dll",
		     "applockercsp.dll", "appmgmts.dll", "appmgr.dll", "appmon.dll",
		     "appointmentapis.dll", "appraiser.dll", "appreadiness.dll",
		     "apprepapi.dll", "appresolver.dll", "appsruprov.dll",
		     "appvcatalog.dll", "appvclientps.dll", "appvetwclientres.dll",
		     "appvintegration.dll", "appvmanifest.dll", "appvpolicy.dll",
		     "appvpublishing.dll", "appvreporting.dll", "appvscripting.dll",
		     "appvsentinel.dll", "appvstreamingux.dll", "appvstreammap.dll",
		     "appvterminator.dll", "appxalluserstore.dll",
		     "appxpackaging.dll", "appxsip.dll", "appxsysprep.dll",
		     "archiveint.dll", "asferror.dll", "aspnet_counters.dll",
		     "asycfilt.dll", "atl.dll", "atlthunk.dll", "atmlib.dll",
		     "audioeng.dll", "audiohandlers.dll", "audiokse.dll",
		     "audioses.dll", "audiosrv.dll", "auditcse.dll",
		     "auditpolcore.dll", "auditpolmsg.dll", "authbroker.dll",
		     "authbrokerui.dll", "authentication.dll", "authext.dll",
		     "authfwcfg.dll", "authfwgp.dll", "authfwsnapin.dll",
		     "authfwwizfwk.dll", "authhostproxy.dll", "authui.dll",
		     "authz.dll", "autopilot.dll", "autopilotdiag.dll",
		     "autoplay.dll", "autotimesvc.dll", "avicap32.dll",
		     "avifil32.dll", "avrt.dll", "axinstsv.dll", "azroles.dll",
		     "azroleui.dll", "azsqlext.dll", "basecsp.dll", "basesrv.dll",
		     "batmeter.dll", "bcastdvrbroker.dll", "bcastdvrclient.dll",
		     "bcastdvrcommon.dll", "bcd.dll", "bcdprov.dll", "bcdsrv.dll",
		     "bcp47langs.dll", "bcp47mrm.dll", "bcrypt.dll",
		     "bcryptprimitives.dll", "bdehdcfglib.dll", "bderepair.dll",
		     "bdesvc.dll", "bdesysprep.dll", "bdeui.dll", "bfe.dll",
		     "bi.dll", "bidispl.dll", "bindfltapi.dll", "bingasds.dll",
		     "bingfilterds.dll", "bingmaps.dll", "biocredprov.dll",
		     "bisrv.dll", "bitlockercsp.dll", "bitsigd.dll", "bitsperf.dll",
		     "bitsproxy.dll", "biwinrt.dll", "blbevents.dll", "blbres.dll",
		     "blb_ps.dll", "bluetoothapis.dll", "bnmanager.dll",
		     "bootmenuux.dll", "bootstr.dll", "bootux.dll", "bootvid.dll",
		     "bridgeres.dll", "brokerlib.dll", "browcli.dll",
		     "browserbroker.dll", "browseui.dll", "btagservice.dll",
		     "bthavctpsvc.dll", "bthavrcp.dll", "bthavrcpappsvc.dll",
		     "bthci.dll", "bthpanapi.dll", "bthradiomedia.dll",
		     "bthserv.dll", "bthtelemetry.dll", "btpanui.dll",
		     "bwcontexthandler.dll", "cabapi.dll", "cabinet.dll",
		     "cabview.dll", "callbuttons.dll", "cameracaptureui.dll",
		     "capauthz.dll", "capiprovider.dll", "capisp.dll",
		     "captureservice.dll", "castingshellext.dll", "castlaunch.dll",
		     "catsrv.dll", "catsrvps.dll", "catsrvut.dll", "cbdhsvc.dll",
		     "cca.dll", "cdd.dll", "cdosys.dll", "cdp.dll", "cdprt.dll",
		     "cdpsvc.dll", "cdpusersvc.dll", "cemapi.dll", "certca.dll",
		     "certcli.dll", "certcredprovider.dll", "certenc.dll",
		     "certenroll.dll", "certenrollui.dll", "certmgr.dll",
		     "certpkicmdlet.dll", "certpoleng.dll", "certprop.dll",
		     "cewmdm.dll", "cfgbkend.dll", "cfgmgr32.dll",
		     "cfgspcellular.dll", "cfgsppolicy.dll", "cflapi.dll",
		     "cfmifs.dll", "cfmifsproxy.dll", "chakra.dll",
		     "chakradiag.dll", "chakrathunk.dll", "chartv.dll",
		     "chatapis.dll", "chkwudrv.dll", "chsstrokeds.dll",
		     "chtbopomofods.dll", "chtcangjieds.dll", "chthkstrokeds.dll",
		     "chtquickds.dll", "chxapds.dll", "chxdecoder.dll",
		     "chxhapds.dll", "chxinputrouter.dll", "chxranker.dll",
		     "ci.dll", "cic.dll", "cimfs.dll", "circoinst.dll", "ciwmi.dll",
		     "clb.dll", "clbcatq.dll", "cldapi.dll", "cleanpccsp.dll",
		     "clfsw32.dll", "cliconfg.dll", "clipboardserver.dll",
		     "clipc.dll", "clipsvc.dll", "clipwinrt.dll", "cloudap.dll",
		     "cloudidsvc.dll", "clrhost.dll", "clusapi.dll", "cmcfg32.dll",
		     "cmdext.dll", "cmdial32.dll", "cmgrcspps.dll", "cmifw.dll",
		     "cmintegrator.dll", "cmlua.dll", "cmpbk32.dll", "cmstplua.dll",
		     "cmutil.dll", "cngcredui.dll", "cngprovider.dll", "cnvfat.dll",
		     "cofiredm.dll", "colbact.dll", "colorcnv.dll", "colorui.dll",
		     "combase.dll", "comcat.dll", "comctl32.dll", "comdlg32.dll",
		     "coml2.dll", "comppkgsup.dll", "compstui.dll",
		     "computecore.dll", "computenetwork.dll", "computestorage.dll",
		     "comrepl.dll", "comres.dll", "comsnap.dll", "comsvcs.dll",
		     "comuid.dll", "configmanager2.dll", "conhostv1.dll",
		     "connect.dll", "consentux.dll", "consentuxclient.dll",
		     "console.dll", "consolelogon.dll", "contactapis.dll",
		     "container.dll", "coredpus.dll", "coreglobconfig.dll",
		     "coremas.dll", "coremessaging.dll", "coremmres.dll",
		     "coreshell.dll", "coreshellapi.dll", "coreuicomponents.dll",
		     "correngine.dll", "courtesyengine.dll", "cpfilters.dll",
		     "creddialogbroker.dll", "credprovhelper.dll",
		     "credprovhost.dll", "credprovs.dll", "credprovslegacy.dll",
		     "credssp.dll", "credui.dll", "crypt32.dll", "cryptbase.dll",
		     "cryptcatsvc.dll", "cryptdlg.dll", "cryptdll.dll",
		     "cryptext.dll", "cryptnet.dll", "cryptngc.dll",
		     "cryptowinrt.dll", "cryptsp.dll", "cryptsvc.dll",
		     "crypttpmeksvc.dll", "cryptui.dll", "cryptuiwizard.dll",
		     "cryptxml.dll", "cscapi.dll", "cscdll.dll", "cscmig.dll",
		     "cscobj.dll", "cscsvc.dll", "cscui.dll", "csplte.dll",
		     "cspproxy.dll", "csrsrv.dll", "cxcredprov.dll", "c_g18030.dll",
		     "c_gsm7.dll", "c_is2022.dll", "c_iscii.dll", "d2d1.dll",
		     "d3d10.dll", "d3d10core.dll", "d3d10level9.dll",
		     "d3d10warp.dll", "d3d10_1.dll", "d3d10_1core.dll", "d3d11.dll",
		     "d3d11on12.dll", "d3d12.dll", "d3d12core.dll", "d3d8thk.dll",
		     "d3d9.dll", "d3d9on12.dll", "d3dscache.dll", "dab.dll",
		     "dabapi.dll", "daconn.dll", "dafbth.dll", "dafdnssd.dll",
		     "dafescl.dll", "dafgip.dll", "dafiot.dll", "dafipp.dll",
		     "dafmcp.dll", "dafpos.dll", "dafprintprovider.dll",
		     "dafupnp.dll", "dafwcn.dll", "dafwfdprovider.dll",
		     "dafwiprov.dll", "dafwsd.dll", "damediamanager.dll",
		     "damm.dll", "das.dll", "dataclen.dll", "datusage.dll",
		     "davclnt.dll", "davhlpr.dll", "davsyncprovider.dll",
		     "daxexec.dll", "dbgcore.dll", "dbgeng.dll", "dbghelp.dll",
		     "dbgmodel.dll", "dbnetlib.dll", "dbnmpntw.dll", "dciman32.dll",
		     "dcntel.dll", "dcomp.dll", "ddaclsys.dll", "ddcclaimsapi.dll",
		     "ddds.dll", "ddisplay.dll", "ddoiproxy.dll", "ddores.dll",
		     "ddpchunk.dll", "ddptrace.dll", "ddputils.dll", "ddp_ps.dll",
		     "ddraw.dll", "ddrawex.dll", "defragproxy.dll", "defragres.dll",
		     "defragsvc.dll", "deploymentcsps.dll", "deskadp.dll",
		     "deskmon.dll", "desktopshellext.dll", "devenum.dll",
		     "deviceaccess.dll", "devicecenter.dll", "devicecredential.dll",
		     "devicepairing.dll", "deviceuxres.dll", "devinv.dll",
		     "devmgr.dll", "devobj.dll", "devpropmgr.dll",
		     "devquerybroker.dll", "devrtl.dll", "dfdts.dll", "dfscli.dll",
		     "dfshim.dll", "dfsshlex.dll", "dggpext.dll",
		     "dhcpcmonitor.dll", "dhcpcore.dll", "dhcpcore6.dll",
		     "dhcpcsvc.dll", "dhcpcsvc6.dll", "dhcpsapi.dll", "diagcpl.dll",
		     "diagnosticlogcsp.dll", "diagperf.dll", "diagsvc.dll",
		     "diagtrack.dll", "dialclient.dll", "dialserver.dll",
		     "dictationmanager.dll", "difxapi.dll", "dimsjob.dll",
		     "dimsroam.dll", "dinput.dll", "dinput8.dll",
		     "direct2ddesktop.dll", "directml.dll", "discan.dll",
		     "dismapi.dll", "dispbroker.dll", "dispex.dll", "display.dll",
		     "displaymanager.dll", "dlnashext.dll", "dmappsres.dll",
		     "dmcfgutils.dll", "dmcmnutils.dll", "dmcsps.dll", "dmdlgs.dll",
		     "dmdskmgr.dll", "dmdskres.dll", "dmdskres2.dll",
		     "dmenrollengine.dll", "dmintf.dll", "dmiso8601utils.dll",
		     "dmloader.dll", "dmocx.dll", "dmoleaututils.dll",
		     "dmpushproxy.dll", "dmpushroutercore.dll", "dmrcdecoder.dll",
		     "dmrserver.dll", "dmsynth.dll", "dmusic.dll", "dmutil.dll",
		     "dmvdsitf.dll", "dmwappushsvc.dll", "dmwmicsp.dll",
		     "dmxmlhelputils.dll", "dnsapi.dll", "dnscmmc.dll",
		     "dnsext.dll", "dnshc.dll", "dnsrslvr.dll", "docprop.dll",
		     "dolbydecmft.dll", "domgmt.dll", "dosettings.dll", "dosvc.dll",
		     "dot3api.dll", "dot3cfg.dll", "dot3conn.dll", "dot3dlg.dll",
		     "dot3gpclnt.dll", "dot3gpui.dll", "dot3hc.dll", "dot3mm.dll",
		     "dot3msm.dll", "dot3svc.dll", "dot3ui.dll", "dpapi.dll",
		     "dpapiprovider.dll", "dpapisrv.dll", "dpnaddr.dll",
		     "dpnathlp.dll", "dpnet.dll", "dpnhpast.dll", "dpnhupnp.dll",
		     "dpnlobby.dll", "dps.dll", "dpx.dll", "drprov.dll", "drt.dll",
		     "drtprov.dll", "drttransport.dll", "drvsetup.dll",
		     "drvstore.dll", "dsauth.dll", "dsccore.dll",
		     "dsccoreconfprov.dll", "dsclient.dll", "dscproxy.dll",
		     "dsctimer.dll", "dsdmo.dll", "dskquota.dll", "dskquoui.dll",
		     "dsound.dll", "dsparse.dll", "dsprop.dll", "dsquery.dll",
		     "dsreg.dll", "dsregtask.dll", "dsrole.dll", "dssec.dll",
		     "dssenh.dll", "dssvc.dll", "dsui.dll", "dsuiext.dll",
		     "dswave.dll", "dtsh.dll", "ducsps.dll", "dui70.dll",
		     "duser.dll", "dusmapi.dll", "dusmsvc.dll", "dwmapi.dll",
		     "dwmcore.dll", "dwmghost.dll", "dwminit.dll", "dwmredir.dll",
		     "dwmscene.dll", "dwrite.dll", "dxcore.dll", "dxdiagn.dll",
		     "dxgi.dll", "dxgwdi.dll", "dxilconv.dll", "dxmasf.dll",
		     "dxp.dll", "dxpps.dll", "dxptasksync.dll", "dxtmsft.dll",
		     "dxtrans.dll", "dxva2.dll", "dynamoapi.dll", "eapp3hst.dll",
		     "eappcfg.dll", "eappcfgui.dll", "eappgnui.dll", "eapphost.dll",
		     "eappprxy.dll", "eapprovp.dll", "eapputil.dll",
		     "eapsimextdesktop.dll", "eapsvc.dll", "eapteapauth.dll",
		     "eapteapconfig.dll", "eapteapext.dll", "easconsent.dll",
		     "easwrt.dll", "edgeangle.dll", "edgecontent.dll",
		     "edgehtml.dll", "edgeiso.dll", "edgemanager.dll",
		     "edpauditapi.dll", "edpcsp.dll", "edptask.dll", "edputil.dll",
		     "eeprov.dll", "eeutil.dll", "efsadu.dll", "efscore.dll",
		     "efsext.dll", "efslsaext.dll", "efssvc.dll", "efsutil.dll",
		     "efswrt.dll", "ehstorapi.dll", "ehstorpwdmgr.dll",
		     "ehstorshell.dll", "els.dll", "elscore.dll", "elshyph.dll",
		     "elslad.dll", "elstrans.dll", "emailapis.dll",
		     "embeddedmodesvc.dll", "emojids.dll", "encapi.dll",
		     "energy.dll", "energyprov.dll", "energytask.dll",
		     "enrollmentapi.dll", "enterpriseapncsp.dll",
		     "enterprisecsps.dll", "enterpriseetw.dll", "eqossnap.dll",
		     "errordetails.dll", "errordetailscore.dll", "es.dll",
		     "esclprotocol.dll", "esclscan.dll", "esclwiadriver.dll",
		     "esdsip.dll", "esent.dll", "esentprf.dll", "esevss.dll",
		     "eshims.dll", "etwrundown.dll", "euiccscsp.dll",
		     "eventaggregation.dll", "eventcls.dll", "evr.dll",
		     "execmodelclient.dll", "execmodelproxy.dll",
		     "explorerframe.dll", "exsmime.dll", "extrasxmlparser.dll",
		     "f3ahvoas.dll", "facilitator.dll", "familysafetyext.dll",
		     "faultrep.dll", "fcon.dll", "fdbth.dll", "fdbthproxy.dll",
		     "fddevquery.dll", "fde.dll", "fdeploy.dll", "fdphost.dll",
		     "fdpnp.dll", "fdprint.dll", "fdproxy.dll", "fdrespub.dll",
		     "fdssdp.dll", "fdwcn.dll", "fdwnet.dll", "fdwsd.dll",
		     "feclient.dll", "ffbroker.dll", "fhcat.dll", "fhcfg.dll",
		     "fhcleanup.dll", "fhcpl.dll", "fhengine.dll", "fhevents.dll",
		     "fhshl.dll", "fhsrchapi.dll", "fhsrchph.dll", "fhsvc.dll",
		     "fhsvcctl.dll", "fhtask.dll", "fhuxadapter.dll", "fhuxapi.dll",
		     "fhuxcommon.dll", "fhuxgraphics.dll", "fhuxpresentation.dll",
		     "fidocredprov.dll", "filemgmt.dll", "filterds.dll",
		     "findnetprinters.dll", "firewallapi.dll", "flightsettings.dll",
		     "fltlib.dll", "fluencyds.dll", "fmapi.dll", "fmifs.dll",
		     "fms.dll", "fntcache.dll", "fontext.dll", "fontprovider.dll",
		     "fontsub.dll", "fphc.dll", "framedyn.dll", "framedynos.dll",
		     "frameserver.dll", "frprov.dll", "fsutilext.dll", "fthsvc.dll",
		     "fundisc.dll", "fveapi.dll", "fveapibase.dll", "fvecerts.dll",
		     "fvecpl.dll", "fveskybackup.dll", "fveui.dll", "fvewiz.dll",
		     "fwbase.dll", "fwcfg.dll", "fwmdmcsp.dll", "fwpolicyiomgr.dll",
		     "fwpuclnt.dll", "fwremotesvr.dll", "gameinput.dll",
		     "gamemode.dll", "gamestreamingext.dll", "gameux.dll",
		     "gamingtcui.dll", "gcdef.dll", "gdi32.dll", "gdi32full.dll",
		     "gdiplus.dll", "generaltel.dll", "geocommon.dll",
		     "geolocation.dll", "getuname.dll", "glmf32.dll",
		     "globinputhost.dll", "glu32.dll", "gmsaclient.dll",
		     "gpapi.dll", "gpcsewrappercsp.dll", "gpedit.dll",
		     "gpprefcl.dll", "gpprnext.dll", "gpscript.dll", "gpsvc.dll",
		     "gptext.dll", "graphicscapture.dll", "graphicsperfsvc.dll",
		     "groupinghc.dll", "hal.dll", "halextpl080.dll", "hascsp.dll",
		     "hashtagds.dll", "hbaapi.dll", "hcproviders.dll",
		     "hdcphandler.dll", "heatcore.dll", "helppaneproxy.dll",
		     "hgcpl.dll", "hhsetup.dll", "hid.dll", "hidcfu.dll",
		     "hidserv.dll", "hlink.dll", "hmkd.dll", "hnetcfg.dll",
		     "hnetcfgclient.dll", "hnetmon.dll", "hologramworld.dll",
		     "holoshellruntime.dll", "holoshextensions.dll", "hotplug.dll",
		     "hrtfapo.dll", "httpapi.dll", "httpprxc.dll", "httpprxm.dll",
		     "httpprxp.dll", "httpsdatasource.dll", "htui.dll",
		     "hvhostsvc.dll", "hvloader.dll", "hvsigpext.dll",
		     "hvsocket.dll", "hydrogen.dll", "ia2comproxy.dll", "ias.dll",
		     "iasacct.dll", "iasads.dll", "iasdatastore.dll", "iashlpr.dll",
		     "iasmigplugin.dll", "iasnap.dll", "iaspolcy.dll", "iasrad.dll",
		     "iasrecst.dll", "iassam.dll", "iassdo.dll", "iassvcs.dll",
		     "icfupgd.dll", "icm32.dll", "icmp.dll", "icmui.dll",
		     "iconcodecservice.dll", "icsigd.dll", "icsvc.dll",
		     "icsvcext.dll", "icu.dll", "icuin.dll", "icuuc.dll",
		     "idctrls.dll", "idlisten.dll", "idndl.dll", "idstore.dll",
		     "ieadvpack.dll", "ieapfltr.dll", "iedkcs32.dll", "ieframe.dll",
		     "iemigplugin.dll", "iepeers.dll", "ieproxy.dll",
		     "iernonce.dll", "iertutil.dll", "iesetup.dll", "iesysprep.dll",
		     "ieui.dll", "ifmon.dll", "ifsutil.dll", "ifsutilx.dll",
		     "igddiag.dll", "ihds.dll", "ikeext.dll", "imagehlp.dll",
		     "imageres.dll", "imagesp1.dll", "imapi.dll", "imapi2.dll",
		     "imapi2fs.dll", "imgutil.dll", "imm32.dll", "implatsetup.dll",
		     "indexeddblegacy.dll", "inetcomm.dll", "inetmib1.dll",
		     "inetpp.dll", "inetppui.dll", "inetres.dll", "inked.dll",
		     "inkobjcore.dll", "inproclogger.dll", "input.dll",
		     "inputcloudstore.dll", "inputcontroller.dll", "inputhost.dll",
		     "inputservice.dll", "inputswitch.dll", "inseng.dll",
		     "installservice.dll", "internetmail.dll",
		     "internetmailcsp.dll", "invagent.dll", "iologmsg.dll",
		     "iphlpapi.dll", "iphlpsvc.dll", "ipnathlp.dll",
		     "ipnathlpclient.dll", "ippcommon.dll", "ippcommonproxy.dll",
		     "iprtprio.dll", "iprtrmgr.dll", "ipsecsnp.dll", "ipsecsvc.dll",
		     "ipsmsnap.dll", "ipxlatcfg.dll", "iri.dll", "iscsicpl.dll",
		     "iscsidsc.dll", "iscsied.dll", "iscsiexe.dll", "iscsilog.dll",
		     "iscsium.dll", "iscsiwmi.dll", "iscsiwmiv2.dll", "ism.dll",
		     "itircl.dll", "itss.dll", "iuilp.dll", "iumbase.dll",
		     "iumcrypt.dll", "iumdll.dll", "iumsdk.dll", "iyuv_32.dll",
		     "joinproviderol.dll", "joinutil.dll", "jpmapcontrol.dll",
		     "jpndecoder.dll", "jpninputrouter.dll", "jpnranker.dll",
		     "jpnserviceds.dll", "jscript.dll", "jscript9.dll",
		     "jscript9diag.dll", "jsproxy.dll", "kbd101.dll", "kbd101a.dll",
		     "kbd101b.dll", "kbd101c.dll", "kbd103.dll", "kbd106.dll",
		     "kbd106n.dll", "kbda1.dll", "kbda2.dll", "kbda3.dll",
		     "kbdadlm.dll", "kbdal.dll", "kbdarme.dll", "kbdarmph.dll",
		     "kbdarmty.dll", "kbdarmw.dll", "kbdax2.dll", "kbdaze.dll",
		     "kbdazel.dll", "kbdazst.dll", "kbdbash.dll", "kbdbe.dll",
		     "kbdbene.dll", "kbdbgph.dll", "kbdbgph1.dll", "kbdbhc.dll",
		     "kbdblr.dll", "kbdbr.dll", "kbdbu.dll", "kbdbug.dll",
		     "kbdbulg.dll", "kbdca.dll", "kbdcan.dll", "kbdcher.dll",
		     "kbdcherp.dll", "kbdcr.dll", "kbdcz.dll", "kbdcz1.dll",
		     "kbdcz2.dll", "kbdda.dll", "kbddiv1.dll", "kbddiv2.dll",
		     "kbddv.dll", "kbddzo.dll", "kbdes.dll", "kbdest.dll",
		     "kbdfa.dll", "kbdfar.dll", "kbdfc.dll", "kbdfi.dll",
		     "kbdfi1.dll", "kbdfo.dll", "kbdfr.dll", "kbdfthrk.dll",
		     "kbdgae.dll", "kbdgeo.dll", "kbdgeoer.dll", "kbdgeome.dll",
		     "kbdgeooa.dll", "kbdgeoqw.dll", "kbdgkl.dll", "kbdgn.dll",
		     "kbdgr.dll", "kbdgr1.dll", "kbdgrlnd.dll", "kbdgthc.dll",
		     "kbdhau.dll", "kbdhaw.dll", "kbdhe.dll", "kbdhe220.dll",
		     "kbdhe319.dll", "kbdheb.dll", "kbdhebl3.dll", "kbdhela2.dll",
		     "kbdhela3.dll", "kbdhept.dll", "kbdhu.dll", "kbdhu1.dll",
		     "kbdibm02.dll", "kbdibo.dll", "kbdic.dll", "kbdinasa.dll",
		     "kbdinbe1.dll", "kbdinbe2.dll", "kbdinben.dll", "kbdindev.dll",
		     "kbdinen.dll", "kbdinguj.dll", "kbdinhin.dll", "kbdinkan.dll",
		     "kbdinmal.dll", "kbdinmar.dll", "kbdinori.dll", "kbdinpun.dll",
		     "kbdintam.dll", "kbdintel.dll", "kbdinuk2.dll", "kbdir.dll",
		     "kbdit.dll", "kbdit142.dll", "kbdiulat.dll", "kbdjav.dll",
		     "kbdjpn.dll", "kbdkaz.dll", "kbdkhmr.dll", "kbdkni.dll",
		     "kbdkor.dll", "kbdkurd.dll", "kbdkyr.dll", "kbdla.dll",
		     "kbdlao.dll", "kbdlisub.dll", "kbdlisus.dll", "kbdlk41a.dll",
		     "kbdlt.dll", "kbdlt1.dll", "kbdlt2.dll", "kbdlv.dll",
		     "kbdlv1.dll", "kbdlvst.dll", "kbdmac.dll", "kbdmacst.dll",
		     "kbdmaori.dll", "kbdmlt47.dll", "kbdmlt48.dll", "kbdmon.dll",
		     "kbdmonmo.dll", "kbdmonst.dll", "kbdmyan.dll", "kbdne.dll",
		     "kbdnec.dll", "kbdnec95.dll", "kbdnecat.dll", "kbdnecnt.dll",
		     "kbdnepr.dll", "kbdnko.dll", "kbdno.dll", "kbdno1.dll",
		     "kbdnso.dll", "kbdntl.dll", "kbdogham.dll", "kbdolch.dll",
		     "kbdoldit.dll", "kbdosa.dll", "kbdosm.dll", "kbdpash.dll",
		     "kbdphags.dll", "kbdpl.dll", "kbdpl1.dll", "kbdpo.dll",
		     "kbdro.dll", "kbdropr.dll", "kbdrost.dll", "kbdru.dll",
		     "kbdru1.dll", "kbdrum.dll", "kbdsf.dll", "kbdsg.dll",
		     "kbdsl.dll", "kbdsl1.dll", "kbdsmsfi.dll", "kbdsmsno.dll",
		     "kbdsn1.dll", "kbdsora.dll", "kbdsorex.dll", "kbdsors1.dll",
		     "kbdsorst.dll", "kbdsp.dll", "kbdsw.dll", "kbdsw09.dll",
		     "kbdsyr1.dll", "kbdsyr2.dll", "kbdtaile.dll", "kbdtajik.dll",
		     "kbdtam99.dll", "kbdtat.dll", "kbdth0.dll", "kbdth1.dll",
		     "kbdth2.dll", "kbdth3.dll", "kbdtifi.dll", "kbdtifi2.dll",
		     "kbdtiprc.dll", "kbdtiprd.dll", "kbdtt102.dll", "kbdtuf.dll",
		     "kbdtuq.dll", "kbdturme.dll", "kbdtzm.dll", "kbdughr.dll",
		     "kbdughr1.dll", "kbduk.dll", "kbdukx.dll", "kbdur.dll",
		     "kbdur1.dll", "kbdurdu.dll", "kbdus.dll", "kbdusa.dll",
		     "kbdusl.dll", "kbdusr.dll", "kbdusx.dll", "kbduzb.dll",
		     "kbdvntc.dll", "kbdwol.dll", "kbdyak.dll", "kbdyba.dll",
		     "kbdycc.dll", "kbdycl.dll", "kd.dll", "kdcom.dll", "kdcpw.dll",
		     "kdhvcom.dll", "kdnet.dll", "kdnet_uart16550.dll",
		     "kdscli.dll", "kdstub.dll", "kdusb.dll", "kd_02_10df.dll",
		     "kd_02_10ec.dll", "kd_02_1137.dll", "kd_02_14e4.dll",
		     "kd_02_15b3.dll", "kd_02_1969.dll", "kd_02_19a2.dll",
		     "kd_02_1af4.dll", "kd_02_8086.dll", "kd_07_1415.dll",
		     "kd_0c_8086.dll", "kerbclientshared.dll", "kerberos.dll",
		     "kernel32.dll", "kernelbase.dll", "keycredmgr.dll",
		     "keyiso.dll", "keymgr.dll", "knobscore.dll", "knobscsp.dll",
		     "ksuser.dll", "ktmw32.dll", "l2gpstore.dll", "l2nacp.dll",
		     "l2sechc.dll", "laprxy.dll", "legacynetux.dll", "lfsvc.dll",
		     "libcrypto.dll", "licensemanager.dll", "licensingcsp.dll",
		     "licensingdiagspp.dll", "licensingwinrt.dll", "licmgr10.dll",
		     "linkinfo.dll", "lltdapi.dll", "lltdres.dll", "lltdsvc.dll",
		     "lmhsvc.dll", "loadperf.dll", "localsec.dll", "localspl.dll",
		     "localui.dll", "locationapi.dll", "lockappbroker.dll",
		     "lockcontroller.dll", "lockscreendata.dll", "loghours.dll",
		     "logoncli.dll", "logoncontroller.dll", "lpasvc.dll", "lpk.dll",
		     "lsasrv.dll", "lscshostpolicy.dll", "lsm.dll", "lsmproxy.dll",
		     "lstelemetry.dll", "luainstall.dll", "luiapi.dll", "lz32.dll",
		     "magnification.dll", "maintenanceui.dll", "manageci.dll",
		     "mapconfiguration.dll", "mapcontrolcore.dll",
		     "mapgeocoder.dll", "mapi32.dll", "mapistub.dll",
		     "maprouter.dll", "mapsbtsvc.dll", "mapsbtsvcproxy.dll",
		     "mapscsp.dll", "mapsstore.dll", "mapstoasttask.dll",
		     "mapsupdatetask.dll", "mbaeapi.dll", "mbaeapipublic.dll",
		     "mbaexmlparser.dll", "mbmediamanager.dll", "mbsmsapi.dll",
		     "mbussdapi.dll", "mccsengineshared.dll", "mccspal.dll",
		     "mciavi32.dll", "mcicda.dll", "mciqtz32.dll", "mciseq.dll",
		     "mciwave.dll", "mcrecvsrc.dll", "mdmcommon.dll",
		     "mdmdiagnostics.dll", "mdminst.dll", "mdmmigrator.dll",
		     "mdmregistration.dll", "memorydiagnostic.dll",
		     "messagingservice.dll", "mf.dll", "mf3216.dll", "mfaacenc.dll",
		     "mfasfsrcsnk.dll", "mfaudiocnv.dll", "mfc42.dll", "mfc42u.dll",
		     "mfcaptureengine.dll", "mfcore.dll", "mfcsubs.dll", "mfds.dll",
		     "mfdvdec.dll", "mferror.dll", "mfh263enc.dll", "mfh264enc.dll",
		     "mfksproxy.dll", "mfmediaengine.dll", "mfmjpegdec.dll",
		     "mfmkvsrcsnk.dll", "mfmp4srcsnk.dll", "mfmpeg2srcsnk.dll",
		     "mfnetcore.dll", "mfnetsrc.dll", "mfperfhelper.dll",
		     "mfplat.dll", "mfplay.dll", "mfps.dll", "mfreadwrite.dll",
		     "mfsensorgroup.dll", "mfsrcsnk.dll", "mfsvr.dll",
		     "mftranscode.dll", "mfvdsp.dll", "mfvfw.dll", "mfwmaaec.dll",
		     "mgmtapi.dll", "mi.dll", "mibincodec.dll", "midimap.dll",
		     "migisol.dll", "miguiresource.dll", "mimefilt.dll",
		     "mimofcodec.dll", "minstoreevents.dll", "miracastinputmgr.dll",
		     "miracastreceiver.dll", "mirrordrvcompat.dll", "mispace.dll",
		     "mitigationclient.dll", "miutils.dll", "mlang.dll",
		     "mmcbase.dll", "mmcndmgr.dll", "mmcshext.dll", "mmdevapi.dll",
		     "mmgaclient.dll", "mmgaproxystub.dll", "mmres.dll",
		     "mobilenetworking.dll", "modemui.dll", "modernexecserver.dll",
		     "moricons.dll", "moshost.dll", "moshostclient.dll",
		     "moshostcore.dll", "mosstorage.dll", "mp3dmod.dll",
		     "mp43decd.dll", "mp4sdecd.dll", "mpeval.dll", "mpg4decd.dll",
		     "mpr.dll", "mprapi.dll", "mprddm.dll", "mprdim.dll",
		     "mprext.dll", "mprmsg.dll", "mpssvc.dll", "mpunits.dll",
		     "mrmcorer.dll", "mrmdeploy.dll", "mrmindexer.dll",
		     "mrt100.dll", "mrt_map.dll", "msaatext.dll", "msac3enc.dll",
		     "msacm32.dll", "msafd.dll", "msajapi.dll", "msalacdecoder.dll",
		     "msalacencoder.dll", "msamrnbdecoder.dll",
		     "msamrnbencoder.dll", "msamrnbsink.dll", "msamrnbsource.dll",
		     "msasn1.dll", "msauddecmft.dll", "msaudite.dll",
		     "msauserext.dll", "mscandui.dll", "mscat32.dll", "msclmd.dll",
		     "mscms.dll", "mscoree.dll", "mscorier.dll", "mscories.dll",
		     "msctf.dll", "msctfmonitor.dll", "msctfp.dll", "msctfui.dll",
		     "msctfuimanager.dll", "msdadiag.dll", "msdart.dll",
		     "msdelta.dll", "msdmo.dll", "msdrm.dll", "msdtckrm.dll",
		     "msdtclog.dll", "msdtcprx.dll", "msdtcspoffln.dll",
		     "msdtctm.dll", "msdtcuiu.dll", "msdtcvsp1res.dll",
		     "msfeeds.dll", "msfeedsbs.dll", "msflacdecoder.dll",
		     "msflacencoder.dll", "msftedit.dll", "msheif.dll",
		     "mshtml.dll", "mshtmldac.dll", "mshtmled.dll", "mshtmler.dll",
		     "msi.dll", "msicofire.dll", "msidcrl40.dll", "msident.dll",
		     "msidle.dll", "msidntld.dll", "msieftp.dll", "msihnd.dll",
		     "msiltcfg.dll", "msimg32.dll", "msimsg.dll", "msimtf.dll",
		     "msisip.dll", "msiso.dll", "msiwer.dll", "mskeyprotcli.dll",
		     "mskeyprotect.dll", "msls31.dll", "msmpeg2adec.dll",
		     "msmpeg2enc.dll", "msmpeg2vdec.dll", "msobjs.dll",
		     "msoert2.dll", "msopusdecoder.dll", "mspatcha.dll",
		     "mspatchc.dll", "msphotography.dll", "msports.dll",
		     "msprivs.dll", "msrahc.dll", "msrating.dll", "msrawimage.dll",
		     "msrdc.dll", "msrdpwebaccess.dll", "msrle32.dll",
		     "msscntrs.dll", "mssecuser.dll", "mssign32.dll", "mssip32.dll",
		     "mssitlb.dll", "mssph.dll", "mssprxy.dll", "mssrch.dll",
		     "mssvp.dll", "mstask.dll", "mstextprediction.dll",
		     "mstscax.dll", "msutb.dll", "msv1_0.dll", "msvcirt.dll",
		     "msvcp110_win.dll", "msvcp120_clr0400.dll",
		     "msvcp140_clr0400.dll", "msvcp60.dll", "msvcp_win.dll",
		     "msvcr100_clr0400.dll", "msvcr120_clr0400.dll", "msvcrt.dll",
		     "msvfw32.dll", "msvidc32.dll", "msvidctl.dll",
		     "msvideodsp.dll", "msvp9dec.dll", "msvproc.dll",
		     "msvpxenc.dll", "mswb7.dll", "mswebp.dll", "mswmdm.dll",
		     "mswsock.dll", "msxml3.dll", "msxml3r.dll", "msxml6.dll",
		     "msxml6r.dll", "msyuv.dll", "mtcmodel.dll", "mtf.dll",
		     "mtfappserviceds.dll", "mtfdecoder.dll", "mtffuzzyds.dll",
		     "mtfserver.dll", "mtfspellcheckds.dll", "mtxclu.dll",
		     "mtxdm.dll", "mtxex.dll", "mtxoci.dll", "muifontsetup.dll",
		     "mycomput.dll", "mydocs.dll", "napcrypt.dll", "napinsp.dll",
		     "naturalauth.dll", "naturallanguage6.dll", "navshutdown.dll",
		     "ncaapi.dll", "ncasvc.dll", "ncbservice.dll",
		     "ncdautosetup.dll", "ncdprop.dll", "nci.dll", "ncobjapi.dll",
		     "ncrypt.dll", "ncryptprov.dll", "ncryptsslp.dll", "ncsi.dll",
		     "ncuprov.dll", "nddeapi.dll", "ndfapi.dll", "ndfetw.dll",
		     "ndfhcdiscovery.dll", "ndishc.dll", "ndproxystub.dll",
		     "nduprov.dll", "negoexts.dll", "netapi32.dll", "netbios.dll",
		     "netcenter.dll", "netcfgx.dll", "netcorehc.dll",
		     "netdiagfx.dll", "netdriverinstall.dll", "netevent.dll",
		     "netfxperf.dll", "neth.dll", "netid.dll", "netiohlp.dll",
		     "netjoin.dll", "netlogon.dll", "netman.dll", "netmsg.dll",
		     "netplwiz.dll", "netprofm.dll", "netprofmsvc.dll",
		     "netprovfw.dll", "netprovisionsp.dll", "netsetupapi.dll",
		     "netsetupengine.dll", "netsetupshim.dll", "netsetupsvc.dll",
		     "netshell.dll", "nettrace.dll", "netutils.dll",
		     "networkexplorer.dll", "networkhelper.dll", "networkicon.dll",
		     "networkproxycsp.dll", "networkstatus.dll",
		     "networkuxbroker.dll", "newdev.dll", "nfcradiomedia.dll",
		     "ngccredprov.dll", "ngcctnr.dll", "ngcctnrsvc.dll",
		     "ngcisoctnr.dll", "ngckeyenum.dll", "ngcksp.dll",
		     "ngclocal.dll", "ngcpopkeysrv.dll", "ngcprocsp.dll",
		     "ngcrecovery.dll", "ngcsvc.dll", "ngctasks.dll", "ninput.dll",
		     "nlaapi.dll", "nlahc.dll", "nlasvc.dll", "nlhtml.dll",
		     "nlmgp.dll", "nlmproxy.dll", "nlmsprep.dll", "nlsbres.dll",
		     "nlsdata0000.dll", "nlsdata0009.dll", "nlsdl.dll",
		     "nlslexicons0009.dll", "nmadirect.dll", "normaliz.dll",
		     "npmproxy.dll", "npsm.dll", "nrpsrv.dll", "nshhttp.dll",
		     "nshipsec.dll", "nshwfp.dll", "nsi.dll", "nsisvc.dll",
		     "ntasn1.dll", "ntdll.dll", "ntdsapi.dll", "ntlanman.dll",
		     "ntlanui2.dll", "ntlmshared.dll", "ntmarta.dll", "ntprint.dll",
		     "ntshrui.dll", "ntvdm64.dll", "objsel.dll", "occache.dll",
		     "ocsetapi.dll", "odbc32.dll", "odbcbcp.dll", "odbcconf.dll",
		     "odbccp32.dll", "odbccr32.dll", "odbccu32.dll", "odbcint.dll",
		     "odbctrac.dll", "oemlicense.dll", "offfilt.dll",
		     "officecsp.dll", "offlinelsa.dll", "offlinesam.dll",
		     "offreg.dll", "ole32.dll", "oleacc.dll", "oleacchooks.dll",
		     "oleaccrc.dll", "oleaut32.dll", "oledlg.dll", "oleprn.dll",
		     "omadmagent.dll", "omadmapi.dll", "onebackuphandler.dll",
		     "onex.dll", "onexui.dll", "opcservices.dll", "opengl32.dll",
		     "ortcengine.dll", "osbaseln.dll", "osksupport.dll",
		     "osuninst.dll", "p2p.dll", "p2pgraph.dll", "p2pnetsh.dll",
		     "p2psvc.dll", "packager.dll", "panmap.dll", "pautoenr.dll",
		     "pcacli.dll", "pcadm.dll", "pcaevts.dll", "pcasvc.dll",
		     "pcaui.dll", "pcpksp.dll", "pcsvdevice.dll", "pcwum.dll",
		     "pcwutl.dll", "pdh.dll", "pdhui.dll", "peerdist.dll",
		     "peerdistad.dll", "peerdistcleaner.dll", "peerdistsh.dll",
		     "peerdistsvc.dll", "peopleapis.dll", "peopleband.dll",
		     "perceptiondevice.dll", "perfctrs.dll", "perfdisk.dll",
		     "perfnet.dll", "perfos.dll", "perfproc.dll", "perfts.dll",
		     "phoneom.dll", "phoneproviders.dll", "phoneservice.dll",
		     "phoneserviceres.dll", "phoneutil.dll", "phoneutilres.dll",
		     "photowiz.dll", "pickerplatform.dll", "pid.dll", "pidgenx.dll",
		     "pifmgr.dll", "pimstore.dll", "pkeyhelper.dll",
		     "pktmonapi.dll", "pku2u.dll", "pla.dll", "playlistfolder.dll",
		     "playsndsrv.dll", "playtodevice.dll", "playtomanager.dll",
		     "playtomenu.dll", "playtoreceiver.dll", "ploptin.dll",
		     "pmcsnap.dll", "pngfilt.dll", "pnidui.dll", "pnpclean.dll",
		     "pnppolicy.dll", "pnpts.dll", "pnpui.dll", "pnpxassoc.dll",
		     "pnpxassocprx.dll", "pnrpauto.dll", "pnrphc.dll",
		     "pnrpnsp.dll", "pnrpsvc.dll", "policymanager.dll",
		     "polstore.dll", "posetup.dll", "posyncservices.dll",
		     "pots.dll", "powercpl.dll", "powrprof.dll", "ppcsnap.dll",
		     "prauthproviders.dll", "prflbmsg.dll", "printui.dll",
		     "printwsdahost.dll", "prm0009.dll", "prncache.dll",
		     "prnfldr.dll", "prnntfy.dll", "prntvpt.dll", "profapi.dll",
		     "profext.dll", "profprov.dll", "profsvc.dll", "profsvcext.dll",
		     "propsys.dll", "provcore.dll", "provdatastore.dll",
		     "provdiagnostics.dll", "provengine.dll", "provhandlers.dll",
		     "provisioningcsp.dll", "provmigrate.dll", "provops.dll",
		     "provplugineng.dll", "provsysprep.dll", "provthrd.dll",
		     "proximitycommon.dll", "proximityservice.dll",
		     "prvdmofcomp.dll", "psapi.dll", "pshed.dll", "psisdecd.dll",
		     "psmsrv.dll", "pstask.dll", "pstorec.dll", "ptpprov.dll",
		     "puiapi.dll", "puiobj.dll", "pushtoinstall.dll",
		     "pwlauncher.dll", "pwrshplugin.dll", "pwsso.dll", "qasf.dll",
		     "qcap.dll", "qdv.dll", "qdvd.dll", "qedit.dll", "qedwipes.dll",
		     "qmgr.dll", "query.dll", "quiethours.dll", "qwave.dll",
		     "racengn.dll", "racpldlg.dll", "radardt.dll", "radarrs.dll",
		     "radcui.dll", "rasadhlp.dll", "rasapi32.dll", "rasauto.dll",
		     "raschap.dll", "raschapext.dll", "rasctrs.dll",
		     "rascustom.dll", "rasdiag.dll", "rasdlg.dll", "rasgcw.dll",
		     "rasman.dll", "rasmans.dll", "rasmbmgr.dll",
		     "rasmediamanager.dll", "rasmm.dll", "rasmontr.dll",
		     "rasplap.dll", "rasppp.dll", "rastapi.dll", "rastls.dll",
		     "rastlsext.dll", "rdbui.dll", "rdpbase.dll", "rdpcfgex.dll",
		     "rdpcore.dll", "rdpcorets.dll", "rdpencom.dll", "rdpendp.dll",
		     "rdpnano.dll", "rdpsaps.dll", "rdpserverbase.dll",
		     "rdpsharercom.dll", "rdpudd.dll", "rdpviewerax.dll",
		     "rdsappxhelper.dll", "rdsdwmdr.dll", "rdvvmtransport.dll",
		     "rdxservice.dll", "rdxtaskfactory.dll", "reagent.dll",
		     "reagenttask.dll", "recovery.dll", "regapi.dll", "regctrl.dll",
		     "regidle.dll", "regsvc.dll", "reguwpapi.dll", "reinfo.dll",
		     "remotepg.dll", "remotewipecsp.dll", "reportingcsp.dll",
		     "resampledmo.dll", "resbparser.dll", "reseteng.dll",
		     "resetengine.dll", "resetengonline.dll", "resourcemapper.dll",
		     "resutils.dll", "rgb9rast.dll", "riched20.dll", "riched32.dll",
		     "rjvmdmconfig.dll", "rmapi.dll", "rmclient.dll", "rnr20.dll",
		     "roamingsecurity.dll", "rometadata.dll", "rotmgr.dll",
		     "rpcepmap.dll", "rpchttp.dll", "rpcns4.dll", "rpcnsh.dll",
		     "rpcrt4.dll", "rpcrtremote.dll", "rpcss.dll", "rsaenh.dll",
		     "rshx32.dll", "rstrtmgr.dll", "rtffilt.dll", "rtm.dll",
		     "rtmediaframe.dll", "rtmmvrortc.dll", "rtutils.dll",
		     "rtworkq.dll", "rulebasedds.dll", "samcli.dll", "samlib.dll",
		     "samsrv.dll", "sas.dll", "sbe.dll", "sbeio.dll", "sberes.dll",
		     "sbservicetrigger.dll", "scansetting.dll", "scardbi.dll",
		     "scarddlg.dll", "scardsvr.dll", "scavengeui.dll",
		     "scdeviceenum.dll", "scecli.dll", "scesrv.dll", "schannel.dll",
		     "schedcli.dll", "schedsvc.dll", "scksp.dll", "scripto.dll",
		     "scrobj.dll", "scrptadm.dll", "scrrun.dll", "sdcpl.dll",
		     "sdds.dll", "sdengin2.dll", "sdfhost.dll", "sdhcinst.dll",
		     "sdiageng.dll", "sdiagprv.dll", "sdiagschd.dll", "sdohlp.dll",
		     "sdrsvc.dll", "sdshext.dll", "searchfolder.dll", "sechost.dll",
		     "seclogon.dll", "secproc.dll", "secproc_isv.dll",
		     "secproc_ssp.dll", "secproc_ssp_isv.dll", "secur32.dll",
		     "security.dll", "semgrps.dll", "semgrsvc.dll", "sendmail.dll",
		     "sens.dll", "sensapi.dll", "sensorsapi.dll", "sensorscpl.dll",
		     "sensorservice.dll", "sensorsnativeapi.dll",
		     "sensorsutilsv2.dll", "sensrsvc.dll", "serialui.dll",
		     "servicinguapi.dll", "serwvdrv.dll", "sessenv.dll",
		     "setbcdlocale.dll", "settingmonitor.dll", "settingsync.dll",
		     "settingsynccore.dll", "setupapi.dll", "setupcl.dll",
		     "setupcln.dll", "setupetw.dll", "sfc.dll", "sfc_os.dll",
		     "sgrmenclave.dll", "shacct.dll", "shacctprofile.dll",
		     "sharedpccsp.dll", "sharedrealitysvc.dll", "sharehost.dll",
		     "sharemediacpl.dll", "shcore.dll", "shdocvw.dll",
		     "shell32.dll", "shellstyle.dll", "shfolder.dll", "shgina.dll",
		     "shimeng.dll", "shimgvw.dll", "shlwapi.dll", "shpafact.dll",
		     "shsetup.dll", "shsvcs.dll", "shunimpl.dll", "shutdownext.dll",
		     "shutdownux.dll", "shwebsvc.dll", "signdrv.dll", "simauth.dll",
		     "simcfg.dll", "skci.dll", "slc.dll", "slcext.dll", "slwga.dll",
		     "smartscreenps.dll", "smbhelperclass.dll", "smbwmiv2.dll",
		     "smiengine.dll", "smphost.dll", "smsroutersvc.dll",
		     "sndvolsso.dll", "snmpapi.dll", "socialapis.dll",
		     "softkbd.dll", "softpub.dll", "sortwindows61.dll",
		     "sortwindows62.dll", "spacebridge.dll", "spacecontrol.dll",
		     "spatializerapo.dll", "spatialstore.dll", "spbcd.dll",
		     "speechpal.dll", "spfileq.dll", "spinf.dll", "spmpm.dll",
		     "spnet.dll", "spoolss.dll", "spopk.dll", "spp.dll", "sppc.dll",
		     "sppcext.dll", "sppcomapi.dll", "sppcommdlg.dll",
		     "sppinst.dll", "sppnp.dll", "sppobjs.dll", "sppwinob.dll",
		     "sppwmi.dll", "spwinsat.dll", "spwizeng.dll", "spwizimg.dll",
		     "spwizres.dll", "spwmp.dll", "sqlsrv32.dll", "sqmapi.dll",
		     "srchadmin.dll", "srclient.dll", "srcore.dll", "srevents.dll",
		     "srh.dll", "srhelper.dll", "srm.dll", "srmclient.dll",
		     "srmlib.dll", "srmscan.dll", "srmshell.dll", "srmstormod.dll",
		     "srmtrace.dll", "srm_ps.dll", "srpapi.dll", "srrstr.dll",
		     "srumapi.dll", "srumsvc.dll", "srvcli.dll", "srvsvc.dll",
		     "srwmi.dll", "sscore.dll", "sscoreext.dll", "ssdm.dll",
		     "ssdpapi.dll", "ssdpsrv.dll", "sspicli.dll", "sspisrv.dll",
		     "ssshim.dll", "sstpsvc.dll", "starttiledata.dll",
		     "startupscan.dll", "stclient.dll", "sti.dll", "sti_ci.dll",
		     "stobject.dll", "storageusage.dll", "storagewmi.dll",
		     "storewuauth.dll", "storprop.dll", "storsvc.dll",
		     "streamci.dll", "structuredquery.dll", "sud.dll", "svf.dll",
		     "svsvc.dll", "swprv.dll", "sxproxy.dll", "sxs.dll",
		     "sxshared.dll", "sxssrv.dll", "sxsstore.dll", "synccenter.dll",
		     "synccontroller.dll", "synchostps.dll", "syncproxy.dll",
		     "syncreg.dll", "syncres.dll", "syncsettings.dll",
		     "syncutil.dll", "sysclass.dll", "sysfxui.dll", "sysmain.dll",
		     "sysntfy.dll", "syssetup.dll", "systemcpl.dll", "t2embed.dll",
		     "tabbtn.dll", "tabbtnex.dll", "tabsvc.dll", "tapi3.dll",
		     "tapi32.dll", "tapilua.dll", "tapimigplugin.dll",
		     "tapiperf.dll", "tapisrv.dll", "tapisysprep.dll", "tapiui.dll",
		     "taskapis.dll", "taskbarcpl.dll", "taskcomp.dll",
		     "taskschd.dll", "taskschdps.dll", "tbauth.dll", "tbs.dll",
		     "tcbloader.dll", "tcpipcfg.dll", "tcpmib.dll", "tcpmon.dll",
		     "tcpmonui.dll", "tdh.dll", "tdlmigration.dll", "tellib.dll",
		     "termmgr.dll", "termsrv.dll", "tetheringclient.dll",
		     "tetheringmgr.dll", "tetheringservice.dll",
		     "tetheringstation.dll", "textshaping.dll", "themecpl.dll",
		     "themeservice.dll", "themeui.dll", "threadpoolwinrt.dll",
		     "thumbcache.dll", "timebrokerclient.dll",
		     "timebrokerserver.dll", "timesync.dll", "timesynctask.dll",
		     "tlscsp.dll", "tokenbinding.dll", "tokenbroker.dll",
		     "tokenbrokerui.dll", "tpmcertresources.dll", "tpmcompc.dll",
		     "tpmtasks.dll", "tpmvsc.dll", "tquery.dll", "traffic.dll",
		     "transportdsa.dll", "trie.dll", "trkwks.dll", "tsbyuv.dll",
		     "tscfgwmi.dll", "tserrredir.dll", "tsf3gip.dll", "tsgqec.dll",
		     "tsmf.dll", "tspkg.dll", "tspubwmi.dll", "tssessionux.dll",
		     "tssrvlic.dll", "tsworkspace.dll", "ttdloader.dll",
		     "ttdplm.dll", "ttdrecord.dll", "ttdrecordcpu.dll",
		     "ttlsauth.dll", "ttlscfg.dll", "ttlsext.dll", "tvratings.dll",
		     "twext.dll", "twinapi.dll", "twinui.dll", "txflog.dll",
		     "txfw32.dll", "tzautoupdate.dll", "tzres.dll", "tzsyncres.dll",
		     "ubpm.dll", "ucmhc.dll", "ucrtbase.dll",
		     "ucrtbase_clr0400.dll", "ucrtbase_enclave.dll", "udhisapi.dll",
		     "udwm.dll", "ueficsp.dll", "uexfat.dll", "ufat.dll",
		     "uiamanager.dll", "uianimation.dll", "uiautomationcore.dll",
		     "uicom.dll", "uireng.dll", "uiribbon.dll", "uiribbonres.dll",
		     "ulib.dll", "umb.dll", "umdmxfrm.dll", "umpdc.dll",
		     "umpnpmgr.dll", "umpo-overrides.dll", "umpo.dll",
		     "umpoext.dll", "umpowmi.dll", "umrdp.dll", "unattend.dll",
		     "unenrollhook.dll", "unimdmat.dll", "uniplat.dll",
		     "unistore.dll", "untfs.dll", "updateagent.dll",
		     "updatecsp.dll", "updatepolicy.dll", "upnp.dll",
		     "upnphost.dll", "upshared.dll", "urefs.dll", "urefsv1.dll",
		     "ureg.dll", "url.dll", "urlmon.dll", "usbcapi.dll",
		     "usbceip.dll", "usbmon.dll", "usbperf.dll", "usbpmapi.dll",
		     "usbtask.dll", "usbui.dll", "user32.dll", "usercpl.dll",
		     "userdataservice.dll", "userdatatimeutil.dll", "userenv.dll",
		     "userinitext.dll", "usermgr.dll", "usermgrcli.dll",
		     "usermgrproxy.dll", "usoapi.dll", "usocoreps.dll",
		     "usosvc.dll", "usp10.dll", "ustprov.dll", "utcutil.dll",
		     "utildll.dll", "uudf.dll", "uvcmodel.dll", "uwfcfgmgmt.dll",
		     "uwfcsp.dll", "uwfservicingapi.dll", "uxinit.dll", "uxlib.dll",
		     "uxlibres.dll", "uxtheme.dll", "vac.dll", "van.dll",
		     "vault.dll", "vaultcds.dll", "vaultcli.dll",
		     "vaultroaming.dll", "vaultsvc.dll", "vbsapi.dll",
		     "vbscript.dll", "vbssysprep.dll", "vcardparser.dll",
		     "vdsbas.dll", "vdsdyn.dll", "vdsutil.dll", "vdsvd.dll",
		     "vds_ps.dll", "verifier.dll", "vertdll.dll", "vfuprov.dll",
		     "vfwwdm32.dll", "vhfum.dll", "vid.dll", "videohandlers.dll",
		     "vidreszr.dll", "virtdisk.dll", "vmbuspipe.dll",
		     "vmdevicehost.dll", "vmictimeprovider.dll", "vmrdvcore.dll",
		     "voiprt.dll", "vpnike.dll", "vpnikeapi.dll",
		     "vpnsohdesktop.dll", "vpnv2csp.dll", "vscmgrps.dll",
		     "vssapi.dll", "vsstrace.dll", "vss_ps.dll", "w32time.dll",
		     "w32topl.dll", "waasassessment.dll", "waasmediccapsule.dll",
		     "waasmedicps.dll", "waasmedicsvc.dll", "wabsyncprovider.dll",
		     "walletproxy.dll", "walletservice.dll", "wavemsp.dll",
		     "wbemcomn.dll", "wbiosrvc.dll", "wci.dll", "wcimage.dll",
		     "wcmapi.dll", "wcmcsp.dll", "wcmsvc.dll", "wcnapi.dll",
		     "wcncsvc.dll", "wcneapauthproxy.dll", "wcneappeerproxy.dll",
		     "wcnnetsh.dll", "wcnwiz.dll", "wc_storage.dll", "wdc.dll",
		     "wdi.dll", "wdigest.dll", "wdscore.dll", "webauthn.dll",
		     "webcamui.dll", "webcheck.dll", "webclnt.dll", "webio.dll",
		     "webservices.dll", "websocket.dll", "wecapi.dll", "wecsvc.dll",
		     "wephostsvc.dll", "wer.dll", "werconcpl.dll",
		     "wercplsupport.dll", "werenc.dll", "weretw.dll", "wersvc.dll",
		     "werui.dll", "wevtapi.dll", "wevtfwd.dll", "wevtsvc.dll",
		     "wfapigp.dll", "wfdprov.dll", "wfdsconmgr.dll",
		     "wfdsconmgrsvc.dll", "wfhc.dll", "whealogr.dll",
		     "whhelper.dll", "wiaaut.dll", "wiadefui.dll", "wiadss.dll",
		     "wiarpc.dll", "wiascanprofiles.dll", "wiaservc.dll",
		     "wiashext.dll", "wiatrace.dll", "wificloudstore.dll",
		     "wificonfigsp.dll", "wifidisplay.dll", "wimgapi.dll",
		     "win32spl.dll", "win32u.dll", "winbio.dll",
		     "winbiodatamodel.dll", "winbioext.dll", "winbrand.dll",
		     "wincorlib.dll", "wincredprovider.dll", "wincredui.dll",
		     "windowmanagement.dll", "windowscodecs.dll",
		     "windowscodecsext.dll", "windowscodecsraw.dll",
		     "windowsiotcsp.dll", "windowslivelogin.dll", "winethc.dll",
		     "winhttp.dll", "winhttpcom.dll", "winhvemulation.dll",
		     "winhvplatform.dll", "wininet.dll", "wininetlui.dll",
		     "wininitext.dll", "winipcfile.dll", "winipcsecproc.dll",
		     "winipsec.dll", "winlangdb.dll", "winlogonext.dll",
		     "winmde.dll", "winml.dll", "winmm.dll", "winmmbase.dll",
		     "winmsipc.dll", "winnlsres.dll", "winnsi.dll",
		     "winreagent.dll", "winrnr.dll", "winrscmd.dll", "winrsmgr.dll",
		     "winrssrv.dll", "winrttracing.dll", "winsatapi.dll",
		     "winscard.dll", "winsetupui.dll", "winshfhc.dll", "winsku.dll",
		     "winsockhc.dll", "winsqlite3.dll", "winsrpc.dll", "winsrv.dll",
		     "winsrvext.dll", "winsta.dll", "winsync.dll",
		     "winsyncmetastore.dll", "winsyncproviders.dll", "wintrust.dll",
		     "wintypes.dll", "winusb.dll", "wirednetworkcsp.dll",
		     "wisp.dll", "wkscli.dll", "wkspbrokerax.dll", "wksprtps.dll",
		     "wkssvc.dll", "wlanapi.dll", "wlancfg.dll", "wlanconn.dll",
		     "wlandlg.dll", "wlangpui.dll", "wlanhc.dll", "wlanhlp.dll",
		     "wlanmediamanager.dll", "wlanmm.dll", "wlanmsm.dll",
		     "wlanpref.dll", "wlanradiomanager.dll", "wlansec.dll",
		     "wlansvc.dll", "wlansvcpal.dll", "wlanui.dll", "wlanutil.dll",
		     "wldap32.dll", "wldp.dll", "wlgpclnt.dll", "wlidcli.dll",
		     "wlidcredprov.dll", "wlidfdp.dll", "wlidnsp.dll",
		     "wlidprov.dll", "wlidres.dll", "wlidsvc.dll", "wmadmod.dll",
		     "wmadmoe.dll", "wmalfxgfxdsp.dll", "wmasf.dll",
		     "wmcodecdspps.dll", "wmdmlog.dll", "wmdmps.dll",
		     "wmdrmsdk.dll", "wmerror.dll", "wmi.dll", "wmiclnt.dll",
		     "wmicmiplugin.dll", "wmidcom.dll", "wmidx.dll", "wmiprop.dll",
		     "wmitomi.dll", "wmnetmgr.dll", "wmp.dll", "wmpdui.dll",
		     "wmpdxm.dll", "wmpeffects.dll", "wmphoto.dll", "wmploc.dll",
		     "wmpps.dll", "wmpshell.dll", "wmsgapi.dll", "wmspdmod.dll",
		     "wmspdmoe.dll", "wmvcore.dll", "wmvdecod.dll", "wmvdspa.dll",
		     "wmvencod.dll", "wmvsdecd.dll", "wmvsencd.dll", "wmvxencd.dll",
		     "woftasks.dll", "wofutil.dll", "wordbreakers.dll",
		     "workfoldersgpext.dll", "workfoldersres.dll",
		     "workfoldersshell.dll", "workfolderssvc.dll", "wosc.dll",
		     "wow64.dll", "wow64cpu.dll", "wow64win.dll", "wpbcreds.dll",
		     "wpc.dll", "wpcapi.dll", "wpcdesktopmonsvc.dll",
		     "wpcproxystubs.dll", "wpcrefreshtask.dll", "wpcwebfilter.dll",
		     "wpdbusenum.dll", "wpdshext.dll", "wpdshserviceobj.dll",
		     "wpdsp.dll", "wpd_ci.dll", "wpnapps.dll", "wpnclient.dll",
		     "wpncore.dll", "wpninprc.dll", "wpnprv.dll", "wpnservice.dll",
		     "wpnsruprov.dll", "wpnuserservice.dll", "wpportinglibrary.dll",
		     "wpprecorderum.dll", "wptaskscheduler.dll", "wpx.dll",
		     "ws2help.dll", "ws2_32.dll", "wscapi.dll", "wscinterop.dll",
		     "wscisvif.dll", "wsclient.dll", "wscproxystub.dll",
		     "wscsvc.dll", "wsdapi.dll", "wsdchngr.dll",
		     "wsdprintproxy.dll", "wsdproviderutil.dll", "wsdscanproxy.dll",
		     "wsecedit.dll", "wsepno.dll", "wshbth.dll", "wshcon.dll",
		     "wshelper.dll", "wshext.dll", "wshhyperv.dll", "wship6.dll",
		     "wshqos.dll", "wshrm.dll", "wshtcpip.dll", "wshunix.dll",
		     "wslapi.dll", "wsmagent.dll", "wsmauto.dll", "wsmplpxy.dll",
		     "wsmres.dll", "wsmsvc.dll", "wsmwmipl.dll", "wsnmp32.dll",
		     "wsock32.dll", "wsplib.dll", "wsp_fs.dll", "wsp_health.dll",
		     "wsp_sr.dll", "wtsapi32.dll", "wuapi.dll", "wuaueng.dll",
		     "wuceffects.dll", "wudfcoinstaller.dll", "wudfplatform.dll",
		     "wudfsmcclassext.dll", "wudfx.dll", "wudfx02000.dll",
		     "wudriver.dll", "wups.dll", "wups2.dll", "wuuhext.dll",
		     "wuuhosdeployment.dll", "wvc.dll", "wwaapi.dll", "wwaext.dll",
		     "wwanapi.dll", "wwancfg.dll", "wwanhc.dll", "wwanprotdim.dll",
		     "wwanradiomanager.dll", "wwansvc.dll", "wwapi.dll",
		     "xamltilerender.dll", "xaudio2_8.dll", "xaudio2_9.dll",
		     "xblauthmanager.dll", "xblgamesave.dll", "xblgamesaveext.dll",
		     "xblgamesaveproxy.dll", "xboxgipsvc.dll",
		     "xboxgipsynthetic.dll", "xboxnetapisvc.dll", "xinput1_4.dll",
		     "xinput9_1_0.dll", "xinputuap.dll", "xmlfilter.dll",
		     "xmllite.dll", "xmlprovi.dll", "xolehlp.dll",
		     "xpsgdiconverter.dll", "xpsprint.dll", "xpspushlayer.dll",
		     "xpsrasterservice.dll", "xpsservices.dll", "xwizards.dll",
		     "xwreg.dll", "xwtpdui.dll", "xwtpw32.dll", "zipcontainer.dll",
		     "zipfldr.dll", "bootsvc.dll", "halextintcpsedma.dll",
		     "icsvcvss.dll", "ieproxydesktop.dll", "lsaadt.dll",
		     "nlansp_c.dll", "nrtapi.dll", "opencl.dll", "pfclient.dll",
		     "pnpdiag.dll", "prxyqry.dll", "rdpnanotransport.dll",
		     "servicingcommon.dll", "sortwindows63.dll", "sstpcfg.dll",
		     "tdhres.dll", "umpodev.dll", "utcapi.dll", "windlp.dll",
		     "wow64base.dll", "wow64con.dll", "blbuires.dll", "bpainst.dll",
		     "cbclient.dll", "certadm.dll", "certocm.dll", "certpick.dll",
		     "csdeployres.dll", "dsdeployres.dll", "eapa3hst.dll",
		     "eapacfg.dll", "eapahost.dll", "elsext.dll", "encdump.dll",
		     "escmigplugin.dll", "fsclient.dll", "fsdeployres.dll",
		     "fssminst.dll", "fssmres.dll", "fssprov.dll", "ipamapi.dll",
		     "kpssvc.dll", "lbfoadminlib.dll", "mintdh.dll", "mmci.dll",
		     "mmcico.dll", "mprsnap.dll", "mstsmhst.dll", "mstsmmc.dll",
		     "muxinst.dll", "personax.dll", "rassfm.dll", "rasuser.dll",
		     "rdmsinst.dll", "rdmsres.dll", "rtrfiltr.dll", "sacsvr.dll",
		     "scrdenrl.dll", "sdclient.dll", "sharedstartmodel.dll",
		     "smsrouter.dll", "spwizimg_svr.dll", "sqlcecompact40.dll",
		     "sqlceoledb40.dll", "sqlceqp40.dll", "sqlcese40.dll",
		     "srvmgrinst.dll", "svrmgrnc.dll", "tapisnap.dll",
		     "tlsbrand.dll", "tsec.dll", "tsprop.dll",
		     "tspubiconhelper.dll", "tssdjet.dll", "tsuserex.dll",
		     "ualapi.dll", "ualsvc.dll", "umcres.dll", "updatehandlers.dll",
		     "usocore.dll", "vssui.dll", "wsbappres.dll", "wsbonline.dll",
		     "wsmselpl.dll", "wsmselrr.dll", "xpsfilt.dll", "xpsshhdr.dll"
		     ) and     not (       (         dll.name : "icuuc.dll" and
		     dll.code_signature.subject_name in (           "Valve", "Valve
		     Corp.", "Avanquest Software (7270356 Canada Inc)", "Adobe Inc."
		     ) and dll.code_signature.trusted == true       ) or       (
		     dll.name : ("timeSync.dll", "appInfo.dll") and
		     dll.code_signature.subject_name in (           "VMware Inc.",
		     "VMware, Inc."         ) and dll.code_signature.trusted == true
		     ) or       (         dll.name : "libcrypto.dll" and
		     dll.code_signature.subject_name in (           "NoMachine
		     S.a.r.l.", "Oculus VR, LLC"         ) and
		     dll.code_signature.trusted == true       ) or       (
		     dll.name : "ucrtbase.dll" and dll.code_signature.subject_name
		     in (           "Proofpoint, Inc.", "Rapid7 LLC", "Eclipse.org
		     Foundation, Inc.", "Amazon.com Services LLC", "Windows Phone"
		     ) and dll.code_signature.trusted == true       ) or       (
		     dll.name : ("libcrypto.dll", "wmi.dll", "geolocation.dll",
		     "kerberos.dll") and         dll.code_signature.subject_name ==
		     "Bitdefender SRL" and dll.code_signature.trusted == true
		     ) or       (dll.name : "ICMP.dll" and
		     dll.code_signature.subject_name == "Paessler AG" and
		     dll.code_signature.trusted == true) or       (dll.name :
		     "dbghelp.dll" and dll.code_signature.trusted == true) or
		     (dll.name : "DirectML.dll" and dll.code_signature.subject_name
		     == "Adobe Inc." and dll.code_signature.trusted == true) or
		     (dll.name : "icsvc.dll" and dll.code_signature.subject_name in
		     ("Dell Inc", "Dell Technologies Inc.") and
		     dll.code_signature.trusted == true) or       (dll.name :
		     "offreg.dll" and dll.code_signature.subject_name ==
		     "Malwarebytes Inc." and dll.code_signature.trusted == true) or
		     (dll.name : "AppMgr.dll" and dll.code_signature.subject_name ==
		     "Autodesk, Inc" and dll.code_signature.trusted == true) or
		     (dll.name : ("SsShim.dll", "Msi.dll", "wdscore.dll") and
		     process.name : "DismHost.exe" and dll.path :
		     "C:\\Windows\\Temp\\*") or       (         dll.path : (
		     "?:\\Windows\\SystemApps\\*\\dxgi.dll",
		     "?:\\Windows\\SystemApps\\*\\wincorlib.dll",
		     "?:\\Windows\\dxgi.dll",
		     "?:\\Users\\*\\AppData\\Local\\LINE\\bin\\current\\dbghelp.dll"
		     )       )     )

NamE: Potential Persistence via Time Provider Modification
	description: 
		     Identifies modification of the Time Provider.
		     Adversaries may establish persistence by registering and
		     enabling a malicious DLL as a time provider. Windows uses the
		     time provider architecture to obtain accurate time stamps from
		     other network devices or clients in the network. Time providers
		     are implemented in the form of a DLL file which resides in the
		     System32 folder. The service W32Time initiates during the
		     startup of Windows and loads w32time.dll.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.path: (     "HKLM\\SYSTEM
		     \\*ControlSet*\\Services\\W32Time\\TimeProviders\\*",     "\\RE
		     GISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Services\\W32Time\\TimeP
		     roviders\\*",     "MACHINE\\SYSTEM\\*ControlSet*\\Services\\W32
		     Time\\TimeProviders\\*"   ) and   registry.data.strings:"*.dll"
		     and   not   (     process.executable :
		     "?:\\Windows\\System32\\msiexec.exe" and
		     registry.data.strings : "?:\\Program Files\\VMware\\VMware
		     Tools\\vmwTimeProvider\\vmwTimeProvider.dll"   ) and   not
		     registry.data.strings : "C:\\Windows\\SYSTEM32\\w32time.DLL"

NamE: SystemKey Access via Command Line
	description: 
		     Keychains are the built-in way for macOS to keep
		     track of users' passwords and credentials for many services and
		     features, including Wi-Fi and website passwords, secure notes,
		     certificates, and Kerberos. Adversaries may collect the
		     keychain storage data from a system to acquire credentials.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:(start or process_started) and
		     process.args:("/private/var/db/SystemKey" or
		     "/var/db/SystemKey") and   not
		     process.Ext.effective_parent.executable :
		     "/Library/Elastic/Endpoint/elastic-
		     endpoint.app/Contents/MacOS/elastic-endpoint"

NamE: NullSessionPipe Registry Modification
	description: 
		     Identifies NullSessionPipe registry
		     modifications that specify which pipes can be accessed
		     anonymously. This could be indicative of adversary lateral
		     movement preparation by making the added pipe available to
		     everyone.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and registry.path : (     "HKLM\\SYSTEM\
		     \*ControlSet*\\services\\LanmanServer\\Parameters\\NullSessionP
		     ipes",     "\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\services
		     \\LanmanServer\\Parameters\\NullSessionPipes",     "MACHINE\\SY
		     STEM\\*ControlSet*\\services\\LanmanServer\\Parameters\\NullSes
		     sionPipes" ) and length(registry.data.strings) > 0 and not
		     registry.data.strings : "(empty)"

NamE: Potential Reverse Shell via Suspicious Binary
	description: 
		     This detection rule detects the creation of a
		     shell through a chain consisting of the execution of a
		     suspicious binary (located in a commonly abused location or
		     executed manually) followed by a network event and ending with
		     a shell being spawned. Stageless reverse tcp shells display
		     this behaviour. Attackers may spawn reverse shells to establish
		     persistence onto a target system.
	query: 
		     sequence by host.id, process.entity_id with maxspan=1s
		     [ process where host.os.type == "linux" and event.type ==
		     "start" and event.action == "exec" and   process.executable : (
		     "./*", "/tmp/*", "/var/tmp/*", "/var/www/*", "/dev/shm/*",
		     "/etc/init.d/*", "/etc/rc*.d/*",   "/etc/crontab",
		     "/etc/cron.*", "/etc/update-motd.d/*", "/usr/lib/update-
		     notifier/*",   "/boot/*", "/srv/*", "/run/*", "/root/*",
		     "/etc/rc.local"    ) and   process.parent.name : ("bash",
		     "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish") and not
		     process.name : ("curl", "wget", "ping", "apt", "dpkg", "yum",
		     "rpm", "dnf", "dockerd") ] [ network where host.os.type ==
		     "linux" and event.type == "start" and event.action in
		     ("connection_attempted", "connection_accepted") and
		     process.executable : (   "./*", "/tmp/*", "/var/tmp/*",
		     "/var/www/*", "/dev/shm/*", "/etc/init.d/*", "/etc/rc*.d/*",
		     "/etc/crontab", "/etc/cron.*", "/etc/update-motd.d/*",
		     "/usr/lib/update-notifier/*",   "/boot/*", "/srv/*", "/run/*",
		     "/root/*", "/etc/rc.local"    ) and destination.ip != null and
		     destination.ip != "127.0.0.1" and destination.ip != "::1" ] [
		     process where host.os.type == "linux" and event.type == "start"
		     and event.action == "exec" and   process.name : ("bash",
		     "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish") and
		     process.parent.name : ("bash", "dash", "sh", "tcsh", "csh",
		     "zsh", "ksh", "fish") ]

NamE: AWS SQS Queue Purge
	description: 
		     Identifies when an AWS Simple Queue Service
		     (SQS) queue is purged. Adversaries may purge SQS queues to
		     disrupt operations, delete messages, or impair monitoring and
		     alerting mechanisms. This action can be used to evade detection
		     and cover tracks by removing evidence of malicious activities.
	query: 
		     event.dataset:"aws.cloudtrail"     and
		     event.provider:"sqs.amazonaws.com"     and
		     event.action:"PurgeQueue"     and event.outcome:"success"

NamE: PowerShell Script with Token Impersonation Capabilities
	description: 
		     Detects scripts that contain PowerShell
		     functions, structures, or Windows API functions related to
		     token impersonation/theft. Attackers may duplicate then
		     impersonate another user's token to escalate privileges and
		     bypass access controls.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text:(     "Invoke-
		     TokenManipulation" or     "ImpersonateNamedPipeClient" or
		     "NtImpersonateThread" or     (       "STARTUPINFOEX" and
		     "UpdateProcThreadAttribute"     ) or     (
		     "AdjustTokenPrivileges" and       "SeDebugPrivilege"     ) or
		     (       ("DuplicateToken" or       "DuplicateTokenEx") and
		     ("SetThreadToken" or       "ImpersonateLoggedOnUser" or
		     "CreateProcessWithTokenW" or       "CreatePRocessAsUserW" or
		     "CreateProcessAsUserA")     )    ) and   not (
		     user.id:("S-1-5-18" or "S-1-5-19" or "S-1-5-20") and
		     file.directory: "C:\\ProgramData\\Microsoft\\Windows Defender
		     Advanced Threat Protection\\Downloads"   ) and   not
		     powershell.file.script_block_text : (     "sentinelbreakpoints"
		     and "Set-PSBreakpoint" and "PowerSploitIndicators"   ) and
		     not (     powershell.file.script_block_text : "New-
		     HPPrivateToastNotificationLogo" and     file.path : "C:\Program
		     Files\HPConnect\hp-cmsl-
		     wl\modules\HP.Notifications\HP.Notifications.psm1"   )

NamE: Persistence via Scheduled Job Creation
	description: 
		     A job can be used to schedule programs or
		     scripts to be executed at a specified date and time.
		     Adversaries may abuse task scheduling functionality to
		     facilitate initial or recurring execution of malicious code.
	query: 
		     file where host.os.type == "windows" and event.type !=
		     "deletion" and   file.path : "?:\\Windows\\Tasks\\*" and
		     file.extension : "job" and   not (     (
		     process.executable : "?:\\Program
		     Files\\CCleaner\\CCleaner64.exe" and       file.path :
		     "?:\\Windows\\Tasks\\CCleanerCrashReporting.job"     ) or     (
		     process.executable : (         "?:\\Program Files
		     (x86)\\ManageEngine\\UEMS_Agent\\bin\\dcagentregister.exe",
		     "?:\\Program Files
		     (x86)\\DesktopCentral_Agent\\bin\\dcagentregister.exe"       )
		     and       file.path : "?:\\Windows\\Tasks\\DCAgentUpdater.job"
		     )   )

NamE: Exploit - Detected - Elastic Endgame
	description: 
		     Elastic Endgame detected an Exploit. Click the
		     Elastic Endgame icon in the event.module column or the link in
		     the rule.reference column for additional information.
	query: 
		     event.kind:alert and event.module:endgame and
		     endgame.metadata.type:detection and (event.action:exploit_event
		     or endgame.event_subtype_full:exploit_event)

NamE: AWS RDS DB Snapshot Created
	description: 
		     Identifies when an AWS RDS DB Snapshot is
		     created. This can be used to evade defenses by allowing an
		     attacker to bypass access controls or cover their tracks by
		     reverting an instance to a previous state. This is a [building
		     block rule](https://www.elastic.co/guide/en/security/current/bu
		     ilding-block-rule.html) and does not generate alerts on its
		     own. It is meant to be used for correlation with other rules to
		     detect suspicious activity. To generate alerts, create a rule
		     that uses this signal as a building block.
	query: 
		     event.dataset: "aws.cloudtrail" and event.provider:
		     "rds.amazonaws.com"      and event.action: ("CreateDBSnapshot"
		     or "CreateDBClusterSnapshot") and event.outcome: "success"

NamE: Potential Privilege Escalation via Container Misconfiguration
	description: 
		     This rule monitors for the execution of
		     processes that interact with Linux containers through an
		     interactive shell without root permissions. Utilities such as
		     runc and ctr are universal command-line utilities leveraged to
		     interact with containers via root permissions. On systems where
		     the access to these utilities are misconfigured, attackers
		     might be able to create and run a container that mounts the
		     root folder or spawn a privileged container vulnerable to a
		     container escape attack, which might allow them to escalate
		     privileges and gain further access onto the host file system.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action == "exec" and (   (process.name ==
		     "runc" and process.args == "run") or   (process.name == "ctr"
		     and process.args == "run" and process.args in ("--privileged",
		     "--mount")) ) and not user.Ext.real.id == "0" and not
		     group.Ext.real.id == "0" and process.interactive == true and
		     process.parent.interactive == true

NamE: Remote File Download via Script Interpreter
	description: 
		     Identifies built-in Windows script interpreters
		     (cscript.exe or wscript.exe) being used to download an
		     executable file from a remote destination.
	query: 
		     sequence by host.id, process.entity_id   [network
		     where host.os.type == "windows" and process.name :
		     ("wscript.exe", "cscript.exe") and network.protocol != "dns"
		     and    network.direction : ("outgoing", "egress") and
		     network.type == "ipv4" and destination.ip != "127.0.0.1"   ]
		     [file where host.os.type == "windows" and event.type ==
		     "creation" and file.extension : ("exe", "dll")]

NamE: Python Site or User Customize File Creation
	description: 
		     This rule detects the creation and modification
		     of sitecustomize.py and usercustomize.py, which Python
		     automatically executes on startup. Attackers can exploit these
		     files for persistence by injecting malicious code. The rule
		     monitors system-wide, user-specific, and virtual environment
		     locations to catch unauthorized changes that could indicate
		     persistence or backdooring attempts.
	query: 
		     file where host.os.type == "linux" and event.type in
		     ("creation", "rename") and process.executable != null and
		     file.path like~ (   "/usr/lib/python*/sitecustomize.py",
		     "/usr/local/lib/python*/sitecustomize.py",
		     "/usr/lib/python*/dist-packages/sitecustomize.py",
		     "/usr/local/lib/python*/dist-packages/sitecustomize.py",
		     "/opt/*/lib/python*/sitecustomize.py",
		     "/home/*/.local/lib/python*/site-packages/usercustomize.py",
		     "/home/*/.config/python/usercustomize.py" ) and not (
		     process.executable in (     "/usr/local/bin/pip2",
		     "/usr/bin/restic", "/usr/bin/pacman", "/usr/bin/dockerd",
		     "/usr/local/bin/pip3",     "/usr/bin/pip3",
		     "/usr/local/bin/pip", "/usr/bin/pip", "/usr/bin/podman",
		     "/usr/local/bin/poetry",     "/usr/bin/poetry",
		     "/usr/bin/pamac-daemon", "./venv/bin/pip"   ) or
		     process.executable like~ (     "/usr/bin/python*",
		     "/usr/local/bin/python*", "/opt/venv/bin/python*",
		     "/nix/store/*libexec/docker/dockerd", "/snap/docker/*dockerd"
		     ) )

NamE: Suspicious Managed Code Hosting Process
	description: 
		     Identifies a suspicious managed code hosting
		     process which could indicate code injection or other form of
		     suspicious code execution.
	query: 
		     file where host.os.type == "windows" and event.type !=
		     "deletion" and   file.name : ("wscript.exe.log",
		     "cscript.exe.log",                "mshta.exe.log",
		     "wmic.exe.log",                "svchost.exe.log",
		     "dllhost.exe.log",                "cmstp.exe.log",
		     "regsvr32.exe.log")

NamE: Suspicious File Downloaded from Google Drive
	description: 
		     Identifies suspicious file download activity
		     from a Google Drive URL. This could indicate an attempt to
		     deliver phishing payloads via a trusted webservice.
	query: 
		     process where      /* common browser processes  */
		     event.action in ("exec", "fork", "start") and      process.name
		     : ("Microsoft Edge", "chrome.exe", "Google Chrome", "google-
		     chrome-stable",                     "google-chrome-beta",
		     "google-chrome", "msedge.exe", "firefox.exe", "brave.exe",
		     "whale.exe", "browser.exe", "dragon.exe", "vivaldi.exe",
		     "opera.exe", "firefox",                     "powershell.exe",
		     "curl", "curl.exe", "wget", "wget.exe") and      /* Look for
		     Google Drive download URL with AV flag skipping */
		     (process.command_line : "*drive.google.com*" and
		     process.command_line : "*export=download*" and
		     process.command_line : "*confirm=no_antivirus*")

NamE: GRUB Configuration Generation through Built-in Utilities
	description: 
		     This rule detects the generation of a new GRUB
		     configuration file using built-in Linux commands. The GRUB
		     configuration file is used to configure the GRUB bootloader,
		     which is responsible for loading the Linux kernel and initramfs
		     image during the boot process. Attackers may use these built-in
		     utilities to generate a new GRUB configuration file that
		     includes malicious kernel parameters or boot options, which can
		     be leveraged to maintain persistence on the system.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2") and process.parent.executable != null and
		     process.name in ("grub-mkconfig", "grub2-mkconfig", "update-
		     grub") and not (   process.parent.name in ("run-parts", "sudo",
		     "update-grub", "pacman", "dockerd", "dnf", "rpm", "yum") or
		     process.parent.executable like~ (     "/var/lib/dpkg/info/*",
		     "/usr/lib/bootloader/grub2-efi/config", "/tmp/newroot/*",
		     "/usr/lib/kernel/install.d/*"   ) )

NamE: Unusual Print Spooler Child Process
	description: 
		     Detects unusual Print Spooler service
		     (spoolsv.exe) child processes. This may indicate an attempt to
		     exploit privilege escalation vulnerabilities related to the
		     Printing Service on Windows.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  process.parent.name : "spoolsv.exe" and
		     process.command_line != null and
		     (?process.Ext.token.integrity_level_name : "System" or
		     ?winlog.event_data.IntegrityLevel : "System") and   /*
		     exclusions for FP control below */  not process.name :
		     ("splwow64.exe", "PDFCreator.exe", "acrodist.exe",
		     "spoolsv.exe", "msiexec.exe", "route.exe", "WerFault.exe") and
		     not process.command_line :
		     "*\\WINDOWS\\system32\\spool\\DRIVERS*" and  not (process.name
		     : "net.exe" and process.command_line : ("*stop*", "*start*"))
		     and  not (process.name : ("cmd.exe", "powershell.exe") and
		     process.command_line : ("*.spl*", "*\\program files*", "*route
		     add*")) and  not (process.name : "netsh.exe" and
		     process.command_line : ("*add portopening*", "*rule name*"))
		     and  not (process.name : "regsvr32.exe" and
		     process.command_line : "*PrintConfig.dll*") and  not
		     process.executable : (     "?:\\Program Files (x86)\\CutePDF
		     Writer\\CPWriter2.exe",     "?:\\Program Files
		     (x86)\\GPLGS\\gswin32c.exe"  )

NamE: Code Signing Policy Modification Through Registry
	description: 
		     Identifies attempts to disable the code signing
		     policy through the registry. Code signing provides authenticity
		     on a program, and grants the user with the ability to check
		     whether the program has been tampered with. By allowing the
		     execution of unsigned or self-signed code, threat actors can
		     craft and execute malicious code.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.value:
		     "BehaviorOnFailedVerify" and registry.data.strings : ("0",
		     "0x00000000", "1", "0x00000001")    /*     Full registry key
		     path omitted due to data source variations:
		     "HKEY_USERS\\*\\Software\\Policies\\Microsoft\\Windows
		     NT\\Driver Signing\\BehaviorOnFailedVerify"   */

NamE: Suspicious CertUtil Commands
	description: 
		     Identifies suspicious commands being used with
		     certutil.exe. CertUtil is a native Windows component which is
		     part of Certificate Services. CertUtil is often abused by
		     attackers to live off the land for stealthier command and
		     control or data exfiltration.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (process.name : "certutil.exe" or
		     ?process.pe.original_file_name == "CertUtil.exe") and
		     process.args : ("?decode", "?encode", "?urlcache",
		     "?verifyctl", "?encodehex", "?decodehex", "?exportPFX")

NamE: Potential Hidden Local User Account Creation
	description: 
		     Identifies attempts to create a local account
		     that will be hidden from the macOS logon window. This may
		     indicate an attempt to evade user attention while maintaining
		     persistence using a separate local account.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:(start or process_started) and  process.name:dscl
		     and process.args:(IsHidden and create and (true or 1 or yes))

NamE: Azure Resource Group Deletion
	description: 
		     Identifies the deletion of a resource group in
		     Azure, which includes all resources within the group. Deletion
		     is permanent and irreversible. An adversary may delete a
		     resource group in an attempt to evade defenses or intentionally
		     destroy data.
	query: 
		     event.dataset:azure.activitylogs and azure.activitylog
		     s.operation_name:"MICROSOFT.RESOURCES/SUBSCRIPTIONS/RESOURCEGRO
		     UPS/DELETE" and event.outcome:(Success or success)

NamE: Suspicious CronTab Creation or Modification
	description: 
		     Identifies attempts to create or modify a
		     crontab via a process that is not crontab (i.e python,
		     osascript, etc.). This activity should not be highly prevalent
		     and could indicate the use of cron as a persistence mechanism
		     by a threat actor.
	query: 
		     file where host.os.type == "macos" and event.type !=
		     "deletion" and process.name != null and   file.path :
		     "/private/var/at/tabs/*" and not process.executable ==
		     "/usr/bin/crontab"

NamE: Nping Process Activity
	description: 
		     Nping ran on a Linux host. Nping is part of the
		     Nmap tool suite and has the ability to construct raw packets
		     for a wide variety of security testing applications, including
		     denial of service testing.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and  event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed", "process_started") and
		     process.name == "nping"

NamE: UID Elevation from Previously Unknown Executable
	description: 
		     Monitors for the elevation of regular user
		     permissions to root permissions through a previously unknown
		     executable. Attackers may attempt to evade detection by
		     hijacking the execution flow and hooking certain
		     functions/syscalls through a rootkit in order to provide easy
		     access to root via a special modified command.
	query: 
		     host.os.type:"linux" and event.category:"process" and
		     event.action:"uid_change" and event.type:"change" and
		     user.id:"0" and process.parent.name:("bash" or "dash" or "sh"
		     or "tcsh" or "csh" or "zsh" or "ksh" or "fish") and not (
		     process.executable:(     /bin/* or /usr/bin/* or /sbin/* or
		     /usr/sbin/* or /snap/* or /tmp/newroot/* or /var/lib/docker/*
		     or /usr/local/* or     /opt/psa/admin/* or /usr/lib/snapd/snap-
		     confine or /opt/dynatrace/* or /opt/microsoft/* or
		     /var/lib/snapd/snap/bin/node or
		     /opt/gitlab/embedded/sbin/logrotate or /etc/apt/universal-
		     hooks/* or     /opt/puppetlabs/puppet/bin/puppet or
		     /opt/cisco/* or /run/k3s/containerd/* or
		     /usr/lib/postfix/sbin/master or     /usr/libexec/postfix/local
		     or /var/lib/snapd/snap/bin/postgresql* or
		     /opt/puppetlabs/puppet/bin/ruby   ) or   process.name:(
		     "bash" or "dash" or "sh" or "tcsh" or "csh" or "zsh" or "ksh"
		     or "fish" or "sudo" or "su" or "apt" or "apt-get" or
		     "aptitude" or "squid" or "snap" or "fusermount" or "pkexec" or
		     "umount" or "master" or "omsbaseline" or "dzdo" or
		     "sandfly" or "logrotate" or "nix-installer"    ) or
		     process.args:/usr/bin/python* )

NamE: A scheduled task was created
	description: 
		     Indicates the creation of a scheduled task using
		     Windows event logs. Adversaries can use these to establish
		     persistence, move laterally, and/or escalate privileges.
	query: 
		     iam where event.action == "scheduled-task-created" and
		     /* excluding tasks created by the computer account */  not
		     user.name : "*$" and   /* TaskContent is not parsed, exclude by
		     full taskname noisy ones */  not winlog.event_data.TaskName : (
		     "\\CreateExplorerShellUnelevatedTask",
		     "\\Hewlett-Packard\\HPDeviceCheck",               "\\Hewlett-
		     Packard\\HP Support Assistant\\WarrantyChecker",
		     "\\Hewlett-Packard\\HP Support
		     Assistant\\WarrantyChecker_backup",               "\\Hewlett-
		     Packard\\HP Web Products Detection",
		     "\\Microsoft\\VisualStudio\\Updates\\BackgroundDownload",
		     "\\OneDrive Standalone Update Task-S-1-5-21*",
		     "\\OneDrive Standalone Update Task-S-1-12-1-*"  )

NamE: Potential Invoke-Mimikatz PowerShell Script
	description: 
		     Mimikatz is a credential dumper capable of
		     obtaining plaintext Windows account logins and passwords, along
		     with many other features that make it useful for testing the
		     security of networks. This rule detects Invoke-Mimikatz
		     PowerShell script and alike.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text:(   (DumpCreds and
		     DumpCerts) or   "sekurlsa::logonpasswords" or
		     ("crypto::certificates" and
		     "CERT_SYSTEM_STORE_LOCAL_MACHINE") )

NamE: Volume Shadow Copy Deletion via WMIC
	description: 
		     Identifies use of wmic.exe for shadow copy
		     deletion on endpoints. This commonly occurs in tandem with
		     ransomware or other destructive attacks.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (process.name : "WMIC.exe" or
		     ?process.pe.original_file_name == "wmic.exe") and
		     process.args : "delete" and process.args : "shadowcopy"

NamE: Suspicious PDF Reader Child Process
	description: 
		     Identifies suspicious child processes of PDF
		     reader applications. These child processes are often launched
		     via exploitation of PDF applications or social engineering.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.name : ("AcroRd32.exe",
		     "Acrobat.exe",                          "FoxitPhantomPDF.exe",
		     "FoxitReader.exe") and   process.name : ("arp.exe",
		     "dsquery.exe", "dsget.exe", "gpresult.exe", "hostname.exe",
		     "ipconfig.exe", "nbtstat.exe",                   "net.exe",
		     "net1.exe", "netsh.exe", "netstat.exe", "nltest.exe",
		     "ping.exe", "qprocess.exe",                   "quser.exe",
		     "qwinsta.exe", "reg.exe", "sc.exe", "systeminfo.exe",
		     "tasklist.exe", "tracert.exe",                   "whoami.exe",
		     "bginfo.exe", "cdb.exe", "cmstp.exe", "csi.exe", "dnx.exe",
		     "fsi.exe", "ieexec.exe",                   "iexpress.exe",
		     "installutil.exe", "Microsoft.Workflow.Compiler.exe",
		     "msbuild.exe", "mshta.exe",                   "msxsl.exe",
		     "odbcconf.exe", "rcsi.exe", "regsvr32.exe", "xwizard.exe",
		     "atbroker.exe",                   "forfiles.exe",
		     "schtasks.exe", "regasm.exe", "regsvcs.exe", "cmd.exe",
		     "cscript.exe",                   "powershell.exe", "pwsh.exe",
		     "wmic.exe", "wscript.exe", "bitsadmin.exe", "certutil.exe",
		     "ftp.exe")

NamE: First Time Seen Removable Device
	description: 
		     Identifies newly seen removable devices by
		     device friendly name using registry modification events. While
		     this activity is not inherently malicious, analysts can use
		     those events to aid monitoring for data exfiltration over those
		     devices.
	query: 
		     event.category:"registry" and host.os.type:"windows"
		     and registry.value:"FriendlyName" and registry.path:*USBSTOR*

NamE: Suspicious Network Activity to the Internet by Previously Unknown Executable
	description: 
		     This rule monitors for network connectivity to
		     the internet from a previously unknown executable located in a
		     suspicious directory. An alert from this rule can indicate the
		     presence of potentially malicious activity, such as the
		     execution of unauthorized or suspicious processes attempting to
		     establish connections to unknown or suspicious destinations
		     such as a command and control server. Detecting and
		     investigating such behavior can help identify and mitigate
		     potential security threats, protecting the system and its data
		     from potential compromise.
	query: 
		     host.os.type:linux and event.category:network and
		     event.action:(connection_attempted or
		     ipv4_connection_attempt_event) and process.executable : (
		     /etc/crontab or /etc/rc.local or ./* or /boot/* or /dev/shm/*
		     or /etc/cron.*/* or /etc/init.d/* or /etc/rc*.d/* or
		     /etc/update-motd.d/* or /home/*/.* or /tmp/* or
		     /usr/lib/update-notifier/* or /var/log/* or /var/tmp/* ) and
		     process.name : * and not (   process.executable : (
		     /tmp/newroot/* or /tmp/snap.rootfs* or
		     /etc/cron.hourly/BitdefenderRedline or /tmp/go-build* or
		     /srv/snp/docker/* or     /run/containerd/* or /tmp/.mount* or
		     /run/k3s/containerd/* or /tmp/selenium* or
		     /tmp/tmp.*/juliainstaller or     /tmp/.criu.mntns* or
		     /home/*/.local/share/containers/* or /etc/update-motd.d/*   )
		     or   source.ip:(10.0.0.0/8 or 127.0.0.0/8 or 172.16.0.0/12 or
		     192.168.0.0/16) or   process.name : (     apt or chrome or curl
		     or dnf or dockerd or dpkg or firefox-bin or git-remote-https or
		     java or kite-update or     kited or node or rpm or saml2aws or
		     selenium-manager or solana-validator or wget or yum or ansible*
		     or aws* or     php* or pip* or python* or steam* or terraform*
		     or filebeat or apk or cursor or http   ) or   destination.ip:(
		     0.0.0.0 or 10.0.0.0/8 or 100.64.0.0/10 or 127.0.0.0/8 or
		     169.254.0.0/16 or 172.16.0.0/12 or 192.0.0.0/24 or
		     192.0.0.0/29 or 192.0.0.10/32 or 192.0.0.170/32 or
		     192.0.0.171/32 or 192.0.0.8/32 or 192.0.0.9/32 or 192.0.2.0/24
		     or     192.168.0.0/16 or 192.175.48.0/24 or 192.31.196.0/24 or
		     192.52.193.0/24 or 192.88.99.0/24 or 198.18.0.0/15 or
		     198.51.100.0/24 or 203.0.113.0/24 or 224.0.0.0/4 or 240.0.0.0/4
		     or "::1" or "FE80::/10" or "FF00::/8"   ) )

NamE: AWS IAM AdministratorAccess Policy Attached to Role
	description: 
		     An adversary with access to a set of compromised
		     credentials may attempt to persist or escalate privileges by
		     attaching additional permissions to compromised IAM roles. This
		     rule looks for use of the IAM `AttachRolePolicy` API operation
		     to attach the highly permissive `AdministratorAccess` AWS
		     managed policy to an existing IAM role.
	query: 
		     from logs-aws.cloudtrail-* metadata _id, _version,
		     _index | where event.provider == "iam.amazonaws.com" and
		     event.action == "AttachRolePolicy" and event.outcome ==
		     "success" | dissect aws.cloudtrail.request_parameters "{%{?poli
		     cyArn}=%{?arn}:%{?aws}:%{?iam}::%{?aws}:%{?policy}/%{policyName
		     },%{?roleName}=%{role.name}}" | where policyName ==
		     "AdministratorAccess" | keep @timestamp, event.provider,
		     event.action, event.outcome, policyName, role.name

NamE: Potential AWS S3 Bucket Ransomware Note Uploaded
	description: 
		     Identifies potential ransomware note being
		     uploaded to an AWS S3 bucket. This rule detects the `PutObject`
		     S3 API call with a common ransomware note file extension such
		     as `.ransom`, or `.lock`. Adversaries with access to a
		     misconfigured S3 bucket may retrieve, delete, and replace
		     objects with ransom notes to extort victims.
	query: 
		     from logs-aws.cloudtrail-*  // any successful uploads
		     via S3 API requests | where event.dataset == "aws.cloudtrail"
		     and event.provider == "s3.amazonaws.com"     and event.action
		     == "PutObject"     and event.outcome == "success"  // abstract
		     object name from API request parameters | dissect
		     aws.cloudtrail.request_parameters
		     "%{?ignore_values}key=%{object_name}}"  // regex on common
		     ransomware note extensions | where object_name rlike "(.*)(rans
		     om|lock|crypt|enc|readme|how_to_decrypt|decrypt_instructions|re
		     covery|datarescue)(.*)"     and not object_name rlike
		     "(.*)(AWSLogs|CloudTrail|access-logs)(.*)"  // keep relevant
		     fields | keep tls.client.server_name,
		     aws.cloudtrail.user_identity.arn, object_name  // aggregate by
		     S3 bucket, resource and object name | stats note_upload_count =
		     count(*) by tls.client.server_name,
		     aws.cloudtrail.user_identity.arn, object_name  // filter for
		     single occurrence to eliminate common upload operations | where
		     note_upload_count == 1

NamE: Google Workspace MFA Enforcement Disabled
	description: 
		     Detects when multi-factor authentication (MFA)
		     enforcement is disabled for Google Workspace users. An
		     adversary may disable MFA enforcement in order to weaken an
		     organization’s security controls.
	query: 
		     event.dataset:google_workspace.admin and
		     event.provider:admin   and event.category:iam and
		     event.action:ENFORCE_STRONG_AUTHENTICATION   and
		     google_workspace.admin.new_value:false

NamE: Suspicious Renaming of ESXI Files
	description: 
		     Identifies instances where VMware-related files,
		     such as those with extensions like ".vmdk", ".vmx", ".vmxf",
		     ".vmsd", ".vmsn", ".vswp", ".vmss", ".nvram", and ".vmem", are
		     renamed on a Linux system. The rule monitors for the "rename"
		     event action associated with these file types, which could
		     indicate malicious activity.
	query: 
		     file where host.os.type == "linux" and event.action ==
		     "rename" and file.Ext.original.name : ("*.vmdk", "*.vmx",
		     "*.vmxf", "*.vmsd", "*.vmsn", "*.vswp", "*.vmss", "*.nvram",
		     "*.vmem") and not file.name : ("*.vmdk", "*.vmx", "*.vmxf",
		     "*.vmsd", "*.vmsn", "*.vswp", "*.vmss", "*.nvram", "*.vmem")

NamE: Persistence via Login or Logout Hook
	description: 
		     Identifies use of the Defaults command to
		     install a login or logoff hook in MacOS. An adversary may abuse
		     this capability to establish persistence in an environment by
		     inserting code to be executed at login or logout.
	query: 
		     process where host.os.type == "macos" and event.type
		     == "start" and  process.name == "defaults" and process.args ==
		     "write" and process.args : ("LoginHook", "LogoutHook") and  not
		     process.args :        (
		     "Support/JAMF/ManagementFrameworkScripts/logouthook.sh",
		     "Support/JAMF/ManagementFrameworkScripts/loginhook.sh",
		     "/Library/Application
		     Support/JAMF/ManagementFrameworkScripts/logouthook.sh",
		     "/Library/Application
		     Support/JAMF/ManagementFrameworkScripts/loginhook.sh"        )

NamE: Network Connection by Cups or Foomatic-rip Child
	description: 
		     This detection rule addresses multiple
		     vulnerabilities in the CUPS printing system, including
		     CVE-2024-47176, CVE-2024-47076, CVE-2024-47175, and
		     CVE-2024-47177. Specifically, this rule detects network
		     connections initiated by a child processes of foomatic-rip.
		     These flaws impact components like cups-browsed,
		     libcupsfilters, libppd, and foomatic-rip, allowing remote
		     unauthenticated attackers to manipulate IPP URLs or inject
		     malicious data through crafted UDP packets or network spoofing.
		     This can result in arbitrary command execution when a print job
		     is initiated.
	query: 
		     sequence by host.id with maxspan=10s   [process where
		     host.os.type == "linux" and event.type == "start" and
		     event.action == "exec" and    process.parent.name == "foomatic-
		     rip" and    process.name in ("bash", "dash", "sh", "tcsh",
		     "csh", "zsh", "ksh", "fish")] by process.entity_id   [network
		     where host.os.type == "linux" and event.type == "start" and
		     event.action == "connection_attempted"] by
		     process.parent.entity_id

NamE: Potential Data Splitting Detected
	description: 
		     This rule looks for the usage of common data
		     splitting utilities with specific arguments that indicate data
		     splitting for exfiltration on Linux systems. Data splitting is
		     a technique used by adversaries to split data into smaller
		     parts to avoid detection and exfiltrate data.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2") and   (     (process.name == "dd"
		     and process.args like "bs=*" and process.args like "if=*") or
		     (       process.name in ("split", "rsplit") and       (
		     (process.args == "-b" or process.args like "--bytes*") or
		     (process.args == "-C" or process.args like "--line-bytes*")
		     )     )   ) and   not (     process.parent.name in ("apport",
		     "overlayroot", "nessus-agent-module") or     process.args like
		     (       "if=/tmp/nvim*", "if=/boot/*", "if=/dev/random",
		     "if=/dev/urandom", "/dev/mapper/*",       "if=*.iso",
		     "of=/dev/stdout", "if=/dev/zero", "if=/dev/sda",
		     "/proc/sys/kernel/*"     )   )

NamE: File Deletion via Shred
	description: 
		     Malware or other files dropped or created on a
		     system by an adversary may leave traces behind as to what was
		     done within a network and how. Adversaries may remove these
		     files over the course of an intrusion to keep their footprint
		     low or remove them at the end as part of the post-intrusion
		     cleanup process.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and process.name == "shred" and process.args in (
		     "-u", "--remove", "-z", "--zero" ) and not process.parent.name
		     == "logrotate"

NamE: Abnormally Large DNS Response
	description: 
		     Specially crafted DNS requests can manipulate a
		     known overflow vulnerability in some Windows DNS servers,
		     resulting in Remote Code Execution (RCE) or a Denial of Service
		     (DoS) from crashing the service.
	query: 
		     (event.dataset: network_traffic.dns or
		     (event.category: (network or network_traffic) and
		     destination.port: 53)) and   (event.dataset:zeek.dns or
		     type:dns or event.type:connection) and network.bytes > 60000

NamE: PowerShell Kerberos Ticket Dump
	description: 
		     Detects PowerShell scripts that have the
		     capability of dumping Kerberos tickets from LSA, which
		     potentially indicates an attacker's attempt to acquire
		     credentials for lateral movement.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (
		     "LsaCallAuthenticationPackage" and     (
		     "KerbRetrieveEncodedTicketMessage" or
		     "KerbQueryTicketCacheMessage" or
		     "KerbQueryTicketCacheExMessage" or
		     "KerbQueryTicketCacheEx2Message" or
		     "KerbRetrieveTicketMessage" or       "KerbDecryptDataMessage"
		     )   )

NamE: AWS IAM Deactivation of MFA Device
	description: 
		     Identifies the deactivation of a specified
		     multi-factor authentication (MFA) device and removes it from
		     association with the user name for which it was originally
		     enabled. In AWS Identity and Access Management (IAM), a device
		     must be deactivated before it can be deleted.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:iam.amazonaws.com and
		     event.action:(DeactivateMFADevice or DeleteVirtualMFADevice)
		     and event.outcome:success

NamE: Deprecated - File System Debugger Launched Inside a Privileged Container
	description: 
		     This rule detects the use of the built-in Linux
		     DebugFS utility from inside a privileged container. DebugFS is
		     a special file system debugging utility which supports reading
		     and writing directly from a hard drive device. When launched
		     inside a privileged container, a container deployed with all
		     the capabilities of the host machine, an attacker can access
		     sensitive host level files which could be used for further
		     privilege escalation and container escapes to the host machine.
	query: 
		     process where event.module == "cloud_defend" and
		     event.type == "start" and process.name == "debugfs" and
		     process.args : "/dev/sd*" and not process.args == "-R" and
		     container.security_context.privileged == true

NamE: Creation of Hidden Files and Directories via CommandLine
	description: 
		     Users can mark specific files as hidden simply
		     by putting a "." as the first character in the file or folder
		     name. Adversaries can use this to their advantage to hide files
		     and folders on the system for persistence and defense evasion.
		     This rule looks for hidden files or folders in common writable
		     directories.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action == "exec" and
		     process.working_directory in ("/tmp", "/var/tmp", "/dev/shm")
		     and process.args regex~ """\.[a-z0-9_\-][a-z0-9_\-\.]{1,254}"""
		     and not process.name in (   "ls", "find", "grep", "git", "jq",
		     "basename", "check_snmp", "snmpget", "snmpwalk", "cc1plus",
		     "snap",   "command-not-found", "sqlite", "apk", "fgrep",
		     "locate", "objdump" )

NamE: Uncommon Registry Persistence Change
	description: 
		     Detects changes to registry persistence keys
		     that are not commonly used or modified by legitimate programs.
		     This could be an indication of an adversary's attempt to
		     persist in a stealthy manner.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and  length(registry.data.strings) > 0
		     and  registry.path : (
		     "HKLM\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Terminal Server\\Install\\SOFTWARE\\Microso
		     ft\\Windows\\CurrentVersion\\Run\\*",
		     "HKLM\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Terminal Server\\Install\\SOFTWARE\\Microso
		     ft\\Windows\\CurrentVersion\\Runonce\\*",
		     "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Windows\\Load",
		     "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Windows\\Run",
		     "HKLM\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Windows\\IconServiceLib",
		     "HKLM\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Winlogon\\Shell",
		     "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Winlogon\\Shell",
		     "HKLM\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Winlogon\\AppSetup",
		     "HKLM\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Winlogon\\Taskman",
		     "HKLM\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Winlogon\\Userinit",
		     "HKLM\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Winlogon\\VmApplet",       "HKLM\\SOFTWARE\
		     \Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\*
		     ",       "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\P
		     olicies\\System\\Shell",       "HKLM\\SOFTWARE\\Policies\\Micro
		     soft\\Windows\\System\\Scripts\\Logoff\\Script",       "HKLM\\S
		     OFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Logon\\
		     Script",       "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\S
		     ystem\\Scripts\\Shutdown\\Script",       "HKLM\\SOFTWARE\\Polic
		     ies\\Microsoft\\Windows\\System\\Scripts\\Startup\\Script",
		     "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\P
		     olicies\\Explorer\\Run\\*",       "HKEY_USERS\\*\\SOFTWARE\\Mic
		     rosoft\\Windows\\CurrentVersion\\Policies\\System\\Shell",
		     "HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\
		     \Scripts\\Logoff\\Script",       "HKEY_USERS\\*\\SOFTWARE\\Poli
		     cies\\Microsoft\\Windows\\System\\Scripts\\Logon\\Script",
		     "HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\
		     \Scripts\\Shutdown\\Script",       "HKEY_USERS\\*\\SOFTWARE\\Po
		     licies\\Microsoft\\Windows\\System\\Scripts\\Startup\\Script",
		     "HKLM\\SOFTWARE\\Microsoft\\Active Setup\\Installed
		     Components\\*\\ShellComponent",
		     "HKLM\\SOFTWARE\\Microsoft\\Windows CE
		     Services\\AutoStartOnConnect\\MicrosoftActiveSync",
		     "HKLM\\SOFTWARE\\Microsoft\\Windows CE
		     Services\\AutoStartOnDisconnect\\MicrosoftActiveSync",
		     "HKLM\\SOFTWARE\\Microsoft\\Ctf\\LangBarAddin\\*\\FilePath",
		     "HKLM\\SOFTWARE\\Microsoft\\Internet
		     Explorer\\Extensions\\*\\Exec",
		     "HKLM\\SOFTWARE\\Microsoft\\Internet
		     Explorer\\Extensions\\*\\Script",
		     "HKLM\\SOFTWARE\\Microsoft\\Command Processor\\Autorun",       
		     "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Ctf\\LangBarAddin\\*\\File
		     Path",       "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Internet
		     Explorer\\Extensions\\*\\Exec",
		     "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Internet
		     Explorer\\Extensions\\*\\Script",
		     "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Command
		     Processor\\Autorun",       "HKEY_USERS\\*\\Control
		     Panel\\Desktop\\scrnsave.exe",
		     "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image
		     File Execution Options\\*\\VerifierDlls",
		     "HKLM\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Winlogon\\GpExtensions\\*\\DllName",
		     "HKLM\\SYSTEM\\ControlSet*\\Control\\SafeBoot\\AlternateShell",
		     "HKLM\\SYSTEM\\ControlSet*\\Control\\Terminal
		     Server\\Wds\\rdpwd\\StartupPrograms",
		     "HKLM\\SYSTEM\\ControlSet*\\Control\\Terminal
		     Server\\WinStations\\RDP-Tcp\\InitialProgram",
		     "HKLM\\SYSTEM\\ControlSet*\\Control\\Session
		     Manager\\BootExecute",
		     "HKLM\\SYSTEM\\ControlSet*\\Control\\Session
		     Manager\\BootExecuteNoPnpSync",
		     "HKLM\\SYSTEM\\ControlSet*\\Control\\Session
		     Manager\\SetupExecute",
		     "HKLM\\SYSTEM\\ControlSet*\\Control\\Session
		     Manager\\SetupExecuteNoPnpSync",
		     "HKLM\\SYSTEM\\ControlSet*\\Control\\Session
		     Manager\\PlatformExecute",
		     "HKLM\\SYSTEM\\ControlSet*\\Control\\Session Manager\\Execute",
		     "HKLM\\SYSTEM\\ControlSet*\\Control\\Session
		     Manager\\S0InitialCommand",       "HKLM\\SYSTEM\\ControlSet*\\C
		     ontrol\\ServiceControlManagerExtension",       "HKLM\\SYSTEM\\C
		     ontrolSet*\\Control\\BootVerificationProgram\\ImagePath",
		     "HKLM\\SYSTEM\\Setup\\CmdLine",
		     "HKEY_USERS\\*\\Environment\\UserInitMprLogonScript") and   not
		     registry.data.strings : ("C:\\Windows\\system32\\userinit.exe",
		     "cmd.exe", "C:\\Program Files (x86)\\*.exe",
		     "C:\\Program Files\\*.exe") and  not (process.name :
		     "rundll32.exe" and registry.path :
		     "*\\Software\\Microsoft\\Internet
		     Explorer\\Extensions\\*\\Script") and  not process.executable :
		     ("C:\\Windows\\System32\\msiexec.exe",
		     "C:\\Windows\\SysWOW64\\msiexec.exe",
		     "C:\\ProgramData\\Microsoft\\Windows
		     Defender\\Platform\\*\\MsMpEng.exe",
		     "C:\\Program Files\\*.exe",
		     "C:\\Program Files (x86)\\*.exe") and  not (process.name :
		     ("TiWorker.exe", "poqexec.exe") and registry.value :
		     "SetupExecute" and       registry.data.strings : (
		     "C:\\windows\\System32\\poqexec.exe /display_progress
		     \\SystemRoot\\WinSxS\\pending.xml",
		     "C:\\Windows\\System32\\poqexec.exe /skip_critical_poq
		     /display_progress \\SystemRoot\\WinSxS\\pending.xml"       )
		     ) and  not (process.name : "svchost.exe" and registry.value :
		     "SCRNSAVE.EXE" and       registry.data.strings : (
		     "%windir%\\system32\\rundll32.exe user32.dll,LockWorkStation",
		     "scrnsave.scr",         "%windir%\\system32\\Ribbons.scr"
		     )      )

NamE: Potential Secure File Deletion via SDelete Utility
	description: 
		     Detects file name patterns generated by the use
		     of Sysinternals SDelete utility to securely delete a file via
		     multiple file overwrite and rename operations.
	query: 
		     file where host.os.type == "windows" and event.type ==
		     "change" and file.name : "*AAA.AAA"

NamE: Shared Object Created or Changed by Previously Unknown Process
	description: 
		     This rule monitors the creation of shared object
		     files by previously unknown processes. The creation of a shared
		     object file involves compiling code into a dynamically linked
		     library that can be loaded by other programs at runtime. While
		     this process is typically used for legitimate purposes,
		     malicious actors can leverage shared object files to execute
		     unauthorized code, inject malicious functionality into
		     legitimate processes, or bypass security controls. This allows
		     malware to persist on the system, evade detection, and
		     potentially compromise the integrity and confidentiality of the
		     affected system and its data.
	query: 
		     host.os.type:linux and event.action:(creation or
		     file_create_event or file_rename_event or rename) and
		     file.path:(/dev/shm/* or /usr/lib/*) and file.extension:so and
		     process.name:* and not (   process.name:(     "dockerd" or
		     "dpkg" or "rpm" or "snapd" or "yum" or "vmis-launcher" or
		     "pacman" or "apt-get" or "dnf" or "podman" or     platform-
		     python* or "dnf-automatic" or "unattended-upgrade" or "apk" or
		     "snap-update-ns" or "install" or "exe" or     "systemd" or
		     "root" or "sshd" or "pip" or "jlink" or python* or "update-
		     alternatives" or pip* or     "installer.bin.inst" or
		     "uninstall-bin" or "linux_agent.inst" or crio or ssm-agent-
		     worker or packagekitd   ) or    (process.name:vmware-install.pl
		     and file.path:/usr/lib/vmware-tools/*) or   process.executable
		     : (/dev/fd/* or "/" or "/kaniko/executor" or
		     "/usr/bin/buildah") )

NamE: Accepted Default Telnet Port Connection
	description: 
		     This rule detects network events that may
		     indicate the use of Telnet traffic. Telnet is commonly used by
		     system administrators to remotely control older or embedded
		     systems using the command line shell. It should almost never be
		     directly exposed to the Internet, as it is frequently targeted
		     and exploited by threat actors as an initial access or backdoor
		     vector. As a plain-text protocol, it may also expose usernames
		     and passwords to anyone capable of observing the traffic.
	query: 
		     (event.dataset:network_traffic.flow or
		     event.category:(network or network_traffic))     and
		     event.type:connection and not event.action:(
		     flow_dropped or flow_denied or denied or deny or
		     flow_terminated or timeout or Reject or network_flow)     and
		     destination.port:23

NamE: Privilege Escalation via CAP_SETUID/SETGID Capabilities
	description: 
		     Identifies instances where a process (granted
		     CAP_SETUID and/or CAP_SETGID capabilities) is executed, after
		     which the user's access is elevated to UID/GID 0 (root). In
		     Linux, the CAP_SETUID and CAP_SETGID capabilities allow a
		     process to change its UID and GID, respectively, providing
		     control over user and group identity management. Attackers may
		     leverage a misconfiguration for exploitation in order to
		     escalate their privileges to root.
	query: 
		     sequence by host.id, process.entity_id with maxspan=1s
		     [process where host.os.type == "linux" and event.type ==
		     "start" and event.action == "exec" and process.name != null and
		     (process.thread.capabilities.effective : "CAP_SET?ID" or
		     process.thread.capabilities.permitted : "CAP_SET?ID") and
		     user.id != "0" and not (      process.parent.executable :
		     ("/tmp/newroot/*", "/opt/carbonblack*") or
		     process.parent.executable in (        "/opt/SolarWinds/Agent/bi
		     n/Plugins/JobEngine/SolarWinds.Agent.JobEngine.Plugin",
		     "/usr/bin/vmware-toolbox-cmd",        "/usr/bin/dbus-daemon",
		     "/usr/bin/update-notifier", "/usr/share/language-
		     tools/language-options",        "/opt/SolarWinds/Agent/*",
		     "/usr/local/sbin/lynis.sh"      ) or      process.executable :
		     ("/opt/dynatrace/*", "/tmp/newroot/*",
		     "/opt/SolarWinds/Agent/*") or      process.executable in (
		     "/bin/fgrep", "/usr/bin/sudo", "/usr/bin/pkexec",
		     "/usr/lib/cockpit/cockpit-session", "/usr/sbin/suexec"      )
		     or      process.parent.name in ("update-notifier", "language-
		     options", "osqueryd", "saposcol", "dbus-daemon", "osqueryi",
		     "sdbrun") or      process.command_line like ("sudo*BECOME-
		     SUCCESS*", "/bin/sh*sapsysinfo.sh*", "sudo su", "sudo su -") or
		     process.name in ("sudo", "fgrep", "lsb_release", "apt-update",
		     "dbus-daemon-launch-helper", "man") or
		     process.parent.command_line like "/usr/bin/python*ansible*"
		     )]   [process where host.os.type == "linux" and event.action ==
		     "uid_change" and event.type == "change" and
		     (process.thread.capabilities.effective : "CAP_SET?ID" or
		     process.thread.capabilities.permitted : "CAP_SET?ID")    and
		     user.id == "0"]

NamE: Potential Widespread Malware Infection Across Multiple Hosts
	description: 
		     This rule uses alert data to determine when a
		     malware signature is triggered in multiple hosts. Analysts can
		     use this to prioritize triage and response, as this can
		     potentially indicate a widespread malware infection.
	query: 
		     from logs-endpoint.alerts-* | where event.code in
		     ("malicious_file", "memory_signature", "shellcode_thread") and
		     rule.name is not null | keep host.id, rule.name, event.code |
		     stats hosts = count_distinct(host.id) by rule.name, event.code
		     | where hosts >= 3

NamE: Process Execution from an Unusual Directory
	description: 
		     Identifies process execution from suspicious
		     default Windows directories. This is sometimes done by
		     adversaries to hide malware in trusted paths.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   /* add suspicious execution paths here */
		     process.executable : (     "?:\\PerfLogs\\*.exe",
		     "?:\\Users\\Public\\*.exe", "?:\\Windows\\Tasks\\*.exe",
		     "?:\\Intel\\*.exe", "?:\\AMD\\Temp\\*.exe",
		     "?:\\Windows\\AppReadiness\\*.exe",
		     "?:\\Windows\\ServiceState\\*.exe",
		     "?:\\Windows\\security\\*.exe",
		     "?:\\Windows\\IdentityCRL\\*.exe",
		     "?:\\Windows\\Branding\\*.exe", "?:\\Windows\\csc\\*.exe",
		     "?:\\Windows\\DigitalLocker\\*.exe",     "?:\\Windows\\en-
		     US\\*.exe", "?:\\Windows\\wlansvc\\*.exe",
		     "?:\\Windows\\Prefetch\\*.exe",
		     "?:\\Windows\\Fonts\\*.exe", "?:\\Windows\\diagnostics\\*.exe",
		     "?:\\Windows\\TAPI\\*.exe",     "?:\\Windows\\INF\\*.exe",
		     "?:\\Windows\\System32\\Speech\\*.exe",
		     "?:\\windows\\tracing\\*.exe",     "?:\\windows\\IME\\*.exe",
		     "?:\\Windows\\Performance\\*.exe", "?:\\windows\\intel\\*.exe",
		     "?:\\windows\\ms\\*.exe", "?:\\Windows\\dot3svc\\*.exe",
		     "?:\\Windows\\panther\\*.exe",
		     "?:\\Windows\\RemotePackages\\*.exe",
		     "?:\\Windows\\OCR\\*.exe", "?:\\Windows\\appcompat\\*.exe",
		     "?:\\Windows\\apppatch\\*.exe", "?:\\Windows\\addins\\*.exe",
		     "?:\\Windows\\Setup\\*.exe",     "?:\\Windows\\Help\\*.exe",
		     "?:\\Windows\\SKB\\*.exe", "?:\\Windows\\Vss\\*.exe",
		     "?:\\Windows\\Web\\*.exe", "?:\\Windows\\servicing\\*.exe",
		     "?:\\Windows\\CbsTemp\\*.exe",     "?:\\Windows\\Logs\\*.exe",
		     "?:\\Windows\\WaaS\\*.exe",
		     "?:\\Windows\\ShellExperiences\\*.exe",
		     "?:\\Windows\\ShellComponents\\*.exe",
		     "?:\\Windows\\PLA\\*.exe", "?:\\Windows\\Migration\\*.exe",
		     "?:\\Windows\\debug\\*.exe", "?:\\Windows\\Cursors\\*.exe",
		     "?:\\Windows\\Containers\\*.exe",
		     "?:\\Windows\\Boot\\*.exe", "?:\\Windows\\bcastdvr\\*.exe",
		     "?:\\Windows\\assembly\\*.exe",
		     "?:\\Windows\\TextInput\\*.exe",
		     "?:\\Windows\\security\\*.exe", "?:\\Windows\\schemas\\*.exe",
		     "?:\\Windows\\SchCache\\*.exe",
		     "?:\\Windows\\Resources\\*.exe",
		     "?:\\Windows\\rescache\\*.exe",
		     "?:\\Windows\\Provisioning\\*.exe",
		     "?:\\Windows\\PrintDialog\\*.exe",
		     "?:\\Windows\\PolicyDefinitions\\*.exe",
		     "?:\\Windows\\media\\*.exe",
		     "?:\\Windows\\Globalization\\*.exe",
		     "?:\\Windows\\L2Schemas\\*.exe",
		     "?:\\Windows\\LiveKernelReports\\*.exe",
		     "?:\\Windows\\ModemLogs\\*.exe",
		     "?:\\Windows\\ImmersiveControlPanel\\*.exe"   ) and      not
		     process.name : (     "SpeechUXWiz.exe", "SystemSettings.exe",
		     "TrustedInstaller.exe",     "PrintDialog.exe", "MpSigStub.exe",
		     "LMS.exe", "mpam-*.exe"   ) and   not process.executable :
		     ("?:\\Intel\\Wireless\\WUSetupLauncher.exe",
		     "?:\\Intel\\Wireless\\Setup.exe",              "?:\\Intel\\Move
		     Mouse.exe",
		     "?:\\windows\\Panther\\DiagTrackRunner.exe",
		     "?:\\Windows\\servicing\\GC64\\tzupd.exe",
		     "?:\\Users\\Public\\res\\RemoteLite.exe",
		     "?:\\Users\\Public\\IBM\\ClientSolutions\\*.exe",
		     "?:\\Users\\Public\\Documents\\syspin.exe",
		     "?:\\Users\\Public\\res\\FileWatcher.exe")

NamE: Suspicious Communication App Child Process
	description: 
		     Identifies suspicious child processes of
		     communications apps, which can indicate a potential
		     masquerading as the communication app or the exploitation of a
		     vulnerability on the application causing it to execute code.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (     /* Slack */     (process.parent.name :
		     "slack.exe" and not       (         (
		     process.executable : (             "?:\\Program Files\\*",
		     "?:\\Program Files (x86)\\*",             "?:\\Users\\*\\AppDat
		     a\\Local\\Google\\Chrome\\Application\\chrome.exe",
		     "?:\\Users\\*\\AppData\\Local\\Island\\Island\\Application\\Isl
		     and.exe",
		     "?:\\Users\\*\\AppData\\Roaming\\Zoom\\bin*\\Zoom.exe",
		     "?:\\Windows\\System32\\rundll32.exe",
		     "?:\\Users\\*\\AppData\\Local\\Mozilla Firefox\\firefox.exe",
		     "?:\\Windows\\System32\\notepad.exe",
		     "?:\\Windows\\System32\\WerFault.exe",
		     "?:\\Windows\\SysWOW64\\WerFault.exe",
		     "?:\\Users\\*\\AppData\\Local\\Programs\\Opera\\opera.exe"
		     ) and process.code_signature.trusted == true         ) or
		     (           process.code_signature.subject_name : (
		     "Slack Technologies, Inc.",             "Slack Technologies,
		     LLC"           ) and process.code_signature.trusted == true
		     ) or         (           (process.name : "powershell.exe" and
		     process.command_line : "powershell.exe -c Invoke-WebRequest
		     -Uri https://slackb.com/*") or           (process.name :
		     "cmd.exe" and process.command_line :
		     "C:\\WINDOWS\\system32\\cmd.exe /d /s /c
		     \"%windir%\\System32\\rundll32.exe User32.dll,SetFocus 0\"")
		     )       )     ) or      /* WebEx */     (process.parent.name :
		     ("CiscoCollabHost.exe", "WebexHost.exe") and not       (
		     (           process.executable : (             "?:\\Program
		     Files\\*",             "?:\\Program Files (x86)\\*",
		     "?:\\Windows\\System32\\WerFault.exe",
		     "?:\\Windows\\SysWOW64\\WerFault.exe",             "?:\\Users\\
		     *\\AppData\\Local\\Google\\Chrome\\Application\\chrome.exe",
		     "?:\\Users\\*\\AppData\\Local\\Mozilla Firefox\\firefox.exe",
		     "?:\\Users\\*\\AppData\\Local\\Programs\\Opera\\opera.exe"
		     ) and process.code_signature.trusted == true         ) or
		     (           process.code_signature.subject_name : (
		     "Cisco Systems, Inc.",             "Cisco WebEx LLC",
		     "Cisco Systems Inc."           ) and
		     process.code_signature.trusted == true         )       )     )
		     or      /* Teams */     (process.parent.name : "Teams.exe" and
		     not       (         (           process.executable : (
		     "?:\\Program Files\\*",             "?:\\Program Files
		     (x86)\\*",             "?:\\Windows\\System32\\WerFault.exe",
		     "?:\\Windows\\SysWOW64\\WerFault.exe",
		     "?:\\Windows\\BrowserCore\\BrowserCore.exe",             "?:\\U
		     sers\\*\\AppData\\Local\\Google\\Chrome\\Application\\chrome.ex
		     e",             "?:\\Users\\*\\AppData\\Local\\Mozilla
		     Firefox\\firefox.exe"           ) and
		     process.code_signature.trusted == true         ) or         (
		     process.code_signature.subject_name : (             "Microsoft
		     Corporation",             "Microsoft 3rd Party Application
		     Component"           ) and process.code_signature.trusted ==
		     true         ) or         (           (process.name :
		     "taskkill.exe" and process.args : "Teams.exe")         )
		     )     ) or      /* Discord */     (process.parent.name :
		     "Discord.exe" and not       (         (
		     process.executable : (             "?:\\Program Files\\*",
		     "?:\\Program Files (x86)\\*",             "?:\\Users\\*\\AppDat
		     a\\Local\\Google\\Chrome\\Application\\chrome.exe",
		     "?:\\Windows\\System32\\reg.exe",
		     "?:\\Windows\\SysWOW64\\reg.exe",
		     "?:\\Windows\\System32\\WerFault.exe",
		     "?:\\Windows\\SysWOW64\\WerFault.exe"           ) and
		     process.code_signature.trusted == true         ) or         (
		     process.code_signature.subject_name : (             "Discord
		     Inc."           ) and process.code_signature.trusted == true
		     ) or         (           process.name : "cmd.exe" and
		     (             process.command_line : (
		     "C:\\WINDOWS\\system32\\cmd.exe /d /s /c \"chcp\"",
		     "C:\\WINDOWS\\system32\\cmd.exe /q /d /s /c \"C:\\Program^
		     Files\\NVIDIA^ Corporation\\NVSMI\\nvidia-smi.exe\""
		     ) or             process.args : (
		     "C:\\WINDOWS/System32/nvidia-smi.exe",
		     "C:\\WINDOWS\\System32\\nvidia-smi.exe",
		     "C:\\Windows\\System32\\DriverStore\\FileRepository/*/nvidia-
		     smi.exe*"             )           )         )       )     ) or
		     /* WhatsApp */     (process.parent.name : "Whatsapp.exe" and
		     not       (         (           process.executable : (
		     "?:\\Program Files\\*",             "?:\\Program Files
		     (x86)\\*",             "?:\\Windows\\System32\\WerFault.exe",
		     "?:\\Windows\\SysWOW64\\WerFault.exe",
		     "?:\\Windows\\System32\\reg.exe",
		     "?:\\Windows\\SysWOW64\\reg.exe"           ) and
		     process.code_signature.trusted == true         ) or         (
		     process.code_signature.subject_name : (             "WhatsApp
		     LLC",             "WhatsApp, Inc",
		     "24803D75-212C-471A-BC57-9EF86AB91435"           ) and
		     process.code_signature.trusted == true         ) or         (
		     (process.name : "cmd.exe" and process.command_line :
		     "C:\\Windows\\system32\\cmd.exe /d /s /c
		     \"C:\\Windows\\system32\\wbem\\wmic.exe*")         )       )
		     ) or      /* Zoom */     (process.parent.name : "Zoom.exe" and
		     not       (         (           process.executable : (
		     "?:\\Program Files\\*",             "?:\\Program Files
		     (x86)\\*",             "?:\\Users\\*\\AppData\\Local\\Google\\C
		     hrome\\Application\\chrome.exe",             "?:\\Users\\*\\App
		     Data\\Local\\Island\\Island\\Application\\Island.exe",
		     "?:\\Users\\*\\AppData\\Local\\Mozilla Firefox\\firefox.exe",
		     "?:\\Windows\\System32\\WerFault.exe",
		     "?:\\Windows\\SysWOW64\\WerFault.exe"           ) and
		     process.code_signature.trusted == true         ) or         (
		     process.code_signature.subject_name : (             "Zoom Video
		     Communications, Inc."           ) and
		     process.code_signature.trusted == true         )       )     )
		     or      /* Thunderbird */     (process.parent.name :
		     "thunderbird.exe" and not       (         (
		     process.executable : (             "?:\\Program Files\\*",
		     "?:\\Program Files (x86)\\*",
		     "?:\\Windows\\System32\\WerFault.exe",
		     "?:\\Windows\\SysWOW64\\WerFault.exe",
		     "?:\\Windows\\splwow64.exe"           ) and
		     process.code_signature.trusted == true         ) or         (
		     process.code_signature.subject_name : (             "Mozilla
		     Corporation"           ) and process.code_signature.trusted ==
		     true         )       )     )   )

NamE: Microsoft 365 Exchange Transport Rule Modification
	description: 
		     Identifies when a transport rule has been
		     disabled or deleted in Microsoft 365. Mail flow rules (also
		     known as transport rules) are used to identify and take action
		     on messages that flow through your organization. An adversary
		     or insider threat may modify a transport rule to exfiltrate
		     data or evade defenses.
	query: 
		     event.dataset:o365.audit and event.provider:Exchange
		     and event.category:web and event.action:("Remove-TransportRule"
		     or "Disable-TransportRule") and event.outcome:success

NamE: Kerberos Pre-authentication Disabled for User
	description: 
		     Identifies the modification of an account's
		     Kerberos pre-authentication options. An adversary with
		     GenericWrite/GenericAll rights over the account can maliciously
		     modify these settings to perform offline password cracking
		     attacks such as AS-REP roasting.
	query: 
		     any where host.os.type == "windows" and event.code ==
		     "4738" and   winlog.event_data.NewUACList ==
		     "USER_DONT_REQUIRE_PREAUTH"

NamE: PowerShell Script with Archive Compression Capabilities
	description: 
		     Identifies the use of Cmdlets and methods
		     related to archive compression activities. Adversaries will
		     often compress and encrypt data in preparation for
		     exfiltration.
	query: 
		     event.category:process and host.os.type:windows and (
		     powershell.file.script_block_text : (
		     "IO.Compression.ZipFile" or     "IO.Compression.ZipArchive" or
		     "ZipFile.CreateFromDirectory" or
		     "IO.Compression.BrotliStream" or
		     "IO.Compression.DeflateStream" or
		     "IO.Compression.GZipStream" or     "IO.Compression.ZLibStream"
		     ) and    powershell.file.script_block_text : (
		     "CompressionLevel" or     "CompressionMode" or
		     "ZipArchiveMode"   ) or   powershell.file.script_block_text :
		     "Compress-Archive" ) and not powershell.file.script_block_text
		     : (   "Compress-Archive -Path
		     'C:\ProgramData\Lenovo\Udc\diagnostics\latest" or
		     ("Copyright: (c) 2017, Ansible Project" and
		     "Ansible.ModuleUtils.Backup") ) and not file.directory : (
		     "C:\Program Files\Microsoft Dependency Agent\plugins\lib" or
		     "C:\Program Files\WindowsPowerShell\Modules\icinga-powershell-
		     framework\cache" or   "C:\ProgramData\Microsoft\Windows
		     Defender Advanced Threat Protection\Downloads" )

NamE: Microsoft 365 Exchange Malware Filter Policy Deletion
	description: 
		     Identifies when a malware filter policy has been
		     deleted in Microsoft 365. A malware filter policy is used to
		     alert administrators that an internal user sent a message that
		     contained malware. This may indicate an account or machine
		     compromise that would need to be investigated. Deletion of a
		     malware filter policy may be done to evade detection.
	query: 
		     event.dataset:o365.audit and event.provider:Exchange
		     and event.category:web and event.action:"Remove-
		     MalwareFilterPolicy" and event.outcome:success

NamE: Shortcut File Written or Modified on Startup Folder
	description: 
		     Identifies shortcut files written to or modified
		     in the startup folder. Adversaries may use this technique to
		     maintain persistence.
	query: 
		     file where host.os.type == "windows" and event.type !=
		     "deletion" and file.extension == "lnk" and   file.path : (
		     "C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Windows\\Start
		     Menu\\Programs\\Startup\\*",
		     "C:\\ProgramData\\Microsoft\\Windows\\Start
		     Menu\\Programs\\StartUp\\*"   ) and   not (     (process.name :
		     "ONENOTE.EXE" and process.code_signature.status: "trusted" and
		     file.name : "*OneNote.lnk") or     (process.name :
		     "OktaVerifySetup.exe" and process.code_signature.status:
		     "trusted" and file.name : "Okta Verify.lnk") or
		     (process.name : "OneLaunch.exe" and
		     process.code_signature.status: "trusted" and file.name :
		     "OneLaunch*.lnk") or     (process.name : "APPServerClient.exe"
		     and process.code_signature.status: "trusted" and file.name :
		     "Parallels Client.lnk")   )

NamE: Potential Masquerading as System32 Executable
	description: 
		     Identifies suspicious instances of default
		     system32 executables, either unsigned or signed with non-MS
		     certificates. This could indicate the attempt to masquerade as
		     system executables or backdoored and resigned legitimate
		     executables.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and    (process.code_signature.status : "?*" or
		     process.code_signature.exists != null) and   process.name: (
		     "agentactivationruntimestarter.exe", "agentservice.exe",
		     "aitstatic.exe", "alg.exe", "apphostregistrationverifier.exe",
		     "appidcertstorecheck.exe", "appidpolicyconverter.exe",
		     "appidtel.exe", "applicationframehost.exe",
		     "applysettingstemplatecatalog.exe", "applytrustoffline.exe",
		     "approvechildrequest.exe", "appvclient.exe",
		     "appvdllsurrogate.exe", "appvnice.exe", "appvshnotify.exe",
		     "arp.exe", "assignedaccessguard.exe", "at.exe", "atbroker.exe",
		     "attrib.exe", "audiodg.exe", "auditpol.exe", "authhost.exe",
		     "autochk.exe", "autoconv.exe", "autofmt.exe", "axinstui.exe",
		     "baaupdate.exe", "backgroundtaskhost.exe",
		     "backgroundtransferhost.exe", "bcdboot.exe", "bcdedit.exe",
		     "bdechangepin.exe", "bdehdcfg.exe", "bdeuisrv.exe",
		     "bdeunlock.exe", "bioiso.exe", "bitlockerdeviceencryption.exe",
		     "bitlockerwizard.exe", "bitlockerwizardelev.exe",
		     "bitsadmin.exe", "bootcfg.exe", "bootim.exe", "bootsect.exe",
		     "bridgeunattend.exe", "browserexport.exe",
		     "browser_broker.exe", "bthudtask.exe", "bytecodegenerator.exe",
		     "cacls.exe", "calc.exe", "camerasettingsuihost.exe",
		     "castsrv.exe", "certenrollctrl.exe", "certreq.exe",
		     "certutil.exe", "change.exe", "changepk.exe", "charmap.exe",
		     "checknetisolation.exe", "chglogon.exe", "chgport.exe",
		     "chgusr.exe", "chkdsk.exe", "chkntfs.exe", "choice.exe",
		     "cidiag.exe", "cipher.exe", "cleanmgr.exe", "cliconfg.exe",
		     "clip.exe", "clipup.exe", "cloudexperiencehostbroker.exe",
		     "cloudnotifications.exe", "cmd.exe", "cmdkey.exe",
		     "cmdl32.exe", "cmmon32.exe", "cmstp.exe", "cofire.exe",
		     "colorcpl.exe", "comp.exe", "compact.exe",
		     "compattelrunner.exe", "compmgmtlauncher.exe",
		     "comppkgsrv.exe", "computerdefaults.exe", "conhost.exe",
		     "consent.exe", "control.exe", "convert.exe", "convertvhd.exe",
		     "coredpussvr.exe", "credentialenrollmentmanager.exe",
		     "credentialuibroker.exe", "credwiz.exe", "cscript.exe",
		     "csrss.exe", "ctfmon.exe", "cttune.exe", "cttunesvr.exe",
		     "custominstallexec.exe", "customshellhost.exe", "dashost.exe",
		     "dataexchangehost.exe", "datastorecachedumptool.exe",
		     "dccw.exe", "dcomcnfg.exe", "ddodiag.exe", "defrag.exe",
		     "deploymentcsphelper.exe", "desktopimgdownldr.exe",
		     "devicecensus.exe", "devicecredentialdeployment.exe",
		     "deviceeject.exe", "deviceenroller.exe",
		     "devicepairingwizard.exe", "deviceproperties.exe",
		     "dfdwiz.exe", "dfrgui.exe", "dialer.exe",
		     "directxdatabaseupdater.exe", "diskpart.exe", "diskperf.exe",
		     "diskraid.exe", "disksnapshot.exe", "dism.exe", "dispdiag.exe",
		     "displayswitch.exe", "djoin.exe", "dllhost.exe",
		     "dllhst3g.exe", "dmcertinst.exe", "dmcfghost.exe",
		     "dmclient.exe", "dmnotificationbroker.exe", "dmomacpmo.exe",
		     "dnscacheugc.exe", "doskey.exe", "dpapimig.exe",
		     "dpiscaling.exe", "dpnsvr.exe", "driverquery.exe",
		     "drvinst.exe", "dsmusertask.exe", "dsregcmd.exe",
		     "dstokenclean.exe", "dusmtask.exe", "dvdplay.exe", "dwm.exe",
		     "dwwin.exe", "dxdiag.exe", "dxgiadaptercache.exe",
		     "dxpserver.exe", "eap3host.exe", "easeofaccessdialog.exe",
		     "easinvoker.exe", "easpolicymanagerbrokerhost.exe",
		     "edpcleanup.exe", "edpnotify.exe", "eduprintprov.exe",
		     "efsui.exe", "ehstorauthn.exe", "eoaexperiences.exe",
		     "esentutl.exe", "eudcedit.exe", "eventcreate.exe",
		     "eventvwr.exe", "expand.exe", "extrac32.exe", "fc.exe",
		     "fclip.exe", "fhmanagew.exe", "filehistory.exe", "find.exe",
		     "findstr.exe", "finger.exe", "fixmapi.exe", "fltmc.exe",
		     "fodhelper.exe", "fondue.exe", "fontdrvhost.exe",
		     "fontview.exe", "forfiles.exe", "fsavailux.exe", "fsiso.exe",
		     "fsquirt.exe", "fsutil.exe", "ftp.exe", "fvenotify.exe",
		     "fveprompt.exe", "gamebarpresencewriter.exe", "gamepanel.exe",
		     "genvalobj.exe", "getmac.exe", "gpresult.exe", "gpscript.exe",
		     "gpupdate.exe", "grpconv.exe", "hdwwiz.exe", "help.exe",
		     "hostname.exe", "hvax64.exe", "hvix64.exe",
		     "hvsievaluator.exe", "icacls.exe", "icsentitlementhost.exe",
		     "icsunattend.exe", "ie4uinit.exe", "ie4ushowie.exe",
		     "iesettingsync.exe", "ieunatt.exe", "iexpress.exe",
		     "immersivetpmvscmgrsvr.exe", "infdefaultinstall.exe",
		     "inputswitchtoasthandler.exe", "iotstartup.exe",
		     "ipconfig.exe", "iscsicli.exe", "iscsicpl.exe", "isoburn.exe",
		     "klist.exe", "ksetup.exe", "ktmutil.exe", "label.exe",
		     "languagecomponentsinstallercomhandler.exe", "launchtm.exe",
		     "launchwinapp.exe", "legacynetuxhost.exe",
		     "licensemanagershellext.exe", "licensingdiag.exe",
		     "licensingui.exe", "locationnotificationwindows.exe",
		     "locator.exe", "lockapphost.exe",
		     "lockscreencontentserver.exe", "lodctr.exe", "logagent.exe",
		     "logman.exe", "logoff.exe", "logonui.exe", "lpkinstall.exe",
		     "lpksetup.exe", "lpremove.exe", "lsaiso.exe", "lsass.exe",
		     "magnify.exe", "makecab.exe", "manage-bde.exe",
		     "mavinject.exe", "mbaeparsertask.exe", "mblctr.exe",
		     "mbr2gpt.exe", "mcbuilder.exe", "mdeserver.exe",
		     "mdmagent.exe", "mdmappinstaller.exe",
		     "mdmdiagnosticstool.exe", "mdres.exe", "mdsched.exe",
		     "mfpmp.exe", "microsoft.uev.cscunpintool.exe",
		     "microsoft.uev.synccontroller.exe", "microsoftedgebchost.exe",
		     "microsoftedgecp.exe", "microsoftedgedevtools.exe",
		     "microsoftedgesh.exe", "mmc.exe", "mmgaserver.exe",
		     "mobsync.exe", "mountvol.exe", "mousocoreworker.exe",
		     "mpnotify.exe", "mpsigstub.exe", "mrinfo.exe", "mschedexe.exe",
		     "msconfig.exe", "msdt.exe", "msdtc.exe", "msfeedssync.exe",
		     "msg.exe", "mshta.exe", "msiexec.exe", "msinfo32.exe",
		     "mspaint.exe", "msra.exe", "msspellcheckinghost.exe",
		     "mstsc.exe", "mtstocom.exe", "muiunattend.exe",
		     "multidigimon.exe", "musnotification.exe",
		     "musnotificationux.exe", "musnotifyicon.exe", "narrator.exe",
		     "nbtstat.exe", "ndadmin.exe", "ndkping.exe", "net.exe",
		     "net1.exe", "netbtugc.exe", "netcfg.exe",
		     "netcfgnotifyobjecthost.exe", "netevtfwdr.exe", "nethost.exe",
		     "netiougc.exe", "netplwiz.exe", "netsh.exe", "netstat.exe",
		     "newdev.exe", "ngciso.exe", "nltest.exe", "notepad.exe",
		     "nslookup.exe", "ntoskrnl.exe", "ntprint.exe", "odbcad32.exe",
		     "odbcconf.exe", "ofdeploy.exe", "omadmclient.exe",
		     "omadmprc.exe", "openfiles.exe", "openwith.exe",
		     "optionalfeatures.exe", "osk.exe", "pacjsworker.exe",
		     "packagedcwalauncher.exe", "packageinspector.exe",
		     "passwordonwakesettingflyout.exe", "pathping.exe",
		     "pcalua.exe", "pcaui.exe", "pcwrun.exe", "perfmon.exe",
		     "phoneactivate.exe", "pickerhost.exe",
		     "pinenrollmentbroker.exe", "ping.exe", "pkgmgr.exe",
		     "pktmon.exe", "plasrv.exe", "pnpunattend.exe", "pnputil.exe",
		     "poqexec.exe", "pospaymentsworker.exe", "powercfg.exe",
		     "presentationhost.exe", "presentationsettings.exe",
		     "prevhost.exe", "printbrmui.exe", "printfilterpipelinesvc.exe",
		     "printisolationhost.exe", "printui.exe", "proquota.exe",
		     "provlaunch.exe", "provtool.exe", "proximityuxhost.exe",
		     "prproc.exe", "psr.exe", "pwlauncher.exe", "qappsrv.exe",
		     "qprocess.exe", "query.exe", "quser.exe", "qwinsta.exe",
		     "rasautou.exe", "rasdial.exe", "raserver.exe", "rasphone.exe",
		     "rdpclip.exe", "rdpinit.exe", "rdpinput.exe", "rdpsa.exe",
		     "rdpsaproxy.exe", "rdpsauachelper.exe", "rdpshell.exe",
		     "rdpsign.exe", "rdrleakdiag.exe", "reagentc.exe",
		     "recdisc.exe", "recover.exe", "recoverydrive.exe",
		     "refsutil.exe", "reg.exe", "regedt32.exe", "regini.exe",
		     "register-cimprovider.exe", "regsvr32.exe", "rekeywiz.exe",
		     "relog.exe", "relpost.exe", "remoteapplifetimemanager.exe",
		     "remoteposworker.exe", "repair-bde.exe", "replace.exe",
		     "reset.exe", "resetengine.exe", "resmon.exe", "rmactivate.exe",
		     "rmactivate_isv.exe", "rmactivate_ssp.exe",
		     "rmactivate_ssp_isv.exe", "rmclient.exe",
		     "rmttpmvscmgrsvr.exe", "robocopy.exe", "route.exe",
		     "rpcping.exe", "rrinstaller.exe", "rstrui.exe", "runas.exe",
		     "rundll32.exe", "runexehelper.exe", "runlegacycplelevated.exe",
		     "runonce.exe", "runtimebroker.exe", "rwinsta.exe", "sc.exe",
		     "schtasks.exe", "scriptrunner.exe", "sdbinst.exe",
		     "sdchange.exe", "sdclt.exe", "sdiagnhost.exe",
		     "searchfilterhost.exe", "searchindexer.exe",
		     "searchprotocolhost.exe", "secedit.exe", "secinit.exe",
		     "securekernel.exe", "securityhealthhost.exe",
		     "securityhealthservice.exe", "securityhealthsystray.exe",
		     "sensordataservice.exe", "services.exe", "sessionmsg.exe",
		     "sethc.exe", "setspn.exe", "settingsynchost.exe",
		     "setupcl.exe", "setupugc.exe", "setx.exe", "sfc.exe",
		     "sgrmbroker.exe", "sgrmlpac.exe", "shellappruntime.exe",
		     "shrpubw.exe", "shutdown.exe", "sigverif.exe", "sihclient.exe",
		     "sihost.exe", "slidetoshutdown.exe", "slui.exe",
		     "smartscreen.exe", "smss.exe", "sndvol.exe",
		     "snippingtool.exe", "snmptrap.exe", "sort.exe",
		     "spaceagent.exe", "spaceman.exe", "spatialaudiolicensesrv.exe",
		     "spectrum.exe", "spoolsv.exe", "sppextcomobj.exe",
		     "sppsvc.exe", "srdelayed.exe", "srtasks.exe", "stordiag.exe",
		     "subst.exe", "svchost.exe", "sxstrace.exe",
		     "syncappvpublishingserver.exe", "synchost.exe",
		     "sysreseterr.exe", "systeminfo.exe",
		     "systempropertiesadvanced.exe",
		     "systempropertiescomputername.exe",
		     "systempropertiesdataexecutionprevention.exe",
		     "systempropertieshardware.exe",
		     "systempropertiesperformance.exe",
		     "systempropertiesprotection.exe", "systempropertiesremote.exe",
		     "systemreset.exe", "systemsettingsadminflows.exe",
		     "systemsettingsbroker.exe", "systemsettingsremovedevice.exe",
		     "systemuwplauncher.exe", "systray.exe", "tabcal.exe",
		     "takeown.exe", "tapiunattend.exe", "tar.exe", "taskhostw.exe",
		     "taskkill.exe", "tasklist.exe", "taskmgr.exe", "tcblaunch.exe",
		     "tcmsetup.exe", "tcpsvcs.exe", "thumbnailextractionhost.exe",
		     "tieringengineservice.exe", "timeout.exe",
		     "tokenbrokercookies.exe", "tpminit.exe", "tpmtool.exe",
		     "tpmvscmgr.exe", "tpmvscmgrsvr.exe", "tracerpt.exe",
		     "tracert.exe", "tscon.exe", "tsdiscon.exe", "tskill.exe",
		     "tstheme.exe", "tswbprxy.exe", "ttdinject.exe", "tttracer.exe",
		     "typeperf.exe", "tzsync.exe", "tzutil.exe", "ucsvc.exe",
		     "uevagentpolicygenerator.exe", "uevappmonitor.exe",
		     "uevtemplatebaselinegenerator.exe",
		     "uevtemplateconfigitemgenerator.exe", "uimgrbroker.exe",
		     "unlodctr.exe", "unregmp2.exe", "upfc.exe",
		     "upgraderesultsui.exe", "upnpcont.exe",
		     "upprinterinstaller.exe", "useraccountbroker.exe",
		     "useraccountcontrolsettings.exe", "userinit.exe",
		     "usoclient.exe", "utcdecoderhost.exe", "utilman.exe",
		     "vaultcmd.exe", "vds.exe", "vdsldr.exe", "verclsid.exe",
		     "verifier.exe", "verifiergui.exe", "vssadmin.exe", "vssvc.exe",
		     "w32tm.exe", "waasmedicagent.exe", "waitfor.exe",
		     "wallpaperhost.exe", "wbadmin.exe", "wbengine.exe",
		     "wecutil.exe", "werfault.exe", "werfaultsecure.exe",
		     "wermgr.exe", "wevtutil.exe", "wextract.exe", "where.exe",
		     "whoami.exe", "wiaacmgr.exe", "wiawow64.exe", "wifitask.exe",
		     "wimserv.exe", "winbiodatamodeloobe.exe",
		     "windows.media.backgroundplayback.exe",
		     "windows.warp.jitservice.exe", "windowsactiondialog.exe",
		     "windowsupdateelevatedinstaller.exe", "wininit.exe",
		     "winload.exe", "winlogon.exe", "winresume.exe", "winrs.exe",
		     "winrshost.exe", "winrtnetmuahostserver.exe", "winsat.exe",
		     "winver.exe", "wkspbroker.exe", "wksprt.exe", "wlanext.exe",
		     "wlrmdr.exe", "wmpdmc.exe", "workfolders.exe", "wowreg32.exe",
		     "wpcmon.exe", "wpctok.exe", "wpdshextautoplay.exe",
		     "wpnpinst.exe", "wpr.exe", "write.exe", "wscadminui.exe",
		     "wscollect.exe", "wscript.exe", "wsl.exe",
		     "wsmanhttpconfig.exe", "wsmprovhost.exe", "wsqmcons.exe",
		     "wsreset.exe", "wuapihost.exe", "wuauclt.exe",
		     "wudfcompanionhost.exe", "wudfhost.exe", "wusa.exe",
		     "wwahost.exe", "xblgamesavetask.exe", "xcopy.exe",
		     "xwizard.exe", "aggregatorhost.exe", "diskusage.exe",
		     "dtdump.exe", "ism.exe", "ndkperfcmd.exe", "ntkrla57.exe",
		     "securekernella57.exe", "spaceutil.exe", "configure-
		     smremoting.exe", "dcgpofix.exe", "dcpromo.exe", "dimc.exe",
		     "diskshadow.exe", "drvcfg.exe", "escunattend.exe",
		     "iashost.exe", "ktpass.exe", "lbfoadmin.exe", "netdom.exe",
		     "rdspnf.exe", "rsopprov.exe", "sacsess.exe",
		     "servermanager.exe", "servermanagerlauncher.exe", "setres.exe",
		     "tsecimp.exe", "vssuirun.exe", "webcache.exe", "win32calc.exe",
		     "certoc.exe", "sdndiagnosticstask.exe", "xpsrchvw.exe"     )
		     and   not (     process.code_signature.subject_name in (
		     "Microsoft Windows",       "Microsoft Corporation",
		     "Microsoft Windows Publisher"     ) and
		     process.code_signature.trusted == true   ) and not
		     process.code_signature.status: ("errorCode_endpoint*",
		     "errorUntrustedRoot", "errorChaining") and   not   (
		     process.executable: (       "?:\\Program
		     Files\\Git\\usr\\bin\\hostname.exe",
		     "?:\\Windows\\Temp\\{*}\\taskkill.exe",
		     "?:\\Users\\*\\AppData\\Local\\Temp\\{*}\\taskkill.exe",
		     "?:\\$WINDOWS.~BT\\NewOS\\Windows\\System32\\ie4ushowIE.exe",
		     "?:\\Program Files\\Git\\usr\\bin\\find.exe",
		     "?:\\Program Files (x86)\\Axence\\nVision Agent
		     2\\nss\\certutil.exe"     )   ) and   not   (
		     (process.name: "ucsvc.exe" and
		     process.code_signature.subject_name == "Wellbia.com Co., Ltd."
		     and process.code_signature.status: "trusted") or
		     (process.name: "pnputil.exe" and
		     process.code_signature.subject_name: ("Lenovo", "HP Inc.",
		     "Dell Inc") and process.code_signature.status: "trusted") or
		     (process.name: "convert.exe" and
		     process.code_signature.subject_name: "ImageMagick Studio LLC"
		     and process.code_signature.status: "trusted") or
		     (process.name: "systeminfo.exe" and
		     process.code_signature.subject_name: "Arctic Wolf Networks,
		     Inc." and process.code_signature.status: "trusted") or     (
		     process.name: "certutil.exe" and
		     process.code_signature.subject_name: (         "Intel(R) Online
		     Connect Access",         "Fortinet Technologies (Canada) ULC"
		     ) and process.code_signature.status: "trusted"     ) or     (
		     process.name: "sfc.exe" and
		     process.code_signature.subject_name: (         "Cisco Systems,
		     Inc.",         "CISCO SYSTEMS CANADA CO"       ) and
		     process.code_signature.status: "trusted"     )   )

NamE: Potential Veeam Credential Access Command
	description: 
		     Identifies commands that can access and decrypt
		     Veeam credentials stored in MSSQL databases. Attackers can use
		     Veeam Credentials to target backups as part of destructive
		     operations such as Ransomware attacks.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (     (process.name : "sqlcmd.exe" or
		     ?process.pe.original_file_name : "sqlcmd.exe") or
		     process.args : ("Invoke-Sqlcmd", "Invoke-SqlExecute", "Invoke-
		     DbaQuery", "Invoke-SqlQuery")   ) and   process.args :
		     "*[VeeamBackup].[dbo].[Credentials]*"

NamE: Polkit Version Discovery
	description: 
		     This rule detects Polkit version discovery
		     activity on Linux systems. Polkit version discovery can be an
		     indication of an attacker attempting to exploit
		     misconfigurations or vulnerabilities in the Polkit service.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2") and (   (process.name == "dnf" and
		     process.args == "dnf" and process.args == "info" and
		     process.args == "polkit") or   (process.name == "rpm" and
		     process.args == "polkit") or   (process.name == "apt" and
		     process.args == "show" and process.args == "policykit-1") or
		     (process.name == "pkaction" and process.args == "--version") )

NamE: Base16 or Base32 Encoding/Decoding Activity
	description: 
		     Adversaries may encode/decode data in an attempt
		     to evade detection by host- or network-based security controls.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and  event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed", "process_started") and
		     process.name in ("base16", "base32", "base32plain",
		     "base32hex") and not process.args in ("--help", "--version")

NamE: Manual Dracut Execution
	description: 
		     This rule detects manual execution of the
		     `dracut` command on Linux systems. Dracut is a tool used to
		     generate an initramfs image that is used to boot the system.
		     Attackers may use `dracut` to create a custom initramfs image
		     that includes malicious code or backdoors, allowing them to
		     maintain persistence on the system.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2") and process.name == "dracut" and
		     process.parent.executable != null and not (
		     process.parent.executable like~ (     "/usr/lib/kernel/*",
		     "/etc/kernel/install.d/*",
		     "/var/lib/dpkg/info/dracut.postinst",     "/tmp/newroot/*",
		     "/usr/lib/module-init-tools/*"   ) or   process.parent.name in
		     (     "dracut-install", "dracut", "run-parts", "weak-modules",
		     "mkdumprd", "new-kernel-pkg", "sudo"   ) or
		     process.parent.args like~ ("/usr/bin/dracut-rebuild",
		     "/var/tmp/rpm-tmp.*") or   process.parent.command_line like~
		     "/bin/sh -c if command -v mkinitcpio*" )

NamE: Kirbi File Creation
	description: 
		     Identifies the creation of .kirbi files. The
		     creation of this kind of file is an indicator of an attacker
		     running Kerberos ticket dump utilities, such as Mimikatz, and
		     precedes attacks such as Pass-The-Ticket (PTT), which allows
		     the attacker to impersonate users using Kerberos tickets.
	query: 
		     file where host.os.type == "windows" and event.type ==
		     "creation" and file.extension : "kirbi"

NamE: Process Termination followed by Deletion
	description: 
		     Identifies a process termination event quickly
		     followed by the deletion of its executable file. Malware tools
		     and other non-native files dropped or created on a system by an
		     adversary may leave traces to indicate to what occurred.
		     Removal of these files can occur during an intrusion, or as
		     part of a post-intrusion process to minimize the adversary's
		     footprint.
	query: 
		     sequence by host.id with maxspan=5s    [process where
		     host.os.type == "windows" and event.type == "end" and
		     process.code_signature.trusted != true and     not
		     process.executable like
		     ("C:\\Windows\\SoftwareDistribution\\*.exe",
		     "C:\\Windows\\WinSxS\\*.exe",
		     "?:\\Windows\\Postillion\\Office\\*.exe") and     not (
		     process.name : "infinst.exe" and process.parent.name:
		     "dxsetup.exe" and
		     process.parent.code_signature.subject_name == "NVIDIA
		     Corporation" and       process.parent.code_signature.status ==
		     "trusted"     )    ] by process.executable    [file where
		     host.os.type == "windows" and event.type == "deletion" and
		     file.extension in~ ("exe", "scr", "com") and     not
		     process.executable like              ("?:\\Program
		     Files\\*.exe",               "?:\\Program Files (x86)\\*.exe",
		     "?:\\Windows\\System32\\svchost.exe",
		     "?:\\Windows\\System32\\drvinst.exe",
		     "?:\\Windows\\Postillion\\Office\\*.exe") and     not file.path
		     like (           "?:\\Program Files\\*.exe",
		     "?:\\Program Files (x86)\\*.exe",
		     "?:\\Windows\\Temp\\*\\DismHost.exe",
		     "?:\\$WINDOWS.~BT\\Work\\*\\DismHost.exe",
		     "?:\\$WinREAgent\\Scratch\\*\\DismHost.exe",
		     "?:\\Windows\\tenable_mw_scan_*.exe",           "?:\\Users\\*\\
		     AppData\\Local\\Temp\\LogiUI\\Pak\\uninstall.exe",
		     "?:\\ProgramData\\chocolatey\\*.exe"     ) and     not
		     (process.name : "OktaVerifySetup-*.exe" and
		     process.code_signature.subject_name == "Okta, Inc.") and
		     not (       process.executable : "?:\\Windows\\SysWOW64\\config
		     \\systemprofile\\Citrix\\UpdaterBinaries\\CitrixReceiver\\*"
		     and       process.code_signature.subject_name == "Citrix
		     Systems, Inc." and       file.path : "?:\\Windows\\SysWOW64\\co
		     nfig\\systemprofile\\Citrix\\UpdaterBinaries\\CitrixReceiver\\*
		     \\bootstrapperhelper.exe"     )    ] by file.path

NamE: AWS RDS Instance/Cluster Stoppage
	description: 
		     Identifies that an Amazon Relational Database
		     Service (RDS) cluster or instance has been stopped.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:rds.amazonaws.com and
		     event.action:(StopDBCluster or StopDBInstance) and
		     event.outcome:success

NamE: OneDrive Malware File Upload
	description: 
		     Identifies the occurence of files uploaded to
		     OneDrive being detected as Malware by the file scanning engine.
		     Attackers can use File Sharing and Organization Repositories to
		     spread laterally within the company and amplify their access.
		     Users can inadvertently share these files without knowing their
		     maliciousness, giving adversaries opportunity to gain initial
		     access to other endpoints in the environment.
	query: 
		     event.dataset:o365.audit and event.provider:OneDrive
		     and event.code:SharePointFileOperation and
		     event.action:FileMalwareDetected

NamE: Deprecated - Modification of Dynamic Linker Preload Shared Object Inside A Container
	description: 
		     This rule detects the creation or modification
		     of the dynamic linker preload shared object (ld.so.preload)
		     inside a container. The Linux dynamic linker is used to load
		     libraries needed by a program at runtime. Adversaries may
		     hijack the dynamic linker by modifying the /etc/ld.so.preload
		     file to point to malicious libraries. This behavior can be used
		     to grant unauthorized access to system resources and has been
		     used to evade detection of malicious processes in container
		     environments.
	query: 
		     file where event.module== "cloud_defend" and
		     event.type != "deletion" and file.path== "/etc/ld.so.preload"

NamE: Google Workspace Drive Encryption Key(s) Accessed from Anonymous User
	description: 
		     Detects when an external (anonymous) user has
		     viewed, copied or downloaded an encryption key file from a
		     Google Workspace drive. Adversaries may gain access to
		     encryption keys stored in private drives from rogue access
		     links that do not have an expiration. Access to encryption keys
		     may allow adversaries to access sensitive data or authenticate
		     on behalf of users.
	query: 
		     file where event.dataset == "google_workspace.drive"
		     and event.action : ("copy", "view", "download") and
		     google_workspace.drive.visibility: "people_with_link" and
		     source.user.email == "" and     file.extension: (
		     "token","assig", "pssc", "keystore", "pub", "pgp.asc",
		     "ps1xml", "pem", "gpg.sig", "der", "key",         "p7r", "p12",
		     "asc", "jks", "p7b", "signature", "gpg", "pgp.sig", "sst",
		     "pgp", "gpgz", "pfx", "crt",         "p8", "sig", "pkcs7",
		     "jceks", "pkcs8", "psc1", "p7c", "csr", "cer", "spc", "ps2xml")

NamE: Multiple Okta User Auth Events with Same Device Token Hash Behind a Proxy
	description: 
		     Detects when Okta user authentication events are
		     reported for multiple users with the same device token hash
		     behind a proxy.
	query: 
		     event.dataset:okta.system     and not
		     okta.actor.id:okta* and okta.debug_context.debug_data.dt_hash:*
		     and okta.event_type:user.authentication* and
		     okta.security_context.is_proxy:true

NamE: AWS EC2 Full Network Packet Capture Detected
	description: 
		     Identifies potential Traffic Mirroring in an
		     Amazon Elastic Compute Cloud (EC2) instance. Traffic Mirroring
		     is an Amazon VPC feature that you can use to copy network
		     traffic from an Elastic network interface. This feature can
		     potentially be abused to exfiltrate sensitive data from
		     unencrypted internal traffic.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:ec2.amazonaws.com and
		     event.action:(CreateTrafficMirrorFilter or
		     CreateTrafficMirrorFilterRule or CreateTrafficMirrorSession or
		     CreateTrafficMirrorTarget) and event.outcome:success

NamE: Execution via Windows Subsystem for Linux
	description: 
		     Detects attempts to execute a program on the
		     host from the Windows Subsystem for Linux. Adversaries may
		     enable and use WSL for Linux to avoid detection.
	query: 
		     process where host.os.type == "windows" and event.type
		     : "start" and   process.parent.name : ("wsl.exe",
		     "wslhost.exe") and   not process.executable : (
		     "?:\\Program Files (x86)\\*",         "?:\\Program Files\\*",
		     "?:\\Program Files*\\WindowsApps\\MicrosoftCorporationII.Window
		     sSubsystemForLinux_*\\wsl*.exe",
		     "?:\\Windows\\System32\\conhost.exe",
		     "?:\\Windows\\System32\\lxss\\wslhost.exe",
		     "?:\\Windows\\System32\\WerFault.exe",
		     "?:\\Windows\\Sys?????\\wslconfig.exe"   ) and   not (
		     event.dataset == "crowdstrike.fdr" and       process.executable
		     : (         "\\Device\\HarddiskVolume?\\Program Files
		     (x86)\\*",         "\\Device\\HarddiskVolume?\\Program
		     Files\\*",         "\\Device\\HarddiskVolume?\\Program Files*\\
		     WindowsApps\\MicrosoftCorporationII.WindowsSubsystemForLinux_*\
		     \wsl*.exe",
		     "\\Device\\HarddiskVolume?\\Windows\\System32\\conhost.exe",
		     "\\Device\\HarddiskVolume?\\Windows\\System32\\lxss\\wslhost.ex
		     e",
		     "\\Device\\HarddiskVolume?\\Windows\\System32\\WerFault.exe",
		     "\\Device\\HarddiskVolume?\\Windows\\Sys?????\\wslconfig.exe"
		     )   )

NamE: Remote File Creation in World Writeable Directory
	description: 
		     This rule detects the creation of a file in a
		     world-writeable directory through a service that is commonly
		     used for file transfer. This behavior is often associated with
		     lateral movement and can be an indicator of an attacker
		     attempting to move laterally within a network.
	query: 
		     file where host.os.type == "linux" and event.action ==
		     "creation" and process.name in ("scp", "sshd", "ssh", "ftp",
		     "sftp", "vsftpd", "sftp-server", "rsync") and file.path like~
		     ("/tmp*", "/var/tmp*", "/dev/shm/*", "/home/.*") and user.id !=
		     "0"

NamE: Persistence via Folder Action Script
	description: 
		     Detects modification of a Folder Action script.
		     A Folder Action script is executed when the folder to which it
		     is attached has items added or removed, or when its window is
		     opened, closed, moved, or resized. Adversaries may abuse this
		     feature to establish persistence by utilizing a malicious
		     script.
	query: 
		     process where host.os.type == "macos" and event.type :
		     "start" and process.name in ("osascript", "python", "tcl",
		     "node", "perl", "ruby", "php", "bash", "csh", "zsh", "sh") and
		     process.parent.name == "com.apple.foundation.UserScriptService"
		     and not process.args : ("/Users/*/Library/Application
		     Support/iTerm2/Scripts/AutoLaunch/*.scpt",
		     "/Users/*/Library/Application
		     Scripts/com.microsoft.*/FoxitUtils.applescript")

NamE: Authorization Plugin Modification
	description: 
		     Authorization plugins are used to extend the
		     authorization services API and implement mechanisms that are
		     not natively supported by the OS, such as multi-factor
		     authentication with third party software. Adversaries may abuse
		     this feature to persist and/or collect clear text credentials
		     as they traverse the registered plugins during user logon.
	query: 
		     event.category:file and host.os.type:macos and not
		     event.type:deletion and
		     file.path:(/Library/Security/SecurityAgentPlugins/* and   not
		     (/Library/Security/SecurityAgentPlugins/KandjiPassport.bundle/*
		     or /Library/Security/SecurityAgentPlugins/TeamViewerAuthPlugin.
		     bundle/*)) and   not (process.name:shove and
		     process.code_signature.trusted:true)

NamE: Potential DNS Tunneling via NsLookup
	description: 
		     This rule identifies a large number (15) of
		     nslookup.exe executions with an explicit query type from the
		     same host. This may indicate command and control activity
		     utilizing the DNS protocol.
	query: 
		     sequence by host.id with maxspan=5m [process where
		     host.os.type == "windows" and event.type == "start" and
		     process.name : "nslookup.exe" and process.args:("-querytype=*",
		     "-qt=*", "-q=*", "-type=*")] with runs = 10

NamE: Remote Scheduled Task Creation
	description: 
		     Identifies remote scheduled task creations on a
		     target host. This could be indicative of adversary lateral
		     movement.
	query: 
		     /* Task Scheduler service incoming connection followed
		     by TaskCache registry modification  */  sequence by host.id,
		     process.entity_id with maxspan = 1m    [network where
		     host.os.type == "windows" and process.name : "svchost.exe" and
		     network.direction : ("incoming", "ingress") and source.port >=
		     49152 and destination.port >= 49152 and    source.ip !=
		     "127.0.0.1" and source.ip != "::1"    ]    [registry where
		     host.os.type == "windows" and event.type == "change" and
		     registry.value : "Actions" and     registry.path :
		     "HKLM\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Schedule\\TaskCache\\Tasks\\*\\Actions"]

NamE: RPM Package Installed by Unusual Parent Process
	description: 
		     This rule leverages the new_terms rule type to
		     identify the installation of RPM packages by an unusual parent
		     process. RPM is a package management system used in Linux
		     systems such as Red Hat, CentOS and Fedora. Attacks may
		     backdoor RPM packages to gain initial access or install
		     malicious RPM packages to maintain persistence.
	query: 
		     host.os.type:linux and event.category:process and
		     event.type:start and event.action:exec and process.name:rpm and
		     process.args:("-i" or "--install")

NamE: Google Workspace User Organizational Unit Changed
	description: 
		     Users in Google Workspace are typically assigned
		     a specific organizational unit that grants them permissions to
		     certain services and roles that are inherited from this
		     organizational unit. Adversaries may compromise a valid account
		     and change which organizational account the user belongs to
		     which then could allow them to inherit permissions to
		     applications and resources inaccessible prior to.
	query: 
		     event.dataset:"google_workspace.admin" and
		     event.type:change and event.category:iam     and
		     google_workspace.event.type:"USER_SETTINGS" and
		     event.action:"MOVE_USER_TO_ORG_UNIT"

NamE: AWS Lambda Function Created or Updated
	description: 
		     Identifies when an AWS Lambda function is
		     created or updated. AWS Lambda lets you run code without
		     provisioning or managing servers. Adversaries can create or
		     update Lambda functions to execute malicious code, exfiltrate
		     data, or escalate privileges. This is a [building block rule](h
		     ttps://www.elastic.co/guide/en/security/current/building-block-
		     rule.html) that does not generate alerts, but signals when a
		     Lambda function is created or updated that matches the rule's
		     conditions. To generate alerts, create a rule that uses this
		     signal as a building block.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "lambda.amazonaws.com"     and event.outcome:
		     "success"     and event.action: (CreateFunction* or
		     UpdateFunctionCode*)

NamE: Google Workspace Admin Role Assigned to a User
	description: 
		     Assigning the administrative role to a user will
		     grant them access to the Google Admin console and grant them
		     administrator privileges which allow them to access and manage
		     various resources and applications. An adversary may create a
		     new administrator account for persistence or apply the admin
		     role to an existing user to carry out further intrusion
		     efforts. Users with super-admin privileges can bypass single-
		     sign on if enabled in Google Workspace.
	query: 
		     event.dataset:"google_workspace.admin" and
		     event.category:"iam" and event.action:"ASSIGN_ROLE"   and
		     google_workspace.event.type:"DELEGATED_ADMIN_SETTINGS" and
		     google_workspace.admin.role.name : *_ADMIN_ROLE

NamE: Credential Dumping - Detected - Elastic Endgame
	description: 
		     Elastic Endgame detected Credential Dumping.
		     Click the Elastic Endgame icon in the event.module column or
		     the link in the rule.reference column for additional
		     information.
	query: 
		     event.kind:alert and event.module:endgame and
		     endgame.metadata.type:detection and
		     (event.action:cred_theft_event or
		     endgame.event_subtype_full:cred_theft_event)

NamE: Microsoft 365 Inbox Forwarding Rule Created
	description: 
		     Identifies when a new Inbox forwarding rule is
		     created in Microsoft 365. Inbox rules process messages in the
		     Inbox based on conditions and take actions. In this case, the
		     rules will forward the emails to a defined address. Attackers
		     can abuse Inbox Rules to intercept and exfiltrate email data
		     without making organization-wide configuration changes or
		     having the corresponding privileges.
	query: 
		     event.dataset:o365.audit and event.provider:Exchange
		     and event.category:web and event.action:("New-InboxRule" or
		     "Set-InboxRule") and     (
		     o365.audit.Parameters.ForwardTo:* or
		     o365.audit.Parameters.ForwardAsAttachmentTo:* or
		     o365.audit.Parameters.RedirectTo:*     )     and
		     event.outcome:success

NamE: GCP Pub/Sub Subscription Creation
	description: 
		     Identifies the creation of a subscription in
		     Google Cloud Platform (GCP). In GCP, the publisher-subscriber
		     relationship (Pub/Sub) is an asynchronous messaging service
		     that decouples event-producing and event-processing services. A
		     subscription is a named resource representing the stream of
		     messages to be delivered to the subscribing application.
	query: 
		     event.dataset:gcp.audit and event.action:google.pubsub
		     .v*.Subscriber.CreateSubscription and event.outcome:success

NamE: Potential Internal Linux SSH Brute Force Detected
	description: 
		     Identifies multiple internal consecutive login
		     failures targeting a user account from the same source address
		     within a short time interval. Adversaries will often brute
		     force login attempts across multiple users with a common or
		     known password, in an attempt to gain access to these accounts.
	query: 
		     sequence by host.id, source.ip, user.name with
		     maxspan=15s   [ authentication where host.os.type == "linux"
		     and     event.action in ("ssh_login", "user_login") and
		     event.outcome == "failure" and    cidrmatch(source.ip,
		     "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12",
		     "192.0.0.0/24",        "192.0.0.0/29", "192.0.0.8/32",
		     "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32",
		     "192.0.0.171/32",        "192.0.2.0/24", "192.31.196.0/24",
		     "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24",
		     "224.0.0.0/4",        "100.64.0.0/10",
		     "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24",
		     "203.0.113.0/24", "240.0.0.0/4",         "::1", "FE80::/10",
		     "FF00::/8") ] with runs = 10

NamE: File Compressed or Archived into Common Format by Unsigned Process
	description: 
		     Detects files being compressed or archived into
		     common formats by unsigned processes. This is a common
		     technique used to obfuscate files to evade detection or to
		     staging data for exfiltration.
	query: 
		     file where host.os.type == "windows" and event.type in
		     ("creation", "change") and  process.executable != null and
		     process.code_signature.trusted != true and
		     file.Ext.header_bytes : (                           /*
		     compression formats */                           "1F9D*",
		     /* tar zip, tar.z (Lempel-Ziv-Welch algorithm) */
		     "1FA0*",             /* tar zip, tar.z (LZH algorithm) */
		     "425A68*",           /* Bzip2 */
		     "524E4301*",         /* Rob Northen Compression */
		     "524E4302*",         /* Rob Northen Compression */
		     "4C5A4950*",         /* LZIP */
		     "504B0*",            /* ZIP */
		     "526172211A07*",     /* RAR compressed */
		     "44434D0150413330*", /* Windows Update Binary Delta Compression
		     file */                           "50413330*",         /*
		     Windows Update Binary Delta Compression file */
		     "377ABCAF271C*",     /* 7-Zip */
		     "1F8B*",             /* GZIP */
		     "FD377A585A00*",     /* XZ, tar.xz */
		     "7801*",                 /* zlib: No Compression (no preset
		     dictionary) */                           "785E*",
		     /* zlib: Best speed (no preset dictionary) */
		     "789C*",                 /* zlib: Default Compression (no
		     preset dictionary) */                           "78DA*",
		     /* zlib: Best Compression (no preset dictionary) */
		     "7820*",                 /* zlib: No Compression (with preset
		     dictionary) */                           "787D*",
		     /* zlib: Best speed (with preset dictionary) */
		     "78BB*",                 /* zlib: Default Compression (with
		     preset dictionary) */                           "78F9*",
		     /* zlib: Best Compression (with preset dictionary) */
		     "62767832*",         /* LZFSE */
		     "28B52FFD*",         /* Zstandard, zst */
		     "5253564B44415441*", /* QuickZip rs compressed archive */
		     "2A2A4143452A2A*",   /* ACE */                            /*
		     archive formats */                           "2D686C302D*",
		     /* lzh */                           "2D686C352D*",       /* lzh
		     */                           "303730373037*",     /* cpio */
		     "78617221*",         /* xar */
		     "4F4152*",           /* oar */
		     "49536328*"          /* cab archive */  )

NamE: Windows Registry File Creation in SMB Share
	description: 
		     Identifies the creation or modification of a
		     medium-size registry hive file on a Server Message Block (SMB)
		     share, which may indicate an exfiltration attempt of a
		     previously dumped Security Account Manager (SAM) registry hive
		     for credential extraction on an attacker-controlled system.
	query: 
		     file where host.os.type == "windows" and event.type ==
		     "creation" and  /* regf file header */  file.Ext.header_bytes :
		     "72656766*" and file.size >= 30000 and  process.pid == 4 and
		     user.id : ("S-1-5-21*", "S-1-12-1-*") and  not file.path : (
		     "?:\\*\\UPM_Profile\\NTUSER.DAT",
		     "?:\\*\\UPM_Profile\\NTUSER.DAT.LASTGOOD.LOAD",     "?:\\*\\UPM
		     _Profile\\AppData\\Local\\Microsoft\\Windows\\UsrClass.dat*",
		     "?:\\Windows\\Netwrix\\Temp\\????????.???.offreg",     "?:\\*\\
		     AppData\\Local\\Packages\\Microsoft.*\\Settings\\settings.dat*"
		     )

NamE: Lateral Movement via Startup Folder
	description: 
		     Identifies suspicious file creations in the
		     startup folder of a remote system. An adversary could abuse
		     this to move laterally by dropping a malicious script or
		     executable that will be executed after a reboot or user logon.
	query: 
		     file where host.os.type == "windows" and event.type in
		     ("creation", "change") and   /* via RDP TSClient mounted share
		     or SMB */   (process.name : "mstsc.exe" or process.pid == 4)
		     and     file.path :
		     ("?:\\Users\\*\\AppData\\Roaming\\Microsoft\\Windows\\Start
		     Menu\\Programs\\Startup\\*",
		     "?:\\ProgramData\\Microsoft\\Windows\\Start
		     Menu\\Programs\\Startup\\*")

NamE: Creation or Modification of a new GPO Scheduled Task or Service
	description: 
		     Detects the creation or modification of a new
		     Group Policy based scheduled task or service. These methods are
		     used for legitimate system administration, but can also be
		     abused by an attacker with domain admin permissions to execute
		     a malicious payload remotely on all or a subset of the domain
		     joined machines.
	query: 
		     file where host.os.type == "windows" and event.type !=
		     "deletion" and event.action != "open" and  file.name :
		     ("ScheduledTasks.xml", "Services.xml") and   file.path : (     
		     "?:\\Windows\\SYSVOL\\domain\\Policies\\*\\MACHINE\\Preferences
		     \\ScheduledTasks\\ScheduledTasks.xml",     "?:\\Windows\\SYSVOL
		     \\domain\\Policies\\*\\MACHINE\\Preferences\\Services\\Services
		     .xml"   ) and   not process.executable :
		     "C:\\Windows\\System32\\dfsrs.exe"

NamE: Suspicious DLL Loaded for Persistence or Privilege Escalation
	description: 
		     Identifies the loading of a non Microsoft signed
		     DLL that is missing on a default Windows install (phantom DLL)
		     or one that can be loaded from a different location by a native
		     Windows process. This may be abused to persist or elevate
		     privileges via privileged file write vulnerabilities.
	query: 
		     any where host.os.type == "windows" and
		     (event.category : ("driver", "library") or (event.category ==
		     "process" and event.action : "Image loaded*")) and (   /*
		     compatible with Elastic Endpoint Library Events */   (
		     ?dll.name : (         "wlbsctrl.dll", "wbemcomn.dll",
		     "WptsExtensions.dll", "Tsmsisrv.dll", "TSVIPSrv.dll",
		     "Msfte.dll",         "wow64log.dll",
		     "WindowsCoreDeviceInfo.dll", "Ualapi.dll", "wlanhlp.dll",
		     "phoneinfo.dll", "EdgeGdi.dll",         "cdpsgshims.dll",
		     "windowsperformancerecordercontrol.dll", "diagtrack_win.dll",
		     "TPPCOIPW32.dll",          "tpgenlic.dll", "thinmon.dll",
		     "fxsst.dll", "msTracer.dll"     )     and (
		     ?dll.code_signature.trusted != true or
		     ?dll.code_signature.exists != true or       (
		     dll.code_signature.trusted == true and           not
		     dll.code_signature.subject_name : ("Microsoft Windows",
		     "Microsoft Corporation", "Microsoft Windows Publisher")       )
		     ) or    /* oci.dll is too noisy due to unsigned Oracle related
		     DLL loaded from random dirs */   (    (?dll.path :
		     "?:\\Windows\\*\\oci.dll" and process.executable :
		     "?:\\Windows\\*.exe" and      (?dll.code_signature.trusted !=
		     true or ?dll.code_signature.exists != true)) or
		     (file.path : "?:\\Windows\\*\\oci.dll" and not
		     file.code_signature.status == "Valid" and process.executable :
		     "?:\\Windows\\*.exe")    ) or     /* compatible with Sysmon
		     EventID 7 - Image Load */   (file.name : ("wlbsctrl.dll",
		     "wbemcomn.dll", "WptsExtensions.dll", "Tsmsisrv.dll",
		     "TSVIPSrv.dll", "Msfte.dll",                "wow64log.dll",
		     "WindowsCoreDeviceInfo.dll", "Ualapi.dll", "wlanhlp.dll",
		     "phoneinfo.dll", "EdgeGdi.dll",
		     "cdpsgshims.dll", "windowsperformancerecordercontrol.dll",
		     "diagtrack_win.dll", "TPPCOIPW32.dll",
		     "tpgenlic.dll", "thinmon.dll", "fxsst.dll", "msTracer.dll") and
		     not file.hash.sha256 :              ("6e837794fc282446906c36d68
		     1958f2f6212043fc117c716936920be166a700f",               "b14e49
		     54e8cca060ffeb57f2458b6a3a39c7d2f27e94391cbcea5387652f21a4",
		     "c258d90acd006fa109dc6b748008edbb196d6168bc75ace0de0de54a4db466
		     62") and     not file.code_signature.status == "Valid")   ) and
		     not   (     ?dll.path : (
		     "?:\\Windows\\System32\\wbemcomn.dll",
		     "?:\\Windows\\SysWOW64\\wbemcomn.dll",
		     "?:\\Windows\\System32\\windowsperformancerecordercontrol.dll",
		     "?:\\Windows\\System32\\wlanhlp.dll",
		     "\\Device\\HarddiskVolume?\\Windows\\SysWOW64\\wbemcomn.dll",
		     "\\Device\\HarddiskVolume?\\Windows\\System32\\wbemcomn.dll",
		     "\\Device\\HarddiskVolume?\\Windows\\SysWOW64\\wlanhlp.dll",
		     "\\Device\\HarddiskVolume?\\Windows\\System32\\wlanhlp.dll",
		     "\\Device\\HarddiskVolume?\\Windows\\SysWOW64\\windowsperforman
		     cerecordercontrol.dll",        "\\Device\\HarddiskVolume?\\Wind
		     ows\\System32\\windowsperformancerecordercontrol.dll",        "
		     C:\\ProgramData\\docker\\windowsfilter\\*\\Files\\Windows\\Syst
		     em32\\windowsperformancerecordercontrol.dll",        "C:\\Progr
		     amData\\docker\\windowsfilter\\*\\Files\\Windows\\System32\\win
		     dowsperformancerecordercontrol.dll",
		     "\\Device\\vmsmb\\VSMB-{*}\\os\\windows\\system32\\*.dll"     )
		     or     file.path : (
		     "?:\\Windows\\System32\\wbemcomn.dll",
		     "?:\\Windows\\SysWOW64\\wbemcomn.dll",
		     "?:\\Windows\\System32\\windowsperformancerecordercontrol.dll",
		     "?:\\Windows\\System32\\wlanhlp.dll",        "C:\\ProgramData\\
		     docker\\windowsfilter\\*\\Files\\Windows\\System32\\windowsperf
		     ormancerecordercontrol.dll",        "C:\\ProgramData\\docker\\w
		     indowsfilter\\*\\Files\\Windows\\System32\\wbemcomn.dll",
		     "\\Device\\vmsmb\\VSMB-{*}\\os\\windows\\system32\\*.dll"     )
		     ) )

NamE: Process Created with a Duplicated Token
	description: 
		     Identifies the creation of a process
		     impersonating the token of another user logon session.
		     Adversaries may create a new process with a different token to
		     escalate privileges and bypass access controls.
	query: 
		     /* This rule is only compatible with Elastic Endpoint
		     8.4+ */  process where host.os.type == "windows" and
		     event.action == "start" and   user.id : ("S-1-5-21-*",
		     "S-1-12-1-*") and   (process.Ext.effective_parent.executable
		     regex~ """[C-Z]:\\Windows\\(System32|SysWOW64)\\[a-zA-Z0-9\-
		     \_\.]+\.exe""" or   process.Ext.effective_parent.executable :
		     "?:\\Windows\\explorer.exe") and   (   process.name :
		     ("powershell.exe", "cmd.exe", "rundll32.exe", "notepad.exe",
		     "net.exe", "ntdsutil.exe",                   "tasklist.exe",
		     "reg.exe", "certutil.exe", "bitsadmin.exe", "msbuild.exe",
		     "esentutl.exe") or    ((process.Ext.relative_file_creation_time
		     <= 900 or process.Ext.relative_file_name_modify_time <= 900)
		     and    not process.code_signature.status : ("trusted",
		     "errorExpired", "errorCode_endpoint*") and    not
		     process.executable : ("?:\\Program Files\\*", "?:\\Program
		     Files (x86)\\*"))  ) and  not (process.name : "rundll32.exe"
		     and       process.command_line : ("*davclnt.dll,DavSetCookie*",
		     "*?:\\Program Files*",
		     "*\\Windows\\System32\\winethc.dll*",
		     "*\\Windows\\SYSTEM32\\EDGEHTML.dll*",
		     "*shell32.dll,SHCreateLocalServerRunDll*")) and  not
		     startswith~(process.Ext.effective_parent.name,
		     process.parent.name) and  not (process.name : "powershell.exe"
		     and process.parent.name : "wmiprvse.exe" and
		     process.Ext.effective_parent.executable :
		     "?:\\Windows\\System32\\wsmprovhost.exe") and  not
		     (process.Ext.effective_parent.executable :
		     "?:\\Windows\\System32\\RuntimeBroker.exe" and
		     process.parent.executable :
		     "?:\\Windows\\System32\\sihost.exe") and  not
		     (process.Ext.effective_parent.executable :
		     "?:\\Windows\\System32\\sethc.exe" and
		     process.parent.executable :
		     "?:\\Windows\\System32\\svchost.exe") and  not
		     (process.Ext.effective_parent.executable :
		     "?:\\Windows\\explorer.exe" and       process.parent.executable
		     : ("?:\\Windows\\System32\\svchost.exe",
		     "?:\\Windows\\System32\\msiexec.exe",
		     "?:\\Windows\\twain_32\\*.exe"))

NamE: Cupsd or Foomatic-rip Shell Execution
	description: 
		     This detection rule addresses multiple
		     vulnerabilities in the CUPS printing system, including
		     CVE-2024-47176, CVE-2024-47076, CVE-2024-47175, and
		     CVE-2024-47177. Specifically, this rule detects shell
		     executions from the foomatic-rip parent process. These flaws
		     impact components like cups-browsed, libcupsfilters, libppd,
		     and foomatic-rip, allowing remote unauthenticated attackers to
		     manipulate IPP URLs or inject malicious data through crafted
		     UDP packets or network spoofing. This can result in arbitrary
		     command execution when a print job is initiated.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2") and process.parent.name ==
		     "foomatic-rip" and   process.name in ("bash", "dash", "sh",
		     "tcsh", "csh", "zsh", "ksh", "fish") and not (
		     process.command_line like (       "*/tmp/foomatic-*",
		     "*-sDEVICE=ps2write*", "*printf*", "/bin/sh -e -c cat",
		     "/bin/bash -c cat",       "/bin/bash -e -c cat"     ) or
		     process.args like "gs*"   )

NamE: Enumerating Domain Trusts via DSQUERY.EXE
	description: 
		     Identifies the use of dsquery.exe for domain
		     trust discovery purposes. Adversaries may use this command-line
		     utility to enumerate trust relationships that may be used for
		     Lateral Movement opportunities in Windows multi-domain forest
		     environments.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and     (process.name : "dsquery.exe" or
		     ?process.pe.original_file_name: "dsquery.exe") and
		     process.args : "*objectClass=trustedDomain*"

NamE: Modification of OpenSSH Binaries
	description: 
		     Adversaries may modify SSH related binaries for
		     persistence or credential access by patching sensitive
		     functions to enable unauthorized access or by logging SSH
		     credentials for exfiltration.
	query: 
		     event.category:file and host.os.type:linux and
		     event.type:change and    process.name:(* and not (     dnf or
		     dnf-automatic or dpkg or yum or rpm or yum-cron or anacron or
		     platform-python* or     apk or ansible-admin or systemd or
		     python* or yum or nix-daemon or nix     )   ) and
		     (file.path:(/usr/bin/scp or                  /usr/bin/sftp or
		     /usr/bin/ssh or                  /usr/sbin/sshd) or
		     file.name:libkeyutils.so) and   not
		     process.executable:/usr/share/elasticsearch/*

NamE: Okta User Session Impersonation
	description: 
		     A user has initiated a session impersonation
		     granting them access to the environment with the permissions of
		     the user they are impersonating. This would likely indicate
		     Okta administrative access and should only ever occur if
		     requested and expected.
	query: 
		     event.dataset:okta.system and
		     event.action:user.session.impersonation.initiate

NamE: Unsigned DLL Side-Loading from a Suspicious Folder
	description: 
		     Identifies a Windows trusted program running
		     from locations often abused by adversaries to masquerade as a
		     trusted program and loading a recently dropped DLL. This
		     behavior may indicate an attempt to evade defenses via side-
		     loading a malicious DLL within the memory space of a signed
		     processes.
	query: 
		     library where host.os.type == "windows" and
		     process.code_signature.trusted == true and
		     (dll.Ext.relative_file_creation_time <= 500 or
		     dll.Ext.relative_file_name_modify_time <= 500) and    not
		     dll.code_signature.status : ("trusted", "errorExpired",
		     "errorCode_endpoint*", "errorChaining") and        /*
		     Suspicious Paths */       dll.path : ("?:\\PerfLogs\\*.dll",
		     "?:\\Users\\*\\Pictures\\*.dll",
		     "?:\\Users\\*\\Music\\*.dll",
		     "?:\\Users\\Public\\*.dll",
		     "?:\\Users\\*\\Documents\\*.dll",
		     "?:\\Windows\\Tasks\\*.dll",
		     "?:\\Windows\\System32\\Tasks\\*.dll",
		     "?:\\Intel\\*.dll",                   "?:\\AMD\\Temp\\*.dll",
		     "?:\\Windows\\AppReadiness\\*.dll",
		     "?:\\Windows\\ServiceState\\*.dll",
		     "?:\\Windows\\security\\*.dll",
		     "?:\\Windows\\System\\*.dll",
		     "?:\\Windows\\IdentityCRL\\*.dll",
		     "?:\\Windows\\Branding\\*.dll",
		     "?:\\Windows\\csc\\*.dll",
		     "?:\\Windows\\DigitalLocker\\*.dll",
		     "?:\\Windows\\en-US\\*.dll",
		     "?:\\Windows\\wlansvc\\*.dll",
		     "?:\\Windows\\Prefetch\\*.dll",
		     "?:\\Windows\\Fonts\\*.dll",
		     "?:\\Windows\\diagnostics\\*.dll",
		     "?:\\Windows\\TAPI\\*.dll",
		     "?:\\Windows\\INF\\*.dll",
		     "?:\\windows\\tracing\\*.dll",
		     "?:\\windows\\IME\\*.dll",
		     "?:\\Windows\\Performance\\*.dll",
		     "?:\\windows\\intel\\*.dll",
		     "?:\\windows\\ms\\*.dll",
		     "?:\\Windows\\dot3svc\\*.dll",
		     "?:\\Windows\\ServiceProfiles\\*.dll",
		     "?:\\Windows\\panther\\*.dll",
		     "?:\\Windows\\RemotePackages\\*.dll",
		     "?:\\Windows\\OCR\\*.dll",
		     "?:\\Windows\\appcompat\\*.dll",
		     "?:\\Windows\\apppatch\\*.dll",
		     "?:\\Windows\\addins\\*.dll",
		     "?:\\Windows\\Setup\\*.dll",
		     "?:\\Windows\\Help\\*.dll",
		     "?:\\Windows\\SKB\\*.dll",
		     "?:\\Windows\\Vss\\*.dll",
		     "?:\\Windows\\Web\\*.dll",
		     "?:\\Windows\\servicing\\*.dll",
		     "?:\\Windows\\CbsTemp\\*.dll",
		     "?:\\Windows\\Logs\\*.dll",
		     "?:\\Windows\\WaaS\\*.dll",
		     "?:\\Windows\\twain_32\\*.dll",
		     "?:\\Windows\\ShellExperiences\\*.dll",
		     "?:\\Windows\\ShellComponents\\*.dll",
		     "?:\\Windows\\PLA\\*.dll",
		     "?:\\Windows\\Migration\\*.dll",
		     "?:\\Windows\\debug\\*.dll",
		     "?:\\Windows\\Cursors\\*.dll",
		     "?:\\Windows\\Containers\\*.dll",
		     "?:\\Windows\\Boot\\*.dll",
		     "?:\\Windows\\bcastdvr\\*.dll",
		     "?:\\Windows\\TextInput\\*.dll",
		     "?:\\Windows\\schemas\\*.dll",
		     "?:\\Windows\\SchCache\\*.dll",
		     "?:\\Windows\\Resources\\*.dll",
		     "?:\\Windows\\rescache\\*.dll",
		     "?:\\Windows\\Provisioning\\*.dll",
		     "?:\\Windows\\PrintDialog\\*.dll",
		     "?:\\Windows\\PolicyDefinitions\\*.dll",
		     "?:\\Windows\\media\\*.dll",
		     "?:\\Windows\\Globalization\\*.dll",
		     "?:\\Windows\\L2Schemas\\*.dll",
		     "?:\\Windows\\LiveKernelReports\\*.dll",
		     "?:\\Windows\\ModemLogs\\*.dll",
		     "?:\\Windows\\ImmersiveControlPanel\\*.dll",
		     "?:\\$Recycle.Bin\\*.dll") and           /* DLL loaded from the
		     process.executable current directory */
		     endswith~(substring(dll.path, 0, length(dll.path) -
		     (length(dll.name) + 1)), substring(process.executable, 0,
		     length(process.executable) - (length(process.name) + 1)))

NamE: Simple HTTP Web Server Connection
	description: 
		     This rule detects connections accepted by a
		     simple HTTP web server in Python and PHP built-in modules.
		     Adversaries may create simple HTTP web servers to establish
		     persistence on a compromised system by uploading a reverse or
		     command shell payload to the server web root, allowing them to
		     regain remote access to the system if lost. This event may
		     occur when an attacker requests the server to execute a command
		     or script via a potential backdoor.
	query: 
		     network where host.os.type == "linux" and event.type
		     == "start" and event.action == "connection_accepted" and (
		     (process.name regex~ """php?[0-9]?\.?[0-9]{0,2}""" and
		     process.command_line like "*-S*") or   (process.name like
		     "python*" and process.command_line like ("*--cgi*",
		     "*CGIHTTPServer*")) )

NamE: Potential privilege escalation via CVE-2022-38028
	description: 
		     Identifies a privilege escalation attempt via
		     exploiting CVE-2022-38028 to hijack the print spooler service
		     execution.
	query: 
		     file where host.os.type == "windows" and event.type !=
		     "deletion" and     file.name : "MPDW-constraints.js" and
		     file.path : (         "?:\\*\\Windows\\system32\\DriVerStoRe\\F
		     iLeRePoSiToRy\\*\\MPDW-constraints.js",
		     "?:\\*\\Windows\\WinSxS\\amd64_microsoft-windows-printing-
		     printtopdf_*\\MPDW-constraints.js"     )

NamE: Delete Volume USN Journal with Fsutil
	description: 
		     Identifies use of the fsutil.exe to delete the
		     volume USNJRNL. This technique is used by attackers to
		     eliminate evidence of files created during post-exploitation
		     activities.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (process.name : "fsutil.exe" or
		     ?process.pe.original_file_name == "fsutil.exe") and
		     process.args : "deletejournal" and process.args : "usn"

NamE: Potential Buffer Overflow Attack Detected
	description: 
		     Detects potential buffer overflow attacks by
		     querying the "Segfault Detected" pre-built rule signal index,
		     through a threshold rule, with a minimum number of 100 segfault
		     alerts in a short timespan. A large amount of segfaults in a
		     short time interval could indicate application exploitation
		     attempts.
	query: 
		     kibana.alert.rule.rule_id:"5c81fc9d-1eae-437f-ba07-
		     268472967013" and host.os.type:linux and event.kind:signal

NamE: Agent Spoofing - Mismatched Agent ID
	description: 
		     Detects events that have a mismatch on the
		     expected event agent ID. The status
		     "agent_id_mismatch/mismatch" occurs when the expected agent ID
		     associated with the API key does not match the actual agent ID
		     in an event. This could indicate attempts to spoof events in
		     order to masquerade actual activity to evade detection.
	query: 
		     event.agent_id_status:(agent_id_mismatch or mismatch)

NamE: Process Injection by the Microsoft Build Engine
	description: 
		     An instance of MSBuild, the Microsoft Build
		     Engine, created a thread in another process. This technique is
		     sometimes used to evade detection or elevate privileges.
	query: 
		     process where host.os.type == "windows" and
		     event.provider == "Microsoft-Windows-Sysmon" and   /*
		     CreateRemoteThread */   event.code == "8" and process.name:
		     "MSBuild.exe"

NamE: Azure Key Vault Modified
	description: 
		     Identifies modifications to a Key Vault in
		     Azure. The Key Vault is a service that safeguards encryption
		     keys and secrets like certificates, connection strings, and
		     passwords. Because this data is sensitive and business
		     critical, access to key vaults should be secured to allow only
		     authorized applications and users.
	query: 
		     event.dataset:azure.activitylogs and azure.activitylog
		     s.operation_name:"MICROSOFT.KEYVAULT/VAULTS/WRITE" and
		     event.outcome:(Success or success)

NamE: Interactive Logon by an Unusual Process
	description: 
		     Identifies interactive logon attempt with
		     alternate credentials and by an unusual process. Adversaries
		     may create a new token to escalate privileges and bypass access
		     controls.
	query: 
		     authentication where  host.os.type : "windows" and
		     winlog.event_data.LogonProcessName : "Advapi*" and
		     winlog.logon.type == "Interactive" and
		     winlog.event_data.SubjectUserSid : ("S-1-5-21*", "S-1-12-*")
		     and  winlog.event_data.TargetUserSid : ("S-1-5-21*",
		     "S-1-12-*")  and process.executable : "C:\\*" and  not
		     startswith~(winlog.event_data.SubjectUserSid,
		     winlog.event_data.TargetUserSid) and  not process.executable :
		     ("?:\\Windows\\System32\\winlogon.exe",
		     "?:\\Windows\\System32\\wininit.exe",              "?:\\Program
		     Files\\*.exe",              "?:\\Program Files (x86)\\*.exe",
		     "?:\\Windows\\SysWOW64\\inetsrv\\w3wp.exe",
		     "?:\\Windows\\System32\\inetsrv\\w3wp.exe",
		     "?:\\Windows\\SysWOW64\\msiexec.exe")

NamE: Microsoft 365 Exchange Safe Link Policy Disabled
	description: 
		     Identifies when a Safe Link policy is disabled
		     in Microsoft 365. Safe Link policies for Office applications
		     extend phishing protection to documents that contain
		     hyperlinks, even after they have been delivered to a user.
	query: 
		     event.dataset:o365.audit and event.provider:Exchange
		     and event.category:web and event.action:"Disable-SafeLinksRule"
		     and event.outcome:success

NamE: Deprecated - SSH Process Launched From Inside A Container
	description: 
		     This rule detects an SSH or SSHD process
		     executed from inside a container. This includes both the client
		     ssh binary and server ssh daemon process. SSH usage inside a
		     container should be avoided and monitored closely when
		     necessary. With valid credentials an attacker may move
		     laterally to other containers or to the underlying host through
		     container breakout. They may also use valid SSH credentials as
		     a persistence mechanism.
	query: 
		     process where container.id: "*" and event.type==
		     "start" and event.action in ("fork", "exec") and process.name:
		     ("sshd", "ssh", "autossh")

NamE: User Added as Owner for Azure Application
	description: 
		     Identifies when a user is added as an owner for
		     an Azure application. An adversary may add a user account as an
		     owner for an Azure application in order to grant additional
		     permissions and modify the application's configuration using
		     another account.
	query: 
		     event.dataset:azure.auditlogs and
		     azure.auditlogs.operation_name:"Add owner to application" and
		     event.outcome:(Success or success)

NamE: rc.local/rc.common File Creation
	description: 
		     This rule monitors the creation/alteration of
		     the rc.local/rc.common file. The /etc/rc.local file is used to
		     start custom applications, services, scripts or commands during
		     start-up. The rc.local file has mostly been replaced by
		     Systemd. However, through the "systemd-rc-local-generator",
		     rc.local files can be converted to services that run at boot.
		     Adversaries may alter rc.local/rc.common to execute malicious
		     code at start-up, and gain persistence onto the system.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("rename", "creation") and file.path in ("/etc/rc.local",
		     "/etc/rc.common") and not (   process.executable in (
		     "/bin/dpkg", "/usr/bin/dpkg", "/bin/dockerd",
		     "/usr/bin/dockerd", "/usr/sbin/dockerd", "/bin/microdnf",
		     "/usr/bin/microdnf", "/bin/rpm", "/usr/bin/rpm", "/bin/snapd",
		     "/usr/bin/snapd", "/bin/yum", "/usr/bin/yum",     "/bin/dnf",
		     "/usr/bin/dnf", "/bin/podman", "/usr/bin/podman", "/bin/dnf-
		     automatic", "/usr/bin/dnf-automatic",     "/bin/pacman",
		     "/usr/bin/pacman", "/usr/bin/dpkg-divert", "/bin/dpkg-divert",
		     "/sbin/apk", "/usr/sbin/apk",     "/usr/local/sbin/apk",
		     "/usr/bin/apt", "/usr/sbin/pacman", "/bin/podman",
		     "/usr/bin/podman", "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/lib/snapd/snapd", "/usr/local/bin/dockerd",
		     "/usr/libexec/platform-python"   ) or   file.extension in
		     ("swp", "swpx", "swx", "dpkg-remove") or
		     file.Ext.original.extension == "dpkg-new" or
		     process.executable : (     "/nix/store/*", "/var/lib/dpkg/*",
		     "/snap/*", "/dev/fd/*", "/usr/lib/virtualbox/*"   ) or
		     process.executable == null or   process.name in ("ssm-agent-
		     worker", "convert2rhel", "platform-python*") or   (process.name
		     == "sed" and file.name : "sed*") or   (process.name == "perl"
		     and file.name : "e2scrub_all.tmp*")  )

NamE: Veeam Backup Library Loaded by Unusual Process
	description: 
		     Identifies potential credential decrypt
		     operations by PowerShell or unsigned processes using the
		     Veeam.Backup.Common.dll library. Attackers can use Veeam
		     Credentials to target backups as part of destructive operations
		     such as Ransomware attacks.
	query: 
		     library where host.os.type == "windows" and
		     event.action == "load" and   (dll.name :
		     "Veeam.Backup.Common.dll" or dll.pe.original_file_name :
		     "Veeam.Backup.Common.dll") and   (
		     process.code_signature.trusted == false or
		     process.code_signature.exists == false or     process.name :
		     ("powershell.exe", "pwsh.exe", "powershell_ise.exe")   )

NamE: Unusual Executable File Creation by a System Critical Process
	description: 
		     Identifies an unexpected executable file being
		     created or modified by a Windows system critical process, which
		     may indicate activity related to remote code execution or other
		     forms of exploitation.
	query: 
		     file where host.os.type == "windows" and event.type !=
		     "deletion" and   file.extension : ("exe", "dll") and
		     process.name : ("smss.exe",                   "autochk.exe",
		     "csrss.exe",                   "wininit.exe",
		     "services.exe",                   "lsass.exe",
		     "winlogon.exe",                   "userinit.exe",
		     "LogonUI.exe")

NamE: CAP_SYS_ADMIN Assigned to Binary
	description: 
		     Identifies instances where a binary is granted
		     the CAP_SYS_ADMIN capability. In Linux, the CAP_SYS_ADMIN
		     capability is a powerful and broad capability that allows a
		     process to perform a range of system administration operations,
		     such as mounting and unmounting filesystems, configuring
		     network interfaces, and accessing hardware devices. Attackers
		     may leverage a misconfiguration for exploitation in order to
		     escalate their privileges to root. The rule identifies
		     previously unknown processes executing with CAP_SYS_ADMIN
		     capabilities through the use of the new terms rule type.
	query: 
		     event.category:"process" and host.os.type:"linux" and
		     event.type:"start" and event.action:"exec" and process.name:*
		     and (process.thread.capabilities.effective:"CAP_SYS_ADMIN" or
		     process.thread.capabilities.permitted:"CAP_SYS_ADMIN") and not
		     user.id:"0"

NamE: AWS IAM Login Profile Added for Root
	description: 
		     Detects when an AWS IAM login profile is added
		     to a root user account and is self-assigned. Adversaries, with
		     temporary access to the root account, may add a login profile
		     to the root user account to maintain access even if the
		     original access key is rotated or disabled.
	query: 
		     from logs-aws.cloudtrail* metadata _id, _version,
		     _index | where     // filter for CloudTrail logs from IAM
		     event.dataset == "aws.cloudtrail"     and event.provider ==
		     "iam.amazonaws.com"      // filter for successful
		     CreateLoginProfile API call     and event.action ==
		     "CreateLoginProfile"     and event.outcome == "success"      //
		     filter for Root member account     and
		     aws.cloudtrail.user_identity.type == "Root"      // filter for
		     an access key existing which sources from AssumeRoot     and
		     aws.cloudtrail.user_identity.access_key_id IS NOT NULL      //
		     filter on the request parameters not including UserName which
		     assumes self-assignment     and NOT
		     TO_LOWER(aws.cloudtrail.request_parameters) LIKE "*username*" |
		     keep     @timestamp,     aws.cloudtrail.request_parameters,
		     aws.cloudtrail.response_elements,
		     aws.cloudtrail.user_identity.type,
		     aws.cloudtrail.user_identity.arn,
		     aws.cloudtrail.user_identity.access_key_id,
		     cloud.account.id,     event.action,     source.address

NamE: Potential Reverse Shell via Java
	description: 
		     This detection rule identifies the execution of
		     a Linux shell process from a Java JAR application post an
		     incoming network connection. This behavior may indicate reverse
		     shell activity via a Java application.
	query: 
		     sequence by host.id with maxspan=5s   [network where
		     host.os.type == "linux" and event.action in
		     ("connection_accepted", "connection_attempted") and
		     process.executable : ("/usr/bin/java", "/bin/java",
		     "/usr/lib/jvm/*", "/usr/java/*") and    not (destination.ip ==
		     null or destination.ip == "0.0.0.0" or cidrmatch(
		     destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16",
		     "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29",
		     "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32",
		     "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24",
		     "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16",
		     "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10",
		     "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24",
		     "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10",
		     "FF00::/8"     )   )] by process.entity_id   [process where
		     host.os.type == "linux" and event.action == "exec" and
		     process.parent.executable : ("/usr/bin/java", "/bin/java",
		     "/usr/lib/jvm/*", "/usr/java/*") and    process.parent.args :
		     "-jar" and process.name in ("bash", "dash", "ash", "sh",
		     "tcsh", "csh", "zsh", "ksh", "fish")    and not
		     process.parent.args in (      "/usr/share/java/jenkins.war",
		     "/etc/remote-iot/services/remoteiot.jar",
		     "/usr/lib64/NetExtender.jar", "/usr/lib/jenkins/jenkins.war"
		     )] by process.parent.entity_id

NamE: Remote Execution via File Shares
	description: 
		     Identifies the execution of a file that was
		     created by the virtual system process. This may indicate
		     lateral movement via network file shares.
	query: 
		     sequence with maxspan=1m   [file where host.os.type ==
		     "windows" and event.type in ("creation", "change") and
		     process.pid == 4 and (file.extension : "exe" or
		     file.Ext.header_bytes : "4d5a*")] by host.id, file.path
		     [process where host.os.type == "windows" and event.type ==
		     "start" and     not (       /* Veeam related processes */
		     (         process.name : (           "VeeamGuestHelper.exe",
		     "VeeamGuestIndexer.exe", "VeeamAgent.exe",
		     "VeeamLogShipper.exe",
		     "Veeam.VSS.Sharepoint20??.exe", "OracleProxy.exe",
		     "Veeam.SQL.Service", "VeeamDeploymentSvc.exe"         ) and
		     process.code_signature.trusted == true and
		     process.code_signature.subject_name : "Veeam Software Group
		     GmbH"       ) or       /* PDQ related processes */       (
		     process.name : (           "PDQInventoryScanner.exe",
		     "PDQInventoryMonitor.exe", "PDQInventory-Scanner-?.exe",
		     "PDQInventoryWakeCommand-?.exe", "PDQDeployRunner-?.exe"
		     ) and process.code_signature.trusted == true and
		     process.code_signature.subject_name : "PDQ.com Corporation"
		     ) or       /* CrowdStrike related processes */       (
		     (process.executable :
		     "?:\\Windows\\System32\\drivers\\CrowdStrike\\*Sensor*.exe" and
		     process.code_signature.trusted == true and
		     process.code_signature.subject_name : "CrowdStrike, Inc.") or
		     (process.executable : "?:\\Windows\\System32\\drivers\\CrowdStr
		     ike\\*-CsInstallerService.exe" and
		     process.code_signature.trusted == true and
		     process.code_signature.subject_name : "Microsoft Windows
		     Hardware Compatibility Publisher")       ) or       /* MS
		     related processes */       (         process.executable ==
		     "System" or         (process.executable :
		     "?:\\Windows\\ccmsetup\\ccmsetup.exe" and
		     process.code_signature.trusted == true and
		     process.code_signature.subject_name : "Microsoft Corporation")
		     ) or       /* CyberArk processes */       (
		     process.executable : "?:\\Windows\\CAInvokerService.exe" and
		     process.code_signature.trusted == true and
		     process.code_signature.subject_name : "CyberArk Software Ltd."
		     )  or       /* Sophos processes */       (
		     process.executable : "?:\\ProgramData\\Sophos\\AutoUpdate\\Cach
		     e\\sophos_autoupdate1.dir\\SophosUpdate.exe" and
		     process.code_signature.trusted == true and
		     process.code_signature.subject_name : "Sophos Ltd"       )  or
		     /* Elastic processes */       (         process.executable : (
		     "?:\\Program Files\\Elastic\\Agent\\data\\elastic-
		     agent-*\\components\\previous\\elastic-endpoint.exe",
		     "?:\\Program Files\\Elastic\\Agent\\data\\elastic-
		     agent-*\\elastic-agent.exe",           "?:\\Program
		     Files\\Elastic\\Agent\\data\\elastic-
		     agent-*\\components\\agentbeat.exe"         ) and
		     process.code_signature.trusted == true and
		     process.code_signature.subject_name : "Elasticsearch, Inc."
		     )      )   ] by host.id, process.executable

NamE: Outbound Scheduled Task Activity via PowerShell
	description: 
		     Identifies the PowerShell process loading the
		     Task Scheduler COM DLL followed by an outbound RPC network
		     connection within a short time period. This may indicate
		     lateral movement or remote discovery via scheduled tasks.
	query: 
		     sequence by host.id, process.entity_id with maxspan =
		     5s  [any where host.os.type == "windows" and (event.category ==
		     "library" or (event.category == "process" and event.action :
		     "Image loaded*")) and   (?dll.name : "taskschd.dll" or
		     file.name : "taskschd.dll") and process.name :
		     ("powershell.exe", "pwsh.exe", "powershell_ise.exe")]  [network
		     where host.os.type == "windows" and process.name :
		     ("powershell.exe", "pwsh.exe", "powershell_ise.exe") and
		     destination.port == 135 and not destination.address in
		     ("127.0.0.1", "::1")]

NamE: Persistence via BITS Job Notify Cmdline
	description: 
		     An adversary can use the Background Intelligent
		     Transfer Service (BITS) SetNotifyCmdLine method to execute a
		     program that runs after a job finishes transferring data or
		     after a job enters a specified state in order to persist on a
		     system.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.name : "svchost.exe" and
		     process.parent.args : "BITS" and   not process.executable :
		     ("?:\\Windows\\System32\\WerFaultSecure.exe",
		     "?:\\Windows\\System32\\WerFault.exe",
		     "?:\\Windows\\System32\\wermgr.exe",
		     "?:\\WINDOWS\\system32\\directxdatabaseupdater.exe")

NamE: Modification of Standard Authentication Module or Configuration
	description: 
		     Adversaries may modify the standard
		     authentication module for persistence via patching the normal
		     authorization process or modifying the login configuration to
		     allow unauthorized access or elevate privileges.
	query: 
		     event.category:file and event.type:change and
		     (file.name:pam_*.so or file.path:(/etc/pam.d/* or
		     /private/etc/pam.d/* or /usr/lib64/security/*)) and
		     process.executable:     (* and       not       (
		     /usr/libexec/packagekitd or         /usr/bin/vim or
		     /usr/libexec/xpcproxy or         /usr/bin/bsdtar or
		     /usr/local/bin/brew or         "/System/Library/PrivateFramewor
		     ks/PackageKit.framework/Versions/A/XPCServices/package_script_s
		     ervice.xpc/Contents/MacOS/package_script_service"       )     )
		     and   not file.path:          (
		     /tmp/snap.rootfs_*/pam_*.so or
		     /tmp/newroot/lib/*/pam_*.so or            /private/var/folders/
		     */T/com.apple.fileprovider.ArchiveService/TemporaryItems/*/lib/
		     security/pam_*.so or
		     /tmp/newroot/usr/lib64/security/pam_*.so          ) and   not
		     process.name:          (            yum or dnf or rsync or
		     platform-python or authconfig or rpm or pdkg or apk or dnf-
		     automatic or btrfs or            dpkg or pam-auth-update or
		     steam or platform-python3.6 or pam-config or microdnf or
		     yum_install or yum-cron or            systemd or containerd or
		     pacman          )

NamE: Potential Remote Credential Access via Registry
	description: 
		     Identifies remote access to the registry to
		     potentially dump credential data from the Security Account
		     Manager (SAM) registry hive in preparation for credential
		     access and privileges elevation.
	query: 
		     file where host.os.type == "windows" and
		     event.action == "creation" and process.name : "svchost.exe" and
		     file.Ext.header_bytes : "72656766*" and user.id :
		     ("S-1-5-21-*", "S-1-12-1-*") and file.size >= 30000 and
		     file.path : ("?:\\Windows\\system32\\*.tmp",
		     "?:\\WINDOWS\\Temp\\*.tmp")

NamE: Unusual Process Execution Path - Alternate Data Stream
	description: 
		     Identifies processes running from an Alternate
		     Data Stream. This is uncommon for legitimate processes and
		     sometimes done by adversaries to hide malware.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.args : "?:\\*:*" and
		     process.args_count == 1

NamE: Potential JAVA/JNDI Exploitation Attempt
	description: 
		     Identifies an outbound network connection by
		     JAVA to LDAP, RMI or DNS standard ports followed by a
		     suspicious JAVA child processes. This may indicate an attempt
		     to exploit a JAVA/NDI (Java Naming and Directory Interface)
		     injection vulnerability.
	query: 
		     sequence by host.id with maxspan=1m  [network where
		     event.action == "connection_attempted" and   process.name :
		     "java" and   /*      outbound connection attempt to      LDAP,
		     RMI or DNS standard ports      by JAVA process    */
		     destination.port in (1389, 389, 1099, 53, 5353)] by process.pid
		     [process where event.type == "start" and    /* Suspicious JAVA
		     child process */   process.parent.name : "java" and
		     process.name : ("sh",                    "bash",
		     "dash",                    "ksh",                    "tcsh",
		     "zsh",                    "curl",                    "perl*",
		     "python*",                    "ruby*",
		     "php*",                    "wget") and     not
		     process.command_line like~ (       "bash -c ulimit -u",
		     "bash /opt/flutter/bin/flutter*",       "bash -c echo $$",
		     "/bin/bash /opt/python3/bin/jira*",       "/bin/sh -c env
		     LC_ALL=C /usr/sbin/lpc status*"     )] by process.parent.pid

NamE: Peripheral Device Discovery
	description: 
		     Identifies use of the Windows file system
		     utility (fsutil.exe) to gather information about attached
		     peripheral devices and components connected to a computer
		     system.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (process.name : "fsutil.exe" or
		     ?process.pe.original_file_name == "fsutil.exe") and
		     process.args : "fsinfo" and process.args : "drives"

NamE: Potential DLL Side-Loading via Trusted Microsoft Programs
	description: 
		     Identifies an instance of a Windows trusted
		     program that is known to be vulnerable to DLL Search Order
		     Hijacking starting after being renamed or from a non-standard
		     path. This is uncommon behavior and may indicate an attempt to
		     evade defenses via side loading a malicious DLL within the
		     memory space of one of those processes.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.pe.original_file_name in
		     ("WinWord.exe", "EXPLORER.EXE", "w3wp.exe", "DISM.EXE") and
		     not (process.name : ("winword.exe", "explorer.exe", "w3wp.exe",
		     "Dism.exe") or          process.executable :
		     ("?:\\Windows\\explorer.exe",
		     "?:\\Program Files\\Microsoft
		     Office\\root\\Office*\\WINWORD.EXE",
		     "?:\\Program Files?(x86)\\Microsoft
		     Office\\root\\Office*\\WINWORD.EXE",
		     "?:\\Windows\\System32\\Dism.exe",
		     "?:\\Windows\\SysWOW64\\Dism.exe",
		     "?:\\Windows\\System32\\inetsrv\\w3wp.exe")          )

NamE: Kernel Object File Creation
	description: 
		     This rule detects the creation of a Linux kernel
		     object file (.ko) on a system. Threat actors may leverage Linux
		     kernel object files to load a rootkit or other type of malware
		     on a system providing them with complete control and the
		     ability to hide from security products.
	query: 
		     event.category:file and host.os.type:linux and
		     event.type:creation and file.extension:ko and not (
		     file.path:/var/tmp/mkinitramfs_* or process.executable:/snap/*
		     or process.name:cpio ) and not file.path:/tmp/mkinitramfs*

NamE: Potential Disabling of SELinux
	description: 
		     Identifies potential attempts to disable
		     Security-Enhanced Linux (SELinux), which is a Linux kernel
		     security feature to support access control policies.
		     Adversaries may disable security tools to avoid possible
		     detection of their tools and activities.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and  event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed", "process_started") and
		     process.name == "setenforce" and process.args == "0"

NamE: Service DACL Modification via sc.exe
	description: 
		     Identifies DACL modifications to deny access to
		     a service, making it unstoppable, or hide it from system and
		     users.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (process.name : "sc.exe" or
		     ?process.pe.original_file_name : "sc.exe") and   process.args :
		     "sdset" and process.args : "*D;*" and   process.args :
		     ("*;IU*", "*;SU*", "*;BA*", "*;SY*", "*;WD*")

NamE: Enumeration Command Spawned via WMIPrvSE
	description: 
		     Identifies native Windows host and network
		     enumeration commands spawned by the Windows Management
		     Instrumentation Provider Service (WMIPrvSE).
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and process.command_line != null and   process.name:
		     (     "arp.exe", "dsquery.exe", "dsget.exe", "gpresult.exe",
		     "hostname.exe", "ipconfig.exe", "nbtstat.exe",     "net.exe",
		     "net1.exe", "netsh.exe", "netstat.exe", "nltest.exe",
		     "ping.exe", "qprocess.exe", "quser.exe",     "qwinsta.exe",
		     "reg.exe", "sc.exe", "systeminfo.exe", "tasklist.exe",
		     "tracert.exe", "whoami.exe"   ) and
		     process.parent.name:"wmiprvse.exe" and   not (     process.name
		     : "sc.exe" and process.args : "RemoteRegistry" and process.args
		     : "start=" and     process.args : ("demand", "disabled")   )
		     and   not process.args : "tenable_mw_scan"

NamE: File Creation in /var/log via Suspicious Process
	description: 
		     This rule detects the creation of files in the
		     /var/log/ directory via process executables located in world-
		     writeable locations or via hidden processes. Attackers may
		     attempt to hide their activities by creating files in the
		     /var/log/ directory, which is commonly used for logging system
		     events.
	query: 
		     event.category:file and host.os.type:linux and
		     event.action:(creation or file_create_event or
		     file_rename_event or rename) and (process.executable:(/tmp/* or
		     /var/tmp/* or /dev/shm/* or ./* or /boot/*) or process.name:.*)
		     and file.path:/var/log/* and not file.extension:*

NamE: Unusual Parent-Child Relationship
	description: 
		     Identifies Windows programs run from unexpected
		     parent processes. This could indicate masquerading or other
		     strange activity on a system.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and process.parent.name != null and  (    /*
		     suspicious parent processes */    (process.name:"autochk.exe"
		     and not process.parent.name:"smss.exe") or
		     (process.name:("fontdrvhost.exe", "dwm.exe") and not
		     process.parent.name:("wininit.exe", "winlogon.exe")) or
		     (process.name:("consent.exe", "RuntimeBroker.exe",
		     "TiWorker.exe") and not process.parent.name:"svchost.exe") or
		     (process.name:"SearchIndexer.exe" and not
		     process.parent.name:"services.exe") or
		     (process.name:"SearchProtocolHost.exe" and not
		     process.parent.name:("SearchIndexer.exe", "dllhost.exe")) or
		     (process.name:"dllhost.exe" and not
		     process.parent.name:("services.exe", "svchost.exe")) or
		     (process.name:"smss.exe" and not process.parent.name:("System",
		     "smss.exe")) or    (process.name:"csrss.exe" and not
		     process.parent.name:("smss.exe", "svchost.exe")) or
		     (process.name:"wininit.exe" and not
		     process.parent.name:"smss.exe") or
		     (process.name:"winlogon.exe" and not
		     process.parent.name:"smss.exe") or
		     (process.name:("lsass.exe", "LsaIso.exe") and not
		     process.parent.name:"wininit.exe") or
		     (process.name:"LogonUI.exe" and not
		     process.parent.name:("wininit.exe", "winlogon.exe")) or
		     (process.name:"services.exe" and not
		     process.parent.name:"wininit.exe") or
		     (process.name:"svchost.exe" and not
		     process.parent.name:("MsMpEng.exe", "services.exe",
		     "svchost.exe")) or    (process.name:"spoolsv.exe" and not
		     process.parent.name:"services.exe") or
		     (process.name:"taskhost.exe" and not
		     process.parent.name:("services.exe", "svchost.exe",
		     "ngentask.exe")) or    (process.name:"taskhostw.exe" and not
		     process.parent.name:("services.exe", "svchost.exe")) or
		     (process.name:"userinit.exe" and not
		     process.parent.name:("dwm.exe", "winlogon.exe")) or
		     (process.name:("wmiprvse.exe", "wsmprovhost.exe",
		     "winrshost.exe") and not process.parent.name:"svchost.exe") or
		     /* suspicious child processes */
		     (process.parent.name:("SearchProtocolHost.exe", "taskhost.exe",
		     "csrss.exe") and not process.name:("werfault.exe",
		     "wermgr.exe", "WerFaultSecure.exe", "conhost.exe")) or
		     (process.parent.name:"autochk.exe" and not
		     process.name:("chkdsk.exe", "doskey.exe", "WerFault.exe")) or
		     (process.parent.name:"smss.exe" and not
		     process.name:("autochk.exe", "smss.exe", "csrss.exe",
		     "wininit.exe", "winlogon.exe", "setupcl.exe", "WerFault.exe"))
		     or    (process.parent.name:"wermgr.exe" and not
		     process.name:("WerFaultSecure.exe", "wermgr.exe",
		     "WerFault.exe")) or    (process.parent.name:"conhost.exe" and
		     not process.name:("mscorsvw.exe", "wermgr.exe", "WerFault.exe",
		     "WerFaultSecure.exe"))   )

NamE: Abnormal Process ID or Lock File Created
	description: 
		     Identifies the creation of a Process ID (PID),
		     lock or reboot file created in temporary file storage paradigm
		     (tmpfs) directory /var/run. On Linux, the PID files typically
		     hold the process ID to track previous copies running and manage
		     other tasks. Certain Linux malware use the /var/run directory
		     for holding data, executables and other tasks, disguising
		     itself or these files as legitimate PID files.
	query: 
		     host.os.type:linux and event.category:file and
		     event.action:(creation or file_create_event) and
		     file.extension:(pid or lock or reboot) and
		     file.path:(/var/run/* or /run/*) and (   (process.name : (
		     bash or dash or sh or tcsh or csh or zsh or ksh or fish or ash
		     or touch or nano or vim or vi or editor or mv or cp)   ) or (
		     process.executable : (     ./* or /tmp/* or /var/tmp/* or
		     /dev/shm/* or /var/run/* or /boot/* or /srv/* or /run/*   )) )
		     and not (   process.executable : (   /tmp/newroot/* or
		     /run/containerd/* or /run/k3s/containerd/* or
		     /run/k0s/container* or /snap/* or /vz/* or   /var/lib/docker/*
		     or /etc/*/universal-hooks/pkgs/mysql-community-server/* or
		     /var/lib/snapd/* or /etc/rubrik/* or   /run/udev/data/*   ) or
		     process.name : (     go or git or containerd* or snap-confine
		     or cron or crond or sshd or unattended-upgrade or vzctl or ifup
		     or     rpcbind or runc or gitlab-runner-helper or elastic-agent
		     or metricbeat or redis-server or libvirt_leaseshelper or
		     s6-ipcserver-socketbinder or xinetd or libvirtd or
		     veeamdeploymentsvc  or dnsmasq or virtlogd or lynis or
		     veeamtransport   ) or   file.name : (     jem.*.pid or
		     lynis.pid or redis.pid or yum.pid or MFS.pid or jenkins.pid or
		     nvmupdate.pid or openlitespeed.pid or     rhnsd.pid   ) or
		     file.path : (/run/containerd/* or /var/run/docker/containerd/*
		     or /var/run/jem*.pid) )

NamE: Potential Persistence via Atom Init Script Modification
	description: 
		     Identifies modifications to the Atom desktop
		     text editor Init File. Adversaries may add malicious JavaScript
		     code to the init.coffee file that will be executed upon the
		     Atom application opening.
	query: 
		     event.category:file and host.os.type:macos and not
		     event.type:"deletion" and  file.path:/Users/*/.atom/init.coffee
		     and not process.name:(Atom or xpcproxy) and not user.name:root

NamE: External IP Lookup from Non-Browser Process
	description: 
		     Identifies domains commonly used by adversaries
		     for post-exploitation IP lookups. It is common for adversaries
		     to test for Internet access and acquire their external IP
		     address after they have gained access to a system. Among
		     others, this has been observed in campaigns leveraging the
		     information stealer, Trickbot.
	query: 
		     network where host.os.type == "windows" and
		     network.protocol == "dns" and     process.name != null and
		     user.id not in ("S-1-5-19", "S-1-5-20") and     event.action ==
		     "lookup_requested" and     /* Add new external IP lookup
		     services here */     dns.question.name :     (
		     "*api.ipify.org",         "*freegeoip.app",
		     "*checkip.amazonaws.com",         "*checkip.dyndns.org",
		     "*freegeoip.app",         "*icanhazip.com",
		     "*ifconfig.*",         "*ipecho.net",         "*ipgeoapi.com",
		     "*ipinfo.io",         "*ip.anysrc.net",
		     "*myexternalip.com",         "*myipaddress.com",
		     "*showipaddress.com",         "*whatismyipaddress.com",
		     "*wtfismyip.com",         "*ipapi.co",         "*ip-
		     lookup.net",         "*ipstack.com"     ) and     /* Insert
		     noisy false positives here */     not     (       (
		     process.executable : (             "?:\\Program Files\\*.exe",
		     "?:\\Program Files (x86)\\*.exe",
		     "?:\\Windows\\Prey\\versions\\*\\bin\\node.exe",
		     "?:\\Windows\\System32\\WWAHost.exe",
		     "?:\\Windows\\System32\\smartscreen.exe",
		     "?:\\Windows\\System32\\MicrosoftEdgeCP.exe",
		     "?:\\ProgramData\\Microsoft\\Windows
		     Defender\\Platform\\*\\MsMpEng.exe",             "?:\\Users\\*\
		     \AppData\\Local\\Google\\Chrome\\Application\\chrome.exe",
		     "?:\\Users\\*\\AppData\\Local\\Programs\\Fiddler\\Fiddler.exe",
		     "?:\\Users\\*\\AppData\\Local\\Programs\\Microsoft VS
		     Code\\Code.exe",             "?:\\Users\\*\\AppData\\Local\\Mic
		     rosoft\\OneDrive\\OneDrive.exe"         ) and
		     process.code_signature.trusted == true       ) or       (
		     (process.name : "Evernote.exe" and
		     process.code_signature.subject_name : "Evernote Corporation"
		     and process.code_signature.trusted == true) or
		     (process.name : "firefox.exe" and
		     process.code_signature.subject_name : "Mozilla Corporation" and
		     process.code_signature.trusted == true) or
		     (process.name : "Loom.exe" and
		     process.code_signature.subject_name : "Loom, Inc." and
		     process.code_signature.trusted == true) or
		     (process.name : "opera.exe" and
		     process.code_signature.subject_name : "Opera Norway AS" and
		     process.code_signature.trusted == true) or
		     (process.name : "brave.exe" and
		     process.code_signature.subject_name : "Brave Software, Inc."
		     and process.code_signature.trusted == true) or
		     (process.name : "vivaldi.exe" and
		     process.code_signature.subject_name : "Vivaldi Technologies AS"
		     and process.code_signature.trusted == true)       )     )

NamE: Pluggable Authentication Module (PAM) Version Discovery
	description: 
		     This rule detects PAM version discovery activity
		     on Linux systems. PAM version discovery can be an indication of
		     an attacker attempting to backdoor the authentication process
		     through malicious PAM modules.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2") and process.parent.name != null and
		     (     (process.name in ("dpkg", "dpkg-query") and process.args
		     == "libpam-modules") or     (process.name == "rpm" and
		     process.args == "pam")   ) and not process.parent.name in
		     ("dcservice", "inspectorssmplugin")

NamE: Remote Desktop Enabled in Windows Firewall by Netsh
	description: 
		     Identifies use of the network shell utility
		     (netsh.exe) to enable inbound Remote Desktop Protocol (RDP)
		     connections in the Windows Firewall.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  (process.name : "netsh.exe" or
		     ?process.pe.original_file_name == "netsh.exe") and
		     process.args : ("localport=3389", "RemoteDesktop",
		     "group=\"remote desktop\"") and  process.args :
		     ("action=allow", "enable=Yes", "enable")

NamE: Suspicious Proc Pseudo File System Enumeration
	description: 
		     This rule monitors for a rapid enumeration of 25
		     different proc cmd, stat, and exe files, which suggests an
		     abnormal activity pattern. Such behavior could be an indicator
		     of a malicious process scanning or gathering information about
		     running processes, potentially for reconnaissance, privilege
		     escalation, or identifying vulnerable targets.
	query: 
		     host.os.type:linux and event.category:file and
		     event.action:"opened-file" and  file.path : (/proc/*/cmdline or
		     /proc/*/stat or /proc/*/exe) and not process.name : (   ps or
		     netstat or landscape-sysin or w or pgrep or pidof or
		     needrestart or apparmor_status ) and not process.parent.pid : 1

NamE: Dynamic Linker Creation or Modification
	description: 
		     Detects the creation or modification of files
		     related to the dynamic linker on Linux systems. The dynamic
		     linker is a shared library that is used by the Linux kernel to
		     load and execute programs. Attackers may attempt to hijack the
		     execution flow of a program by modifying the dynamic linker
		     configuration files.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("creation", "rename") and file.path : ("/etc/ld.so.preload",
		     "/etc/ld.so.conf.d/*", "/etc/ld.so.conf") and not (
		     process.executable in (     "/bin/dpkg", "/usr/bin/dpkg",
		     "/bin/dockerd", "/usr/bin/dockerd", "/usr/sbin/dockerd",
		     "/bin/microdnf",     "/usr/bin/microdnf", "/bin/rpm",
		     "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd", "/bin/yum",
		     "/usr/bin/yum",     "/bin/dnf", "/usr/bin/dnf", "/bin/podman",
		     "/usr/bin/podman", "/bin/dnf-automatic", "/usr/bin/dnf-
		     automatic",     "/bin/pacman", "/usr/bin/pacman",
		     "/usr/bin/dpkg-divert", "/bin/dpkg-divert", "/sbin/apk",
		     "/usr/sbin/apk",     "/usr/local/sbin/apk", "/usr/bin/apt",
		     "/usr/sbin/pacman", "/bin/podman", "/usr/bin/podman",
		     "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/lib/snapd/snapd", "/usr/local/bin/dockerd",
		     "/usr/libexec/platform-python",     "/usr/lib/snapd/snap-
		     update-ns", "/usr/bin/vmware-config-tools.pl"   ) or
		     file.extension in ("swp", "swpx", "swx", "dpkg-remove") or
		     file.Ext.original.extension == "dpkg-new" or
		     process.executable : (     "/nix/store/*", "/var/lib/dpkg/*",
		     "/snap/*", "/dev/fd/*", "/usr/lib/virtualbox/*",
		     "/opt/dynatrace/oneagent/*"   ) or   process.executable == null
		     or   process.name in (     "java", "executor", "ssm-agent-
		     worker", "packagekitd", "crio", "dockerd-entrypoint.sh",
		     "docker-init", "BootTimeChecker"   ) or   (process.name ==
		     "sed" and file.name : "sed*") or   (process.name == "perl" and
		     file.name : "e2scrub_all.tmp*") )

NamE: Potential Defense Evasion via CMSTP.exe
	description: 
		     The Microsoft Connection Manager Profile
		     Installer (CMSTP.exe) is a command-line program to install
		     Connection Manager service profiles, which accept installation
		     information file (INF) files. Adversaries may abuse CMSTP to
		     proxy the execution of malicious code by supplying INF files
		     that contain malicious commands.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : "cmstp.exe" and process.args ==
		     "/s"

NamE: Microsoft Build Engine Started by a System Process
	description: 
		     An instance of MSBuild, the Microsoft Build
		     Engine, was started by Explorer or the WMI (Windows Management
		     Instrumentation) subsystem. This behavior is unusual and is
		     sometimes used by malicious payloads.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : "MSBuild.exe" and
		     process.parent.name : ("explorer.exe", "wmiprvse.exe")

NamE: Suspicious Outlook Child Process
	description: 
		     Identifies suspicious child processes spawned by
		     MS Outlook, which can indicate a potential masquerading or the
		     exploitation of a vulnerability on the application causing it
		     to execute code.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.name : "outlook.exe" and   not
		     (     (       process.executable : (         "?:\\Program
		     Files\\*",         "?:\\Program Files (x86)\\*",
		     "?:\\Windows\\System32\\WerFault.exe",
		     "?:\\Windows\\SysWOW64\\WerFault.exe",
		     "?:\\Windows\\system32\\wermgr.exe",         "?:\\Users\\*\\App
		     Data\\Local\\Microsoft\\Teams\\current\\Teams.exe",         "?:
		     \\Users\\*\\AppData\\Local\\Temp\\NewOutlookInstall\\NewOutlook
		     Installer.exe",         "?:\\Users\\*\\AppData\\Local\\Google\\
		     Chrome\\Application\\chrome.exe",         "?:\\Users\\*\\AppDat
		     a\\Local\\Island\\Island\\Application\\Island.exe",
		     "?:\\Users\\*\\AppData\\Local\\Mozilla Firefox\\firefox.exe",
		     "?:\\Users\\*\\AppData\\Roaming\\Zoom\\bin\\Zoom.exe",
		     "?:\\Windows\\System32\\IME\\SHARED\\IMEWDBLD.EXE",
		     "?:\\Windows\\System32\\spool\\drivers\\x64\\*",
		     "?:\\Windows\\System32\\prevhost.exe",
		     "?:\\Windows\\System32\\dwwin.exe",
		     "?:\\Windows\\System32\\mspaint.exe",
		     "?:\\Windows\\SysWOW64\\mspaint.exe",
		     "?:\\Windows\\System32\\notepad.exe",
		     "?:\\Windows\\SysWOW64\\notepad.exe",
		     "?:\\Windows\\System32\\smartscreen.exe",
		     "?:\\Windows\\explorer.exe",
		     "?:\\Windows\\splwow64.exe"       ) and
		     process.code_signature.trusted == true       ) or     (
		     process.name : "rundll32.exe" and       process.args :
		     "*hpmsn???.dll,MonitorPrintJobStatus*"     )   )

NamE: Disable Windows Firewall Rules via Netsh
	description: 
		     Identifies use of the netsh.exe to disable or
		     weaken the local firewall. Attackers will use this command line
		     tool to disable the firewall during troubleshooting or to
		     enable network mobility.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : "netsh.exe" and   (
		     (process.args : "disable" and process.args : "firewall" and
		     process.args : "set") or     (process.args : "advfirewall" and
		     process.args : "off" and process.args : "state")   )

NamE: High Number of Process and/or Service Terminations
	description: 
		     This rule identifies a high number (10) of
		     process terminations (stop, delete, or suspend) from the same
		     host within a short time period.
	query: 
		     event.category:process and host.os.type:windows and
		     event.type:start and process.name:(net.exe or sc.exe or
		     taskkill.exe) and  process.args:(stop or pause or delete or
		     "/PID" or "/IM" or "/T" or "/F" or "/t" or "/f" or "/im" or
		     "/pid") and  not process.parent.name:osquerybeat.exe

NamE: Potential Persistence via Periodic Tasks
	description: 
		     Identifies the creation or modification of the
		     default configuration for periodic tasks. Adversaries may abuse
		     periodic tasks to execute malicious code or maintain
		     persistence.
	query: 
		     event.category:file and host.os.type:macos and not
		     event.type:"deletion" and  file.path:(/private/etc/periodic/*
		     or /private/etc/defaults/periodic.conf or
		     /private/etc/periodic.conf)

NamE: Unusual Pkexec Execution
	description: 
		     This rule detects the execution of the `pkexec`
		     command by a shell process. The `pkexec` command is used to
		     execute programs as another user, typically as the superuser.
		     Through the `new_terms` rule type, unusual executions of
		     `pkexec` are identified, and may indicate an attempt to
		     escalate privileges or perform unauthorized actions on the
		     system.
	query: 
		     event.category:process and host.os.type:linux and
		     event.type:start and event.action:(exec or exec_event or start
		     or ProcessRollup2) and process.name:pkexec and
		     process.args:pkexec and process.parent.name:(bash or dash or sh
		     or tcsh or csh or zsh or ksh or fish)

NamE: AWS SSM `SendCommand` with Run Shell Command Parameters
	description: 
		     Identifies the use of the AWS Systems Manager
		     (SSM) `SendCommand` API with the either `AWS-RunShellScript` or
		     `AWS-RunPowerShellScript` parameters. The `SendCommand` API
		     call allows users to execute commands on EC2 instances using
		     the SSM service. Adversaries may use this technique to execute
		     commands on EC2 instances without the need for SSH or RDP
		     access. This behavior may indicate an adversary attempting to
		     execute commands on an EC2 instance for malicious purposes.
		     This is a [New
		     Terms](https://www.elastic.co/guide/en/security/current/rules-
		     ui-create.html#create-new-terms-rule) rule that only flags when
		     this behavior is observed for the first time on a host in the
		     last 7 days.
	query: 
		     event.category: "process" and event.type: "start" and
		     process.name: "aws" and (     host.os.type: ("windows" or
		     "macos")     or (         host.os.type: "linux"         and
		     event.action: ("exec" or "exec_event" or "executed" or
		     "process_started")     ) ) and process.args: (     "send-
		     command" and "--parameters" and commands=*     and ("AWS-
		     RunShellScript" or "AWS-RunPowerShellScript") )

NamE: AWS Route 53 Domain Transferred to Another Account
	description: 
		     Identifies when a request has been made to
		     transfer a Route 53 domain to another AWS account.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:route53.amazonaws.com and
		     event.action:TransferDomainToAnotherAwsAccount and
		     event.outcome:success

NamE: First Occurrence of Okta User Session Started via Proxy
	description: 
		     Identifies the first occurrence of an Okta user
		     session started via a proxy.
	query: 
		     event.dataset:okta.system and okta.event_type:
		     (user.session.start or user.authentication.verify) and
		     okta.security_context.is_proxy:true and not okta.actor.id:
		     okta*

NamE: Multiple Vault Web Credentials Read
	description: 
		     Windows Credential Manager allows you to create,
		     view, or delete saved credentials for signing into websites,
		     connected applications, and networks. An adversary may abuse
		     this to list or dump credentials stored in the Credential
		     Manager for saved usernames and passwords. This may also be
		     performed in preparation of lateral movement.
	query: 
		     sequence by winlog.computer_name, winlog.process.pid
		     with maxspan=1s   /* 2 consecutive vault reads from same pid
		     for web creds */   [any where event.code : "5382" and
		     (winlog.event_data.SchemaFriendlyName : "Windows Web Password
		     Credential" and winlog.event_data.Resource : "http*") and   not
		     winlog.event_data.SubjectLogonId : "0x3e7" and   not
		     winlog.event_data.Resource : "http://localhost/"]   [any where
		     event.code : "5382" and   (winlog.event_data.SchemaFriendlyName
		     : "Windows Web Password Credential" and
		     winlog.event_data.Resource : "http*") and   not
		     winlog.event_data.SubjectLogonId : "0x3e7" and   not
		     winlog.event_data.Resource : "http://localhost/"]

NamE: Potential Relay Attack against a Domain Controller
	description: 
		     Identifies potential relay attacks against a
		     domain controller (DC) by identifying authentication events
		     using the domain controller computer account coming from other
		     hosts to the DC that owns the account. Attackers may relay the
		     DC hash after capturing it using forced authentication.
	query: 
		     authentication where host.os.type == "windows" and
		     event.code in ("4624", "4625") and endswith~(user.name, "$")
		     and     winlog.event_data.AuthenticationPackageName : "NTLM"
		     and winlog.logon.type : "network" and      /* Filter for a
		     machine account that matches the hostname */
		     startswith~(host.name, substring(user.name, 0, -1)) and      /*
		     Verify if the Source IP belongs to the host */     not
		     endswith(string(source.ip), string(host.ip)) and     source.ip
		     != null and source.ip != "::1" and source.ip != "127.0.0.1"

NamE: Startup/Logon Script added to Group Policy Object
	description: 
		     Detects the modification of Group Policy Objects
		     (GPO) to add a startup/logon script to users or computer
		     objects.
	query: 
		     any where host.os.type == "windows" and event.code in
		     ("5136", "5145") and (   (
		     winlog.event_data.AttributeLDAPDisplayName : (
		     "gPCMachineExtensionNames",       "gPCUserExtensionNames"     )
		     and     winlog.event_data.AttributeValue :
		     "*42B5FAAE-6536-11D2-AE5A-0000F87571E3*" and
		     winlog.event_data.AttributeValue : (
		     "*40B66650-4972-11D1-A7CA-0000F87571E3*",
		     "*40B6664F-4972-11D1-A7CA-0000F87571E3*"     )   ) or   (
		     winlog.event_data.ShareName : "\\\\*\\SYSVOL" and
		     winlog.event_data.RelativeTargetName : ("*\\scripts.ini",
		     "*\\psscripts.ini") and
		     winlog.event_data.AccessList:"*%%4417*"   ) )

NamE: Deprecated - SSH Authorized Keys File Modified Inside a Container
	description: 
		     This rule detects the creation or modification
		     of an authorized_keys or sshd_config file inside a container.
		     The Secure Shell (SSH) authorized_keys file specifies which
		     users are allowed to log into a server using public key
		     authentication. Adversaries may modify it to maintain
		     persistence on a victim host by adding their own public key(s).
		     Unexpected and unauthorized SSH usage inside a container can be
		     an indicator of compromise and should be investigated.
	query: 
		     file where container.id:"*" and   event.type in
		     ("change", "creation") and file.name: ("authorized_keys",
		     "authorized_keys2", "sshd_config")

NamE: Potential Reverse Shell via Suspicious Child Process
	description: 
		     This detection rule detects the creation of a
		     shell through a suspicious process chain. Any reverse shells
		     spawned by the specified utilities that are initialized from a
		     single process followed by a network connection attempt will be
		     captured through this rule. Attackers may spawn reverse shells
		     to establish persistence onto a target system.
	query: 
		     sequence by host.id, process.entity_id with maxspan=1s
		     [process where host.os.type == "linux" and event.type ==
		     "start" and event.action in ("exec", "fork") and (
		     (process.name : "python*" and process.args : "-c" and
		     process.args : (      "*import*pty*spawn*",
		     "*import*subprocess*call*"     )) or     (process.name :
		     "perl*" and process.args : "-e" and process.args : "*socket*"
		     and process.args : (      "*exec*", "*system*"     )) or
		     (process.name : "ruby*" and process.args : ("-e", "-rsocket")
		     and process.args : (      "*TCPSocket.new*", "*TCPSocket.open*"
		     )) or     (process.name : "lua*" and process.args : "-e" and
		     process.args : "*socket.tcp*" and process.args : (
		     "*io.popen*", "*os.execute*"     )) or     (process.name :
		     "php*" and process.args : "-r" and process.args : "*fsockopen*"
		     and process.args : "*/bin/*sh*") or     (process.name : ("awk",
		     "gawk", "mawk", "nawk") and process.args : "*/inet/tcp/*") or
		     (process.name : "openssl" and process.args : "-connect") or
		     (process.name : ("nc", "ncat", "netcat") and process.args ==
		     "-e" and process.args_count >= 3 and      not process.args ==
		     "-z") or     (process.name : "telnet" and process.args_count >=
		     3)   ) and process.parent.name : (     "bash", "dash", "sh",
		     "tcsh", "csh", "zsh", "ksh", "fish", "python*", "php*", "perl",
		     "ruby", "lua*",     "openssl", "nc", "netcat", "ncat",
		     "telnet", "awk")]   [network where host.os.type == "linux" and
		     event.type == "start" and event.action in
		     ("connection_attempted", "connection_accepted") and
		     process.name : ("python*", "php*", "perl", "ruby", "lua*",
		     "openssl", "nc", "netcat", "ncat", "telnet", "awk") and
		     destination.ip != null and not cidrmatch(destination.ip,
		     "127.0.0.0/8", "169.254.0.0/16", "224.0.0.0/4", "::1")]

NamE: Active Directory Forced Authentication from Linux Host - SMB Named Pipes
	description: 
		     Identifies a potential forced authentication
		     using related SMB named pipes. Attackers may attempt to force
		     targets to authenticate to a host controlled by them to capture
		     hashes or enable relay attacks.
	query: 
		     sequence with maxspan=15s [network where host.os.type
		     == "linux" and event.action == "connection_attempted" and
		     destination.port == 445 and not
		     startswith~(string(destination.ip), string(host.ip))] by
		     host.ip, data_stream.namespace [file where host.os.type ==
		     "windows" and event.code == "5145" and file.name : ("Spoolss",
		     "netdfs", "lsarpc", "lsass", "netlogon", "samr", "efsrpc",
		     "FssagentRpc")] by source.ip, data_stream.namespace

NamE: Mimikatz Memssp Log File Detected
	description: 
		     Identifies the password log file from the
		     default Mimikatz memssp module.
	query: 
		     file where host.os.type == "windows" and file.name :
		     "mimilsa.log" and process.name : "lsass.exe"

NamE: Azure Automation Runbook Deleted
	description: 
		     Identifies when an Azure Automation runbook is
		     deleted. An adversary may delete an Azure Automation runbook in
		     order to disrupt their target's automated business operations
		     or to remove a malicious runbook for defense evasion.
	query: 
		     event.dataset:azure.activitylogs and     azure.activit
		     ylogs.operation_name:"MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/R
		     UNBOOKS/DELETE" and     event.outcome:(Success or success)

NamE: AWS RDS DB Instance Restored
	description: 
		     An adversary with a set of compromised
		     credentials may attempt to make copies of running or deleted
		     RDS databases in order to evade defense mechanisms or access
		     data. This rule identifies successful attempts to restore a DB
		     instance using the RDS `RestoreDBInstanceFromDBSnapshot` or
		     `RestoreDBInstanceFromS3` API operations.
	query: 
		     any where event.dataset == "aws.cloudtrail"     and
		     event.provider == "rds.amazonaws.com"     and event.action in
		     ("RestoreDBInstanceFromDBSnapshot", "RestoreDBInstanceFromS3")
		     and event.outcome == "success"

NamE: Potential Execution of rc.local Script
	description: 
		     This rule detects the potential execution of the
		     `/etc/rc.local` script through the `already_running` event
		     action created by the `rc-local.service` systemd service. The
		     `/etc/rc.local` script is a legacy initialization script that
		     is executed at the end of the boot process. The `/etc/rc.local`
		     script is not enabled by default on most Linux distributions.
		     The `/etc/rc.local` script can be used by attackers to
		     persistently execute malicious commands or scripts on a
		     compromised system at reboot. As the rc.local file is executed
		     prior to the initialization of Elastic Defend, the execution
		     event is not ingested, and therefore the `already_running`
		     event is leveraged to provide insight into the potential
		     execution of `rc.local`.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "info" and event.action == "already_running" and
		     process.parent.args == "/etc/rc.local" and process.parent.args
		     == "start"

NamE: Potential SharpRDP Behavior
	description: 
		     Identifies potential behavior of SharpRDP, which
		     is a tool that can be used to perform authenticated command
		     execution against a remote target via Remote Desktop Protocol
		     (RDP) for the purposes of lateral movement.
	query: 
		     /* Incoming RDP followed by a new RunMRU string value
		     set to cmd, powershell, taskmgr or tsclient, followed by
		     process execution within 1m */  sequence by host.id with
		     maxspan=1m   [network where host.os.type == "windows" and
		     event.type == "start" and process.name : "svchost.exe" and
		     destination.port == 3389 and    network.direction :
		     ("incoming", "ingress") and network.transport == "tcp" and
		     source.ip != "127.0.0.1" and source.ip != "::1"   ]
		     [registry where host.os.type == "windows" and event.type ==
		     "change" and process.name : "explorer.exe" and    registry.path
		     : ("HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion
		     \\Explorer\\RunMRU\\*") and    registry.data.strings :
		     ("cmd.exe*", "powershell.exe*", "taskmgr*",
		     "\\\\tsclient\\*.exe\\*")   ]    [process where host.os.type ==
		     "windows" and event.type == "start" and    (process.parent.name
		     : ("cmd.exe", "powershell.exe", "taskmgr.exe") or process.args
		     : ("\\\\tsclient\\*.exe")) and    not process.name :
		     "conhost.exe"    ]

NamE: Persistent Scripts in the Startup Directory
	description: 
		     Identifies script engines creating files in the
		     Startup folder, or the creation of script files in the Startup
		     folder. Adversaries may abuse this technique to maintain
		     persistence in an environment.
	query: 
		     file where host.os.type == "windows" and event.type !=
		     "deletion" and    /* Call attention to file extensions that may
		     be used for malicious purposes */   /* Optionally, Windows
		     scripting engine processes targeting shortcut files */   (
		     file.extension : ("vbs", "vbe", "wsh", "wsf", "js") or
		     process.name : ("wscript.exe", "cscript.exe")   ) and not
		     (startsWith(user.domain, "NT") or endsWith(user.domain, "NT"))
		     /* Identify files created or changed in the startup folder */
		     and file.path : (
		     "?:\\Users\\*\\AppData\\Roaming\\Microsoft\\Windows\\Start
		     Menu\\Programs\\Startup\\*",
		     "?:\\ProgramData\\Microsoft\\Windows\\Start
		     Menu\\Programs\\StartUp\\*")

NamE: Potential Privilege Escalation via InstallerFileTakeOver
	description: 
		     Identifies a potential exploitation of
		     InstallerTakeOver (CVE-2021-41379) default PoC execution.
		     Successful exploitation allows an unprivileged user to escalate
		     privileges to SYSTEM.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and     process.Ext.token.integrity_level_name :
		     "System" and     (       (process.name :
		     "elevation_service.exe" and        not
		     process.pe.original_file_name == "elevation_service.exe") or
		     (process.name : "elevation_service.exe" and        not
		     process.code_signature.trusted == true) or
		     (process.parent.name : "elevation_service.exe" and
		     process.name : ("rundll32.exe", "cmd.exe", "powershell.exe"))
		     ) and     not     (       process.name :
		     "elevation_service.exe" and process.code_signature.trusted ==
		     true and       process.pe.original_file_name == null     )

NamE: Pluggable Authentication Module (PAM) Source Download
	description: 
		     This rule detects the usage of `curl` or `wget`
		     to download the source code of a Pluggable Authentication
		     Module (PAM) shared object file. Attackers may download the
		     source code of a PAM shared object file to create a backdoor in
		     the authentication process.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event") and
		     process.name in ("curl", "wget") and process.args like~
		     "https://github.com/linux-pam/linux-
		     pam/releases/download/v*/Linux-PAM-*.tar.xz"

NamE: Unusual Network Connection via RunDLL32
	description: 
		     Identifies unusual instances of rundll32.exe
		     making outbound network connections. This may indicate
		     adversarial Command and Control activity.
	query: 
		     sequence by host.id, process.entity_id with maxspan=1m
		     [process where host.os.type == "windows" and event.type ==
		     "start" and process.name : "rundll32.exe" and
		     process.args_count == 1]   [network where host.os.type ==
		     "windows" and process.name : "rundll32.exe" and    not
		     cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8",
		     "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24",
		     "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32",
		     "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32",
		     "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24",
		     "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4",
		     "100.64.0.0/10", "192.175.48.0/24","198.18.0.0/15",
		     "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1",
		     "FE80::/10", "FF00::/8")]

NamE: Potential Local NTLM Relay via HTTP
	description: 
		     Identifies attempt to coerce a local NTLM
		     authentication via HTTP using the Windows Printer Spooler
		     service as a target. An adversary may use this primitive in
		     combination with other techniques to elevate privileges on a
		     compromised system.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : "rundll32.exe" and    /*
		     Rundll32 WbeDav Client  */   process.args :
		     ("?:\\Windows\\System32\\davclnt.dll,DavSetCookie",
		     "?:\\Windows\\SysWOW64\\davclnt.dll,DavSetCookie") and    /*
		     Access to named pipe via http */   process.args :
		     ("http*/print/pipe/*", "http*/pipe/spoolss",
		     "http*/pipe/srvsvc")

NamE: Suspicious Execution via Microsoft Office Add-Ins
	description: 
		     Identifies execution of common Microsoft Office
		     applications to launch an Office Add-In from a suspicious path
		     or with an unusual parent process. This may indicate an attempt
		     to get initial access via a malicious phishing MS Office Add-
		     In.
	query: 
		     process where      host.os.type == "windows" and
		     event.type == "start" and      process.name : ("WINWORD.EXE",
		     "EXCEL.EXE", "POWERPNT.EXE", "MSACCESS.EXE",
		     "VSTOInstaller.exe") and      process.args regex~
		     """.+\.(wll|xll|ppa|ppam|xla|xlam|vsto)""" and      /* Office
		     Add-In from suspicious paths */     (process.args :
		     ("?:\\Users\\*\\Temp\\7z*",
		     "?:\\Users\\*\\Temp\\Rar$*",
		     "?:\\Users\\*\\Temp\\Temp?_*",
		     "?:\\Users\\*\\Temp\\BNZ.*",
		     "?:\\Users\\*\\Downloads\\*",
		     "?:\\Users\\*\\AppData\\Roaming\\*",
		     "?:\\Users\\Public\\*",               "?:\\ProgramData\\*",
		     "?:\\Windows\\Temp\\*",               "\\Device\\*",
		     "http*") or      process.parent.name : ("explorer.exe",
		     "OpenWith.exe") or      /* Office Add-In from suspicious parent
		     */     process.parent.name : ("cmd.exe", "powershell.exe")) and
		     /* False Positives */     not (process.args : "*.vsto" and
		     process.parent.executable :                    ("?:\\Program
		     Files\\Logitech\\LogiOptions\\PlugInInstallerUtility*.exe",
		     "?:\\ProgramData\\Logishrd\\LogiOptions\\Plugins\\VSTO\\*\\VSTO
		     Installer.exe",                     "?:\\Program
		     Files\\Logitech\\LogiOptions\\PlugInInstallerUtility.exe",
		     "?:\\Program
		     Files\\LogiOptionsPlus\\PlugInInstallerUtility*.exe",
		     "?:\\ProgramData\\Logishrd\\LogiOptionsPlus\\Plugins\\VSTO\\*\\
		     VSTOInstaller.exe",                     "?:\\Program
		     Files\\Common Files\\microsoft
		     shared\\VSTO\\*\\VSTOInstaller.exe")) and     not (process.args
		     : "/Uninstall" and process.name : "VSTOInstaller.exe") and
		     not (process.parent.name : "rundll32.exe" and
		     process.parent.args : "?:\\WINDOWS\\Installer\\MSI*.tmp,zzzzInv
		     okeManagedCustomActionOutOfProc") and     not (process.name :
		     "VSTOInstaller.exe" and process.args :
		     "https://dl.getsidekick.com/outlook/vsto/Sidekick.vsto")

NamE: Potential Ransomware Behavior - High count of Readme files by System
	description: 
		     This rule identifies a high number (20) of file
		     creation event by the System virtual process from the same host
		     and with same file name containing keywords similar to
		     ransomware note files and all within a short time period.
	query: 
		     event.category:file and host.os.type:windows and
		     process.pid:4 and event.action:creation and
		     file.name:(*read*me* or *README* or *lock* or *LOCK* or
		     *how*to* or *HOW*TO* or *@* or *recover* or *RECOVER* or
		     *decrypt* or *DECRYPT* or *restore* or *RESTORE* or
		     *FILES_BACK* or *files_back*)

NamE: Ransomware - Prevented - Elastic Endgame
	description: 
		     Elastic Endgame prevented ransomware. Click the
		     Elastic Endgame icon in the event.module column or the link in
		     the rule.reference column for additional information.
	query: 
		     event.kind:alert and event.module:endgame and
		     endgame.metadata.type:prevention and
		     (event.action:ransomware_event or
		     endgame.event_subtype_full:ransomware_event)

NamE: AWS EFS File System or Mount Deleted
	description: 
		     Detects when an EFS File System or Mount is
		     deleted. An adversary could break any file system using the
		     mount target that is being deleted, which might disrupt
		     instances or applications using those mounts. The mount must be
		     deleted prior to deleting the File System, or the adversary
		     will be unable to delete the File System.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:elasticfilesystem.amazonaws.com and
		     event.action:(DeleteMountTarget or DeleteFileSystem) and
		     event.outcome:success

NamE: Microsoft 365 Teams Custom Application Interaction Allowed
	description: 
		     Identifies when custom applications are allowed
		     in Microsoft Teams. If an organization requires applications
		     other than those available in the Teams app store, custom
		     applications can be developed as packages and uploaded. An
		     adversary may abuse this behavior to establish persistence in
		     an environment.
	query: 
		     event.dataset:o365.audit and
		     event.provider:MicrosoftTeams and event.category:web and
		     event.action:TeamsTenantSettingChanged and
		     o365.audit.Name:"Allow sideloading and interaction of custom
		     apps" and o365.audit.NewValue:True and event.outcome:success

NamE: Suspicious APT Package Manager Execution
	description: 
		     Detects suspicious process events executed by
		     the APT package manager, potentially indicating persistence
		     through an APT backdoor. In Linux, APT (Advanced Package Tool)
		     is a command-line utility used for handling packages on Debian-
		     based systems, providing functions for installing, updating,
		     upgrading, and removing software along with managing package
		     repositories. Attackers can backdoor APT to gain persistence by
		     injecting malicious code into scripts that APT runs, thereby
		     ensuring continued unauthorized access or control each time APT
		     is used for package management.
	query: 
		     sequence by host.id with maxspan=5s   [process where
		     host.os.type == "linux" and event.type == "start" and
		     event.action in ("exec", "start") and    process.parent.name ==
		     "apt" and process.args == "-c" and process.name in (
		     "bash", "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish"    )
		     and not process.executable == "/usr/lib/venv-salt-
		     minion/bin/python.original"   ] by process.entity_id   [process
		     where host.os.type == "linux" and event.type == "start" and
		     event.action in ("exec", "start") and process.name : (
		     "bash", "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish",
		     "python*", "php*",      "perl", "ruby", "lua*", "openssl",
		     "nc", "netcat", "ncat", "telnet", "awk"    )   ] by
		     process.parent.entity_id

NamE: Connection to Internal Network via Telnet
	description: 
		     Telnet provides a command line interface for
		     communication with a remote device or server. This rule
		     identifies Telnet network connections to non-publicly routable
		     IP addresses.
	query: 
		     sequence by process.entity_id   [process where
		     host.os.type == "linux" and process.name == "telnet" and
		     event.type == "start"]   [network where host.os.type == "linux"
		     and process.name == "telnet" and cidrmatch(
		     destination.ip, "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16",
		     "172.16.0.0/12", "192.0.0.0/24", "192.0.0.0/29",
		     "192.0.0.8/32", "192.0.0.9/32", "192.0.0.10/32",
		     "192.0.0.170/32", "192.0.0.171/32", "192.0.2.0/24",
		     "192.31.196.0/24", "192.52.193.0/24", "192.168.0.0/16",
		     "192.88.99.0/24", "224.0.0.0/4", "100.64.0.0/10",
		     "192.175.48.0/24", "198.18.0.0/15", "198.51.100.0/24",
		     "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10",
		     "FF00::/8"     )   ]

NamE: Privileges Elevation via Parent Process PID Spoofing
	description: 
		     Identifies parent process spoofing used to
		     create an elevated child process. Adversaries may spoof the
		     parent process identifier (PPID) of a new process to evade
		     process-monitoring defenses or to elevate privileges.
	query: 
		     /* This rule is compatible with Elastic Endpoint only
		     */  process where host.os.type == "windows" and event.action ==
		     "start" and   /* process creation via seclogon */
		     process.parent.Ext.real.pid > 0 and   /* PrivEsc to SYSTEM */
		     user.id : "S-1-5-18"  and   /* Common FPs - evasion via
		     hollowing is possible, should be covered by code injection */
		     not process.executable :
		     ("?:\\Windows\\System32\\WerFault.exe",
		     "?:\\Windows\\SysWOW64\\WerFault.exe",
		     "?:\\Windows\\System32\\WerFaultSecure.exe",
		     "?:\\Windows\\SysWOW64\\WerFaultSecure.exe",
		     "?:\\Windows\\System32\\Wermgr.exe",
		     "?:\\Windows\\SysWOW64\\Wermgr.exe",
		     "?:\\Windows\\SoftwareDistribution\\Download\\Install\\security
		     healthsetup.exe") and  /* Logon Utilities */  not
		     (process.parent.executable :
		     "?:\\Windows\\System32\\Utilman.exe" and
		     process.executable : ("?:\\Windows\\System32\\osk.exe",
		     "?:\\Windows\\System32\\Narrator.exe",
		     "?:\\Windows\\System32\\Magnify.exe")) and   not
		     process.parent.executable :
		     "?:\\Windows\\System32\\AtBroker.exe" and   not
		     (process.code_signature.subject_name in            ("philandro
		     Software GmbH", "Freedom Scientific Inc.", "TeamViewer Germany
		     GmbH", "Projector.is, Inc.",             "TeamViewer GmbH",
		     "Cisco WebEx LLC", "Dell Inc") and
		     process.code_signature.trusted == true) and   /* AM_Delta_Patch
		     Windows Update */  not (process.executable :
		     ("?:\\Windows\\System32\\MpSigStub.exe",
		     "?:\\Windows\\SysWOW64\\MpSigStub.exe") and
		     process.parent.executable :
		     ("?:\\Windows\\System32\\wuauclt.exe",
		     "?:\\Windows\\SysWOW64\\wuauclt.exe",
		     "?:\\Windows\\UUS\\Packages\\Preview\\*\\wuaucltcore.exe",
		     "?:\\Windows\\UUS\\amd64\\wuauclt.exe",
		     "?:\\Windows\\UUS\\amd64\\wuaucltcore.exe",
		     "?:\\ProgramData\\Microsoft\\Windows\\UUS\\*\\wuaucltcore.exe")
		     ) and  not (process.executable :
		     ("?:\\Windows\\System32\\MpSigStub.exe",
		     "?:\\Windows\\SysWOW64\\MpSigStub.exe") and
		     process.parent.executable == null) and   /* Other third party
		     SW */  not process.parent.executable :
		     ("?:\\Program Files (x86)\\HEAT Software\\HEAT
		     Remote\\HEATRemoteServer.exe",                     "?:\\Program
		     Files (x86)\\VisualCron\\VisualCronService.exe",
		     "?:\\Program Files\\BinaryDefense\\Vision\\Agent\\bds-vision-
		     agent-app.exe",                     "?:\\Program
		     Files\\Tablet\\Wacom\\WacomHost.exe",
		     "?:\\Program Files (x86)\\LogMeIn\\x64\\LogMeIn.exe",
		     "?:\\Program Files (x86)\\EMC Captiva\\Captiva Cloud
		     Runtime\\Emc.Captiva.WebCaptureRunner.exe",
		     "?:\\Program Files\\Freedom Scientific\\*.exe",
		     "?:\\Program Files (x86)\\Google\\Chrome Remote
		     Desktop\\*\\remoting_host.exe",
		     "?:\\Program Files (x86)\\GoToAssist Remote Support
		     Customer\\*\\g2ax_comm_customer.exe") and  not (
		     process.code_signature.trusted == true and
		     process.code_signature.subject_name == "Netwrix Corporation"
		     and     process.name : "adcrcpy.exe" and
		     process.parent.executable : (       "?:\\Program Files
		     (x86)\\Netwrix Auditor\\Active Directory
		     Auditing\\Netwrix.ADA.EventCollector.exe",       "?:\\Program
		     Files (x86)\\Netwrix Auditor\\Active Directory
		     Auditing\\Netwrix.ADA.Analyzer.exe",       "?:\\Netwrix
		     Auditor\\Active Directory
		     Auditing\\Netwrix.ADA.EventCollector.exe"     )  )

NamE: Suspicious MS Office Child Process
	description: 
		     Identifies suspicious child processes of
		     frequently targeted Microsoft Office applications (Word,
		     PowerPoint, Excel). These child processes are often launched
		     during exploitation of Office applications or from documents
		     with malicious macros.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.name : (       "eqnedt32.exe",
		     "excel.exe", "fltldr.exe", "msaccess.exe",       "mspub.exe",
		     "powerpnt.exe", "winword.exe", "outlook.exe"   ) and
		     process.name : (       "Microsoft.Workflow.Compiler.exe",
		     "arp.exe", "atbroker.exe", "bginfo.exe", "bitsadmin.exe",
		     "cdb.exe",       "certutil.exe", "cmd.exe", "cmstp.exe",
		     "control.exe", "cscript.exe", "csi.exe", "dnx.exe",
		     "dsget.exe",       "dsquery.exe", "forfiles.exe", "fsi.exe",
		     "ftp.exe", "gpresult.exe", "hostname.exe", "ieexec.exe",
		     "iexpress.exe",       "installutil.exe", "ipconfig.exe",
		     "mshta.exe", "msxsl.exe", "nbtstat.exe", "net.exe", "net1.exe",
		     "netsh.exe",       "netstat.exe", "nltest.exe", "odbcconf.exe",
		     "ping.exe", "powershell.exe", "pwsh.exe", "qprocess.exe",
		     "quser.exe", "qwinsta.exe", "rcsi.exe", "reg.exe",
		     "regasm.exe", "regsvcs.exe", "regsvr32.exe", "sc.exe",
		     "schtasks.exe", "systeminfo.exe", "tasklist.exe",
		     "tracert.exe", "whoami.exe", "wmic.exe", "wscript.exe",
		     "xwizard.exe", "explorer.exe", "rundll32.exe", "hh.exe",
		     "msdt.exe"   ) and   not (     process.parent.name :
		     "outlook.exe" and     process.name : "rundll32.exe" and
		     process.args : "shell32.dll,Control_RunDLL" and
		     process.args : "srchadmin.dll"   )

NamE: Potential Upgrade of Non-interactive Shell
	description: 
		     Identifies when a non-interactive terminal (tty)
		     is being upgraded to a fully interactive shell. Attackers may
		     upgrade a simple reverse shell to a fully interactive tty after
		     obtaining initial access to a host, in order to obtain a more
		     stable connection.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2") and   (     (process.name == "stty"
		     and process.args == "raw" and process.args == "-echo" and
		     process.args_count >= 3) or     (process.name == "script" and
		     process.args in ("-qc", "-c") and process.args == "/dev/null"
		     and     process.args_count == 4)   )

NamE: Creation of Hidden Login Item via Apple Script
	description: 
		     Identifies the execution of osascript to create
		     a hidden login item. This may indicate an attempt to persist a
		     malicious program while concealing its presence.
	query: 
		     process where host.os.type == "macos" and event.type
		     in ("start", "process_started") and process.name : "osascript"
		     and  process.command_line : "osascript*login item*hidden:true*"

NamE: SolarWinds Process Disabling Services via Registry
	description: 
		     Identifies a SolarWinds binary modifying the
		     start type of a service to be disabled. An adversary may abuse
		     this technique to manipulate relevant security services.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and registry.value : "Start" and
		     process.name : (       "SolarWinds.BusinessLayerHost*.exe",
		     "ConfigurationWizard*.exe",
		     "NetflowDatabaseMaintenance*.exe",       "NetFlowService*.exe",
		     "SolarWinds.Administration*.exe",
		     "SolarWinds.Collector.Service*.exe",
		     "SolarwindsDiagnostics*.exe"   ) and   registry.path : (
		     "HKLM\\SYSTEM\\*ControlSet*\\Services\\*\\Start",     "\\REGIST
		     RY\\MACHINE\\SYSTEM\\*ControlSet*\\Services\\*\\Start",
		     "MACHINE\\SYSTEM\\*ControlSet*\\Services\\*\\Start"   ) and
		     registry.data.strings : ("4", "0x00000004")

NamE: Archive File with Unusual Extension
	description: 
		     Identifies the creation of an archive file with
		     an unusual extension. Attackers may attempt to evade detection
		     by masquerading files using the file extension values used by
		     image, audio, or document file types.
	query: 
		     file where host.os.type == "windows" and event.action
		     != "deletion" and    /* common archive file headers - Rar, 7z,
		     GZIP, MSCF, XZ, ZIP */   file.Ext.header_bytes : ("52617221*",
		     "377ABCAF271C*", "1F8B*", "4d534346*", "FD377A585A00*",
		     "504B0304*", "504B0708*") and    (     /* common image file
		     extensions */     file.extension : ("jpg", "jpeg", "emf",
		     "tiff", "gif", "png", "bmp", "ico", "fpx", "eps", "inf") or
		     /* common audio and video file extensions */     file.extension
		     : ("mp3", "wav", "avi", "mpeg", "flv", "wma", "wmv", "mov",
		     "mp4", "3gp") or      /* common document file extensions */
		     (file.extension : ("doc", "docx", "rtf", "ppt", "pptx", "xls",
		     "xlsx") and      /* exclude ZIP file header values for OPENXML
		     documents */     not file.Ext.header_bytes : ("504B0304*",
		     "504B0708*"))   ) and    not (process.executable :
		     "?:\\Windows\\System32\\inetsrv\\w3wp.exe" and file.path :
		     "?:\\inetpub\\temp\\IIS Temporary Compressed Files\\*")

NamE: Wireless Credential Dumping using Netsh Command
	description: 
		     Identifies attempts to dump Wireless saved
		     access keys in clear text using the Windows built-in utility
		     Netsh.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  (process.name : "netsh.exe" or
		     ?process.pe.original_file_name == "netsh.exe") and
		     process.args : "wlan" and process.args : "key*clear"

NamE: Dumping Account Hashes via Built-In Commands
	description: 
		     Identifies the execution of macOS built-in
		     commands used to dump user account hashes. Adversaries may
		     attempt to dump credentials to obtain account login information
		     in the form of a hash. These hashes can be cracked or leveraged
		     for lateral movement.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:start and  process.name:(defaults or mkpassdb) and
		     process.args:(ShadowHashData or "-dump")

NamE: NTDS or SAM Database File Copied
	description: 
		     Identifies a copy operation of the Active
		     Directory Domain Database (ntds.dit) or Security Account
		     Manager (SAM) files. Those files contain sensitive information
		     including hashed domain and/or local credentials.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (     ((?process.pe.original_file_name in
		     ("Cmd.Exe", "PowerShell.EXE", "XCOPY.EXE") or process.name :
		     ("Cmd.Exe", "PowerShell.EXE", "XCOPY.EXE")) and
		     process.args : ("copy", "xcopy", "Copy-Item", "move", "cp",
		     "mv")     ) or     ((?process.pe.original_file_name :
		     "esentutl.exe" or process.name : "esentutl.exe") and
		     process.args : ("*/y*", "*/vss*", "*/d*"))   ) and
		     process.command_line : ("*\\ntds.dit*", "*\\config\\SAM*",
		     "*\\*\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy*\\*",
		     "*/system32/config/SAM*", "*\\User Data\\*")

NamE: Suspicious Child Process of Adobe Acrobat Reader Update Service
	description: 
		     Detects attempts to exploit privilege escalation
		     vulnerabilities related to the Adobe Acrobat Reader
		     PrivilegedHelperTool responsible for installing updates. For
		     more information, refer to CVE-2020-9615, CVE-2020-9614 and
		     CVE-2020-9613 and verify that the impacted system is patched.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:(start or process_started) and
		     process.parent.name:com.adobe.ARMDC.SMJobBlessHelper and
		     user.name:root and   not process.executable: (/Library/Privileg
		     edHelperTools/com.adobe.ARMDC.SMJobBlessHelper or
		     /usr/bin/codesign or
		     /private/var/folders/zz/*/T/download/ARMDCHammer or
		     /usr/sbin/pkgutil or                            /usr/bin/shasum
		     or                            /usr/bin/perl* or
		     /usr/sbin/spctl or
		     /usr/sbin/installer or
		     /usr/bin/csrutil)

NamE: Attempt to Unload Elastic Endpoint Security Kernel Extension
	description: 
		     Identifies attempts to unload the Elastic
		     Endpoint Security kernel extension via the kextunload command.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:(start or process_started) and
		     process.name:kextunload and process.args:("/System/Library/Exte
		     nsions/EndpointSecurity.kext" or "EndpointSecurity.kext")

NamE: Potential Persistence via File Modification
	description: 
		     This rule leverages the File Integrity
		     Monitoring (FIM) integration to detect file modifications of
		     files that are commonly used for persistence on Linux systems.
		     The rule detects modifications to files that are commonly used
		     for cron jobs, systemd services, message-of-the-day (MOTD), SSH
		     configurations, shell configurations, runtime control, init
		     daemon, passwd/sudoers/shadow files, Systemd udevd, and XDG/KDE
		     autostart entries. To leverage this rule, the paths specified
		     in the query need to be added to the FIM policy in the Elastic
		     Security app.
	query: 
		     file where host.os.type == "linux" and event.dataset
		     == "fim.event" and event.action == "updated" and file.path : (
		     // cron, anacron & at   "/etc/cron.d/*", "/etc/cron.daily/*",
		     "/etc/cron.hourly/*", "/etc/cron.monthly/*",
		     "/etc/cron.weekly/*", "/etc/crontab",
		     "/var/spool/cron/crontabs/*", "/etc/cron.allow",
		     "/etc/cron.deny",  "/var/spool/anacron/*",
		     "/var/spool/cron/atjobs/*",    // systemd services & timers
		     "/etc/systemd/system/*", "/usr/local/lib/systemd/system/*",
		     "/lib/systemd/system/*",   "/usr/lib/systemd/system/*",
		     "/home/*/.config/systemd/user/*",
		     "/home/*/.local/share/systemd/user/*",
		     "/root/.config/systemd/user/*",
		     "/root/.local/share/systemd/user/*",    // LD_PRELOAD
		     "/etc/ld.so.preload", "/etc/ld.so.conf.d/*", "/etc/ld.so.conf",
		     // Dynamic linker   "/lib/ld-linux*.so*", "/lib64/ld-
		     linux*.so*", "/usr/lib/ld-linux*.so*", "/usr/lib64/ld-
		     linux*.so*",    // message-of-the-day (MOTD)   "/etc/update-
		     motd.d/*",    // SSH   "/home/*/.ssh/*", "/root/.ssh/*",
		     "/etc/ssh/*",    // system-wide shell configurations
		     "/etc/profile", "/etc/profile.d/*", "/etc/bash.bashrc",
		     "/etc/zsh/*", "/etc/csh.cshrc",   "/etc/csh.login",
		     "/etc/fish/config.fish", "/etc/ksh.kshrc",    // root and user
		     shell configurations   "/home/*/.profile", "/home/*/.bashrc",
		     "/home/*/.bash_login", "/home/*/.bash_logout",
		     "/root/.profile", "/root/.bashrc", "/root/.bash_login",
		     "/root/.bash_logout",   "/home/*/.zprofile", "/home/*/.zshrc",
		     "/root/.zprofile", "/root/.zshrc",   "/home/*/.cshrc",
		     "/home/*/.login", "/home/*/.logout", "/root/.cshrc",
		     "/root/.login", "/root/.logout",
		     "/home/*/.config/fish/config.fish",
		     "/root/.config/fish/config.fish",   "/home/*/.kshrc",
		     "/root/.kshrc",    // runtime control   "/etc/rc.common",
		     "/etc/rc.local",    // System V init/Upstart   "/etc/init.d/*",
		     "/etc/init/*",    // passwd/sudoers/shadow   "/etc/passwd",
		     "/etc/shadow", "/etc/sudoers", "/etc/sudoers.d/*",    //
		     Systemd udevd   "/lib/udev/*", "/etc/udev/rules.d/*",
		     "/usr/lib/udev/rules.d/*", "/run/udev/rules.d/*",
		     "/usr/local/lib/udev/rules.d/*",    // XDG/KDE autostart
		     entries   "/home/*/.config/autostart/*",
		     "/root/.config/autostart/*", "/etc/xdg/autostart/*",
		     "/usr/share/autostart/*",   "/home/*/.kde/Autostart/*",
		     "/root/.kde/Autostart/*",   "/home/*/.kde4/Autostart/*",
		     "/root/.kde4/Autostart/*",   "/home/*/.kde/share/autostart/*",
		     "/root/.kde/share/autostart/*",
		     "/home/*/.kde4/share/autostart/*",
		     "/root/.kde4/share/autostart/*",
		     "/home/*/.local/share/autostart/*",
		     "/root/.local/share/autostart/*",   "/home/*/.config/autostart-
		     scripts/*", "/root/.config/autostart-scripts/*",    // LKM
		     configuration files   "/etc/modules", "/etc/modprobe.d/*",
		     "/usr/lib/modprobe.d/*", "/etc/modules-load.d/*",
		     "/run/modules-load.d/*", "/usr/local/lib/modules-load.d/*",
		     "/usr/lib/modules-load.d/*",    // PAM modules & configuration
		     files   "/lib/security/*", "/lib64/security/*",
		     "/usr/lib/security/*", "/usr/lib64/security/*",
		     "/lib/x86_64-linux-gnu/security/*", "/usr/lib/x86_64-linux-
		     gnu/security/*",   "/etc/pam.d/*", "/etc/security/pam_*",
		     "/etc/pam.conf",    // Polkit Rule files
		     "/etc/polkit-1/rules.d/*", "/usr/share/polkit-1/rules.d/*",
		     // Polkit pkla files   "/etc/polkit-1/localauthority/*",
		     "/var/lib/polkit-1/localauthority/*",    // Polkit Action files
		     "/usr/share/polkit-1/actions/*",    // Polkit Legacy paths
		     "/lib/polkit-1/rules.d/*", "/lib64/polkit-1/rules.d/*",
		     "/var/lib/polkit-1/rules.d/*",    // NetworkManager
		     "/etc/NetworkManager/dispatcher.d/*",    // D-bus Service files
		     "/usr/share/dbus-1/system-services/*",
		     "/etc/dbus-1/system.d/*",   "/lib/dbus-1/system-services/*",
		     "/run/dbus/system.d/*",
		     "/home/*/.local/share/dbus-1/services/*",
		     "/home/*/.dbus/session-bus/*",
		     "/usr/share/dbus-1/services/*", "/etc/dbus-1/session.d/*",
		     // GRUB   "/etc/default/grub.d/*", "/etc/default/grub",
		     "/etc/grub.d/*", "/boot/grub2/grub.cfg",
		     "/boot/grub/grub.cfg", "/boot/efi/EFI/*/grub.cfg",
		     "/etc/sysconfig/grub",    // Dracut
		     "/lib/dracut/modules.d/*", "/usr/lib/dracut/modules.d/*",    //
		     Misc.   "/etc/shells"  ) and not (   file.path : (
		     "/var/spool/cron/crontabs/tmp.*", "/run/udev/rules.d/*rules.*",
		     "/home/*/.ssh/known_hosts.*", "/root/.ssh/known_hosts.*"   ) or
		     file.extension in ("dpkg-new", "dpkg-remove", "SEQ") )

NamE: User or Group Creation/Modification
	description: 
		     This rule leverages the `auditd_manager`
		     integration to detect user or group creation or modification
		     events on Linux systems. Threat actors may attempt to create or
		     modify users or groups to establish persistence on the system.
	query: 
		     iam where host.os.type == "linux" and event.type in
		     ("creation", "change") and auditd.result == "success" and
		     event.action in ("changed-password", "added-user-account",
		     "added-group-account-to") and process.name != null

NamE: Cobalt Strike Command and Control Beacon
	description: 
		     Cobalt Strike is a threat emulation platform
		     commonly modified and used by adversaries to conduct network
		     attack and exploitation campaigns. This rule detects a network
		     activity algorithm leveraged by Cobalt Strike implant beacons
		     for command and control.
	query: 
		     ((event.category: (network OR network_traffic) AND
		     type: (tls OR http))     OR event.dataset: (network_traffic.tls
		     OR network_traffic.http) ) AND
		     destination.domain:/[a-z]{3}.stage.[0-9]{8}\..*/

NamE: AWS IAM CompromisedKeyQuarantine Policy Attached to User
	description: 
		     This rule looks for use of the IAM
		     `AttachUserPolicy` API operation to attach the
		     `CompromisedKeyQuarantine` or `CompromisedKeyQuarantineV2` AWS
		     managed policies to an existing IAM user. This policy denies
		     access to certain actions and is applied by the AWS team in the
		     event that an IAM user's credentials have been compromised or
		     exposed publicly.
	query: 
		     any where event.dataset == "aws.cloudtrail"    and
		     event.action == "AttachUserPolicy"    and event.outcome ==
		     "success"    and
		     stringContains(aws.cloudtrail.request_parameters,
		     "AWSCompromisedKeyQuarantine")

NamE: IPSEC NAT Traversal Port Activity
	description: 
		     This rule detects events that could be
		     describing IPSEC NAT Traversal traffic. IPSEC is a VPN
		     technology that allows one system to talk to another using
		     encrypted tunnels. NAT Traversal enables these tunnels to
		     communicate over the Internet where one of the sides is behind
		     a NAT router gateway. This may be common on your network, but
		     this technique is also used by threat actors to avoid
		     detection.
	query: 
		     (event.dataset: network_traffic.flow or
		     (event.category: (network or network_traffic))) and
		     network.transport:udp and destination.port:4500

NamE: Prompt for Credentials with OSASCRIPT
	description: 
		     Identifies the use of osascript to execute
		     scripts via standard input that may prompt a user with a rogue
		     dialog for credentials.
	query: 
		     process where event.action == "exec" and host.os.type
		     == "macos" and  process.name : "osascript" and process.args :
		     "-e" and process.command_line :
		     ("*osascript*display*dialog*password*",
		     "*osascript*display*dialog*passphrase*") and  not
		     (process.parent.executable : "/usr/bin/sudo" and
		     process.command_line : "*Encryption Key Escrow*") and  not
		     (process.command_line : "*-e with timeout of 3600 seconds*" and
		     user.id == "0" and process.parent.executable : "/bin/bash") and
		     not process.Ext.effective_parent.executable :
		     ("/usr/local/jamf/*",
		     "/Applications/Karabiner-Elements.app/Contents/MacOS/Karabiner-
		     Elements",                                                 "/Sy
		     stem/Applications/Utilities/Terminal.app/Contents/MacOS/Termina
		     l",
		     "/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/Jamf
		     Daemon.app/Contents/MacOS/JamfDaemon",
		     "/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/Jamf
		     ManagementService.app/Contents/MacOS/JamfManagementService")

NamE: Potential Lateral Tool Transfer via SMB Share
	description: 
		     Identifies the creation or change of a Windows
		     executable file over network shares. Adversaries may transfer
		     tools or other files between systems in a compromised
		     environment.
	query: 
		     sequence by host.id with maxspan=30s   [network where
		     host.os.type == "windows" and event.type == "start" and
		     process.pid == 4 and destination.port == 445 and
		     network.direction : ("incoming", "ingress") and
		     network.transport == "tcp" and source.ip != "127.0.0.1" and
		     source.ip != "::1"   ] by process.entity_id   /* add more
		     executable extensions here if they are not noisy in your
		     environment */   [file where host.os.type == "windows" and
		     event.type in ("creation", "change") and process.pid == 4 and
		     (file.Ext.header_bytes : "4d5a*" or file.extension : ("exe",
		     "scr", "pif", "com", "dll"))] by process.entity_id

NamE: Kubernetes Pod Created With HostIPC
	description: 
		     This rule detects an attempt to create or modify
		     a pod using the host IPC namespace. This gives access to data
		     used by any pod that also use the hosts IPC namespace. If any
		     process on the host or any processes in a pod uses the hosts
		     inter-process communication mechanisms (shared memory,
		     semaphore arrays, message queues, etc.), an attacker can
		     read/write to those same mechanisms. They may look for files in
		     /dev/shm or use ipcs to check for any IPC facilities being
		     used.
	query: 
		     event.dataset : "kubernetes.audit_logs"   and kubernet
		     es.audit.annotations.authorization_k8s_io/decision:"allow"
		     and kubernetes.audit.objectRef.resource:"pods"   and
		     kubernetes.audit.verb:("create" or "update" or "patch")   and
		     kubernetes.audit.requestObject.spec.hostIPC:true   and not
		     kubernetes.audit.requestObject.spec.containers.image:
		     ("docker.elastic.co/beats/elastic-agent:8.4.0")

NamE: Potential Credential Access via Renamed COM+ Services DLL
	description: 
		     Identifies suspicious renamed COMSVCS.DLL Image
		     Load, which exports the MiniDump function that can be used to
		     dump a process memory. This may indicate an attempt to dump
		     LSASS memory while bypassing command-line based detection in
		     preparation for credential access.
	query: 
		     sequence by process.entity_id with maxspan=1m
		     [process where host.os.type == "windows" and event.category ==
		     "process" and     process.name : "rundll32.exe"]  [process
		     where host.os.type == "windows" and event.category == "process"
		     and event.dataset : "windows.sysmon_operational" and event.code
		     == "7" and    (file.pe.original_file_name : "COMSVCS.DLL" or
		     file.pe.imphash : "EADBCCBB324829ACB5F2BBE87E5549A8") and
		     /* renamed COMSVCS */     not file.name : "COMSVCS.DLL"]

NamE: Web Application Suspicious Activity: POST Request Declined
	description: 
		     A POST request to a web application returned a
		     403 response, which indicates the web application declined to
		     process the request because the action requested was not
		     allowed.
	query: 
		     http.response.status_code:403 and
		     http.request.method:post

NamE: Microsoft 365 Exchange Management Group Role Assignment
	description: 
		     Identifies when a new role is assigned to a
		     management group in Microsoft 365. An adversary may attempt to
		     add a role in order to maintain persistence in an environment.
	query: 
		     event.dataset:o365.audit and event.provider:Exchange
		     and event.category:web and event.action:"New-
		     ManagementRoleAssignment" and event.outcome:success

NamE: GCP Virtual Private Cloud Route Deletion
	description: 
		     Identifies when a Virtual Private Cloud (VPC)
		     route is deleted in Google Cloud Platform (GCP). Google Cloud
		     routes define the paths that network traffic takes from a
		     virtual machine (VM) instance to other destinations. These
		     destinations can be inside a Google VPC network or outside it.
		     An adversary may delete a route in order to impact the flow of
		     network traffic in their target's cloud environment.
	query: 
		     event.dataset:gcp.audit and
		     event.action:v*.compute.routes.delete and event.outcome:success

NamE: Kerberos Cached Credentials Dumping
	description: 
		     Identifies the use of the Kerberos credential
		     cache (kcc) utility to dump locally cached Kerberos tickets.
		     Adversaries may attempt to dump credential material in the form
		     of tickets that can be leveraged for lateral movement.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:(start or process_started) and   process.name:kcc
		     and   process.args:copy_cred_cache

NamE: AWS Management Console Root Login
	description: 
		     Identifies a successful login to the AWS
		     Management Console by the Root user.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:signin.amazonaws.com and
		     event.action:ConsoleLogin and
		     aws.cloudtrail.user_identity.type:Root and
		     event.outcome:success

NamE: SSH Authorized Keys File Deletion
	description: 
		     This rule detects the deletion of the
		     authorized_keys or authorized_keys2 files on Linux systems.
		     These files are used to store public keys for SSH
		     authentication. Unauthorized deletion of these files can be an
		     indicator of an attacker removing access to the system, and may
		     be a precursor to further malicious activity.
	query: 
		     file where host.os.type == "linux" and event.type ==
		     "deletion" and file.name in ("authorized_keys",
		     "authorized_keys2") and not (   process.executable in (
		     "/usr/bin/google_guest_agent", "/usr/bin/dockerd",
		     "/bin/dockerd", "/usr/bin/containerd"   ) or
		     process.executable like~ "/nix/store/*" )

NamE: Suspicious Network Connection via systemd
	description: 
		     Detects suspicious network events executed by
		     systemd, potentially indicating persistence through a systemd
		     backdoor. Systemd is a system and service manager for Linux
		     operating systems, used to initialize and manage system
		     processes. Attackers can backdoor systemd for persistence by
		     creating or modifying systemd unit files to execute malicious
		     scripts or commands, or by replacing legitimate systemd
		     binaries with compromised ones, ensuring that their malicious
		     code is automatically executed at system startup or during
		     certain system events.
	query: 
		     sequence by host.id with maxspan=5s   [process where
		     host.os.type == "linux" and event.type == "start" and
		     event.action == "exec" and    process.parent.name == "systemd"
		     and process.name in (      "python*", "php*", "perl", "ruby",
		     "lua*", "openssl", "nc", "netcat", "ncat", "telnet", "awk"    )
		     ] by process.entity_id   [network where host.os.type == "linux"
		     and event.action == "connection_attempted" and event.type ==
		     "start" and    not process.executable ==
		     "/tmp/newroot/bin/curl"] by process.parent.entity_id

NamE: Virtual Machine Fingerprinting
	description: 
		     An adversary may attempt to get detailed
		     information about the operating system and hardware. This rule
		     identifies common locations used to discover virtual machine
		     hardware by a non-root user. This technique has been used by
		     the Pupy RAT and other malware.
	query: 
		     event.category:process and host.os.type:linux and
		     event.type:(start or process_started) and
		     process.args:("/sys/class/dmi/id/bios_version" or
		     "/sys/class/dmi/id/product_name" or
		     "/sys/class/dmi/id/chassis_vendor" or
		     "/proc/scsi/scsi" or                 "/proc/ide/hd0/model") and
		     not user.name:root

NamE: Potential Reverse Shell via Child
	description: 
		     This detection rule identifies suspicious
		     network traffic patterns associated with TCP reverse shell
		     activity. This activity consists of a network event that is
		     followed by the creation of a shell process with suspicious
		     command line arguments. An attacker may establish a Linux TCP
		     reverse shell to gain remote access to a target system.
	query: 
		     sequence by host.id, process.entity_id with maxspan=5s
		     [network where event.type == "start" and host.os.type ==
		     "linux" and      event.action in ("connection_attempted",
		     "connection_accepted") and      process.name : ("bash", "dash",
		     "sh", "tcsh", "csh", "zsh", "ksh", "fish", "socat") and
		     destination.ip != null and      not cidrmatch(destination.ip,
		     "127.0.0.0/8", "169.254.0.0/16", "224.0.0.0/4", "::1")]
		     [process where event.type == "start" and host.os.type ==
		     "linux" and event.action == "exec" and      process.name in
		     ("bash", "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish") and
		     (        (process.args : ("-i", "-l")) or (process.parent.name
		     == "socat" and process.parent.args : "*exec*")    )]

NamE: Process Capability Enumeration
	description: 
		     Identifies recursive process capability
		     enumeration of the entire filesystem through the getcap
		     command. Malicious users may manipulate identified capabilities
		     to gain root privileges.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "ProcessRollup2") and   process.name == "getcap" and
		     process.args == "-r" and process.args == "/" and
		     process.args_count == 3 and user.id != "0"

NamE: Unusual D-Bus Daemon Child Process
	description: 
		     This rule detects when an unusual child process
		     is spawned from the `dbus-daemon` parent process. The `dbus-
		     daemon` process is a message bus system that provides a way for
		     applications to talk to each other. Attackers may abuse this
		     process to execute malicious code or escalate privileges.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start")
		     and process.parent.name == "dbus-daemon" and process.args_count
		     > 1 and not (   process.parent.args == "--session" or
		     process.args in ("/usr/lib/software-properties/software-
		     properties-dbus", "/usr/share/backintime/qt/serviceHelper.py")
		     or   process.name in ("dbus-daemon-launch-helper", "gnome-
		     keyring-daemon", "abrt-dbus", "aptd", "usb-creator-helper") or
		     process.executable like~ ("/usr/lib/*", "/usr/local/lib/*",
		     "/usr/libexec/*", "/tmp/newroot/*") )

NamE: File Creation, Execution and Self-Deletion in Suspicious Directory
	description: 
		     This rule monitors for the creation of a file,
		     followed by its execution and self-deletion in a short timespan
		     within a directory often used for malicious purposes by threat
		     actors. This behavior is often used by malware to execute
		     malicious code and delete itself to hide its tracks.
	query: 
		     sequence by host.id, user.id with maxspan=1m   [file
		     where host.os.type == "linux" and event.action == "creation"
		     and    process.name in ("curl", "wget", "fetch", "ftp", "sftp",
		     "scp", "rsync", "ld") and    file.path : ("/dev/shm/*",
		     "/run/shm/*", "/tmp/*", "/var/tmp/*",      "/run/*",
		     "/var/run/*", "/var/www/*", "/proc/*/fd/*")] by file.name
		     [process where host.os.type == "linux" and event.type ==
		     "start" and event.action == "exec" and    process.parent.name
		     in ("bash", "dash", "ash", "sh", "tcsh", "csh", "zsh", "ksh",
		     "fish") and    not process.parent.executable like (
		     "/tmp/VeeamApp*", "/tmp/rajh/spack-stage/*", "plz-
		     out/bin/vault/bridge/test/e2e/base/bridge-dev",
		     "/usr/bin/ranlib", "/usr/bin/ar", "plz-
		     out/bin/vault/bridge/test/e2e/base/local-k8s"    )] by
		     process.name   [file where host.os.type == "linux" and
		     event.action == "deletion" and    file.path : (
		     "/dev/shm/*", "/run/shm/*", "/tmp/*", "/var/tmp/*", "/run/*",
		     "/var/run/*", "/var/www/*", "/proc/*/fd/*"     ) and not
		     process.name in ("rm", "ld", "conftest", "link", "gcc",
		     "getarch", "ld")] by file.name

NamE: Timestomping using Touch Command
	description: 
		     Timestomping is an anti-forensics technique
		     which is used to modify the timestamps of a file, often to
		     mimic files that are in the same folder.
	query: 
		     process where event.type == "start" and  process.name
		     : "touch" and user.id != "0" and  process.args : ("-r", "-t",
		     "-a*","-m*") and  not process.args : (
		     "/usr/lib/go-*/bin/go", "/usr/lib/dracut/dracut-functions.sh",
		     "/tmp/KSInstallAction.*/m/.patch/*" ) and not
		     process.parent.name in ("pmlogger_daily", "pmlogger_janitor",
		     "systemd")

NamE: AWS Bedrock Invocations without Guardrails Detected by a Single User Over a Session
	description: 
		     Identifies multiple AWS Bedrock executions in a
		     one minute time window without guardrails by the same user in
		     the same account over a session. Multiple consecutive
		     executions implies that a user may be intentionally attempting
		     to bypass security controls, by not routing the requests with
		     the desired guardrail configuration in order to access
		     sensitive information, or possibly exploit a vulnerability in
		     the system.
	query: 
		     from logs-aws_bedrock.invocation-* // create time
		     window buckets of 1 minute | eval time_window = date_trunc(1
		     minute, @timestamp) | where gen_ai.guardrail_id is NULL | KEEP
		     @timestamp, time_window, gen_ai.guardrail_id , user.id | stats
		     model_invocation_without_guardrails = count() by user.id |
		     where model_invocation_without_guardrails > 5 | sort
		     model_invocation_without_guardrails desc

NamE: AWS IAM Roles Anywhere Profile Creation
	description: 
		     Identifies the creation of an AWS Roles Anywhere
		     profile. AWS Roles Anywhere is a feature that allows you to use
		     AWS Identity and Access Management (IAM) profiles to manage
		     access to your AWS resources from any location via trusted
		     anchors. This rule detects the creation of a profile that can
		     be assumed from any service. Adversaries may create profiles
		     tied to overly permissive roles to maintain access to AWS
		     resources. Ensure that the profile creation is expected and
		     that the trust policy is configured securely.
	query: 
		     event.dataset:aws.cloudtrail     and event.provider:
		     rolesanywhere.amazonaws.com     and event.action: CreateProfile
		     and event.outcome: success

NamE: AWS Lambda Function Policy Updated to Allow Public Invocation
	description: 
		     Identifies when an AWS Lambda function policy is
		     updated to allow public invocation. This rule specifically
		     looks for the `AddPermission` API call with the `Principal` set
		     to `*` which allows any AWS account to invoke the Lambda
		     function. Adversaries may abuse this permission to create a
		     backdoor in the Lambda function that allows them to execute
		     arbitrary code.
	query: 
		     event.dataset: aws.cloudtrail     and event.provider:
		     lambda.amazonaws.com     and event.outcome: success     and
		     event.action: AddPermission*     and
		     aws.cloudtrail.request_parameters: (*lambda\:InvokeFunction*
		     and *principal=\**)

NamE: Clearing Windows Console History
	description: 
		     Identifies when a user attempts to clear console
		     history. An adversary may clear the command history of a
		     compromised account to conceal the actions undertaken during an
		     intrusion.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (     process.name : ("powershell.exe",
		     "pwsh.exe", "powershell_ise.exe") or
		     ?process.pe.original_file_name in ("powershell.exe",
		     "pwsh.dll", "powershell_ise.exe")   ) and   (     process.args
		     : "*Clear-History*" or     (process.args : ("*Remove-Item*",
		     "rm") and process.args : ("*ConsoleHost_history.txt*", "*(Get-
		     PSReadlineOption).HistorySavePath*")) or     (process.args :
		     "*Set-PSReadlineOption*" and process.args : "*SaveNothing*")
		     )

NamE: Interactive Terminal Spawned via Perl
	description: 
		     Identifies when a terminal (tty) is spawned via
		     Perl. Attackers may upgrade a simple reverse shell to a fully
		     interactive tty after obtaining initial access to a host.
	query: 
		     event.category:process and host.os.type:linux and
		     event.type:(start or process_started) and process.name:perl and
		     process.args:("exec \"/bin/sh\";" or "exec \"/bin/dash\";" or
		     "exec \"/bin/bash\";")

NamE: Execution via Electron Child Process Node.js Module
	description: 
		     Identifies attempts to execute a child process
		     from within the context of an Electron application using the
		     child_process Node.js module. Adversaries may abuse this
		     technique to inherit permissions from parent processes.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:(start or process_started) and process.args:("-e"
		     and const*require*child_process*)

NamE: Unusual SSHD Child Process
	description: 
		     This rule detects the creation of an unusual
		     SSHD child process through the usage of the `new_terms` rule
		     type. Attackers may abuse SSH to maintain persistence on a
		     compromised system, or to establish a backdoor for remote
		     access, potentially resulting in an unusual SSHD child process
		     being created.
	query: 
		     event.category:process and host.os.type:linux and
		     event.type:start and event.action:exec and
		     process.parent.name:(ssh or sshd) and process.args_count:2 and
		     not (   process.command_line:(-bash or -zsh or -sh) or
		     process.name:(ractrans or exectask or tty or tput or ferny-
		     askpass or id or ip) )

NamE: D-Bus Service Created
	description: 
		     This rule detects the creation of D-Bus service
		     files on Linux systems. D-Bus is a message bus system that
		     provides a way for applications to talk to one another. D-Bus
		     services are defined in service files that are typically
		     located in default directories. The rule looks for the creation
		     of service files that are not associated with known package
		     managers or system services. Attackers may create malicious
		     D-Bus services to establish persistence or escalate privileges
		     on a system.
	query: 
		     file where host.os.type == "linux" and event.type ==
		     "creation" and process.executable != null and file.extension in
		     ("service", "conf") and file.path like~ (
		     "/usr/share/dbus-1/system-services/*",
		     "/etc/dbus-1/system.d/*",   "/lib/dbus-1/system-services/*",
		     "/run/dbus/system.d/*",
		     "/home/*/.local/share/dbus-1/services/*",
		     "/home/*/.dbus/session-bus/*",
		     "/usr/share/dbus-1/services/*", "/etc/dbus-1/session.d/*" ) and
		     not (   process.executable in (     "/bin/dpkg",
		     "/usr/bin/dpkg", "/bin/dockerd", "/usr/bin/dockerd",
		     "/usr/sbin/dockerd", "/bin/microdnf",     "/usr/bin/microdnf",
		     "/bin/rpm", "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd",
		     "/bin/yum", "/usr/bin/yum",     "/bin/dnf", "/usr/bin/dnf",
		     "/bin/podman", "/usr/bin/podman", "/bin/dnf-automatic",
		     "/usr/bin/dnf-automatic",     "/bin/pacman", "/usr/bin/pacman",
		     "/usr/bin/dpkg-divert", "/bin/dpkg-divert", "/sbin/apk",
		     "/usr/sbin/apk",     "/usr/local/sbin/apk", "/usr/bin/apt",
		     "/usr/sbin/pacman", "/bin/podman", "/usr/bin/podman",
		     "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/lib/snapd/snapd", "/usr/local/bin/dockerd",
		     "/usr/bin/crio", "/usr/sbin/crond",
		     "/opt/puppetlabs/puppet/bin/ruby", "/usr/libexec/platform-
		     python", "/kaniko/kaniko-executor",
		     "/usr/local/bin/dockerd", "/usr/bin/podman", "/bin/install",
		     "/proc/self/exe", "/usr/lib/systemd/systemd",
		     "/usr/sbin/sshd", "/usr/bin/gitlab-runner",
		     "/opt/gitlab/embedded/bin/ruby", "/usr/sbin/gdm",
		     "/usr/bin/install",
		     "/usr/local/manageengine/uems_agent/bin/dcregister"   ) or
		     file.Ext.original.extension == "dpkg-new" or
		     process.executable : (     "/nix/store/*", "/var/lib/dpkg/*",
		     "/tmp/vmis.*", "/snap/*", "/dev/fd/*", "/usr/lib/virtualbox/*"
		     ) or   process.name like (     "ssm-agent-worker", "platform-
		     python*", "dnf_install", "cloudflared", "lxc-pve-prestart-
		     hook",     "convert-usrmerge", "elastic-agent",
		     "google_metadata_script_runner", "update-alternatives",
		     "gitlab-runner",     "install", "crio", "apt-get", "package-
		     cleanup", "dcservice", "dcregister", "jumpcloud-agent",
		     "executor"   ) or   (process.name == "sed" and file.name :
		     "sed*") or   (process.name == "perl" and file.name :
		     "e2scrub_all.tmp*")  )

NamE: Linux Restricted Shell Breakout via Linux Binary(s)
	description: 
		     Identifies the abuse of a Linux binary to break
		     out of a restricted shell or environment by spawning an
		     interactive system shell. The activity of spawning a shell from
		     a binary is not common behavior for a user or system
		     administrator, and may indicate an attempt to evade detection,
		     increase capabilities or enhance the stability of an adversary.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and (   /* launching shell from capsh */
		     (process.name == "capsh" and process.args == "--") or    /*
		     launching shells from unusual parents or parent+arg combos */
		     (process.name in ("bash", "dash", "ash", "sh", "tcsh", "csh",
		     "zsh", "ksh", "fish") and (     (process.parent.name : "*awk"
		     and process.parent.args : "BEGIN {system(*)}") or
		     (process.parent.name == "git" and process.parent.args :
		     ("*PAGER*", "!*sh", "exec *sh") or      process.args :
		     ("*PAGER*", "!*sh", "exec *sh") and not process.name == "ssh" )
		     or     (process.parent.name : ("byebug", "ftp", "strace",
		     "zip", "tar") and     (       process.parent.args : "BEGIN
		     {system(*)}" or       (process.parent.args : ("*PAGER*",
		     "!*sh", "exec *sh") or process.args : ("*PAGER*", "!*sh", "exec
		     *sh")) or       (         (process.parent.args : "exec=*sh" or
		     (process.parent.args : "-I" and process.parent.args : "*sh"))
		     or         (process.args : "exec=*sh" or (process.args : "-I"
		     and process.args : "*sh"))         )       )     ) or      /*
		     shells specified in parent args */     /* nice rule is broken
		     in 8.2 */     (process.parent.args : "*sh" and       (
		     (process.parent.name == "nice") or         (process.parent.name
		     == "cpulimit" and process.parent.args == "-f") or
		     (process.parent.name == "find" and process.parent.args == "."
		     and process.parent.args == "-exec" and
		     process.parent.args == ";" and process.parent.args :
		     "/bin/*sh") or         (process.parent.name == "flock" and
		     process.parent.args == "-u" and process.parent.args == "/")
		     )     )   )) or    /* shells specified in args */
		     (process.args : "*sh" and (     (process.parent.name == "crash"
		     and process.parent.args == "-h") or     (process.name ==
		     "sensible-pager" and process.parent.name in ("apt", "apt-get")
		     and process.parent.args == "changelog")     /* scope to include
		     more sensible-pager invoked shells with different parent
		     process to reduce noise and remove false positives */    )) or
		     (process.name == "busybox" and event.action == "exec" and
		     process.args_count == 2 and process.args : "*sh" and not
		     process.executable :
		     "/var/lib/docker/overlay2/*/merged/bin/busybox" and not
		     (process.parent.args == "init" and    process.parent.args ==
		     "runc") and not process.parent.args in ("ls-remote", "push",
		     "fetch") and not process.parent.name == "mkinitramfs") or
		     (process.name == "env" and process.args_count == 2 and
		     process.args : "*sh") or   (process.parent.name in ("vi",
		     "vim") and process.parent.args == "-c" and process.parent.args
		     : ":!*sh") or   (process.parent.name in ("c89", "c99", "gcc")
		     and process.parent.args : "*sh,-s" and process.parent.args ==
		     "-wrapper") or   (process.parent.name == "expect" and
		     process.parent.args == "-c" and process.parent.args : "spawn
		     *sh;interact") or   (process.parent.name == "mysql" and
		     process.parent.args == "-e" and process.parent.args : "\\!*sh")
		     or   (process.parent.name == "ssh" and process.parent.args ==
		     "-o" and process.parent.args : "ProxyCommand=;*sh 0<&2 1>&2") )

NamE: Suspicious Process Execution via Renamed PsExec Executable
	description: 
		     Identifies suspicious psexec activity which is
		     executing from the psexec service that has been renamed,
		     possibly to evade detection.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.pe.original_file_name : "psexesvc.exe"
		     and not process.name : "PSEXESVC.exe"

NamE: Unexpected Child Process of macOS Screensaver Engine
	description: 
		     Identifies when a child process is spawned by
		     the screensaver engine process, which is consistent with an
		     attacker's malicious payload being executed after the
		     screensaver activated on the endpoint. An adversary can
		     maintain persistence on a macOS endpoint by creating a
		     malicious screensaver (.saver) file and configuring the
		     screensaver plist file to execute code each time the
		     screensaver is activated.
	query: 
		     process where host.os.type == "macos" and event.type
		     == "start" and process.parent.name == "ScreenSaverEngine"

NamE: Suspicious Termination of ESXI Process
	description: 
		     Identifies instances where VMware processes,
		     such as "vmware-vmx" or "vmx," are terminated on a Linux system
		     by a "kill" command. The rule monitors for the "end" event
		     type, which signifies the termination of a process. The
		     presence of a "kill" command as the parent process for
		     terminating VMware processes may indicate that a threat actor
		     is attempting to interfere with the virtualized environment on
		     the targeted system.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "end" and process.name in ("vmware-vmx", "vmx") and
		     process.parent.name == "kill"

NamE: Image File Execution Options Injection
	description: 
		     The Debugger and SilentProcessExit registry keys
		     can allow an adversary to intercept the execution of files,
		     causing a different process to be executed. This functionality
		     can be abused by an adversary to establish persistence.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.value : ("Debugger",
		     "MonitorProcess") and length(registry.data.strings) > 0 and
		     registry.path : (     "HKLM\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Image File Execution
		     Options\\*.exe\\Debugger",
		     "HKLM\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows
		     NT\\CurrentVersion\\Image File Execution Options\\*\\Debugger",
		     "HKLM\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\SilentProcessExit\\*\\MonitorProcess",
		     "HKLM\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows
		     NT\\CurrentVersion\\SilentProcessExit\\*\\MonitorProcess",
		     "\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Image File Execution
		     Options\\*.exe\\Debugger",
		     "\\REGISTRY\\MACHINE\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows
		     NT\\CurrentVersion\\Image File Execution Options\\*\\Debugger",
		     "\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\SilentProcessExit\\*\\MonitorProcess",
		     "\\REGISTRY\\MACHINE\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows
		     NT\\CurrentVersion\\SilentProcessExit\\*\\MonitorProcess",
		     "MACHINE\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Image File Execution
		     Options\\*.exe\\Debugger",
		     "MACHINE\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows
		     NT\\CurrentVersion\\Image File Execution Options\\*\\Debugger",
		     "MACHINE\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\SilentProcessExit\\*\\MonitorProcess",
		     "MACHINE\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows
		     NT\\CurrentVersion\\SilentProcessExit\\*\\MonitorProcess"   )
		     and     /* add FPs here */   not registry.data.strings regex~
		     ("""C:\\Program Files( \(x86\))?\\ThinKiosk\\thinkiosk\.exe""",
		     """.*\\PSAppDeployToolkit\\.*""")

NamE: SIP Provider Modification
	description: 
		     Identifies modifications to the registered
		     Subject Interface Package (SIP) providers. SIP providers are
		     used by the Windows cryptographic system to validate file
		     signatures on the system. This may be an attempt to bypass
		     signature validation checks or inject code into critical
		     processes.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and registry.value : ("Dll", "$Dll") and
		     registry.path: (
		     "*\\SOFTWARE\\Microsoft\\Cryptography\\OID\\EncodingType
		     0\\CryptSIPDllPutSignedDataMsg\\{*}\\Dll",     "*\\SOFTWARE\\WO
		     W6432Node\\Microsoft\\Cryptography\\OID\\EncodingType
		     0\\CryptSIPDllPutSignedDataMsg\\{*}\\Dll",     "*\\SOFTWARE\\Mi
		     crosoft\\Cryptography\\Providers\\Trust\\FinalPolicy\\{*}\\$Dll
		     ",     "*\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\Prov
		     iders\\Trust\\FinalPolicy\\{*}\\$Dll"     ) and
		     registry.data.strings:"*.dll" and   not (process.name :
		     "msiexec.exe" and registry.data.strings : "mso.dll") and   not
		     (process.name : "regsvr32.exe" and registry.data.strings ==
		     "WINTRUST.DLL")

NamE: UAC Bypass Attempt via Privileged IFileOperation COM Interface
	description: 
		     Identifies attempts to bypass User Account
		     Control (UAC) via DLL side-loading. Attackers may attempt to
		     bypass UAC to stealthily execute code with elevated
		     permissions.
	query: 
		     file where host.os.type == "windows" and event.type :
		     "change" and process.name : "dllhost.exe" and   /* Known
		     modules names side loaded into process running with high or
		     system integrity level for UAC Bypass, update here for new
		     modules */   file.name : ("wow64log.dll", "comctl32.dll",
		     "DismCore.dll", "OskSupport.dll", "duser.dll",
		     "Accessibility.ni.dll") and   /* has no impact on rule logic
		     just to avoid OS install related FPs */   not file.path :
		     ("C:\\Windows\\SoftwareDistribution\\*",
		     "C:\\Windows\\WinSxS\\*")

NamE: Suspicious MS Outlook Child Process
	description: 
		     Identifies suspicious child processes of
		     Microsoft Outlook. These child processes are often associated
		     with spear phishing activity.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.name : "outlook.exe" and
		     process.name : ("Microsoft.Workflow.Compiler.exe", "arp.exe",
		     "atbroker.exe", "bginfo.exe", "bitsadmin.exe",
		     "cdb.exe", "certutil.exe", "cmd.exe", "cmstp.exe",
		     "cscript.exe", "csi.exe", "dnx.exe", "dsget.exe",
		     "dsquery.exe", "forfiles.exe", "fsi.exe", "ftp.exe",
		     "gpresult.exe", "hostname.exe", "ieexec.exe",
		     "iexpress.exe", "installutil.exe", "ipconfig.exe", "mshta.exe",
		     "msxsl.exe", "nbtstat.exe", "net.exe",
		     "net1.exe", "netsh.exe", "netstat.exe", "nltest.exe",
		     "odbcconf.exe", "ping.exe", "powershell.exe",
		     "pwsh.exe", "qprocess.exe", "quser.exe", "qwinsta.exe",
		     "rcsi.exe", "reg.exe", "regasm.exe",
		     "regsvcs.exe", "regsvr32.exe", "sc.exe", "schtasks.exe",
		     "systeminfo.exe", "tasklist.exe",
		     "tracert.exe", "whoami.exe", "wmic.exe", "wscript.exe",
		     "xwizard.exe")

NamE: Deprecated - Sensitive Keys Or Passwords Searched For Inside A Container
	description: 
		     This rule detects the use of system search
		     utilities like grep and find to search for private SSH keys or
		     passwords inside a container. Unauthorized access to these
		     sensitive files could lead to further compromise of the
		     container environment or facilitate a container breakout to the
		     underlying host machine.
	query: 
		     process where container.id: "*" and event.type==
		     "start" and (( /*account for tools that execute utilities as a
		     subprocess, in this case the target utility name will appear as
		     a process arg*/   (process.name in ("grep", "egrep", "fgrep")
		     or process.args in ("grep", "egrep", "fgrep"))     and
		     process.args : ("*BEGIN PRIVATE*", "*BEGIN OPENSSH PRIVATE*",
		     "*BEGIN RSA PRIVATE*", "*BEGIN DSA PRIVATE*", "*BEGIN EC
		     PRIVATE*", "*pass*", "*ssh*", "*user*") ) or ( /*account for
		     tools that execute utilities as a subprocess, in this case the
		     target utility name will appear as a process arg*/
		     (process.name in ("find", "locate", "mlocate") or process.args
		     in ("find", "locate", "mlocate"))     and process.args :
		     ("*id_rsa*", "*id_dsa*") ))

NamE: Potential PowerShell Pass-the-Hash/Relay Script
	description: 
		     Detects PowerShell scripts that can execute
		     pass-the-hash (PtH) attacks, intercept and relay NTLM
		     challenges, and carry out other man-in-the-middle (MitM)
		     attacks.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (     ("NTLMSSPNegotiate"
		     and ("NegotiateSMB" or "NegotiateSMB2")) or
		     "4E544C4D53535000" or     "0x4e,0x54,0x4c,0x4d,0x53,0x53,0x50"
		     or     "0x4e,0x54,0x20,0x4c,0x4d" or
		     "0x53,0x4d,0x42,0x20,0x32" or     "0x81,0xbb,0x7a,0x36,0x44,0x9
		     8,0xf1,0x35,0xad,0x32,0x98,0xf0,0x38"   ) and   not
		     file.directory : "C:\ProgramData\Microsoft\Windows Defender
		     Advanced Threat Protection\Downloads"

NamE: GitHub Repository Deleted
	description: 
		     This rule detects when a GitHub repository is
		     deleted within your organization. Repositories are a critical
		     component used within an organization to manage work,
		     collaborate with others and release products to the public. Any
		     delete action against a repository should be investigated to
		     determine it's validity. Unauthorized deletion of organization
		     repositories could cause irreversible loss of intellectual
		     property and indicate compromise within your organization.
	query: 
		     configuration where event.module == "github" and
		     event.dataset == "github.audit" and event.action ==
		     "repo.destroy"

NamE: Process Creation via Secondary Logon
	description: 
		     Identifies process creation with alternate
		     credentials. Adversaries may create a new process with a
		     different token to escalate privileges and bypass access
		     controls.
	query: 
		     sequence by winlog.computer_name with maxspan=1m
		     [authentication where event.action:"logged-in" and
		     event.outcome == "success" and user.id : ("S-1-5-21-*",
		     "S-1-12-1-*") and   /* seclogon service */  process.name ==
		     "svchost.exe" and  winlog.event_data.LogonProcessName :
		     "seclogo*" and source.ip == "::1" ] by
		     winlog.event_data.TargetLogonId  [process where event.type ==
		     "start"] by winlog.event_data.TargetLogonId

NamE: GitHub Repo Created
	description: 
		     A new GitHub repository was created.
	query: 
		     configuration where event.dataset == "github.audit"
		     and event.action == "repo.create"

NamE: Microsoft 365 Portal Logins from Impossible Travel Locations
	description: 
		     Detects successful Microsoft 365 portal logins
		     from impossible travel locations. Impossible travel locations
		     are defined as two different countries within a short time
		     frame. This behavior may indicate an adversary attempting to
		     access a Microsoft 365 account from a compromised account or a
		     malicious actor attempting to access a Microsoft 365 account
		     from a different location.
	query: 
		     event.dataset: "o365.audit"     and event.provider:
		     "AzureActiveDirectory"     and event.action: "UserLoggedIn"
		     and event.outcome: "success"     and not o365.audit.UserId:
		     "Not Available"     and o365.audit.Target.Type: ("0" or "2" or
		     "3" or "5" or "6" or "10")

NamE: AWS STS Role Assumption by User
	description: 
		     Identifies when a user or role has assumed a
		     role in AWS Security Token Service (STS). Users can assume a
		     role to obtain temporary credentials and access AWS resources.
		     Adversaries can use this technique for credential access and
		     privilege escalation. This is a [New
		     Terms](https://www.elastic.co/guide/en/security/current/rules-
		     ui-create.html#create-new-terms-rule) rule that identifies when
		     a service assumes a role in AWS Security Token Service (STS) to
		     obtain temporary credentials and access AWS resources. While
		     often legitimate, adversaries may use this technique for
		     unauthorized access, privilege escalation, or lateral movement
		     within an AWS environment.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "sts.amazonaws.com"     and event.action:
		     "AssumeRole"     and event.outcome: "success"     and
		     aws.cloudtrail.user_identity.type: ("AssumedRole" or "IAMUser")

NamE: Kubernetes Pod Created With HostNetwork
	description: 
		     This rules detects an attempt to create or
		     modify a pod attached to the host network. HostNetwork allows a
		     pod to use the node network namespace. Doing so gives the pod
		     access to any service running on localhost of the host. An
		     attacker could use this access to snoop on network activity of
		     other pods on the same node or bypass restrictive network
		     policies applied to its given namespace.
	query: 
		     event.dataset : "kubernetes.audit_logs"   and kubernet
		     es.audit.annotations.authorization_k8s_io/decision:"allow"
		     and kubernetes.audit.objectRef.resource:"pods"   and
		     kubernetes.audit.verb:("create" or "update" or "patch")   and
		     kubernetes.audit.requestObject.spec.hostNetwork:true   and not
		     kubernetes.audit.requestObject.spec.containers.image:
		     ("docker.elastic.co/beats/elastic-agent:8.4.0")

NamE: Access to a Sensitive LDAP Attribute
	description: 
		     Identify access to sensitive Active Directory
		     object attributes that contains credentials and decryption keys
		     such as unixUserPassword, ms-PKI-AccountCredentials and msPKI-
		     CredentialRoamingTokens.
	query: 
		     any where event.code == "4662" and    not
		     winlog.event_data.SubjectUserSid : "S-1-5-18" and
		     winlog.event_data.Properties : (    /* unixUserPassword */
		     "*612cb747-c0e8-4f92-9221-fdd5f15b550d*",    /* ms-PKI-
		     AccountCredentials */
		     "*b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7*",    /*  ms-PKI-
		     DPAPIMasterKeys */   "*b3f93023-9239-4f7c-b99c-6745d87adbc2*",
		     /* msPKI-CredentialRoamingTokens */
		     "*b7ff5a38-0818-42b0-8110-d3d154c97f24*"   ) and    /*
		     Excluding noisy AccessMasks    0x0 undefined and 0x100 Control
		     Access    https://learn.microsoft.com/en-
		     us/windows/security/threat-protection/auditing/event-4662    */
		     not winlog.event_data.AccessMask in ("0x0", "0x100")

NamE: Modification of the msPKIAccountCredentials
	description: 
		     Identify the modification of the
		     msPKIAccountCredentials attribute in an Active Directory User
		     Object. Attackers can abuse the credentials roaming feature to
		     overwrite an arbitrary file for privilege escalation. ms-PKI-
		     AccountCredentials contains binary large objects (BLOBs) of
		     encrypted credential objects from the credential manager store,
		     private keys, certificates, and certificate requests.
	query: 
		     event.code:"5136" and winlog.event_data.AttributeLDAPD
		     isplayName:"msPKIAccountCredentials" and
		     winlog.event_data.OperationType:"%%14674" and   not
		     winlog.event_data.SubjectUserSid : "S-1-5-18"

NamE: Kernel Module Removal
	description: 
		     Kernel modules are pieces of code that can be
		     loaded and unloaded into the kernel upon demand. They extend
		     the functionality of the kernel without the need to reboot the
		     system. This rule identifies attempts to remove a kernel
		     module.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2") and   (     process.name == "rmmod"
		     or     (process.name == "modprobe" and process.args in ("--
		     remove", "-r"))   ) and   process.parent.name in ("sudo",
		     "bash", "dash", "ash", "sh", "tcsh", "csh", "zsh", "ksh",
		     "fish")

NamE: First Occurrence of Entra ID Auth via DeviceCode Protocol
	description: 
		     Identifies when a user is observed for the first
		     time in the last 14 days authenticating using the device code
		     authentication workflow. This authentication workflow can be
		     abused by attackers to phish users and steal access tokens to
		     impersonate the victim. By its very nature, device code should
		     only be used when logging in to devices without keyboards,
		     where it is difficult to enter emails and passwords.
	query: 
		     event.dataset:(azure.activitylogs or azure.signinlogs)
		     and (
		     azure.signinlogs.properties.authentication_protocol:deviceCode
		     or
		     azure.signinlogs.properties.original_transfer_method: "Device
		     code flow" or             azure.activitylogs.properties.authent
		     ication_protocol:deviceCode         )     and
		     event.outcome:success

NamE: Disabling User Account Control via Registry Modification
	description: 
		     User Account Control (UAC) can help mitigate the
		     impact of malware on Windows hosts. With UAC, apps and tasks
		     always run in the security context of a non-administrator
		     account, unless an administrator specifically authorizes
		     administrator-level access to the system. This rule identifies
		     registry value changes to bypass User Access Control (UAC)
		     protection.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.path :     (       "HKLM\
		     \SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System
		     \\EnableLUA",       "HKLM\\SOFTWARE\\Microsoft\\Windows\\Curren
		     tVersion\\Policies\\System\\ConsentPromptBehaviorAdmin",       
		     "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\
		     System\\PromptOnSecureDesktop",       "\\REGISTRY\\MACHINE\\SOF
		     TWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\En
		     ableLUA",       "\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Wind
		     ows\\CurrentVersion\\Policies\\System\\ConsentPromptBehaviorAdm
		     in",       "\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\
		     CurrentVersion\\Policies\\System\\PromptOnSecureDesktop",
		     "MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policie
		     s\\System\\EnableLUA",       "MACHINE\\SOFTWARE\\Microsoft\\Win
		     dows\\CurrentVersion\\Policies\\System\\ConsentPromptBehaviorAd
		     min",       "MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVers
		     ion\\Policies\\System\\PromptOnSecureDesktop"     ) and
		     registry.data.strings : ("0", "0x00000000")

NamE: AWS CloudWatch Alarm Deletion
	description: 
		     Identifies the deletion of an AWS CloudWatch
		     alarm. An adversary may delete alarms in an attempt to evade
		     defenses.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:monitoring.amazonaws.com and
		     event.action:DeleteAlarms and event.outcome:success

NamE: System V Init Script Created
	description: 
		     Files that are placed in the /etc/init.d/
		     directory in Unix can be used to start custom applications,
		     services, scripts or commands during start-up. Init.d has been
		     mostly replaced in favor of Systemd. However, the "systemd-
		     sysv-generator" can convert init.d files to service unit files
		     that run at boot. Adversaries may add or alter files located in
		     the /etc/init.d/ directory to execute malicious code upon boot
		     in order to gain persistence on the system.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("creation", "file_create_event", "rename",
		     "file_rename_event") and file.path : "/etc/init.d/*" and not (
		     process.executable in (     "/bin/dpkg", "/usr/bin/dpkg",
		     "/bin/dockerd", "/usr/bin/dockerd", "/usr/sbin/dockerd",
		     "/bin/microdnf",     "/usr/bin/microdnf", "/bin/rpm",
		     "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd", "/bin/yum",
		     "/usr/bin/yum",     "/bin/dnf", "/usr/bin/dnf", "/bin/podman",
		     "/usr/bin/podman", "/bin/dnf-automatic", "/usr/bin/dnf-
		     automatic",     "/bin/pacman", "/usr/bin/pacman",
		     "/usr/bin/dpkg-divert", "/bin/dpkg-divert", "/sbin/apk",
		     "/usr/sbin/apk",     "/usr/local/sbin/apk", "/usr/bin/apt",
		     "/usr/sbin/pacman", "/bin/podman", "/usr/bin/podman",
		     "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/lib/snapd/snapd", "/usr/local/bin/dockerd"   ) or
		     file.extension in ("swp", "swpx", "swx", "dpkg-remove", "dpkg-
		     new") or   file.path like ("/etc/init.d/*beat*",
		     "/etc/init.d/elastic-agent*") or   process.executable like
		     ("/nix/store/*", "/var/lib/dpkg/*", "/snap/*", "/dev/fd/*",
		     "/usr/lib/virtualbox/*", "/opt/puppetlabs/puppet/bin/ruby") or
		     process.name in ("docker-init", "jumpcloud-agent", "crio") or
		     process.executable == null or   process.name in ("executor",
		     "univention-config-registry", "install", "dockerd-
		     entrypoint.sh", "platform-python*", "ssm-agent-worker") or
		     (process.name == "ln" and file.path : "/etc/init.d/rc*.d/*") or
		     (process.name == "sed" and file.name : "sed*") or
		     (process.name == "perl" and file.name : "e2scrub_all.tmp*")  )

NamE: LaunchDaemon Creation or Modification and Immediate Loading
	description: 
		     Indicates the creation or modification of a
		     launch daemon, which adversaries may use to repeatedly execute
		     malicious payloads as part of persistence.
	query: 
		     sequence by host.id with maxspan=1m  [file where
		     host.os.type == "macos" and event.type != "deletion" and
		     file.path : ("/System/Library/LaunchDaemons/*",
		     "/Library/LaunchDaemons/*")]  [process where host.os.type ==
		     "macos" and event.type in ("start", "process_started") and
		     process.name == "launchctl" and process.args == "load"]

NamE: Kubernetes Denied Service Account Request
	description: 
		     This rule detects when a service account makes
		     an unauthorized request for resources from the API server.
		     Service accounts follow a very predictable pattern of behavior.
		     A service account should never send an unauthorized request to
		     the API server. This behavior is likely an indicator of
		     compromise or of a problem within the cluster. An adversary may
		     have gained access to credentials/tokens and this could be an
		     attempt to access or create resources to facilitate further
		     movement or execution within the cluster.
	query: 
		     event.dataset: "kubernetes.audit_logs"   and
		     kubernetes.audit.user.username: system\:serviceaccount\:*   and
		     kubernetes.audit.annotations.authorization_k8s_io/decision:
		     "forbid"

NamE: Attempt to Modify an Okta Policy Rule
	description: 
		     Detects attempts to modify a rule within an Okta
		     policy. An adversary may attempt to modify an Okta policy rule
		     in order to weaken an organization's security controls.
	query: 
		     event.dataset:okta.system and
		     event.action:policy.rule.update

NamE: Microsoft 365 User Restricted from Sending Email
	description: 
		     Identifies when a user has been restricted from
		     sending email due to exceeding sending limits of the service
		     policies per the Security Compliance Center.
	query: 
		     event.dataset:o365.audit and
		     event.provider:SecurityComplianceCenter and event.category:web
		     and event.action:"User restricted from sending email" and
		     event.outcome:success

NamE: Segfault Detected
	description: 
		     Monitors kernel logs for segfault messages. A
		     segfault, or segmentation fault, is an error that occurs when a
		     program tries to access a memory location that it's not allowed
		     to access, typically leading to program termination. A segfault
		     can be an indication of malicious behavior if it results from
		     attempts to exploit buffer overflows or other vulnerabilities
		     in software to execute arbitrary code or disrupt its normal
		     operation.
	query: 
		     host.os.type:linux and event.dataset:"system.syslog"
		     and process.name:kernel and message:segfault

NamE: Azure Network Watcher Deletion
	description: 
		     Identifies the deletion of a Network Watcher in
		     Azure. Network Watchers are used to monitor, diagnose, view
		     metrics, and enable or disable logs for resources in an Azure
		     virtual network. An adversary may delete a Network Watcher in
		     an attempt to evade defenses.
	query: 
		     event.dataset:azure.activitylogs and azure.activitylog
		     s.operation_name:"MICROSOFT.NETWORK/NETWORKWATCHERS/DELETE" and
		     event.outcome:(Success or success)

NamE: Deprecated - Container Management Utility Run Inside A Container
	description: 
		     This rule detects when a container management
		     binary is run from inside a container. These binaries are
		     critical components of many containerized environments, and
		     their presence and execution in unauthorized containers could
		     indicate compromise or a misconfiguration.
	query: 
		     process where container.id: "*" and event.type==
		     "start"   and process.name: ("dockerd", "docker", "kubelet",
		     "kube-proxy", "kubectl", "containerd", "runc", "systemd",
		     "crictl")

NamE: AWS SNS Email Subscription by Rare User
	description: 
		     Identifies when an SNS topic is subscribed to by
		     an email address of a user who does not typically perform this
		     action. Adversaries may subscribe to an SNS topic to collect
		     sensitive information or exfiltrate data via an external email
		     address.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "sns.amazonaws.com"     and event.action:
		     "Subscribe"     and aws.cloudtrail.request_parameters:
		     *protocol=email*

NamE: Azure Event Hub Authorization Rule Created or Updated
	description: 
		     Identifies when an Event Hub Authorization Rule
		     is created or updated in Azure. An authorization rule is
		     associated with specific rights, and carries a pair of
		     cryptographic keys. When you create an Event Hubs namespace, a
		     policy rule named RootManageSharedAccessKey is created for the
		     namespace. This has manage permissions for the entire namespace
		     and it's recommended that you treat this rule like an
		     administrative root account and don't use it in your
		     application.
	query: 
		     event.dataset:azure.activitylogs and azure.activitylog
		     s.operation_name:"MICROSOFT.EVENTHUB/NAMESPACES/AUTHORIZATIONRU
		     LES/WRITE" and event.outcome:(Success or success)

NamE: WMI Incoming Lateral Movement
	description: 
		     Identifies processes executed via Windows
		     Management Instrumentation (WMI) on a remote host. This could
		     be indicative of adversary lateral movement, but could be noisy
		     if administrators use WMI to remotely manage hosts.
	query: 
		     sequence by host.id with maxspan = 2s   /* Accepted
		     Incoming RPC connection by Winmgmt service */    [network where
		     host.os.type == "windows" and process.name : "svchost.exe" and
		     network.direction : ("incoming", "ingress") and    source.ip !=
		     "127.0.0.1" and source.ip != "::1" and source.port >= 49152 and
		     destination.port >= 49152   ]    /* Excluding Common FPs Nessus
		     and SCCM */    [process where host.os.type == "windows" and
		     event.type == "start" and process.parent.name : "WmiPrvSE.exe"
		     and    not (?process.Ext.token.integrity_level_name : "System"
		     or ?winlog.event_data.IntegrityLevel : "System") and    not (
		     user.id : ("S-1-5-18", "S-1-5-19", "S-1-5-20") and          /*
		     Don't apply the user.id exclusion to Sysmon for compatibility
		     */          not event.dataset : ("windows.sysmon_operational",
		     "windows.sysmon")    ) and    not process.executable :
		     ("?:\\Program Files\\HPWBEM\\Tools\\hpsum_swdiscovery.exe",
		     "?:\\Windows\\CCM\\Ccm32BitLauncher.exe",
		     "?:\\Windows\\System32\\wbem\\mofcomp.exe",
		     "?:\\Windows\\Microsoft.NET\\Framework*\\csc.exe",
		     "?:\\Windows\\System32\\powercfg.exe") and    not
		     (process.executable : "?:\\Windows\\System32\\msiexec.exe" and
		     process.args : "REBOOT=ReallySuppress") and    not
		     (process.executable :
		     "?:\\Windows\\System32\\inetsrv\\appcmd.exe" and process.args :
		     "uninstall")    ]

NamE: Unusual Network Connection via DllHost
	description: 
		     Identifies unusual instances of dllhost.exe
		     making outbound network connections. This may indicate
		     adversarial Command and Control activity.
	query: 
		     sequence by host.id, process.entity_id with maxspan=1m
		     [process where host.os.type == "windows" and event.type ==
		     "start" and process.name : "dllhost.exe" and process.args_count
		     == 1]   [network where host.os.type == "windows" and
		     process.name : "dllhost.exe" and    not
		     cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8",
		     "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24",
		     "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32",
		     "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32",
		     "192.0.2.0/24",     "192.31.196.0/24", "192.52.193.0/24",
		     "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4",
		     "100.64.0.0/10",     "192.175.48.0/24", "198.18.0.0/15",
		     "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1",
		     "FE80::/10",     "FF00::/8")]

NamE: Creation or Modification of Pluggable Authentication Module or Configuration
	description: 
		     This rule monitors for the creation or
		     modification of Pluggable Authentication Module (PAM) shared
		     object files or configuration files. Attackers may create or
		     modify these files to maintain persistence on a compromised
		     system, or harvest account credentials.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("rename", "creation") and process.executable != null and (
		     (file.path like~ (     "/lib/security/*", "/lib64/security/*",
		     "/usr/lib/security/*", "/usr/lib64/security/*",
		     "/lib/x86_64-linux-gnu/security/*", "/usr/lib/x86_64-linux-
		     gnu/security/*"   ) and file.extension == "so") or   (file.path
		     like~ "/etc/pam.d/*" and file.extension == null) or
		     (file.path like~ "/etc/security/pam_*" or file.path ==
		     "/etc/pam.conf") ) and not (   process.executable in (
		     "/bin/dpkg", "/usr/bin/dpkg", "/bin/dockerd",
		     "/usr/bin/dockerd", "/usr/sbin/dockerd", "/bin/microdnf",
		     "/usr/bin/microdnf", "/bin/rpm", "/usr/bin/rpm", "/bin/snapd",
		     "/usr/bin/snapd", "/bin/yum", "/usr/bin/yum",     "/bin/dnf",
		     "/usr/bin/dnf", "/bin/podman", "/usr/bin/podman", "/bin/dnf-
		     automatic", "/usr/bin/dnf-automatic",     "/bin/pacman",
		     "/usr/bin/pacman", "/usr/bin/dpkg-divert", "/bin/dpkg-divert",
		     "/sbin/apk", "/usr/sbin/apk",     "/usr/local/sbin/apk",
		     "/usr/bin/apt", "/usr/sbin/pacman", "/bin/podman",
		     "/usr/bin/podman", "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/lib/snapd/snapd", "/usr/local/bin/dockerd",
		     "/usr/sbin/pam-auth-update",     "/usr/lib/systemd/systemd",
		     "/usr/libexec/packagekitd", "/usr/bin/bsdtar", "/sbin/pam-auth-
		     update"   ) or   file.path like (
		     "/tmp/snap.rootfs_*/pam_*.so", "/tmp/newroot/lib/*/pam_*.so",
		     "/tmp/newroot/usr/lib64/security/pam_*.so"   ) or
		     file.extension in ("swp", "swpx", "swx", "dpkg-remove") or
		     file.Ext.original.extension == "dpkg-new" or
		     process.executable like (     "/nix/store/*",
		     "/var/lib/dpkg/*", "/snap/*", "/dev/fd/*",
		     "/usr/lib/virtualbox/*"   ) or   (process.name == "sed" and
		     file.name like~ "sed*") or   (process.name == "perl" and
		     file.name like~ "e2scrub_all.tmp*") )

NamE: Namespace Manipulation Using Unshare
	description: 
		     Identifies suspicious usage of unshare to
		     manipulate system namespaces. Unshare can be utilized to
		     escalate privileges or escape container security boundaries.
		     Threat actors have utilized this binary to allow themselves to
		     escape to the host and access other resources or escalate
		     privileges.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action : ("exec", "exec_event", "start")
		     and process.executable: "/usr/bin/unshare" and not
		     process.parent.executable: ("/usr/bin/udevadm",
		     "*/lib/systemd/systemd-udevd", "/usr/bin/unshare") and not
		     process.args == "/usr/bin/snap" and not process.parent.name in
		     ("zz-proxmox-boot", "java")

NamE: Unusual Parent Process for cmd.exe
	description: 
		     Identifies a suspicious parent child process
		     relationship with cmd.exe descending from an unusual process.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : "cmd.exe" and
		     process.parent.name : ("lsass.exe",
		     "csrss.exe",                          "epad.exe",
		     "regsvr32.exe",                          "dllhost.exe",
		     "LogonUI.exe",                          "wermgr.exe",
		     "spoolsv.exe",                          "jucheck.exe",
		     "jusched.exe",                          "ctfmon.exe",
		     "taskhostw.exe",                          "GoogleUpdate.exe",
		     "sppsvc.exe",                          "sihost.exe",
		     "slui.exe",                          "SIHClient.exe",
		     "SearchIndexer.exe",
		     "SearchProtocolHost.exe",
		     "FlashPlayerUpdateService.exe",
		     "WerFault.exe",                          "WUDFHost.exe",
		     "unsecapp.exe",                          "wlanext.exe" ) and
		     not (process.parent.name : "dllhost.exe" and
		     process.parent.args : "/Processid:{CA8C87C1-929D-45BA-94DB-
		     EF8E6CB346AD}")

NamE: Suspicious Hidden Child Process of Launchd
	description: 
		     Identifies the execution of a launchd child
		     process with a hidden file. An adversary can establish
		     persistence by installing a new logon item, launch agent, or
		     daemon that executes upon login.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:(start or process_started) and  process.name:.* and
		     process.parent.executable:/sbin/launchd

NamE: Network Connection via Sudo Binary
	description: 
		     Detects network connections initiated by the
		     "sudo" binary. This behavior is uncommon and may occur in
		     instances where reverse shell shellcode is injected into a
		     process run with elevated permissions via "sudo". Attackers may
		     attempt to inject shellcode into processes running as root, to
		     escalate privileges.
	query: 
		     sequence by host.id, process.entity_id with maxspan=5s
		     [process where host.os.type == "linux" and event.type ==
		     "start" and event.action == "exec"]   [network where
		     host.os.type == "linux" and event.type == "start" and
		     event.action in ("connection_attempted",
		     "ipv4_connection_attempt_event") and process.name == "sudo" and
		     not (     destination.ip == null or destination.ip == "0.0.0.0"
		     or cidrmatch(       destination.ip, "10.0.0.0/8",
		     "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12",
		     "192.0.0.0/24", "192.0.0.0/29",       "192.0.0.8/32",
		     "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32",
		     "192.0.0.171/32", "192.0.2.0/24",       "192.31.196.0/24",
		     "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24",
		     "224.0.0.0/4", "100.64.0.0/10",
		     "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24",
		     "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10",
		     "FF00::/8", "172.31.0.0/16"     )   )]

NamE: Windows Network Enumeration
	description: 
		     Identifies attempts to enumerate hosts in a
		     network using the built-in Windows net.exe tool.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   ((process.name : "net.exe" or
		     process.pe.original_file_name == "net.exe") or
		     ((process.name : "net1.exe" or process.pe.original_file_name ==
		     "net1.exe") and        not process.parent.name : "net.exe"))
		     and   (process.args : "view" or (process.args : "time" and
		     process.args : "\\\\*")) and   not process.command_line : "net
		     view \\\\localhost "     /* expand when ancestry is available
		     and not descendant of [process where event.type == "start" and
		     process.name : "cmd.exe" and
		     ((process.parent.name : "userinit.exe") or
		     (process.parent.name : "gpscript.exe") or
		     (process.parent.name : "explorer.exe" and
		     process.args : "C:\\*\\Start
		     Menu\\Programs\\Startup\\*.bat*"))]   */

NamE: AdFind Command Activity
	description: 
		     This rule detects the Active Directory query
		     tool, AdFind.exe. AdFind has legitimate purposes, but it is
		     frequently leveraged by threat actors to perform post-
		     exploitation Active Directory reconnaissance. The AdFind tool
		     has been observed in Trickbot, Ryuk, Maze, and FIN6 campaigns.
		     For Winlogbeat, this rule requires Sysmon.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (process.name : "AdFind*.exe" or
		     ?process.pe.original_file_name == "AdFind.exe") and
		     process.args : ("objectcategory=computer",
		     "(objectcategory=computer)",
		     "objectcategory=person", "(objectcategory=person)",
		     "objectcategory=subnet", "(objectcategory=subnet)",
		     "objectcategory=group", "(objectcategory=group)",
		     "objectcategory=organizationalunit",
		     "(objectcategory=organizationalunit)",
		     "objectcategory=attributeschema",
		     "(objectcategory=attributeschema)",
		     "domainlist", "dcmodes", "adinfo", "dclist",
		     "computers_pwnotreqd", "trustdmp")

NamE: Potential SSH-IT SSH Worm Downloaded
	description: 
		     Identifies processes that are capable of
		     downloading files with command line arguments containing URLs
		     to SSH-IT's autonomous SSH worm. This worm intercepts outgoing
		     SSH connections every time a user uses ssh.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and  event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed", "process_started") and
		     process.name in ("curl", "wget") and process.args : (
		     "https://thc.org/ssh-it/x", "http://nossl.segfault.net/ssh-it-
		     deploy.sh", "https://gsocket.io/x",   "https://thc.org/ssh-
		     it/bs", "http://nossl.segfault.net/bs" )

NamE: Unusual Preload Environment Variable Process Execution
	description: 
		     This rule detects processes that are executed
		     with environment variables that are not commonly used. This
		     could indicate an attacker is attempting to hijack the
		     execution flow of a process by loading malicious libraries or
		     binaries into the process memory space.
	query: 
		     event.category:process and host.os.type:linux and
		     event.type:start and event.action:exec and process.env_vars:*

NamE: EC2 AMI Shared with Another Account
	description: 
		     Identifies an AWS Amazon Machine Image (AMI)
		     being shared with another AWS account. Adversaries with access
		     may share an AMI with an external AWS account as a means of
		     data exfiltration. AMIs can contain secrets, bash histories,
		     code artifacts, and other sensitive data that adversaries may
		     abuse if shared with unauthorized accounts. AMIs can be made
		     publicly available accidentally as well.
	query: 
		     event.dataset: "aws.cloudtrail" and event.provider:
		     "ec2.amazonaws.com"     and event.action: ModifyImageAttribute
		     and event.outcome: success     and
		     aws.cloudtrail.request_parameters: (*imageId* and *add* and
		     *userId*)

NamE: Google Workspace Password Policy Modified
	description: 
		     Detects when a Google Workspace password policy
		     is modified. An adversary may attempt to modify a password
		     policy in order to weaken an organization’s security controls.
	query: 
		     event.dataset:google_workspace.admin and
		     event.provider:admin and event.category:iam and
		     event.action:(CHANGE_APPLICATION_SETTING or
		     CREATE_APPLICATION_SETTING) and
		     google_workspace.admin.setting.name:(     "Password Management
		     - Enforce strong password" or     "Password Management -
		     Password reset frequency" or     "Password Management - Enable
		     password reuse" or     "Password Management - Enforce password
		     policy at next login" or     "Password Management - Minimum
		     password length" or     "Password Management - Maximum password
		     length"   )

NamE: Adversary Behavior - Detected - Elastic Endgame
	description: 
		     Elastic Endgame detected an Adversary Behavior.
		     Click the Elastic Endgame icon in the event.module column or
		     the link in the rule.reference column for additional
		     information.
	query: 
		     event.kind:alert and event.module:endgame and
		     (event.action:behavior_protection_event or
		     endgame.event_subtype_full:behavior_protection_event)

NamE: AWS CloudWatch Log Stream Deletion
	description: 
		     Identifies the deletion of an AWS CloudWatch log
		     stream, which permanently deletes all associated archived log
		     events with the stream.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:logs.amazonaws.com and
		     event.action:DeleteLogStream and event.outcome:success

NamE: Potential Linux Credential Dumping via Proc Filesystem
	description: 
		     Identifies the execution of the mimipenguin
		     exploit script which is linux adaptation of Windows tool
		     mimikatz. Mimipenguin exploit script is used to dump clear text
		     passwords from a currently logged-in user. The tool exploits a
		     known vulnerability CVE-2018-20781. Malicious actors can
		     exploit the cleartext credentials in memory by dumping the
		     process and extracting lines that have a high probability of
		     containing cleartext passwords.
	query: 
		     sequence by host.id, process.parent.name with
		     maxspan=1m   [process where host.os.type == "linux" and
		     process.name == "ps" and event.action in ("exec", "start",
		     "exec_event")    and process.args in ("-eo", "pid", "command")]
		     [process where host.os.type == "linux" and process.name ==
		     "strings" and event.action in ("exec", "start", "exec_event")
		     and process.args : "/tmp/*"]

NamE: Potential Privilege Escalation via OverlayFS
	description: 
		     Identifies an attempt to exploit a local
		     privilege escalation (CVE-2023-2640 and CVE-2023-32629) via a
		     flaw in Ubuntu's modifications to OverlayFS. These flaws allow
		     the creation of specialized executables, which, upon execution,
		     grant the ability to escalate privileges to root on the
		     affected machine.
	query: 
		     sequence by process.parent.entity_id, host.id with
		     maxspan=5s   [process where host.os.type == "linux" and
		     event.type == "start" and event.action == "exec" and
		     process.name == "unshare" and process.args : ("-r", "-rm", "m")
		     and process.args : "*cap_setuid*"  and user.id != "0"]
		     [process where host.os.type == "linux" and event.action ==
		     "uid_change" and event.type == "change" and     user.id == "0"]

NamE: Incoming DCOM Lateral Movement via MSHTA
	description: 
		     Identifies the use of Distributed Component
		     Object Model (DCOM) to execute commands from a remote host,
		     which are launched via the HTA Application COM Object. This
		     behavior may indicate an attacker abusing a DCOM application to
		     move laterally while attempting to evade detection.
	query: 
		     sequence with maxspan=1m   [process where host.os.type
		     == "windows" and event.type == "start" and      process.name :
		     "mshta.exe" and process.args : "-Embedding"   ] by host.id,
		     process.entity_id   [network where host.os.type == "windows"
		     and event.type == "start" and process.name : "mshta.exe" and
		     network.direction : ("incoming", "ingress") and
		     network.transport == "tcp" and      source.port > 49151 and
		     destination.port > 49151 and source.ip != "127.0.0.1" and
		     source.ip != "::1"   ] by host.id, process.entity_id

NamE: Dynamic Linker (ld.so) Creation
	description: 
		     This rule detects the creation of the dynamic
		     linker (ld.so) file. The dynamic linker is used to load shared
		     libraries needed by an executable. Attackers may attempt to
		     replace the dynamic linker with a malicious version to execute
		     arbitrary code.
	query: 
		     file where host.os.type == "linux" and event.type ==
		     "creation" and process.executable != null and file.path like~
		     ("/lib/ld-linux*.so*", "/lib64/ld-linux*.so*", "/usr/lib/ld-
		     linux*.so*", "/usr/lib64/ld-linux*.so*") and not process.name
		     in ("dockerd", "yum", "dnf", "microdnf", "pacman")

NamE: Suspicious WMI Image Load from MS Office
	description: 
		     Identifies a suspicious image load
		     (wmiutils.dll) from Microsoft Office processes. This behavior
		     may indicate adversarial activity where child processes are
		     spawned via Windows Management Instrumentation (WMI). This
		     technique can be used to execute code and evade traditional
		     parent/child processes spawned from Microsoft Office products.
	query: 
		     any where host.os.type == "windows" and
		     (event.category : ("library", "driver") or (event.category ==
		     "process" and event.action : "Image loaded*")) and
		     process.name : ("WINWORD.EXE", "EXCEL.EXE", "POWERPNT.EXE",
		     "MSPUB.EXE", "MSACCESS.EXE") and   (?dll.name : "wmiutils.dll"
		     or file.name : "wmiutils.dll")

NamE: Attempt to Disable Gatekeeper
	description: 
		     Detects attempts to disable Gatekeeper on macOS.
		     Gatekeeper is a security feature that's designed to ensure that
		     only trusted software is run. Adversaries may attempt to
		     disable Gatekeeper before executing malicious code.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:(start or process_started) and   process.args:(spctl
		     and "--master-disable")

NamE: Sensitive Registry Hive Access via RegBack
	description: 
		     Identifies attempts to access sensitive registry
		     hives which contain credentials from the registry backup
		     folder.
	query: 
		     file where host.os.type == "windows" and
		     event.action == "open" and event.outcome == "success" and
		     process.executable != null and   file.path :
		     ("?:\\Windows\\System32\\config\\RegBack\\SAM",
		     "?:\\Windows\\System32\\config\\RegBack\\SECURITY",
		     "?:\\Windows\\System32\\config\\RegBack\\SYSTEM") and   not (
		     user.id == "S-1-5-18" and process.executable : (
		     "?:\\Windows\\system32\\taskhostw.exe",
		     "?:\\Windows\\system32\\taskhost.exe"     ))

NamE: Docker Socket Enumeration
	description: 
		     This rule detects potential Docker socket
		     enumeration activity by monitoring processes that attempt to
		     interact with the Docker socket file (/var/run/docker.sock).
		     Docker socket enumeration is a common technique used by
		     attackers to interact with the Docker daemon and perform
		     various operations, such as creating, starting, stopping, and
		     removing containers. Attackers may abuse Docker socket
		     enumeration to gain unauthorized access to the host system,
		     escalate privileges, or move laterally within the environment.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed", "process_started") and
		     process.name in ("curl", "socat", "nc", "netcat", "ncat",
		     "nc.traditional") and process.command_line like
		     ("*/var/run/docker.sock*", "*/run/docker.sock*")

NamE: Potential OpenSSH Backdoor Logging Activity
	description: 
		     Identifies a Secure Shell (SSH) client or server
		     process creating or writing to a known SSH backdoor log file.
		     Adversaries may modify SSH related binaries for persistence or
		     credential access via patching sensitive functions to enable
		     unauthorized access or to log SSH credentials for exfiltration.
	query: 
		     file where host.os.type == "linux" and event.type ==
		     "change" and process.executable : ("/usr/sbin/sshd",
		     "/usr/bin/ssh") and   (     (file.name : (".*", "~*", "*~") and
		     not file.name : (".cache", ".viminfo", ".bash_history",
		     ".google_authenticator",       ".jelenv", ".csvignore",
		     ".rtreport")) or     file.extension : ("in", "out", "ini", "h",
		     "gz", "so", "sock", "sync", "0", "1", "2", "3", "4", "5", "6",
		     "7", "8", "9") or     file.path :     (
		     "/private/etc/*--",       "/usr/share/*",
		     "/usr/include/*",       "/usr/local/include/*",
		     "/private/tmp/*",       "/private/var/tmp/*",
		     "/usr/tmp/*",       "/usr/share/man/*",
		     "/usr/local/share/*",       "/usr/lib/*.so.*",
		     "/private/etc/ssh/.sshd_auth",       "/usr/bin/ssd",
		     "/private/var/opt/power",
		     "/private/etc/ssh/ssh_known_hosts",
		     "/private/var/html/lol",       "/private/var/log/utmp",
		     "/private/var/lib",       "/var/run/sshd/sshd.pid",
		     "/var/run/nscd/ns.pid",       "/var/run/udev/ud.pid",
		     "/var/run/udevd.pid"     )   )

NamE: DNF Package Manager Plugin File Creation
	description: 
		     Detects file creation events in the plugin
		     directories for the Yum package manager. In Linux, DNF
		     (Dandified YUM) is a command-line utility used for handling
		     packages on Fedora-based systems, providing functions for
		     installing, updating, upgrading, and removing software along
		     with managing package repositories. Attackers can backdoor DNF
		     to gain persistence by injecting malicious code into plugins
		     that DNF runs, thereby ensuring continued unauthorized access
		     or control each time DNF is used for package management.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("rename", "creation") and file.path : ("/usr/lib/python*/site-
		     packages/dnf-plugins/*", "/etc/dnf/plugins/*") and not (
		     process.executable in (     "/bin/dockerd", "/usr/bin/dockerd",
		     "/usr/sbin/dockerd", "/bin/microdnf", "/usr/bin/microdnf",
		     "/bin/rpm",     "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd",
		     "/bin/yum", "/usr/bin/yum", "/bin/dnf", "/usr/bin/dnf",
		     "/bin/podman", "/usr/bin/podman", "/bin/dnf-automatic",
		     "/usr/bin/dnf-automatic", "/sbin/apk", "/usr/sbin/apk",
		     "/usr/local/sbin/apk", "/bin/podman", "/usr/bin/podman",
		     "/usr/bin/puppet", "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client", "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/lib/snapd/snapd", "/usr/local/bin/dockerd",
		     "/usr/libexec/netplan/generate"   ) or   file.extension in
		     ("swp", "swpx", "swx") or   process.executable : (
		     "/nix/store/*", "/var/lib/dpkg/*", "/tmp/vmis.*", "/snap/*",
		     "/dev/fd/*", "/usr/lib/*", "/usr/libexec/*",
		     "/etc/kernel/*"   ) or   process.executable == null or
		     (process.name == "sed" and file.name : "sed*") or
		     (process.name == "perl" and file.name : "e2scrub_all.tmp*") or
		     file.path like~ "/etc/dnf/plugins/.ansible_tmp*" or
		     process.name like~ ("ssm-agent-worker, NinjaOrbit", "python*")
		     )

NamE: Application Added to Google Workspace Domain
	description: 
		     Detects when a Google marketplace application is
		     added to the Google Workspace domain. An adversary may add a
		     malicious application to an organization’s Google Workspace
		     domain in order to maintain a presence in their target’s
		     organization and steal data.
	query: 
		     event.dataset:google_workspace.admin and
		     event.provider:admin and event.category:iam and
		     event.action:ADD_APPLICATION

NamE: AWS S3 Bucket Configuration Deletion
	description: 
		     Identifies the deletion of various Amazon Simple
		     Storage Service (S3) bucket configuration components.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:s3.amazonaws.com and
		     event.action:(DeleteBucketPolicy or DeleteBucketReplication or
		     DeleteBucketCors or                 DeleteBucketEncryption or
		     DeleteBucketLifecycle)   and event.outcome:success

NamE: GCP Firewall Rule Deletion
	description: 
		     Identifies when a firewall rule is deleted in
		     Google Cloud Platform (GCP) for Virtual Private Cloud (VPC) or
		     App Engine. These firewall rules can be configured to allow or
		     deny connections to or from virtual machine (VM) instances or
		     specific applications. An adversary may delete a firewall rule
		     in order to weaken their target's security controls.
	query: 
		     event.dataset:gcp.audit and
		     event.action:(*.compute.firewalls.delete or
		     google.appengine.*.Firewall.Delete*Rule)

NamE: Enumeration of Kernel Modules via Proc
	description: 
		     Loadable Kernel Modules (or LKMs) are pieces of
		     code that can be loaded and unloaded into the kernel upon
		     demand. They extend the functionality of the kernel without the
		     need to reboot the system. This identifies attempts to
		     enumerate information about a kernel module using the
		     /proc/modules filesystem. This filesystem is used by utilities
		     such as lsmod and kmod to list the available kernel modules.
	query: 
		     host.os.type:linux and event.category:file and
		     event.action:"opened-file" and file.path:"/proc/modules" and
		     not process.name:(python* or chef-client)

NamE: Google Workspace Bitlocker Setting Disabled
	description: 
		     Google Workspace administrators whom manage
		     Windows devices and have Windows device management enabled may
		     also enable BitLocker drive encryption to mitigate unauthorized
		     data access on lost or stolen computers. Adversaries with valid
		     account access may disable BitLocker to access sensitive data
		     on an endpoint added to Google Workspace device management.
	query: 
		     event.dataset:"google_workspace.admin" and
		     event.action:"CHANGE_APPLICATION_SETTING" and
		     event.category:(iam or configuration)     and
		     google_workspace.admin.new_value:"Disabled" and
		     google_workspace.admin.setting.name:BitLocker*

NamE: Credential Manipulation - Prevented - Elastic Endgame
	description: 
		     Elastic Endgame prevented Credential
		     Manipulation. Click the Elastic Endgame icon in the
		     event.module column or the link in the rule.reference column
		     for additional information.
	query: 
		     event.kind:alert and event.module:endgame and
		     endgame.metadata.type:prevention and
		     (event.action:token_manipulation_event or
		     endgame.event_subtype_full:token_manipulation_event)

NamE: Unusual High Word Policy Blocks Detected
	description: 
		     Detects repeated compliance violation 'BLOCKED'
		     actions coupled with specific policy name such as
		     'word_policy', indicating persistent misuse or attempts to
		     probe the model's denied topics.
	query: 
		     from logs-aws_bedrock.invocation-* | MV_EXPAND
		     gen_ai.policy.name | where gen_ai.policy.action == "BLOCKED"
		     and gen_ai.compliance.violation_detected == "true" and
		     gen_ai.policy.name == "word_policy" | keep user.id | stats
		     profanity_words= count() by user.id | where profanity_words > 5
		     | sort profanity_words desc

NamE: Process Injection - Detected - Elastic Endgame
	description: 
		     Elastic Endgame detected Process Injection.
		     Click the Elastic Endgame icon in the event.module column or
		     the link in the rule.reference column for additional
		     information.
	query: 
		     event.kind:alert and event.module:endgame and
		     endgame.metadata.type:detection and
		     (event.action:kernel_shellcode_event or
		     endgame.event_subtype_full:kernel_shellcode_event)

NamE: AWS IAM Login Profile Added to User
	description: 
		     Identifies when an AWS IAM login profile is
		     added to a user. Adversaries may add a login profile to an IAM
		     user who typically does not have one and is used only for
		     programmatic access. This can be used to maintain access to the
		     account even if the original access key is rotated or disabled.
		     This is a building block rule and does not generate alerts on
		     its own. It is meant to be used for correlation with other
		     rules to detect suspicious activity.
	query: 
		     event.dataset: aws.cloudtrail and event.provider:
		     "iam.amazonaws.com"     and event.action: "CreateLoginProfile"
		     and event.outcome: success

NamE: Route53 Resolver Query Log Configuration Deleted
	description: 
		     Identifies when a Route53 Resolver Query Log
		     Configuration is deleted. When a Route53 Resolver query log
		     configuration is deleted, Resolver stops logging DNS queries
		     and responses for the specified configuration. Adversaries may
		     delete query log configurations to evade detection or cover
		     their tracks.
	query: 
		     event.dataset:aws.cloudtrail and event.provider:
		     route53resolver.amazonaws.com     and event.action:
		     DeleteResolverQueryLogConfig and event.outcome: success

NamE: AWS Root Login Without MFA
	description: 
		     Identifies attempts to login to AWS as the root
		     user without using multi-factor authentication (MFA). Amazon
		     AWS best practices indicate that the root user should be
		     protected by MFA.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:signin.amazonaws.com and
		     event.action:ConsoleLogin and
		     aws.cloudtrail.user_identity.type:Root and   aws.cloudtrail.con
		     sole_login.additional_eventdata.mfa_used:false and
		     event.outcome:success

NamE: AWS EC2 Encryption Disabled
	description: 
		     Identifies disabling of Amazon Elastic Block
		     Store (EBS) encryption by default in the current region.
		     Disabling encryption by default does not change the encryption
		     status of your existing volumes.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:ec2.amazonaws.com and
		     event.action:DisableEbsEncryptionByDefault and
		     event.outcome:success

NamE: AWS EC2 Network Access Control List Creation
	description: 
		     Identifies the creation of an AWS Elastic
		     Compute Cloud (EC2) network access control list (ACL) or an
		     entry in a network ACL with a specified rule number.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:ec2.amazonaws.com and
		     event.action:(CreateNetworkAcl or CreateNetworkAclEntry) and
		     event.outcome:success

NamE: Domain Added to Google Workspace Trusted Domains
	description: 
		     Detects when a domain is added to the list of
		     trusted Google Workspace domains. An adversary may add a
		     trusted domain in order to collect and exfiltrate data from
		     their target’s organization with less restrictive security
		     controls.
	query: 
		     event.dataset:google_workspace.admin and
		     event.provider:admin and event.category:iam and
		     event.action:ADD_TRUSTED_DOMAINS

NamE: AWS Route53 private hosted zone associated with a VPC
	description: 
		     Identifies when a Route53 private hosted zone
		     has been associated with VPC.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:route53.amazonaws.com and
		     event.action:AssociateVPCWithHostedZone and
		     event.outcome:success

NamE: Unusual High Confidence Content Filter Blocks Detected
	description: 
		     Detects repeated high-confidence 'BLOCKED'
		     actions coupled with specific 'Content Filter' policy violation
		     having codes such as 'MISCONDUCT', 'HATE', 'SEXUAL', INSULTS',
		     'PROMPT_ATTACK', 'VIOLENCE' indicating persistent misuse or
		     attempts to probe the model's ethical boundaries.
	query: 
		     from logs-aws_bedrock.invocation-* | MV_EXPAND
		     gen_ai.compliance.violation_code | MV_EXPAND
		     gen_ai.policy.confidence | MV_EXPAND gen_ai.policy.name | where
		     gen_ai.policy.action == "BLOCKED" and gen_ai.policy.name ==
		     "content_policy" and gen_ai.policy.confidence LIKE "HIGH" and
		     gen_ai.compliance.violation_code IN ("HATE", "MISCONDUCT",
		     "SEXUAL", "INSULTS", "PROMPT_ATTACK", "VIOLENCE") | keep
		     user.id, gen_ai.compliance.violation_code | stats
		     block_count_per_violation = count() by user.id,
		     gen_ai.compliance.violation_code | SORT
		     block_count_per_violation DESC | keep user.id,
		     gen_ai.compliance.violation_code, block_count_per_violation |
		     STATS violation_count = SUM(block_count_per_violation) by
		     user.id | WHERE violation_count > 5 | SORT violation_count DESC

NamE: Suspicious Modprobe File Event
	description: 
		     Detects file events involving kernel modules in
		     modprobe configuration files, which may indicate unauthorized
		     access or manipulation of critical kernel modules. Attackers
		     may tamper with the modprobe files to load malicious or
		     unauthorized kernel modules, potentially bypassing security
		     measures, escalating privileges, or hiding their activities
		     within the system.
	query: 
		     host.os.type:linux and event.category:file and
		     event.action:"opened-file" and file.path :
		     ("/etc/modprobe.conf" or "/etc/modprobe.d" or
		     /etc/modprobe.d/*) and not process.name:(   cp or dpkg or
		     dockerd or lynis or mkinitramfs or snapd or systemd-udevd or
		     borg or auditbeat or lspci or   aide or modprobe or python* )

NamE: AWS VPC Flow Logs Deletion
	description: 
		     Identifies the deletion of one or more flow logs
		     in AWS Elastic Compute Cloud (EC2). An adversary may delete
		     flow logs in an attempt to evade defenses.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:ec2.amazonaws.com and
		     event.action:DeleteFlowLogs and event.outcome:success

NamE: Malware - Prevented - Elastic Endgame
	description: 
		     Elastic Endgame prevented Malware. Click the
		     Elastic Endgame icon in the event.module column or the link in
		     the rule.reference column for additional information.
	query: 
		     event.kind:alert and event.module:endgame and
		     endgame.metadata.type:prevention and
		     (event.action:file_classification_event or
		     endgame.event_subtype_full:file_classification_event)

NamE: External User Added to Google Workspace Group
	description: 
		     Detects an external Google Workspace user
		     account being added to an existing group. Adversaries may add
		     external user accounts as a means to intercept shared files or
		     emails with that specific group.
	query: 
		     iam where event.dataset == "google_workspace.admin"
		     and event.action == "ADD_GROUP_MEMBER" and   not
		     endsWith(user.target.email, user.target.group.domain)

NamE: Process Injection - Prevented - Elastic Endgame
	description: 
		     Elastic Endgame prevented Process Injection.
		     Click the Elastic Endgame icon in the event.module column or
		     the link in the rule.reference column for additional
		     information.
	query: 
		     event.kind:alert and event.module:endgame and
		     endgame.metadata.type:prevention and
		     (event.action:kernel_shellcode_event or
		     endgame.event_subtype_full:kernel_shellcode_event)

NamE: AWS Bedrock Guardrails Detected Multiple Policy Violations Within a Single Blocked Request
	description: 
		     Identifies multiple violations of AWS Bedrock
		     guardrails within a single request, resulting in a block
		     action, increasing the likelihood of malicious intent. Multiple
		     violations implies that a user may be intentionally attempting
		     to cirvumvent security controls, access sensitive information,
		     or possibly exploit a vulnerability in the system.
	query: 
		     from logs-aws_bedrock.invocation-* | where
		     gen_ai.policy.action == "BLOCKED" | eval policy_violations =
		     mv_count(gen_ai.policy.name) | where policy_violations > 1 |
		     keep gen_ai.policy.action, policy_violations, user.id,
		     gen_ai.request.model.id, cloud.account.id, user.id | stats
		     total_unique_request_violations = count(*) by
		     policy_violations, user.id, gen_ai.request.model.id,
		     cloud.account.id | sort total_unique_request_violations desc

NamE: AWS ElastiCache Security Group Modified or Deleted
	description: 
		     Identifies when an ElastiCache security group
		     has been modified or deleted.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:elasticache.amazonaws.com and
		     event.action:("Delete Cache Security Group" or "Authorize Cache
		     Security Group Ingress" or  "Revoke Cache Security Group
		     Ingress" or "AuthorizeCacheSecurityGroupEgress" or
		     "RevokeCacheSecurityGroupEgress") and event.outcome:success

NamE: Azure Service Principal Credentials Added
	description: 
		     Identifies when new Service Principal
		     credentials have been added in Azure. In most organizations,
		     credentials will be added to service principals infrequently.
		     Hijacking an application (by adding a rogue secret or
		     certificate) with granted permissions will allow the attacker
		     to access data that is normally protected by MFA requirements.
	query: 
		     event.dataset:azure.auditlogs and
		     azure.auditlogs.operation_name:"Add service principal
		     credentials" and event.outcome:(success or Success)

NamE: Forwarded Google Workspace Security Alert
	description: 
		     Identifies the occurrence of a security alert
		     from the Google Workspace alerts center. Google Workspace's
		     security alert center provides an overview of actionable alerts
		     that may be affecting an organization's domain. An alert is a
		     warning of a potential security issue that Google has detected.
	query: 
		     event.dataset: google_workspace.alert

NamE: Insecure AWS EC2 VPC Security Group Ingress Rule Added
	description: 
		     Identifies when a specified inbound (ingress)
		     rule is added or adjusted for a VPC security group in AWS EC2.
		     This rule detects when a security group rule is added that
		     allows traffic from any IP address or from a specific IP
		     address to common remote access ports, such as 22 (SSH) or 3389
		     (RDP). Adversaries may add these rules to allow remote access
		     to VPC instances from any location, increasing the attack
		     surface and potentially exposing the instances to unauthorized
		     access.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: ec2.amazonaws.com     and event.action:
		     AuthorizeSecurityGroupIngress     and event.outcome: success
		     and aws.cloudtrail.flattened.request_parameters.cidrIp:
		     ("0.0.0.0/0" or "::/0")     and
		     aws.cloudtrail.flattened.request_parameters.fromPort: (
		     21 or 22 or 23 or 445 or 3389 or 5985 or 5986)

NamE: AWS Deletion of RDS Instance or Cluster
	description: 
		     Identifies the deletion of an Amazon Relational
		     Database Service (RDS) Aurora database cluster, global database
		     cluster, or database instance.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:rds.amazonaws.com and
		     event.action:(DeleteDBCluster or DeleteGlobalCluster or
		     DeleteDBInstance) and event.outcome:success

NamE: AWS EC2 VM Export Failure
	description: 
		     Identifies an attempt to export an AWS EC2
		     instance. A virtual machine (VM) export may indicate an attempt
		     to extract or exfiltrate information.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:ec2.amazonaws.com and
		     event.action:CreateInstanceExportTask and event.outcome:failure

NamE: AWS WAF Rule or Rule Group Deletion
	description: 
		     Identifies the deletion of a specified AWS Web
		     Application Firewall (WAF) rule or rule group.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:(waf.amazonaws.com or waf-regional.amazonaws.com
		     or wafv2.amazonaws.com) and event.action:(DeleteRule or
		     DeleteRuleGroup) and event.outcome:success

NamE: Azure Entra Sign-in Brute Force Microsoft 365 Accounts by Repeat Source
	description: 
		     Identifies potential brute-force attempts
		     against Microsoft 365 user accounts by detecting a high number
		     of failed interactive or non-interactive login attempts within
		     a 30-minute window from a single source. Attackers may attempt
		     to brute force user accounts to gain unauthorized access to
		     Microsoft 365 services via different services such as Exchange,
		     SharePoint, or Teams.
	query: 
		     from logs-azure.signinlogs* | WHERE   event.dataset ==
		     "azure.signinlogs"   and event.category == "authentication"
		     and to_lower(azure.signinlogs.properties.resource_display_name)
		     rlike "(.*)365(.*)"   and azure.signinlogs.category in
		     ("NonInteractiveUserSignInLogs", "SignInLogs")   and
		     event.outcome != "success"    // For tuning, review
		     azure.signinlogs.properties.status.error_code   //
		     https://learn.microsoft.com/en-us/entra/identity-
		     platform/reference-error-codes  // keep only relevant fields |
		     keep event.dataset, event.category,
		     azure.signinlogs.properties.resource_display_name,
		     azure.signinlogs.category, event.outcome,
		     azure.signinlogs.properties.user_principal_name, source.ip  //
		     Count the number of unique targets per source IP | stats
		     target_count =
		     count_distinct(azure.signinlogs.properties.user_principal_name)
		     by source.ip  // Filter for at least 10 distinct failed login
		     attempts from a single source | where target_count >= 10

NamE: Rapid7 Threat Command CVEs Correlation
	description: 
		     This rule is triggered when CVEs collected from
		     the Rapid7 Threat Command Integration have a match against
		     vulnerabilities that were found in the customer environment.
	query: 
		     vulnerability.id : *

NamE: AWS EC2 Deprecated AMI Discovery
	description: 
		     Identifies when a user has queried for
		     deprecated Amazon Machine Images (AMIs) in AWS. This may
		     indicate an adversary whom is looking for outdated AMIs that
		     may be vulnerable to exploitation. While deprecated AMIs are
		     not inherently malicious or indicate breach, they may be more
		     susceptible to vulnerabilities and should be investigated for
		     potential security risks.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "ec2.amazonaws.com"     and event.action:
		     "DescribeImages"     and event.outcome: "success"     and
		     aws.cloudtrail.flattened.request_parameters.includeDeprecated:
		     "true"     and aws.cloudtrail.request_parameters: *owner=*

NamE: Azure Kubernetes Pods Deleted
	description: 
		     Identifies the deletion of Azure Kubernetes
		     Pods. Adversaries may delete a Kubernetes pod to disrupt the
		     normal behavior of the environment.
	query: 
		     event.dataset:azure.activitylogs and azure.activitylog
		     s.operation_name:"MICROSOFT.KUBERNETES/CONNECTEDCLUSTERS/PODS/D
		     ELETE" and event.outcome:(Success or success)

NamE: Azure Active Directory PowerShell Sign-in
	description: 
		     Identifies a sign-in using the Azure Active
		     Directory PowerShell module. PowerShell for Azure Active
		     Directory allows for managing settings from the command line,
		     which is intended for users who are members of an admin role.
	query: 
		     event.dataset:azure.signinlogs and
		     azure.signinlogs.properties.app_display_name:"Azure Active
		     Directory PowerShell" and
		     azure.signinlogs.properties.token_issuer_type:AzureAD and
		     event.outcome:(success or Success)

NamE: SMB (Windows File Sharing) Activity to the Internet
	description: 
		     This rule detects network events that may
		     indicate the use of Windows file sharing (also called SMB or
		     CIFS) traffic to the Internet. SMB is commonly used within
		     networks to share files, printers, and other system resources
		     amongst trusted systems. It should almost never be directly
		     exposed to the Internet, as it is frequently targeted and
		     exploited by threat actors as an initial access or backdoor
		     vector or for data exfiltration.
	query: 
		     (event.dataset: network_traffic.flow or
		     (event.category: (network or network_traffic))) and
		     network.transport:tcp and (destination.port:(139 or 445) or
		     event.dataset:zeek.smb) and   source.ip:(     10.0.0.0/8 or
		     172.16.0.0/12 or     192.168.0.0/16   ) and   not
		     destination.ip:(     10.0.0.0/8 or     127.0.0.0/8 or
		     169.254.0.0/16 or     172.16.0.0/12 or     192.0.0.0/24 or
		     192.0.0.0/29 or     192.0.0.8/32 or     192.0.0.9/32 or
		     192.0.0.10/32 or     192.0.0.170/32 or     192.0.0.171/32 or
		     192.0.2.0/24 or     192.31.196.0/24 or     192.52.193.0/24 or
		     192.168.0.0/16 or     192.88.99.0/24 or     224.0.0.0/4 or
		     100.64.0.0/10 or     192.175.48.0/24 or     198.18.0.0/15 or
		     198.51.100.0/24 or     203.0.113.0/24 or     240.0.0.0/4 or
		     "::1" or     "FE80::/10" or     "FF00::/8"   )

NamE: GitHub Protected Branch Settings Changed
	description: 
		     This rule detects setting modifications for
		     protected branches of a GitHub repository. Branch protection
		     rules can be used to enforce certain workflows or requirements
		     before a contributor can push changes to a branch in your
		     repository. Changes to these protected branch settings should
		     be investigated and verified as legitimate activity.
		     Unauthorized changes could be used to lower your organization's
		     security posture and leave you exposed for future attacks.
	query: 
		     configuration where event.dataset == "github.audit"
		     and github.category == "protected_branch" and event.type ==
		     "change"

NamE: SMTP on Port 26/TCP
	description: 
		     This rule detects events that may indicate use
		     of SMTP on TCP port 26. This port is commonly used by several
		     popular mail transfer agents to deconflict with the default
		     SMTP port 25. This port has also been used by a malware family
		     called BadPatch for command and control of Windows systems.
	query: 
		     (event.dataset: (network_traffic.flow or zeek.smtp) or
		     event.category:(network or network_traffic)) and
		     network.transport:tcp and destination.port:26

NamE: Enumeration of Users or Groups via Built-in Commands
	description: 
		     Identifies the execution of macOS built-in
		     commands related to account or group enumeration. Adversaries
		     may use account and group information to orient themselves
		     before deciding how to act.
	query: 
		     process where host.os.type == "macos" and event.type
		     in ("start", "process_started") and   (     process.name :
		     ("ldapsearch", "dsmemberutil") or     (process.name : "dscl"
		     and       process.args : ("read", "-read", "list", "-list",
		     "ls", "search", "-search") and       process.args : ("/Active
		     Directory/*", "/Users*", "/Groups*"))         ) and
		     ((process.Ext.effective_parent.executable : ("/Volumes/*",
		     "/Applications/*") or process.parent.executable :
		     ("/Volumes/*", "/Applications/*")) or
		     (process.Ext.effective_parent.name : ".*" or
		     process.parent.name : ".*")) and   not
		     process.Ext.effective_parent.executable :
		     ("/Applications/QualysCloudAgent.app/Contents/MacOS/qualys-
		     cloud-agent",
		     "/Applications/Kaspersky Anti-Virus For
		     Mac.app/Contents/MacOS/kavd.app/Contents/MacOS/kavd",
		     "/Applications/ESET Endpoint
		     Security.app/Contents/MacOS/esets_ctl",
		     "/Applications/NordVPN.app/Contents/MacOS/NordVPN",
		     "/Applications/Xcode.app/Contents/MacOS/Xcode",
		     "/Applications/ESET Endpoint Security.app/Contents/Helpers/Unin
		     staller.app/Contents/MacOS/Uninstaller",
		     "/Applications/Parallels
		     Desktop.app/Contents/MacOS/prl_client_app",
		     "/Applications/Zscaler/Zscaler.app/Contents/MacOS/Zscaler",
		     "/Applications/com.avast.av.uninstaller.app/Contents/MacOS/com.
		     avast.av.uninstaller",
		     "/Applications/NoMAD.app/Contents/MacOS/NoMAD",
		     "/Applications/ESET Management
		     Agent.app/Contents/MacOS/ERAAgent")

NamE: Unusual File Modification by dns.exe
	description: 
		     Identifies an unexpected file being modified by
		     dns.exe, the process responsible for Windows DNS Server
		     services, which may indicate activity related to remote code
		     execution or other forms of exploitation.
	query: 
		     file where host.os.type == "windows" and process.name
		     : "dns.exe" and event.type in ("creation", "deletion",
		     "change") and   not file.name : "dns.log" and not
		     (file.extension : ("old", "temp", "bak", "dns", "arpa") and
		     file.path : "C:\\Windows\\System32\\dns\\*") and    /* DNS logs
		     with custom names, header converts to "DNS Server log" */   not
		     ?file.Ext.header_bytes : "444e5320536572766572206c6f67*"

NamE: Suspicious Execution from Foomatic-rip or Cupsd Parent
	description: 
		     This detection rule addresses multiple
		     vulnerabilities in the CUPS printing system, including
		     CVE-2024-47176, CVE-2024-47076, CVE-2024-47175, and
		     CVE-2024-47177. Specifically, this rule detects suspicious
		     process command lines executed by child processes of foomatic-
		     rip and cupsd. These flaws impact components like cups-browsed,
		     libcupsfilters, libppd, and foomatic-rip, allowing remote
		     unauthenticated attackers to manipulate IPP URLs or inject
		     malicious data through crafted UDP packets or network spoofing.
		     This can result in arbitrary command execution when a print job
		     is initiated.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2") and process.parent.name in ("foomatic-rip",
		     "cupsd") and process.command_line like (   // persistence
		     "*cron*", "*/etc/rc.local*", "*/dev/tcp/*", "*/etc/init.d*",
		     "*/etc/update-motd.d*", "*/etc/sudoers*",   "*/etc/profile*",
		     "*autostart*", "*/etc/ssh*", "*/home/*/.ssh/*", "*/root/.ssh*",
		     "*~/.ssh/*", "*udev*",   "*/etc/shadow*", "*/etc/passwd*",
		     // Downloads   "*curl*", "*wget*",    // encoding and decoding
		     "*base64 *", "*base32 *", "*xxd *", "*openssl*",    // reverse
		     connections   "*GS_ARGS=*", "*/dev/tcp*", "*/dev/udp/*",
		     "*import*pty*spawn*", "*import*subprocess*call*",
		     "*TCPSocket.new*",   "*TCPSocket.open*", "*io.popen*",
		     "*os.execute*", "*fsockopen*", "*disown*", "*nohup*",    // SO
		     loads   "*openssl*-engine*.so*", "*cdll.LoadLibrary*.so*",
		     "*ruby*-e**Fiddle.dlopen*.so*", "*Fiddle.dlopen*.so*",
		     "*cdll.LoadLibrary*.so*",    // misc. suspicious command lines
		     "*/etc/ld.so*", "*/dev/shm/*", "*/var/tmp*", "*echo*", "*>>*",
		     "*|*" ) and not process.args like "gs*"

NamE: Hidden Files and Directories via Hidden Flag
	description: 
		     Identify activity related where adversaries can
		     add the 'hidden' flag to files to hide them from the user in an
		     attempt to evade detection.
	query: 
		     file where host.os.type == "linux" and event.type ==
		     "creation" and process.name == "chflags"

NamE: AWS Lambda Layer Added to Existing Function
	description: 
		     Identifies when an Lambda Layer is added to an
		     existing Lambda function. AWS layers are a way to share code
		     and data across multiple functions. By adding a layer to an
		     existing function, an attacker can persist or execute code in
		     the context of the function.
	query: 
		     event.dataset: aws.cloudtrail     and event.provider:
		     lambda.amazonaws.com     and event.outcome: success     and
		     event.action: (PublishLayerVersion* or
		     UpdateFunctionConfiguration)

NamE: AWS S3 Bucket Expiration Lifecycle Configuration Added
	description: 
		     Identifies an expiration lifecycle configuration
		     added to an S3 bucket. Lifecycle configurations can be used to
		     manage objects in a bucket, including setting expiration
		     policies. This rule detects when a lifecycle configuration is
		     added to an S3 bucket, which could indicate that objects in the
		     bucket will be automatically deleted after a specified period
		     of time. This could be used to evade detection by deleting
		     objects that contain evidence of malicious activity.
	query: 
		     event.dataset: "aws.cloudtrail" and event.provider:
		     "s3.amazonaws.com" and     event.action: PutBucketLifecycle and
		     event.outcome: success and
		     aws.cloudtrail.request_parameters: (*LifecycleConfiguration*
		     and *Expiration=*)

NamE: Deprecated - AWS Credentials Searched For Inside A Container
	description: 
		     This rule detects the use of system search
		     utilities like grep and find to search for AWS credentials
		     inside a container. Unauthorized access to these sensitive
		     files could lead to further compromise of the container
		     environment or facilitate a container breakout to the
		     underlying cloud environment.
	query: 
		     process where event.module == "cloud_defend" and
		     event.type == "start" and  /*account for tools that execute
		     utilities as a subprocess, in this case the target utility name
		     will appear as a process arg*/ (process.name : ("grep",
		     "egrep", "fgrep", "find", "locate", "mlocate") or process.args
		     : ("grep", "egrep", "fgrep", "find", "locate", "mlocate")) and
		     process.args : ("*aws_access_key_id*",
		     "*aws_secret_access_key*", "*aws_session_token*",
		     "*accesskeyid*", "*secretaccesskey*", "*access_key*",
		     "*.aws/credentials*")

NamE: Deprecated - Netcat Listener Established Inside A Container
	description: 
		     This rule detects an established netcat listener
		     running inside a container. Netcat is a utility used for
		     reading and writing data across network connections, and it can
		     be used for malicious purposes such as establishing a backdoor
		     for persistence or exfiltrating data.
	query: 
		     process where container.id: "*" and event.type==
		     "start" and event.action in ("fork", "exec") and ( process.name
		     :("nc","ncat","netcat","netcat.openbsd","netcat.traditional")
		     or /*account for tools that execute utilities as a subprocess,
		     in this case the target utility name will appear as a process
		     arg*/ process.args:
		     ("nc","ncat","netcat","netcat.openbsd","netcat.traditional") )
		     and (           /* bind shell to echo for command execution */
		     (process.args:("-*l*", "--listen", "-*p*", "--source-port") and
		     process.args:("-c", "--sh-exec", "-e", "--exec", "echo","$*"))
		     /* bind shell to specific port */           or
		     process.args:("-*l*", "--listen", "-*p*", "--source-port")
		     )

NamE: Windows Event Logs Cleared
	description: 
		     Identifies attempts to clear Windows event log
		     stores. This is often done by attackers in an attempt to evade
		     detection or destroy forensic evidence on a system.
	query: 
		     event.action:("audit-log-cleared" or "Log clear") and
		     winlog.api:"wineventlog" and   not winlog.provider_name:"AD FS
		     Auditing"

NamE: Microsoft 365 Global Administrator Role Assigned
	description: 
		     In Azure Active Directory (Azure AD),
		     permissions to manage resources are assigned using roles. The
		     Global Administrator is a role that enables users to have
		     access to all administrative features in Azure AD and services
		     that use Azure AD identities like the Microsoft 365 Defender
		     portal, the Microsoft 365 compliance center, Exchange,
		     SharePoint Online, and Skype for Business Online. Attackers can
		     add users as Global Administrators to maintain access and
		     manage all subscriptions and their settings and resources.
	query: 
		     event.dataset:o365.audit and
		     event.code:"AzureActiveDirectory" and event.action:"Add member
		     to role." and
		     o365.audit.ModifiedProperties.Role_DisplayName.NewValue:"Global
		     Administrator"

NamE: System Time Discovery
	description: 
		     Detects the usage of commonly used system time
		     discovery techniques, which attackers may use during the
		     reconnaissance phase after compromising a system.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and (  (     (process.name: "net.exe" or
		     (process.name : "net1.exe" and not process.parent.name :
		     "net.exe")) and      process.args : "time" and not process.args
		     : "/set"  ) or   (process.name: "w32tm.exe" and process.args:
		     "/tz") or   (process.name: "tzutil.exe" and process.args: "/g")
		     ) and not user.id : ("S-1-5-18", "S-1-5-19", "S-1-5-20")

NamE: Access to Keychain Credentials Directories
	description: 
		     Adversaries may collect the keychain storage
		     data from a system to acquire credentials. Keychains are the
		     built-in way for macOS to keep track of users' passwords and
		     credentials for many services and features such as WiFi
		     passwords, websites, secure notes and certificates.
	query: 
		     process where host.os.type == "macos" and event.type
		     in ("start", "process_started") and   process.args :     (
		     "/Users/*/Library/Keychains/*",       "/Library/Keychains/*",
		     "/Network/Library/Keychains/*",       "System.keychain",
		     "login.keychain-db",       "login.keychain"     ) and     not
		     process.args : ("find-certificate",
		     "add-trusted-cert",                         "set-keychain-
		     settings",                         "delete-certificate",
		     "/Users/*/Library/Keychains/openvpn.keychain-db",
		     "show-keychain-info",                         "lock-keychain",
		     "set-key-partition-list",                         "import",
		     "find-identity") and     not process.parent.executable :
		     (         "/Applications/OpenVPN Connect/OpenVPN
		     Connect.app/Contents/MacOS/OpenVPN Connect",
		     "/Applications/Microsoft Defender.app/Contents/MacOS/wdavdaemon
		     _enterprise.app/Contents/MacOS/wdavdaemon_enterprise",
		     "/opt/jc/bin/jumpcloud-agent"       ) and     not
		     process.executable : ("/opt/jc/bin/jumpcloud-agent",
		     "/usr/bin/basename") and     not
		     process.Ext.effective_parent.executable :
		     ("/opt/rapid7/ir_agent/ir_agent",
		     "/Library/Elastic/Endpoint/elastic-
		     endpoint.app/Contents/MacOS/elastic-endpoint",
		     "/Applications/QualysCloudAgent.app/Contents/MacOS/qualys-
		     cloud-agent",
		     "/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/Jamf
		     Daemon.app/Contents/MacOS/JamfDaemon",
		     "/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/Jamf
		     ManagementService.app/Contents/MacOS/JamfManagementService",
		     "/usr/local/jamf/bin/jamf",
		     "/Applications/Microsoft
		     Defender.app/Contents/MacOS/wdavdaemon")

NamE: Incoming Execution via WinRM Remote Shell
	description: 
		     Identifies remote execution via Windows Remote
		     Management (WinRM) remote shell on a target host. This could be
		     an indication of lateral movement.
	query: 
		     sequence by host.id with maxspan=30s    [network where
		     host.os.type == "windows" and process.pid == 4 and
		     network.direction : ("incoming", "ingress") and
		     destination.port in (5985, 5986) and network.protocol == "http"
		     and source.ip != "127.0.0.1" and source.ip != "::1"]
		     [process where host.os.type == "windows" and     event.type ==
		     "start" and process.parent.name : "winrshost.exe" and not
		     process.executable : "?:\\Windows\\System32\\conhost.exe"]

NamE: Cron Job Created or Modified
	description: 
		     This rule monitors for (ana)cron jobs being
		     created or renamed. Linux cron jobs are scheduled tasks that
		     can be leveraged by system administrators to set up scheduled
		     tasks, but may be abused by malicious actors for persistence,
		     privilege escalation and command execution. By creating or
		     modifying cron job configurations, attackers can execute
		     malicious commands or scripts at predefined intervals, ensuring
		     their continued presence and enabling unauthorized activities.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("rename", "creation") and file.path : (   "/etc/cron.allow",
		     "/etc/cron.deny", "/etc/cron.d/*", "/etc/cron.hourly/*",
		     "/etc/cron.daily/*", "/etc/cron.weekly/*",
		     "/etc/cron.monthly/*", "/etc/crontab",
		     "/var/spool/cron/crontabs/*", "/var/spool/anacron/*" ) and not
		     (   process.executable in (     "/bin/dpkg", "/usr/bin/dpkg",
		     "/bin/dockerd", "/usr/bin/dockerd", "/usr/sbin/dockerd",
		     "/bin/microdnf",     "/usr/bin/microdnf", "/bin/rpm",
		     "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd", "/bin/yum",
		     "/usr/bin/yum",     "/bin/dnf", "/usr/bin/dnf", "/bin/podman",
		     "/usr/bin/podman", "/bin/dnf-automatic", "/usr/bin/dnf-
		     automatic",     "/bin/pacman", "/usr/bin/pacman",
		     "/usr/bin/dpkg-divert", "/bin/dpkg-divert", "/sbin/apk",
		     "/usr/sbin/apk",     "/usr/local/sbin/apk", "/usr/bin/apt",
		     "/usr/sbin/pacman", "/bin/podman", "/usr/bin/podman",
		     "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/local/bin/dockerd", "/opt/elasticbeanstalk/bin/platform-
		     engine",     "/opt/puppetlabs/puppet/bin/ruby",
		     "/usr/libexec/platform-python",
		     "/opt/imunify360/venv/bin/python3",
		     "/opt/eset/efs/lib/utild", "/usr/sbin/anacron",
		     "/usr/bin/podman", "/kaniko/kaniko-executor"   ) or   file.path
		     like ("/var/spool/cron/crontabs/tmp.*", "/etc/cron.d/jumpcloud-
		     updater") or   file.extension in ("swp", "swpx", "swx", "dpkg-
		     remove") or   file.Ext.original.extension == "dpkg-new" or
		     process.executable : (     "/nix/store/*", "/var/lib/dpkg/*",
		     "/tmp/vmis.*", "/snap/*", "/dev/fd/*", "/usr/libexec/platform-
		     python*"   ) or   process.executable == null or   process.name
		     in (     "crond", "executor", "puppet", "droplet-
		     agent.postinst", "cf-agent", "schedd", "imunify-notifier",
		     "perl",     "jumpcloud-agent", "crio", "dnf_install", "utild"
		     ) or   (process.name == "sed" and file.name : "sed*") or
		     (process.name == "perl" and file.name : "e2scrub_all.tmp*")  )

NamE: DPKG Package Installed by Unusual Parent Process
	description: 
		     This rule detects the installation of a Debian
		     package (dpkg) by an unusual parent process. The dpkg command
		     is used to install, remove, and manage Debian packages on a
		     Linux system. Attackers can abuse the dpkg command to install
		     malicious packages on a system.
	query: 
		     host.os.type:linux and event.category:process and
		     event.type:start and event.action:exec and process.name:dpkg
		     and process.args:("-i" or "--install")

NamE: Unusual Discovery Activity by User
	description: 
		     This rule leverages alert data from various
		     Discovery building block rules to alert on signals with unusual
		     unique host.id and user.id entries.
	query: 
		     host.os.type:windows and event.kind:signal and
		     kibana.alert.rule.rule_id:(
		     "d68e95ad-1c82-4074-a12a-125fe10ac8ba" or
		     "7b8bfc26-81d2-435e-965c-d722ee397ef1" or
		     "0635c542-1b96-4335-9b47-126582d2c19a" or
		     "6ea55c81-e2ba-42f2-a134-bccf857ba922" or
		     "e0881d20-54ac-457f-8733-fe0bc5d44c55" or
		     "06568a02-af29-4f20-929c-f3af281e41aa" or
		     "c4e9ed3e-55a2-4309-a012-bc3c78dad10a" or
		     "51176ed2-2d90-49f2-9f3d-17196428b169" or
		     "1d72d014-e2ab-4707-b056-9b96abe7b511" )

NamE: Threat Intel Windows Registry Indicator Match
	description: 
		     This rule is triggered when a Windows registry
		     indicator from the Threat Intel Filebeat module or integrations
		     has a match against an event that contains registry data.
	query: 
		     registry.path:*

NamE: AWS RDS Snapshot Deleted
	description: 
		     Identifies the deletion of an AWS RDS DB
		     snapshot. Snapshots contain a full backup of an entire DB
		     instance. Unauthorized deletion of snapshots can make it
		     impossible to recover critical or sensitive data. This rule
		     detects deleted snapshots and instances modified so that
		     backupRetentionPeriod is set to 0 which disables automated
		     backups and is functionally similar to deleting the system
		     snapshot.
	query: 
		     any where event.dataset == "aws.cloudtrail"     and
		     event.provider == "rds.amazonaws.com"     and event.outcome ==
		     "success"     and (         event.action in
		     ("DeleteDBSnapshot", "DeleteDBClusterSnapshot") or
		     (event.action == "ModifyDBInstance" and
		     stringContains(aws.cloudtrail.request_parameters,
		     "backupRetentionPeriod=0"))     )

NamE: Scheduled Tasks AT Command Enabled
	description: 
		     Identifies attempts to enable the Windows
		     scheduled tasks AT command via the registry. Attackers may use
		     this method to move laterally or persist locally. The AT
		     command has been deprecated since Windows 8 and Windows Server
		     2012, but still exists for backwards compatibility.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.path : (
		     "HKLM\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Schedule\\Configuration\\EnableAt",
		     "\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Schedule\\Configuration\\EnableAt",
		     "MACHINE\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Schedule\\Configuration\\EnableAt"   ) and
		     registry.data.strings : ("1", "0x00000001")

NamE: File Transfer or Listener Established via Netcat
	description: 
		     A netcat process is engaging in network activity
		     on a Linux host. Netcat is often used as a persistence
		     mechanism by exporting a reverse shell or by serving a shell on
		     a listening port. Netcat is also sometimes used for data
		     exfiltration.
	query: 
		     sequence by process.entity_id   [process where
		     host.os.type == "linux" and event.type == "start" and       pro
		     cess.name:("nc","ncat","netcat","netcat.openbsd","netcat.tradit
		     ional") and (           /* bind shell to echo for command
		     execution */           (process.args:("-l","-p") and
		     process.args:("-c","echo","$*"))           /* bind shell to
		     specific port */           or process.args:("-l","-p","-lp")
		     /* reverse shell to command-line interpreter used for command
		     execution */           or (process.args:("-e") and
		     process.args:("/bin/bash","/bin/sh"))           /* file
		     transfer via stdout */           or process.args:(">","<")
		     /* file transfer via pipe */           or (process.args:("|")
		     and process.args:("nc","ncat"))       ) and       not
		     process.command_line like~ ("*127.0.0.1*", "*localhost*")]
		     [network where host.os.type == "linux" and (process.name ==
		     "nc" or process.name == "ncat" or process.name == "netcat" or
		     process.name == "netcat.openbsd" or process.name ==
		     "netcat.traditional")]

NamE: Execution of COM object via Xwizard
	description: 
		     Windows Component Object Model (COM) is an
		     inter-process communication (IPC) component of the native
		     Windows application programming interface (API) that enables
		     interaction between software objects or executable code.
		     Xwizard can be used to run a COM object created in registry to
		     evade defensive counter measures.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  (process.name : "xwizard.exe" or
		     ?process.pe.original_file_name : "xwizard.exe") and  (
		     (process.args : "RunWizard" and process.args : "{*}") or
		     (process.executable != null and      not process.executable : (
		     "C:\\Windows\\SysWOW64\\xwizard.exe",
		     "C:\\Windows\\System32\\xwizard.exe",
		     "\\Device\\HarddiskVolume?\\Windows\\SysWOW64\\xwizard.exe",
		     "\\Device\\HarddiskVolume?\\Windows\\System32\\xwizard.exe"
		     )    )  )

NamE: Hping Process Activity
	description: 
		     Hping ran on a Linux host. Hping is a FOSS
		     command-line packet analyzer and has the ability to construct
		     network packets for a wide variety of network security testing
		     applications, including scanning and firewall auditing.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and  event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed", "process_started") and
		     process.name in ("hping", "hping2", "hping3")

NamE: Execution via local SxS Shared Module
	description: 
		     Identifies the creation, change, or deletion of
		     a DLL module within a Windows SxS local folder. Adversaries may
		     abuse shared modules to execute malicious payloads by
		     instructing the Windows module loader to load DLLs from
		     arbitrary local paths.
	query: 
		     file where host.os.type == "windows" and
		     file.extension : "dll" and file.path :
		     "C:\\*\\*.exe.local\\*.dll"

NamE: Potential Reverse Shell via Background Process
	description: 
		     Monitors for the execution of background
		     processes with process arguments capable of opening a socket in
		     the /dev/tcp channel. This may indicate the creation of a
		     backdoor reverse connection, and should be investigated
		     further.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2") and   process.name in ("setsid",
		     "nohup") and process.args : "*/dev/tcp/*0>&1*" and
		     process.parent.name in ("bash", "dash", "sh", "tcsh", "csh",
		     "zsh", "ksh", "fish")

NamE: Suspicious WerFault Child Process
	description: 
		     A suspicious WerFault child process was
		     detected, which may indicate an attempt to run via the
		     SilentProcessExit registry key manipulation. Verify process
		     details such as command line, network connections and file
		     writes.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and    process.parent.name : "WerFault.exe" and
		     /* args -s and -t used to execute a process via
		     SilentProcessExit mechanism */   (process.parent.args : "-s"
		     and process.parent.args : "-t" and process.parent.args : "-c")
		     and    not process.executable :
		     ("?:\\Windows\\SysWOW64\\Initcrypt.exe", "?:\\Program Files
		     (x86)\\Heimdal\\Heimdal.Guard.exe")

NamE: Startup Persistence by a Suspicious Process
	description: 
		     Identifies files written to or modified in the
		     startup folder by commonly abused processes. Adversaries may
		     use this technique to maintain persistence.
	query: 
		     file where host.os.type == "windows" and event.type !=
		     "deletion" and   user.domain != "NT AUTHORITY" and   file.path
		     : ("C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Windows\\Start
		     Menu\\Programs\\Startup\\*",
		     "C:\\ProgramData\\Microsoft\\Windows\\Start
		     Menu\\Programs\\StartUp\\*") and   process.name : ("cmd.exe",
		     "powershell.exe",                   "wmic.exe",
		     "mshta.exe",                   "pwsh.exe",
		     "cscript.exe",                   "wscript.exe",
		     "regsvr32.exe",                   "RegAsm.exe",
		     "rundll32.exe",                   "EQNEDT32.EXE",
		     "WINWORD.EXE",                   "EXCEL.EXE",
		     "POWERPNT.EXE",                   "MSPUB.EXE",
		     "MSACCESS.EXE",                   "iexplore.exe",
		     "InstallUtil.exe")

NamE: Potential Suspicious File Edit
	description: 
		     This rule monitors for the potential edit of a
		     suspicious file. In Linux, when editing a file through an
		     editor, a temporary .swp file is created. By monitoring for the
		     creation of this .swp file, we can detect potential file edits
		     of suspicious files. The execution of this rule is not a clear
		     sign of the file being edited, as just opening the file through
		     an editor will trigger this event. Attackers may alter any of
		     the files added in this rule to establish persistence, escalate
		     privileges or perform reconnaisance on the system.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("creation", "file_create_event") and file.extension == "swp"
		     and file.path : (   /* common interesting files and locations
		     */   "/etc/.shadow.swp", "/etc/.shadow-.swp",
		     "/etc/.shadow~.swp", "/etc/.gshadow.swp", "/etc/.gshadow-.swp",
		     "/etc/.passwd.swp", "/etc/.pwd.db.swp",
		     "/etc/.master.passwd.swp", "/etc/.spwd.db.swp",
		     "/etc/security/.opasswd.swp",   "/etc/.environment.swp",
		     "/etc/.profile.swp", "/etc/sudoers.d/.*.swp",
		     "/etc/ld.so.conf.d/.*.swp",   "/etc/init.d/.*.swp",
		     "/etc/.rc.local.swp", "/etc/rc*.d/.*.swp", "/dev/shm/.*.swp",
		     "/etc/update-motd.d/.*.swp",   "/usr/lib/update-
		     notifier/.*.swp",    /* service, timer, want, socket and lock
		     files */   "/etc/systemd/system/.*.swp",
		     "/usr/local/lib/systemd/system/.*.swp",
		     "/lib/systemd/system/.*.swp",   "/usr/lib/systemd/system/.*.swp
		     ","/home/*/.config/systemd/user/.*.swp", "/run/.*.swp",
		     "/var/run/.*.swp/",    /* profile and shell configuration files
		     */   "/home/*.profile.swp", "/home/*.bash_profile.swp",
		     "/home/*.bash_login.swp", "/home/*.bashrc.swp",
		     "/home/*.bash_logout.swp",   "/home/*.zshrc.swp",
		     "/home/*.zlogin.swp", "/home/*.tcshrc.swp",
		     "/home/*.kshrc.swp", "/home/*.config.fish.swp",
		     "/root/*.profile.swp", "/root/*.bash_profile.swp",
		     "/root/*.bash_login.swp", "/root/*.bashrc.swp",
		     "/root/*.bash_logout.swp",   "/root/*.zshrc.swp",
		     "/root/*.zlogin.swp", "/root/*.tcshrc.swp",
		     "/root/*.kshrc.swp", "/root/*.config.fish.swp" )

NamE: Machine Learning Detected DGA activity using a known SUNBURST DNS domain
	description: 
		     A supervised machine learning model has
		     identified a DNS question name that used by the SUNBURST
		     malware and is predicted to be the result of a Domain
		     Generation Algorithm.
	query: 
		     ml_is_dga.malicious_prediction:1 and
		     dns.question.registered_domain:avsvmcloud.com

NamE: Privilege Escalation via SUID/SGID
	description: 
		     Identifies instances where a process is executed
		     with user/group ID 0 (root), and a real user/group ID that is
		     not 0. This is indicative of a process that has been granted
		     SUID/SGID permissions, allowing it to run with elevated
		     privileges. Attackers may leverage a misconfiguration for
		     exploitation in order to escalate their privileges to root, or
		     establish a backdoor for persistence.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action == "exec" and (   (process.user.id
		     == "0" and process.real_user.id != "0") or   (process.group.id
		     == "0" and process.real_group.id != "0") ) and (   process.name
		     in (     "aa-exec", "ab", "agetty", "alpine", "ar", "arj",
		     "arp", "as", "ascii-xfr", "ash", "aspell",     "atobm", "awk",
		     "base32", "base64", "basenc", "basez", "bash", "bc", "bridge",
		     "busctl",     "busybox", "bzip2", "cabal", "capsh", "cat",
		     "choom", "chown", "chroot", "clamscan", "cmp",     "column",
		     "comm", "cp", "cpio", "cpulimit", "csh", "csplit", "csvtool",
		     "cupsfilter", "curl",     "cut", "dash", "date", "dd",
		     "debugfs", "dialog", "diff", "dig", "distcc", "dmsetup",
		     "docker",     "dosbox", "ed", "efax", "elvish", "emacs", "env",
		     "eqn", "espeak", "expand", "expect", "file",     "find",
		     "fish", "flock", "fmt", "fold", "gawk", "gcore", "gdb",
		     "genie", "genisoimage", "gimp",     "grep", "gtester", "gzip",
		     "hd", "head", "hexdump", "highlight", "hping3", "iconv",
		     "install",     "ionice", "ispell", "jjs", "join", "jq",
		     "jrunscript", "julia", "ksh", "ksshell", "kubectl",
		     "ld.so", "less", "links", "logsave", "look", "lua", "make",
		     "mawk", "minicom", "more",     "mosquitto", "msgattrib",
		     "msgcat", "msgconv", "msgfilter", "msgmerge", "msguniq",
		     "multitime",     "mv", "nasm", "nawk", "ncftp", "nft", "nice",
		     "nl", "nm", "nmap", "node", "nohup", "ntpdate",     "od",
		     "openssl", "openvpn", "pandoc", "paste", "perf", "perl",
		     "pexec", "pg", "php", "pidstat",     "pr", "ptx", "python",
		     "rc", "readelf", "restic", "rev", "rlwrap", "rsync",
		     "rtorrent",     "run-parts", "rview", "rvim", "sash",
		     "scanmem", "sed", "setarch", "setfacl", "setlock", "shuf",
		     "soelim", "softlimit", "sort", "sqlite3", "ss", "ssh-agent",
		     "ssh-keygen", "ssh-keyscan",     "sshpass", "start-stop-
		     daemon", "stdbuf", "strace", "strings", "sysctl", "systemctl",
		     "tac",     "tail", "taskset", "tbl", "tclsh", "tee",
		     "terraform", "tftp", "tic", "time", "timeout", "troff",
		     "ul", "unexpand", "uniq", "unshare", "unsquashfs", "unzip",
		     "update-alternatives", "uudecode",     "uuencode", "vagrant",
		     "varnishncsa", "view", "vigr", "vim", "vimdiff", "vipw", "w3m",
		     "watch",     "wc", "wget", "whiptail", "xargs", "xdotool",
		     "xmodmap", "xmore", "xxd", "xz", "yash", "zsh",     "zsoelim"
		     ) or   process.name == "ip" and (     (process.args == "-force"
		     and process.args in ("-batch", "-b")) or (process.args ==
		     "exec")   ) ) and not process.parent.name == "spine"

NamE: Suspicious macOS MS Office Child Process
	description: 
		     Identifies suspicious child processes of
		     frequently targeted Microsoft Office applications (Word,
		     PowerPoint, and Excel). These child processes are often
		     launched during exploitation of Office applications or by
		     documents with malicious macros.
	query: 
		     process where event.action == "exec" and host.os.type
		     == "macos" and     process.parent.name: (       "Microsoft
		     Word",       "Microsoft Outlook",       "Microsoft Excel",
		     "Microsoft PowerPoint",       "Microsoft OneNote"     ) and
		     process.name : (     "curl",     "nscurl",     "bash",
		     "sh",     "osascript",     "python*",     "perl*",
		     "mktemp",     "chmod",     "php",     "nohup",     "openssl",
		     "plutil",     "PlistBuddy",     "xattr",     "mktemp",
		     "sqlite3",     "funzip",     "popen"   ) and    // Filter FPs
		     related to product version discovery and Office error reporting
		     behavior   not process.args:     (       "ProductVersion",
		     "hw.model",       "ioreg",       "ProductName",
		     "ProductUserVisibleVersion",       "ProductBuildVersion",
		     "/Library/Application Support/Microsoft/MERP*/Microsoft Error
		     Reporting.app/Contents/MacOS/Microsoft Error Reporting",
		     "open -a Safari *",       "defaults read *",       "sysctl
		     hw.model*",       "ioreg -d2 -c IOPlatformExpertDevice *",
		     "ps aux | grep 'ToDesk_Desktop' | grep -v grep",
		     "PIPE=\"$CFFIXED_USER_HOME/.zoteroIntegrationPipe*"     ) and
		     not process.parent.executable :         (
		     "/Applications/ToDesk.app/Contents/MacOS/ToDesk_Service",
		     "/usr/local/Privacy-i/PISupervisor",
		     "/Library/Addigy/lan-cache",
		     "/Library/Elastic/Agent/*",           "/opt/jc/bin/jumpcloud-
		     agent",           "/usr/sbin/networksetup"         ) and    not
		     (process.name : "sh" and process.command_line :
		     "*$CFFIXED_USER_HOME/.zoteroIntegrationPipe*") and     not
		     process.Ext.effective_parent.executable : (
		     "/Applications/ToDesk.app/Contents/MacOS/ToDesk_Service",
		     "/usr/local/Privacy-i/PISupervisor",
		     "/Library/Addigy/auditor",         "/Library/Elastic/Agent/*",
		     "/opt/jc/bin/jumpcloud-agent",         "/usr/sbin/networksetup"
		     )

NamE: Suspicious Data Encryption via OpenSSL Utility
	description: 
		     Identifies when the openssl command-line utility
		     is used to encrypt multiple files on a host within a short time
		     window. Adversaries may encrypt data on a single or multiple
		     systems in order to disrupt the availability of their target's
		     data and may attempt to hold the organization's data to ransom
		     for the purposes of extortion.
	query: 
		     sequence by host.id, user.name,
		     process.parent.entity_id with maxspan=5s   [ process where
		     host.os.type == "linux" and event.action == "exec" and
		     process.name == "openssl" and process.parent.name : ("bash",
		     "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish", "perl*",
		     "php*", "python*", "xargs") and     process.args == "-in" and
		     process.args == "-out" and     process.args in ("-k", "-K",
		     "-kfile", "-pass", "-iv", "-md") and     /* excluding base64
		     encoding options and including encryption password or key
		     params */     not process.args in ("-d", "-a", "-A", "-base64",
		     "-none", "-nosalt") ] with runs=10

NamE: Memory Dump File with Unusual Extension
	description: 
		     Identifies the creation of a memory dump file
		     with an unusual extension, which can indicate an attempt to
		     disguise a memory dump as another file type to bypass security
		     defenses.
	query: 
		     file where host.os.type == "windows" and event.type ==
		     "creation" and    /* MDMP header */   file.Ext.header_bytes :
		     "4d444d50*" and   not file.extension : ("dmp", "mdmp", "hdmp",
		     "edmp", "full", "tdref", "cg", "tmp", "dat") and   not    (
		     process.executable : "?:\\Program Files\\Endgame\\esensor.exe"
		     and     process.code_signature.trusted == true and
		     length(file.extension) == 0   ) and   not   (     process.name
		     : "System" and file.extension : "tmpscan"   )

NamE: Suspicious RDP ActiveX Client Loaded
	description: 
		     Identifies suspicious Image Loading of the
		     Remote Desktop Services ActiveX Client (mstscax), this may
		     indicate the presence of RDP lateral movement capability.
	query: 
		     any where host.os.type == "windows" and
		     (event.category : ("library", "driver") or (event.category ==
		     "process" and event.action : "Image loaded*")) and  (?dll.name
		     : "mstscax.dll" or file.name : "mstscax.dll") and    /*
		     depending on noise in your env add here extra paths  */
		     process.executable : (     "C:\\Windows\\*",
		     "C:\\Users\\Public\\*",     "C:\\Users\\Default\\*",
		     "C:\\Intel\\*",     "C:\\PerfLogs\\*",
		     "C:\\ProgramData\\*",     "\\Device\\Mup\\*",     "\\\\*"   )
		     and   /* add here FPs */   not process.executable : (
		     "?:\\Windows\\System32\\mstsc.exe",
		     "?:\\Windows\\SysWOW64\\mstsc.exe",
		     "?:\\Windows\\System32\\vmconnect.exe",
		     "?:\\Windows\\System32\\WindowsSandboxClient.exe",
		     "?:\\Windows\\System32\\hvsirdpclient.exe"   )

NamE: Disable Windows Event and Security Logs Using Built-in Tools
	description: 
		     Identifies attempts to disable EventLog via the
		     logman Windows utility, PowerShell, or auditpol. This is often
		     done by attackers in an attempt to evade detection on a system.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and (   (     (process.name:"logman.exe" or
		     ?process.pe.original_file_name == "Logman.exe") and
		     process.args : "EventLog-*" and process.args : ("stop",
		     "delete")   ) or   (     (       process.name : ("pwsh.exe",
		     "powershell.exe", "powershell_ise.exe") or
		     ?process.pe.original_file_name in ("pwsh.exe",
		     "powershell.exe", "powershell_ise.exe")     ) and
		     process.args : "Set-Service" and process.args: "EventLog" and
		     process.args : "Disabled"   )  or   (
		     (process.name:"auditpol.exe" or ?process.pe.original_file_name
		     == "AUDITPOL.EXE") and process.args : "/success:disable"   ) )

NamE: Potential Microsoft Office Sandbox Evasion
	description: 
		     Identifies the creation of a suspicious zip file
		     prepended with special characters. Sandboxed Microsoft Office
		     applications on macOS are allowed to write files that start
		     with special characters, which can be combined with an
		     AutoStart location to achieve sandbox evasion.
	query: 
		     event.category:file and host.os.type:(macos and macos)
		     and not event.type:deletion and file.name:~$*.zip

NamE: AWS RDS Security Group Deletion
	description: 
		     Identifies the deletion of an Amazon Relational
		     Database Service (RDS) Security group.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:rds.amazonaws.com and
		     event.action:DeleteDBSecurityGroup and event.outcome:success

NamE: SharePoint Malware File Upload
	description: 
		     Identifies the occurence of files uploaded to
		     SharePoint being detected as Malware by the file scanning
		     engine. Attackers can use File Sharing and Organization
		     Repositories to spread laterally within the company and amplify
		     their access. Users can inadvertently share these files without
		     knowing their maliciousness, giving adversaries opportunities
		     to gain initial access to other endpoints in the environment.
	query: 
		     event.dataset:o365.audit and event.provider:SharePoint
		     and event.code:SharePointFileOperation and
		     event.action:FileMalwareDetected

NamE: AWS CloudTrail Log Deleted
	description: 
		     Identifies the deletion of an AWS log trail. An
		     adversary may delete trails in an attempt to evade defenses.
	query: 
		     event.dataset:aws.cloudtrail     and
		     event.provider:cloudtrail.amazonaws.com     and
		     event.action:DeleteTrail     and event.outcome:success

NamE: PowerShell Keylogging Script
	description: 
		     Detects the use of Win32 API Functions that can
		     be used to capture user keystrokes in PowerShell scripts.
		     Attackers use this technique to capture user input, looking for
		     credentials and/or other valuable data.
	query: 
		     event.category:process and host.os.type:windows and
		     (    powershell.file.script_block_text : (GetAsyncKeyState or
		     NtUserGetAsyncKeyState or GetKeyboardState or "Get-Keystrokes")
		     or    powershell.file.script_block_text : (
		     (SetWindowsHookA or SetWindowsHookW or SetWindowsHookEx or
		     SetWindowsHookExA or NtUserSetWindowsHookEx) and
		     (GetForegroundWindow or GetWindowTextA or GetWindowTextW or
		     "WM_KEYBOARD_LL" or "WH_MOUSE_LL")    )    ) and not user.id :
		     "S-1-5-18"   and not powershell.file.script_block_text : (
		     "sentinelbreakpoints" and "Set-PSBreakpoint"   )

NamE: GCP Pub/Sub Topic Creation
	description: 
		     Identifies the creation of a topic in Google
		     Cloud Platform (GCP). In GCP, the publisher-subscriber
		     relationship (Pub/Sub) is an asynchronous messaging service
		     that decouples event-producing and event-processing services. A
		     topic is used to forward messages from publishers to
		     subscribers.
	query: 
		     event.dataset:gcp.audit and
		     event.action:google.pubsub.v*.Publisher.CreateTopic and
		     event.outcome:success

NamE: Azure Privilege Identity Management Role Modified
	description: 
		     Azure Active Directory (AD) Privileged Identity
		     Management (PIM) is a service that enables you to manage,
		     control, and monitor access to important resources in an
		     organization. PIM can be used to manage the built-in Azure
		     resource roles such as Global Administrator and Application
		     Administrator. An adversary may add a user to a PIM role in
		     order to maintain persistence in their target's environment or
		     modify a PIM role to weaken their target's security controls.
	query: 
		     event.dataset:azure.auditlogs and
		     azure.auditlogs.operation_name:"Update role setting in PIM" and
		     event.outcome:(Success or success)

NamE: Potential WPAD Spoofing via DNS Record Creation
	description: 
		     Identifies the creation of a DNS record that is
		     potentially meant to enable WPAD spoofing. Attackers can
		     disable the Global Query Block List (GQBL) and create a "wpad"
		     record to exploit hosts running WPAD with default settings for
		     privilege escalation and lateral movement.
	query: 
		     any where host.os.type == "windows" and event.code ==
		     "5137" and winlog.event_data.ObjectDN : "DC=wpad,*"

NamE: First Time AWS Cloudformation Stack Creation by User
	description: 
		     This rule detects the first time a principal
		     calls AWS Cloudwatch `CreateStack` or `CreateStackSet` API.
		     Cloudformation is used to create a single collection of cloud
		     resources called a stack, via a defined template file. An
		     attacker with the appropriate privileges could leverage
		     Cloudformation to create specific resources needed to further
		     exploit the environment. This is a new terms rule that looks
		     for the first instance of this behavior in the last 10 days for
		     a role or IAM user within a particular account.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:cloudformation.amazonaws.com and
		     event.action: (CreateStack or CreateStackSet) and
		     event.outcome:success

NamE: Unusual High Denied Topic Blocks Detected
	description: 
		     Detects repeated compliance violation 'BLOCKED'
		     actions coupled with specific policy name such as
		     'topic_policy', indicating persistent misuse or attempts to
		     probe the model's denied topics.
	query: 
		     from logs-aws_bedrock.invocation-* | MV_EXPAND
		     gen_ai.policy.name | where gen_ai.policy.action == "BLOCKED"
		     and gen_ai.compliance.violation_detected == "true" and
		     gen_ai.policy.name == "topic_policy" | keep user.id | stats
		     denied_topics = count() by user.id | where denied_topics > 5 |
		     sort denied_topics desc

NamE: Kubernetes User Exec into Pod
	description: 
		     This rule detects a user attempt to establish a
		     shell session into a pod using the 'exec' command. Using the
		     'exec' command in a pod allows a user to establish a temporary
		     shell session and execute any process/commands in the pod. An
		     adversary may call bash to gain a persistent interactive shell
		     which will allow access to any data the pod has permissions to,
		     including secrets.
	query: 
		     event.dataset : "kubernetes.audit_logs"   and kubernet
		     es.audit.annotations.authorization_k8s_io/decision:"allow"
		     and kubernetes.audit.verb:"create"   and
		     kubernetes.audit.objectRef.resource:"pods"   and
		     kubernetes.audit.objectRef.subresource:"exec"

NamE: PowerShell Invoke-NinjaCopy script
	description: 
		     Detects PowerShell scripts that contain the
		     default exported functions used on Invoke-NinjaCopy. Attackers
		     can use Invoke-NinjaCopy to read SYSTEM files that are normally
		     locked, such as the NTDS.dit file or registry hives.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (     "StealthReadFile" or
		     "StealthReadFileAddr" or     "StealthCloseFileDelegate" or
		     "StealthOpenFile" or     "StealthCloseFile" or
		     "StealthReadFile" or     "Invoke-NinjaCopy"    )   and not
		     user.id : "S-1-5-18"   and not
		     powershell.file.script_block_text : (     "sentinelbreakpoints"
		     and "Set-PSBreakpoint" and "PowerSploitIndicators"   )

NamE: Permission Theft - Detected - Elastic Endgame
	description: 
		     Elastic Endgame detected Permission Theft. Click
		     the Elastic Endgame icon in the event.module column or the link
		     in the rule.reference column for additional information.
	query: 
		     event.kind:alert and event.module:endgame and
		     endgame.metadata.type:detection and
		     (event.action:token_protection_event or
		     endgame.event_subtype_full:token_protection_event)

NamE: Web Application Suspicious Activity: Unauthorized Method
	description: 
		     A request to a web application returned a 405
		     response, which indicates the web application declined to
		     process the request because the HTTP method is not allowed for
		     the resource.
	query: 
		     http.response.status_code:405

NamE: IPv4/IPv6 Forwarding Activity
	description: 
		     This rule monitors for the execution of commands
		     that enable IPv4 and IPv6 forwarding on Linux systems. Enabling
		     IP forwarding can be used to route network traffic between
		     different network interfaces, potentially allowing attackers to
		     pivot between networks, exfiltrate data, or establish command
		     and control channels.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "start", "exec_event")
		     and process.parent.executable != null and process.command_line
		     like (   "*net.ipv4.ip_forward*",
		     "*/proc/sys/net/ipv4/ip_forward*",
		     "*net.ipv6.conf.all.forwarding*",
		     "*/proc/sys/net/ipv6/conf/all/forwarding*" ) and (
		     (process.name == "sysctl" and process.args like ("*-w*",
		     "*--write*", "*=*")) or   (     process.name in ("bash",
		     "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish") and
		     process.args == "-c" and     process.command_line like "*echo
		     *"   ) ) and not process.parent.name like~ ("privsep-helper",
		     "platform-python*", "init.ipv6-global", "wsl-bootstrap")

NamE: Suspicious PowerShell Engine ImageLoad
	description: 
		     Identifies the PowerShell engine being invoked
		     by unexpected processes. Rather than executing PowerShell
		     functionality with powershell.exe, some attackers do this to
		     operate more stealthily.
	query: 
		     host.os.type:windows and event.category:library and
		     dll.name:("System.Management.Automation.dll" or
		     "System.Management.Automation.ni.dll") and    not (
		     process.code_signature.subject_name:("Microsoft Corporation" or
		     "Microsoft Dynamic Code Publisher" or "Microsoft Windows") and
		     process.code_signature.trusted:true and not
		     process.name.caseless:("regsvr32.exe" or "rundll32.exe")   )
		     and    not (
		     process.executable.caseless:(C\:\\Program*Files*\(x86\)\\*.exe
		     or C\:\\Program*Files\\*.exe) and
		     process.code_signature.trusted:true   ) and    not (
		     process.executable.caseless: C\:\\Windows\\Lenovo\\*.exe and
		     process.code_signature.subject_name:"Lenovo" and
		     process.code_signature.trusted:true   ) and    not (
		     process.executable.caseless:
		     "C:\\ProgramData\\chocolatey\\choco.exe" and
		     process.code_signature.subject_name:"Chocolatey Software, Inc."
		     and process.code_signature.trusted:true   ) and not
		     process.executable.caseless : "C:\\Windows\\System32\\WindowsPo
		     werShell\\v1.0\\powershell.exe"

NamE: TCC Bypass via Mounted APFS Snapshot Access
	description: 
		     Identifies the use of the mount_apfs command to
		     mount the entire file system through Apple File System (APFS)
		     snapshots as read-only and with the noowners flag set. This
		     action enables the adversary to access almost any file in the
		     file system, including all user data and files protected by
		     Apple’s privacy framework (TCC).
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:(start or process_started) and
		     process.name:mount_apfs and
		     process.args:(/System/Volumes/Data and noowners)

NamE: WebProxy Settings Modification
	description: 
		     Identifies the use of the built-in networksetup
		     command to configure webproxy settings. This may indicate an
		     attempt to hijack web browser traffic for credential access via
		     traffic sniffing or redirection.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:start and  process.name : networksetup and
		     process.args : (("-setwebproxy" or "-setsecurewebproxy" or
		     "-setautoproxyurl") and not (Bluetooth or off)) and  not
		     process.parent.executable :
		     ("/Library/PrivilegedHelperTools/com.80pct.FreedomHelper" or
		     "/Applications/Fiddler Everywhere.app/Contents/Resources/app/ou
		     t/WebServer/Fiddler.WebUi" or
		     "/usr/libexec/xpcproxy") and  not
		     process.Ext.effective_parent.executable :
		     ("/Applications/Proxyman.app/Contents/MacOS/Proxyman" or
		     "/Applications/Incoggo.app/Contents/MacOS/Incoggo.app")

NamE: AWS CloudWatch Log Group Deletion
	description: 
		     Identifies the deletion of a specified AWS
		     CloudWatch log group. When a log group is deleted, all the
		     archived log events associated with the log group are also
		     permanently deleted.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:logs.amazonaws.com and
		     event.action:DeleteLogGroup and event.outcome:success

NamE: AWS GuardDuty Detector Deletion
	description: 
		     Identifies the deletion of an Amazon GuardDuty
		     detector. Upon deletion, GuardDuty stops monitoring the
		     environment and all existing findings are lost.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:guardduty.amazonaws.com and
		     event.action:DeleteDetector and event.outcome:success

NamE: AWS IAM Customer-Managed Policy Attached to Role by Rare User
	description: 
		     Detects when an AWS Identity and Access
		     Management (IAM) customer-managed policy is attached to a role
		     by an unusual or unauthorized user. Customer-managed policies
		     are policies created and controlled within an AWS account,
		     granting specific permissions to roles or users when attached.
		     This rule identifies potential privilege escalation by flagging
		     cases where a customer-managed policy is attached to a role by
		     an unexpected actor, which could signal unauthorized access or
		     misuse. Attackers may attach policies to roles to expand
		     permissions and elevate their privileges within the AWS
		     environment. This is a [New
		     Terms](https://www.elastic.co/guide/en/security/current/rules-
		     ui-create.html#create-new-terms-rule) rule that uses the
		     `aws.cloudtrail.user_identity.arn` and
		     `aws.cloudtrail.flattened.request_parameters.roleName` fields
		     to check if the combination of the actor ARN and target role
		     name has not been seen in the last 14 days.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "iam.amazonaws.com"     and event.action:
		     "AttachRolePolicy"     and event.outcome: "success"     and not
		     aws.cloudtrail.flattened.request_parameters.policyArn:
		     arn\:aws\:iam\:\:aws\:policy*

NamE: Kubernetes Exposed Service Created With Type NodePort
	description: 
		     This rule detects an attempt to create or modify
		     a service as type NodePort. The NodePort service allows a user
		     to externally expose a set of labeled pods to the internet.
		     This creates an open port on every worker node in the cluster
		     that has a pod for that service. When external traffic is
		     received on that open port, it directs it to the specific pod
		     through the service representing it. A malicious user can
		     configure a service as type Nodeport in order to intercept
		     traffic from other pods or nodes, bypassing firewalls and other
		     network security measures configured for load balancers within
		     a cluster. This creates a direct method of communication
		     between the cluster and the outside world, which could be used
		     for more malicious behavior and certainly widens the attack
		     surface of your cluster.
	query: 
		     event.dataset : "kubernetes.audit_logs"   and kubernet
		     es.audit.annotations.authorization_k8s_io/decision:"allow"
		     and kubernetes.audit.objectRef.resource:"services"   and
		     kubernetes.audit.verb:("create" or "update" or "patch")   and
		     kubernetes.audit.requestObject.spec.type:"NodePort"

NamE: Suspicious Activity Reported by Okta User
	description: 
		     Detects when a user reports suspicious activity
		     for their Okta account. These events should be investigated, as
		     they can help security teams identify when an adversary is
		     attempting to gain access to their network.
	query: 
		     event.dataset:okta.system and event.action:user.accoun
		     t.report_suspicious_activity_by_enduser

NamE: Azure Kubernetes Events Deleted
	description: 
		     Identifies when events are deleted in Azure
		     Kubernetes. Kubernetes events are objects that log any state
		     changes. Example events are a container creation, an image
		     pull, or a pod scheduling on a node. An adversary may delete
		     events in Azure Kubernetes in an attempt to evade detection.
	query: 
		     event.dataset:azure.activitylogs and azure.activitylog
		     s.operation_name:"MICROSOFT.KUBERNETES/CONNECTEDCLUSTERS/EVENTS
		     .K8S.IO/EVENTS/DELETE" and event.outcome:(Success or success)

NamE: Potential Pspy Process Monitoring Detected
	description: 
		     This rule leverages auditd to monitor for
		     processes scanning different processes within the /proc
		     directory using the openat syscall. This is a strong indication
		     for the usage of the pspy utility. Attackers may leverage the
		     pspy process monitoring utility to monitor system processes
		     without requiring root permissions, in order to find potential
		     privilege escalation vectors.
	query: 
		     sequence by process.pid, host.id with maxspan=5s
		     [file where host.os.type == "linux" and auditd.data.syscall ==
		     "openat" and file.path == "/proc" and    auditd.data.a0 :
		     ("ffffffffffffff9c", "ffffff9c") and auditd.data.a2 : ("80000",
		     "88000") and    not process.name in ("agentbeat", "packetbeat")
		     ] with runs=10

NamE: User Added to the Admin Group
	description: 
		     Identifies users being added to the admin group.
		     This could be an indication of privilege escalation activity.
	query: 
		     configuration where host.os.type == "macos" and
		     event.type == "change" and   event.action == "od_group_add" and
		     group.name:"admin"

NamE: Suspicious Service was Installed in the System
	description: 
		     Identifies the creation of a new Windows service
		     with suspicious Service command values. Windows services
		     typically run as SYSTEM and can be used for privilege
		     escalation and persistence.
	query: 
		     any where   (event.code : "4697" and
		     (winlog.event_data.ServiceFileName :             ("*COMSPEC*",
		     "*\\127.0.0.1*", "*Admin$*", "*powershell*", "*rundll32*",
		     "*cmd.exe*", "*PSEXESVC*",              "*echo*",
		     "*RemComSvc*", "*.bat*", "*.cmd*", "*certutil*", "*vssadmin*",
		     "*certmgr*", "*bitsadmin*",              "*\\Users\\*",
		     "*\\Windows\\Temp\\*", "*\\Windows\\Tasks\\*",
		     "*\\PerfLogs\\*", "*\\Windows\\Debug\\*",
		     "*regsvr32*", "*msbuild*") or
		     winlog.event_data.ServiceFileName regex~
		     """%systemroot%\\[a-z0-9]+\.exe""")) or    (event.code : "7045"
		     and    winlog.event_data.ImagePath : (        "*COMSPEC*",
		     "*\\127.0.0.1*", "*Admin$*", "*powershell*", "*rundll32*",
		     "*cmd.exe*", "*PSEXESVC*",        "*echo*", "*RemComSvc*",
		     "*.bat*", "*.cmd*", "*certutil*", "*vssadmin*", "*certmgr*",
		     "*bitsadmin*",        "*\\Users\\*", "*\\Windows\\Temp\\*",
		     "*\\Windows\\Tasks\\*", "*\\PerfLogs\\*",
		     "*\\Windows\\Debug\\*",        "*regsvr32*", "*msbuild*"))

NamE: PowerShell Script with Encryption/Decryption Capabilities
	description: 
		     Identifies the use of Cmdlets and methods
		     related to encryption/decryption of files in PowerShell
		     scripts, which malware and offensive security tools can abuse
		     to encrypt data or decrypt payloads to bypass security
		     solutions.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (     (
		     "Cryptography.AESManaged" or
		     "Cryptography.RijndaelManaged" or
		     "Cryptography.SHA1Managed" or
		     "Cryptography.SHA256Managed" or
		     "Cryptography.SHA384Managed" or
		     "Cryptography.SHA512Managed" or
		     "Cryptography.SymmetricAlgorithm" or
		     "PasswordDeriveBytes" or       "Rfc2898DeriveBytes"     ) and
		     (       CipherMode and PaddingMode     ) and     (
		     ".CreateEncryptor" or       ".CreateDecryptor"     )   ) and
		     not user.id : "S-1-5-18" and   not (     file.name :
		     "Bootstrap.Octopus.FunctionAppenderContext.ps1" and
		     powershell.file.script_block_text : ("function Decrypt-
		     Variables" or "github.com/OctopusDeploy")   )

NamE: KRBTGT Delegation Backdoor
	description: 
		     Identifies the modification of the msDS-
		     AllowedToDelegateTo attribute to KRBTGT. Attackers can use this
		     technique to maintain persistence to the domain by having the
		     ability to request tickets for the KRBTGT service.
	query: 
		     iam where event.code == "4738" and
		     winlog.event_data.AllowedToDelegateTo : "*krbtgt*"

NamE: GCP Logging Sink Deletion
	description: 
		     Identifies a Logging sink deletion in Google
		     Cloud Platform (GCP). Every time a log entry arrives, Logging
		     compares the log entry to the sinks in that resource. Each sink
		     whose filter matches the log entry writes a copy of the log
		     entry to the sink's export destination. An adversary may delete
		     a Logging sink to evade detection.
	query: 
		     event.dataset:gcp.audit and event.action:google.loggin
		     g.v*.ConfigServiceV*.DeleteSink and event.outcome:success

NamE: Suspicious Module Loaded by LSASS
	description: 
		     Identifies LSASS loading an unsigned or
		     untrusted DLL. Windows Security Support Provider (SSP) DLLs are
		     loaded into LSSAS process at system start. Once loaded into the
		     LSA, SSP DLLs have access to encrypted and plaintext passwords
		     that are stored in Windows, such as any logged-on user's Domain
		     password or smart card PINs.
	query: 
		     any where event.category in ("library", "driver") and
		     host.os.type == "windows" and   process.executable :
		     "?:\\Windows\\System32\\lsass.exe" and   not
		     (dll.code_signature.subject_name :                ("Microsoft
		     Windows",                 "Microsoft Corporation",
		     "Microsoft Windows Publisher",                 "Microsoft
		     Windows Software Compatibility Publisher",
		     "Microsoft Windows Hardware Compatibility Publisher",
		     "McAfee, Inc.",                 "SecMaker AB",
		     "HID Global Corporation",                 "HID Global",
		     "Apple Inc.",                 "Citrix Systems, Inc.",
		     "Dell Inc",                 "Hewlett-Packard Company",
		     "Symantec Corporation",                 "National Instruments
		     Corporation",                 "DigitalPersona, Inc.",
		     "Novell, Inc.",                 "gemalto",
		     "EasyAntiCheat Oy",                 "Entrust Datacard
		     Corporation",                 "AuriStor, Inc.",
		     "LogMeIn, Inc.",                 "VMware, Inc.",
		     "Istituto Poligrafico e Zecca dello Stato S.p.A.",
		     "Nubeva Technologies Ltd",                 "Micro Focus (US),
		     Inc.",                 "Yubico AB",                 "GEMALTO
		     SA",                 "Secure Endpoints, Inc.",
		     "Sophos Ltd",                 "Morphisec Information Security
		     2014 Ltd",                 "Entrust, Inc.",
		     "Nubeva Technologies Ltd",                 "Micro Focus (US),
		     Inc.",                 "F5 Networks Inc",
		     "Bit4id",                 "Thales DIS CPL USA, Inc.",
		     "Micro Focus International plc",                 "HYPR Corp",
		     "Intel(R) Software Development Products",                 "PGP
		     Corporation",                 "Parallels International GmbH",
		     "FrontRange Solutions Deutschland GmbH",
		     "SecureLink, Inc.",                 "Tidexa OU",
		     "Amazon Web Services, Inc.",                 "SentryBay
		     Limited",                 "Audinate Pty Ltd",
		     "CyberArk Software Ltd.",                 "McAfeeSysPrep",
		     "NVIDIA Corporation PE Sign v2016",                 "Trend
		     Micro, Inc.",                 "Fortinet Technologies (Canada)
		     Inc.",                 "Carbon Black, Inc.") and
		     dll.code_signature.status : ("trusted", "errorExpired",
		     "errorCode_endpoint*", "errorChaining")) and       not
		     dll.hash.sha256 :                 ("811a03a5d7c03802676d2613d74
		     1be690b3461022ea925eb6b2651a5be740a4c",                  "11815
		     42d9cfd63fb00c76242567446513e6773ea37db6211545629ba2ecf26a1",
		     "ed6e735aa6233ed262f50f67585949712f1622751035db256811b4088c214c
		     e3",                  "26be2e4383728eebe191c0ab19706188f0e9592a
		     dd2e0bf86b37442083ae5e12",                  "9367e78b84ef30cf38
		     ab27776605f2645e52e3f6e93369c674972b668a444faa",
		     "d46cc934765c5ecd53867070f540e8d6f7701e834831c51c2b0552aba87192
		     1b",                  "0f77a3826d7a5cd0533990be0269d951a88a5c27
		     7bc47cff94553330b715ec61",                  "4aca034d3d85a9e912
		     7b5d7a10882c2ef4c3e0daa3329ae2ac1d0797398695fb",
		     "86031e69914d9d33c34c2f4ac4ae523cef855254d411f88ac26684265c981d
		     95")

NamE: Remote System Discovery Commands
	description: 
		     Discovery of remote system information using
		     built-in commands, which may be used to move laterally.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   ((process.name : "nbtstat.exe" and
		     process.args : ("-n", "-s")) or   (process.name : "arp.exe" and
		     process.args : "-a") or   (process.name : "nltest.exe" and
		     process.args : ("/dclist", "/dsgetdc")) or   (process.name :
		     "nslookup.exe" and process.args : "*_ldap._tcp.dc.*") or
		     (process.name: ("dsquery.exe", "dsget.exe") and process.args:
		     "subnet") or   ((((process.name : "net.exe" or
		     process.pe.original_file_name == "net.exe") or
		     ((process.name : "net1.exe" or process.pe.original_file_name ==
		     "net1.exe") and not         process.parent.name : "net.exe"))
		     and         process.args : "group" and process.args : "/domain"
		     and not process.args : "/add"))) and   not   (     (
		     process.name : "arp.exe" and       process.parent.executable :
		     (
		     "?:\\ProgramData\\CentraStage\\AEMAgent\\AEMAgent.exe",
		     "?:\\Program Files (x86)\\Citrix\\Workspace Environment
		     Management Agent\\Citrix.Wem.Agent.Service.exe",
		     "?:\\Program Files
		     (x86)\\Lansweeper\\Service\\LansweeperService.exe"       )
		     )   )

NamE: Dracut Module Creation
	description: 
		     This rule detects the creation of Dracut module
		     files on Linux systems. Dracut is a tool used to generate an
		     initramfs image that is used to boot the system. Dracut modules
		     are scripts that are executed during the initramfs image
		     generation process. Attackers may create malicious Dracut
		     modules to execute arbitrary code at boot time, which can be
		     leveraged to maintain persistence on a Linux system.
	query: 
		     file where host.os.type == "linux" and event.type ==
		     "creation" and process.executable != null and file.path like~
		     ("/lib/dracut/modules.d/*", "/usr/lib/dracut/modules.d/*") and
		     not (   process.executable in (     "/bin/dpkg",
		     "/usr/bin/dpkg", "/bin/dockerd", "/usr/bin/dockerd",
		     "/usr/sbin/dockerd", "/bin/microdnf",     "/usr/bin/microdnf",
		     "/bin/rpm", "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd",
		     "/bin/yum", "/usr/bin/yum",     "/bin/dnf", "/usr/bin/dnf",
		     "/bin/podman", "/usr/bin/podman", "/bin/dnf-automatic",
		     "/usr/bin/dnf-automatic",     "/bin/pacman", "/usr/bin/pacman",
		     "/usr/bin/dpkg-divert", "/bin/dpkg-divert", "/sbin/apk",
		     "/usr/sbin/apk",     "/usr/local/sbin/apk", "/usr/bin/apt",
		     "/usr/sbin/pacman", "/bin/podman", "/usr/bin/podman",
		     "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/lib/snapd/snapd", "/usr/local/bin/dockerd",
		     "/usr/bin/crio", "/usr/sbin/crond",
		     "/opt/puppetlabs/puppet/bin/ruby", "/usr/libexec/platform-
		     python", "/kaniko/kaniko-executor",
		     "/usr/local/bin/dockerd", "/usr/bin/podman", "/bin/install",
		     "/proc/self/exe", "/usr/lib/systemd/systemd",
		     "/usr/sbin/sshd", "/usr/bin/gitlab-runner",
		     "/opt/gitlab/embedded/bin/ruby", "/usr/sbin/gdm",
		     "/usr/bin/install",
		     "/usr/local/manageengine/uems_agent/bin/dcregister",
		     "/usr/local/bin/pacman"   ) or   process.executable like~ (
		     "/nix/store/*", "/var/lib/dpkg/*", "/tmp/vmis.*", "/snap/*",
		     "/dev/fd/*", "/usr/lib/virtualbox/*"   ) or   file.extension in
		     ("swp", "swpx", "swx", "dpkg-remove") or   (process.name ==
		     "sed" and file.name : "sed*") )

NamE: Sublime Plugin or Application Script Modification
	description: 
		     Adversaries may create or modify the Sublime
		     application plugins or scripts to execute a malicious payload
		     each time the Sublime application is started.
	query: 
		     file where host.os.type == "macos" and event.type in
		     ("change", "creation") and file.extension : "py" and
		     file.path :     (       "/Users/*/Library/Application
		     Support/Sublime Text*/Packages/*.py",
		     "/Applications/Sublime Text.app/Contents/MacOS/sublime.py"
		     ) and   not process.executable :     (
		     "/Applications/Sublime Text*.app/Contents/*",
		     "/usr/local/Cellar/git/*/bin/git",
		     "/Library/Developer/CommandLineTools/usr/bin/git",
		     "/usr/libexec/xpcproxy",       "/System/Library/PrivateFramewor
		     ks/DesktopServicesPriv.framework/Versions/A/Resources/DesktopSe
		     rvicesHelper"     )

NamE: Unusual Child Process of dns.exe
	description: 
		     Identifies an unexpected process spawning from
		     dns.exe, the process responsible for Windows DNS server
		     services, which may indicate activity related to remote code
		     execution or other forms of exploitation.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and process.parent.name : "dns.exe" and   not
		     process.name : "conhost.exe"

NamE: Microsoft Exchange Server UM Spawning Suspicious Processes
	description: 
		     Identifies suspicious processes being spawned by
		     the Microsoft Exchange Server Unified Messaging (UM) service.
		     This activity has been observed exploiting CVE-2021-26857.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.name : ("UMService.exe",
		     "UMWorkerProcess.exe") and     not process.executable : (
		     "?:\\Windows\\System32\\werfault.exe",
		     "?:\\Windows\\System32\\wermgr.exe",           "?:\\Program
		     Files\\Microsoft\\Exchange
		     Server\\V??\\Bin\\UMWorkerProcess.exe",           "?:\\Program
		     Files\\Microsoft\\Exchange Server\\Bin\\UMWorkerProcess.exe",
		     "D:\\Exchange 2016\\Bin\\UMWorkerProcess.exe",
		     "E:\\ExchangeServer\\Bin\\UMWorkerProcess.exe",
		     "D:\\Exchange\\Bin\\UMWorkerProcess.exe",
		     "D:\\Exchange Server\\Bin\\UMWorkerProcess.exe",
		     "E:\\Exchange Server\\V15\\Bin\\UMWorkerProcess.exe",
		     "\\Device\\HarddiskVolume?\\Windows\\System32\\werfault.exe",
		     "\\Device\\HarddiskVolume?\\Windows\\System32\\wermgr.exe",
		     "\\Device\\HarddiskVolume?\\Program Files\\Microsoft\\Exchange
		     Server\\V??\\Bin\\UMWorkerProcess.exe",
		     "\\Device\\HarddiskVolume?\\Program Files\\Microsoft\\Exchange
		     Server\\Bin\\UMWorkerProcess.exe",
		     "\\Device\\HarddiskVolume?\\Exchange
		     2016\\Bin\\UMWorkerProcess.exe",           "\\Device\\HarddiskV
		     olume?\\ExchangeServer\\Bin\\UMWorkerProcess.exe",           "\
		     \Device\\HarddiskVolume?\\Exchange\\Bin\\UMWorkerProcess.exe",
		     "\\Device\\HarddiskVolume?\\Exchange
		     Server\\Bin\\UMWorkerProcess.exe",
		     "\\Device\\HarddiskVolume?\\Exchange
		     Server\\V15\\Bin\\UMWorkerProcess.exe"     )

NamE: Adding Hidden File Attribute via Attrib
	description: 
		     Adversaries can add the 'hidden' attribute to
		     files to hide them from the user in an attempt to evade
		     detection.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (process.name : "attrib.exe" or
		     ?process.pe.original_file_name == "ATTRIB.EXE") and
		     process.args : "+h" and   not (process.parent.name: "cmd.exe"
		     and process.command_line: "attrib  +R +H +S +A *.cui")

NamE: Privileged Docker Container Creation
	description: 
		     This rule leverages the new_terms rule type to
		     identify the creation of a potentially unsafe docker container
		     from an unusual parent process. Attackers can use the
		     `--privileged` flag to create containers with escalated
		     privileges, which can lead to trivial privilege escalation,
		     docker escaping and persistence. access.
	query: 
		     host.os.type:linux and event.category:process and
		     event.type:start and event.action:exec and process.name:docker
		     and process.args:(run and --privileged)

NamE: Potential Process Name Stomping with Prctl
	description: 
		     This rule leverages Auditd data to detect the
		     use of the `prctl` syscall to potentially hide a process by
		     changing its name. The `prctl` syscall is used to control
		     various process attributes. Attackers can use this syscall to
		     change the name of a process to a hidden directory or file,
		     making it harder to detect. The query looks for the `prctl`
		     syscall with the `PR_SET_NAME` argument set to `f` (PR_SET_NAME
		     is used to set the name of a process).
	query: 
		     process where host.os.type == "linux" and
		     auditd.data.syscall == "prctl" and auditd.data.a0 == "f" and
		     process.executable like (   "/boot/*", "/dev/shm/*",
		     "/etc/cron.*/*", "/etc/init.d/*", "/var/run/*", "/etc/update-
		     motd.d/*",   "/tmp/*", "/var/log/*", "/var/tmp/*", "/home/*",
		     "/run/shm/*", "/run/*", "./*" )

NamE: M365 OneDrive Excessive File Downloads with OAuth Token
	description: 
		     Identifies when an excessive number of files are
		     downloaded from OneDrive using OAuth authentication.
		     Adversaries may conduct phishing campaigns to steal OAuth
		     tokens and impersonate users. These access tokens can then be
		     used to download files from OneDrive.
	query: 
		     FROM logs-o365.audit-* | WHERE @timestamp > now() - 14
		     day | WHERE     event.dataset == "o365.audit" and      //
		     filter on files downloaded from OneDrive     event.provider ==
		     "OneDrive" and     event.action == "FileDownloaded" and      //
		     filter on OAuth authentication which encompasses device code
		     workflow     o365.audit.AuthenticationType == "OAuth"     and
		     event.outcome == "success" // bucket authentication attempts by
		     1 minute | EVAL target_time_window = DATE_TRUNC(1 minutes,
		     @timestamp) | KEEP target_time_window, o365.audit.UserId,
		     file.name, source.ip  // aggregate on unique file names and
		     download attempts | STATS unique_file_count =
		     count_distinct(file.name), download_attempt_count = count(*) BY
		     target_time_window, o365.audit.UserId, source.ip  // adjustable
		     range for "excessive" unique files that were downloaded | WHERE
		     unique_file_count >= 25

NamE: Zoom Meeting with no Passcode
	description: 
		     This rule identifies Zoom meetings that are
		     created without a passcode. Meetings without a passcode are
		     susceptible to Zoombombing. Zoombombing is carried out by
		     taking advantage of Zoom sessions that are not protected with a
		     passcode. Zoombombing refers to the unwanted, disruptive
		     intrusion, generally by Internet trolls and hackers, into a
		     video conference call. In a typical Zoombombing incident, a
		     teleconferencing session is hijacked by the insertion of
		     material that is lewd, obscene, racist, or antisemitic in
		     nature, typically resulting of the shutdown of the session.
	query: 
		     event.type:creation and event.module:zoom and
		     event.dataset:zoom.webhook and   event.action:meeting.created
		     and not zoom.meeting.password:*

NamE: Process Started with Executable Stack
	description: 
		     This rule monitors the syslog log file for
		     messages related to instances of processes that are started
		     with an executable stack. This can be an indicator of a process
		     that is attempting to execute code from the stack, which can be
		     a security risk.
	query: 
		     host.os.type:"linux" and event.dataset:"system.syslog"
		     and process.name:"kernel" and message:"started with executable
		     stack"

NamE: Signed Proxy Execution via MS Work Folders
	description: 
		     Identifies the use of Windows Work Folders to
		     execute a potentially masqueraded control.exe file in the
		     current working directory. Misuse of Windows Work Folders could
		     indicate malicious activity.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : "control.exe" and
		     process.parent.name : "WorkFolders.exe" and   not
		     process.executable : (
		     "?:\\Windows\\System32\\control.exe",
		     "?:\\Windows\\SysWOW64\\control.exe",
		     "\\Device\\HarddiskVolume?\\Windows\\System32\\control.exe",
		     "\\Device\\HarddiskVolume?\\Windows\\SysWOW64\\control.exe"   )

NamE: Potential Remote Code Execution via Web Server
	description: 
		     Identifies suspicious commands executed via a
		     web server, which may suggest a vulnerability and remote shell
		     access. Attackers may exploit a vulnerability in a web
		     application to execute commands via a web server, or place a
		     backdoor file that can be abused to gain code execution as a
		     mechanism for persistence.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start")
		     and process.parent.executable : (   "/usr/sbin/nginx",
		     "/usr/local/sbin/nginx",   "/usr/sbin/apache",
		     "/usr/local/sbin/apache",   "/usr/sbin/apache2",
		     "/usr/local/sbin/apache2",   "/usr/sbin/php*",
		     "/usr/local/sbin/php*",   "/usr/sbin/lighttpd",
		     "/usr/local/sbin/lighttpd",   "/usr/sbin/hiawatha",
		     "/usr/local/sbin/hiawatha",   "/usr/local/bin/caddy",
		     "/usr/local/lsws/bin/lswsctrl",   "*/bin/catalina.sh" ) and
		     process.name : (   "bash", "dash", "sh", "tcsh", "csh", "zsh",
		     "ksh", "fish", "python*", "php*", "perl", "ruby", "lua*",
		     "openssl", "nc",   "netcat", "ncat", "telnet", "awk", "socat"
		     ) and process.args : (   "whoami", "id", "uname", "cat",
		     "hostname", "ip", "curl", "wget", "pwd", "ls", "cd", "python*",
		     "php*", "perl",   "ruby", "lua*", "openssl", "nc", "netcat",
		     "ncat", "telnet", "awk", "socat"   ) and not process.name ==
		     "phpquery"

NamE: Parent Process PID Spoofing
	description: 
		     Identifies parent process spoofing used to
		     thwart detection. Adversaries may spoof the parent process
		     identifier (PPID) of a new process to evade process-monitoring
		     defenses or to elevate privileges.
	query: 
		     /* This rule is compatible with Elastic Endpoint only
		     */  sequence by host.id, user.id with maxspan=3m   [process
		     where host.os.type == "windows" and event.type == "start" and
		     process.Ext.token.integrity_level_name != "system" and   (
		     process.pe.original_file_name : ("winword.exe", "excel.exe",
		     "outlook.exe", "powerpnt.exe", "eqnedt32.exe",
		     "fltldr.exe", "mspub.exe", "msaccess.exe", "powershell.exe",
		     "pwsh.exe",                                      "cscript.exe",
		     "wscript.exe", "rundll32.exe", "regsvr32.exe", "msbuild.exe",
		     "mshta.exe", "wmic.exe", "cmstp.exe", "msxsl.exe") or
		     (process.executable : ("?:\\Users\\*.exe",
		     "?:\\ProgramData\\*.exe",
		     "?:\\Windows\\Temp\\*.exe",
		     "?:\\Windows\\Tasks\\*") and
		     (process.code_signature.exists == false or
		     process.code_signature.status : "errorBadDigest")) or
		     process.executable : "?:\\Windows\\Microsoft.NET\\*.exe"   )
		     and    not process.executable :
		     ("?:\\Windows\\System32\\WerFaultSecure.exe",
		     "?:\\WINDOWS\\SysWOW64\\WerFaultSecure.exe",
		     "?:\\Windows\\System32\\WerFault.exe",
		     "?:\\Windows\\SysWOW64\\WerFault.exe")   ] by process.pid
		     [process where host.os.type == "windows" and event.type ==
		     "start" and   process.parent.Ext.real.pid > 0 and    /*
		     process.parent.Ext.real.pid is only populated if the parent
		     process pid doesn't match */   not (process.name : "msedge.exe"
		     and process.parent.name : "sihost.exe") and     not
		     process.executable :
		     ("?:\\Windows\\System32\\WerFaultSecure.exe",
		     "?:\\WINDOWS\\SysWOW64\\WerFaultSecure.exe",
		     "?:\\Windows\\System32\\WerFault.exe",
		     "?:\\Windows\\SysWOW64\\WerFault.exe")  ] by
		     process.parent.Ext.real.pid

NamE: Initramfs Unpacking via unmkinitramfs
	description: 
		     This rule detects the unpacking of an initramfs
		     image using the `unmkinitramfs` command on Linux systems. The
		     `unmkinitramfs` command is used to extract the contents of an
		     initramfs image, which is used to boot the system. Attackers
		     may use `unmkinitramfs` to unpack an initramfs image and modify
		     its contents to include malicious code or backdoors, allowing
		     them to maintain persistence on the system.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed") and process.name ==
		     "unmkinitramfs"

NamE: Suspicious Passwd File Event Action
	description: 
		     Monitors for the generation of a passwd password
		     entry via openssl, followed by a file write activity on the
		     "/etc/passwd" file. The "/etc/passwd" file in Linux stores user
		     account information, including usernames, user IDs, group IDs,
		     home directories, and default shell paths. Attackers may
		     exploit a misconfiguration in the "/etc/passwd" file
		     permissions or other privileges to add a new entry to the
		     "/etc/passwd" file with root permissions, and leverage this new
		     user account to login as root.
	query: 
		     sequence by host.id, process.parent.pid with
		     maxspan=1m   [process where host.os.type == "linux" and
		     event.type == "start" and event.action == "exec" and
		     process.name == "openssl" and process.args == "passwd" and
		     user.id != "0"]   [file where host.os.type == "linux" and
		     file.path == "/etc/passwd" and process.parent.pid != 1 and
		     not auditd.data.a2 == "80000" and event.outcome == "success"
		     and user.id != "0"]

NamE: Account Discovery Command via SYSTEM Account
	description: 
		     Identifies when the SYSTEM account uses an
		     account discovery utility. This could be a sign of discovery
		     activity after an adversary has achieved privilege escalation.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (?process.Ext.token.integrity_level_name :
		     "System" or   ?winlog.event_data.IntegrityLevel : "System") and
		     (     process.name : "whoami.exe" or     (       process.name :
		     "net1.exe" and not process.parent.name : "net.exe" and not
		     process.args : ("start", "stop", "/active:*")     )   )

NamE: Potential Masquerading as Browser Process
	description: 
		     Identifies suspicious instances of browser
		     processes, such as unsigned or signed with unusual
		     certificates, that can indicate an attempt to conceal malicious
		     activity, bypass security features such as allowlists, or trick
		     users into executing malware.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (     /* Chrome Related Processes */     (
		     process.name : (         "chrome.exe", "GoogleUpdate.exe",
		     "GoogleCrashHandler64.exe", "GoogleCrashHandler.exe",
		     "GoogleUpdateComRegisterShell64.exe", "GoogleUpdateSetup.exe",
		     "GoogleUpdateOnDemand.exe",         "chrome_proxy.exe",
		     "remote_assistance_host.exe",
		     "remoting_native_messaging_host.exe",
		     "GoogleUpdateBroker.exe"       ) and       not
		     (process.code_signature.subject_name in ("Google LLC", "Google
		     Inc") and process.code_signature.trusted == true) and       not
		     (         process.executable : (           "?:\\Program
		     Files\\HP\\Sure Click\\servers\\chrome.exe",
		     "?:\\Program Files\\HP\\Sure Click\\*\\servers\\chrome.exe"
		     ) and         process.code_signature.subject_name == "Bromium,
		     Inc." and process.code_signature.trusted == true       ) and
		     not (         process.executable : "?:\\Program
		     Files\\dynatrace\\synthetic\\Chrome-bin\\chrome.exe" and
		     process.code_signature.subject_name == "Dynatrace LLC" and
		     process.code_signature.trusted == true       ) and       not (
		     process.executable :
		     "?:\\Users\\*\\Desktop\\CentBrowser\\chrome.exe" and
		     process.code_signature.subject_name == "MV INFORMATICA NORDESTE
		     LTDA" and process.code_signature.trusted == true       ) and
		     not (         process.executable : (
		     "?:\\Users\\*\\AppData\\Local\\ms-
		     playwright\\chromium-*\\chrome-win\\chrome.exe",
		     "?:\\Users\\*\\AppData\\Local\\Programs\\synthetics-
		     recorder\\resources\\local-browsers\\chromium-*\\chrome-
		     win\\chrome.exe",
		     "*\\node_modules\\puppeteer\\*\\win64-*\\chrome-
		     win\\chrome.exe",           "?:\\Program Files (x86)\\Invicti
		     Professional Edition\\chromium\\chrome.exe",
		     "?:\\Program Files\\End2End, Inc\\ARMS Html
		     Engine\\chrome.exe",           "?:\\Users\\*\\AppData\\Local\\*
		     BurpSuitePro\\burpbrowser\\*\\chrome.exe",           "?:\\Users
		     \\*\\AppData\\Roaming\\*BurpSuite\\burpbrowser\\*\\chrome.exe",
		     "?:\\Gradient\\Connector.Service\\runtimes\\win-
		     x64\\native\\chrome.exe",           "?:\\Program Files
		     (x86)\\Netsparker Enterprise Agent-?\\chromium\\chrome.exe"
		     ) and process.args: (                 "--enable-
		     features=NetworkService,NetworkServiceInProcess",
		     "--type=crashpad-handler", "--enable-automation", "--disable-
		     xss-auditor"               )       )     ) or      /* MS Edge
		     Related Processes */     (       process.name : (
		     "msedge.exe", "MicrosoftEdgeUpdate.exe", "identity_helper.exe",
		     "msedgewebview2.exe",         "MicrosoftEdgeWebview2Setup.exe",
		     "MicrosoftEdge_X*.exe", "msedge_proxy.exe",
		     "MicrosoftEdgeUpdateCore.exe", "MicrosoftEdgeUpdateBroker.exe",
		     "MicrosoftEdgeUpdateSetup_X*.exe",
		     "MicrosoftEdgeUpdateComRegisterShell64.exe",
		     "msedgerecovery.exe", "MicrosoftEdgeUpdateSetup.exe"       )
		     and       not (process.code_signature.subject_name ==
		     "Microsoft Corporation" and process.code_signature.trusted ==
		     true) and       not (         process.name :
		     "msedgewebview2.exe" and
		     process.code_signature.subject_name in ("Bromium, Inc.",
		     "Amazon.com Services LLC", "Code Systems Corporation") and
		     process.code_signature.trusted == true       ) and       not
		     process.executable : "?:\\Program Files
		     (x86)\\Microsoft\\EdgeUpdate\\MicrosoftEdgeUpdate.exe"     ) or
		     /* Brave Related Processes */     (       process.name : (
		     "brave.exe", "BraveUpdate.exe", "BraveCrashHandler64.exe",
		     "BraveCrashHandler.exe",         "BraveUpdateOnDemand.exe",
		     "brave_vpn_helper.exe", "BraveUpdateSetup*.exe",
		     "BraveUpdateComRegisterShell64.exe"       ) and       not
		     (process.code_signature.subject_name in ("Brave Software,
		     Inc.", "Google Inc") and process.code_signature.trusted ==
		     true)     ) or      /* Firefox Related Processes */     (
		     process.name : (         "firefox.exe", "pingsender.exe",
		     "default-browser-agent.exe", "maintenanceservice.exe",
		     "plugin-container.exe", "maintenanceservice_tmp.exe",
		     "maintenanceservice_installer.exe",         "minidump-
		     analyzer.exe"       ) and       not
		     (process.code_signature.subject_name == "Mozilla Corporation"
		     and process.code_signature.trusted == true) and       not (
		     process.name : "default-browser-agent.exe" and
		     process.code_signature.subject_name in ("WATERFOX LIMITED") and
		     process.code_signature.trusted == true       ) and       not
		     process.hash.sha256 == "ddc7a6c3a4b50d23daffe8e364c575fd7df9af9
		     711b14d153b09553ddd3670a0" and       not process.executable :
		     "?:\\Users\\*\\AppData\\Local\\ms-
		     playwright\\firefox-*\\firefox\\firefox.exe"     ) or      /*
		     Island Related Processes */     (       process.name : (
		     "Island.exe", "IslandUpdate.exe", "IslandCrashHandler.exe",
		     "IslandCrashHandler64.exe",         "IslandUpdateBroker.exe",
		     "IslandUpdateOnDemand.exe",
		     "IslandUpdateComRegisterShell64.exe",
		     "IslandUpdateSetup.exe"       ) and       not
		     (process.code_signature.subject_name == "Island Technology
		     Inc." and process.code_signature.trusted == true)     ) or
		     /* Opera Related Processes */     (       process.name :
		     ("opera.exe", "opera_*.exe", "browser_assistant.exe") and
		     not (process.code_signature.subject_name in ("Opera Norway AS",
		     "Opera Software AS") and process.code_signature.trusted ==
		     true)     ) or      /* Whale Related Processes */     (
		     process.name : ("whale.exe", "whale_update.exe", "wusvc.exe")
		     and       not (process.code_signature.subject_name == "NAVER
		     Corp." and process.code_signature.trusted == true)     ) or
		     /* Chromium-based Browsers processes */     (
		     process.name : ("chrmstp.exe", "notification_helper.exe",
		     "elevation_service.exe") and       not (
		     process.code_signature.subject_name in (           "Island
		     Technology Inc.",           "Citrix Systems, Inc.",
		     "Brave Software, Inc.",           "Google LLC",
		     "Google Inc",           "Microsoft Corporation",
		     "NAVER Corp.",           "AVG Technologies USA, LLC",
		     "Avast Software s.r.o.",           "PIRIFORM SOFTWARE LIMITED",
		     "NortonLifeLock Inc.",           "Opera Norway AS"         )
		     and process.code_signature.trusted == true       )     )   )

NamE: Memory Swap Modification
	description: 
		     This rule detects memory swap modification
		     events on Linux systems. Memory swap modification can be used
		     to manipulate the system's memory and potentially impact the
		     system's performance. This behavior is commonly observed in
		     malware that deploys miner software such as XMRig.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start")
		     and process.parent.executable != null and process.name in
		     ("swapon", "swapoff") or (   process.command_line like
		     ("*vm.swappiness*", "*/proc/sys/vm/swappiness*") and (
		     (process.name == "sysctl" and process.args like ("*-w*",
		     "*--write*", "*=*")) or     (       process.name in ("bash",
		     "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish") and
		     process.args == "-c" and       process.command_line like "*echo
		     *"     )   ) ) and not process.parent.name in ("lynis",
		     "systemd", "end-zram-swapping", "SyxsenseResponder", "tuned",
		     "platform-python", "timeout")

NamE: Process Started from Process ID (PID) File
	description: 
		     Identifies a new process starting from a process
		     ID (PID), lock or reboot file within the temporary file storage
		     paradigm (tmpfs) directory /var/run directory. On Linux, the
		     PID files typically hold the process ID to track previous
		     copies running and manage other tasks. Certain Linux malware
		     use the /var/run directory for holding data, executables and
		     other tasks, disguising itself or these files as legitimate PID
		     files.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and user.id == "0" and   process.executable regex~
		     """/var/run/\w+\.(pid|lock|reboot)"""

NamE: Linux SSH X11 Forwarding
	description: 
		     This rule monitors for X11 forwarding via SSH.
		     X11 forwarding is a feature that allows users to run graphical
		     applications on a remote server and display the application's
		     graphical user interface on their local machine. Attackers can
		     abuse X11 forwarding for tunneling their GUI-based tools, pivot
		     through compromised systems, and create covert communication
		     channels, enabling lateral movement and facilitating remote
		     control of systems within a network.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2") and process.name in ("ssh", "sshd") and
		     process.args in ("-X", "-Y") and process.args_count >= 3 and
		     process.parent.name in ("bash", "dash", "ash", "sh", "tcsh",
		     "csh", "zsh", "ksh", "fish")

NamE: Persistence via Microsoft Outlook VBA
	description: 
		     Detects attempts to establish persistence on an
		     endpoint by installing a rogue Microsoft Outlook VBA Template.
	query: 
		     file where host.os.type == "windows" and event.type !=
		     "deletion" and  file.path : "C:\\Users\\*\\AppData\\Roaming\\Mi
		     crosoft\\Outlook\\VbaProject.OTM"

NamE: Shell Execution via Apple Scripting
	description: 
		     Identifies the execution of the shell process
		     (sh) via scripting (JXA or AppleScript). Adversaries may use
		     the doShellScript functionality in JXA or do shell script in
		     AppleScript to execute system commands.
	query: 
		     sequence by host.id with maxspan=5s  [process where
		     host.os.type == "macos" and event.type in ("start",
		     "process_started", "info") and process.name == "osascript" and
		     process.args : "-e"] by process.entity_id  [process where
		     host.os.type == "macos" and event.type in ("start",
		     "process_started") and process.name : ("sh", "bash", "zsh") and
		     process.args == "-c" and process.args : ("*curl*", "*pbcopy*",
		     "*http*", "*chmod*")] by process.parent.entity_id

NamE: Microsoft Build Engine Started by a Script Process
	description: 
		     An instance of MSBuild, the Microsoft Build
		     Engine, was started by a script or the Windows command
		     interpreter. This behavior is unusual and is sometimes used by
		     malicious payloads.
	query: 
		     host.os.type:windows and event.category:process and
		     event.type:start and (   process.name.caseless:"msbuild.exe" or
		     process.pe.original_file_name:"MSBuild.exe") and
		     process.parent.name:("cmd.exe" or "powershell.exe" or
		     "pwsh.exe" or "powershell_ise.exe" or "cscript.exe" or
		     "wscript.exe" or "mshta.exe")

NamE: Attempt to Deactivate an Okta Network Zone
	description: 
		     Detects attempts to deactivate an Okta network
		     zone. Okta network zones can be configured to limit or restrict
		     access to a network based on IP addresses or geolocations. An
		     adversary may attempt to modify, delete, or deactivate an Okta
		     network zone in order to remove or weaken an organization's
		     security controls.
	query: 
		     event.dataset:okta.system and
		     event.action:zone.deactivate

NamE: Azure External Guest User Invitation
	description: 
		     Identifies an invitation to an external user in
		     Azure Active Directory (AD). Azure AD is extended to include
		     collaboration, allowing you to invite people from outside your
		     organization to be guest users in your cloud account. Unless
		     there is a business need to provision guest access, it is best
		     practice avoid creating guest users. Guest users could
		     potentially be overlooked indefinitely leading to a potential
		     vulnerability.
	query: 
		     event.dataset:azure.auditlogs and
		     azure.auditlogs.operation_name:"Invite external user" and azure
		     .auditlogs.properties.target_resources.*.display_name:guest and
		     event.outcome:(Success or success)

NamE: FirstTime Seen Account Performing DCSync
	description: 
		     This rule identifies when a User Account starts
		     the Active Directory Replication Process for the first time.
		     Attackers can use the DCSync technique to get credential
		     information of individual accounts or the entire domain, thus
		     compromising the entire domain.
	query: 
		     event.code:"4662" and winlog.event_data.Properties:(
		     *DS-Replication-Get-Changes* or *DS-Replication-Get-Changes-
		     All* or                                *DS-Replication-Get-
		     Changes-In-Filtered-Set* or
		     *1131f6ad-9c07-11d1-f79f-00c04fc2dcd2* or
		     *1131f6aa-9c07-11d1-f79f-00c04fc2dcd2* or
		     *89e95b76-444d-4c62-991a-0facbeda640c*) and  not
		     winlog.event_data.SubjectUserName:(*$ or MSOL_*)

NamE: PowerShell Script with Windows Defender Tampering Capabilities
	description: 
		     Identifies PowerShell scripts containing cmdlets
		     and parameters that attackers can abuse to disable Windows
		     Defender features. Attackers can tamper with antivirus to
		     reduce the risk of detection when executing their payloads.
	query: 
		     event.category: "process" and host.os.type:windows and
		     (   powershell.file.script_block_text: "Set-MpPreference" and
		     powershell.file.script_block_text: (     DisableArchiveScanning
		     or DisableBehaviorMonitoring or
		     DisableIntrusionPreventionSystem or DisableIOAVProtection or
		     DisableRemovableDriveScanning or DisableBlockAtFirstSeen or
		     DisableScanningMappedNetworkDrivesForFullScan or
		     DisableScanningNetworkFiles or DisableScriptScanning or
		     DisableRealtimeMonitoring or LowThreatDefaultAction or
		     ModerateThreatDefaultAction or HighThreatDefaultAction   ) )
		     and not powershell.file.script_block_text : (
		     ("cmdletization" and "cdxml-Help.xml") or   ("function Set-
		     MpPreference" and "Microsoft.PowerShell.Cmdletization.Generated
		     Types.MpPreference.SubmitSamplesConsentType") ) and not
		     file.directory : "C:\ProgramData\Microsoft\Windows Defender
		     Advanced Threat Protection\SenseCM"

NamE: Microsoft 365 Teams Guest Access Enabled
	description: 
		     Identifies when guest access is enabled in
		     Microsoft Teams. Guest access in Teams allows people outside
		     the organization to access teams and channels. An adversary may
		     enable guest access to maintain persistence in an environment.
	query: 
		     event.dataset:o365.audit and
		     event.provider:(SkypeForBusiness or MicrosoftTeams) and
		     event.category:web and event.action:"Set-
		     CsTeamsClientConfiguration" and
		     o365.audit.Parameters.AllowGuestUser:True and
		     event.outcome:success

NamE: Potential External Linux SSH Brute Force Detected
	description: 
		     Identifies multiple external consecutive login
		     failures targeting a user account from the same source address
		     within a short time interval. Adversaries will often brute
		     force login attempts across multiple users with a common or
		     known password, in an attempt to gain access to these accounts.
	query: 
		     sequence by host.id, source.ip, user.name with
		     maxspan=15s   [ authentication where host.os.type == "linux"
		     and     event.action in ("ssh_login", "user_login") and
		     event.outcome == "failure" and    not cidrmatch(source.ip,
		     "10.0.0.0/8", "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12",
		     "192.0.0.0/24",        "192.0.0.0/29", "192.0.0.8/32",
		     "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32",
		     "192.0.0.171/32",        "192.0.2.0/24", "192.31.196.0/24",
		     "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24",
		     "224.0.0.0/4",        "100.64.0.0/10",
		     "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24",
		     "203.0.113.0/24", "240.0.0.0/4",         "::1", "FE80::/10",
		     "FF00::/8") ] with runs = 10

NamE: Launch Agent Creation or Modification and Immediate Loading
	description: 
		     An adversary can establish persistence by
		     installing a new launch agent that executes at login by using
		     launchd or launchctl to load a plist into the appropriate
		     directories.
	query: 
		     sequence by host.id with maxspan=1m  [file where
		     host.os.type == "macos" and event.type != "deletion" and
		     file.path : ("/System/Library/LaunchAgents/*",
		     "/Library/LaunchAgents/*", "/Users/*/Library/LaunchAgents/*")
		     ]  [process where host.os.type == "macos" and event.type in
		     ("start", "process_started") and process.name == "launchctl"
		     and process.args == "load"]

NamE: Persistence via a Windows Installer
	description: 
		     Identifies when the Windows installer process
		     msiexec.exe creates a new persistence entry via scheduled tasks
		     or startup.
	query: 
		     any where host.os.type == "windows" and  (process.name
		     : "msiexec.exe" or Effective_process.name : "msiexec.exe") and
		     (   (event.category == "file" and event.action == "creation"
		     and    file.path : ("?:\\Windows\\System32\\Tasks\\*",
		     "?:\\programdata\\microsoft\\windows\\start
		     menu\\programs\\startup\\*",
		     "?:\\Users\\*\\AppData\\Roaming\\Microsoft\\Windows\\Start
		     Menu\\Programs\\Startup\\*")) or    (event.category ==
		     "registry" and event.action == "modification" and
		     registry.path :
		     ("H*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\*",
		     "H*\\Software\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\
		     \Run\\*",                     "H*\\Software\\Microsoft\\Windows
		     \\CurrentVersion\\Policies\\Explorer\\Run\\*",
		     "H*\\Software\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\
		     \Policies\\Explorer\\Run\\*"))   )

NamE: Suspicious Microsoft 365 Mail Access by ClientAppId
	description: 
		     Identifies when a Microsoft 365 Mailbox is
		     accessed by a ClientAppId that was observed for the fist time
		     during the last 10 days.
	query: 
		     event.dataset:o365.audit and event.provider:Exchange
		     and event.category:web and event.action:MailItemsAccessed and
		     event.outcome:success and  not o365.audit.ClientAppId :
		     ("13937bba-652e-4c46-b222-3003f4d1ff97" or
		     "6326e366-9d6d-4c70-b22a-34c7ea72d73d" or   "a3883eba-
		     fbe9-48bd-9ed3-dca3e0e84250" or "d3590ed6-52b3-4102-aeff-
		     aad2292ab01c" or "27922004-5251-4030-b22d-91ecd9a37ea4" or
		     "1fec8e78-bce4-4aaf-ab1b-5451cc387264" or
		     "26a7ee05-5602-4d76-a7ba-eae8b7b67941" or
		     "00000002-0000-0000-c000-000000000000" or
		     "00000002-0000-0ff1-ce00-000000000000" or
		     "ffcb16e8-f789-467c-8ce9-f826a080d987" or
		     "00000003-0000-0ff1-ce00-000000000000" or
		     "00000004-0000-0ff1-ce00-000000000000" or
		     "00000005-0000-0ff1-ce00-000000000000" or
		     "00000006-0000-0ff1-ce00-000000000000" or
		     "00000007-0000-0000-c000-000000000000" or
		     "00000007-0000-0ff1-ce00-000000000000" or
		     "00000009-0000-0000-c000-000000000000" or
		     "0000000c-0000-0000-c000-000000000000" or
		     "00000015-0000-0000-c000-000000000000" or
		     "0000001a-0000-0000-c000-000000000000" or
		     "00b41c95-dab0-4487-9791-b9d2c32c80f2" or
		     "022907d3-0f1b-48f7-badc-1ba6abab6d66" or
		     "04b07795-8ddb-461a-bbee-02f9e1bf7b46" or
		     "08e18876-6177-487e-b8b5-cf950c1e598c" or
		     "0cb7b9ec-5336-483b-bc31-b15b5788de71" or
		     "0cd196ee-71bf-4fd6-a57c-b491ffd4fb1e" or
		     "0f698dd4-f011-4d23-a33e-b36416dcb1e6" or
		     "13937bba-652e-4c46-b222-3003f4d1ff97" or
		     "14d82eec-204b-4c2f-b7e8-296a70dab67e" or
		     "16aeb910-ce68-41d1-9ac3-9e1673ac9575" or
		     "1786c5ed-9644-47b2-8aa0-7201292175b6" or
		     "17d5e35f-655b-4fb0-8ae6-86356e9a49f5" or
		     "18fbca16-2224-45f6-85b0-f7bf2b39b3f3" or
		     "1950a258-227b-4e31-a9cf-717495945fc2" or
		     "1b3c667f-cde3-4090-b60b-3d2abd0117f0" or "1fec8e78-bce4-4aaf-
		     ab1b-5451cc387264" or "20a11fe0-faa8-4df5-baf2-f965f8f9972e" or
		     "23523755-3a2b-41ca-9315-f81f3f566a95" or
		     "243c63a3-247d-41c5-9d83-7788c43f1c43" or
		     "268761a2-03f3-40df-8a8b-c3db24145b6b" or
		     "26a7ee05-5602-4d76-a7ba-eae8b7b67941" or
		     "26abc9a8-24f0-4b11-8234-e86ede698878" or
		     "27922004-5251-4030-b22d-91ecd9a37ea4" or
		     "28b567f6-162c-4f54-99a0-6887f387bbcc" or
		     "29d9ed98-a469-4536-ade2-f981bc1d605e" or
		     "2abdc806-e091-4495-9b10-b04d93c3f040" or
		     "2d4d3d8e-2be3-4bef-9f87-7875a61c29de" or
		     "2d7f3606-b07d-41d1-b9d2-0d0c9296a6e8" or "3090ab82-f1c1-4cdf-
		     af2c-5d7a6f3e2cc7" or   "35d54a08-36c9-4847-9018-93934c62740c"
		     or "37182072-3c9c-4f6a-a4b3-b3f91cacffce" or
		     "38049638-cc2c-4cde-abe4-4479d721ed44" or
		     "3c896ded-22c5-450f-91f6-3d1ef0848f6e" or
		     "4345a7b9-9a63-4910-a426-35363201d503" or
		     "45a330b1-b1ec-4cc1-9161-9f03992aa49f" or
		     "4765445b-32c6-49b0-83e6-1d93765276ca" or
		     "497effe9-df71-4043-a8bb-14cf78c4b63b" or
		     "4b233688-031c-404b-9a80-a4f3f2351f90" or
		     "4d5c2d63-cf83-4365-853c-925fd1a64357" or
		     "51be292c-a17e-4f17-9a7e-4b661fb16dd2" or
		     "5572c4c0-d078-44ce-b81c-6cbf8d3ed39e" or
		     "5e3ce6c0-2b1f-4285-8d4b-75ee78787346" or
		     "60c8bde5-3167-4f92-8fdb-059f6176dc0f" or
		     "61109738-7d2b-4a0b-9fe3-660b1ff83505" or
		     "62256cef-54c0-4cb4-bcac-4c67989bdc40" or
		     "6253bca8-faf2-4587-8f2f-b056d80998a7" or
		     "65d91a3d-ab74-42e6-8a2f-0add61688c74" or
		     "66a88757-258c-4c72-893c-3e8bed4d6899" or
		     "67e3df25-268a-4324-a550-0de1c7f97287" or
		     "69893ee3-dd10-4b1c-832d-4870354be3d8" or
		     "74658136-14ec-4630-ad9b-26e160ff0fc6" or
		     "74bcdadc-2fdc-4bb3-8459-76d06952a0e9" or
		     "797f4846-ba00-4fd7-ba43-dac1f8f63013" or
		     "7ab7862c-4c57-491e-8a45-d52a7e023983" or
		     "7ae974c5-1af7-4923-af3a-fb1fd14dcb7e" or
		     "7b7531ad-5926-4f2d-8a1d-38495ad33e17" or
		     "80ccca67-54bd-44ab-8625-4b79c4dc7775" or
		     "835b2a73-6e10-4aa5-a979-21dfda45231c" or
		     "871c010f-5e61-4fb1-83ac-98610a7e9110" or
		     "89bee1f7-5e6e-4d8a-9f3d-ecd601259da7" or
		     "8edd93e1-2103-40b4-bd70-6e34e586362d" or
		     "905fcf26-4eb7-48a0-9ff0-8dcc7194b5ba" or "91ca2ca5-3b3e-41dd-
		     ab65-809fa3dffffa" or "93625bc8-bfe2-437a-97e0-3d0060024faa" or
		     "93d53678-613d-4013-afc1-62e9e444a0a5" or
		     "944f0bd1-117b-4b1c-af26-804ed95e767e" or
		     "94c63fef-13a3-47bc-8074-75af8c65887a" or
		     "95de633a-083e-42f5-b444-a4295d8e9314" or
		     "97cb1f73-50df-47d1-8fb0-0271f2728514" or
		     "98db8bd6-0cc0-4e67-9de5-f187f1cd1b41" or
		     "99b904fd-a1fe-455c-b86c-2f9fb1da7687" or
		     "9ea1ad79-fdb6-4f9a-8bc3-2b70f96e34c7" or
		     "a3475900-ccec-4a69-98f5-a65cd5dc5306" or
		     "a3b79187-70b2-4139-83f9-6016c58cd27b" or
		     "a57aca87-cbc0-4f3c-8b9e-dc095fdc8978" or
		     "a970bac6-63fe-4ec5-8884-8536862c42d4" or
		     "a9b49b65-0a12-430b-9540-c80b3332c127" or
		     "ab9b8c07-8f02-4f72-87fa-80105867a763" or
		     "ae8e128e-080f-4086-b0e3-4c19301ada69" or
		     "b23dd4db-9142-4734-867f-3577f640ad0c" or
		     "b4bddae8-ab25-483e-8670-df09b9f1d0ea" or
		     "b669c6ea-1adf-453f-b8bc-6d526592b419" or
		     "b6e69c34-5f1f-4c34-8cdf-7fea120b8670" or
		     "bb2a2e3a-c5e7-4f0a-88e0-8e01fd3fc1f4" or
		     "bdd48c81-3a58-4ea9-849c-ebea7f6b6360" or
		     "c1c74fed-04c9-4704-80dc-9f79a2e515cb" or
		     "c35cb2ba-f88b-4d15-aa9d-37bd443522e1" or
		     "c44b4083-3bb0-49c1-b47d-974e53cbdf3c" or
		     "c9a559d2-7aab-4f13-a6ed-e7e9c52aec87" or
		     "cc15fd57-2c6c-4117-a88c-83b1d56b4bbe" or
		     "cf36b471-5b44-428c-9ce7-313bf84528de" or
		     "cf53fce8-def6-4aeb-8d30-b158e7b1cf83" or
		     "d176f6e7-38e5-40c9-8a78-3998aab820e7" or
		     "d3590ed6-52b3-4102-aeff-aad2292ab01c" or
		     "d73f4b35-55c9-48c7-8b10-651f6f2acb2e" or
		     "d9b8ec3a-1e4e-4e08-b3c2-5baf00c0fcb0" or
		     "de8bc8b5-d9f9-48b1-a8ad-b748da725064" or
		     "dfe74da8-9279-44ec-8fb2-2aed9e1c73d0" or
		     "e1ef36fd-b883-4dbf-97f0-9ece4b576fc6" or
		     "e64aa8bc-8eb4-40e2-898b-cf261a25954f" or
		     "e9f49c6b-5ce5-44c8-925d-015017e9f7ad" or
		     "ee272b19-4411-433f-8f28-5c13cb6fd407" or
		     "f5eaa862-7f08-448c-9c4e-f4047d4d4521" or
		     "fb78d390-0c51-40cd-8e17-fdbfab77341b" or
		     "fc0f3af4-6835-4174-b806-f7db311fd2f3" or
		     "fdf9885b-dd37-42bf-82e5-c3129ef5a302" )

NamE: Potential Protocol Tunneling via EarthWorm
	description: 
		     Identifies the execution of the EarthWorm
		     tunneler. Adversaries may tunnel network communications to and
		     from a victim system within a separate protocol to avoid
		     detection and network filtering, or to enable access to
		     otherwise unreachable systems.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and  process.args : "-s" and process.args : "-d" and
		     process.args : "rssocks"

NamE: Potential Escalation via Vulnerable MSI Repair
	description: 
		     Identifies when a browser process navigates to
		     the Microsoft Help page followed by spawning an elevated
		     process. This may indicate a successful exploitation for
		     privilege escalation abusing a vulnerable Windows Installer
		     repair setup.
	query: 
		     process where event.type == "start" and host.os.type
		     == "windows" and  user.domain : ("NT AUTHORITY", "AUTORITE NT",
		     "AUTORIDADE NT") and  process.parent.name : ("chrome.exe",
		     "msedge.exe", "brave.exe", "whale.exe", "browser.exe",
		     "dragon.exe", "vivaldi.exe",
		     "opera.exe", "iexplore", "firefox.exe", "waterfox.exe",
		     "iexplore.exe", "tor.exe", "safari.exe") and
		     process.parent.command_line : "*go.microsoft.com*"

NamE: Creation of Hidden Shared Object File
	description: 
		     Identifies the creation of a hidden shared
		     object (.so) file. Users can mark specific files as hidden
		     simply by putting a "." as the first character in the file or
		     folder name. Adversaries can use this to their advantage to
		     hide files and folders on the system for persistence and
		     defense evasion.
	query: 
		     file where host.os.type == "linux" and event.type ==
		     "creation" and file.extension == "so" and file.name : ".*.so"
		     and not process.name in ("dockerd", "azcopy", "podman")

NamE: Microsoft IIS Service Account Password Dumped
	description: 
		     Identifies the Internet Information Services
		     (IIS) command-line tool, AppCmd, being used to list passwords.
		     An attacker with IIS web server access via a web shell can
		     decrypt and dump the IIS AppPool service account password using
		     AppCmd.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and    (process.name : "appcmd.exe" or
		     ?process.pe.original_file_name == "appcmd.exe") and
		     process.args : "list" and process.args : "/text*"

NamE: Potential Memory Seeking Activity
	description: 
		     Monitors for the execution of Unix utilities
		     that may be leveraged as memory address seekers. Attackers may
		     leverage built-in utilities to seek specific memory addresses,
		     allowing for potential future manipulation/exploitation.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event") and (
		     (process.name == "tail" and process.args in ("-c", "--bytes"))
		     or   (process.name == "cmp" and process.args == "-i") or
		     (process.name in ("hexdump", "xxd") and process.args == "-s")
		     or   (process.name == "dd" and process.args : ("skip*",
		     "seek*")) ) and not (   process.parent.args like
		     ("/opt/error_monitor/error_monitor.sh", "printf*") or
		     process.parent.name in ("acme.sh", "dracut", "leapp") or
		     process.parent.executable like (     "/bin/cagefs_enter",
		     "/opt/nessus_agent/sbin/nessus-service",
		     "/usr/libexec/platform-python*",     "/usr/libexec/vdsm/vdsmd",
		     "/usr/local/bin/docker-entrypoint.sh", "/usr/lib/module-init-
		     tools/lsinitrd-quick"   ) or   process.parent.command_line like
		     "sh*acme.sh*" or   process.args like "/var/tmp/dracut*" )

NamE: Potential PowerShell HackTool Script by Function Names
	description: 
		     Detects known PowerShell offensive tooling
		     functions names in PowerShell scripts. Attackers commonly use
		     out-of-the-box offensive tools without modifying the code. This
		     rule aim is to take advantage of that.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (     "Add-
		     DomainGroupMember" or "Add-DomainObjectAcl" or     "Add-
		     RemoteConnection" or "Add-ServiceDacl" or     "Add-Win32Type"
		     or "Convert-ADName" or     "Convert-LDAPProperty" or
		     "ConvertFrom-LDAPLogonHours" or     "ConvertFrom-UACValue" or
		     "Copy-ArrayOfMemAddresses" or     "Create-NamedPipe" or
		     "Create-ProcessWithToken" or     "Create-RemoteThread" or
		     "Create-SuspendedWinLogon" or     "Create-WinLogonProcess" or
		     "Emit-CallThreadStub" or     "Enable-
		     SeAssignPrimaryTokenPrivilege" or "Enable-SeDebugPrivilege" or
		     "Enum-AllTokens" or "Export-PowerViewCSV" or     "Find-
		     AVSignature" or "Find-AppLockerLog" or     "Find-
		     DomainLocalGroupMember" or "Find-DomainObjectPropertyOutlier"
		     or     "Find-DomainProcess" or "Find-DomainShare" or     "Find-
		     DomainUserEvent" or "Find-DomainUserLocation" or     "Find-
		     InterestingDomainAcl" or "Find-InterestingDomainShareFile" or
		     "Find-InterestingFile" or "Find-LocalAdminAccess" or     "Find-
		     PSScriptsInPSAppLog" or "Find-PathDLLHijack" or     "Find-
		     ProcessDLLHijack" or "Find-RDPClientConnection" or     "Get-
		     AllAttributesForClass" or "Get-CachedGPPPassword" or     "Get-
		     DecryptedCpassword" or "Get-DecryptedSitelistPassword" or
		     "Get-DelegateType" or "New-RelayEnumObject" or     "Get-
		     DomainDFSShare" or "Get-DomainDFSShareV1" or     "Get-
		     DomainDFSShareV2" or "Get-DomainDNSRecord" or     "Get-
		     DomainDNSZone" or "Get-DomainFileServer" or     "Get-
		     DomainForeignGroupMember" or "Get-DomainForeignUser" or
		     "Get-DomainGPO" or "Get-DomainGPOComputerLocalGroupMapping" or
		     "Get-DomainGPOLocalGroup" or "Get-
		     DomainGPOUserLocalGroupMapping" or     "Get-DomainGUIDMap" or
		     "Get-DomainGroup" or     "Get-DomainGroupMember" or "Get-
		     DomainGroupMemberDeleted" or     "Get-
		     DomainManagedSecurityGroup" or "Get-DomainOU" or     "Get-
		     DomainObject" or "Get-DomainObjectAcl" or     "Get-
		     DomainObjectAttributeHistory" or "Get-
		     DomainObjectLinkedAttributeHistory" or     "Get-
		     DomainPolicyData" or "Get-DomainSID" or     "Get-
		     DomainSPNTicket" or "Get-DomainSearcher" or     "Get-
		     DomainSite" or "Get-DomainSubnet" or     "Get-DomainTrust" or
		     "Get-DomainTrustMapping" or     "Get-DomainUser" or "Get-
		     DomainUserEvent" or     "Get-Forest" or "Get-ForestDomain" or
		     "Get-ForestGlobalCatalog" or "Get-ForestSchemaClass" or
		     "Get-ForestTrust" or "Get-GPODelegation" or     "Get-
		     GPPAutologon" or "Get-GPPInnerField" or     "Get-
		     GPPInnerFields" or "Get-GPPPassword" or     "Get-GptTmpl" or
		     "Get-GroupsXML" or     "Get-HttpStatus" or "Get-ImageNtHeaders"
		     or     "Get-Keystrokes" or "New-SOASerialNumberArray" or
		     "Get-MemoryProcAddress" or "Get-MicrophoneAudio" or     "Get-
		     ModifiablePath" or "Get-ModifiableRegistryAutoRun" or     "Get-
		     ModifiableScheduledTaskFile" or "Get-ModifiableService" or
		     "Get-ModifiableServiceFile" or "Get-Name" or     "Get-
		     NetComputerSiteName" or "Get-NetLocalGroup" or     "Get-
		     NetLocalGroupMember" or "Get-NetLoggedon" or     "Get-
		     NetRDPSession" or "Get-NetSession" or     "Get-NetShare" or
		     "Get-PEArchitecture" or     "Get-PEBasicInfo" or "Get-
		     PEDetailedInfo" or     "Get-PathAcl" or "Get-PrimaryToken" or
		     "Get-ProcAddress" or "Get-ProcessTokenGroup" or     "Get-
		     ProcessTokenPrivilege" or "Get-ProcessTokenType" or     "Get-
		     RegLoggedOn" or "Get-RegistryAlwaysInstallElevated" or
		     "Get-RegistryAutoLogon" or "Get-RemoteProcAddress" or     "Get-
		     Screenshot" or "Get-ServiceDetail" or     "Get-
		     SiteListPassword" or "Get-SitelistField" or     "Get-System" or
		     "Get-SystemNamedPipe" or     "Get-SystemToken" or "Get-
		     ThreadToken" or     "Get-TimedScreenshot" or "Get-
		     TokenInformation" or     "Get-TopPort" or "Get-
		     UnattendedInstallFile" or     "Get-UniqueTokens" or "Get-
		     UnquotedService" or     "Get-VaultCredential" or "Get-
		     VaultElementValue" or     "Get-VirtualProtectValue" or "Get-
		     VolumeShadowCopy" or     "Get-WMIProcess" or "Get-
		     WMIRegCachedRDPConnection" or     "Get-WMIRegLastLoggedOn" or
		     "Get-WMIRegMountedDrive" or     "Get-WMIRegProxy" or "Get-
		     WebConfig" or     "Get-Win32Constants" or "Get-Win32Functions"
		     or     "Get-Win32Types" or "Import-DllImports" or     "Import-
		     DllInRemoteProcess" or "Inject-LocalShellcode" or     "Inject-
		     RemoteShellcode" or "Install-ServiceBinary" or     "Invoke-
		     CompareAttributesForClass" or "Invoke-CreateRemoteThread" or
		     "Invoke-CredentialInjection" or "Invoke-DllInjection" or
		     "Invoke-EventVwrBypass" or "Invoke-ImpersonateUser" or
		     "Invoke-Kerberoast" or "Invoke-MemoryFreeLibrary" or
		     "Invoke-MemoryLoadLibrary" or     "Invoke-Mimikatz" or "Invoke-
		     NinjaCopy" or     "Invoke-PatchDll" or "Invoke-Portscan" or
		     "Invoke-PrivescAudit" or "Invoke-ReflectivePEInjection" or
		     "Invoke-ReverseDnsLookup" or "Invoke-RevertToSelf" or
		     "Invoke-ServiceAbuse" or "Invoke-Shellcode" or     "Invoke-
		     TokenManipulation" or "Invoke-UserImpersonation" or
		     "Invoke-WmiCommand" or "Mount-VolumeShadowCopy" or     "New-
		     ADObjectAccessControlEntry" or "New-DomainGroup" or     "New-
		     DomainUser" or "New-DynamicParameter" or     "New-
		     InMemoryModule" or     "New-ThreadedFunction" or "New-
		     VolumeShadowCopy" or     "Out-CompressedDll" or "Out-
		     EncodedCommand" or     "Out-EncryptedScript" or "Out-Minidump"
		     or     "PortScan-Alive" or "Portscan-Port" or     "Remove-
		     DomainGroupMember" or "Remove-DomainObjectAcl" or     "Remove-
		     RemoteConnection" or "Remove-VolumeShadowCopy" or     "Restore-
		     ServiceBinary" or "Set-DesktopACLToAllowEveryone" or     "Set-
		     DesktopACLs" or "Set-DomainObject" or     "Set-
		     DomainObjectOwner" or "Set-DomainUserPassword" or     "Set-
		     ServiceBinaryPath" or "Sub-SignedIntAsUnsigned" or     "Test-
		     AdminAccess" or "Test-MemoryRangeValid" or     "Test-
		     ServiceDaclPermission" or "Update-ExeFunctions" or     "Update-
		     MemoryAddresses" or "Update-MemoryProtectionFlags" or
		     "Write-BytesToMemory" or "Write-HijackDll" or     "Write-
		     PortscanOut" or "Write-ServiceBinary" or     "Write-UserAddMSI"
		     or "Invoke-Privesc" or     "func_get_proc_address" or "Invoke-
		     BloodHound" or     "Invoke-HostEnum" or "Get-
		     BrowserInformation" or     "Get-DomainAccountPolicy" or "Get-
		     DomainAdmins" or     "Get-AVProcesses" or "Get-AVInfo" or
		     "Get-RecycleBin" or "Invoke-BruteForce" or     "Get-PassHints"
		     or "Invoke-SessionGopher" or     "Get-LSASecret" or "Get-
		     PassHashes" or     "Invoke-WdigestDowngrade" or "Get-
		     ChromeDump" or     "Invoke-DomainPasswordSpray" or "Get-
		     FoxDump" or     "New-HoneyHash" or "Invoke-DCSync" or
		     "Invoke-PowerDump" or "Invoke-SSIDExfil" or     "Invoke-
		     PowerShellTCP" or "Add-Exfiltration" or     "Do-Exfiltration"
		     or "Invoke-DropboxUpload" or     "Invoke-ExfilDataToGitHub" or
		     "Invoke-EgressCheck" or     "Invoke-PostExfil" or "Create-
		     MultipleSessions" or     "Invoke-NetworkRelay" or "New-
		     GPOImmediateTask" or     "Invoke-WMIDebugger" or "Invoke-
		     SQLOSCMD" or     "Invoke-SMBExec" or "Invoke-PSRemoting" or
		     "Invoke-ExecuteMSBuild" or "Invoke-DCOM" or     "Invoke-
		     InveighRelay" or "Invoke-PsExec" or     "Invoke-SSHCommand" or
		     "Find-ActiveUsersWMI" or     "Get-SystemDrivesWMI" or "Get-
		     ActiveNICSWMI" or     "Remove-Persistence" or "DNS_TXT_Pwnage"
		     or     "Execute-OnTime" or "HTTP-Backdoor" or     "Add-
		     ConstrainedDelegationBackdoor" or "Add-RegBackdoor" or
		     "Add-ScrnSaveBackdoor" or "Gupt-Backdoor" or     "Invoke-
		     ADSBackdoor" or "Add-Persistence" or     "Invoke-
		     ResolverBackdoor" or "Invoke-EventLogBackdoor" or     "Invoke-
		     DeadUserBackdoor" or "Invoke-DisableMachineAcctChange" or
		     "Invoke-AccessBinary" or "Add-NetUser" or     "Invoke-Schtasks"
		     or "Invoke-JSRatRegsvr" or     "Invoke-JSRatRundll" or "Invoke-
		     PoshRatHttps" or     "Invoke-PsGcatAgent" or "Remove-PoshRat"
		     or     "Install-SSP" or "Invoke-BackdoorLNK" or
		     "PowerBreach" or "InstallEXE-Persistence" or     "RemoveEXE-
		     Persistence" or "Install-ServiceLevel-Persistence" or
		     "Remove-ServiceLevel-Persistence" or "Invoke-Prompt" or
		     "Invoke-PacketCapture" or "Start-WebcamRecorder" or     "Get-
		     USBKeyStrokes" or "Invoke-KeeThief" or     "Get-Keystrokes" or
		     "Invoke-NetRipper" or     "Get-EmailItems" or "Invoke-
		     MailSearch" or     "Invoke-SearchGAL" or "Get-WebCredentials"
		     or     "Start-CaptureServer" or "Invoke-PowerShellIcmp" or
		     "Invoke-PowerShellTcpOneLine" or "Invoke-
		     PowerShellTcpOneLineBind" or     "Invoke-PowerShellUdp" or
		     "Invoke-PowerShellUdpOneLine" or     "Run-EXEonRemote" or
		     "Download-Execute-PS" or     "Out-RundllCommand" or "Set-
		     RemoteWMI" or     "Set-DCShadowPermissions" or "Invoke-
		     PowerShellWMI" or     "Invoke-Vnc" or "Invoke-LockWorkStation"
		     or     "Invoke-EternalBlue" or "Invoke-ShellcodeMSIL" or
		     "Invoke-MetasploitPayload" or "Invoke-DowngradeAccount" or
		     "Invoke-RunAs" or "ExetoText" or     "Disable-SecuritySettings"
		     or "Set-MacAttribute" or     "Invoke-MS16032" or "Invoke-
		     BypassUACTokenManipulation" or     "Invoke-SDCLTBypass" or
		     "Invoke-FodHelperBypass" or     "Invoke-EventVwrBypass" or
		     "Invoke-EnvBypass" or     "Get-ServiceUnquoted" or "Get-
		     ServiceFilePermission" or     "Get-ServicePermission" or
		     "Enable-DuplicateToken" or "Invoke-PsUaCme" or     "Invoke-
		     Tater" or "Invoke-WScriptBypassUAC" or     "Invoke-AllChecks"
		     or "Find-TrustedDocuments" or     "Invoke-Interceptor" or
		     "Invoke-PoshRatHttp" or     "Invoke-ExecCommandWMI" or "Invoke-
		     KillProcessWMI" or     "Invoke-CreateShareandExecute" or
		     "Invoke-RemoteScriptWithOutput" or     "Invoke-
		     SchedJobManipulation" or "Invoke-ServiceManipulation" or
		     "Invoke-PowerOptionsWMI" or "Invoke-DirectoryListing" or
		     "Invoke-FileTransferOverWMI" or "Invoke-WMImplant" or
		     "Invoke-WMIObfuscatedPSCommand" or "Invoke-WMIDuplicateClass"
		     or     "Invoke-WMIUpload" or "Invoke-WMIRemoteExtract" or
		     "Invoke-winPEAS"   ) and   not
		     powershell.file.script_block_text : (     "sentinelbreakpoints"
		     and "Set-PSBreakpoint"   ) and   not user.id : ("S-1-5-18" or
		     "S-1-5-19")

NamE: Remote Computer Account DnsHostName Update
	description: 
		     Identifies the remote update to a computer
		     account's DnsHostName attribute. If the new value set is a
		     valid domain controller DNS hostname and the subject computer
		     name is not a domain controller, then it's highly likely a
		     preparation step to exploit CVE-2022-26923 in an attempt to
		     elevate privileges from a standard domain user to domain admin
		     privileges.
	query: 
		     iam where event.action == "changed-computer-account"
		     and user.id : ("S-1-5-21-*", "S-1-12-1-*") and      /* if
		     DnsHostName value equal a DC DNS hostname then it's highly
		     suspicious */     winlog.event_data.DnsHostName : "??*" and
		     /* exclude FPs where DnsHostName starts with the ComputerName
		     that was changed */     not
		     startswith~(winlog.event_data.DnsHostName,
		     substring(winlog.event_data.TargetUserName, 0,
		     length(winlog.event_data.TargetUserName) - 1))

NamE: Azure Event Hub Deletion
	description: 
		     Identifies an Event Hub deletion in Azure. An
		     Event Hub is an event processing service that ingests and
		     processes large volumes of events and data. An adversary may
		     delete an Event Hub in an attempt to evade detection.
	query: 
		     event.dataset:azure.activitylogs and azure.activitylog
		     s.operation_name:"MICROSOFT.EVENTHUB/NAMESPACES/EVENTHUBS/DELET
		     E" and event.outcome:(Success or success)

NamE: Suspicious Windows Powershell Arguments
	description: 
		     Identifies the execution of PowerShell with
		     suspicious argument values. This behavior is often observed
		     during malware installation leveraging PowerShell.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  process.name : "powershell.exe" and   (
		     process.command_line :         (
		     "*^*^*^*^*^*^*^*^*^*",           "*`*`*`*`*",
		     "*+*+*+*+*+*+*",           "*[char[]](*)*-join*",
		     "*Base64String*",           "*[*Convert]*",
		     "*.Compression.*",           "*-join($*",
		     "*.replace*",           "*MemoryStream*",
		     "*WriteAllBytes*",           "* -enc *",           "* -ec *",
		     "* /e *",           "* /enc *",           "* /ec *",
		     "*WebClient*",           "*DownloadFile*",
		     "*DownloadString*",           "* iex*",           "* iwr*",
		     "*Reflection.Assembly*",           "*Assembly.GetType*",
		     "*$env:temp\\*start*",           "*powercat*",
		     "*nslookup -q=txt*",
		     "*$host.UI.PromptForCredential*",
		     "*Net.Sockets.TCPClient*",           "*curl *;Start*",
		     "powershell.exe \"<#*",           "*ssh -p *",
		     "*http*|iex*",           "*@SSL\\DavWWWRoot\\*.ps1*",
		     "*.lnk*.Seek(0x*",           "*[string]::join(*",
		     "*[Array]::Reverse($*",           "* hidden $(gc *",
		     "*=wscri& set*",           "*http'+'s://*",
		     "*.content|i''Ex*",           "*//:sptth*",
		     "*//:ptth*",           "*$*=Get-
		     Content*AppData*.SubString(*$*",           "*=cat
		     *AppData*.substring(*);*$*"         ) or        (process.args :
		     "-c" and process.args : "&{'*") or        (process.args :
		     "-Outfile" and process.args : "Start*") or        (process.args
		     : "-bxor" and process.args : "0x*") or        process.args :
		     "$*$*;set-alias" or        (process.parent.name :
		     ("explorer.exe", "cmd.exe") and        process.command_line :
		     ("*-encodedCommand*", "*Invoke-webrequest*", "*WebClient*",
		     "*Reflection.Assembly*"))   )

NamE: RDP (Remote Desktop Protocol) from the Internet
	description: 
		     This rule detects network events that may
		     indicate the use of RDP traffic from the Internet. RDP is
		     commonly used by system administrators to remotely control a
		     system for maintenance or to use shared resources. It should
		     almost never be directly exposed to the Internet, as it is
		     frequently targeted and exploited by threat actors as an
		     initial access or backdoor vector.
	query: 
		     (event.dataset: network_traffic.flow or
		     (event.category: (network or network_traffic))) and
		     network.transport:tcp and (destination.port:3389 or
		     event.dataset:zeek.rdp) and   not source.ip:(     10.0.0.0/8 or
		     127.0.0.0/8 or     169.254.0.0/16 or     172.16.0.0/12 or
		     192.0.0.0/24 or     192.0.0.0/29 or     192.0.0.8/32 or
		     192.0.0.9/32 or     192.0.0.10/32 or     192.0.0.170/32 or
		     192.0.0.171/32 or     192.0.2.0/24 or     192.31.196.0/24 or
		     192.52.193.0/24 or     192.168.0.0/16 or     192.88.99.0/24 or
		     224.0.0.0/4 or     100.64.0.0/10 or     192.175.48.0/24 or
		     198.18.0.0/15 or     198.51.100.0/24 or     203.0.113.0/24 or
		     240.0.0.0/4 or     "::1" or     "FE80::/10" or     "FF00::/8"
		     ) and   destination.ip:(     10.0.0.0/8 or     172.16.0.0/12 or
		     192.168.0.0/16   )

NamE: WPS Office Exploitation via DLL Hijack
	description: 
		     Identifies the load of a remote library by the
		     WPS Office promecefpluginhost.exe executable. This may indicate
		     the successful exploitation of CVE-2024-7262 or CVE-2024-7263
		     via DLL hijack abusing the ksoqing custom protocol handler.
	query: 
		     any where host.os.type == "windows" and process.name :
		     "promecefpluginhost.exe" and (  (event.category == "library"
		     and   ?dll.path :
		     ("?:\\Users\\*\\AppData\\Local\\Temp\\wps\\INetCache\\*",
		     "\\Device\\Mup\\**", "\\\\*")) or    ((event.category ==
		     "process" and event.action : "Image loaded*") and   ?file.path
		     :
		     ("?:\\Users\\*\\AppData\\Local\\Temp\\wps\\INetCache\\*",
		     "\\Device\\Mup\\**", "\\\\*")) )

NamE: Suspicious Content Extracted or Decompressed via Funzip
	description: 
		     Identifies when suspicious content is extracted
		     from a file and subsequently decompressed using the funzip
		     utility. Malware may execute the tail utility using the "-c"
		     option to read a sequence of bytes from the end of a file. The
		     output from tail can be piped to funzip in order to decompress
		     malicious code before it is executed. This behavior is
		     consistent with malware families such as Bundlore.
	query: 
		     process where host.os.type == "linux" and event.action
		     in ("exec", "exec_event", "start") and ((process.args == "tail"
		     and process.args == "-c" and process.args == "funzip")) and not
		     process.args : "/var/log/messages" and not
		     process.parent.executable : ("/usr/bin/dracut", "/sbin/dracut",
		     "/usr/bin/xargs") and not (process.parent.name in ("sh",
		     "sudo") and process.parent.command_line : "*nessus_su*")

NamE: Windows Account or Group Discovery
	description: 
		     This rule identifies the execution of commands
		     that enumerates account or group information. Adversaries may
		     use built-in applications to get a listing of local system or
		     domain accounts and groups.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and (   (    (     (process.name : "net.exe" or
		     process.pe.original_file_name == "net.exe") or     (
		     (process.name : "net1.exe" or process.pe.original_file_name ==
		     "net1.exe") and      not process.parent.name : "net.exe"     )
		     ) and process.args : ("accounts", "group", "user",
		     "localgroup") and not process.args : "/add"   ) or
		     (process.name:("dsquery.exe", "dsget.exe") and
		     process.args:("*members*", "user")) or
		     (process.name:"dsquery.exe" and process.args:"*filter*") or
		     process.name:("quser.exe", "qwinsta.exe", "PsGetSID.exe",
		     "PsLoggedOn.exe", "LogonSessions.exe", "whoami.exe") or   (
		     process.name: "cmd.exe" and     (       process.args : "echo"
		     and process.args : (         "%username%", "%userdomain%",
		     "%userdnsdomain%",         "%userdomain_roamingprofile%",
		     "%userprofile%",         "%homepath%", "%localappdata%",
		     "%appdata%"       ) or       process.args : "set"     )   ) )
		     and not process.parent.args: "C:\\Program Files
		     (x86)\\Microsoft Intune Management
		     Extension\\Content\\DetectionScripts\\*.ps1" and not
		     process.parent.name : "LTSVC.exe" and not user.id : "S-1-5-18"

NamE: Startup or Run Key Registry Modification
	description: 
		     Identifies run key or startup key registry
		     modifications. In order to survive reboots and other system
		     interrupts, attackers will modify run keys within the registry
		     or leverage startup folder items as a form of persistence.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.data.strings != null and
		     registry.hive : ("HKEY_USERS", "HKLM") and  registry.path : (
		     /* Machine Hive */
		     "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\*",
		     "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\*
		     ",      "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Ru
		     nOnceEx\\*",      "HKLM\\Software\\Microsoft\\Windows\\CurrentV
		     ersion\\Policies\\Explorer\\Run\\*",
		     "HKLM\\Software\\Microsoft\\Windows
		     NT\\CurrentVersion\\Winlogon\\Shell\\*",      /* Users Hive */
		     "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\R
		     un\\*",      "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\Curr
		     entVersion\\RunOnce\\*",      "HKEY_USERS\\*\\Software\\Microso
		     ft\\Windows\\CurrentVersion\\RunOnceEx\\*",      "HKEY_USERS\\*
		     \\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explo
		     rer\\Run\\*",      "HKEY_USERS\\*\\Software\\Microsoft\\Windows
		     NT\\CurrentVersion\\Winlogon\\Shell\\*"      ) and   /* add
		     common legitimate changes without being too restrictive as this
		     is one of the most abused AESPs */   not registry.data.strings
		     : "ctfmon.exe /n" and   not (registry.value : "Application
		     Restart #*" and process.name : "csrss.exe") and   not user.id :
		     ("S-1-5-18", "S-1-5-19", "S-1-5-20") and   not
		     registry.data.strings : ("?:\\Program Files\\*.exe",
		     "?:\\Program Files (x86)\\*.exe") and   not process.executable
		     : ("?:\\Windows\\System32\\msiexec.exe",
		     "?:\\Windows\\SysWOW64\\msiexec.exe") and   not (     /*
		     Logitech G Hub */     (       process.code_signature.trusted ==
		     true and process.code_signature.subject_name == "Logitech Inc"
		     and       (         process.name : "lghub_agent.exe" and
		     registry.data.strings : (           "\"?:\\Program
		     Files\\LGHUB\\lghub.exe\" --background",
		     "\"?:\\Program
		     Files\\LGHUB\\system_tray\\lghub_system_tray.exe\" --minimized"
		     )       ) or       (         process.name : "LogiBolt.exe" and
		     registry.data.strings : (           "?:\\Program
		     Files\\Logi\\LogiBolt\\LogiBolt.exe --startup",
		     "?:\\Users\\*\\AppData\\Local\\Logi\\LogiBolt\\LogiBolt.exe
		     --startup"         )       )     ) or      /* Google Drive File
		     Stream, Chrome, and Google Update */     (
		     process.code_signature.trusted == true and
		     process.code_signature.subject_name == "Google LLC" and       (
		     process.name : "GoogleDriveFS.exe" and registry.data.strings :
		     (         "\"?:\\Program Files\\Google\\Drive File
		     Stream\\*\\GoogleDriveFS.exe\" --startup_mode"         ) or
		     process.name : "chrome.exe" and registry.data.strings : (
		     "\"?:\\Program Files\\Google\\Chrome\\Application\\chrome.exe\"
		     --no-startup-window /prefetch:5",           "\"?:\\Program
		     Files (x86)\\Google\\Chrome\\Application\\chrome.exe\" --no-
		     startup-window /prefetch:5"         ) or          process.name
		     : "GoogleUpdate.exe" and registry.data.strings : (           "\
		     "?:\\Users\\*\\AppData\\Local\\Google\\Update\\*\\GoogleUpdateC
		     ore.exe\""         )       )     ) or      /* MS Programs */
		     (       process.code_signature.trusted == true and
		     process.code_signature.subject_name in ("Microsoft Windows",
		     "Microsoft Corporation") and       (         process.name :
		     "msedge.exe" and registry.data.strings : (
		     "\"?:\\Program Files
		     (x86)\\Microsoft\\Edge\\Application\\msedge.exe\" --no-startup-
		     window --win-session-start /prefetch:5",
		     "\"C:\\Program Files
		     (x86)\\Microsoft\\Edge\\Application\\msedge.exe\" --win-
		     session-start",           "\"C:\\Program Files
		     (x86)\\Microsoft\\Edge\\Application\\msedge.exe\" --no-startup-
		     window --win-session-start"         ) or          process.name
		     : ("Update.exe", "Teams.exe") and registry.data.strings : (
		     "?:\\Users\\*\\AppData\\Local\\Microsoft\\Teams\\Update.exe
		     --processStart \"Teams.exe\" --process-start-args \"--system-
		     initiated\"",
		     "?:\\ProgramData\\*\\Microsoft\\Teams\\Update.exe
		     --processStart \"Teams.exe\" --process-start-args \"--system-
		     initiated\""         ) or          process.name :
		     "OneDriveStandaloneUpdater.exe" and registry.data.strings : (
		     "?:\\Users\\*\\AppData\\Local\\Microsoft\\OneDrive\\*\\Microsof
		     t.SharePoint.exe"         ) or          process.name :
		     "OneDriveSetup.exe" and           registry.data.strings : (
		     "?:\\Windows\\system32\\cmd.exe /q /c *
		     \"?:\\Users\\*\\AppData\\Local\\Microsoft\\OneDrive\\*\"",
		     "?:\\Program Files (x86)\\Microsoft OneDrive\\OneDrive.exe
		     /background*",             "\"?:\\Program Files
		     (x86)\\Microsoft OneDrive\\OneDrive.exe\" /background*",
		     "?:\\Program Files\\Microsoft OneDrive\\OneDrive.exe
		     /background *",             "?:\\Users\\*\\AppData\\Local\\Micr
		     osoft\\OneDrive\\??.???.????.????\\Microsoft.SharePoint.exe"
		     ) or                  process.name : "OneDrive.exe" and
		     registry.data.strings : (           "\"?:\\Program
		     Files\\Microsoft OneDrive\\OneDrive.exe\" /background",
		     "\"?:\\Program Files (x86)\\Microsoft OneDrive\\OneDrive.exe\"
		     /background",           "\"?:\\Users\\*\\AppData\\Local\\Micros
		     oft\\OneDrive\\OneDrive.exe\" /background"         ) or
		     process.name : "Microsoft.SharePoint.exe" and
		     registry.data.strings : (           "?:\\Users\\*\\AppData\\Loc
		     al\\Microsoft\\OneDrive\\??.???.????.????\\Microsoft.SharePoint
		     .exe"         ) or                  process.name :
		     "MicrosoftEdgeUpdate.exe" and registry.data.strings : (
		     "\"?:\\Users\\Expedient\\AppData\\Local\\Microsoft\\EdgeUpdate\
		     \*\\MicrosoftEdgeUpdateCore.exe\""         ) or
		     process.executable : "?:\\Program Files (x86)\\Microsoft\\EdgeW
		     ebView\\Application\\*\\Installer\\setup.exe" and
		     registry.data.strings : (           "\"?:\\Program Files (x86)\
		     \Microsoft\\EdgeWebView\\Application\\*\\Installer\\setup.exe\"
		     --msedgewebview --delete-old-versions --system-level --verbose-
		     logging --on-logon"         )       )     ) or      /* Slack */
		     (       process.code_signature.trusted == true and
		     process.code_signature.subject_name in (        "Slack
		     Technologies, Inc.", "Slack Technologies, LLC"       ) and
		     process.name : "slack.exe" and registry.data.strings : (
		     "\"?:\\Users\\*\\AppData\\Local\\slack\\slack.exe\" --process-
		     start-args --startup",
		     "\"?:\\ProgramData\\*\\slack\\slack.exe\" --process-start-args
		     --startup",         "\"?:\\Program Files\\Slack\\slack.exe\"
		     --process-start-args --startup"       )     ) or      /* Cisco
		     */     (       process.code_signature.trusted == true and
		     process.code_signature.subject_name in ("Cisco WebEx LLC",
		     "Cisco Systems, Inc.") and       (         process.name :
		     "WebexHost.exe" and registry.data.strings : (
		     "\"?:\\Users\\*\\AppData\\Local\\WebEx\\WebexHost.exe\" /daemon
		     /runFrom=autorun"         )       ) or       (
		     process.name : "CiscoJabber.exe" and registry.data.strings : (
		     "\"?:\\Program Files (x86)\\Cisco Systems\\Cisco
		     Jabber\\CiscoJabber.exe\" /min"         )       )     ) or
		     /* Loom */     (       process.code_signature.trusted == true
		     and process.code_signature.subject_name == "Loom, Inc." and
		     process.name : "Loom.exe" and registry.data.strings : (
		     "?:\\Users\\*\\AppData\\Local\\Programs\\Loom\\Loom.exe
		     --process-start-args \"--loomHidden\""       )     ) or      /*
		     Adobe */     (       process.code_signature.trusted == true and
		     process.code_signature.subject_name == "Adobe Inc." and
		     process.name : ("Acrobat.exe", "FlashUtil32_*_Plugin.exe") and
		     registry.data.strings : (         "\"?:\\Program
		     Files\\Adobe\\Acrobat DC\\Acrobat\\AdobeCollabSync.exe\"",
		     "\"?:\\Program Files (x86)\\Adobe\\Acrobat
		     DC\\Acrobat\\AdobeCollabSync.exe\"",         "?:\\WINDOWS\\SysW
		     OW64\\Macromed\\Flash\\FlashUtil32_*_Plugin.exe -update plugin"
		     )     ) or      /* CCleaner */     (
		     process.code_signature.trusted == true and
		     process.code_signature.subject_name == "PIRIFORM SOFTWARE
		     LIMITED" and       process.name : ("CCleanerBrowser.exe",
		     "CCleaner64.exe") and registry.data.strings : (
		     "\"C:\\Program Files (x86)\\CCleaner
		     Browser\\Application\\CCleanerBrowser.exe\" --check-
		     run=src=logon --auto-launch-at-startup --profile-
		     directory=\"Default\"",         "\"C:\\Program
		     Files\\CCleaner\\CCleaner64.exe\" /MONITOR"       )     ) or
		     /* Opera */     (       process.code_signature.trusted == true
		     and process.code_signature.subject_name == "Opera Norway AS"
		     and       process.name : "opera.exe" and registry.data.strings
		     : (
		     "?:\\Users\\*\\AppData\\Local\\Programs\\Opera\\launcher.exe",
		     "?:\\Users\\*\\AppData\\Local\\Programs\\Opera
		     GX\\launcher.exe"       )     ) or      /* Avast */     (
		     process.code_signature.trusted == true and
		     process.code_signature.subject_name == "Avast Software s.r.o."
		     and       process.name : "AvastBrowser.exe" and
		     registry.data.strings : (
		     "\"?:\\Users\\*\\AppData\\Local\\AVAST
		     Software\\Browser\\Application\\AvastBrowser.exe\" --check-
		     run=src=logon --auto-launch-at-startup*",
		     "\"?:\\Program Files (x86)\\AVAST
		     Software\\Browser\\Application\\AvastBrowser.exe\" --check-
		     run=src=logon --auto-launch-at-startup*",         ""       )
		     ) or      /* Grammarly */     (
		     process.code_signature.trusted == true and
		     process.code_signature.subject_name == "Grammarly, Inc." and
		     process.name : "GrammarlyInstaller.exe" and
		     registry.data.strings : (         "?:\\Users\\*\\AppData\\Local
		     \\Grammarly\\DesktopIntegrations\\Grammarly.Desktop.exe"
		     )     )   )

NamE: Directory Creation in /bin directory
	description: 
		     This rule identifies the creation of directories
		     in the /bin directory. The /bin directory contains essential
		     binary files that are required for the system to function
		     properly. The creation of directories in this location could be
		     an attempt to hide malicious files or executables, as these
		     /bin directories usually just contain binaries.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "start",
		     "ProcessRollup2", "exec_event") and process.name == "mkdir" and
		     process.args like ("/bin/*", "/usr/bin/*", "/usr/local/bin/*",
		     "/sbin/*", "/usr/sbin/*", "/usr/local/sbin/*") and not
		     process.args in ("/bin/mkdir", "/usr/bin/mkdir",
		     "/usr/local/bin/mkdir")

NamE: Persistence via WMI Standard Registry Provider
	description: 
		     Identifies use of the Windows Management
		     Instrumentation StdRegProv (registry provider) to modify
		     commonly abused registry locations for persistence.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and  registry.data.strings != null and
		     process.name : "WmiPrvSe.exe" and  registry.path : (
		     "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Command
		     Processor\\Autorun",                   "HKEY_USERS\\*\\Software
		     \\Microsoft\\Windows\\CurrentVersion\\Run\\*",
		     "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\*",
		     "HKLM\\Software\\WOW6432Node\\Microsoft\\Windows\\CurrentVersio
		     n\\Run\\*",                   "HKEY_USERS\\*\\Software\\Microso
		     ft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run\\*",
		     "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\
		     Explorer\\Run\\*",                   "HKLM\\Software\\Microsoft
		     \\Windows\\CurrentVersion\\RunOnce\\*",                   "HKLM
		     \\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx\\*",
		     "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\R
		     unOnce\\*",                   "HKEY_USERS\\*\\Software\\Microso
		     ft\\Windows\\CurrentVersion\\RunOnceEx\\*",
		     "HKLM\\SYSTEM\\*ControlSet*\\Services\\*\\ServiceDLL",
		     "HKLM\\SYSTEM\\*ControlSet*\\Services\\*\\ImagePath",
		     "HKEY_USERS\\*\\Software\\Microsoft\\Windows
		     NT\\CurrentVersion\\Winlogon\\Shell\\*",
		     "HKEY_USERS\\*\\Environment\\UserInitMprLogonScript",
		     "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Windows\\Load",
		     "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Winlogon\\Shell",                   "HKEY_U
		     SERS\\*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies
		     \\System\\Shell",                   "HKEY_USERS\\*\\SOFTWARE\\P
		     olicies\\Microsoft\\Windows\\System\\Scripts\\Logoff\\Script",
		     "HKEY_USERS\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\
		     \Scripts\\Logon\\Script",                   "HKEY_USERS\\*\\SOF
		     TWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Shutdown\
		     \Script",                   "HKEY_USERS\\*\\SOFTWARE\\Policies\
		     \Microsoft\\Windows\\System\\Scripts\\Startup\\Script",
		     "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Ctf\\LangBarAddin\\*\\File
		     Path",
		     "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Internet
		     Explorer\\Extensions\\*\\Exec",
		     "HKEY_USERS\\*\\SOFTWARE\\Microsoft\\Internet
		     Explorer\\Extensions\\*\\Script",
		     "\\REGISTRY\\USER\\*\\SOFTWARE\\Microsoft\\Command
		     Processor\\Autorun",                   "\\REGISTRY\\USER\\*\\So
		     ftware\\Microsoft\\Windows\\CurrentVersion\\Run\\*",
		     "\\REGISTRY\\MACHINE\\Software\\Microsoft\\Windows\\CurrentVers
		     ion\\Run\\*",                   "\\REGISTRY\\MACHINE\\Software\
		     \WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Run\\*",
		     "\\REGISTRY\\USER\\*\\Software\\Microsoft\\Windows\\CurrentVers
		     ion\\Policies\\Explorer\\Run\\*",                   "\\REGISTRY
		     \\MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Polici
		     es\\Explorer\\Run\\*",                   "\\REGISTRY\\MACHINE\\
		     Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\*",
		     "\\REGISTRY\\MACHINE\\Software\\Microsoft\\Windows\\CurrentVers
		     ion\\RunOnceEx\\*",                   "\\REGISTRY\\USER\\*\\Sof
		     tware\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\*",
		     "\\REGISTRY\\USER\\*\\Software\\Microsoft\\Windows\\CurrentVers
		     ion\\RunOnceEx\\*",                   "\\REGISTRY\\MACHINE\\SYS
		     TEM\\*ControlSet*\\Services\\*\\ServiceDLL",                   
		     "\\REGISTRY\\MACHINE\\SYSTEM\\*ControlSet*\\Services\\*\\ImageP
		     ath",
		     "\\REGISTRY\\USER\\*\\Software\\Microsoft\\Windows
		     NT\\CurrentVersion\\Winlogon\\Shell\\*",
		     "\\REGISTRY\\USER\\*\\Environment\\UserInitMprLogonScript",
		     "\\REGISTRY\\USER\\*\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Windows\\Load",
		     "\\REGISTRY\\USER\\*\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Winlogon\\Shell",                   "\\REGI
		     STRY\\USER\\*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Po
		     licies\\System\\Shell",                   "\\REGISTRY\\USER\\*\
		     \SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scripts\\Logof
		     f\\Script",                   "\\REGISTRY\\USER\\*\\SOFTWARE\\P
		     olicies\\Microsoft\\Windows\\System\\Scripts\\Logon\\Script",
		     "\\REGISTRY\\USER\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\S
		     ystem\\Scripts\\Shutdown\\Script",                   "\\REGISTR
		     Y\\USER\\*\\SOFTWARE\\Policies\\Microsoft\\Windows\\System\\Scr
		     ipts\\Startup\\Script",                   "\\REGISTRY\\USER\\*\
		     \SOFTWARE\\Microsoft\\Ctf\\LangBarAddin\\*\\FilePath",
		     "\\REGISTRY\\USER\\*\\SOFTWARE\\Microsoft\\Internet
		     Explorer\\Extensions\\*\\Exec",
		     "\\REGISTRY\\USER\\*\\SOFTWARE\\Microsoft\\Internet
		     Explorer\\Extensions\\*\\Script"                   )

NamE: Network Connection via Registration Utility
	description: 
		     Identifies the native Windows tools
		     regsvr32.exe, regsvr64.exe, RegSvcs.exe, or RegAsm.exe making a
		     network connection. This may be indicative of an attacker
		     bypassing allowlists or running arbitrary scripts via a signed
		     Microsoft binary.
	query: 
		     sequence by process.entity_id   [process where
		     host.os.type == "windows" and event.type == "start" and
		     process.name : ("regsvr32.exe", "RegAsm.exe", "RegSvcs.exe")
		     and    not (          (?process.Ext.token.integrity_level_name
		     : "System" or ?winlog.event_data.IntegrityLevel : "System") and
		     (process.parent.name : "msiexec.exe" or
		     process.parent.executable : ("C:\\Program Files (x86)\\*.exe",
		     "C:\\Program Files\\*.exe"))        )    ]   [network where
		     host.os.type == "windows" and process.name : ("regsvr32.exe",
		     "RegAsm.exe", "RegSvcs.exe")  and    not
		     cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8",
		     "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24",
		     "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32",
		     "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32",
		     "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24",
		     "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4",
		     "100.64.0.0/10", "192.175.48.0/24","198.18.0.0/15",
		     "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1",
		     "FE80::/10", "FF00::/8") and network.protocol != "dns"]

NamE: Unusual Remote File Creation
	description: 
		     This rule leverages the new_terms rule type to
		     detect file creation via a commonly used file transfer service
		     while excluding typical remote file creation activity. This
		     behavior is often linked to lateral movement, potentially
		     indicating an attacker attempting to move within a network.
	query: 
		     event.category:file and host.os.type:linux and
		     event.action:creation and process.name:(scp or ftp or sftp or
		     vsftpd or sftp-server or sync) and not file.path:(/dev/ptmx or
		     /run/* or /var/run/*)

NamE: NTDS Dump via Wbadmin
	description: 
		     Identifies the execution of wbadmin to access
		     the NTDS.dit file in a domain controller. Attackers with
		     privileges from groups like Backup Operators can abuse the
		     utility to perform credential access and compromise the domain.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and     (process.name : "wbadmin.exe" or
		     ?process.pe.original_file_name : "wbadmin.exe") and
		     process.args : "recovery" and process.command_line :
		     "*ntds.dit*"

NamE: AWS IAM Create User via Assumed Role on EC2 Instance
	description: 
		     Detects the creation of an AWS Identity and
		     Access Management (IAM) user initiated by an assumed role on an
		     EC2 instance. Assumed roles allow users or services to
		     temporarily adopt different AWS permissions, but the creation
		     of IAM users through these roles—particularly from within EC2
		     instances—may indicate a compromised instance. Adversaries
		     might exploit such permissions to establish persistence by
		     creating new IAM users under unauthorized conditions.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "iam.amazonaws.com"     and event.action:
		     "CreateUser"     and event.outcome: "success"     and
		     aws.cloudtrail.user_identity.type: "AssumedRole"     and
		     aws.cloudtrail.user_identity.arn: *i-*

NamE: Kubernetes Suspicious Self-Subject Review
	description: 
		     This rule detects when a service account or node
		     attempts to enumerate their own permissions via the
		     selfsubjectaccessreview or selfsubjectrulesreview APIs. This is
		     highly unusual behavior for non-human identities like service
		     accounts and nodes. An adversary may have gained access to
		     credentials/tokens and this could be an attempt to determine
		     what privileges they have to facilitate further movement or
		     execution within the cluster.
	query: 
		     event.dataset : "kubernetes.audit_logs"   and kubernet
		     es.audit.annotations.authorization_k8s_io/decision:"allow"
		     and kubernetes.audit.verb:"create"   and
		     kubernetes.audit.objectRef.resource:("selfsubjectaccessreviews"
		     or "selfsubjectrulesreviews")   and
		     (kubernetes.audit.user.username:(system\:serviceaccount\:* or
		     system\:node\:*)   or kubernetes.audit.impersonatedUser.usernam
		     e:(system\:serviceaccount\:* or system\:node\:*))

NamE: GCP Pub/Sub Topic Deletion
	description: 
		     Identifies the deletion of a topic in Google
		     Cloud Platform (GCP). In GCP, the publisher-subscriber
		     relationship (Pub/Sub) is an asynchronous messaging service
		     that decouples event-producing and event-processing services. A
		     publisher application creates and sends messages to a topic.
		     Deleting a topic can interrupt message flow in the Pub/Sub
		     pipeline.
	query: 
		     event.dataset:gcp.audit and
		     event.action:google.pubsub.v*.Publisher.DeleteTopic and
		     event.outcome:success

NamE: AWS IAM Assume Role Policy Update
	description: 
		     Identifies AWS CloudTrail events where an IAM
		     role's trust policy has been updated. The trust policy is a
		     JSON document that defines which principals are allowed to
		     assume the role. An attacker may attempt to modify this policy
		     to gain the privileges of the role. This is a [New
		     Terms](https://www.elastic.co/guide/en/security/current/rules-
		     ui-create.html#create-new-terms-rule) rule, which means it will
		     only trigger once for each unique value of the
		     `aws.cloudtrail.user_identity.arn` and
		     `aws.cloudtrail.flattened.request_parameters.roleName` fields
		     that has not been seen making this API request within the last
		     14 days.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "iam.amazonaws.com"     and event.action:
		     "UpdateAssumeRolePolicy"     and event.outcome: "success"
		     and not source.address: "cloudformation.amazonaws.com"

NamE: AWS STS GetCallerIdentity API Called for the First Time
	description: 
		     An adversary with access to a set of compromised
		     credentials may attempt to verify that the credentials are
		     valid and determine what account they are using. This rule
		     looks for the first time an identity has called the STS
		     `GetCallerIdentity` API operation in the last 15 days, which
		     may be an indicator of compromised credentials. A legitimate
		     user would not need to call this operation as they should know
		     the account they are using.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "sts.amazonaws.com"     and event.action:
		     "GetCallerIdentity"     and event.outcome: "success"     and
		     not aws.cloudtrail.user_identity.type: "AssumedRole"

NamE: Potential Abuse of Resources by High Token Count and Large Response Sizes
	description: 
		     Detects potential resource exhaustion or data
		     breach attempts by monitoring for users who consistently
		     generate high input token counts, submit numerous requests, and
		     receive large responses. This behavior could indicate an
		     attempt to overload the system or extract an unusually large
		     amount of data, possibly revealing sensitive information or
		     causing service disruptions.
	query: 
		     from logs-aws_bedrock.invocation-* | keep user.id,
		     gen_ai.usage.prompt_tokens, gen_ai.usage.completion_tokens |
		     stats max_tokens = max(gen_ai.usage.prompt_tokens),
		     total_requests = count(*),          avg_response_size =
		     avg(gen_ai.usage.completion_tokens)   by user.id // tokens
		     count depends on specific LLM, as is related to how embeddings
		     are generated. | where max_tokens > 5000 and total_requests >
		     10 and avg_response_size > 500 | eval risk_factor = (max_tokens
		     / 1000) * total_requests * (avg_response_size / 500) | where
		     risk_factor > 10 | sort risk_factor desc

NamE: Suspicious Startup Shell Folder Modification
	description: 
		     Identifies suspicious startup shell folder
		     modifications to change the default Startup directory in order
		     to bypass detections monitoring file creation in the Windows
		     Startup folder.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and  registry.value : ("Common Startup",
		     "Startup") and  registry.path : (      "HKLM\\Software\\Microso
		     ft\\Windows\\CurrentVersion\\Explorer\\User Shell
		     Folders\\Common Startup",      "HKLM\\Software\\Microsoft\\Wind
		     ows\\CurrentVersion\\Explorer\\Shell Folders\\Common Startup",
		     "HKEY_USERS\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\E
		     xplorer\\User Shell Folders\\Startup",      "HKEY_USERS\\*\\Sof
		     tware\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell
		     Folders\\Startup",      "HKU\\*\\Software\\Microsoft\\Windows\\
		     CurrentVersion\\Explorer\\User Shell Folders\\Startup",      "H
		     KU\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\
		     Shell Folders\\Startup",      "HKCU\\*\\Software\\Microsoft\\Wi
		     ndows\\CurrentVersion\\Explorer\\User Shell Folders\\Startup",
		     "HKCU\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explore
		     r\\Shell Folders\\Startup",      "\\REGISTRY\\MACHINE\\Software
		     \\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell
		     Folders\\Common Startup",      "\\REGISTRY\\MACHINE\\Software\\
		     Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell
		     Folders\\Common Startup",      "\\REGISTRY\\USER\\*\\Software\\
		     Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell
		     Folders\\Startup",      "\\REGISTRY\\USER\\*\\Software\\Microso
		     ft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\\Startup",
		     "MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Explore
		     r\\User Shell Folders\\Common Startup",      "MACHINE\\Software
		     \\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell
		     Folders\\Common Startup",      "USER\\*\\Software\\Microsoft\\W
		     indows\\CurrentVersion\\Explorer\\User Shell Folders\\Startup",
		     "USER\\*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explore
		     r\\Shell Folders\\Startup"      ) and   registry.data.strings
		     != null and   /* Normal Startup Folder Paths */   not
		     registry.data.strings : (
		     "C:\\ProgramData\\Microsoft\\Windows\\Start
		     Menu\\Programs\\Startup",
		     "%ProgramData%\\Microsoft\\Windows\\Start
		     Menu\\Programs\\Startup",
		     "%USERPROFILE%\\AppData\\Roaming\\Microsoft\\Windows\\Start
		     Menu\\Programs\\Startup",
		     "C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Windows\\Start
		     Menu\\Programs\\Startup"            )

NamE: AWS CloudTrail Log Suspended
	description: 
		     Identifies suspending the recording of AWS API
		     calls and log file delivery for the specified trail. An
		     adversary may suspend trails in an attempt to evade defenses.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:cloudtrail.amazonaws.com and
		     event.action:StopLogging and event.outcome:success

NamE: AWS IAM Brute Force of Assume Role Policy
	description: 
		     Identifies a high number of failed attempts to
		     assume an AWS Identity and Access Management (IAM) role. IAM
		     roles are used to delegate access to users or services. An
		     adversary may attempt to enumerate IAM roles in order to
		     determine if a role exists before attempting to assume or
		     hijack the discovered role.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:iam.amazonaws.com and
		     event.action:UpdateAssumeRolePolicy and
		     aws.cloudtrail.error_code:MalformedPolicyDocumentException and
		     event.outcome:failure

NamE: Suspicious Image Load (taskschd.dll) from MS Office
	description: 
		     Identifies a suspicious image load
		     (taskschd.dll) from Microsoft Office processes. This behavior
		     may indicate adversarial activity where a scheduled task is
		     configured via Windows Component Object Model (COM). This
		     technique can be used to configure persistence and evade
		     monitoring by avoiding the usage of the traditional Windows
		     binary (schtasks.exe) used to manage scheduled tasks.
	query: 
		     any where host.os.type == "windows" and
		     (event.category : ("library", "driver") or (event.category ==
		     "process" and event.action : "Image loaded*")) and
		     process.name : ("WINWORD.EXE", "EXCEL.EXE", "POWERPNT.EXE",
		     "MSPUB.EXE", "MSACCESS.EXE") and   (?dll.name : "taskschd.dll"
		     or file.name : "taskschd.dll")

NamE: Suspicious Symbolic Link Created
	description: 
		     Identifies the creation of a symbolic link to a
		     suspicious file or location. A symbolic link is a reference to
		     a file or directory that acts as a pointer or shortcut,
		     allowing users to access the target file or directory from a
		     different location in the file system. An attacker can
		     potentially leverage symbolic links for privilege escalation by
		     tricking a privileged process into following the symbolic link
		     to a sensitive file, giving the attacker access to data or
		     capabilities they would not normally have.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action == "exec" and process.name == "ln"
		     and process.args in ("-s", "-sf") and   (     /* suspicious
		     files */     (process.args in ("/etc/shadow", "/etc/shadow-",
		     "/etc/shadow~", "/etc/gshadow", "/etc/gshadow-") or
		     (process.working_directory == "/etc" and process.args in
		     ("shadow", "shadow-", "shadow~", "gshadow", "gshadow-"))) or
		     /* suspicious bins */     (process.args in ("/bin/bash",
		     "/bin/dash", "/bin/sh", "/bin/tcsh", "/bin/csh", "/bin/zsh",
		     "/bin/ksh", "/bin/fish") or     (process.working_directory ==
		     "/bin" and process.args : ("bash", "dash", "sh", "tcsh", "csh",
		     "zsh", "ksh", "fish"))) or     (process.args in
		     ("/usr/bin/bash", "/usr/bin/dash", "/usr/bin/sh",
		     "/usr/bin/tcsh", "/usr/bin/csh", "/usr/bin/zsh",
		     "/usr/bin/ksh", "/usr/bin/fish") or
		     (process.working_directory == "/usr/bin" and process.args in
		     ("bash", "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish")))
		     or      /* suspicious locations */     (process.args :
		     ("/etc/cron.d/*", "/etc/cron.daily/*", "/etc/cron.hourly/*",
		     "/etc/cron.weekly/*", "/etc/cron.monthly/*")) or
		     (process.args : ("/home/*/.ssh/*",
		     "/root/.ssh/*","/etc/sudoers.d/*", "/dev/shm/*"))   ) and
		     process.parent.name in ("bash", "dash", "ash", "sh", "tcsh",
		     "csh", "zsh", "ksh", "fish") and   not user.Ext.real.id == "0"
		     and not group.Ext.real.id == "0"

NamE: System Binary Moved or Copied
	description: 
		     This rule monitors for the copying or moving of
		     a system binary. Adversaries may copy/move and rename system
		     binaries to evade detection. Copying a system binary to a
		     different location should not occur often, so if it does, the
		     activity should be investigated.
	query: 
		     file where host.os.type == "linux" and event.type ==
		     "change" and event.action == "rename" and process.name != null
		     and file.Ext.original.path : (   "/bin/*", "/usr/bin/*",
		     "/usr/local/bin/*", "/sbin/*", "/usr/sbin/*",
		     "/usr/local/sbin/*" ) and not (   process.executable in (
		     "/bin/dpkg", "/usr/bin/dpkg", "/bin/dockerd",
		     "/usr/bin/dockerd", "/usr/sbin/dockerd", "/bin/microdnf",
		     "/usr/bin/microdnf", "/bin/rpm", "/usr/bin/rpm", "/bin/snapd",
		     "/usr/bin/snapd", "/bin/yum", "/usr/bin/yum",     "/bin/dnf",
		     "/usr/bin/dnf", "/bin/podman", "/usr/bin/podman", "/bin/dnf-
		     automatic", "/usr/bin/dnf-automatic",     "/bin/pacman",
		     "/usr/bin/pacman", "/usr/bin/dpkg-divert", "/bin/dpkg-divert",
		     "/sbin/apk", "/usr/sbin/apk",     "/usr/local/sbin/apk",
		     "/usr/bin/apt", "/usr/sbin/pacman", "/bin/podman",
		     "/usr/bin/podman", "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/lib/snapd/snapd", "/usr/local/bin/dockerd",
		     "/usr/libexec/netplan/generate",     "/usr/bin/update-
		     alternatives", "/bin/update-alternatives", "/usr/sbin/update-
		     alternatives",     "/sbin/update-alternatives",
		     "/usr/bin/pip3", "/bin/pip3", "/usr/local/bin/pip3",
		     "/usr/local/bin/node",     "/bin/node", "/usr/bin/node",
		     "/sbin/apk", "/usr/sbin/apk", "/usr/local/sbin/apk",
		     "/usr/bin/pip", "/bin/pip",     "/usr/local/bin/pip",
		     "/usr/libexec/platform-python", "/usr/bin/platform-python",
		     "/bin/platform-python",     "/usr/lib/systemd/systemd",
		     "/usr/sbin/sshd", "/sbin/sshd", "/usr/local/sbin/sshd",
		     "/usr/sbin/crond", "/sbin/crond",     "/usr/local/sbin/crond",
		     "/usr/sbin/gdm"   ) or   process.name like (     "python*",
		     "packagekitd", "systemd", "ln", "platform-python",
		     "dnf_install", "runc", "apt-get", "ssm-agent-worker",
		     "convert-usrmerge", "updatenow.static-cpanelsync", "apk",
		     "exe", "php", "containerd-shim-runc-v2", "dpkg", "sed",
		     "platform-python*", "gedit", "crond", "sshd", "ruby", "sudo",
		     "chainctl", "update-alternatives", "pip*", "microdnf",
		     "rsync", "convert2rhel", "convert-usr-merge"   ) or
		     file.Ext.original.path : (     "/bin/*.tmp", "/usr/bin/*.tmp",
		     "/usr/local/bin/*.tmp", "/sbin/*.tmp", "/usr/sbin/*.tmp",
		     "/usr/local/sbin/*.tmp"   ) or   file.extension in ("swp",
		     "swpx", "swx", "dpkg-remove") or   file.Ext.original.extension
		     == "dpkg-new" or   process.executable : ("/nix/store/*",
		     "/var/lib/dpkg/*", "/tmp/vmis.*", "/snap/*", "/dev/fd/*") or
		     process.executable == null or   (process.name == "sed" and
		     file.name : "sed*") or   (process.name == "perl" and file.name
		     : "e2scrub_all.tmp*") )

NamE: DNS-over-HTTPS Enabled via Registry
	description: 
		     Identifies when a user enables DNS-over-HTTPS.
		     This can be used to hide internet activity or the process of
		     exfiltrating data. With this enabled, an organization will lose
		     visibility into data such as query type, response, and
		     originating IP, which are used to determine bad actors.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   (registry.path : "*\\SOFTWARE\\Pol
		     icies\\Microsoft\\Edge\\BuiltInDnsClientEnabled" and
		     registry.data.strings : ("1", "0x00000001")) or
		     (registry.path :
		     "*\\SOFTWARE\\Google\\Chrome\\DnsOverHttpsMode" and
		     registry.data.strings : "secure") or   (registry.path :
		     "*\\SOFTWARE\\Policies\\Mozilla\\Firefox\\DNSOverHTTPS" and
		     registry.data.strings : ("1", "0x00000001"))

NamE: Potential Evasion via Filter Manager
	description: 
		     The Filter Manager Control Program (fltMC.exe)
		     binary may be abused by adversaries to unload a filter driver
		     and evade defenses.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : "fltMC.exe" and process.args :
		     "unload" and   not process.parent.executable :
		     ("?:\\Program Files
		     (x86)\\ManageEngine\\UEMS_Agent\\bin\\DCFAService64.exe",
		     "?:\\Windows\\SysWOW64\\msiexec.exe",
		     "?:\\Program Files\\Bitdefender\\Endpoint
		     Security\\installer\\installer.exe",
		     "?:\\Program Files\\Bitdefender\\Endpoint
		     Security\\EPSecurityService.exe",
		     "?:\\Program Files\\Bitdefender\\Bitdefender
		     Security\\productcfg.exe",                      "?:\\Program
		     Files\\Bitdefender\\Bitdefender Security\\bdservicehost.exe",
		     "?:\\Program Files\\Bitdefender\\EndpointSetupInformation\\{*}\
		     \Installer.exe")

NamE: Microsoft Management Console File from Unusual Path
	description: 
		     Identifies attempts to open a Microsoft
		     Management Console File from untrusted paths. Adversaries may
		     use MSC files for initial access and execution.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.executable : (
		     "?:\\Windows\\System32\\mmc.exe",
		     "\\Device\\HarddiskVolume?\\Windows\\System32\\mmc.exe"   ) and
		     process.args : "*.msc" and   not process.args : (
		     "?:\\Windows\\System32\\*.msc",
		     "?:\\Windows\\SysWOW64\\*.msc",         "?:\\Program
		     files\\*.msc",         "?:\\Program Files (x86)\\*.msc"   )

NamE: Potential WSUS Abuse for Lateral Movement
	description: 
		     Identifies a potential Windows Server Update
		     Services (WSUS) abuse to execute psexec to enable for lateral
		     movement. WSUS is limited to executing Microsoft signed
		     binaries, which limits the executables that can be used to
		     tools published by Microsoft.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and process.parent.name : "wuauclt.exe" and
		     process.executable : (
		     "?:\\Windows\\SoftwareDistribution\\Download\\Install\\*",     
		     "\\Device\\HarddiskVolume?\\Windows\\SoftwareDistribution\\Down
		     load\\Install\\*" ) and (process.name : "psexec64.exe" or
		     ?process.pe.original_file_name : "psexec.c")

NamE: Bypass UAC via Event Viewer
	description: 
		     Identifies User Account Control (UAC) bypass via
		     eventvwr.exe. Attackers bypass UAC to stealthily execute code
		     with elevated permissions.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.name : "eventvwr.exe" and   not
		     process.executable : (
		     "?:\\Windows\\SysWOW64\\mmc.exe",
		     "?:\\Windows\\System32\\mmc.exe",
		     "?:\\Windows\\SysWOW64\\WerFault.exe",
		     "?:\\Windows\\System32\\WerFault.exe",
		     "?\\Device\\HarddiskVolume?\\Windows\\Sys?????\\mmc.exe",
		     "?\\Device\\HarddiskVolume?\\Windows\\Sys?????\\WerFault.exe"
		     )

NamE: Potential Privacy Control Bypass via Localhost Secure Copy
	description: 
		     Identifies use of the Secure Copy Protocol (SCP)
		     to copy files locally by abusing the auto addition of the
		     Secure Shell Daemon (sshd) to the authorized application list
		     for Full Disk Access. This may indicate attempts to bypass
		     macOS privacy controls to access sensitive files.
	query: 
		     process where host.os.type == "macos" and event.type
		     in ("start", "process_started") and  process.name:"scp" and
		     process.args:"StrictHostKeyChecking=no" and
		     process.command_line:("scp *localhost:/*", "scp *127.0.0.1:/*")
		     and  not process.args:"vagrant@*127.0.0.1*"

NamE: Potential Persistence via Login Hook
	description: 
		     Identifies the creation or modification of the
		     login window property list (plist). Adversaries may modify
		     plist files to run a program during system boot or user login
		     for persistence.
	query: 
		     event.category:file and host.os.type:macos and not
		     event.type:"deletion" and
		     file.name:"com.apple.loginwindow.plist" and  not process.name:
		     (systemmigrationd or DesktopServicesHelper or diskmanagementd
		     or rsync or launchd or cfprefsd or xpcproxy or ManagedClient or
		     MCXCompositor or backupd or "iMazing Profile Editor" or
		     storagekitd or CloneKitService)

NamE: GitHub UEBA - Multiple Alerts from a GitHub Account
	description: 
		     This rule is part of the "GitHub UEBA - Unusual
		     Activity from Account Pack", and leverages alert data to
		     determine when multiple alerts are executed by the same user in
		     a timespan of one hour. Analysts can use this to prioritize
		     triage and response, as these alerts are a higher indicator of
		     compromised user accounts or PATs.
	query: 
		     signal.rule.tags:("Use Case: UEBA" and "Data Source:
		     Github") and kibana.alert.workflow_status:"open"

NamE: Remote File Download via Desktopimgdownldr Utility
	description: 
		     Identifies the desktopimgdownldr utility being
		     used to download a remote file. An adversary may use
		     desktopimgdownldr to download arbitrary files as an alternative
		     to certutil.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (process.name : "desktopimgdownldr.exe" or
		     ?process.pe.original_file_name == "desktopimgdownldr.exe") and
		     process.args : "/lockscreenurl:http*"

NamE: Modification of Environment Variable via Unsigned or Untrusted Parent
	description: 
		     Identifies modifications to an environment
		     variable using the built-in launchctl command. Adversaries may
		     execute their own malicious payloads by hijacking certain
		     environment variables to load arbitrary libraries or bypass
		     certain restrictions.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:start and   process.name:launchctl and
		     (process.parent.code_signature.exists : false or
		     process.parent.code_signature.trusted : false) and
		     process.args:(setenv and not (ANT_HOME or
		     DBUS_LAUNCHD_SESSION_BUS_SOCKET or
		     EDEN_ENV or
		     LG_WEBOS_TV_SDK_HOME or
		     RUNTIME_JAVA_HOME or
		     WEBOS_CLI_TV or                                 JAVA*_HOME) and
		     not *.vmoptions) and   not
		     process.parent.executable:("/Applications/IntelliJ IDEA
		     CE.app/Contents/jbr/Contents/Home/lib/jspawnhelper" or
		     /Applications/NoMachine.app/Contents/Frameworks/bin/nxserver.bi
		     n or                                   /Applications/NoMachine.
		     app/Contents/Frameworks/bin/nxserver.bin or
		     /usr/local/bin/kr)

NamE: Sensitive Files Compression
	description: 
		     Identifies the use of a compression utility to
		     collect known files containing sensitive information, such as
		     credentials and system configurations.
	query: 
		     event.category:process and host.os.type:linux and
		     event.type:start and   process.name:(zip or tar or gzip or
		     hdiutil or 7z) and   process.args:     (
		     /root/.ssh/id_rsa or       /root/.ssh/id_rsa.pub or
		     /root/.ssh/id_ed25519 or       /root/.ssh/id_ed25519.pub or
		     /root/.ssh/authorized_keys or       /root/.ssh/authorized_keys2
		     or       /root/.ssh/known_hosts or       /root/.bash_history or
		     /etc/hosts or       /home/*/.ssh/id_rsa or
		     /home/*/.ssh/id_rsa.pub or       /home/*/.ssh/id_ed25519 or
		     /home/*/.ssh/id_ed25519.pub or
		     /home/*/.ssh/authorized_keys or
		     /home/*/.ssh/authorized_keys2 or       /home/*/.ssh/known_hosts
		     or       /home/*/.bash_history or       /root/.aws/credentials
		     or       /root/.aws/config or       /home/*/.aws/credentials or
		     /home/*/.aws/config or       /root/.docker/config.json or
		     /home/*/.docker/config.json or       /etc/group or
		     /etc/passwd or       /etc/shadow or       /etc/gshadow     )

NamE: Modification of Dynamic Linker Preload Shared Object
	description: 
		     Identifies modification of the dynamic linker
		     preload shared object (ld.so.preload). Adversaries may execute
		     malicious payloads by hijacking the dynamic linker used to load
		     libraries.
	query: 
		     host.os.type:linux and event.category:file and
		     event.action:(file_rename_event or rename or renamed or
		     updated) and not event.type:deletion and
		     file.path:/etc/ld.so.preload and process.name:(* and not
		     (oneagentinstallaction or passwd or wine))

NamE: Sudo Heap-Based Buffer Overflow Attempt
	description: 
		     Identifies the attempted use of a heap-based
		     buffer overflow vulnerability for the Sudo binary in Unix-like
		     systems (CVE-2021-3156). Successful exploitation allows an
		     unprivileged user to escalate to the root user.
	query: 
		     event.category:process and event.type:start and
		     process.name:(sudo or sudoedit) and   process.args:(*\\ and
		     ("-i" or "-s"))

NamE: Okta Brute Force or Password Spraying Attack
	description: 
		     Identifies a high number of failed Okta user
		     authentication attempts from a single IP address, which could
		     be indicative of a brute force or password spraying attack. An
		     adversary may attempt a brute force or password spraying attack
		     to obtain unauthorized access to user accounts.
	query: 
		     event.dataset:okta.system and
		     event.category:authentication and event.outcome:failure

NamE: New GitHub Owner Added
	description: 
		     Detects when a new member is added to a GitHub
		     organization as an owner. This role provides admin level
		     privileges. Any new owner roles should be investigated to
		     determine it's validity. Unauthorized owner roles could
		     indicate compromise within your organization and provide
		     unlimited access to data and settings.
	query: 
		     iam where event.dataset == "github.audit" and
		     event.action == "org.add_member" and github.permission ==
		     "admin"

NamE: Attempt to Delete an Okta Application
	description: 
		     Detects attempts to delete an Okta application.
		     An adversary may attempt to modify, deactivate, or delete an
		     Okta application in order to weaken an organization's security
		     controls or disrupt their business operations.
	query: 
		     event.dataset:okta.system and
		     event.action:application.lifecycle.delete

NamE: Potential Meterpreter Reverse Shell
	description: 
		     This detection rule identifies a sample of
		     suspicious Linux system file reads used for system
		     fingerprinting, leveraged by the Metasploit Meterpreter shell
		     to gather information about the target that it is executing its
		     shell on. Detecting this pattern is indicative of a successful
		     meterpreter shell connection.
	query: 
		     sample by host.id, process.pid, user.id   [file where
		     host.os.type == "linux" and auditd.data.syscall == "open" and
		     auditd.data.a2 == "1b6" and file.path == "/etc/machine-id"]
		     [file where host.os.type == "linux" and auditd.data.syscall ==
		     "open" and auditd.data.a2 == "1b6" and file.path ==
		     "/etc/passwd"]   [file where host.os.type == "linux" and
		     auditd.data.syscall == "open" and auditd.data.a2 == "1b6" and
		     file.path == "/proc/net/route"]   [file where host.os.type ==
		     "linux" and auditd.data.syscall == "open" and auditd.data.a2 ==
		     "1b6" and file.path == "/proc/net/ipv6_route"]   [file where
		     host.os.type == "linux" and auditd.data.syscall == "open" and
		     auditd.data.a2 == "1b6" and file.path == "/proc/net/if_inet6"]

NamE: Attempt to Modify an Okta Network Zone
	description: 
		     Detects attempts to modify an Okta network zone.
		     Okta network zones can be configured to limit or restrict
		     access to a network based on IP addresses or geolocations. An
		     adversary may attempt to modify, delete, or deactivate an Okta
		     network zone in order to remove or weaken an organization's
		     security controls.
	query: 
		     event.dataset:okta.system and
		     event.action:(zone.update or network_zone.rule.disabled or
		     zone.remove_blacklist)

NamE: O365 Excessive Single Sign-On Logon Errors
	description: 
		     Identifies accounts with a high number of single
		     sign-on (SSO) logon errors. Excessive logon errors may indicate
		     an attempt to brute force a password or SSO token.
	query: 
		     event.dataset:o365.audit and
		     event.provider:AzureActiveDirectory and
		     event.category:authentication and
		     o365.audit.LogonError:"SsoArtifactInvalidOrExpired"

NamE: AWS S3 Object Versioning Suspended
	description: 
		     Identifies when object versioning is suspended
		     for an Amazon S3 bucket. Object versioning allows for multiple
		     versions of an object to exist in the same bucket. This allows
		     for easy recovery of deleted or overwritten objects. When
		     object versioning is suspended for a bucket, it could indicate
		     an adversary's attempt to inhibit system recovery following
		     malicious activity. Additionally, when versioning is suspended,
		     buckets can then be deleted.
	query: 
		     any where event.dataset == "aws.cloudtrail"    and
		     event.action == "PutBucketVersioning"    and event.outcome ==
		     "success"    and
		     stringContains(aws.cloudtrail.request_parameters,
		     "Status=Suspended")

NamE: Web Shell Detection: Script Process Child of Common Web Processes
	description: 
		     Identifies suspicious commands executed via a
		     web server, which may suggest a vulnerability and remote shell
		     access.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.name : ("w3wp.exe",
		     "httpd.exe", "nginx.exe", "php.exe", "php-cgi.exe",
		     "tomcat.exe") and   process.name : ("cmd.exe", "cscript.exe",
		     "powershell.exe", "pwsh.exe", "powershell_ise.exe", "wmic.exe",
		     "wscript.exe") and   not   (     process.parent.name :
		     ("php.exe", "httpd.exe") and process.name : "cmd.exe" and
		     process.command_line : (       "cmd.exe /c mode CON",
		     "cmd.exe /s /c \"mode CON\"",       "cmd.exe /c \"mode\"",
		     "cmd.exe /s /c \"tput colors 2>&1\""     )   )

NamE: Network Connection via Certutil
	description: 
		     Identifies certutil.exe making a network
		     connection. Adversaries could abuse certutil.exe to download a
		     certificate, or malware, from a remote URL.
	query: 
		     network where host.os.type == "windows" and
		     process.name : "certutil.exe" and   not
		     cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8",
		     "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24",
		     "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32",
		     "192.0.0.10/32", "192.0.0.170/32",
		     "192.0.0.171/32", "192.0.2.0/24", "192.31.196.0/24",
		     "192.52.193.0/24",
		     "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4",
		     "100.64.0.0/10", "192.175.48.0/24",
		     "198.18.0.0/15", "198.51.100.0/24", "203.0.113.0/24",
		     "240.0.0.0/4", "::1",
		     "FE80::/10", "FF00::/8") and   not dns.question.name in
		     ("localhost", "*.digicert.com", "ctldl.windowsupdate.com")

NamE: Binary Executed from Shared Memory Directory
	description: 
		     Identifies the execution of a binary by root in
		     Linux shared memory directories: (/dev/shm/, /run/shm/,
		     /var/run/, /var/lock/). This activity is to be considered
		     highly abnormal and should be investigated. Threat actors have
		     placed executables used for persistence on high-uptime servers
		     in these directories as system backdoors.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event") and
		     user.id == "0" and process.executable : ("/dev/shm/*",
		     "/run/shm/*", "/var/run/*", "/var/lock/*") and not
		     process.executable : ("/var/run/docker/*", "/var/run/utsns/*",
		     "/var/run/s6/*", "/var/run/cloudera-scm-agent/*",
		     "/var/run/argo/argoexec") and not process.parent.command_line :
		     "/usr/bin/runc init"

NamE: Potential Unauthorized Access via Wildcard Injection Detected
	description: 
		     This rule monitors for the execution of the
		     "chown" and "chmod" commands with command line flags that could
		     indicate a wildcard injection attack. Linux wildcard injection
		     is a type of security vulnerability where attackers manipulate
		     commands or input containing wildcards (e.g., *, ?, []) to
		     execute unintended operations or access sensitive data by
		     tricking the system into interpreting the wildcard characters
		     in unexpected ways.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2", "executed", "process_started") and
		     process.name in ("chown", "chmod") and process.args == "-R" and
		     process.args : "--reference=*"

NamE: Potential Denial of Azure OpenAI ML Service
	description: 
		     Detects patterns indicative of Denial-of-Service
		     (DoS) attacks on machine learning (ML) models, focusing on
		     unusually high volume and frequency of requests or patterns of
		     requests that are known to cause performance degradation or
		     service disruption, such as large input sizes or rapid API
		     calls.
	query: 
		     from logs-azure_openai.logs-* // truncate the
		     timestamp to a 1-minute window | eval target_time_window =
		     DATE_TRUNC(1 minutes, @timestamp) | where
		     azure.open_ai.operation_name == "ChatCompletions_Create" | keep
		     azure.open_ai.properties.request_length, azure.resource.name,
		     cloud.account.id,target_time_window | stats count = count(),
		     avg_request_size = avg(azure.open_ai.properties.request_length)
		     by target_time_window, azure.resource.name | where count >= 10
		     and avg_request_size >= 5000 | sort count desc

NamE: AWS RDS Instance Creation
	description: 
		     Identifies the creation of an Amazon Relational
		     Database Service (RDS) Aurora database instance.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:rds.amazonaws.com and
		     event.action:CreateDBInstance and event.outcome:success

NamE: SSM Session Started to EC2 Instance
	description: 
		     Identifies the first occurrence of an AWS
		     resource establishing a session via SSM to an EC2 instance.
		     Adversaries may use AWS Systems Manager to establish a session
		     to an EC2 instance to execute commands on the instance. This
		     can be used to gain access to the instance and perform actions
		     such as privilege escalation. This rule helps detect the first
		     occurrence of this activity for a given AWS resource.
	query: 
		     event.dataset:"aws.cloudtrail" and
		     event.provider:"ssm.amazonaws.com"     and
		     event.action:"StartSession" and event.outcome:"success"

NamE: AWS KMS Customer Managed Key Disabled or Scheduled for Deletion
	description: 
		     Identifies attempts to disable or schedule the
		     deletion of an AWS KMS Customer Managed Key (CMK). Deleting an
		     AWS KMS key is destructive and potentially dangerous. It
		     deletes the key material and all metadata associated with the
		     KMS key and is irreversible. After a KMS key is deleted, the
		     data that was encrypted under that KMS key can no longer be
		     decrypted, which means that data becomes unrecoverable.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:kms.amazonaws.com and event.action:("DisableKey"
		     or "ScheduleKeyDeletion") and event.outcome:success

NamE: AWS Route 53 Domain Transfer Lock Disabled
	description: 
		     Identifies when a transfer lock was removed from
		     a Route 53 domain. It is recommended to refrain from performing
		     this action unless intending to transfer the domain to a
		     different registrar.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:route53.amazonaws.com and
		     event.action:DisableDomainTransferLock and
		     event.outcome:success

NamE: APT Package Manager Configuration File Creation
	description: 
		     Detects file creation events in the
		     configuration directory for the APT package manager. In Linux,
		     APT (Advanced Package Tool) is a command-line utility used for
		     handling packages on (by default) Debian-based systems,
		     providing functions for installing, updating, upgrading, and
		     removing software along with managing package repositories.
		     Attackers can backdoor APT to gain persistence by injecting
		     malicious code into scripts that APT runs, thereby ensuring
		     continued unauthorized access or control each time APT is used
		     for package management.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("rename", "creation") and file.path : "/etc/apt/apt.conf.d/*"
		     and not (   process.executable in (     "/bin/dpkg",
		     "/usr/bin/dpkg", "/bin/dockerd", "/usr/bin/dockerd",
		     "/usr/sbin/dockerd", "/bin/microdnf",     "/usr/bin/microdnf",
		     "/bin/rpm", "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd",
		     "/bin/yum", "/usr/bin/yum",     "/bin/dnf", "/usr/bin/dnf",
		     "/bin/podman", "/usr/bin/podman", "/bin/dnf-automatic",
		     "/usr/bin/dnf-automatic",     "/bin/pacman", "/usr/bin/pacman",
		     "/usr/bin/dpkg-divert", "/bin/dpkg-divert", "/sbin/apk",
		     "/usr/sbin/apk",     "/usr/local/sbin/apk", "/usr/bin/apt",
		     "/usr/sbin/pacman", "/bin/podman", "/usr/bin/podman",
		     "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/lib/snapd/snapd", "/usr/local/bin/dockerd",
		     "/usr/libexec/netplan/generate",     "/usr/local/bin/apt-get",
		     "/usr/bin/apt-get"   ) or   file.path
		     :("/etc/apt/apt.conf.d/*.tmp*") or   file.extension in ("swp",
		     "swpx", "swx", "dpkg-remove") or   file.Ext.original.extension
		     == "dpkg-new" or   process.executable : (     "/nix/store/*",
		     "/var/lib/dpkg/*", "/tmp/vmis.*", "/snap/*", "/dev/fd/*",
		     "/usr/lib/*", "/usr/libexec/*",     "/etc/kernel/*"   ) or
		     process.executable == null or   process.name in ("pveupdate",
		     "perl", "executor", "crio", "docker-init", "dockerd",
		     "pvedaemon") or   (process.name == "sed" and file.name :
		     "sed*") or   (process.name == "perl" and file.name :
		     "e2scrub_all.tmp*") )

NamE: Suspicious Renaming of ESXI index.html File
	description: 
		     Identifies instances where the "index.html" file
		     within the "/usr/lib/vmware/*" directory is renamed on a Linux
		     system. The rule monitors for the "rename" event action
		     associated with this specific file and path, which could
		     indicate malicious activity.
	query: 
		     file where host.os.type == "linux" and event.action ==
		     "rename" and file.name : "index.html" and
		     file.Ext.original.path : "/usr/lib/vmware/*"

NamE: Remote XSL Script Execution via COM
	description: 
		     Identifies the execution of a hosted XSL script
		     using the Microsoft.XMLDOM COM interface via Microsoft Office
		     processes. This behavior may indicate adversarial activity to
		     execute malicious JScript or VBScript on the system.
	query: 
		     sequence with maxspan=1m  [library where host.os.type
		     == "windows" and dll.name : "msxml3.dll" and   process.name :
		     ("winword.exe", "excel.exe", "powerpnt.exe", "mspub.exe")] by
		     process.entity_id  [process where host.os.type == "windows" and
		     event.action == "start" and   process.parent.name :
		     ("winword.exe", "excel.exe", "powerpnt.exe", "mspub.exe") and
		     not process.executable :
		     ("?:\\Windows\\System32\\WerFault.exe",
		     "?:\\Windows\\SysWoW64\\WerFault.exe",
		     "?:\\windows\\splwow64.exe",
		     "?:\\Windows\\System32\\conhost.exe",          "?:\\Program
		     Files\\*.exe",          "?:\\Program Files (x86)\\*exe")] by
		     process.parent.entity_id

NamE: Threat Intel IP Address Indicator Match
	description: 
		     This rule is triggered when an IP address
		     indicator from the Threat Intel Filebeat module or integrations
		     has a match against a network event.
	query: 
		     source.ip:* or destination.ip:*

NamE: Kubernetes Anonymous Request Authorized
	description: 
		     This rule detects when an unauthenticated user
		     request is authorized within the cluster. Attackers may attempt
		     to use anonymous accounts to gain initial access to the cluster
		     or to avoid attribution of their activities within the cluster.
		     This rule excludes the /healthz, /livez and /readyz endpoints
		     which are commonly accessed anonymously.
	query: 
		     event.dataset:kubernetes.audit_logs   and kubernetes.a
		     udit.annotations.authorization_k8s_io/decision:allow   and
		     kubernetes.audit.user.username:("system:anonymous" or
		     "system:unauthenticated" or not *)   and not
		     kubernetes.audit.requestURI:(/healthz* or /livez* or /readyz*)

NamE: Azure Automation Runbook Created or Modified
	description: 
		     Identifies when an Azure Automation runbook is
		     created or modified. An adversary may create or modify an Azure
		     Automation runbook to execute malicious code and maintain
		     persistence in their target's environment.
	query: 
		     event.dataset:azure.activitylogs and
		     azure.activitylogs.operation_name:   (
		     "MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/RUNBOOKS/DRAFT/WRITE"
		     or     "MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/RUNBOOKS/WRITE"
		     or     "MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/RUNBOOKS/PUBLIS
		     H/ACTION"   ) and   event.outcome:(Success or success)

NamE: Attempt to Deactivate an Okta Policy
	description: 
		     Detects attempts to deactivate an Okta policy.
		     An adversary may attempt to deactivate an Okta policy in order
		     to weaken an organization's security controls. For example, an
		     adversary may attempt to deactivate an Okta multi-factor
		     authentication (MFA) policy in order to weaken the
		     authentication requirements for user accounts.
	query: 
		     event.dataset:okta.system and
		     event.action:policy.lifecycle.deactivate

NamE: Windows Service Installed via an Unusual Client
	description: 
		     Identifies the creation of a Windows service by
		     an unusual client process. Services may be created with
		     administrator privileges but are executed under SYSTEM
		     privileges, so an adversary may also use a service to escalate
		     privileges from administrator to SYSTEM.
	query: 
		     configuration where host.os.type == "windows" and
		     event.action == "service-installed" and
		     (winlog.event_data.ClientProcessId == "0" or
		     winlog.event_data.ParentProcessId == "0") and   not
		     winlog.event_data.ServiceFileName : (
		     "?:\\Windows\\VeeamVssSupport\\VeeamGuestHelper.exe",
		     "?:\\Windows\\VeeamLogShipper\\VeeamLogShipper.exe",     "%Syst
		     emRoot%\\system32\\Drivers\\Crowdstrike\\*-
		     CsInstallerService.exe",
		     "\"%windir%\\AdminArsenal\\PDQInventory-
		     Scanner\\service-1\\PDQInventory-Scanner-1.exe\" "   )

NamE: Potential SYN-Based Port Scan Detected
	description: 
		     This rule identifies a potential SYN-Based port
		     scan. A SYN port scan is a technique employed by attackers to
		     scan a target network for open ports by sending SYN packets to
		     multiple ports and observing the response. Attackers use this
		     method to identify potential entry points or services that may
		     be vulnerable to exploitation, allowing them to launch targeted
		     attacks or gain unauthorized access to the system or network,
		     compromising its security and potentially leading to data
		     breaches or further malicious activities. This rule defines a
		     threshold-based approach to detect connection attempts from a
		     single source to a large number of unique destination ports,
		     while limiting the number of packets per port.
	query: 
		     event.action:network_flow and destination.port:* and
		     network.packets <= 2 and source.ip:(10.0.0.0/8 or 172.16.0.0/12
		     or 192.168.0.0/16)

NamE: UAC Bypass via ICMLuaUtil Elevated COM Interface
	description: 
		     Identifies User Account Control (UAC) bypass
		     attempts via the ICMLuaUtil Elevated COM interface. Attackers
		     may attempt to bypass UAC to stealthily execute code with
		     elevated permissions.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  process.parent.name == "dllhost.exe" and
		     process.parent.args in
		     ("/Processid:{3E5FC7F9-9A51-4367-9063-A120244FBEC7}",
		     "/Processid:{D2E7041B-2927-42FB-8E9F-7CE93B6DC937}") and
		     process.pe.original_file_name != "WerFault.exe"

NamE: UAC Bypass Attempt with IEditionUpgradeManager Elevated COM Interface
	description: 
		     Identifies attempts to bypass User Account
		     Control (UAC) by abusing an elevated COM Interface to launch a
		     rogue Windows ClipUp program. Attackers may attempt to bypass
		     UAC to stealthily execute code with elevated permissions.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and process.name : "Clipup.exe" and   not
		     process.executable : "C:\\Windows\\System32\\ClipUp.exe" and
		     process.parent.name : "dllhost.exe" and   /* CLSID of the
		     Elevated COM Interface IEditionUpgradeManager */
		     process.parent.args :
		     "/Processid:{BD54C901-076B-434E-B6C7-17C531F4AB41}"

NamE: Google Drive Ownership Transferred via Google Workspace
	description: 
		     Drive and Docs is a Google Workspace service
		     that allows users to leverage Google Drive and Google Docs.
		     Access to files is based on inherited permissions from the
		     child organizational unit the user belongs to which is scoped
		     by administrators. Typically if a user is removed, their files
		     can be transferred to another user by the administrator. This
		     service can also be abused by adversaries to transfer files to
		     an adversary account for potential exfiltration.
	query: 
		     event.dataset:"google_workspace.admin" and
		     event.action:"CREATE_DATA_TRANSFER_REQUEST"   and
		     event.category:"iam" and
		     google_workspace.admin.application.name:Drive*

NamE: AWS CloudTrail Log Updated
	description: 
		     Identifies an update to an AWS log trail setting
		     that specifies the delivery of log files.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:cloudtrail.amazonaws.com and
		     event.action:UpdateTrail and event.outcome:success

NamE: Azure Entra ID Password Spraying (Non-Interactive SFA)
	description: 
		     Identifies potential brute-force (password
		     spraying) attempts against Azure Entra ID user accounts by
		     detecting a high number of failed non-interactive single-factor
		     authentication (SFA) login attempts within a 10-minute window.
		     Attackers may attempt to brute force user accounts to gain
		     unauthorized access to Azure Entra ID services. Non-interactive
		     SFA login attempts bypass conditional-access policies (CAP) and
		     multi-factor authentication (MFA) requirements, making them a
		     high-risk vector for unauthorized access. Adversaries may
		     attempt this to identify which accounts are still valid from
		     acquired credentials via phishing, infostealers, or other
		     means.
	query: 
		     from logs-azure.signinlogs* | keep     @timestamp,
		     event.dataset,     event.category,
		     azure.signinlogs.properties.is_interactive,
		     azure.signinlogs.properties.authentication_requirement,
		     azure.signinlogs.properties.resource_display_name,
		     azure.signinlogs.properties.status.error_code,
		     azure.signinlogs.properties.resource_service_principal_id,
		     azure.signinlogs.category,     event.outcome,
		     azure.signinlogs.properties.user_principal_name,     source.ip
		     // truncate the timestamp to a 10-minute window | eval
		     target_time_window = DATE_TRUNC(10 minutes, @timestamp) | WHERE
		     event.dataset == "azure.signinlogs"   and event.category ==
		     "authentication"   and
		     azure.signinlogs.properties.is_interactive == false   and
		     azure.signinlogs.properties.authentication_requirement ==
		     "singleFactorAuthentication"   and event.outcome != "success"
		     and azure.signinlogs.properties.status.error_code in (50053,
		     50126, 50055, 50056, 50064, 50144)     // for tuning review
		     azure.signinlogs.properties.status.error_code     //
		     https://learn.microsoft.com/en-us/entra/identity-
		     platform/reference-error-codes  // count the number of unique
		     user login attempts | stats     unique_user_login_count = count
		     _distinct(azure.signinlogs.properties.resource_service_principa
		     l_id) by         target_time_window,
		     azure.signinlogs.properties.user_principal_name,
		     azure.signinlogs.properties.status.error_code  // filter for >=
		     20 failed SFA auth attempts with the same error codes | where
		     unique_user_login_count >= 20

NamE: First Occurrence of STS GetFederationToken Request by User
	description: 
		     Identifies the first occurrence of an AWS
		     Security Token Service (STS) `GetFederationToken` request made
		     by a user within the last 10 days. The `GetFederationToken` API
		     call allows users to request temporary security credentials to
		     access AWS resources. Adversaries may use this API to obtain
		     temporary credentials to access resources they would not
		     normally have access to.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: sts.amazonaws.com     and event.action:
		     GetFederationToken

NamE: Multiple Device Token Hashes for Single Okta Session
	description: 
		     This rule detects when a specific Okta actor has
		     multiple device token hashes for a single Okta session. This
		     may indicate an authenticated session has been hijacked or is
		     being used by multiple devices. Adversaries may hijack a
		     session to gain unauthorized access to Okta admin console,
		     applications, tenants, or other resources.
	query: 
		     FROM logs-okta* | WHERE     event.dataset ==
		     "okta.system"     // ignore authentication events where session
		     and device token hash change often     AND NOT event.action IN
		     (         "policy.evaluate_sign_on",
		     "user.session.start",         "user.authentication.sso"     )
		     // ignore Okta system events and only allow registered users
		     AND (         okta.actor.alternate_id != "system@okta.com"
		     AND okta.actor.alternate_id RLIKE "[^@\\s]+\\@[^@\\s]+"     )
		     AND okta.authentication_context.external_session_id !=
		     "unknown" | KEEP event.action, okta.actor.alternate_id,
		     okta.authentication_context.external_session_id,
		     okta.debug_context.debug_data.dt_hash | STATS
		     dt_hash_counts =
		     COUNT_DISTINCT(okta.debug_context.debug_data.dt_hash) BY
		     okta.actor.alternate_id,
		     okta.authentication_context.external_session_id | WHERE
		     dt_hash_counts >= 2 | SORT     dt_hash_counts DESC

NamE: AWS EC2 Instance Connect SSH Public Key Uploaded
	description: 
		     Identifies when a new SSH public key is uploaded
		     to an AWS EC2 instance using the EC2 Instance Connect service.
		     This action could indicate an adversary attempting to maintain
		     access to the instance. The rule also detects the
		     `SendSerialConsoleSSHPublicKey` or `SendSSHPublicKey` API
		     actions, which are logged when manually uploading an SSH key to
		     an EC2 instance or serial connection. It is important to know
		     that this API call happens automatically by the EC2 Instance
		     Connect service when a user connects to an EC2 instance using
		     the EC2 Instance Connect service via the CLI or AWS Management
		     Console.
	query: 
		     event.dataset: aws.cloudtrail     and event.provider:
		     ec2-instance-connect.amazonaws.com     and event.action:
		     (SendSSHPublicKey or SendSerialConsoleSSHPublicKey)     and
		     event.outcome: success

NamE: Virtual Private Network Connection Attempt
	description: 
		     Identifies the execution of macOS built-in
		     commands to connect to an existing Virtual Private Network
		     (VPN). Adversaries may use VPN connections to laterally move
		     and control remote systems on a network.
	query: 
		     process where host.os.type == "macos" and event.type
		     in ("start", "process_started") and   (     (process.name :
		     "networksetup" and process.args : "-connectpppoeservice") or
		     (process.name : "scutil" and process.args : "--nc" and
		     process.args : "start") or     (process.name : "osascript" and
		     process.command_line : "osascript*set VPN to service*")   )

NamE: Potential Privilege Escalation via Python cap_setuid
	description: 
		     This detection rule monitors for the execution
		     of a system command with setuid or setgid capabilities via
		     Python, followed by a uid or gid change to the root user. This
		     sequence of events may indicate successful privilege
		     escalation. Setuid (Set User ID) and setgid (Set Group ID) are
		     Unix-like OS features that enable processes to run with
		     elevated privileges, based on the file owner or group. Threat
		     actors can exploit these attributes to escalate privileges to
		     the privileges that are set on the binary that is being
		     executed.
	query: 
		     sequence by host.id, process.entity_id with maxspan=1s
		     [process where host.os.type == "linux" and event.type ==
		     "start" and event.action == "exec" and    process.args :
		     "import os;os.set?id(0);os.system(*)" and process.args :
		     "*python*" and user.id != "0"]   [process where host.os.type ==
		     "linux" and event.action in ("uid_change", "gid_change") and
		     event.type == "change" and    (user.id == "0" or group.id ==
		     "0")]

NamE: Process Created with an Elevated Token
	description: 
		     Identifies the creation of a process running as
		     SYSTEM and impersonating a Windows core binary privileges.
		     Adversaries may create a new process with a different token to
		     escalate privileges and bypass access controls.
	query: 
		     /* This rule is only compatible with Elastic Endpoint
		     8.4+ */  process where host.os.type == "windows" and
		     event.action == "start" and   /* CreateProcessWithToken and
		     effective parent is a privileged MS native binary used as a
		     target for token theft */  user.id : "S-1-5-18"  and   /* Token
		     Theft target process usually running as service are located in
		     one of the following paths */
		     process.Ext.effective_parent.executable :
		     ("?:\\Windows\\*.exe",                  "?:\\Program
		     Files\\*.exe",                  "?:\\Program Files
		     (x86)\\*.exe",                  "?:\\ProgramData\\*") and  /*
		     Ignores Utility Manager in Windows running in debug mode */
		     not (process.Ext.effective_parent.executable :
		     "?:\\Windows\\System32\\Utilman.exe" and
		     process.parent.executable :
		     "?:\\Windows\\System32\\Utilman.exe" and process.parent.args :
		     "/debug") and  /* Ignores Windows print spooler service with
		     correlation to Access Intelligent Form */ not
		     (process.parent.executable :
		     "?\\Windows\\System32\\spoolsv.exe" and
		     process.executable: "?:\\Program Files*\\Access\\Intelligent
		     Form\\*\\LaunchCreate.exe") and  /* Ignores Windows error
		     reporting executables */  not process.executable :
		     ("?:\\Windows\\System32\\WerFault.exe",
		     "?:\\Windows\\SysWOW64\\WerFault.exe",
		     "?:\\Windows\\System32\\WerFaultSecure.exe",
		     "?:\\Windows\\SysWOW64\\WerFaultSecure.exe",
		     "?:\\windows\\system32\\WerMgr.exe",
		     "?:\\Windows\\SoftwareDistribution\\Download\\Install\\security
		     healthsetup.exe")  and   /* Ignores Windows updates from
		     TiWorker.exe that runs with elevated privileges */  not
		     (process.parent.executable :
		     "?:\\Windows\\WinSxS\\*\\TiWorker.exe" and
		     process.executable :
		     ("?:\\Windows\\Microsoft.NET\\Framework*.exe",
		     "?:\\Windows\\WinSxS\\*.exe",
		     "?:\\Windows\\System32\\inetsrv\\iissetup.exe",
		     "?:\\Windows\\SysWOW64\\inetsrv\\iissetup.exe",
		     "?:\\Windows\\System32\\inetsrv\\aspnetca.exe",
		     "?:\\Windows\\SysWOW64\\inetsrv\\aspnetca.exe",
		     "?:\\Windows\\System32\\lodctr.exe",
		     "?:\\Windows\\SysWOW64\\lodctr.exe",
		     "?:\\Windows\\System32\\netcfg.exe",
		     "?:\\Windows\\Microsoft.NET\\Framework*\\*\\ngen.exe",
		     "?:\\Windows\\Microsoft.NET\\Framework*\\*\\aspnet_regiis.exe")
		     ) and   /* Ignores additional parent executables that run with
		     elevated privileges */  not process.parent.executable :
		     ("?:\\Windows\\System32\\AtBroker.exe",
		     "?:\\Windows\\system32\\svchost.exe",
		     "?:\\Program Files (x86)\\*.exe",                 "?:\\Program
		     Files\\*.exe",
		     "?:\\Windows\\System32\\msiexec.exe",
		     "?:\\Windows\\System32\\DriverStore\\*") and  /* Ignores
		     Windows binaries with a trusted signature and specific
		     signature name */  not (process.code_signature.trusted == true
		     and       process.code_signature.subject_name :
		     ("philandro Software GmbH",                  "Freedom
		     Scientific Inc.",                  "TeamViewer Germany GmbH",
		     "Projector.is, Inc.",                  "TeamViewer GmbH",
		     "Cisco WebEx LLC",                  "Dell Inc"))

NamE: Suspicious /proc/maps Discovery
	description: 
		     Monitors for /proc/*/maps file reads. The
		     /proc/*/maps file in Linux provides a memory map for a specific
		     process, detailing the memory segments, permissions, and what
		     files are mapped to these segments. Attackers may read a
		     process's memory map to identify memory addresses for code
		     injection or process hijacking.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action == "exec" and process.name in
		     ("cat", "grep") and process.args : "/proc/*/maps" and
		     process.entry_leader.name in (   "bash", "dash", "sh", "tcsh",
		     "csh", "zsh", "ksh", "fish" )

NamE: LSASS Process Access via Windows API
	description: 
		     Identifies access attempts to the LSASS handle,
		     which may indicate an attempt to dump credentials from LSASS
		     memory.
	query: 
		     api where host.os.type == "windows" and
		     process.Ext.api.name in ("OpenProcess", "OpenThread") and
		     Target.process.name : "lsass.exe" and    not    (
		     process.executable : (
		     "?:\\ProgramData\\GetSupportService*\\Updates\\Update_*.exe",
		     "?:\\ProgramData\\Microsoft\\Windows
		     Defender\\Platform\\*\\MsMpEng.exe",         "?:\\Program Files
		     (x86)\\Asiainfo Security\\OfficeScan Client\\NTRTScan.exe",
		     "?:\\Program Files
		     (x86)\\Blackpoint\\SnapAgent\\SnapAgent.exe",
		     "?:\\Program Files (x86)\\CheckPoint\\Endpoint
		     Security\\EFR\\EFRService.exe",         "?:\\Program Files
		     (x86)\\CyberCNSAgent\\osqueryi.exe",         "?:\\Program Files
		     (x86)\\cisco\\cisco anyconnect secure mobility
		     client\\vpnagent.exe",         "?:\\Program Files
		     (x86)\\cisco\\cisco anyconnect secure mobility
		     client\\aciseagent.exe",         "?:\\Program Files
		     (x86)\\cisco\\cisco anyconnect secure mobility
		     client\\vpndownloader.exe",         "?:\\Program Files
		     (x86)\\eScan\\reload.exe",         "?:\\Program Files
		     (x86)\\Google\\Update\\GoogleUpdate.exe",         "?:\\Program
		     Files (x86)\\Kaspersky Lab\\*\\avp.exe",         "?:\\Program
		     Files (x86)\\microsoft intune management extension\\microsoft.m
		     anagement.services.intunewindowsagent.exe",
		     "?:\\Program Files (x86)\\N-able
		     Technologies\\Reactive\\bin\\NableReactiveManagement.exe",
		     "?:\\Program Files (x86)\\N-able Technologies\\Windows
		     Agent\\bin\\agent.exe",         "?:\\Program Files
		     (x86)\\Tanium\\Tanium Client\\TaniumClient.exe",
		     "?:\\Program Files (x86)\\Trend Micro\\*\\CCSF\\TmCCSF.exe",
		     "?:\\Program Files (x86)\\Trend Micro\\Security
		     Agent\\TMASutility.exe",         "?:\\Program Files*\\Windows
		     Defender\\MsMpEng.exe",         "?:\\Program
		     Files\\Bitdefender\\Endpoint Security\\EPSecurityService.exe",
		     "?:\\Program Files\\Cisco\\AMP\\*\\sfc.exe",
		     "?:\\Program Files\\Common
		     Files\\McAfee\\AVSolution\\mcshield.exe",         "?:\\Program
		     Files\\EA\\AC\\EAAntiCheat.GameService.exe",
		     "?:\\Program Files\\Elastic\\Agent\\data\\elastic-
		     agent-*\\components\\agentbeat.exe",         "?:\\Program
		     Files\\Elastic\\Agent\\data\\elastic-
		     agent-*\\components\\metricbeat.exe",         "?:\\Program
		     Files\\Elastic\\Agent\\data\\elastic-
		     agent-*\\components\\osqueryd.exe",         "?:\\Program
		     Files\\Elastic\\Agent\\data\\elastic-
		     agent-*\\components\\packetbeat.exe",         "?:\\Program
		     Files\\ESET\\ESET Security\\ekrn.exe",         "?:\\Program
		     Files\\Fortinet\\FortiClient\\FortiProxy.exe",
		     "?:\\Program
		     Files\\Fortinet\\FortiClient\\FortiSSLVPNdaemon.exe",
		     "?:\\Program Files\\Goverlan
		     Inc\\GoverlanAgent\\GovAgentx64.exe",         "?:\\Program
		     Files\\Huntress\\HuntressAgent.exe",         "?:\\Program
		     Files\\LogicMonitor\\Agent\\bin\\sbshutdown.exe",
		     "?:\\Program Files\\Malwarebytes\\Anti-
		     Malware\\MBAMService.exe",         "?:\\Program
		     Files\\Microsoft Monitoring Agent\\Agent\\Health Service
		     State\\*\\pmfexe.exe",          "?:\\Program Files\\Microsoft
		     Security Client\\MsMpEng.exe",         "?:\\Program
		     Files\\Qualys\\QualysAgent\\QualysAgent.exe",
		     "?:\\Program
		     Files\\smart-x\\controlupagent\\version*\\cuagent.exe",
		     "?:\\Program Files\\TDAgent\\ossec-agent\\ossec-agent.exe",
		     "?:\\Program Files\\Topaz OFD\\Warsaw\\core.exe",
		     "?:\\Program Files\\Trend Micro\\Deep Security
		     Agent\\netagent\\tm_netagent.exe",         "?:\\Program
		     Files\\VMware\\VMware Tools\\vmtoolsd.exe",
		     "?:\\Program Files\\Windows Defender Advanced Threat
		     Protection\\MsSense.exe",         "?:\\Program
		     Files\\Wise\\Wise Memory Optimizer\\WiseMemoryOptimzer.exe",
		     "?:\\Windows\\AdminArsenal\\PDQDeployRunner\\*\\exec\\Sysmon64.
		     exe",         "?:\\Windows\\Sysmon.exe",
		     "?:\\Windows\\Sysmon64.exe",
		     "?:\\Windows\\System32\\csrss.exe",
		     "?:\\Windows\\System32\\MRT.exe",
		     "?:\\Windows\\System32\\msiexec.exe",
		     "?:\\Windows\\System32\\taskhostw.exe",
		     "?:\\Windows\\System32\\RtkAudUService64.exe",
		     "?:\\Windows\\System32\\wbem\\WmiPrvSE.exe",
		     "?:\\Windows\\SysWOW64\\wbem\\WmiPrvSE.exe",         "?:\\Windo
		     ws\\tenable_mw_scan_142a90001fb65e0beb1751cc8c63edd0.exe"     )
		     and not ?process.code_signature.trusted == false   )

NamE: Suspicious APT Package Manager Network Connection
	description: 
		     Detects suspicious network events executed by
		     the APT package manager, potentially indicating persistence
		     through an APT backdoor. In Linux, APT (Advanced Package Tool)
		     is a command-line utility used for handling packages on Debian-
		     based systems, providing functions for installing, updating,
		     upgrading, and removing software along with managing package
		     repositories. Attackers can backdoor APT to gain persistence by
		     injecting malicious code into scripts that APT runs, thereby
		     ensuring continued unauthorized access or control each time APT
		     is used for package management.
	query: 
		     sequence by host.id with maxspan=5s   [process where
		     host.os.type == "linux" and event.type == "start" and
		     event.action == "exec" and    process.parent.name == "apt" and
		     process.args == "-c" and process.name in (      "bash", "dash",
		     "sh", "tcsh", "csh", "zsh", "ksh", "fish"     )   ] by
		     process.entity_id   [network where host.os.type == "linux" and
		     event.action == "connection_attempted" and event.type ==
		     "start" and not (      destination.ip == null or destination.ip
		     == "0.0.0.0" or cidrmatch(      destination.ip, "10.0.0.0/8",
		     "127.0.0.0/8", "169.254.0.0/16", "172.16.0.0/12",
		     "192.0.0.0/24", "192.0.0.0/29",      "192.0.0.8/32",
		     "192.0.0.9/32", "192.0.0.10/32", "192.0.0.170/32",
		     "192.0.0.171/32", "192.0.2.0/24",      "192.31.196.0/24",
		     "192.52.193.0/24", "192.168.0.0/16", "192.88.99.0/24",
		     "224.0.0.0/4", "100.64.0.0/10",
		     "192.175.48.0/24","198.18.0.0/15", "198.51.100.0/24",
		     "203.0.113.0/24", "240.0.0.0/4", "::1", "FE80::/10",
		     "FF00::/8", "172.31.0.0/16"      )    ) and not
		     process.executable == "/usr/bin/apt-listbugs"   ] by
		     process.parent.entity_id

NamE: Suspicious Emond Child Process
	description: 
		     Identifies the execution of a suspicious child
		     process of the Event Monitor Daemon (emond). Adversaries may
		     abuse this service by writing a rule to execute commands when a
		     defined event occurs, such as system start up or user
		     authentication.
	query: 
		     process where host.os.type == "macos" and event.type
		     in ("start", "process_started") and  process.parent.name :
		     "emond" and  process.name : (    "bash",    "dash",    "sh",
		     "tcsh",    "csh",    "zsh",    "ksh",    "fish",    "Python",
		     "python*",    "perl*",    "php*",    "osascript",    "pwsh",
		     "curl",    "wget",    "cp",    "mv",    "touch",    "echo",
		     "base64",    "launchctl")

NamE: Potential Command and Control via Internet Explorer
	description: 
		     Identifies instances of Internet Explorer
		     (iexplore.exe) being started via the Component Object Model
		     (COM) making unusual network connections. Adversaries could
		     abuse Internet Explorer via COM to avoid suspicious processes
		     making network connections and bypass host-based firewall
		     restrictions.
	query: 
		     sequence by host.id, user.name with maxspan = 5s
		     [library where host.os.type == "windows" and dll.name :
		     "IEProxy.dll" and process.name : ("rundll32.exe",
		     "regsvr32.exe")]   [process where host.os.type == "windows" and
		     event.type == "start" and process.parent.name : "iexplore.exe"
		     and process.parent.args : "-Embedding"]   /* IE started via COM
		     in normal conditions makes few connections, mainly to Microsoft
		     and OCSP related domains, add FPs here */   [network where
		     host.os.type == "windows" and network.protocol == "dns" and
		     process.name : "iexplore.exe" and    not dns.question.name :
		     (     "*.microsoft.com",     "*.digicert.com",
		     "*.msocsp.com",     "*.windowsupdate.com",     "*.bing.com",
		     "*.identrust.com",     "*.sharepoint.com",
		     "*.office365.com",     "*.office.com"     )   ] /* with runs=5
		     */

NamE: Setcap setuid/setgid Capability Set
	description: 
		     This rule monitors for the addition of the
		     cap_setuid+ep or cap_setgid+ep capabilities via setcap. Setuid
		     (Set User ID) and setgid (Set Group ID) are Unix-like OS
		     features that enable processes to run with elevated privileges,
		     based on the file owner or group. Threat actors can exploit
		     these attributes to achieve persistence by creating malicious
		     binaries, allowing them to maintain control over a compromised
		     system with elevated permissions.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2") and    process.name == "setcap" and
		     process.args : "cap_set?id+ep" and not (
		     process.parent.name in ("jem", "vzctl") or     process.args
		     like "/usr/bin/new?idmap"   )

NamE: UAC Bypass via Windows Firewall Snap-In Hijack
	description: 
		     Identifies attempts to bypass User Account
		     Control (UAC) by hijacking the Microsoft Management Console
		     (MMC) Windows Firewall snap-in. Attackers bypass UAC to
		     stealthily execute code with elevated permissions.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  process.parent.name == "mmc.exe" and  /*
		     process.Ext.token.integrity_level_name == "high" can be added
		     in future for tuning */  /* args of the Windows Firewall SnapIn
		     */   process.parent.args == "WF.msc" and process.name !=
		     "WerFault.exe"

NamE: Simple HTTP Web Server Creation
	description: 
		     This rule detects the creation of a simple HTTP
		     web server using PHP or Python built-in modules. Adversaries
		     may create simple HTTP web servers to establish persistence on
		     a compromised system by uploading a reverse or command shell
		     payload to the server web root, allowing them to regain remote
		     access to the system if lost.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2") and   (     (process.name regex~
		     """php?[0-9]?\.?[0-9]{0,2}""" and process.args == "-S") or
		     (process.name like "python*" and process.args in ("--cgi",
		     "CGIHTTPServer"))   ) and not process.parent.name in
		     ("check_kmp_wrapper", "naemon")

NamE: Yum Package Manager Plugin File Creation
	description: 
		     Detects file creation events in the plugin
		     directories for the Yum package manager. In Linux, Yum
		     (Yellowdog Updater, Modified) is a command-line utility used
		     for handling packages on (by default) Fedora-based systems,
		     providing functions for installing, updating, upgrading, and
		     removing software along with managing package repositories.
		     Attackers can backdoor Yum to gain persistence by injecting
		     malicious code into plugins that Yum runs, thereby ensuring
		     continued unauthorized access or control each time Yum is used
		     for package management.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("rename", "creation") and file.path : ("/usr/lib/yum-
		     plugins/*", "/etc/yum/pluginconf.d/*") and not (
		     process.executable in (     "/bin/dockerd", "/usr/bin/dockerd",
		     "/usr/sbin/dockerd", "/bin/microdnf", "/usr/bin/microdnf",
		     "/bin/rpm",     "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd",
		     "/bin/yum", "/usr/bin/yum", "/bin/dnf", "/usr/bin/dnf",
		     "/bin/podman", "/usr/bin/podman", "/bin/dnf-automatic",
		     "/usr/bin/dnf-automatic", "/sbin/apk", "/usr/sbin/apk",
		     "/usr/local/sbin/apk", "/bin/podman", "/usr/bin/podman",
		     "/usr/bin/puppet", "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client", "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/lib/snapd/snapd", "/usr/local/bin/dockerd",
		     "/usr/libexec/netplan/generate"   ) or   process.name in
		     ("yumBackend.py", "crio") or   file.extension in ("swp",
		     "swpx", "swx") or   file.Ext.original.name like ".ansible*" or
		     file.name like ".ansible_tmp*" or   process.executable : (
		     "/nix/store/*", "/var/lib/dpkg/*", "/tmp/vmis.*", "/snap/*",
		     "/dev/fd/*", "/usr/lib/*", "/usr/libexec/*",
		     "/etc/kernel/*"   ) or   process.executable == null or
		     (process.name == "sed" and file.name : "sed*") or
		     (process.name == "perl" and file.name : "e2scrub_all.tmp*") )

NamE: Suspicious Calendar File Modification
	description: 
		     Identifies suspicious modifications of the
		     calendar file by an unusual process. Adversaries may create a
		     custom calendar notification procedure to execute a malicious
		     program at a recurring interval to establish persistence.
	query: 
		     event.category:file and host.os.type:macos and
		     event.action:modification and
		     file.path:/Users/*/Library/Calendars/*.calendar/Events/*.ics
		     and   process.executable:   (* and not     (
		     /System/Library/* or
		     /System/Applications/Calendar.app/Contents/MacOS/* or
		     /System/Applications/Mail.app/Contents/MacOS/Mail or
		     /usr/libexec/xpcproxy or       /sbin/launchd or
		     /Applications/*     )   )

NamE: Attempt to Install Root Certificate
	description: 
		     Adversaries may install a root certificate on a
		     compromised system to avoid warnings when connecting to their
		     command and control servers. Root certificates are used in
		     public key cryptography to identify a root certificate
		     authority (CA). When a root certificate is installed, the
		     system or application will trust certificates in the root's
		     chain of trust that have been signed by the root certificate.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:(start or process_started) and
		     process.name:security and process.args:"add-trusted-cert" and
		     not process.parent.executable:("/Library/Bitdefender/AVP/produc
		     t/bin/BDCoreIssues" or "/Applications/Bitdefender/SecurityNetwo
		     rkInstallerApp.app/Contents/MacOS/SecurityNetworkInstallerApp"
		     )

NamE: My First Rule
	description: 
		     This rule helps you test and practice using
		     alerts with Elastic Security as you get set up. It’s not a sign
		     of threat activity.
	query: 
		     event.kind:event

NamE: Unusual Interactive Shell Launched from System User
	description: 
		     This rule detects interactive shells launched
		     from system users. System users typically do not require
		     interactive shells, and their presence may indicate malicious
		     activity.
	query: 
		     event.category:process and host.os.type:linux and
		     event.type:start and event.action:exec and user.name:(
		     daemon or bin or sys or sync or games or man or mail or news or
		     uucp or proxy or backup or list or irc    or gnats or _apt or
		     Debian-exim or systemd-timesync or messagebus or uuidd or
		     _chrony or sshd or    gamer or shutdown or halt or dbus or
		     polkitd or rtkit or pipewire or tcpdump or clevis or
		     libstoreagemgmt or geoclue or tss or sssd or gnome-initial-
		     setup or pesign or dnsmasq or chrony ) and
		     process.interactive:true and process.parent.executable:* and
		     not (   process.parent.name:(     apt-key or apt-config or gpgv
		     or gpgconf or man-db.postinst or sendmail or rpm or nullmailer-
		     inject   ) or   process.args:(/etc/apt/trusted.gpg.d/* or
		     /tmp/apt-key-gpg*) or   process.name:(awk or apt-config or dpkg
		     or grep or gpgv or sed) or   (user.name:_apt and
		     process.name:(sqv or apt-key or gpgconf or sort or mktemp or
		     find or cmp or gpg-connect-agent)) or   (user.name:man and
		     process.name:mandb) or   (user.name:daemon and process.name:at)
		     )

NamE: Microsoft 365 Teams External Access Enabled
	description: 
		     Identifies when external access is enabled in
		     Microsoft Teams. External access lets Teams and Skype for
		     Business users communicate with other users that are outside
		     their organization. An adversary may enable external access or
		     add an allowed domain to exfiltrate data or maintain
		     persistence in an environment.
	query: 
		     event.dataset:o365.audit and
		     event.provider:(SkypeForBusiness or MicrosoftTeams) and
		     event.category:web and event.action:"Set-
		     CsTenantFederationConfiguration" and
		     o365.audit.Parameters.AllowFederatedUsers:True and
		     event.outcome:success

NamE: PowerShell PSReflect Script
	description: 
		     Detects the use of PSReflect in PowerShell
		     scripts. Attackers leverage PSReflect as a library that enables
		     PowerShell to access win32 API functions.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text:(     "New-InMemoryModule" or
		     "Add-Win32Type" or     psenum or     DefineDynamicAssembly or
		     DefineDynamicModule or     "Reflection.TypeAttributes" or
		     "Reflection.Emit.OpCodes" or
		     "Reflection.Emit.CustomAttributeBuilder" or
		     "Runtime.InteropServices.DllImportAttribute"   ) and   not
		     user.id : "S-1-5-18"

NamE: Suspicious Lsass Process Access
	description: 
		     Identifies access attempts to LSASS handle, this
		     may indicate an attempt to dump credentials from Lsass memory.
	query: 
		     process where host.os.type == "windows" and event.code
		     == "10" and   winlog.event_data.TargetImage :
		     "?:\\WINDOWS\\system32\\lsass.exe" and   not
		     winlog.event_data.GrantedAccess :                 ("0x1000",
		     "0x1400", "0x101400", "0x101000", "0x101001", "0x100000",
		     "0x100040", "0x3200", "0x40", "0x3200") and   not process.name
		     : ("procexp64.exe", "procmon.exe", "procexp.exe",
		     "Microsoft.Identity.AadConnect.Health.AadSync.Host.ex") and
		     not process.executable : (
		     "?:\\ProgramData\\Microsoft\\Windows Defender\\platform\\*",
		     "?:\\ProgramData\\WebEx\\webex\\*",         "?:\\Program Files
		     (x86)\\*",         "?:\\Program Files\\*",
		     "?:\\Windows\\CCM\\CcmExec.exe",
		     "?:\\Windows\\LTSvc\\LTSVC.exe",
		     "?:\\Windows\\Sysmon.exe",         "?:\\Windows\\Sysmon64.exe",
		     "C:\\Windows\\CynetMS.exe",
		     "?:\\Windows\\system32\\csrss.exe",
		     "?:\\Windows\\System32\\lsm.exe",
		     "?:\\Windows\\system32\\MRT.exe",
		     "?:\\Windows\\System32\\msiexec.exe",
		     "?:\\Windows\\system32\\wbem\\wmiprvse.exe",
		     "?:\\Windows\\system32\\wininit.exe",
		     "?:\\Windows\\SystemTemp\\GUM*.tmp\\GoogleUpdate.exe",
		     "?:\\Windows\\sysWOW64\\wbem\\wmiprvse.exe",
		     "C:\\oracle\\64\\02\\instantclient_19_13\\sqlplus.exe",
		     "C:\\oracle\\64\\02\\instantclient_19_13\\sqlldr.exe",
		     "d:\\oracle\\product\\19\\dbhome1\\bin\\ORACLE.EXE",
		     "C:\\wamp\\bin\\apache\\apache*\\bin\\httpd.exe",
		     "C:\\Windows\\system32\\netstat.exe",
		     "C:\\PROGRA~1\\INFORM~1\\apps\\jdk\\*\\jre\\bin\\java.exe",
		     "C:\\PROGRA~2\\CyberCNSAgentV2\\osqueryi.exe",
		     "C:\\Utilityw2k19\\packetbeat\\packetbeat.exe",
		     "C:\\ProgramData\\Cisco\\Cisco AnyConnect Secure Mobility
		     Client\\Temp\\CloudUpdate\\vpndownloader.exe",
		     "C:\\ProgramData\\Cisco\\Cisco Secure
		     Client\\Temp\\CloudUpdate\\vpndownloader.exe"   ) and   not
		     winlog.event_data.CallTrace : ("*mpengine.dll*",
		     "*appresolver.dll*", "*sysmain.dll*")

NamE: Okta ThreatInsight Threat Suspected Promotion
	description: 
		     Okta ThreatInsight is a feature that provides
		     valuable debug data regarding authentication and authorization
		     processes, which is logged in the system. Within this data,
		     there is a specific field called threat_suspected, which
		     represents Okta's internal evaluation of the authentication or
		     authorization workflow. When this field is set to True, it
		     suggests the presence of potential credential access
		     techniques, such as password-spraying, brute-forcing, replay
		     attacks, and other similar threats.
	query: 
		     event.dataset:okta.system and
		     (event.action:security.threat.detected or
		     okta.debug_context.debug_data.threat_suspected: true)

NamE: GCP Virtual Private Cloud Route Creation
	description: 
		     Identifies when a virtual private cloud (VPC)
		     route is created in Google Cloud Platform (GCP). Google Cloud
		     routes define the paths that network traffic takes from a
		     virtual machine (VM) instance to other destinations. These
		     destinations can be inside a Google VPC network or outside it.
		     An adversary may create a route in order to impact the flow of
		     network traffic in their target's cloud environment.
	query: 
		     event.dataset:gcp.audit and
		     event.action:(v*.compute.routes.insert or
		     "beta.compute.routes.insert")

NamE: Suspicious Usage of bpf_probe_write_user Helper
	description: 
		     This rule monitors the syslog log file for
		     messages related to instances of a program using the
		     `bpf_probe_write_user` helper. The `bpf_probe_write_user`
		     helper is used to write data to user space from a BPF program.
		     Unauthorized use of this helper can be indicative of an eBPF
		     rootkit or other malicious activity.
	query: 
		     host.os.type:linux and event.dataset:"system.syslog"
		     and process.name:kernel and message:"bpf_probe_write_user"

NamE: Azure Kubernetes Rolebindings Created
	description: 
		     Identifies the creation of role binding or
		     cluster role bindings. You can assign these roles to Kubernetes
		     subjects (users, groups, or service accounts) with role
		     bindings and cluster role bindings. An adversary who has
		     permissions to create bindings and cluster-bindings in the
		     cluster can create a binding to the cluster-admin ClusterRole
		     or to other high privileges roles.
	query: 
		     event.dataset:azure.activitylogs and
		     azure.activitylogs.operation_name:         ("MICROSOFT.KUBERNET
		     ES/CONNECTEDCLUSTERS/RBAC.AUTHORIZATION.K8S.IO/ROLEBINDINGS/WRI
		     TE" or          "MICROSOFT.KUBERNETES/CONNECTEDCLUSTERS/RBAC.AU
		     THORIZATION.K8S.IO/CLUSTERROLEBINDINGS/WRITE") and
		     event.outcome:(Success or success)

NamE: Deprecated - Container Workload Protection
	description: 
		     Generates a detection alert each time a
		     'Container Workload Protection' alert is received. Enabling
		     this rule allows you to immediately begin triaging and
		     investigating these alerts.
	query: 
		     event.kind:alert and event.module:cloud_defend

NamE: Exchange Mailbox Export via PowerShell
	description: 
		     Identifies the use of the Exchange PowerShell
		     cmdlet, New-MailBoxExportRequest, to export the contents of a
		     primary mailbox or archive to a .pst file. Adversaries may
		     target user email to collect sensitive information.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : "New-MailboxExportRequest"

NamE: VNC (Virtual Network Computing) from the Internet
	description: 
		     This rule detects network events that may
		     indicate the use of VNC traffic from the Internet. VNC is
		     commonly used by system administrators to remotely control a
		     system for maintenance or to use shared resources. It should
		     almost never be directly exposed to the Internet, as it is
		     frequently targeted and exploited by threat actors as an
		     initial access or backdoor vector.
	query: 
		     (event.dataset: network_traffic.flow or
		     (event.category: (network or network_traffic))) and
		     network.transport:tcp and destination.port >= 5800 and
		     destination.port <= 5810 and   not source.ip:(     10.0.0.0/8
		     or     127.0.0.0/8 or     169.254.0.0/16 or     172.16.0.0/12
		     or     192.0.0.0/24 or     192.0.0.0/29 or     192.0.0.8/32 or
		     192.0.0.9/32 or     192.0.0.10/32 or     192.0.0.170/32 or
		     192.0.0.171/32 or     192.0.2.0/24 or     192.31.196.0/24 or
		     192.52.193.0/24 or     192.168.0.0/16 or     192.88.99.0/24 or
		     224.0.0.0/4 or     100.64.0.0/10 or     192.175.48.0/24 or
		     198.18.0.0/15 or     198.51.100.0/24 or     203.0.113.0/24 or
		     240.0.0.0/4 or     "::1" or     "FE80::/10" or     "FF00::/8"
		     ) and   destination.ip:(     10.0.0.0/8 or     172.16.0.0/12 or
		     192.168.0.0/16   )

NamE: Microsoft Windows Defender Tampering
	description: 
		     Identifies when one or more features on
		     Microsoft Defender are disabled. Adversaries may disable or
		     tamper with Microsoft Defender features to evade detection and
		     conceal malicious behavior.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and process.executable != null and   (
		     (       registry.value : (         "PUAProtection",
		     "DisallowExploitProtectionOverride", "TamperProtection",
		     "EnableControlledFolderAccess",         "SpynetReporting",
		     "SubmitSamplesConsent"       ) and registry.data.strings :
		     ("0", "0x00000000")     ) or     (       registry.path : (
		     "DisableAntiSpyware", "DisableRealtimeMonitoring",
		     "DisableIntrusionPreventionSystem", "DisableScriptScanning",
		     "DisableIOAVProtection", "DisableEnhancedNotifications",
		     "DisableBlockAtFirstSeen", "DisableBehaviorMonitoring"       )
		     and registry.data.strings : ("1", "0x00000001")     )   ) and
		     not process.executable : (
		     "?:\\Windows\\system32\\svchost.exe",
		     "?:\\Windows\\CCM\\CcmExec.exe",
		     "?:\\Windows\\System32\\DeviceEnroller.exe",      "?:\\Program
		     Files (x86)\\Trend Micro\\Security Agent\\tmuninst.exe"   )  /*
		     Full registry key paths omitted due to data source variations:
		     "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows
		     Defender\\DisableAntiSpyware"
		     "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-
		     Time Protection\\DisableRealtimeMonitoring"
		     "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-
		     Time Protection\\DisableIntrusionPreventionSystem"
		     "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-
		     Time Protection\\DisableScriptScanning"
		     "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-
		     Time Protection\\DisableIOAVProtection"
		     "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows
		     Defender\\Reporting\\DisableEnhancedNotifications"
		     "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows
		     Defender\\SpyNet\\DisableBlockAtFirstSeen"
		     "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Real-
		     Time Protection\\DisableBehaviorMonitoring"
		     "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows
		     Defender\\PUAProtection"
		     "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender Security
		     Center\\App and Browser
		     protection\\DisallowExploitProtectionOverride"
		     "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows
		     Defender\\Features\\TamperProtection"
		     "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Windows
		     Defender Exploit Guard\\Controlled Folder
		     Access\\EnableControlledFolderAccess"
		     "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows
		     Defender\\SpyNet\\SpynetReporting"
		     "HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows
		     Defender\\SpyNet\\SubmitSamplesConsent" */

NamE: Suspicious Web Browser Sensitive File Access
	description: 
		     Identifies the access or file open of web
		     browser sensitive files by an untrusted/unsigned process or
		     osascript. Adversaries may acquire credentials from web
		     browsers by reading files specific to the target browser.
	query: 
		     file where event.action == "open" and host.os.type ==
		     "macos" and process.executable != null and  file.name :
		     ("cookies.sqlite",               "key?.db",
		     "logins.json",               "Cookies",
		     "Cookies.binarycookies",               "Login Data") and
		     ((process.code_signature.trusted == false or
		     process.code_signature.exists == false) or process.name :
		     "osascript") and  not process.code_signature.signing_id :
		     "org.mozilla.firefox" and  not Effective_process.executable :
		     "/Library/Elastic/Endpoint/elastic-
		     endpoint.app/Contents/MacOS/elastic-endpoint"

NamE: Screensaver Plist File Modified by Unexpected Process
	description: 
		     Identifies when a screensaver plist file is
		     modified by an unexpected process. An adversary can maintain
		     persistence on a macOS endpoint by creating a malicious
		     screensaver (.saver) file and configuring the screensaver plist
		     file to execute code each time the screensaver is activated.
	query: 
		     file where host.os.type == "macos" and event.type !=
		     "deletion" and   file.name: "com.apple.screensaver.*.plist" and
		     file.path : (       "/Users/*/Library/Preferences/ByHost/*",
		     "/Library/Managed Preferences/*",
		     "/System/Library/Preferences/*"       ) and   (
		     process.code_signature.trusted == false or
		     process.code_signature.exists == false or      /* common script
		     interpreters and abused native macOS bins */     process.name :
		     (       "curl",       "mktemp",       "tail",       "funzip",
		     "python*",       "osascript",       "perl"       )    ) and
		     /* Filter OS processes modifying screensaver plist files */
		     not process.executable : (     "/usr/sbin/cfprefsd",
		     "/usr/libexec/xpcproxy",     "/System/Library/CoreServices/Mana
		     gedClient.app/Contents/Resources/MCXCompositor",     "/System/L
		     ibrary/CoreServices/ManagedClient.app/Contents/MacOS/ManagedCli
		     ent"     )

NamE: Web Server Spawned via Python
	description: 
		     This rule identifies when a web server is
		     spawned via Python. Attackers may use Python to spawn a web
		     server to exfiltrate/infiltrate data or to move laterally
		     within a network.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2") and   (     (process.name like
		     "python*" and process.args in ("http.server",
		     "SimpleHTTPServer")) or     (       process.name in ("bash",
		     "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish") and
		     process.command_line like~ "*python* -m http.server*"     )   )

NamE: Linux User Added to Privileged Group
	description: 
		     Identifies attempts to add a user to a
		     privileged group. Attackers may add users to a privileged group
		     in order to establish persistence on a system.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2", "executed", "process_started") and
		     process.args in (     "root", "admin", "wheel", "staff",
		     "sudo","disk", "video", "shadow", "lxc", "lxd"   ) and   (
		     process.name in ("usermod", "adduser") or     (process.name ==
		     "gpasswd" and process.args in ("-a", "--add", "-M", "--
		     members"))   )

NamE: AWS Service Quotas Multi-Region `GetServiceQuota` Requests
	description: 
		     Identifies when a single AWS resource is making
		     `GetServiceQuota` API calls for the EC2 service quota
		     L-1216C47A in more than 10 regions within a 30-second window.
		     Quota code L-1216C47A represents on-demand instances which are
		     used by adversaries to deploy malware and mine cryptocurrency.
		     This could indicate a potential threat actor attempting to
		     discover the AWS infrastructure across multiple regions using
		     compromised credentials or a compromised instance.
	query: 
		     from logs-aws.cloudtrail-*  // filter for
		     GetServiceQuota API calls | where event.dataset ==
		     "aws.cloudtrail" and event.provider ==
		     "servicequotas.amazonaws.com" and event.action ==
		     "GetServiceQuota"  // truncate the timestamp to a 30-second
		     window | eval target_time_window = DATE_TRUNC(30 seconds,
		     @timestamp)  // pre-process the request parameters to extract
		     the service code and quota code | dissect
		     aws.cloudtrail.request_parameters
		     "{%{?service_code_key}=%{service_code},
		     %{?quota_code_key}=%{quota_code}}"  // filter for EC2 service
		     quota L-1216C47A (vCPU on-demand instances) | where
		     service_code == "ec2" and quota_code == "L-1216C47A"  // keep
		     only the relevant fields | keep target_time_window,
		     aws.cloudtrail.user_identity.arn, cloud.region, service_code,
		     quota_code  // count the number of unique regions and total API
		     calls within the 30-second window | stats region_count =
		     count_distinct(cloud.region), window_count = count(*) by
		     target_time_window, aws.cloudtrail.user_identity.arn  // filter
		     for resources making DescribeInstances API calls in more than
		     10 regions within the 30-second window | where region_count >=
		     10 and window_count >= 10  // sort the results by time windows
		     in descending order | sort target_time_window desc

NamE: Potential Active Directory Replication Account Backdoor
	description: 
		     Identifies the modification of the
		     nTSecurityDescriptor attribute in a domain object with rights
		     related to DCSync to a user/computer account. Attackers can use
		     this backdoor to re-obtain access to hashes of any
		     user/computer.
	query: 
		     event.code:"5136" and   winlog.event_data.AttributeLDA
		     PDisplayName:"nTSecurityDescriptor" and
		     winlog.event_data.AttributeValue : (     (
		     *1131f6ad-9c07-11d1-f79f-00c04fc2dcd2;;S-1-5-21-* and
		     *1131f6aa-9c07-11d1-f79f-00c04fc2dcd2;;S-1-5-21-* and
		     *89e95b76-444d-4c62-991a-0facbeda640c;;S-1-5-21-*     )   )

NamE: AWS IAM SAML Provider Updated
	description: 
		     Identifies when a user has updated a SAML
		     provider in AWS. SAML providers are used to enable federated
		     access to the AWS Management Console. This activity could be an
		     indication of an attacker attempting to escalate privileges.
	query: 
		     event.dataset:aws.cloudtrail     and event.provider:
		     iam.amazonaws.com     and event.action: UpdateSAMLProvider
		     and event.outcome:success

NamE: Enumeration of Privileged Local Groups Membership
	description: 
		     Identifies instances of an unusual process
		     enumerating built-in Windows privileged local groups membership
		     like Administrators or Remote Desktop users.
	query: 
		     host.os.type:windows and event.category:iam and
		     event.action:user-member-enumerated and    (
		     group.name:(*Admin* or "RemoteDesktopUsers") or
		     winlog.event_data.TargetSid:("S-1-5-32-544" or "S-1-5-32-555")
		     ) and    not (     winlog.event_data.SubjectUserName: *$ or
		     winlog.event_data.SubjectUserSid: ("S-1-5-19" or "S-1-5-20") or
		     winlog.event_data.CallerProcessName:("-" or
		     C\:\\Windows\\System32\\VSSVC.exe or
		     C\:\\Windows\\System32\\SearchIndexer.exe or
		     C\:\\Windows\\System32\\CompatTelRunner.exe or
		     C\:\\Windows\\System32\\oobe\\msoobe.exe or
		     C\:\\Windows\\System32\\net1.exe or
		     C\:\\Windows\\System32\\svchost.exe or
		     C\:\\Windows\\System32\\Netplwiz.exe or
		     C\:\\Windows\\System32\\msiexec.exe or
		     C\:\\Windows\\System32\\CloudExperienceHostBroker.exe or
		     C\:\\Windows\\System32\\RuntimeBroker.exe or
		     C\:\\Windows\\System32\\wbem\\WmiPrvSE.exe or
		     C\:\\Windows\\System32\\SrTasks.exe or
		     C\:\\Windows\\System32\\diskshadow.exe or
		     C\:\\Windows\\System32\\dfsrs.exe or
		     C\:\\Windows\\System32\\vssadmin.exe or
		     C\:\\Windows\\System32\\dllhost.exe or
		     C\:\\Windows\\System32\\mmc.exe or
		     C\:\\Windows\\System32\\SettingSyncHost.exe or
		     C\:\\Windows\\System32\\inetsrv\\w3wp.exe or
		     C\:\\Windows\\System32\\wsmprovhost.exe or
		     C\:\\Windows\\System32\\mstsc.exe or
		     C\:\\Windows\\System32\\esentutl.exe or
		     C\:\\Windows\\System32\\RecoveryDrive.exe or
		     C\:\\Windows\\System32\\SystemPropertiesComputerName.exe or
		     C\:\\Windows\\SysWOW64\\msiexec.exe or
		     C\:\\Windows\\System32\\taskhostw.exe or
		     C\:\\Windows\\ImmersiveControlPanel\\SystemSettings.exe or
		     C\:\\Windows\\Temp\\rubrik_vmware*\\snaptool.exe or
		     C\:\\Windows\\VeeamVssSupport\\VeeamGuestHelper.exe or
		     C\:\\WindowsAzure\\*WaAppAgent.exe or
		     C\:\\$WINDOWS.~BT\\Sources\\*.exe
		     )   )

NamE: Microsoft 365 Unusual Volume of File Deletion
	description: 
		     Identifies that a user has deleted an unusually
		     large volume of files as reported by Microsoft Cloud App
		     Security.
	query: 
		     event.dataset:o365.audit and
		     event.provider:SecurityComplianceCenter and event.category:web
		     and event.action:"Unusual volume of file deletion" and
		     event.outcome:success

NamE: New User Added To GitHub Organization
	description: 
		     A new user was added to a GitHub organization.
	query: 
		     configuration where event.dataset == "github.audit"
		     and event.action == "org.add_member"

NamE: Linux Group Creation
	description: 
		     Identifies attempts to create a new group.
		     Attackers may create new groups to establish persistence on a
		     system.
	query: 
		     iam where host.os.type == "linux" and (event.type ==
		     "group" and event.type == "creation") and process.name in
		     ("groupadd", "addgroup") and group.name != null

NamE: Ingress Transfer via Windows BITS
	description: 
		     Identifies downloads of executable and archive
		     files via the Windows Background Intelligent Transfer Service
		     (BITS). Adversaries could leverage Windows BITS transfer jobs
		     to download remote payloads.
	query: 
		     file where host.os.type == "windows" and event.action
		     == "rename" and   process.name : "svchost.exe" and
		     file.Ext.original.name : "BIT*.tmp" and    (file.extension :
		     ("exe", "zip", "rar", "bat", "dll", "ps1", "vbs", "wsh", "js",
		     "vbe", "pif", "scr", "cmd", "cpl") or    file.Ext.header_bytes
		     : "4d5a*") and      /* noisy paths, for hunting purposes you
		     can use the same query without the following exclusions */
		     not file.path : ("?:\\Program Files\\*", "?:\\Program Files
		     (x86)\\*", "?:\\Windows\\*", "?:\\ProgramData\\*\\*") and
		     /* lot of third party SW use BITS to download executables with
		     a long file name */   not length(file.name) > 30 and   not
		     file.path : (
		     "?:\\Users\\*\\AppData\\Local\\Temp*\\wct*.tmp",         "?:\\U
		     sers\\*\\AppData\\Local\\Adobe\\ARM\\*\\RdrServicesUpdater*.exe
		     ",         "?:\\Users\\*\\AppData\\Local\\Adobe\\ARM\\*\\AcroSe
		     rvicesUpdater*.exe",
		     "?:\\Users\\*\\AppData\\Local\\Docker Desktop
		     Installer\\update-*.exe"   )

NamE: Netcat Listener Established via rlwrap
	description: 
		     Monitors for the execution of a netcat listener
		     via rlwrap. rlwrap is a 'readline wrapper', a small utility
		     that uses the GNU Readline library to allow the editing of
		     keyboard input for any command. This utility can be used in
		     conjunction with netcat to gain a more stable reverse shell.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2") and   process.name == "rlwrap" and
		     process.args in ("nc", "ncat", "netcat", "nc.openbsd", "socat")
		     and   process.args : "*l*" and process.args_count >= 4

NamE: Mshta Making Network Connections
	description: 
		     Identifies Mshta.exe making outbound network
		     connections. This may indicate adversarial activity, as Mshta
		     is often leveraged by adversaries to execute malicious scripts
		     and evade detection.
	query: 
		     sequence by process.entity_id with maxspan=10m
		     [process where host.os.type == "windows" and event.type ==
		     "start" and process.name : "mshta.exe" and      not
		     process.parent.name : "Microsoft.ConfigurationManagement.exe"
		     and      not (process.parent.executable : "C:\\Amazon\\Amazon
		     Assistant\\amazonAssistantService.exe" or
		     process.parent.executable : "C:\\TeamViewer\\TeamViewer.exe")
		     and      not process.args : "ADSelfService_Enroll.hta"]
		     [network where host.os.type == "windows" and process.name :
		     "mshta.exe"]

NamE: Connection to Commonly Abused Free SSL Certificate Providers
	description: 
		     Identifies unusual processes connecting to
		     domains using known free SSL certificates. Adversaries may
		     employ a known encryption algorithm to conceal command and
		     control traffic.
	query: 
		     network where host.os.type == "windows" and
		     network.protocol == "dns" and   /* Add new free SSL certificate
		     provider domains here */   dns.question.name :
		     ("*letsencrypt.org", "*.sslforfree.com", "*.zerossl.com",
		     "*.freessl.org") and    /* Native Windows process paths that
		     are unlikely to have network connections to domains secured
		     using free SSL certificates */   process.executable :
		     ("C:\\Windows\\System32\\*.exe",
		     "C:\\Windows\\System\\*.exe",
		     "C:\\Windows\\SysWOW64\\*.exe",
		     "C:\\Windows\\Microsoft.NET\\Framework*\\*.exe",
		     "C:\\Windows\\explorer.exe",
		     "C:\\Windows\\notepad.exe") and    /* Insert noisy false
		     positives here */   not process.name : ("svchost.exe",
		     "MicrosoftEdge*.exe", "msedge.exe")

NamE: O365 Email Reported by User as Malware or Phish
	description: 
		     Detects the occurrence of emails reported as
		     Phishing or Malware by Users. Security Awareness training is
		     essential to stay ahead of scammers and threat actors, as
		     security products can be bypassed, and the user can still
		     receive a malicious message. Educating users to report
		     suspicious messages can help identify gaps in security controls
		     and prevent malware infections and Business Email Compromise
		     attacks.
	query: 
		     event.dataset:o365.audit and
		     event.provider:SecurityComplianceCenter and
		     event.action:AlertTriggered and rule.name:"Email reported by
		     user as malware or phish"

NamE: Deprecated - Suspicious Interactive Shell Spawned From Inside A Container
	description: 
		     This rule detects when an interactive shell is
		     spawned inside a running container. This could indicate a
		     potential container breakout attempt or an attacker's attempt
		     to gain unauthorized access to the underlying host.
	query: 
		     process where container.id: "*" and event.type==
		     "start" and  /*D4C consolidates closely spawned event.actions,
		     this excludes end actions to only capture ongoing processes*/
		     event.action in ("fork", "exec") and
		     process.entry_leader.same_as_process== false and (
		     (process.executable: "*/*sh" and process.args: ("-i", "-it"))
		     or process.args: "*/*sh" )

NamE: Suspicious Inter-Process Communication via Outlook
	description: 
		     Detects Inter-Process Communication with Outlook
		     via Component Object Model from an unusual process. Adversaries
		     may target user email to collect sensitive information or send
		     email on their behalf via API.
	query: 
		     sequence with maxspan=1m [process where host.os.type
		     == "windows" and event.action == "start" and   (
		     process.name : (       "rundll32.exe", "mshta.exe",
		     "powershell.exe", "pwsh.exe",       "cmd.exe", "regsvr32.exe",
		     "cscript.exe", "wscript.exe"     ) or     (
		     (process.code_signature.trusted == false or
		     process.code_signature.exists == false) and
		     (process.Ext.relative_file_creation_time <= 500 or
		     process.Ext.relative_file_name_modify_time <= 500)     )   ) ]
		     by process.entity_id [process where host.os.type == "windows"
		     and event.action == "start" and process.name : "OUTLOOK.EXE"
		     and   process.Ext.effective_parent.name != null] by
		     process.Ext.effective_parent.entity_id

NamE: Security Software Discovery via Grep
	description: 
		     Identifies the use of the grep command to
		     discover known third-party macOS and Linux security tools, such
		     as Antivirus or Host Firewall details.
	query: 
		     process where event.type == "start" and process.name :
		     "grep" and user.id != "0" and  not process.parent.executable :
		     ("/Library/Application Support/*",
		     "/opt/McAfee/agent/scripts/ma") and    process.args :
		     ("Little Snitch*",           "Avast*",           "Avira*",
		     "ESET*",           "BlockBlock*",           "360Sec*",
		     "LuLu*",           "KnockKnock*",           "kav",
		     "KIS",           "RTProtectionDaemon*",           "Malware*",
		     "VShieldScanner*",           "WebProtection*",
		     "webinspectord*",           "McAfee*",           "isecespd*",
		     "macmnsvc*",           "masvc*",           "kesl*",
		     "avscan*",           "guard*",           "rtvscand*",
		     "symcfgd*",           "scmdaemon*",           "symantec*",
		     "sophos*",           "osquery*",           "elastic-endpoint*"
		     ) and    not (      (process.args : "Avast" and process.args :
		     "Passwords") or      (process.args == "osquery.conf") or
		     (process.parent.args : "/opt/McAfee/agent/scripts/ma" and
		     process.parent.args : "checkhealth") or
		     (process.command_line : (        "grep ESET Command-line
		     scanner, version %s -A2",        "grep -i McAfee Web Gateway
		     Core version:",        "grep --color=auto ESET Command-line
		     scanner, version %s -A2"        )      ) or
		     (process.parent.command_line : (        """sh -c printf
		     "command_start_%s"*; perl -pe 's/[^ -~]/\n/g' <
		     /opt/eset/esets/sbin/esets_scan | grep 'ESET Command-line
		     scanner, version %s' -A2 | tail -1; printf
		     "command_done_%s*""",        """bash -c perl -pe 's/[^
		     -~]/\n/g' < /opt/eset/esets/sbin/esets_scan | grep 'ESET
		     Command-line scanner, version %s' -A2 | tail -1"""        )
		     )     )

NamE: Network Connection Initiated by SSHD Child Process
	description: 
		     This rule identifies an egress internet
		     connection initiated by an SSH Daemon child process. This
		     behavior is indicative of the alteration of a shell
		     configuration file or other mechanism that launches a process
		     when a new SSH login occurs. Attackers can also backdoor the
		     SSH daemon to allow for persistence, call out to a C2 or to
		     steal credentials.
	query: 
		     sequence by host.id with maxspan=1s   [process where
		     host.os.type == "linux" and event.type == "start" and
		     event.action == "exec" and    process.parent.executable ==
		     "/usr/sbin/sshd"] by process.entity_id   [network where
		     host.os.type == "linux" and event.type == "start" and
		     event.action == "connection_attempted" and not (
		     destination.ip == null or destination.ip == "0.0.0.0" or
		     cidrmatch(      destination.ip, "10.0.0.0/8", "127.0.0.0/8",
		     "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24",
		     "192.0.0.0/29",      "192.0.0.8/32", "192.0.0.9/32",
		     "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32",
		     "192.0.2.0/24",      "192.31.196.0/24", "192.52.193.0/24",
		     "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4",
		     "100.64.0.0/10",      "192.175.48.0/24","198.18.0.0/15",
		     "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1",
		     "FE80::/10",      "FF00::/8", "172.31.0.0/16"      )     ) and
		     not (       process.executable in ("/bin/yum", "/usr/bin/yum")
		     or       process.name in ("login_duo", "ssh", "sshd", "sshd-
		     session")     )   ] by process.parent.entity_id

NamE: Potential Port Monitor or Print Processor Registration Abuse
	description: 
		     Identifies port monitor and print processor
		     registry modifications. Adversaries may abuse port monitor and
		     print processors to run malicious DLLs during system boot that
		     will be executed as SYSTEM for privilege escalation and/or
		     persistence, if permissions allow writing a fully-qualified
		     pathname for that DLL.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.path : (
		     "HKLM\\SYSTEM\\*ControlSet*\\Control\\Print\\Monitors\\*",
		     "HKLM\\SYSTEM\\*ControlSet*\\Control\\Print\\Environments\\Wind
		     ows*\\Print Processors\\*",       "\\REGISTRY\\MACHINE\\SYSTEM\
		     \*ControlSet*\\Control\\Print\\Monitors\\*",       "\\REGISTRY\
		     \MACHINE\\SYSTEM\\*ControlSet*\\Control\\Print\\Environments\\W
		     indows*\\Print Processors\\*"   ) and registry.data.strings :
		     "*.dll" and   /* exclude SYSTEM SID - look for changes by non-
		     SYSTEM user */   not user.id : "S-1-5-18"

NamE: Third-party Backup Files Deleted via Unexpected Process
	description: 
		     Identifies the deletion of backup files, saved
		     using third-party software, by a process outside of the backup
		     suite. Adversaries may delete Backup files to ensure that
		     recovery from a ransomware attack is less likely.
	query: 
		     file where host.os.type == "windows" and event.type ==
		     "deletion" and   (     /* Veeam Related Backup Files */     (
		     file.extension : ("VBK", "VIB", "VBM") and       not (
		     process.executable : ("?:\\Windows\\*", "?:\\Program Files\\*",
		     "?:\\Program Files (x86)\\*") and
		     (process.code_signature.trusted == true and
		     process.code_signature.subject_name : ("Veeam Software Group
		     GmbH", "Veeam Software AG"))       )     ) or     /* Veritas
		     Backup Exec Related Backup File */     (       file.extension :
		     "BKF" and         not process.executable : (
		     "?:\\Program Files\\Veritas\\Backup Exec\\*",
		     "?:\\Program Files (x86)\\Veritas\\Backup Exec\\*"         )
		     )   ) and   not (     process.name :
		     ("MSExchangeMailboxAssistants.exe",
		     "Microsoft.PowerBI.EnterpriseGateway.exe") and
		     (process.code_signature.subject_name : "Microsoft Corporation"
		     and process.code_signature.trusted == true)   ) and   not
		     file.path : (     "?:\\ProgramData\\Trend Micro\\*",
		     "?:\\Program Files (x86)\\Trend Micro\\*",
		     "?:\\$RECYCLE.BIN\\*"   )

NamE: Potential Credential Access via Memory Dump File Creation
	description: 
		     Identifies the creation or modification of a
		     medium size memory dump file which can indicate an attempt to
		     access credentials from a process memory.
	query: 
		     file where host.os.type == "windows" and event.type ==
		     "creation" and    /* MDMP header */   file.Ext.header_bytes :
		     "4d444d50*" and file.size >= 30000 and   not    (     (
		     process.name : "System" or       process.executable : (
		     "?:\\Windows\\System32\\WerFault.exe",
		     "?:\\Windows\\SysWOW64\\WerFault.exe",
		     "?:\\Windows\\System32\\Wermgr.exe",
		     "?:\\Windows\\SysWOW64\\Wermgr.exe",
		     "?:\\Windows\\System32\\WerFaultSecure.exe",
		     "?:\\Windows\\SysWOW64\\WerFaultSecure.exe",
		     "?:\\Windows\\System32\\WUDFHost.exe",
		     "C:\\Windows\\System32\\rdrleakdiag.exe",
		     "?:\\Windows\\System32\\Taskmgr.exe",
		     "?:\\Windows\\SysWOW64\\Taskmgr.exe",         "?:\\Program
		     Files\\*.exe",         "?:\\Program Files (x86)\\*.exe",
		     "?:\\Windows\\SystemApps\\*.exe",         "?:\\Users\\*\\AppDat
		     a\\Roaming\\Zoom\\bin\\zCrashReport64.exe",
		     "?:\\Windows\\CCM\\ccmdump.exe",
		     "?:\\$WINDOWS.~BT\\Sources\\SetupHost.exe"       ) and
		     process.code_signature.trusted == true     ) or     (
		     file.path : (
		     "?:\\ProgramData\\Microsoft\\Windows\\WER\\*",
		     "?:\\ProgramData\\Microsoft\\WDF\\*",
		     "?:\\ProgramData\\Alteryx\\ErrorLogs\\*",
		     "?:\\ProgramData\\Goodix\\*",         "?:\\Windows\\system32\\c
		     onfig\\systemprofile\\AppData\\Local\\CrashDumps\\*",
		     "?:\\Users\\*\\AppData\\Roaming\\Zoom\\logs\\zoomcrash*",
		     "?:\\Users\\*\\AppData\\*\\Crashpad\\*",
		     "?:\\Users\\*\\AppData\\*\\crashpaddb\\*",
		     "?:\\Users\\*\\AppData\\*\\HungReports\\*",
		     "?:\\Users\\*\\AppData\\*\\CrashDumps\\*",
		     "?:\\Users\\*\\AppData\\*\\NativeCrashReporting\\*",
		     "?:\\Program Files (x86)\\*\\Crashpad\\*",         "?:\\Program
		     Files\\*\\Crashpad\\*"       ) and
		     (process.code_signature.trusted == true or process.executable
		     == null)     )   )

NamE: Potential Linux Credential Dumping via Unshadow
	description: 
		     Identifies the execution of the unshadow utility
		     which is part of John the Ripper, a password-cracking tool on
		     the host machine. Malicious actors can use the utility to
		     retrieve the combined contents of the '/etc/shadow' and
		     '/etc/password' files. Using the combined file generated from
		     the utility, the malicious threat actors can use them as input
		     for password-cracking utilities or prepare themselves for
		     future operations by gathering credential information of the
		     victim.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2") and process.name == "unshadow" and
		     process.args_count >= 3

NamE: Unusual Persistence via Services Registry
	description: 
		     Identifies processes modifying the services
		     registry key directly, instead of through the expected Windows
		     APIs. This could be an indication of an adversary attempting to
		     stealthily persist through abnormal service creation or
		     modification of an existing service.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and   registry.value : ("ServiceDLL",
		     "ImagePath") and   registry.path : (
		     "HKLM\\SYSTEM\\ControlSet*\\Services\\*\\ServiceDLL",
		     "HKLM\\SYSTEM\\ControlSet*\\Services\\*\\ImagePath",       "\\R
		     EGISTRY\\MACHINE\\SYSTEM\\ControlSet*\\Services\\*\\ServiceDLL"
		     ,       "\\REGISTRY\\MACHINE\\SYSTEM\\ControlSet*\\Services\\*\
		     \ImagePath",
		     "MACHINE\\SYSTEM\\ControlSet*\\Services\\*\\ServiceDLL",
		     "MACHINE\\SYSTEM\\ControlSet*\\Services\\*\\ImagePath"   ) and
		     not registry.data.strings : (
		     "?:\\windows\\system32\\Drivers\\*.sys",
		     "\\SystemRoot\\System32\\drivers\\*.sys",
		     "\\??\\?:\\Windows\\system32\\Drivers\\*.SYS",
		     "\\??\\?:\\Windows\\syswow64\\*.sys",
		     "system32\\DRIVERS\\USBSTOR") and   not (process.name :
		     "procexp??.exe" and registry.data.strings :
		     "?:\\*\\procexp*.sys") and   not process.executable : (
		     "?:\\Program Files\\*.exe",       "?:\\Program Files
		     (x86)\\*.exe",       "?:\\Windows\\System32\\svchost.exe",
		     "?:\\Windows\\winsxs\\*\\TiWorker.exe",
		     "?:\\Windows\\System32\\drvinst.exe",
		     "?:\\Windows\\System32\\services.exe",
		     "?:\\Windows\\System32\\msiexec.exe",
		     "?:\\Windows\\System32\\regsvr32.exe",
		     "?:\\Windows\\System32\\WaaSMedicAgent.exe"   )

NamE: Network Connection via MsXsl
	description: 
		     Identifies msxsl.exe making a network
		     connection. This may indicate adversarial activity as msxsl.exe
		     is often leveraged by adversaries to execute malicious scripts
		     and evade detection.
	query: 
		     sequence by process.entity_id   [process where
		     host.os.type == "windows" and process.name : "msxsl.exe" and
		     event.type == "start"]   [network where host.os.type ==
		     "windows" and process.name : "msxsl.exe" and      not
		     cidrmatch(destination.ip, "10.0.0.0/8", "127.0.0.0/8",
		     "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24",
		     "192.0.0.0/29", "192.0.0.8/32", "192.0.0.9/32",
		     "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32",
		     "192.0.2.0/24", "192.31.196.0/24", "192.52.193.0/24",
		     "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4",
		     "100.64.0.0/10", "192.175.48.0/24","198.18.0.0/15",
		     "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1",
		     "FE80::/10", "FF00::/8")]

NamE: Suspicious Antimalware Scan Interface DLL
	description: 
		     Identifies the creation of the Antimalware Scan
		     Interface (AMSI) DLL in an unusual location. This may indicate
		     an attempt to bypass AMSI by loading a rogue AMSI module
		     instead of the legit one.
	query: 
		     file where host.os.type == "windows" and event.type !=
		     "deletion" and file.path != null and   file.name : ("amsi.dll",
		     "amsi") and   not file.path : (
		     "?:\\$SysReset\\CloudImage\\Package_for_RollupFix*",
		     "?:\\Windows\\system32\\amsi.dll",
		     "?:\\Windows\\Syswow64\\amsi.dll",
		     "?:\\$WINDOWS.~BT\\DUImageSandbox\\*",
		     "?:\\$WINDOWS.~BT\\NewOS\\Windows\\WinSXS\\*",
		     "?:\\$WINDOWS.~BT\\NewOS\\Windows\\servicing\\LCU\\*",
		     "?:\\$WINDOWS.~BT\\Work\\*\\*",     "?:\\$WINDOWS.~BT\\Store\\O
		     ffline\\File\\C$\\Windows\\SoftwareDistribution\\Download.bak\\
		     *",     "?:\\Windows\\CbsTemp\\*\\f\\amsi.dll",
		     "?:\\Windows\\SoftwareDistribution\\Download\\*",
		     "?:\\Windows\\WinSxS\\amd64_microsoft-antimalware-scan-
		     interface_*\\amsi.dll"   ) and   not   (     process.executable
		     : "C:\\Windows\\System32\\wbengine.exe" and     file.path : (
		     "\\Device\\HarddiskVolume??\\Windows\\system32\\amsi.dll",
		     "\\Device\\HarddiskVolume??\\Windows\\syswow64\\amsi.dll",
		     "\\Device\\HarddiskVolume??\\Windows\\WinSxS\\*\\amsi.dll",
		     "\\\\?\\Volume{*}\\Windows\\WinSxS\\*\\amsi.dll",
		     "\\\\?\\Volume{*}\\Windows\\system32\\amsi.dll",
		     "\\\\?\\Volume{*}\\Windows\\syswow64\\amsi.dll"     )   )

NamE: Suspicious System Commands Executed by Previously Unknown Executable
	description: 
		     This rule monitors for the execution of several
		     commonly used system commands executed by a previously unknown
		     executable located in commonly abused directories. An alert
		     from this rule can indicate the presence of potentially
		     malicious activity, such as the execution of unauthorized or
		     suspicious processes attempting to run malicious code.
		     Detecting and investigating such behavior can help identify and
		     mitigate potential security threats, protecting the system and
		     its data from potential compromise.
	query: 
		     host.os.type:linux and event.category:process and
		     event.action:(exec or exec_event or fork or fork_event) and
		     process.executable:(* and (   /etc/crontab or /bin/* or /boot/*
		     or /dev/shm/* or /etc/cron.*/* or /etc/init.d/* or /etc/rc*.d/*
		     or /etc/update-motd.d/* or   /home/*/.* or /tmp/* or /usr/bin/*
		     or /usr/lib/update-notifier/* or /usr/share/* or /var/tmp/* )
		     and not /tmp/go-build*) and process.args:(hostname or id or
		     ifconfig or ls or netstat or ps or pwd or route or top or
		     uptime or whoami) and not (process.name:   (apt or dnf or
		     docker or dockerd or dpkg or hostname or id or ls or netstat or
		     ps or pwd or rpm or snap or   snapd or sudo or top or uptime or
		     which or whoami or yum) or process.parent.executable:(
		     /opt/cassandra/bin/cassandra or /opt/nessus/sbin/nessusd or
		     /opt/nessus_agent/sbin/nessus-agent-module or
		     /opt/puppetlabs/puppet/bin/puppet or
		     /opt/puppetlabs/puppet/bin/ruby or /usr/libexec/platform-python
		     or /usr/local/cloudamize/bin/CCAgent or /usr/sbin/sshd or
		     /bin/* or   /etc/network/* or /opt/Elastic/* or
		     /opt/TrendMicro* or /opt/aws/* or /opt/eset/* or /opt/rapid7/*
		     or /run/containerd/* or /run/k3s/* or   /snap/* or /tmp/dpkg-
		     licenses* or /tmp/newroot/* or /usr/bin/* or /var/lib/amagent/*
		     or /var/lib/docker/* or /vz/*   ) or
		     process.executable:(/run/containerd/* or /srv/snp/docker/* or
		     /tmp/.criu*) )

NamE: ScreenConnect Server Spawning Suspicious Processes
	description: 
		     Identifies suspicious processes being spawned by
		     the ScreenConnect server process (ScreenConnect.Service.exe).
		     This activity may indicate exploitation activity or access to
		     an existing web shell backdoor.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.parent.name :
		     "ScreenConnect.Service.exe" and   (process.name : ("cmd.exe",
		     "powershell.exe", "pwsh.exe", "powershell_ise.exe", "csc.exe")
		     or   ?process.pe.original_file_name in ("cmd.exe",
		     "powershell.exe", "pwsh.dll", "powershell_ise.exe"))

NamE: SoftwareUpdate Preferences Modification
	description: 
		     Identifies changes to the SoftwareUpdate
		     preferences using the built-in defaults command. Adversaries
		     may abuse this in an attempt to disable security updates.
	query: 
		     event.category:process and host.os.type:macos and
		     event.type:(start or process_started) and
		     process.name:defaults and  process.args:(write and "-bool" and
		     (com.apple.SoftwareUpdate or
		     /Library/Preferences/com.apple.SoftwareUpdate.plist) and not
		     (TRUE or true))

NamE: Microsoft 365 Portal Login from Rare Location
	description: 
		     Detects successful Microsoft 365 portal logins
		     from rare locations. Rare locations are defined as locations
		     that are not commonly associated with the user's account. This
		     behavior may indicate an adversary attempting to access a
		     Microsoft 365 account from an unusual location or behind a VPN.
	query: 
		     event.dataset: "o365.audit"     and event.provider:
		     "AzureActiveDirectory"     and event.action: "UserLoggedIn"
		     and event.outcome: "success"     and not o365.audit.UserId:
		     "Not Available"     and o365.audit.Target.Type: ("0" or "2" or
		     "3" or "5" or "6" or "10")

NamE: Azure Entra ID Rare App ID for Principal Authentication
	description: 
		     Identifies rare Azure Entra ID apps IDs
		     requesting authentication on-behalf-of a principal user. An
		     adversary with stolen credentials may specify an Azure-managed
		     app ID to authenticate on-behalf-of a user. This is a rare
		     event and may indicate an attempt to bypass conditional access
		     policies (CAP) and multi-factor authentication (MFA)
		     requirements. The app ID specified may not be commonly used by
		     the user based on their historical sign-in activity.
	query: 
		     event.dataset: "azure.signinlogs" and event.category:
		     "authentication"     and
		     azure.signinlogs.properties.is_interactive: false     and
		     azure.signinlogs.properties.user_type: "Member"     and not
		     azure.signinlogs.properties.client_app_used: "Browser"     and
		     not source.as.organization.name: "MICROSOFT-CORP-MSN-AS-BLOCK"

NamE: AWS RDS Security Group Creation
	description: 
		     Identifies the creation of an Amazon Relational
		     Database Service (RDS) Security group.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:rds.amazonaws.com and
		     event.action:CreateDBSecurityGroup and event.outcome:success

NamE: Potential PowerShell Obfuscated Script
	description: 
		     Identifies scripts that contain patterns and
		     known methods that obfuscate PowerShell code. Attackers can use
		     obfuscation techniques to bypass PowerShell security
		     protections such as Antimalware Scan Interface (AMSI).
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (     "[string]::join" or
		     "-Join" or     "[convert]::toint16" or     "[char][int]$_" or
		     ("ConvertTo-SecureString" and "PtrToStringAuto") or
		     ".GetNetworkCredential().password" or     "-BXor" or
		     ("replace" and "char") or     "[array]::reverse" or
		     "-replace"   ) and   powershell.file.script_block_text : (
		     ("$pSHoMe[" and "+$pSHoMe[") or     ("$ShellId[" and
		     "+$ShellId[") or     ("$env:ComSpec[4" and "25]-Join") or
		     (("Set-Variable" or "SV" or "Set-Item") and "OFS") or
		     ("*MDR*" and "Name[3,11,2]") or     ("$VerbosePreference" and
		     "[1,3]+'X'-Join''") or     ("rahc" or "ekovin" or "gnirts" or
		     "ecnereferpesobrev" or "ecalper" or "cepsmoc" or "dillehs") or
		     ("System.Management.Automation.$([cHAr]" or "System.$([cHAr]"
		     or ")+[cHAR]([byte]")   )

NamE: Azure Entra Sign-in Brute Force against Microsoft 365 Accounts
	description: 
		     Identifies potential brute-force attempts
		     against Microsoft 365 user accounts by detecting a high number
		     of failed interactive or non-interactive login attempts within
		     a 30-minute window. Attackers may attempt to brute force user
		     accounts to gain unauthorized access to Microsoft 365 services
		     via different services such as Exchange, SharePoint, or Teams.
	query: 
		     from logs-azure.signinlogs* // truncate the timestamp
		     to a 30-minute window | eval target_time_window = DATE_TRUNC(30
		     minutes, @timestamp) | WHERE   event.dataset ==
		     "azure.signinlogs"   and event.category == "authentication"
		     and to_lower(azure.signinlogs.properties.resource_display_name)
		     rlike "(.*)365(.*)"   and azure.signinlogs.category in
		     ("NonInteractiveUserSignInLogs", "SignInLogs")   and
		     event.outcome != "success"   // for tuning review
		     azure.signinlogs.properties.status.error_code   //
		     https://learn.microsoft.com/en-us/entra/identity-
		     platform/reference-error-codes  // keep only relevant fields |
		     keep target_time_window, event.dataset, event.category,
		     azure.signinlogs.properties.resource_display_name,
		     azure.signinlogs.category, event.outcome,
		     azure.signinlogs.properties.user_principal_name, source.ip  //
		     count the number of login sources and failed login attempts |
		     stats   login_source_count = count(source.ip),
		     failed_login_count = count(*) by target_time_window,
		     azure.signinlogs.properties.user_principal_name  // filter for
		     users with more than 20 login sources or failed login attempts
		     | where (login_source_count >= 20 or failed_login_count >= 20)

NamE: Google Workspace Custom Gmail Route Created or Modified
	description: 
		     Detects when a custom Gmail route is added or
		     modified in Google Workspace. Adversaries can add a custom
		     e-mail route for outbound mail to route these e-mails to their
		     own inbox of choice for data gathering. This allows adversaries
		     to capture sensitive information from e-mail and potential
		     attachments, such as invoices or payment documents. By default,
		     all email from current Google Workspace users with accounts are
		     routed through a domain's mail server for inbound and outbound
		     mail.
	query: 
		     event.dataset:"google_workspace.admin" and
		     event.action:("CREATE_GMAIL_SETTING" or "CHANGE_GMAIL_SETTING")
		     and google_workspace.event.type:"EMAIL_SETTINGS" and
		     google_workspace.admin.setting.name:("EMAIL_ROUTE" or
		     "MESSAGE_SECURITY_RULE")

NamE: GCP IAM Role Deletion
	description: 
		     Identifies an Identity and Access Management
		     (IAM) role deletion in Google Cloud Platform (GCP). A role
		     contains a set of permissions that allows you to perform
		     specific actions on Google Cloud resources. An adversary may
		     delete an IAM role to inhibit access to accounts utilized by
		     legitimate users.
	query: 
		     event.dataset:gcp.audit and
		     event.action:google.iam.admin.v*.DeleteRole and
		     event.outcome:success

NamE: AWS Redshift Cluster Creation
	description: 
		     Identifies the creation of an Amazon Redshift
		     cluster. Unexpected creation of this cluster by a non-
		     administrative user may indicate a permission or role issue
		     with current users. If unexpected, the resource may not
		     properly be configured and could introduce security
		     vulnerabilities.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:redshift.amazonaws.com and
		     event.action:CreateCluster and event.outcome:success

NamE: Untrusted Driver Loaded
	description: 
		     Identifies attempt to load an untrusted driver.
		     Adversaries may modify code signing policies to enable
		     execution of unsigned or self-signed code.
	query: 
		     driver where host.os.type == "windows" and process.pid
		     == 4 and   dll.code_signature.trusted != true and    not
		     dll.code_signature.status : ("errorExpired", "errorRevoked",
		     "errorCode_endpoint:*")

NamE: Curl SOCKS Proxy Activity from Unusual Parent
	description: 
		     This rule detects the use of the `curl` command-
		     line tool with SOCKS proxy options, launched from an unusual
		     parent process. Attackers may use `curl` to establish a SOCKS
		     proxy connection to bypass network restrictions and exfiltrate
		     data or communicate with C2 servers.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action == "exec" and process.name ==
		     "curl" and (   process.parent.executable like (
		     "/dev/shm/*", "/tmp/*", "/var/tmp/*", "/var/run/*", "/root/*",
		     "/boot/*", "/var/www/html/*", "/opt/.*"   ) or
		     process.parent.name in ("bash", "dash", "sh", "tcsh", "csh",
		     "zsh", "ksh", "fish") ) and (   process.args like ("--
		     socks5-hostname", "--proxy", "--preproxy", "socks5*") or
		     process.args == "-x" or   process.env_vars like
		     ("http_proxy=socks5h://*", "HTTPS_PROXY=socks5h://*",
		     "ALL_PROXY=socks5h://*") )

NamE: Enumerating Domain Trusts via NLTEST.EXE
	description: 
		     Identifies the use of nltest.exe for domain
		     trust discovery purposes. Adversaries may use this command-line
		     utility to enumerate domain trusts and gain insight into trust
		     relationships, as well as the state of Domain Controller (DC)
		     replication in a Microsoft Windows NT Domain.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and     process.name : "nltest.exe" and process.args
		     : (         "/DCLIST:*", "/DCNAME:*", "/DSGET*",
		     "/LSAQUERYFTI:*", "/PARENTDOMAIN",         "/DOMAIN_TRUSTS",
		     "/BDC_QUERY:*"         ) and  not process.parent.name :
		     "PDQInventoryScanner.exe" and not (   user.id in ("S-1-5-18",
		     "S-1-5-19", "S-1-5-20") and   /* Don't apply the user.id
		     exclusion to Sysmon for compatibility */   not event.dataset :
		     ("windows.sysmon_operational", "windows.sysmon") )

NamE: SSH Authorized Keys File Modification
	description: 
		     The Secure Shell (SSH) authorized_keys file
		     specifies which users are allowed to log into a server using
		     public key authentication. Adversaries may modify it to
		     maintain persistence on a victim host by adding their own
		     public key(s).
	query: 
		     event.category:file and event.type:(change or
		     creation) and  file.name:("authorized_keys" or
		     "authorized_keys2" or "/etc/ssh/sshd_config" or "/root/.ssh")
		     and  not process.executable:
		     (/Library/Developer/CommandLineTools/usr/bin/git or
		     /usr/local/Cellar/maven/*/libexec/bin/mvn or               /Lib
		     rary/Java/JavaVirtualMachines/jdk*.jdk/Contents/Home/bin/java
		     or               /usr/bin/vim or
		     /usr/local/Cellar/coreutils/*/bin/gcat or
		     /usr/bin/bsdtar or               /usr/bin/nautilus or
		     /usr/bin/scp or               /usr/bin/touch or
		     /var/lib/docker/* or               /usr/bin/google_guest_agent
		     or               /opt/jc/bin/jumpcloud-agent or
		     /opt/puppetlabs/puppet/bin/puppet or
		     /usr/bin/chef-client )

NamE: First Time Seen Commonly Abused Remote Access Tool Execution
	description: 
		     Adversaries may install legitimate remote access
		     tools (RAT) to compromised endpoints for further command-and-
		     control (C2). Adversaries can rely on installed RATs for
		     persistence, execution of native commands and more. This rule
		     detects when a process is started whose name or code signature
		     resembles commonly abused RATs. This is a New Terms rule type
		     indicating the host has not seen this RAT process started
		     before within the last 30 days.
	query: 
		     host.os.type: "windows" and     event.category:
		     "process" and event.type : "start" and      (
		     process.code_signature.subject_name : (             "Action1
		     Corporation" or             "AeroAdmin LLC" or
		     "Ammyy LLC" or             "Atera Networks Ltd" or
		     "AWERAY PTE. LTD." or             "BeamYourScreen GmbH" or
		     "Bomgar Corporation" or             "DUC FABULOUS CO.,LTD" or
		     "DOMOTZ INC." or             "DWSNET OÜ" or
		     "FleetDeck Inc" or             "GlavSoft LLC" or
		     "GlavSoft LLC." or             "Hefei Pingbo Network Technology
		     Co. Ltd" or             "IDrive, Inc." or             "IMPERO
		     SOLUTIONS LIMITED" or             "Instant Housecall" or
		     "ISL Online Ltd." or             "LogMeIn, Inc." or
		     "Monitoring Client" or             "MMSOFT Design Ltd." or
		     "Nanosystems S.r.l." or             "NetSupport Ltd" or
		     "NinjaRMM, LLC" or             "Parallels International GmbH"
		     or             "philandro Software GmbH" or             "Pro
		     Softnet Corporation" or             "RealVNC" or
		     "RealVNC Limited" or             "BreakingSecurity.net" or
		     "Remote Utilities LLC" or             "Rocket Software, Inc."
		     or             "SAFIB" or             "Servably, Inc." or
		     "ShowMyPC INC" or             "Splashtop Inc." or
		     "Superops Inc." or             "TeamViewer" or
		     "TeamViewer GmbH" or             "TeamViewer Germany GmbH" or
		     "Techinline Limited" or             "uvnc bvba" or
		     "Yakhnovets Denis Aleksandrovich IP" or             "Zhou
		     Huabing"         ) or          process.name.caseless : (
		     AA_v*.exe or             "AeroAdmin.exe" or
		     "AnyDesk.exe" or             "apc_Admin.exe" or
		     "apc_host.exe" or             "AteraAgent.exe" or
		     aweray_remote*.exe or             "AweSun.exe" or
		     "B4-Service.exe" or             "BASupSrvc.exe" or
		     "bomgar-scc.exe" or             "domotzagent.exe" or
		     "domotz-windows-x64-10.exe" or             "dwagsvc.exe" or
		     "DWRCC.exe" or             "ImperoClientSVC.exe" or
		     "ImperoServerSVC.exe" or             "ISLLight.exe" or
		     "ISLLightClient.exe" or             fleetdeck_commander*.exe or
		     "getscreen.exe" or             "LMIIgnition.exe" or
		     "LogMeIn.exe" or
		     "ManageEngine_Remote_Access_Plus.exe" or             "Mikogo-
		     Service.exe" or             "NinjaRMMAgent.exe" or
		     "NinjaRMMAgenPatcher.exe" or             "ninjarmm-cli.exe" or
		     "r_server.exe" or             "radmin.exe" or
		     "radmin3.exe" or             "RCClient.exe" or
		     "RCService.exe" or             "RemoteDesktopManager.exe" or
		     "RemotePC.exe" or             "RemotePCDesktop.exe" or
		     "RemotePCService.exe" or             "rfusclient.exe" or
		     "ROMServer.exe" or             "ROMViewer.exe" or
		     "RPCSuite.exe" or             "rserver3.exe" or
		     "rustdesk.exe" or             "rutserv.exe" or
		     "rutview.exe" or             "saazapsc.exe" or
		     ScreenConnect*.exe or             "smpcview.exe" or
		     "spclink.exe" or             "Splashtop-streamer.exe" or
		     "SRService.exe" or             "strwinclt.exe" or
		     "Supremo.exe" or             "SupremoService.exe" or
		     "teamviewer.exe" or             "TiClientCore.exe" or
		     "TSClient.exe" or             "tvn.exe" or
		     "tvnserver.exe" or             "tvnviewer.exe" or
		     UltraVNC*.exe or             UltraViewer*.exe or
		     "vncserver.exe" or             "vncviewer.exe" or
		     "winvnc.exe" or             "winwvc.exe" or
		     "Zaservice.exe" or             "ZohoURS.exe"         ) or
		     process.name : (             AA_v*.exe or
		     "AeroAdmin.exe" or             "AnyDesk.exe" or
		     "apc_Admin.exe" or             "apc_host.exe" or
		     "AteraAgent.exe" or             aweray_remote*.exe or
		     "AweSun.exe" or             "B4-Service.exe" or
		     "BASupSrvc.exe" or             "bomgar-scc.exe" or
		     "domotzagent.exe" or             "domotz-windows-x64-10.exe" or
		     "dwagsvc.exe" or             "DWRCC.exe" or
		     "ImperoClientSVC.exe" or             "ImperoServerSVC.exe" or
		     "ISLLight.exe" or             "ISLLightClient.exe" or
		     fleetdeck_commander*.exe or             "getscreen.exe" or
		     "LMIIgnition.exe" or             "LogMeIn.exe" or
		     "ManageEngine_Remote_Access_Plus.exe" or             "Mikogo-
		     Service.exe" or             "NinjaRMMAgent.exe" or
		     "NinjaRMMAgenPatcher.exe" or             "ninjarmm-cli.exe" or
		     "r_server.exe" or             "radmin.exe" or
		     "radmin3.exe" or             "RCClient.exe" or
		     "RCService.exe" or             "RemoteDesktopManager.exe" or
		     "RemotePC.exe" or             "RemotePCDesktop.exe" or
		     "RemotePCService.exe" or             "rfusclient.exe" or
		     "ROMServer.exe" or             "ROMViewer.exe" or
		     "RPCSuite.exe" or             "rserver3.exe" or
		     "rustdesk.exe" or             "rutserv.exe" or
		     "rutview.exe" or             "saazapsc.exe" or
		     ScreenConnect*.exe or             "smpcview.exe" or
		     "spclink.exe" or             "Splashtop-streamer.exe" or
		     "SRService.exe" or             "strwinclt.exe" or
		     "Supremo.exe" or             "SupremoService.exe" or
		     "teamviewer.exe" or             "TiClientCore.exe" or
		     "TSClient.exe" or             "tvn.exe" or
		     "tvnserver.exe" or             "tvnviewer.exe" or
		     UltraVNC*.exe or             UltraViewer*.exe or
		     "vncserver.exe" or             "vncviewer.exe" or
		     "winvnc.exe" or             "winwvc.exe" or
		     "Zaservice.exe" or             "ZohoURS.exe"         )
		     ) and          not (process.pe.original_file_name : ("G2M.exe"
		     or "Updater.exe" or "powershell.exe") and
		     process.code_signature.subject_name : "LogMeIn, Inc.")

NamE: Execution from Unusual Directory - Command Line
	description: 
		     Identifies process execution from suspicious
		     default Windows directories. This may be abused by adversaries
		     to hide malware in trusted paths.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : ("wscript.exe",
		     "cscript.exe",                   "rundll32.exe",
		     "regsvr32.exe",                   "cmstp.exe",
		     "RegAsm.exe",                   "installutil.exe",
		     "mshta.exe",                   "RegSvcs.exe",
		     "powershell.exe",                   "pwsh.exe",
		     "cmd.exe") and    /* add suspicious execution paths here */
		     process.args : ("C:\\PerfLogs\\*",
		     "C:\\Users\\Public\\*",
		     "C:\\Windows\\Tasks\\*",                   "C:\\Intel\\*",
		     "C:\\AMD\\Temp\\*",
		     "C:\\Windows\\AppReadiness\\*",
		     "C:\\Windows\\ServiceState\\*",
		     "C:\\Windows\\security\\*",
		     "C:\\Windows\\IdentityCRL\\*",
		     "C:\\Windows\\Branding\\*",
		     "C:\\Windows\\csc\\*",
		     "C:\\Windows\\DigitalLocker\\*",
		     "C:\\Windows\\en-US\\*",
		     "C:\\Windows\\wlansvc\\*",
		     "C:\\Windows\\Prefetch\\*",
		     "C:\\Windows\\Fonts\\*",
		     "C:\\Windows\\diagnostics\\*",
		     "C:\\Windows\\TAPI\\*",
		     "C:\\Windows\\INF\\*",
		     "C:\\Windows\\System32\\Speech\\*",
		     "C:\\windows\\tracing\\*",
		     "c:\\windows\\IME\\*",
		     "c:\\Windows\\Performance\\*",
		     "c:\\windows\\intel\\*",
		     "c:\\windows\\ms\\*",
		     "C:\\Windows\\dot3svc\\*",
		     "C:\\Windows\\panther\\*",
		     "C:\\Windows\\RemotePackages\\*",
		     "C:\\Windows\\OCR\\*",
		     "C:\\Windows\\appcompat\\*",
		     "C:\\Windows\\apppatch\\*",
		     "C:\\Windows\\addins\\*",
		     "C:\\Windows\\Setup\\*",
		     "C:\\Windows\\Help\\*",
		     "C:\\Windows\\SKB\\*",                   "C:\\Windows\\Vss\\*",
		     "C:\\Windows\\servicing\\*",
		     "C:\\Windows\\CbsTemp\\*",
		     "C:\\Windows\\Logs\\*",
		     "C:\\Windows\\WaaS\\*",
		     "C:\\Windows\\twain_32\\*",
		     "C:\\Windows\\ShellExperiences\\*",
		     "C:\\Windows\\ShellComponents\\*",
		     "C:\\Windows\\PLA\\*",
		     "C:\\Windows\\Migration\\*",
		     "C:\\Windows\\debug\\*",
		     "C:\\Windows\\Cursors\\*",
		     "C:\\Windows\\Containers\\*",
		     "C:\\Windows\\Boot\\*",
		     "C:\\Windows\\bcastdvr\\*",
		     "C:\\Windows\\TextInput\\*",
		     "C:\\Windows\\security\\*",
		     "C:\\Windows\\schemas\\*",
		     "C:\\Windows\\SchCache\\*",
		     "C:\\Windows\\Resources\\*",
		     "C:\\Windows\\rescache\\*",
		     "C:\\Windows\\Provisioning\\*",
		     "C:\\Windows\\PrintDialog\\*",
		     "C:\\Windows\\PolicyDefinitions\\*",
		     "C:\\Windows\\media\\*",
		     "C:\\Windows\\Globalization\\*",
		     "C:\\Windows\\L2Schemas\\*",
		     "C:\\Windows\\LiveKernelReports\\*",
		     "C:\\Windows\\ModemLogs\\*",
		     "C:\\Windows\\ImmersiveControlPanel\\*",
		     "C:\\$Recycle.Bin\\*") and    /* noisy FP patterns */    not
		     process.parent.executable : ("C:\\WINDOWS\\System32\\DriverStor
		     e\\FileRepository\\*\\igfxCUIService*.exe",
		     "C:\\Windows\\System32\\spacedeskService.exe",
		     "C:\\Program Files\\Dell\\SupportAssistAgent\\SRE\\SRE.exe")
		     and   not (process.name : "rundll32.exe" and
		     process.args : ("uxtheme.dll,#64",
		     "PRINTUI.DLL,PrintUIEntry",                        "?:\\Windows
		     \\System32\\FirewallControlPanel.dll,ShowNotificationDialog",
		     "?:\\WINDOWS\\system32\\Speech\\SpeechUX\\sapi.cpl",
		     "?:\\Windows\\system32\\shell32.dll,OpenAs_RunDLL")) and    not
		     (process.name : "cscript.exe" and process.args :
		     "?:\\WINDOWS\\system32\\calluxxprovider.vbs") and    not
		     (process.name : "cmd.exe" and process.args :
		     "?:\\WINDOWS\\system32\\powercfg.exe" and process.args :
		     "?:\\WINDOWS\\inf\\PowerPlan.log") and    not (process.name :
		     "regsvr32.exe" and process.args :
		     "?:\\Windows\\Help\\OEM\\scripts\\checkmui.dll") and    not
		     (process.name : "cmd.exe" and        process.parent.executable
		     : ("?:\\Windows\\System32\\oobe\\windeploy.exe",
		     "?:\\Program Files (x86)\\ossec-agent\\wazuh-agent.exe",
		     "?:\\Windows\\System32\\igfxCUIService.exe",
		     "?:\\Windows\\Temp\\IE*.tmp\\IE*-support\\ienrcore.exe"))

NamE: Mounting Hidden or WebDav Remote Shares
	description: 
		     Identifies the use of net.exe to mount a WebDav
		     or hidden remote share. This may indicate lateral movement or
		     preparation for data exfiltration.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  ((process.name : "net.exe" or
		     ?process.pe.original_file_name == "net.exe") or ((process.name
		     : "net1.exe" or ?process.pe.original_file_name == "net1.exe")
		     and  not process.parent.name : "net.exe")) and  process.args :
		     "use" and  /* including hidden and webdav based online shares
		     such as onedrive  */  process.args : ("\\\\*\\*$*",
		     "\\\\*@SSL\\*", "http*") and  /* excluding shares deletion
		     operation */  not process.args : "/d*"

NamE: Agent Spoofing - Multiple Hosts Using Same Agent
	description: 
		     Detects when multiple hosts are using the same
		     agent ID. This could occur in the event of an agent being taken
		     over and used to inject illegitimate documents into an instance
		     as an attempt to spoof events in order to masquerade actual
		     activity to evade detection.
	query: 
		     event.agent_id_status:* and not tags:forwarded

NamE: Successful SSH Authentication from Unusual IP Address
	description: 
		     This rule leverages the new_terms rule type to
		     detect successful SSH authentications by an IP- address that
		     has not been authenticated in the last 10 days. This behavior
		     may indicate an attacker attempting to gain access to the
		     system using a valid account.
	query: 
		     event.category:authentication and host.os.type:linux
		     and event.action:ssh_login and event.outcome:success

NamE: AWS EC2 Instance Console Login via Assumed Role
	description: 
		     Identifies a successful console login activity
		     by an EC2 instance profile using an assumed role. This is
		     uncommon behavior and could indicate an attacker using
		     compromised credentials to further exploit an environment. An
		     EC2 instance assumes a role using their EC2 ID as the session
		     name. This rule looks for the pattern "i-" which is the
		     beginning pattern for assumed role sessions started by an EC2
		     instance and a successful `ConsoleLogin` or `GetSigninToken`
		     API call.
	query: 
		     any where event.dataset == "aws.cloudtrail"    and
		     event.provider == "signin.amazonaws.com"    and event.action in
		     ("ConsoleLogin", "GetSigninToken")    and event.outcome ==
		     "success"    and aws.cloudtrail.user_identity.type ==
		     "AssumedRole"    and stringContains (user.id, ":i-")

NamE: Inbound Connection to an Unsecure Elasticsearch Node
	description: 
		     Identifies Elasticsearch nodes that do not have
		     Transport Layer Security (TLS), and/or lack authentication, and
		     are accepting inbound network connections over the default
		     Elasticsearch port.
	query: 
		     (event.dataset: network_traffic.http OR
		     (event.category: network_traffic AND network.protocol: http))
		     AND     status:OK AND destination.port:9200 AND
		     network.direction:inbound AND NOT
		     http.response.headers.content-type:"image/x-icon" AND NOT
		     _exists_:http.request.headers.authorization

NamE: GCP Service Account Disabled
	description: 
		     Identifies when a service account is disabled in
		     Google Cloud Platform (GCP). A service account is a special
		     type of account used by an application or a virtual machine
		     (VM) instance, not a person. Applications use service accounts
		     to make authorized API calls, authorized as either the service
		     account itself, or as G Suite or Cloud Identity users through
		     domain-wide delegation. An adversary may disable a service
		     account in order to disrupt to disrupt their target's business
		     operations.
	query: 
		     event.dataset:gcp.audit and
		     event.action:google.iam.admin.v*.DisableServiceAccount and
		     event.outcome:success

NamE: External Alerts
	description: 
		     Generates a detection alert for each external
		     alert written to the configured indices. Enabling this rule
		     allows you to immediately begin investigating external alerts
		     in the app.
	query: 
		     event.kind:alert and not event.module:(endgame or
		     endpoint or cloud_defend)

NamE: AWS S3 Bucket Replicated to Another Account
	description: 
		     Identifies when the `PutBucketReplication`
		     operation is used to replicate S3 objects to a bucket in
		     another AWS account. Adversaries may use bucket replication to
		     exfiltrate sensitive data to an environment they control.
	query: 
		     any where event.dataset == "aws.cloudtrail"    and
		     event.action == "PutBucketReplication"    and event.outcome ==
		     "success"    and
		     stringContains(aws.cloudtrail.request_parameters, "Account")

NamE: O365 Mailbox Audit Logging Bypass
	description: 
		     Detects the occurrence of mailbox audit bypass
		     associations. The mailbox audit is responsible for logging
		     specified mailbox events (like accessing a folder or a message
		     or permanently deleting a message). However, actions taken by
		     some authorized accounts, such as accounts used by third-party
		     tools or accounts used for lawful monitoring, can create a
		     large number of mailbox audit log entries and may not be of
		     interest to your organization. Because of this, administrators
		     can create bypass associations, allowing certain accounts to
		     perform their tasks without being logged. Attackers can abuse
		     this allowlist mechanism to conceal actions taken, as the
		     mailbox audit will log no activity done by the account.
	query: 
		     event.dataset:o365.audit and event.provider:Exchange
		     and event.action:Set-MailboxAuditBypassAssociation and
		     event.outcome:success

NamE: Login via Unusual System User
	description: 
		     This rule identifies successful logins by system
		     users that are uncommon to authenticate. These users have
		     `nologin` set by default, and must be modified to allow SSH
		     access. Adversaries may backdoor these users to gain
		     unauthorized access to the system.
	query: 
		     authentication where host.os.type == "linux" and
		     event.action in ("ssh_login", "user_login") and user.name in (
		     "deamon", "bin", "sys", "games", "man", "lp", "mail", "news",
		     "uucp", "proxy", "www-data", "backup",   "list", "irc",
		     "gnats", "nobody", "systemd-timesync", "systemd-network",
		     "systemd-resolve", "messagebus",   "avahi", "sshd", "dnsmasq" )
		     and event.outcome == "success"

NamE: Ransomware - Detected - Elastic Defend
	description: 
		     Generates a detection alert each time an Elastic
		     Defend alert for ransomware are received. Enabling this rule
		     allows you to immediately begin investigating your Endpoint
		     ransomware alerts. This rule identifies Elastic Defend
		     ransomware detections only, and does not include prevention
		     alerts.
	query: 
		     event.kind : alert and event.code : ransomware and
		     (event.type : allowed or (event.type: denied and event.outcome:
		     failure))

NamE: Behavior - Prevented - Elastic Defend
	description: 
		     Generates a detection alert each time an Elastic
		     Defend alert for malicious behavior is received. Enabling this
		     rule allows you to immediately begin investigating your
		     Endpoint behavior alerts. This rule identifies Elastic Defend
		     behavior preventions only, and does not include detection only
		     alerts.
	query: 
		     event.kind : alert and event.code : behavior and
		     event.type : denied and event.outcome : success

NamE: Ransomware - Prevented - Elastic Defend
	description: 
		     Generates a detection alert each time an Elastic
		     Defend alert for ransomware are received. Enabling this rule
		     allows you to immediately begin investigating your Endpoint
		     ransomware alerts. This rule identifies Elastic Defend
		     ransomware preventions only, and does not include detection
		     only alerts.
	query: 
		     event.kind : alert and event.code : ransomware and
		     event.type : denied and event.outcome : success

NamE: Creation of SettingContent-ms Files
	description: 
		     Identifies the suspicious creation of
		     SettingContents-ms files, which have been used in attacks to
		     achieve code execution while evading defenses.
	query: 
		     file where host.os.type == "windows" and event.type ==
		     "creation" and   file.extension : "settingcontent-ms" and   not
		     file.path : (     "?:\\*\\AppData\\Local\\Packages\\windows.imm
		     ersivecontrolpanel_*\\LocalState\\Indexed\\Settings\\*",
		     "\\Device\\HarddiskVolume*\\Windows\\WinSxS\\amd64_microsoft-
		     windows-s..*\\*.settingcontent-ms"   )

NamE: Emond Rules Creation or Modification
	description: 
		     Identifies the creation or modification of the
		     Event Monitor Daemon (emond) rules. Adversaries may abuse this
		     service by writing a rule to execute commands when a defined
		     event occurs, such as system start up or user authentication.
	query: 
		     file where host.os.type == "macos" and event.type !=
		     "deletion" and  file.path :
		     ("/private/etc/emond.d/rules/*.plist",
		     "/etc/emon.d/rules/*.plist", "/private/var/db/emondClients/*")

NamE: Suspicious Kworker UID Elevation
	description: 
		     Monitors for the elevation of regular user
		     permissions to root permissions through the kworker process.
		     kworker, or kernel worker, processes are part of the kernel's
		     workqueue mechanism. They are responsible for executing work
		     that has been scheduled to be done in kernel space, which might
		     include tasks like handling interrupts, background activities,
		     and other kernel-related tasks. Attackers may attempt to evade
		     detection by masquerading as a kernel worker process, and
		     hijack the execution flow by hooking certain functions/syscalls
		     through a rootkit in order to provide easy access to root via a
		     special modified command.
	query: 
		     process where host.os.type == "linux" and event.action
		     == "session_id_change" and process.name : "kworker*" and
		     user.id == "0"

NamE: Sudo Command Enumeration Detected
	description: 
		     This rule monitors for the usage of the sudo -l
		     command, which is used to list the allowed and forbidden
		     commands for the invoking user. Attackers may execute this
		     command to enumerate commands allowed to be executed with sudo
		     permissions, potentially allowing to escalate privileges to
		     root.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "ProcessRollup2") and process.name == "sudo" and
		     process.args == "-l" and   process.args_count == 2 and
		     process.parent.name in ("bash", "dash", "sh", "tcsh", "csh",
		     "zsh", "ksh", "fish") and   not process.args == "dpkg"

NamE: Microsoft Build Engine Using an Alternate Name
	description: 
		     An instance of MSBuild, the Microsoft Build
		     Engine, was started after being renamed. This is uncommon
		     behavior and may indicate an attempt to run unnoticed or
		     undetected.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.pe.original_file_name == "MSBuild.exe"
		     and   not process.name : "MSBuild.exe"

NamE: Process Activity via Compiled HTML File
	description: 
		     Compiled HTML files (.chm) are commonly
		     distributed as part of the Microsoft HTML Help system.
		     Adversaries may conceal malicious code in a CHM file and
		     deliver it to a victim for execution. CHM content is loaded by
		     the HTML Help executable program (hh.exe).
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  process.parent.name : "hh.exe" and
		     process.name : ("mshta.exe", "cmd.exe", "powershell.exe",
		     "pwsh.exe", "powershell_ise.exe", "cscript.exe", "wscript.exe")

NamE: Suspicious Print Spooler Point and Print DLL
	description: 
		     Detects attempts to exploit a privilege
		     escalation vulnerability (CVE-2020-1030) related to the print
		     spooler service. Exploitation involves chaining multiple
		     primitives to load an arbitrary DLL into the print spooler
		     process running as SYSTEM.
	query: 
		     sequence by host.id with maxspan=30s [registry where
		     host.os.type == "windows" and  registry.path : (
		     "HKLM\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Print\\Printers\\*\\SpoolDirectory",
		     "\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Print\\Printers\\*\\SpoolDirectory"     )
		     and  registry.data.strings :
		     "C:\\Windows\\System32\\spool\\drivers\\x64\\4"] [registry
		     where host.os.type == "windows" and  registry.path : (
		     "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Print\\
		     Printers\\*\\CopyFiles\\Payload\\Module",
		     "\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentV
		     ersion\\Print\\Printers\\*\\CopyFiles\\Payload\\Module"     )
		     and  registry.data.strings :
		     "C:\\Windows\\System32\\spool\\drivers\\x64\\4\\*"]

NamE: Potential curl CVE-2023-38545 Exploitation
	description: 
		     Detects potential exploitation of curl
		     CVE-2023-38545 by monitoring for vulnerable command line
		     arguments in conjunction with an unusual command line length. A
		     flaw in curl version <= 8.3 makes curl vulnerable to a heap
		     based buffer overflow during the SOCKS5 proxy handshake.
		     Upgrade to curl version >= 8.4 to patch this vulnerability.
		     This exploit can be executed with and without the use of
		     environment variables. For increased visibility, enable the
		     collection of http_proxy, HTTPS_PROXY and ALL_PROXY environment
		     variables based on the instructions provided in the setup guide
		     of this rule.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action == "exec" and process.name ==
		     "curl" and (   process.args like ("--socks5-hostname", "--
		     proxy", "--preproxy", "socks5*") or   process.env_vars like
		     ("http_proxy=socks5h://*", "HTTPS_PROXY=socks5h://*",
		     "ALL_PROXY=socks5h://*") ) and length(process.command_line) >
		     255 and not (   process.parent.name in ("cf-agent", "agent-
		     run", "agent-check", "rudder", "agent-inventory", "cf-execd")
		     or   process.args like "/opt/rudder/*" or
		     process.parent.executable like ("/vz/root/*", "/var/rudder/*")
		     )

NamE: First Time Seen Driver Loaded
	description: 
		     Identifies the load of a driver with an original
		     file name and signature values that were observed for the first
		     time during the last 30 days. This rule type can help baseline
		     drivers installation within your environment.
	query: 
		     event.category:"driver" and host.os.type:windows and
		     event.action:"load"

NamE: Linux Clipboard Activity Detected
	description: 
		     This rule monitors for the usage of the most
		     common clipboard utilities on unix systems by an uncommon
		     process group leader. Adversaries may collect data stored in
		     the clipboard from users copying information within or between
		     applications.
	query: 
		     event.category:process and host.os.type:"linux" and
		     event.type:"start" and event.action:("exec" or "exec_event" or
		     "executed" or "process_started") and process.name:("xclip" or
		     "xsel" or "wl-clipboard" or "clipman" or "copyq") and not
		     process.parent.name:("bwrap" or "micro")

NamE: Process Backgrounded by Unusual Parent
	description: 
		     This rule identifies processes that are
		     backgrounded by an unusual parent process. This behavior may
		     indicate a process attempting to evade detection by hiding its
		     parent process.
	query: 
		     event.category:process and host.os.type:linux and
		     event.type:start and event.action:(ProcessRollup2 or exec or
		     exec_event or start) and process.name:(bash or csh or dash or
		     fish or ksh or sh or tcsh or zsh) and process.args:(-c and *&)

NamE: First Time Seen NewCredentials Logon Process
	description: 
		     Identifies a new credentials logon type
		     performed by an unusual process. This may indicate the
		     existence of an access token forging capability that are often
		     abused to bypass access control restrictions.
	query: 
		     event.category:"authentication" and
		     host.os.type:"windows" and winlog.logon.type:"NewCredentials"
		     and winlog.event_data.LogonProcessName:(Advapi* or "Advapi  ")
		     and not winlog.event_data.SubjectUserName:*$ and not
		     process.executable :???\\Program?Files*

NamE: AdminSDHolder SDProp Exclusion Added
	description: 
		     Identifies a modification on the dsHeuristics
		     attribute on the bit that holds the configuration of groups
		     excluded from the SDProp process. The SDProp compares the
		     permissions on protected objects with those defined on the
		     AdminSDHolder object. If the permissions on any of the
		     protected accounts and groups do not match, the permissions on
		     the protected accounts and groups are reset to match those of
		     the domain's AdminSDHolder object, meaning that groups excluded
		     will remain unchanged. Attackers can abuse this
		     misconfiguration to maintain long-term access to privileged
		     accounts in these groups.
	query: 
		     any where event.code == "5136" and
		     winlog.event_data.AttributeLDAPDisplayName : "dSHeuristics" and
		     length(winlog.event_data.AttributeValue) > 15 and
		     winlog.event_data.AttributeValue regex~ "[0-9]{15}([1-9a-f]).*"

NamE: AWS RDS DB Instance Made Public
	description: 
		     Identifies the creation or modification of an
		     AWS RDS DB instance to enable public access. DB instances may
		     contain sensitive data that can be abused if shared with
		     unauthorized accounts or made public. Adversaries may enable
		     public access on a DB instance to maintain persistence or evade
		     defenses by bypassing access controls.
	query: 
		     any where event.dataset == "aws.cloudtrail"     and
		     event.provider == "rds.amazonaws.com"     and event.outcome ==
		     "success"     and (         (event.action == "ModifyDBInstance"
		     and stringContains(aws.cloudtrail.request_parameters,
		     "publiclyAccessible=true"))         or         (event.action in
		     ("CreateDBInstance", "CreateDBCluster") and
		     stringContains(aws.cloudtrail.request_parameters,
		     "publiclyAccessible=true"))     )

NamE: GCP Logging Sink Modification
	description: 
		     Identifies a modification to a Logging sink in
		     Google Cloud Platform (GCP). Logging compares the log entry to
		     the sinks in that resource. Each sink whose filter matches the
		     log entry writes a copy of the log entry to the sink's export
		     destination. An adversary may update a Logging sink to
		     exfiltrate logs to a different export destination.
	query: 
		     event.dataset:gcp.audit and event.action:google.loggin
		     g.v*.ConfigServiceV*.UpdateSink and event.outcome:success

NamE: Potential Privilege Escalation via Enlightenment
	description: 
		     Identifies an attempt to exploit a local
		     privilege escalation CVE-2022-37706 via a flaw in Linux window
		     manager package Enlightenment. enlightenment_sys in
		     Enlightenment before 0.25.4 allows local users to gain
		     privileges because it is setuid root, and the system library
		     function mishandles pathnames that begin with a /dev/..
		     substring.
	query: 
		     sequence by host.id, process.parent.entity_id with
		     maxspan=5s   [process where host.os.type == "linux" and
		     event.type == "start" and event.action == "exec" and
		     process.name == "enlightenment_sys" and process.args in
		     ("/bin/mount/", "-o","noexec","nosuid","nodev","uid=*") ]
		     [process where host.os.type == "linux" and event.action ==
		     "uid_change" and event.type == "change" and user.id == "0"]

NamE: Potential Privilege Escalation via UID INT_MAX Bug Detected
	description: 
		     This rule monitors for the execution of the
		     systemd-run command by a user with a UID that is larger than
		     the maximum allowed UID size (INT_MAX). Some older Linux
		     versions were affected by a bug which allows user accounts with
		     a UID greater than INT_MAX to escalate privileges by spawning a
		     shell through systemd-run.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "ProcessRollup2") and   process.name == "systemd-run" and
		     process.args == "-t" and process.args_count >= 3 and user.id >=
		     "1000000000"

NamE: Deprecated - Interactive Exec Command Launched Against A Running Container
	description: 
		     This rule detects interactive 'exec' events
		     launched against a container using the 'exec' command. Using
		     the 'exec' command in a pod allows a user to establish a
		     temporary shell session and execute any process/command inside
		     the container. This rule specifically targets higher-risk
		     interactive commands that allow real-time interaction with a
		     container's shell. A malicious actor could use this level of
		     access to further compromise the container environment or
		     attempt a container breakout.
	query: 
		     process where container.id : "*" and event.type==
		     "start" and  /* use of kubectl exec to enter a container */
		     process.entry_leader.entry_meta.type : "container" and  /*
		     process is the inital process run in a container */
		     process.entry_leader.same_as_process== true and  /* interactive
		     process */ process.interactive == true

NamE: Access Control List Modification via setfacl
	description: 
		     This rule detects Linux Access Control List
		     (ACL) modification via the setfacl command.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed", "process_started") and
		     process.name == "setfacl" and not (   process.command_line ==
		     "/bin/setfacl --restore=-" or   process.args ==
		     "/var/log/journal/" or   process.parent.name in ("stats.pl",
		     "perl", "find") or   process.parent.command_line like~ "/bin/sh
		     -c *ansible*" )

NamE: Incoming DCOM Lateral Movement with MMC
	description: 
		     Identifies the use of Distributed Component
		     Object Model (DCOM) to run commands from a remote host, which
		     are launched via the MMC20 Application COM Object. This
		     behavior may indicate an attacker abusing a DCOM application to
		     move laterally.
	query: 
		     sequence by host.id with maxspan=1m  [network where
		     host.os.type == "windows" and event.type == "start" and
		     process.name : "mmc.exe" and source.port >= 49152 and
		     destination.port >= 49152 and source.ip != "127.0.0.1" and
		     source.ip != "::1" and   network.direction : ("incoming",
		     "ingress") and network.transport == "tcp"  ] by
		     process.entity_id  [process where host.os.type == "windows" and
		     event.type == "start" and process.parent.name : "mmc.exe"  ] by
		     process.parent.entity_id

NamE: Creation of Hidden Launch Agent or Daemon
	description: 
		     Identifies the creation of a hidden launch agent
		     or daemon. An adversary may establish persistence by installing
		     a new launch agent or daemon which executes at login.
	query: 
		     file where host.os.type == "macos" and event.type !=
		     "deletion" and   file.path :   (
		     "/System/Library/LaunchAgents/.*.plist",
		     "/Library/LaunchAgents/.*.plist",
		     "/Users/*/Library/LaunchAgents/.*.plist",
		     "/System/Library/LaunchDaemons/.*.plist",
		     "/Library/LaunchDaemons/.*.plist"   )

NamE: Remotely Started Services via RPC
	description: 
		     Identifies remote execution of Windows services
		     over remote procedure call (RPC). This could be indicative of
		     lateral movement, but will be noisy if commonly done by
		     administrators.
	query: 
		     sequence with maxspan=1s    [network where
		     host.os.type == "windows" and process.name : "services.exe" and
		     network.direction : ("incoming", "ingress") and
		     network.transport == "tcp" and       source.port >= 49152 and
		     destination.port >= 49152 and source.ip != "127.0.0.1" and
		     source.ip != "::1"    ] by host.id, process.entity_id
		     [process where host.os.type == "windows" and         event.type
		     == "start" and process.parent.name : "services.exe" and
		     not (process.executable : "?:\\Windows\\System32\\msiexec.exe"
		     and process.args : "/V") and        not process.executable : (
		     "?:\\Pella
		     Corporation\\OSCToGPAutoService\\OSCToGPAutoSvc.exe",
		     "?:\\Pella Corporation\\Pella Order Management\\GPAutoSvc.exe",
		     "?:\\Pella Corporation\\Pella Order Management\\GPAutoSvc.exe",
		     "?:\\Program Files (x86)\\*.exe",                 "?:\\Program
		     Files\\*.exe",
		     "?:\\Windows\\ADCR_Agent\\adcrsvc.exe",
		     "?:\\Windows\\AdminArsenal\\PDQ*.exe",
		     "?:\\Windows\\CAInvokerService.exe",
		     "?:\\Windows\\ccmsetup\\ccmsetup.exe",
		     "?:\\Windows\\eset-remote-install-service.exe",
		     "?:\\Windows\\ProPatches\\Scheduler\\STSchedEx.exe",
		     "?:\\Windows\\PSEXESVC.EXE",
		     "?:\\Windows\\RemoteAuditService.exe",
		     "?:\\Windows\\servicing\\TrustedInstaller.exe",
		     "?:\\Windows\\System32\\certsrv.exe",
		     "?:\\Windows\\System32\\sppsvc.exe",
		     "?:\\Windows\\System32\\srmhost.exe",
		     "?:\\Windows\\System32\\svchost.exe",
		     "?:\\Windows\\System32\\taskhostex.exe",
		     "?:\\Windows\\System32\\upfc.exe",
		     "?:\\Windows\\System32\\vds.exe",
		     "?:\\Windows\\System32\\VSSVC.exe",
		     "?:\\Windows\\System32\\wbem\\WmiApSrv.exe",
		     "?:\\Windows\\SysWOW64\\NwxExeSvc\\NwxExeSvc.exe",
		     "?:\\Windows\\Veeam\\Backup\\VeeamDeploymentSvc.exe",
		     "?:\\Windows\\VeeamLogShipper\\VeeamLogShipper.exe",
		     "?:\\Windows\\VeeamVssSupport\\VeeamGuestHelper.exe"        )]
		     by host.id, process.parent.entity_id

NamE: Rare SMB Connection to the Internet
	description: 
		     This rule detects rare internet network
		     connections via the SMB protocol. SMB is commonly used to leak
		     NTLM credentials via rogue UNC path injection.
	query: 
		     event.category:network and host.os.type:windows and
		     process.pid:4 and   network.transport:tcp and
		     destination.port:(139 or 445) and   source.ip:(     10.0.0.0/8
		     or     172.16.0.0/12 or     192.168.0.0/16   ) and   not
		     destination.ip:(     10.0.0.0/8 or     127.0.0.0/8 or
		     169.254.0.0/16 or     172.16.0.0/12 or     192.0.0.0/24 or
		     192.0.0.0/29 or     192.0.0.8/32 or     192.0.0.9/32 or
		     192.0.0.10/32 or     192.0.0.170/32 or     192.0.0.171/32 or
		     192.0.2.0/24 or     192.31.196.0/24 or     192.52.193.0/24 or
		     192.168.0.0/16 or     192.88.99.0/24 or     224.0.0.0/4 or
		     100.64.0.0/10 or     192.175.48.0/24 or     198.18.0.0/15 or
		     198.51.100.0/24 or     203.0.113.0/24 or     240.0.0.0/4 or
		     "::1" or     "FE80::/10" or     "FF00::/8"   )

NamE: Root Network Connection via GDB CAP_SYS_PTRACE
	description: 
		     Identifies instances where GDB (granted the
		     CAP_SYS_PTRACE capability) is executed, after which an outbound
		     network connection is initiated by UID/GID 0 (root). In Linux,
		     the CAP_SYS_PTRACE capability grants a process the ability to
		     use the ptrace system call, which is typically used for
		     debugging and allows the process to trace and control other
		     processes. Attackers may leverage this capability to hook and
		     inject into a process that is running with root permissions in
		     order to execute shell code and gain a reverse shell with root
		     privileges.
	query: 
		     sequence by host.id, process.entry_leader.entity_id
		     with maxspan=30s   [process where host.os.type == "linux" and
		     event.type == "start" and event.action == "exec" and
		     process.name == "gdb" and
		     (process.thread.capabilities.effective : "CAP_SYS_PTRACE" or
		     process.thread.capabilities.permitted : "CAP_SYS_PTRACE") and
		     user.id != "0"]   [network where host.os.type == "linux" and
		     event.action == "connection_attempted" and event.type ==
		     "start" and    process.name != null and user.id == "0"]

NamE: Suspicious .NET Code Compilation
	description: 
		     Identifies executions of .NET compilers with
		     suspicious parent processes, which can indicate an attacker's
		     attempt to compile code after delivery in order to bypass
		     security mechanisms.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : ("csc.exe", "vbc.exe") and
		     process.parent.name : ("wscript.exe", "mshta.exe",
		     "cscript.exe", "wmic.exe", "svchost.exe", "rundll32.exe",
		     "cmstp.exe", "regsvr32.exe")

NamE: Memory Threat - Detected - Elastic Defend
	description: 
		     Generates a detection alert each time an Elastic
		     Defend alert for memory signatures are received. Enabling this
		     rule allows you to immediately begin investigating your
		     Endpoint memory signature alerts. This rule identifies Elastic
		     Defend memory signature detections only, and does not include
		     prevention alerts.
	query: 
		     event.kind : alert and event.code : (memory_signature
		     or shellcode_thread) and (event.type : allowed or (event.type:
		     denied and event.outcome: failure))

NamE: Malicious File - Prevented - Elastic Defend
	description: 
		     Generates a detection alert each time an Elastic
		     Defend alert for malicious files is received. Enabling this
		     rule allows you to immediately begin investigating your
		     Endpoint malicious file alerts. This rule identifies Elastic
		     Defend malicious file preventions only, and does not include
		     detection only alerts.
	query: 
		     event.kind : alert and event.code : malicious_file and
		     event.type : denied and event.outcome : success

NamE: Memory Threat - Prevented- Elastic Defend
	description: 
		     Generates a detection alert each time an Elastic
		     Defend alert for memory signatures are received. Enabling this
		     rule allows you to immediately begin investigating your
		     Endpoint memory signature alerts. This rule identifies Elastic
		     Defend memory signature preventions only, and does not include
		     detection only alerts.
	query: 
		     event.kind : alert and event.code : (memory_signature
		     or shellcode_thread) and event.type : denied and event.outcome
		     : success

NamE: Endpoint Security (Elastic Defend)
	description: 
		     Generates a detection alert each time an Elastic
		     Defend alert is received. Enabling this rule allows you to
		     immediately begin investigating your Endpoint alerts.
	query: 
		     event.kind:alert and event.module:(endpoint and not
		     endgame)

NamE: Malicious File - Detected - Elastic Defend
	description: 
		     Generates a detection alert each time an Elastic
		     Defend alert for malicious files is received. Enabling this
		     rule allows you to immediately begin investigating your
		     Endpoint malicious file alerts. This rule identifies Elastic
		     Defend malicious file detections only, and does not include
		     prevention alerts.
	query: 
		     event.kind : alert and event.code : malicious_file and
		     (event.type : allowed or (event.type: denied and event.outcome:
		     failure))

NamE: Potential Application Shimming via Sdbinst
	description: 
		     The Application Shim was created to allow for
		     backward compatibility of software as the operating system
		     codebase changes over time. This Windows functionality has been
		     abused by attackers to stealthily gain persistence and
		     arbitrary code execution in legitimate Windows processes.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and process.name : "sdbinst.exe" and   process.args
		     : "?*" and   not (process.args : "-m" and process.args : "-bg")
		     and   not process.args : "-mm"

NamE: Behavior - Detected - Elastic Defend
	description: 
		     Generates a detection alert each time an Elastic
		     Defend alert for malicious behavior is received. Enabling this
		     rule allows you to immediately begin investigating your
		     Endpoint behavior alerts. This rule identifies Elastic Defend
		     behavior detections only, and does not include prevention
		     alerts.
	query: 
		     event.kind : alert and event.code : behavior and
		     (event.type : allowed or (event.type: denied and event.outcome:
		     failure))

NamE: SMB Connections via LOLBin or Untrusted Process
	description: 
		     Identifies potentially suspicious processes that
		     are not trusted or living-off-the-land binaries (LOLBin) making
		     Server Message Block (SMB) network connections over port 445.
		     Windows File Sharing is typically implemented over SMB, which
		     communicates between hosts using port 445. Legitimate
		     connections are generally established by the kernel (PID 4).
		     This rule helps to detect processes that might be port
		     scanners, exploits, or user-level processes attempting lateral
		     movement within the network by leveraging SMB connections.
	query: 
		     sequence by process.entity_id with maxspan=1m    /*
		     first sequence to capture the start of Windows processes */
		     [process where host.os.type == "windows" and event.type ==
		     "start" and process.pid != 4 and      /* ignore NT Authority
		     and Network Service accounts */     not user.id in ("S-1-5-19",
		     "S-1-5-20") and      /* filter out anything trusted but not
		     from Microsoft */     /* LOLBins will be inherently trusted and
		     signed, so ignore everything else trusted */     not
		     (process.code_signature.trusted == true and not
		     startsWith(process.code_signature.subject_name, "Microsoft"))
		     and      /* filter out PowerShell scripts from Windows Defender
		     ATP */     not (       process.name : "powershell.exe" and
		     process.args :"?:\\ProgramData\\Microsoft\\Windows Defender
		     Advanced Threat Protection\\Downloads\\PSScript_*.ps1")]    /*
		     second sequence to capture network connections over port 445
		     related to SMB */   [network where host.os.type == "windows"
		     and destination.port == 445 and process.pid != 4]

NamE: Full User-Mode Dumps Enabled System-Wide
	description: 
		     Identifies the enable of the full user-mode
		     dumps feature system-wide. This feature allows Windows Error
		     Reporting (WER) to collect data after an application crashes.
		     This setting is a requirement for the LSASS Shtinkering attack,
		     which fakes the communication of a crash on LSASS, generating a
		     dump of the process memory, which gives the attacker access to
		     the credentials present on the system without having to bring
		     malware to the system. This setting is not enabled by default,
		     and applications must create their registry subkeys to hold
		     settings that enable them to collect dumps.
	query: 
		     registry where host.os.type == "windows" and
		     registry.path : (
		     "HKLM\\SOFTWARE\\Microsoft\\Windows\\Windows Error
		     Reporting\\LocalDumps\\DumpType",
		     "\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\Windows
		     Error Reporting\\LocalDumps\\DumpType"     ) and
		     registry.data.strings : ("2", "0x00000002") and     not
		     (process.executable : "?:\\Windows\\system32\\svchost.exe" and
		     user.id : ("S-1-5-18", "S-1-5-19", "S-1-5-20"))

NamE: Conhost Spawned By Suspicious Parent Process
	description: 
		     Detects when the Console Window Host
		     (conhost.exe) process is spawned by a suspicious parent
		     process, which could be indicative of code injection.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : "conhost.exe" and
		     process.parent.name : ("lsass.exe", "services.exe", "smss.exe",
		     "winlogon.exe", "explorer.exe", "dllhost.exe", "rundll32.exe",
		     "regsvr32.exe", "userinit.exe", "wininit.exe", "spoolsv.exe",
		     "ctfmon.exe") and   not (process.parent.name : "rundll32.exe"
		     and        process.parent.args : ("?:\\Windows\\Installer\\MSI*
		     .tmp,zzzzInvokeManagedCustomActionOutOfProc",
		     "?:\\WINDOWS\\system32\\PcaSvc.dll,PcaPatchSdbTask",
		     "?:\\WINDOWS\\system32\\davclnt.dll,DavSetCookie"))

NamE: Root Certificate Installation
	description: 
		     This rule detects the installation of root
		     certificates on a Linux system. Adversaries may install a root
		     certificate on a compromised system to avoid warnings when
		     connecting to their command and control servers. Root
		     certificates are used in public key cryptography to identify a
		     root certificate authority (CA). When a root certificate is
		     installed, the system or application will trust certificates in
		     the root's chain of trust that have been signed by the root
		     certificate.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start")
		     and process.name in ("update-ca-trust", "update-ca-
		     certificates") and not (   process.parent.name like (     "ca-
		     certificates.postinst", "ca-certificates-*.trigger", "pacman",
		     "pamac-daemon", "autofirma.postinst",     "ipa-client-install",
		     "su", "platform-python", "python*", "kesl", "execd", "systemd",
		     "flock"   ) or   process.parent.args like "/var/tmp/rpm*" or
		     (process.parent.name in ("sh", "bash", "zsh") and process.args
		     == "-e") )

NamE: Privilege Escalation via CAP_CHOWN/CAP_FOWNER Capabilities
	description: 
		     Identifies instances where a processes (granted
		     CAP_CHOWN and/or CAP_FOWNER capabilities) is executed, after
		     which the ownership of a suspicious file or binary is changed.
		     In Linux, the CAP_CHOWN capability allows a process to change
		     the owner of a file, while CAP_FOWNER permits it to bypass
		     permission checks on operations that require file ownership
		     (like reading, writing, and executing). Attackers may abuse
		     these capabilities to obtain unauthorized access to files.
	query: 
		     sequence by host.id, process.pid with maxspan=1s
		     [process where host.os.type == "linux" and event.type ==
		     "start" and event.action == "exec" and    process.name != null
		     and process.thread.capabilities.effective : ("CAP_CHOWN",
		     "CAP_FOWNER") and    process.command_line : ("*sudoers*",
		     "*passwd*", "*shadow*", "*/root/*") and user.id != "0"]   [file
		     where host.os.type == "linux" and event.action == "changed-
		     file-ownership-of" and event.type == "change" and
		     event.outcome == "success" and file.path in (
		     "/etc/passwd",      "/etc/shadow",      "/etc/sudoers",
		     "/root/.ssh/*"    ) and user.id != "0"   ]

NamE: AWS Bedrock Guardrails Detected Multiple Violations by a Single User Over a Session
	description: 
		     Identifies multiple violations of AWS Bedrock
		     guardrails by the same user in the same account over a session.
		     Multiple violations implies that a user may be intentionally
		     attempting to cirvumvent security controls, access sensitive
		     information, or possibly exploit a vulnerability in the system.
	query: 
		     from logs-aws_bedrock.invocation-* | where
		     gen_ai.compliance.violation_detected | keep user.id,
		     gen_ai.request.model.id, cloud.account.id | stats violations =
		     count(*) by user.id, gen_ai.request.model.id, cloud.account.id
		     | where violations > 1 | sort violations desc

NamE: AWS CloudTrail Log Created
	description: 
		     Identifies the creation of an AWS log trail that
		     specifies the settings for delivery of log data.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:cloudtrail.amazonaws.com and
		     event.action:CreateTrail and event.outcome:success

NamE: Microsoft 365 Exchange Malware Filter Rule Modification
	description: 
		     Identifies when a malware filter rule has been
		     deleted or disabled in Microsoft 365. An adversary or insider
		     threat may want to modify a malware filter rule to evade
		     detection.
	query: 
		     event.dataset:o365.audit and event.provider:Exchange
		     and event.category:web and event.action:("Remove-
		     MalwareFilterRule" or "Disable-MalwareFilterRule") and
		     event.outcome:success

NamE: Deprecated - SSH Connection Established Inside A Running Container
	description: 
		     This rule detects an incoming SSH connection
		     established inside a running container. Running an ssh daemon
		     inside a container should be avoided and monitored closely if
		     necessary. If an attacker gains valid credentials they can use
		     it to gain initial access or establish persistence within a
		     compromised environment.
	query: 
		     process where container.id: "*" and event.type ==
		     "start" and  /* use of sshd to enter a container*/
		     process.entry_leader.entry_meta.type: "sshd"  and  /* process
		     is the initial process run in a container or start of a new
		     session*/ (process.entry_leader.same_as_process== true or
		     process.session_leader.same_as_process== true) and  /*
		     interactive process*/ process.interactive== true

NamE: Potentially Successful MFA Bombing via Push Notifications
	description: 
		     Detects when an attacker abuses the Multi-Factor
		     authentication mechanism by repeatedly issuing login requests
		     until the user eventually accepts the Okta push notification.
		     An adversary may attempt to bypass the Okta MFA policies
		     configured for an organization to obtain unauthorized access.
	query: 
		     sequence by okta.actor.id with maxspan=10m
		     [authentication where event.dataset == "okta.system" and
		     event.module == "okta"     and event.action ==
		     "user.mfa.okta_verify.deny_push"] with runs=3   [authentication
		     where event.dataset == "okta.system" and event.module == "okta"
		     and (event.action : (       "user.authentication.sso",
		     "user.authentication.auth_via_mfa",
		     "user.authentication.verify",       "user.session.start") and
		     okta.outcome.result == "SUCCESS")]

NamE: Exploit - Prevented - Elastic Endgame
	description: 
		     Elastic Endgame prevented an Exploit. Click the
		     Elastic Endgame icon in the event.module column or the link in
		     the rule.reference column for additional information.
	query: 
		     event.kind:alert and event.module:endgame and
		     endgame.metadata.type:prevention and
		     (event.action:exploit_event or
		     endgame.event_subtype_full:exploit_event)

NamE: Authentication via Unusual PAM Grantor
	description: 
		     This rule detects successful authentications via
		     PAM grantors that are not commonly used. This could indicate an
		     attacker is attempting to escalate privileges or maintain
		     persistence on the system by modifying the default PAM
		     configuration.
	query: 
		     event.category:authentication and host.os.type:linux
		     and event.action:authenticated and event.outcome:success and
		     auditd.data.grantors:(* and not (pam_rootok or *pam_cap* or
		     *pam_permit*))

NamE: Default Cobalt Strike Team Server Certificate
	description: 
		     This rule detects the use of the default Cobalt
		     Strike Team Server TLS certificate. Cobalt Strike is software
		     for Adversary Simulations and Red Team Operations which are
		     security assessments that replicate the tactics and techniques
		     of an advanced adversary in a network. Modifications to the
		     Packetbeat configuration can be made to include MD5 and SHA256
		     hashing algorithms (the default is SHA1). See the References
		     section for additional information on module configuration.
	query: 
		     (event.dataset: network_traffic.tls or event.category:
		     (network or network_traffic))   and
		     (tls.server.hash.md5:950098276A495286EB2A2556FBAB6D83   or
		     tls.server.hash.sha1:6ECE5ECE4192683D2D84E25B0BA7E04F9CB7EB7C
		     or tls.server.hash.sha256:87F2085C32B6A2CC709B365F55873E207A9CA
		     A10BFFECF2FD16D3CF9D94D390C)

NamE: Linux User Account Creation
	description: 
		     Identifies attempts to create new users.
		     Attackers may add new users to establish persistence on a
		     system.
	query: 
		     iam where host.os.type == "linux" and (event.type ==
		     "user" and event.type == "creation") and process.name in
		     ("useradd", "adduser") and user.name != null

NamE: GCP Virtual Private Cloud Network Deletion
	description: 
		     Identifies when a Virtual Private Cloud (VPC)
		     network is deleted in Google Cloud Platform (GCP). A VPC
		     network is a virtual version of a physical network within a GCP
		     project. Each VPC network has its own subnets, routes, and
		     firewall, as well as other elements. An adversary may delete a
		     VPC network in order to disrupt their target's network and
		     business operations.
	query: 
		     event.dataset:gcp.audit and
		     event.action:v*.compute.networks.delete and
		     event.outcome:success

NamE: Google Workspace Custom Admin Role Created
	description: 
		     Detects when a custom admin role is created in
		     Google Workspace. An adversary may create a custom admin role
		     in order to elevate the permissions of other user accounts and
		     persist in their target’s environment.
	query: 
		     event.dataset:google_workspace.admin and
		     event.provider:admin and event.category:iam and
		     event.action:CREATE_ROLE

NamE: First Occurrence of GitHub User Interaction with Private Repo
	description: 
		     Detects a new private repo interaction for a
		     GitHub user not seen in the last 14 days.
	query: 
		     event.dataset:"github.audit" and
		     event.category:"configuration" and github.repo:* and
		     user.name:* and  github.repository_public:false

NamE: PowerShell Script Block Logging Disabled
	description: 
		     Identifies attempts to disable PowerShell Script
		     Block Logging via registry modification. Attackers may disable
		     this logging to conceal their activities in the host and evade
		     detection.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and     registry.path : (         "HKLM\
		     \SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBloc
		     kLogging\\EnableScriptBlockLogging",         "\\REGISTRY\\MACHI
		     NE\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptB
		     lockLogging\\EnableScriptBlockLogging",         "MACHINE\\SOFTW
		     ARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLoggi
		     ng\\EnableScriptBlockLogging"     ) and registry.data.strings :
		     ("0", "0x00000000")

NamE: Suspicious Automator Workflows Execution
	description: 
		     Identifies the execution of the Automator
		     Workflows process followed by a network connection from it's
		     XPC service. Adversaries may drop a custom workflow template
		     that hosts malicious JavaScript for Automation (JXA) code as an
		     alternative to using osascript.
	query: 
		     sequence by host.id with maxspan=30s  [process where
		     host.os.type == "macos" and event.type in ("start",
		     "process_started") and process.name == "automator"]  [network
		     where host.os.type == "macos" and
		     process.name:"com.apple.automator.runner"]

NamE: User Account Creation
	description: 
		     Identifies attempts to create new users. This is
		     sometimes done by attackers to increase access or establish
		     persistence on a system or domain.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (process.name : ("net.exe", "net1.exe") and
		     not process.parent.name : "net.exe") and   (process.args :
		     "user" and process.args : ("/ad", "/add"))

NamE: Suspicious File Creation via Kworker
	description: 
		     This rule monitors for a file creation event
		     originating from a kworker parent process. kworker, or kernel
		     worker, processes are part of the kernel's workqueue mechanism.
		     They are responsible for executing work that has been scheduled
		     to be done in kernel space, which might include tasks like
		     handling interrupts, background activities, and other kernel-
		     related tasks. Attackers may attempt to evade detection by
		     masquerading as a kernel worker process.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("creation", "file_create_event") and   process.name :
		     "kworker*" and not (     (process.name : "kworker*kcryptd*") or
		     (file.path : (       "/var/log/*", "/var/crash/*",
		     "/var/run/*", "/var/lib/systemd/coredump/*", "/var/spool/*",
		     "/var/lib/nfs/nfsdcltrack/main.sqlite-journal",
		     "/proc/*/cwd/core.*", "/var/run/apport.lock",
		     "/var/spool/abrt/ccpp-*", "/var/lib/dynatrace/oneagent/*",
		     "/var/lib/nfs*", "/run/user/*/.bubblewrap/*",
		     "/etc/localtime/*", "/proc/*/cwd/core.*"       )     )   )

NamE: Renamed AutoIt Scripts Interpreter
	description: 
		     Identifies a suspicious AutoIt process
		     execution. Malware written as an AutoIt script tends to rename
		     the AutoIt executable to avoid detection.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.pe.original_file_name : "AutoIt*.exe"
		     and not process.name : "AutoIt*.exe"

NamE: Possible FIN7 DGA Command and Control Behavior
	description: 
		     This rule detects a known command and control
		     pattern in network events. The FIN7 threat group is known to
		     use this command and control technique, while maintaining
		     persistence in their target's network.
	query: 
		     (event.dataset: (network_traffic.tls OR
		     network_traffic.http) OR     (event.category: (network OR
		     network_traffic) AND type: (tls OR http) AND network.transport:
		     tcp)) AND
		     destination.domain:/[a-zA-Z]{4,5}\.(pw|us|club|info|site|top)/
		     AND NOT destination.domain:zoom.us

NamE: Control Panel Process with Unusual Arguments
	description: 
		     Identifies unusual instances of Control Panel
		     with suspicious keywords or paths in the process command line
		     value. Adversaries may abuse control.exe to proxy execution of
		     malicious code.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : "control.exe" and
		     process.command_line : (     "*.jpg*", "*.png*",     "*.gif*",
		     "*.bmp*",     "*.jpeg*", "*.TIFF*",     "*.inf*", "*.cpl:*/*",
		     "*../../..*",     "*/AppData/Local/*",
		     "*:\\Users\\Public\\*",     "*\\AppData\\Local\\*" )

NamE: Attempt to Delete an Okta Policy
	description: 
		     Detects attempts to delete an Okta policy. An
		     adversary may attempt to delete an Okta policy in order to
		     weaken an organization's security controls. For example, an
		     adversary may attempt to delete an Okta multi-factor
		     authentication (MFA) policy in order to weaken the
		     authentication requirements for user accounts.
	query: 
		     event.dataset:okta.system and
		     event.action:policy.lifecycle.delete

NamE: Remote File Download via PowerShell
	description: 
		     Identifies powershell.exe being used to download
		     an executable file from an untrusted remote destination.
	query: 
		     sequence by process.entity_id with maxspan=30s
		     [network where host.os.type == "windows" and   process.name :
		     ("powershell.exe", "pwsh.exe", "powershell_ise.exe") and
		     network.protocol == "dns" and    not dns.question.name : (
		     "localhost", "*.microsoft.com", "*.azureedge.net",
		     "*.powershellgallery.com",           "*.windowsupdate.com",
		     "metadata.google.internal", "dist.nuget.org",
		     "artifacts.elastic.co", "*.digicert.com",
		     "packages.chocolatey.org",           "outlook.office365.com"
		     ) and not user.id : "S-1-5-18"] [file where host.os.type ==
		     "windows" and event.type == "creation" and   process.name :
		     "powershell.exe" and file.extension : ("exe", "dll", "ps1",
		     "bat") and   not file.name : "__PSScriptPolicy*.ps1"]

NamE: Azure Service Principal Addition
	description: 
		     Identifies when a new service principal is added
		     in Azure. An application, hosted service, or automated tool
		     that accesses or modifies resources needs an identity created.
		     This identity is known as a service principal. For security
		     reasons, it's always recommended to use service principals with
		     automated tools rather than allowing them to log in with a user
		     identity.
	query: 
		     event.dataset:azure.auditlogs and
		     azure.auditlogs.operation_name:"Add service principal" and
		     event.outcome:(success or Success)

NamE: Potential Code Execution via Postgresql
	description: 
		     This rule monitors for suspicious activities
		     that may indicate an attacker attempting to execute arbitrary
		     code within a PostgreSQL environment. Attackers can execute
		     code via PostgreSQL as a result of gaining unauthorized access
		     to a public facing PostgreSQL database or exploiting
		     vulnerabilities, such as remote command execution and SQL
		     injection attacks, which can result in unauthorized access and
		     malicious actions, and facilitate post-exploitation activities
		     for unauthorized access and malicious actions.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "fork",
		     "fork_event") and user.name == "postgres" and (
		     (process.parent.args : "*sh" and process.parent.args : "echo*")
		     or   (process.args : "*sh" and process.args : "echo*") ) and
		     not (   process.parent.name == "puppet" or
		     process.command_line like (     "*BECOME-SUCCESS-*", "bash -c
		     while true; do sleep 1;*", "df -l", "sleep 1", "who", "head -v
		     -n *", "tail -v -n *",     "/bin/sh -c echo BECOME-SUCCESS*",
		     "/usr/bin/python3 /var/tmp/ansible-tmp*"   ) or
		     process.parent.command_line like "*BECOME-SUCCESS-*" )

NamE: Suspicious HTML File Creation
	description: 
		     Identifies the execution of a browser process to
		     open an HTML file with high entropy and size. Adversaries may
		     smuggle data and files past content filters by hiding malicious
		     payloads inside of seemingly benign HTML files.
	query: 
		     sequence by user.id with maxspan=2m   [file where
		     host.os.type == "windows" and event.action in ("creation",
		     "rename") and    /* Check for HTML files with high entropy and
		     size */   file.extension : ("htm", "html") and
		     ((file.Ext.entropy >= 5 and file.size >= 150000) or file.size
		     >= 1000000) and    /* Check for file paths in common download
		     and temporary directories */   file.path : (
		     "?:\\Users\\*\\Downloads\\*",
		     "?:\\Users\\*\\Content.Outlook\\*",
		     "?:\\Users\\*\\AppData\\Local\\Temp\\Temp?_*",
		     "?:\\Users\\*\\AppData\\Local\\Temp\\7z*",
		     "?:\\Users\\*\\AppData\\Local\\Temp\\Rar$*")]  [process where
		     host.os.type == "windows" and event.action == "start" and   (
		     /* Check for browser processes opening HTML files with single
		     argument */    (process.name in ("chrome.exe", "msedge.exe",
		     "brave.exe", "whale.exe", "browser.exe", "dragon.exe",
		     "vivaldi.exe", "opera.exe")     and process.args == "--single-
		     argument") or     /* Optionally, check for browser processes
		     opening HTML files with two arguments */    (process.name ==
		     "iexplore.exe" and process.args_count == 2) or     /*
		     Optionally, check for browser processes opening HTML files with
		     URL argument */    (process.name in ("firefox.exe",
		     "waterfox.exe") and process.args == "-url")   )   /* Check for
		     file paths in common download and temporary directories
		     targeted in the process arguments */   and process.args :
		     ("?:\\Users\\*\\Downloads\\*.htm*",
		     "?:\\Users\\*\\Content.Outlook\\*.htm*",
		     "?:\\Users\\*\\AppData\\Local\\Temp\\Temp?_*.htm*",
		     "?:\\Users\\*\\AppData\\Local\\Temp\\7z*.htm*",
		     "?:\\Users\\*\\AppData\\Local\\Temp\\Rar$*.htm*")]

NamE: Administrator Privileges Assigned to an Okta Group
	description: 
		     Detects when an administrator role is assigned
		     to an Okta group. An adversary may attempt to assign
		     administrator privileges to an Okta group in order to assign
		     additional permissions to compromised user accounts and
		     maintain access to their target organization.
	query: 
		     event.dataset:okta.system and
		     event.action:group.privilege.grant

NamE: SELinux Configuration Creation or Renaming
	description: 
		     This rule detects the creation or renaming of
		     the SELinux configuration file. SELinux is a security module
		     that provides access control security policies. Modifications
		     to the SELinux configuration file may indicate an attempt to
		     impair defenses by disabling or modifying security tools.
	query: 
		     file where host.os.type == "linux" and event.action in
		     ("creation", "file_create_event", "rename",
		     "file_rename_event") and file.path : "/etc/selinux/config" and
		     not process.name in ("dockerd", "platform-python")

NamE: GitHub User Blocked From Organization
	description: 
		     A GitHub user was blocked from access to an
		     organization.
	query: 
		     configuration where event.dataset == "github.audit"
		     and event.action == "org.block_user"

NamE: Remote File Copy via TeamViewer
	description: 
		     Identifies an executable or script file remotely
		     downloaded via a TeamViewer transfer session.
	query: 
		     file where host.os.type == "windows" and event.type ==
		     "creation" and process.name : "TeamViewer.exe" and
		     file.extension : ("exe", "dll", "scr", "com", "bat", "ps1",
		     "vbs", "vbe", "js", "wsh", "hta") and   not    (     file.path
		     : (       "?:\\Users\\*\\AppData\\Local\\Microsoft\\Windows\\IN
		     etCache\\*.js",
		     "?:\\Users\\*\\AppData\\Local\\Temp\\TeamViewer\\update.exe",
		     "?:\\Users\\*\\AppData\\Local\\Temp\\?\\TeamViewer\\update.exe"
		     ,       "?:\\Users\\*\\AppData\\Local\\TeamViewer\\CustomConfig
		     s\\???????\\TeamViewer_Resource_??.dll",       "?:\\Users\\*\\A
		     ppData\\Local\\TeamViewer\\CustomConfigs\\???????\\TeamViewer*.
		     exe"     ) and process.code_signature.trusted == true   )

NamE: BPF filter applied using TC
	description: 
		     Detects when the tc (transmission control)
		     binary is utilized to set a BPF (Berkeley Packet Filter) on a
		     network interface. Tc is used to configure Traffic Control in
		     the Linux kernel. It can shape, schedule, police and drop
		     traffic. A threat actor can utilize tc to set a bpf filter on
		     an interface for the purpose of manipulating the incoming
		     traffic. This technique is not at all common and should
		     indicate abnormal, suspicious or malicious activity.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and process.executable == "/usr/sbin/tc" and
		     process.args == "filter" and process.args == "add" and
		     process.args == "bpf" and not process.parent.executable ==
		     "/usr/sbin/libvirtd"

NamE: Attempts to Brute Force an Okta User Account
	description: 
		     Identifies when an Okta user account is locked
		     out 3 times within a 3 hour window. An adversary may attempt a
		     brute force or password spraying attack to obtain unauthorized
		     access to user accounts. The default Okta authentication policy
		     ensures that a user account is locked out after 10 failed
		     authentication attempts.
	query: 
		     event.dataset:okta.system and
		     event.action:user.account.lock

NamE: Script Execution via Microsoft HTML Application
	description: 
		     Identifies the execution of scripts via HTML
		     applications using Windows utilities rundll32.exe or mshta.exe.
		     Adversaries may bypass process and/or signature-based defenses
		     by proxying execution of malicious content with signed
		     binaries.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  process.name : ("rundll32.exe", "mshta.exe")
		     and   (      (process.command_line :         (
		     "*script*eval(*",          "*script*GetObject*",
		     "*.regread(*",          "*WScript.Shell*",          "*.run(*",
		     "*).Exec()*",          "*mshta*http*",
		     "*mshtml*RunHTMLApplication*",          "*mshtml*,#135*",
		     "*StrReverse*",          "*.RegWrite*",          /* Issue #379
		     */          "*window.close(*",          "* Chr(*"          )
		     and not process.parent.executable :
		     ("?:\\Program Files (x86)\\Citrix\\System32\\wfshell.exe",
		     "?:\\Program Files (x86)\\Microsoft
		     Office\\Office*\\MSACCESS.EXE",                    "?:\\Program
		     Files\\Quokka.Works GTInstaller\\GTInstaller.exe")      ) or
		     (process.name : "mshta.exe" and      not process.command_line :
		     ("*.hta*", "*.htm*", "-Embedding") and process.args_count >=2)
		     or       /* Execution of HTA file downloaded from the internet
		     */      (process.name : "mshta.exe" and process.command_line :
		     "*\\Users\\*\\Downloads\\*.hta*") or       /* Execution of HTA
		     file from archive */      (process.name : "mshta.exe" and
		     process.args : ("?:\\Users\\*\\Temp\\7z*",
		     "?:\\Users\\*\\Temp\\Rar$*", "?:\\Users\\*\\Temp\\Temp?_*",
		     "?:\\Users\\*\\Temp\\BNZ.*"))    )

NamE: A scheduled task was updated
	description: 
		     Indicates the update of a scheduled task using
		     Windows event logs. Adversaries can use these to establish
		     persistence, by changing the configuration of a legit scheduled
		     task. Some changes such as disabling or enabling a scheduled
		     task are common and may may generate noise.
	query: 
		     iam where event.action == "scheduled-task-updated" and
		     /* excluding tasks created by the computer account */  not
		     user.name : "*$" and  not winlog.event_data.TaskName :
		     "*Microsoft*" and  not winlog.event_data.TaskName :
		     ("\\User_Feed_Synchronization-*",            "\\OneDrive
		     Reporting Task-S-1-5-21*",            "\\OneDrive Reporting
		     Task-S-1-12-1-*",            "\\Hewlett-Packard\\HP Web
		     Products Detection",            "\\Hewlett-
		     Packard\\HPDeviceCheck",
		     "\\Microsoft\\Windows\\UpdateOrchestrator\\UpdateAssistant",
		     "\\IpamDnsProvisioning",            "\\Microsoft\\Windows\\Upda
		     teOrchestrator\\UpdateAssistantAllUsersRun",            "\\Micr
		     osoft\\Windows\\UpdateOrchestrator\\UpdateAssistantCalendarRun"
		     ,            "\\Microsoft\\Windows\\UpdateOrchestrator\\UpdateA
		     ssistantWakeupRun",            "\\Microsoft\\Windows\\.NET
		     Framework\\.NET Framework NGEN v*",
		     "\\Microsoft\\VisualStudio\\Updates\\BackgroundDownload") and
		     not winlog.event_data.SubjectUserSid :  ("S-1-5-18",
		     "S-1-5-19", "S-1-5-20")

NamE: Attempt to Deactivate an Okta Application
	description: 
		     Detects attempts to deactivate an Okta
		     application. An adversary may attempt to modify, deactivate, or
		     delete an Okta application in order to weaken an organization's
		     security controls or disrupt their business operations.
	query: 
		     event.dataset:okta.system and
		     event.action:application.lifecycle.deactivate

NamE: Azure Full Network Packet Capture Detected
	description: 
		     Identifies potential full network packet capture
		     in Azure. Packet Capture is an Azure Network Watcher feature
		     that can be used to inspect network traffic. This feature can
		     potentially be abused to read sensitive data from unencrypted
		     internal traffic.
	query: 
		     event.dataset:azure.activitylogs and
		     azure.activitylogs.operation_name:     (
		     MICROSOFT.NETWORK/*/STARTPACKETCAPTURE/ACTION or
		     MICROSOFT.NETWORK/*/VPNCONNECTIONS/STARTPACKETCAPTURE/ACTION or
		     MICROSOFT.NETWORK/*/PACKETCAPTURES/WRITE     ) and
		     event.outcome:(Success or success)

NamE: High Number of Okta Device Token Cookies Generated for Authentication
	description: 
		     Detects when an Okta client address has a
		     certain threshold of Okta user authentication events with
		     multiple device token hashes generated for single user
		     authentication. Adversaries may attempt to launch a credential
		     stuffing or password spraying attack from the same device by
		     using a list of known usernames and passwords to gain
		     unauthorized access to user accounts.
	query: 
		     FROM logs-okta* | WHERE     event.dataset ==
		     "okta.system"     AND (event.action RLIKE
		     "user\\.authentication(.*)" OR event.action ==
		     "user.session.start")     AND
		     okta.debug_context.debug_data.request_uri == "/api/v1/authn"
		     AND okta.outcome.reason == "INVALID_CREDENTIALS" | KEEP
		     event.action, okta.debug_context.debug_data.dt_hash,
		     okta.client.ip, okta.actor.alternate_id,
		     okta.debug_context.debug_data.request_uri, okta.outcome.reason
		     | STATS     source_auth_count =
		     COUNT_DISTINCT(okta.debug_context.debug_data.dt_hash)     BY
		     okta.client.ip, okta.actor.alternate_id | WHERE
		     source_auth_count >= 30 | SORT     source_auth_count DESC

NamE: AWS SSM Command Document Created by Rare User
	description: 
		     Identifies when an AWS Systems Manager (SSM)
		     command document is created by a user who does not typically
		     perform this action. Adversaries may create SSM command
		     documents to execute commands on managed instances, potentially
		     leading to unauthorized access, command and control, data
		     exfiltration and more.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "ssm.amazonaws.com"     and event.action:
		     "CreateDocument"     and event.outcome: "success"     and
		     aws.cloudtrail.response_elements: *documentType=Command*

NamE: Azure Entra MFA TOTP Brute Force Attempts
	description: 
		     Identifies brute force attempts against Azure
		     Entra multi-factor authentication (MFA) Time-based One-Time
		     Password (TOTP) verification codes. This rule detects high
		     frequency failed TOTP code attempts for a single user in a
		     short time-span. Adversaries with valid credentials, when
		     attempting to login to Azure portal or other Azure services,
		     may be prompted to provide a TOTP code as part of the MFA
		     process. If successful, adversaries can bypass MFA and gain
		     unauthorized access to Azure resources.
	query: 
		     from logs-azure.signinlogs* metadata _id, _version,
		     _index | where     // filter for Entra Sign-In Logs
		     event.dataset == "azure.signinlogs"     and
		     azure.signinlogs.operation_name == "Sign-in activity"      //
		     filter for MFA attempts with OATH conditional access attempts
		     or TOTP     and
		     azure.signinlogs.properties.authentication_requirement ==
		     "multiFactorAuthentication"     and
		     azure.signinlogs.properties.mfa_detail.auth_method == "OATH
		     verification code"      // filter on failures only from brute-
		     force attempts     and
		     azure.signinlogs.properties.conditional_access_status ==
		     "failure"     and azure.signinlogs.result_description ==
		     "Authentication failed during strong authentication request." |
		     keep azure.signinlogs.properties.sign_in_identifier | stats
		     // aggregate by the sign-in account or principal
		     failed_totp_code_attempts = count(*) by
		     azure.signinlogs.properties.sign_in_identifier | where     //
		     filter on high frequency for a single user
		     failed_totp_code_attempts > 30

NamE: Successful SSH Authentication from Unusual SSH Public Key
	description: 
		     This rule leverages the new_terms rule type to
		     detect successful SSH authentications via a public key that has
		     not been seen in the last 10 days. Public key authentication is
		     a secure method for authenticating users to a server.
		     Monitoring unusual public key authentication events can help
		     detect unauthorized access attempts or suspicious activity on
		     the system.
	query: 
		     event.category:authentication and host.os.type:linux
		     and event.action:ssh_login and event.outcome:success and
		     system.auth.ssh.method:publickey

NamE: GitHub Owner Role Granted To User
	description: 
		     This rule detects when a member is granted the
		     organization owner role of a GitHub organization. This role
		     provides admin level privileges. Any new owner role should be
		     investigated to determine its validity. Unauthorized owner
		     roles could indicate compromise within your organization and
		     provide unlimited access to data and settings.
	query: 
		     iam where event.dataset == "github.audit" and
		     event.action == "org.update_member" and github.permission ==
		     "admin"

NamE: GCP Storage Bucket Deletion
	description: 
		     Identifies when a Google Cloud Platform (GCP)
		     storage bucket is deleted. An adversary may delete a storage
		     bucket in order to disrupt their target's business operations.
	query: 
		     event.dataset:gcp.audit and
		     event.action:"storage.buckets.delete"

NamE: Potential Ransomware Note File Dropped via SMB
	description: 
		     Identifies an incoming SMB connection followed
		     by the creation of a file with a name similar to ransomware
		     note files. This may indicate a remote ransomware attack via
		     the SMB protocol.
	query: 
		     sequence by host.id with maxspan=1s  [network where
		     host.os.type == "windows" and   event.action ==
		     "connection_accepted" and destination.port == 445 and
		     source.port >= 49152 and process.pid == 4 and   source.ip !=
		     "127.0.0.1" and source.ip != "::1" and   network.type == "ipv4"
		     and not endswith(source.address, destination.address)]  [file
		     where host.os.type == "windows" and event.action == "creation"
		     and   process.pid == 4 and user.id : ("S-1-5-21*", "S-1-12-*")
		     and file.extension : ("hta", "txt", "readme", "htm*") and
		     file.path : "C:\\Users\\*" and    /* ransom file name keywords
		     */     file.name : ("*read*me*", "*lock*", "*@*", "*RECOVER*",
		     "*decrypt*", "*restore*file*", "*FILES_BACK*", "*how*to*")]
		     with runs=3

NamE: Potential Privacy Control Bypass via TCCDB Modification
	description: 
		     Identifies the use of sqlite3 to directly modify
		     the Transparency, Consent, and Control (TCC) SQLite database.
		     This may indicate an attempt to bypass macOS privacy controls,
		     including access to sensitive resources like the system camera,
		     microphone, address book, and calendar.
	query: 
		     process where host.os.type == "macos" and event.type
		     in ("start", "process_started") and process.name : "sqlite*"
		     and  process.args : "/*/Application
		     Support/com.apple.TCC/TCC.db" and  not
		     process.parent.executable :
		     "/Library/Bitdefender/AVP/product/bin/*"

NamE: Unix Socket Connection
	description: 
		     This rule monitors for inter-process
		     communication via Unix sockets. Adversaries may attempt to
		     communicate with local Unix sockets to enumerate application
		     details, find vulnerabilities/configuration mistakes and
		     potentially escalate privileges or set up malicious
		     communication channels via Unix sockets for inter-process
		     communication to attempt to evade detection.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and  event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed", "process_started") and  (
		     (process.name in ("nc", "ncat", "netcat", "nc.openbsd") and
		     process.args == "-U" and process.args : ("/usr/local/*",
		     "/run/*", "/var/run/*")) or   (process.name == "socat" and
		     process.args == "-" and process.args : ("UNIX-
		     CLIENT:/usr/local/*", "UNIX-CLIENT:/run/*", "UNIX-
		     CLIENT:/var/run/*")) or   (process.name == "curl" and
		     process.args : ("--unix-socket", "--abstract-unix-socket")) )
		     and not (   process.args == "/var/run/libvirt/libvirt-sock" or
		     process.parent.name in ("bundle", "ruby", "haproxystatus.sh") )

NamE: Network Connections Initiated Through XDG Autostart Entry
	description: 
		     Detects network connections initiated through
		     Cross-Desktop Group (XDG) autostart entries for GNOME and XFCE-
		     based Linux distributions. XDG Autostart entries can be used to
		     execute arbitrary commands or scripts when a user logs in. This
		     rule helps to identify potential malicious activity where an
		     attacker may have modified XDG autostart scripts to establish
		     persistence on the system.
	query: 
		     sequence by host.id, process.entity_id with maxspan=1s
		     [process where host.os.type == "linux" and event.type ==
		     "start" and event.action == "exec" and (
		     (process.parent.executable == "/usr/bin/xfce4-session") or
		     (process.executable == "/bin/sh" and process.args == "-e" and
		     process.args == "-u" and       process.args == "-c" and
		     process.args : "export GIO_LAUNCHED_DESKTOP_FILE_PID=$$;*")
		     )   ]   [network where host.os.type == "linux" and event.type
		     == "start" and event.action == "connection_attempted" and not (
		     destination.ip == null or destination.ip == "0.0.0.0" or
		     cidrmatch(        destination.ip, "10.0.0.0/8", "127.0.0.0/8",
		     "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24",
		     "192.0.0.0/29",        "192.0.0.8/32", "192.0.0.9/32",
		     "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32",
		     "192.0.2.0/24",        "192.31.196.0/24", "192.52.193.0/24",
		     "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4",
		     "100.64.0.0/10",        "192.175.48.0/24","198.18.0.0/15",
		     "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1",
		     "FE80::/10",        "FF00::/8", "172.31.0.0/16"        ) or
		     process.name in (          "telegram-desktop", "firefox",
		     "gnome-calculator", "remmina", "spotify", "librewolf",
		     "fortitraylauncher",          "flameshot", "thunderbird",
		     "update-manager", "warp-terminal", "obs", "transmission-gtk"
		     )      )   ]

NamE: GRUB Configuration File Creation
	description: 
		     This rule detects the creation of GRUB
		     configuration files on Linux systems. The GRUB configuration
		     file is used to configure the boot loader, which is responsible
		     for loading the operating system. Attackers may create
		     malicious GRUB configuration files to execute arbitrary code or
		     escalate privileges during the boot process, which can be
		     leveraged to maintain persistence on the system.
	query: 
		     file where host.os.type == "linux" and event.type ==
		     "creation" and process.executable != null and file.path like~ (
		     "/etc/default/grub.d/*", "/etc/default/grub", "/etc/grub.d/*",
		     "/boot/grub2/grub.cfg", "/boot/grub/grub.cfg",
		     "/boot/efi/EFI/*/grub.cfg",   "/etc/sysconfig/grub" ) and not (
		     process.executable in (     "/bin/dpkg", "/usr/bin/dpkg",
		     "/bin/dockerd", "/usr/bin/dockerd", "/usr/sbin/dockerd",
		     "/bin/microdnf",     "/usr/bin/microdnf", "/bin/rpm",
		     "/usr/bin/rpm", "/bin/snapd", "/usr/bin/snapd", "/bin/yum",
		     "/usr/bin/yum",     "/bin/dnf", "/usr/bin/dnf", "/bin/podman",
		     "/usr/bin/podman", "/bin/dnf-automatic", "/usr/bin/dnf-
		     automatic",     "/bin/pacman", "/usr/bin/pacman",
		     "/usr/bin/dpkg-divert", "/bin/dpkg-divert", "/sbin/apk",
		     "/usr/sbin/apk",     "/usr/local/sbin/apk", "/usr/bin/apt",
		     "/usr/sbin/pacman", "/bin/podman", "/usr/bin/podman",
		     "/usr/bin/puppet",     "/bin/puppet",
		     "/opt/puppetlabs/puppet/bin/puppet", "/usr/bin/chef-client",
		     "/bin/chef-client",     "/bin/autossl_check",
		     "/usr/bin/autossl_check", "/proc/self/exe", "/dev/fd/*",
		     "/usr/bin/pamac-daemon",     "/bin/pamac-daemon",
		     "/usr/lib/snapd/snapd", "/usr/local/bin/dockerd",
		     "/usr/bin/crio", "/usr/sbin/crond",
		     "/opt/puppetlabs/puppet/bin/ruby", "/usr/libexec/platform-
		     python", "/kaniko/kaniko-executor",
		     "/usr/local/bin/dockerd", "/usr/bin/podman", "/bin/install",
		     "/proc/self/exe", "/usr/lib/systemd/systemd",
		     "/usr/sbin/sshd", "/usr/bin/gitlab-runner",
		     "/opt/gitlab/embedded/bin/ruby", "/usr/sbin/gdm",
		     "/usr/bin/install",
		     "/usr/local/manageengine/uems_agent/bin/dcregister",
		     "/usr/local/bin/pacman"   ) or   process.executable like~ (
		     "/nix/store/*", "/var/lib/dpkg/*", "/tmp/vmis.*", "/snap/*",
		     "/dev/fd/*", "/usr/lib/virtualbox/*"   ) or   file.extension in
		     ("swp", "swpx", "swx", "dpkg-remove") or   (process.name ==
		     "sed" and file.name : "sed*") )

NamE: UAC Bypass Attempt via Windows Directory Masquerading
	description: 
		     Identifies an attempt to bypass User Account
		     Control (UAC) by masquerading as a Microsoft trusted Windows
		     directory. Attackers may bypass UAC to stealthily execute code
		     with elevated permissions.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.args : ("C:\\Windows
		     \\system32\\*.exe", "C:\\Windows \\SysWOW64\\*.exe")

NamE: Linux Process Hooking via GDB
	description: 
		     This rule monitors for potential memory dumping
		     through gdb. Attackers may leverage memory dumping techniques
		     to attempt secret extraction from privileged processes. Tools
		     that display this behavior include "truffleproc" and "bash-
		     memory-dump". This behavior should not happen by default, and
		     should be investigated thoroughly.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed", "process_started")  and
		     process.name == "gdb" and process.args in ("--pid", "-p") and
		     /* Covered by d4ff2f53-c802-4d2e-9fb9-9ecc08356c3f */
		     process.args != "1"

NamE: Azure Virtual Network Device Modified or Deleted
	description: 
		     Identifies when a virtual network device is
		     modified or deleted. This can be a network virtual appliance,
		     virtual hub, or virtual router.
	query: 
		     event.dataset:azure.activitylogs and azure.activitylog
		     s.operation_name:("MICROSOFT.NETWORK/NETWORKINTERFACES/TAPCONFI
		     GURATIONS/WRITE" or
		     "MICROSOFT.NETWORK/NETWORKINTERFACES/TAPCONFIGURATIONS/DELETE"
		     or "MICROSOFT.NETWORK/NETWORKINTERFACES/WRITE" or
		     "MICROSOFT.NETWORK/NETWORKINTERFACES/JOIN/ACTION" or
		     "MICROSOFT.NETWORK/NETWORKINTERFACES/DELETE" or
		     "MICROSOFT.NETWORK/NETWORKVIRTUALAPPLIANCES/DELETE" or
		     "MICROSOFT.NETWORK/NETWORKVIRTUALAPPLIANCES/WRITE" or
		     "MICROSOFT.NETWORK/VIRTUALHUBS/DELETE" or
		     "MICROSOFT.NETWORK/VIRTUALHUBS/WRITE" or
		     "MICROSOFT.NETWORK/VIRTUALROUTERS/WRITE" or
		     "MICROSOFT.NETWORK/VIRTUALROUTERS/DELETE") and
		     event.outcome:(Success or success)

NamE: Google Workspace Object Copied to External Drive with App Consent
	description: 
		     Detects when a user copies a Google spreadsheet,
		     form, document or script from an external drive. Sequence logic
		     has been added to also detect when a user grants a custom
		     Google application permission via OAuth shortly after. An
		     adversary may send a phishing email to the victim with a Drive
		     object link where "copy" is included in the URI, thus copying
		     the object to the victim's drive. If a container-bound script
		     exists within the object, execution will require permission
		     access via OAuth in which the user has to accept.
	query: 
		     sequence by source.user.email with maxspan=3m [file
		     where event.dataset == "google_workspace.drive" and
		     event.action == "copy" and      /* Should only match if the
		     object lives in a Drive that is external to the user's GWS
		     organization */     google_workspace.drive.owner_is_team_drive
		     == "false" and google_workspace.drive.copy_type == "external"
		     and      /* Google Script, Forms, Sheets and Document can have
		     container-bound scripts */
		     google_workspace.drive.file.type: ("script", "form",
		     "spreadsheet", "document")]  [any where event.dataset ==
		     "google_workspace.token" and event.action == "authorize" and
		     /* Ensures application ID references custom app in Google
		     Workspace and not GCP */     google_workspace.token.client.id :
		     "*apps.googleusercontent.com"]

NamE: Potential Evasion via Windows Filtering Platform
	description: 
		     Identifies multiple Windows Filtering Platform
		     block events and where the process name is related to an
		     endpoint security software. Adversaries may add malicious WFP
		     rules to prevent Endpoint security from sending telemetry.
	query: 
		     sequence by winlog.computer_name with maxspan=1m
		     [network where host.os.type == "windows" and   event.action :
		     ("windows-firewall-packet-block", "windows-firewall-packet-
		     drop") and   process.name : (         "bdagent.exe",
		     "bdreinit.exe", "pdscan.exe", "pdiface.exe", "BDSubWiz.exe",
		     "ProductAgentService.exe",         "ProductAgentUI.exe",
		     "WatchDog.exe", "CarbonBlackClientSetup.exe", "TrGUI.exe",
		     "TracCAPI.exe", "cpmsi_tool.exe",         "trac.exe",
		     "vna_install64.exe", "vna_utils.exe", "TracSrvWrapper.exe",
		     "vsmon.exe", "p95tray.exe",
		     "CybereasonRansomFreeServiceHost.exe", "CrAmTray.exe",
		     "minionhost.exe", "CybereasonSensor.exe", "CylanceUI.exe",
		     "CylanceProtectSetup.exe", "cylancesvc.exe", "cyupdate.exe",
		     "elastic-agent.exe", "elastic-endpoint.exe",
		     "egui.exe", "minodlogin.exe", "emu-rep.exe", "emu_install.exe",
		     "emu-cci.exe", "emu-gui.exe", "emu-uninstall.exe",
		     "ndep.exe", "spike.exe", "ecls.exe", "ecmd.exe",
		     "ecomserver.exe", "eeclnt.exe", "eh64.exe", "EHttpSrv.exe",
		     "xagt.exe", "collectoragent.exe", "FSAEConfig.exe",
		     "uninstalldcagent.exe", "rmon.exe", "fccomint.exe",
		     "fclanguageselector.exe", "fortifw.exe", "fcreg.exe",
		     "fortitray.exe", "fcappdb.exe", "fcwizard.exe", "submitv.exe",
		     "av_task.exe", "fortiwf.exe", "fortiwadbd.exe", "fcauth.exe",
		     "fcdblog.exe", "fcmgr.exe", "fortiwad.exe",
		     "fortiproxy.exe", "fortiscand.exe", "fortivpnst.exe",
		     "ipsec.exe", "fcwscd7.exe", "fcasc.exe", "fchelper.exe",
		     "forticlient.exe","fcwsc.exe", "FortiClient.exe", "fmon.exe",
		     "FSSOMA.exe", "FCVbltScan.exe", "FortiESNAC.exe",
		     "EPCUserAvatar.exe", "FortiAvatar.exe",
		     "FortiClient_Diagnostic_Tool.exe", "FortiSSLVPNdaemon.exe",
		     "avp.exe",         "FCConfig.exe", "avpsus.exe",
		     "klnagent.exe", "klnsacwsrv.exe", "kl_platf.exe", "stpass.exe",
		     "klnagwds.exe",         "mbae.exe", "mbae64.exe", "mbae-
		     svc.exe", "mbae-uninstaller.exe", "mbaeLoader32.exe",
		     "mbaeloader64.exe",         "mbam-dor.exe", "mbamgui.exe",
		     "mbamservice.exe", "mbamtrayctrl.exe", "mbampt.exe",
		     "mbamscheduler.exe",         "Coreinst.exe", "mbae-setup.exe",
		     "mcupdate.exe", "ProtectedModuleHost.exe", "ESConfigTool.exe",
		     "FWInstCheck.exe",         "FwWindowsFirewallHandler.exe",
		     "mfeesp.exe", "mfefw.exe", "mfeProvisionModeUtility.exe",
		     "mfetp.exe", "avpui.exe",         "WscAVExe.exe",
		     "mcshield.exe", "McChHost.exe", "mfewc.exe", "mfewch.exe",
		     "mfewcui.exe", "fwinfo.exe",         "mfecanary.exe",
		     "mfefire.exe", "mfehidin.exe", "mfemms.exe", "mfevtps.exe",
		     "mmsinfo.exe", "vtpinfo.exe",         "MarSetup.exe",
		     "mctray.exe", "masvc.exe", "macmnsvc.exe", "McAPExe.exe",
		     "McPvTray.exe", "mcods.exe",         "mcuicnt.exe",
		     "mcuihost.exe", "xtray.exe", "McpService.exe",
		     "epefprtrainer.exe", "mfeffcoreservice.exe",
		     "MfeEpeSvc.exe", "qualysagent.exe", "QualysProxy.exe",
		     "QualysAgentUI.exe", "SVRTgui.exe", "SVRTcli.exe",
		     "SVRTcli.exe", "SVRTgui.exe", "SCTCleanupService.exe",
		     "SVRTservice.exe", "native.exe", "SCTBootTasks.exe",
		     "ALMon.exe", "SAA.exe", "SUMService.exe", "ssp.exe",
		     "SCFService.exe", "SCFManager.exe", "spa.exe", "cabarc.exe",
		     "sargui.exe", "sntpservice.exe", "McsClient.exe",
		     "McsAgent.exe", "McsHeartbeat.exe", "SAVAdminService.exe",
		     "sav32cli.exe", "ForceUpdateAlongSideSGN.exe",
		     "SAVCleanupService.exe", "SavMain.exe", "SavProgress.exe",
		     "SavProxy.exe", "SavService.exe", "swc_service.exe",
		     "swi_di.exe", "swi_service.exe", "swi_filter.exe",
		     "ALUpdate.exe", "SophosUpdate.exe", "ALsvc.exe",
		     "SophosAlert.exe", "osCheck.exe", "N360Downloader.exe",
		     "InstWrap.exe", "symbos.exe", "nss.exe", "symcorpui.exe",
		     "isPwdSvc.exe", "ccsvchst.exe", "ntrmv.exe",
		     "pccntmon.exe", "AosUImanager.exe", "NTRTScan.exe",
		     "TMAS_OL.exe", "TMAS_OLImp.exe", "TMAS_OLSentry.exe",
		     "ufnavi.exe", "Clnrbin.exe", "vizorhtmldialog.exe",
		     "pwmConsole.exe", "PwmSvc.exe", "coreServiceShell.exe",
		     "ds_agent.exe", "SfCtlCom.exe", "MBAMHelper.exe", "cb.exe",
		     "smc.exe", "tda.exe", "xagtnotif.exe", "ekrn.exe",
		     "dsa.exe", "Notifier.exe", "rphcp.exe", "lc_sensor.exe",
		     "CSFalconService.exe", "CSFalconController.exe",
		     "SenseSampleUploader.exe", "windefend.exe", "MSASCui.exe",
		     "MSASCuiL.exe", "msmpeng.exe", "msmpsvc.exe",
		     "MsSense.exe", "esensor.exe", "sentinelone.exe", "tmccsf.exe",
		     "csfalconcontainer.exe", "sensecncproxy.exe",
		     "splunk.exe", "sysmon.exe", "sysmon64.exe", "taniumclient.exe"
		     )] with runs=5

NamE: Command and Scripting Interpreter via Windows Scripts
	description: 
		     Identifies PowerShell.exe or Cmd.exe execution
		     spawning from Windows Script Host processes Wscript.exe.
	query: 
		     process where host.os.type == "windows" and
		     event.action == "start" and   process.name : ("powershell.exe",
		     "pwsh.exe", "cmd.exe") and   process.parent.name :
		     ("wscript.exe", "mshta.exe") and ?process.parent.args :
		     "?:\\Users\\*"

NamE: Potential Credential Access via DuplicateHandle in LSASS
	description: 
		     Identifies suspicious access to an LSASS handle
		     via DuplicateHandle from an unknown call trace module. This may
		     indicate an attempt to bypass the NtOpenProcess API to evade
		     detection and dump LSASS memory for credential access.
	query: 
		     process where host.os.type == "windows" and event.code
		     == "10" and   /* LSASS requesting DuplicateHandle access right
		     to another process */  process.name : "lsass.exe" and
		     winlog.event_data.GrantedAccess == "0x40" and   /* call is
		     coming from an unknown executable region */
		     winlog.event_data.CallTrace : "*UNKNOWN*"

NamE: PowerShell Share Enumeration Script
	description: 
		     Detects scripts that contain PowerShell
		     functions, structures, or Windows API functions related to
		     windows share enumeration activities. Attackers, mainly
		     ransomware groups, commonly identify and inspect network
		     shares, looking for critical information for encryption and/or
		     exfiltration.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text:(     "Invoke-ShareFinder" or
		     "Invoke-ShareFinderThreaded" or     (       "shi1_netname" and
		     "shi1_remark"     ) or     (       "NetShareEnum" and
		     "NetApiBufferFree"     )   ) and not user.id : "S-1-5-18"

NamE: SUID/SGUID Enumeration Detected
	description: 
		     This rule monitors for the usage of the "find"
		     command in conjunction with SUID and SGUID permission
		     arguments. SUID (Set User ID) and SGID (Set Group ID) are
		     special permissions in Linux that allow a program to execute
		     with the privileges of the file owner or group, respectively,
		     rather than the privileges of the user running the program. In
		     case an attacker is able to enumerate and find a binary that is
		     misconfigured, they might be able to leverage this
		     misconfiguration to escalate privileges by exploiting
		     vulnerabilities or built-in features in the privileged program.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action == "exec" and process.name ==
		     "find" and process.args : "-perm" and process.args : (
		     "/6000", "-6000", "/4000", "-4000", "/2000", "-2000", "/u=s",
		     "-u=s", "/g=s", "-g=s", "/u=s,g=s", "/g=s,u=s" ) and not (
		     user.Ext.real.id == "0" or group.Ext.real.id == "0" or
		     process.args_count >= 12 or   (process.args : "/usr/bin/pkexec"
		     and process.args : "-xdev" and process.args_count == 7) )

NamE: Potential Privilege Escalation via Recently Compiled Executable
	description: 
		     This rule monitors a sequence involving a
		     program compilation event followed by its execution and a
		     subsequent alteration of UID permissions to root privileges.
		     This behavior can potentially indicate the execution of a
		     kernel or software privilege escalation exploit.
	query: 
		     sequence by host.id with maxspan=1m   [process where
		     host.os.type == "linux" and event.type == "start" and
		     event.action == "exec" and    process.name in ("gcc", "g++",
		     "cc") and user.id != "0"] by process.args   [file where
		     host.os.type == "linux" and event.action == "creation" and
		     event.type == "creation" and    process.name == "ld" and
		     user.id != "0"] by file.name   [process where host.os.type ==
		     "linux" and event.type == "start" and event.action == "exec"
		     and    user.id != "0"] by process.name   [process where
		     host.os.type == "linux" and event.action in ("uid_change",
		     "guid_change") and event.type == "change" and    user.id ==
		     "0"] by process.name

NamE: Potential Cookies Theft via Browser Debugging
	description: 
		     Identifies the execution of a Chromium based
		     browser with the debugging process argument, which may indicate
		     an attempt to steal authentication cookies. An adversary may
		     steal web application or service session cookies and use them
		     to gain access web applications or Internet services as an
		     authenticated user without needing credentials.
	query: 
		     process where event.type in ("start",
		     "process_started", "info") and   process.name in (
		     "Microsoft Edge",              "chrome.exe",
		     "Google Chrome",              "google-chrome-stable",
		     "google-chrome-beta",              "google-chrome",
		     "msedge.exe") and    process.args : ("--remote-debugging-
		     port=*",                    "--remote-debugging-targets=*",
		     "--remote-debugging-pipe=*") and    process.args : "--user-
		     data-dir=*" and not process.args:"--remote-debugging-port=0"

NamE: Execution via TSClient Mountpoint
	description: 
		     Identifies execution from the Remote Desktop
		     Protocol (RDP) shared mountpoint tsclient on the target host.
		     This may indicate a lateral movement attempt.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and process.executable :
		     "\\Device\\Mup\\tsclient\\*.exe"

NamE: Network Connection via Signed Binary
	description: 
		     Binaries signed with trusted digital
		     certificates can execute on Windows systems protected by
		     digital signature validation. Adversaries may use these
		     binaries to 'live off the land' and execute malicious files
		     that could bypass application allowlists and signature
		     validation.
	query: 
		     sequence by process.entity_id   [process where
		     host.os.type == "windows" and (process.name : "expand.exe" or
		     process.name : "extrac32.exe" or                  process.name
		     : "ieexec.exe" or process.name : "makecab.exe") and
		     event.type == "start"]   [network where host.os.type ==
		     "windows" and (process.name : "expand.exe" or process.name :
		     "extrac32.exe" or                  process.name : "ieexec.exe"
		     or process.name : "makecab.exe") and     not
		     cidrmatch(destination.ip,       "10.0.0.0/8", "127.0.0.0/8",
		     "169.254.0.0/16", "172.16.0.0/12", "192.0.0.0/24",
		     "192.0.0.0/29", "192.0.0.8/32",       "192.0.0.9/32",
		     "192.0.0.10/32", "192.0.0.170/32", "192.0.0.171/32",
		     "192.0.2.0/24", "192.31.196.0/24",       "192.52.193.0/24",
		     "192.168.0.0/16", "192.88.99.0/24", "224.0.0.0/4",
		     "100.64.0.0/10", "192.175.48.0/24",       "198.18.0.0/15",
		     "198.51.100.0/24", "203.0.113.0/24", "240.0.0.0/4", "::1",
		     "FE80::/10", "FF00::/8")]

NamE: Attempt to Clear Kernel Ring Buffer
	description: 
		     Monitors for the deletion of the kernel ring
		     buffer events through dmesg. Attackers may clear kernel ring
		     buffer events to evade detection after installing a Linux
		     kernel module (LKM).
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed", "process_started")  and
		     process.name == "dmesg" and process.args in ("-c", "--clear")

NamE: Windows Subsystem for Linux Distribution Installed
	description: 
		     Detects changes to the registry that indicates
		     the install of a new Windows Subsystem for Linux distribution
		     by name. Adversaries may enable and use WSL for Linux to avoid
		     detection.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and registry.value : "PackageFamilyName"
		     and  registry.path : "*\\SOFTWARE\\Microsoft\\Windows\\CurrentV
		     ersion\\Lxss\\*\\PackageFamilyName"

NamE: Openssl Client or Server Activity
	description: 
		     This rule identifies when the openssl client or
		     server is used to establish a connection. Attackers may use
		     openssl to establish a secure connection to a remote server or
		     to create a secure server to receive connections. This activity
		     may be used to exfiltrate data or establish a command and
		     control channel.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start")
		     and   process.name == "openssl" and (     (process.args ==
		     "s_client" and process.args : ("-connect", "*:*") and not
		     process.args == "-showcerts") or     (process.args ==
		     "s_server" and process.args == "-port")   ) and   not
		     process.parent.executable in (
		     "/pro/xymon/client/ext/awsXymonCheck.sh", "/opt/antidot-
		     svc/nrpe/plugins/check_cert",
		     "/etc/zabbix/scripts/check_dane_tlsa.sh"   )

NamE: SSL Certificate Deletion
	description: 
		     This rule detects the deletion of SSL
		     certificates on a Linux system. Adversaries may delete SSL
		     certificates to subvert trust controls and negatively impact
		     the system.
	query: 
		     file where host.os.type == "linux" and event.type ==
		     "deletion" and file.path : "/etc/ssl/certs/*" and
		     file.extension in ("pem", "crt") and not process.name in
		     ("dockerd", "pacman")

NamE: Scheduled Task Created by a Windows Script
	description: 
		     A scheduled task was created by a Windows script
		     via cscript.exe, wscript.exe or powershell.exe. This can be
		     abused by an adversary to establish persistence.
	query: 
		     sequence by host.id with maxspan = 30s   [any where
		     host.os.type == "windows" and      (event.category :
		     ("library", "driver") or (event.category == "process" and
		     event.action : "Image loaded*")) and     (?dll.name :
		     "taskschd.dll" or file.name : "taskschd.dll") and
		     process.name : ("cscript.exe", "wscript.exe", "powershell.exe",
		     "pwsh.exe", "powershell_ise.exe")]   [registry where
		     host.os.type == "windows" and event.type == "change" and
		     registry.value : "Actions" and     registry.path : (
		     "HKLM\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Schedule\\TaskCache\\Tasks\\*\\Actions",
		     "\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows
		     NT\\CurrentVersion\\Schedule\\TaskCache\\Tasks\\*\\Actions"
		     )]

NamE: Mofcomp Activity
	description: 
		     Managed Object Format (MOF) files can be
		     compiled locally or remotely through mofcomp.exe. Attackers may
		     leverage MOF files to build their own namespaces and classes
		     into the Windows Management Instrumentation (WMI) repository,
		     or establish persistence using WMI Event Subscription.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   process.name : "mofcomp.exe" and process.args
		     : "*.mof" and   not user.id : "S-1-5-18" and   not   (
		     process.parent.name : "ScenarioEngine.exe" and     process.args
		     : (       "*\\MSSQL\\Binn\\*.mof",       "*\\Microsoft SQL
		     Server\\???\\Shared\\*.mof",       "*\\OLAP\\bin\\*.mof"     )
		     )

NamE: Suspicious WMIC XSL Script Execution
	description: 
		     Identifies WMIC allowlist bypass techniques by
		     alerting on suspicious execution of scripts. When WMIC loads
		     scripting libraries it may be indicative of an allowlist
		     bypass.
	query: 
		     sequence by process.entity_id with maxspan = 2m
		     [process where host.os.type == "windows" and event.type ==
		     "start" and    (process.name : "WMIC.exe" or
		     process.pe.original_file_name : "wmic.exe") and    process.args
		     : ("format*:*", "/format*:*", "*-format*:*") and    not
		     process.command_line : ("* /format:table *", "*
		     /format:table")] [any where host.os.type == "windows" and
		     (event.category == "library" or (event.category == "process"
		     and event.action : "Image loaded*")) and  (?dll.name :
		     ("jscript.dll", "vbscript.dll") or file.name : ("jscript.dll",
		     "vbscript.dll"))]

NamE: Potential Network Scan Executed From Host
	description: 
		     This threshold rule monitors for the rapid
		     execution of unix utilities that are capable of conducting
		     network scans. Adversaries may leverage built-in tools such as
		     ping, netcat or socat to execute ping sweeps across the network
		     while attempting to evade detection or due to the lack of
		     network mapping tools available on the compromised host.
	query: 
		     event.category:process and host.os.type:linux and
		     event.action:(exec or exec_event or executed or
		     process_started) and event.type:start and process.name:(ping or
		     nping or hping or hping2 or hping3 or nc or ncat or netcat or
		     socat)

NamE: AWS S3 Object Encryption Using External KMS Key
	description: 
		     Identifies `CopyObject` events within an S3
		     bucket using an AWS KMS key from an external account for
		     encryption. Adversaries with access to a misconfigured S3
		     bucket and the proper permissions may encrypt objects with an
		     external KMS key to deny their victims access to their own
		     data.
	query: 
		     from logs-aws.cloudtrail-* metadata _id, _version,
		     _index  // any successful copy event | where event.dataset ==
		     "aws.cloudtrail"     and event.provider == "s3.amazonaws.com"
		     and event.action == "CopyObject"     and event.outcome ==
		     "success"  // abstract key account id, key id, encrypted object
		     bucket name and object name | dissect
		     aws.cloudtrail.request_parameters
		     "{%{?bucketName}=%{target.bucketName},%{?x-amz-server-side-
		     encryption-aws-kms-key-id}=%{?arn}:%{?aws}:%{?kms}:%{?region}:%
		     {key.account.id}:%{?key}/%{keyId},%{?Host}=%{?tls.client.server
		     _name},%{?x-amz-server-side-encryption}=%{?server-side-
		     encryption},%{?x-amz-copy-
		     source}=%{?bucket.objectName},%{?key}=%{target.objectName}}"
		     // filter for s3 objects whose account id is different from the
		     encryption key's account id // add exceptions based on
		     key.account.id or keyId for known external accounts or
		     encryption keys | where cloud.account.id != key.account.id  //
		     keep relevant fields | keep @timestamp,
		     aws.cloudtrail.user_identity.arn, cloud.account.id,
		     event.action, target.bucketName, key.account.id, keyId,
		     target.objectName

NamE: Multiple Logon Failure from the same Source Address
	description: 
		     Identifies multiple consecutive logon failures
		     from the same source address and within a short time interval.
		     Adversaries will often brute force login attempts across
		     multiple users with a common or known password, in an attempt
		     to gain access to accounts.
	query: 
		     sequence by winlog.computer_name, source.ip with
		     maxspan=10s   [authentication where event.action == "logon-
		     failed" and     /* event 4625 need to be logged */
		     winlog.logon.type : "Network" and     source.ip != null and
		     source.ip != "127.0.0.1" and source.ip != "::1" and     not
		     user.name : ("ANONYMOUS LOGON", "-", "*$") and not user.domain
		     == "NT AUTHORITY" and      /*     noisy failure status codes
		     often associated to authentication misconfiguration :
		     0xC000015B - The user has not been granted the requested logon
		     type (also called the logon right) at this machine.
		     0XC000005E - There are currently no logon servers available to
		     service the logon request.      0XC0000133 - Clocks between DC
		     and other computer too far out of sync.      0XC0000192 An
		     attempt was made to logon, but the Netlogon service was not
		     started.     */     not winlog.event_data.Status :
		     ("0xC000015B", "0XC000005E", "0XC0000133", "0XC0000192")] with
		     runs=10

NamE: PowerShell Suspicious Payload Encoded and Compressed
	description: 
		     Identifies the use of .NET functionality for
		     decompression and base64 decoding combined in PowerShell
		     scripts, which malware and security tools heavily use to
		     deobfuscate payloads and load them directly in memory to bypass
		     defenses.
	query: 
		     event.category:process and host.os.type:windows and
		     powershell.file.script_block_text : (     (
		     "System.IO.Compression.DeflateStream" or
		     "System.IO.Compression.GzipStream" or
		     "IO.Compression.DeflateStream" or
		     "IO.Compression.GzipStream"     ) and     FromBase64String   )
		     and   not user.id : "S-1-5-18"

NamE: AdminSDHolder Backdoor
	description: 
		     Detects modifications in the AdminSDHolder
		     object. Attackers can abuse the SDProp process to implement a
		     persistent backdoor in Active Directory. SDProp compares the
		     permissions on protected objects with those defined on the
		     AdminSDHolder object. If the permissions on any of the
		     protected accounts and groups do not match, the permissions on
		     the protected accounts and groups are reset to match those of
		     the domain's AdminSDHolder object, regaining their
		     Administrative Privileges.
	query: 
		     event.code:5136 and
		     winlog.event_data.ObjectDN:CN=AdminSDHolder,CN=System*

NamE: AWS Management Console Brute Force of Root User Identity
	description: 
		     Identifies a high number of failed
		     authentication attempts to the AWS management console for the
		     Root user identity. An adversary may attempt to brute force the
		     password for the Root user identity, as it has complete access
		     to all services and resources for the AWS account.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:signin.amazonaws.com and
		     event.action:ConsoleLogin and
		     aws.cloudtrail.user_identity.type:Root and
		     event.outcome:failure

NamE: GCP Storage Bucket Configuration Modification
	description: 
		     Identifies when the configuration is modified
		     for a storage bucket in Google Cloud Platform (GCP). An
		     adversary may modify the configuration of a storage bucket in
		     order to weaken the security controls of their target's
		     environment.
	query: 
		     event.dataset:gcp.audit and
		     event.action:"storage.buckets.update" and event.outcome:success

NamE: Successful SSH Authentication from Unusual User
	description: 
		     This rule leverages the new_terms rule type to
		     detect successful SSH authentications by a user who has not
		     been authenticated in the last 10 days. This behavior may
		     indicate an attacker attempting to gain access to the system
		     using a valid account.
	query: 
		     event.category:authentication and host.os.type:linux
		     and event.action:ssh_login and event.outcome:success

NamE: User Added as Owner for Azure Service Principal
	description: 
		     Identifies when a user is added as an owner for
		     an Azure service principal. The service principal object
		     defines what the application can do in the specific tenant, who
		     can access the application, and what resources the app can
		     access. A service principal object is created when an
		     application is given permission to access resources in a
		     tenant. An adversary may add a user account as an owner for a
		     service principal and use that account in order to define what
		     an application can do in the Azure AD tenant.
	query: 
		     event.dataset:azure.auditlogs and
		     azure.auditlogs.operation_name:"Add owner to service principal"
		     and event.outcome:(Success or success)

NamE: AWS S3 Bucket Enumeration or Brute Force
	description: 
		     Identifies a high number of failed S3 operations
		     from a single source and account (or anonymous account) within
		     a short timeframe. This activity can be indicative of
		     attempting to cause an increase in billing to an account for
		     excessive random operations, cause resource exhaustion, or
		     enumerating bucket names for discovery.
	query: 
		     from logs-aws.cloudtrail* | where event.provider ==
		     "s3.amazonaws.com" and aws.cloudtrail.error_code ==
		     "AccessDenied" // keep only relevant fields | keep
		     tls.client.server_name, source.address, cloud.account.id |
		     stats failed_requests = count(*) by tls.client.server_name,
		     source.address, cloud.account.id   // can modify the failed
		     request count or tweak time window to fit environment   // can
		     add `not cloud.account.id in (KNOWN)` or specify in exceptions
		     | where failed_requests > 40

NamE: Kernel Driver Load
	description: 
		     Detects the loading of a Linux kernel module
		     through system calls. Threat actors may leverage Linux kernel
		     modules to load a rootkit on a system providing them with
		     complete control and the ability to hide from security
		     products. As other rules monitor for the addition of Linux
		     kernel modules through system utilities or .ko files, this rule
		     covers the gap that evasive rootkits leverage by monitoring for
		     kernel module additions on the lowest level through
		     auditd_manager.
	query: 
		     driver where host.os.type == "linux" and event.action
		     == "loaded-kernel-module" and auditd.data.syscall in
		     ("init_module", "finit_module")

NamE: Successful Application SSO from Rare Unknown Client Device
	description: 
		     Detects successful single sign-on (SSO) events
		     to Okta applications from an unrecognized or "unknown" client
		     device, as identified by the user-agent string. This activity
		     may be indicative of exploitation of a vulnerability in Okta's
		     Classic Engine, which could allow an attacker to bypass
		     application-specific sign-on policies, such as device or
		     network restrictions. The vulnerability potentially enables
		     unauthorized access to applications using only valid, stolen
		     credentials, without requiring additional authentication
		     factors.
	query: 
		     event.dataset: "okta.system"     and event.action:
		     "user.authentication.sso"     and event.outcome: "success"
		     and okta.client.device: ("Unknown" or "unknown")

NamE: AWS SSM `SendCommand` Execution by Rare User
	description: 
		     Detects the execution of commands or scripts on
		     EC2 instances using AWS Systems Manager (SSM), such as
		     `RunShellScript`, `RunPowerShellScript` or custom documents.
		     While legitimate users may employ these commands for management
		     tasks, they can also be exploited by attackers with credentials
		     to establish persistence, install malware, or execute reverse
		     shells for further access to compromised instances. This is a
		     [New
		     Terms](https://www.elastic.co/guide/en/security/current/rules-
		     ui-create.html#create-new-terms-rule) rule that looks for the
		     first instance of this behavior by the
		     `aws.cloudtrail.user_identity.arn` field in the last 7 days.
	query: 
		     event.dataset: "aws.cloudtrail"     and
		     event.provider: "ssm.amazonaws.com"     and event.action:
		     "SendCommand"     and event.outcome: "success"     and not
		     aws.cloudtrail.user_identity.arn:
		     *AWSServiceRoleForAmazonSSM/StateManagerService*     and not
		     source.address: (       "ssm-guiconnect.amazonaws.com" or
		     "ssm.amazonaws.com" or       "inspector2.amazonaws.com"     )

NamE: Potential Remote Desktop Shadowing Activity
	description: 
		     Identifies the modification of the Remote
		     Desktop Protocol (RDP) Shadow registry or the execution of
		     processes indicative of an active RDP shadowing session. An
		     adversary may abuse the RDP Shadowing feature to spy on or
		     control other users active RDP sessions.
	query: 
		     /* Identifies the modification of RDP Shadow registry
		     or   the execution of processes indicative of active shadow RDP
		     session */  any where host.os.type == "windows" and (
		     (event.category == "registry" and      registry.path : (
		     "HKLM\\Software\\Policies\\Microsoft\\Windows NT\\Terminal
		     Services\\Shadow",
		     "\\REGISTRY\\MACHINE\\Software\\Policies\\Microsoft\\Windows
		     NT\\Terminal Services\\Shadow",
		     "MACHINE\\Software\\Policies\\Microsoft\\Windows NT\\Terminal
		     Services\\Shadow"     )   ) or   (event.category == "process"
		     and event.type == "start" and      (process.name :
		     ("RdpSaUacHelper.exe", "RdpSaProxy.exe") and
		     process.parent.name : "svchost.exe") or
		     (?process.pe.original_file_name : "mstsc.exe" and process.args
		     : "/shadow:*")   ) )

NamE: Potential Modification of Accessibility Binaries
	description: 
		     Windows contains accessibility features that may
		     be launched with a key combination before a user has logged in.
		     An adversary can modify the way these programs are launched to
		     get a command prompt or backdoor without logging in to the
		     system.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  process.parent.name : ("Utilman.exe",
		     "winlogon.exe") and user.name == "SYSTEM" and
		     process.pe.original_file_name : "?*" and  process.args :     (
		     "C:\\Windows\\System32\\osk.exe",
		     "C:\\Windows\\System32\\Magnify.exe",
		     "C:\\Windows\\System32\\Narrator.exe",
		     "C:\\Windows\\System32\\Sethc.exe",     "utilman.exe",
		     "ATBroker.exe",     "DisplaySwitch.exe",     "sethc.exe"     )
		     and not process.pe.original_file_name in     (     "osk.exe",
		     "sethc.exe",     "utilman2.exe",     "DisplaySwitch.exe",
		     "ATBroker.exe",     "ScreenMagnifier.exe",     "SR.exe",
		     "Narrator.exe",     "magnify.exe",     "MAGNIFY.EXE"     )  /*
		     uncomment once in winlogbeat to avoid bypass with rogue process
		     with matching pe original file name */ /* and
		     process.code_signature.subject_name == "Microsoft Windows" and
		     process.code_signature.status == "trusted" */

NamE: Machine Learning Detected a DNS Request Predicted to be a DGA Domain
	description: 
		     A supervised machine learning model has
		     identified a DNS question name that is predicted to be the
		     result of a Domain Generation Algorithm (DGA), which could
		     indicate command and control network activity.
	query: 
		     ml_is_dga.malicious_prediction:1 and not
		     dns.question.registered_domain:avsvmcloud.com

NamE: Potential Azure OpenAI Model Theft
	description: 
		     Monitors for suspicious activities that may
		     indicate theft or unauthorized duplication of machine learning
		     (ML) models, such as unauthorized API calls, atypical access
		     patterns, or large data transfers that are unusual during model
		     interactions.
	query: 
		     from logs-azure_openai.logs-* | where
		     azure.open_ai.operation_name == "ListKey" and
		     azure.open_ai.category == "Audit" | KEEP @timestamp,
		     azure.open_ai.operation_name , azure.open_ai.category,
		     azure.resource.group, azure.resource.name,
		     azure.open_ai.properties.response_length | stats count =
		     count(), max_data_transferred =
		     max(azure.open_ai.properties.response_length) by
		     azure.resource.group , azure.resource.name | where count >= 100
		     or max_data_transferred >= 1000000 | sort count desc

NamE: AWS Bedrock Detected Multiple Validation Exception Errors by a Single User
	description: 
		     Identifies multiple validation exeception errors
		     within AWS Bedrock. Validation errors occur when you run the
		     InvokeModel or InvokeModelWithResponseStream APIs on a
		     foundation model that uses an incorrect inference parameter or
		     corresponding value. These errors also occur when you use an
		     inference parameter for one model with a model that doesn't
		     have the same API parameter. This could indicate attempts to
		     bypass limitations of other approved models, or to force an
		     impact on the environment by incurring exhorbitant costs.
	query: 
		     from logs-aws_bedrock.invocation-* // truncate the
		     timestamp to a 1-minute window | eval target_time_window =
		     DATE_TRUNC(1 minutes, @timestamp) | where
		     gen_ai.response.error_code == "ValidationException" | keep
		     user.id, gen_ai.request.model.id, cloud.account.id,
		     gen_ai.response.error_code, target_time_window // count the
		     number of users causing validation errors within a 1 minute
		     window | stats total_denials = count(*) by target_time_window,
		     user.id, cloud.account.id | where total_denials > 3

NamE: PowerShell Mailbox Collection Script
	description: 
		     Detects PowerShell scripts that can be used to
		     collect data from mailboxes. Adversaries may target user email
		     to collect sensitive information.
	query: 
		     event.category:process and host.os.type:windows and
		     (    powershell.file.script_block_text : (
		     "Microsoft.Office.Interop.Outlook" or
		     "Interop.Outlook.olDefaultFolders" or       "::olFolderInBox"
		     ) or    powershell.file.script_block_text : (
		     "Microsoft.Exchange.WebServices.Data.Folder" or
		     "Microsoft.Exchange.WebServices.Data.FileAttachment"    )   )
		     and not user.id : "S-1-5-18"

NamE: AWS Route Table Created
	description: 
		     Identifies when an AWS Route Table has been
		     created.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:ec2.amazonaws.com and event.action:(CreateRoute
		     or CreateRouteTable) and event.outcome:success

NamE: Azure Blob Permissions Modification
	description: 
		     Identifies when the Azure role-based access
		     control (Azure RBAC) permissions are modified for an Azure
		     Blob. An adversary may modify the permissions on a blob to
		     weaken their target's security controls or an administrator may
		     inadvertently modify the permissions, which could lead to data
		     exposure or loss.
	query: 
		     event.dataset:azure.activitylogs and
		     azure.activitylogs.operation_name:(      "MICROSOFT.STORAGE/STO
		     RAGEACCOUNTS/BLOBSERVICES/CONTAINERS/BLOBS/MANAGEOWNERSHIP/ACTI
		     ON" or      "MICROSOFT.STORAGE/STORAGEACCOUNTS/BLOBSERVICES/CON
		     TAINERS/BLOBS/MODIFYPERMISSIONS/ACTION") and
		     event.outcome:(Success or success)

NamE: First Occurrence of User-Agent For a GitHub User
	description: 
		     Detects a new user agent used for a GitHub user
		     not previously seen in the last 14 days.
	query: 
		     event.dataset:"github.audit" and
		     event.category:"configuration" and github.user_agent:* and
		     user.name:*

NamE: New Okta Identity Provider (IdP) Added by Admin
	description: 
		     Detects the creation of a new Identity Provider
		     (IdP) by a Super Administrator or Organization Administrator
		     within Okta.
	query: 
		     event.dataset: "okta.system" and event.action:
		     "system.idp.lifecycle.create" and okta.outcome.result:
		     "SUCCESS"

NamE: Deprecated - File Made Executable via Chmod Inside A Container
	description: 
		     This rule detects when chmod is used to add the
		     execute permission to a file inside a container. Modifying file
		     permissions to make a file executable could indicate malicious
		     activity, as an attacker may attempt to run unauthorized or
		     malicious code inside the container.
	query: 
		     file where container.id: "*" and event.type in
		     ("change", "creation") and  /*account for tools that execute
		     utilities as a subprocess, in this case the target utility name
		     will appear as a process arg*/ (process.name : "chmod" or
		     process.args : "chmod") and process.args : ("*x*", "777",
		     "755", "754", "700") and not process.args: "-x"

NamE: Kubernetes Suspicious Assignment of Controller Service Account
	description: 
		     This rule detects a request to attach a
		     controller service account to an existing or new pod running in
		     the kube-system namespace. By default, controllers running as
		     part of the API Server utilize admin-equivalent service
		     accounts hosted in the kube-system namespace. Controller
		     service accounts aren't normally assigned to running pods and
		     could indicate adversary behavior within the cluster. An
		     attacker that can create or modify pods or pod controllers in
		     the kube-system namespace, can assign one of these admin-
		     equivalent service accounts to a pod and abuse their powerful
		     token to escalate privileges and gain complete cluster control.
	query: 
		     event.dataset : "kubernetes.audit_logs"   and kubernet
		     es.audit.annotations.authorization_k8s_io/decision:"allow"
		     and kubernetes.audit.verb : "create"   and
		     kubernetes.audit.objectRef.resource : "pods"   and
		     kubernetes.audit.objectRef.namespace : "kube-system"   and kube
		     rnetes.audit.requestObject.spec.serviceAccountName:*controller

NamE: GCP Logging Bucket Deletion
	description: 
		     Identifies a Logging bucket deletion in Google
		     Cloud Platform (GCP). Log buckets are containers that store and
		     organize log data. A deleted bucket stays in a pending state
		     for 7 days, and Logging continues to route logs to the bucket
		     during that time. To stop routing logs to a deleted bucket, you
		     can delete the log sinks that have the bucket as their
		     destination, or modify the filter for the sinks to stop it from
		     routing logs to the deleted bucket. An adversary may delete a
		     log bucket to evade detection.
	query: 
		     event.dataset:gcp.audit and event.action:google.loggin
		     g.v*.ConfigServiceV*.DeleteBucket and event.outcome:success

NamE: Privileged Account Brute Force
	description: 
		     Identifies multiple consecutive logon failures
		     targeting an Admin account from the same source address and
		     within a short time interval. Adversaries will often brute
		     force login attempts across multiple users with a common or
		     known password, in an attempt to gain access to accounts.
	query: 
		     sequence by winlog.computer_name, source.ip with
		     maxspan=10s   [authentication where event.action == "logon-
		     failed" and winlog.logon.type : "Network" and     source.ip !=
		     null and source.ip != "127.0.0.1" and source.ip != "::1" and
		     user.name : "*admin*" and      /* noisy failure status codes
		     often associated to authentication misconfiguration */     not
		     winlog.event_data.Status : ("0xC000015B", "0XC000005E",
		     "0XC0000133", "0XC0000192")] with runs=5

NamE: MS Office Macro Security Registry Modifications
	description: 
		     Microsoft Office Products offer options for
		     users and developers to control the security settings for
		     running and using Macros. Adversaries may abuse these security
		     settings to modify the default behavior of the Office
		     Application to trust future macros and/or disable security
		     warnings, which could increase their chances of establishing
		     persistence.
	query: 
		     registry where host.os.type == "windows" and
		     event.type == "change" and registry.value : ("AccessVBOM",
		     "VbaWarnings") and     registry.path : (         /* Sysmon */
		     "HKU\\S-1-5-21-
		     *\\SOFTWARE\\Microsoft\\Office\\*\\Security\\AccessVBOM",
		     "HKU\\S-1-5-21-
		     *\\SOFTWARE\\Microsoft\\Office\\*\\Security\\VbaWarnings",
		     "HKU\\S-1-12-1-
		     *\\SOFTWARE\\Microsoft\\Office\\*\\Security\\AccessVBOM",
		     "HKU\\S-1-12-1-
		     *\\SOFTWARE\\Microsoft\\Office\\*\\Security\\VbaWarnings",
		     /* MDE */         "HKCU\\S-1-5-21-
		     *\\SOFTWARE\\Microsoft\\Office\\*\\Security\\AccessVBOM",
		     "HKCU\\S-1-5-21-
		     *\\SOFTWARE\\Microsoft\\Office\\*\\Security\\VbaWarnings",
		     "HKCU\\S-1-12-1-
		     *\\SOFTWARE\\Microsoft\\Office\\*\\Security\\AccessVBOM",
		     "HKCU\\S-1-12-1-
		     *\\SOFTWARE\\Microsoft\\Office\\*\\Security\\VbaWarnings",
		     /* Endgame */         "\\REGISTRY\\USER\\S-1-5-21-
		     *\\SOFTWARE\\Microsoft\\Office\\*\\Security\\AccessVBOM",
		     "\\REGISTRY\\USER\\S-1-5-21-
		     *\\SOFTWARE\\Microsoft\\Office\\*\\Security\\VbaWarnings",
		     "\\REGISTRY\\USER\\S-1-12-1-
		     *\\SOFTWARE\\Microsoft\\Office\\*\\Security\\AccessVBOM",
		     "\\REGISTRY\\USER\\S-1-12-1-
		     *\\SOFTWARE\\Microsoft\\Office\\*\\Security\\VbaWarnings",
		     /* SentinelOne */         "USER\\S-1-5-21-
		     *\\SOFTWARE\\Microsoft\\Office\\*\\Security\\AccessVBOM",
		     "USER\\S-1-5-21-
		     *\\SOFTWARE\\Microsoft\\Office\\*\\Security\\VbaWarnings",
		     "USER\\S-1-12-1-
		     *\\SOFTWARE\\Microsoft\\Office\\*\\Security\\AccessVBOM",
		     "USER\\S-1-12-1-
		     *\\SOFTWARE\\Microsoft\\Office\\*\\Security\\VbaWarnings"
		     ) and     registry.data.strings : ("0x00000001", "1")

NamE: AWS STS GetSessionToken Abuse
	description: 
		     Identifies the suspicious use of
		     GetSessionToken. Tokens could be created and used by attackers
		     to move laterally and escalate privileges.
	query: 
		     event.dataset:aws.cloudtrail and
		     event.provider:sts.amazonaws.com and
		     event.action:GetSessionToken and
		     aws.cloudtrail.user_identity.type:IAMUser and
		     event.outcome:success

NamE: Potential Reverse Shell
	description: 
		     This detection rule identifies suspicious
		     network traffic patterns associated with TCP reverse shell
		     activity. This activity consists of a parent-child relationship
		     where a network event is followed by the creation of a shell
		     process. An attacker may establish a Linux TCP reverse shell to
		     gain remote access to a target system.
	query: 
		     sequence by host.id with maxspan=5s   [network where
		     event.type == "start" and host.os.type == "linux" and
		     event.action in ("connection_attempted", "connection_accepted")
		     and      process.name : ("bash", "dash", "sh", "tcsh", "csh",
		     "zsh", "ksh", "fish", "socat") and destination.ip != null and
		     not cidrmatch(destination.ip, "127.0.0.0/8", "169.254.0.0/16",
		     "224.0.0.0/4", "::1")] by process.entity_id   [process where
		     event.type == "start" and host.os.type == "linux" and
		     event.action in ("exec", "fork") and      process.name in
		     ("bash", "dash", "sh", "tcsh", "csh", "zsh", "ksh", "fish") and
		     (        (process.args : ("-i", "-l")) or (process.parent.name
		     == "socat" and process.parent.args : "*exec*")    )] by
		     process.parent.entity_id

NamE: Execution from a Removable Media with Network Connection
	description: 
		     Identifies process execution from a removable
		     media and by an unusual process. Adversaries may move onto
		     systems, possibly those on disconnected or air-gapped networks,
		     by copying malware to removable media and taking advantage of
		     Autorun features when the media is inserted into a system and
		     executes.
	query: 
		     sequence by process.entity_id with maxspan=5m
		     [process where host.os.type == "windows" and event.action ==
		     "start" and    /* Direct Exec from USB */
		     (process.Ext.device.bus_type : "usb" or
		     process.Ext.device.product_id : "USB *") and
		     (process.code_signature.trusted == false or
		     process.code_signature.exists == false) and    not
		     process.code_signature.status : ("errorExpired",
		     "errorCode_endpoint*")]  [network where host.os.type ==
		     "windows" and event.action == "connection_attempted"]

NamE: Executable Bit Set for Potential Persistence Script
	description: 
		     This rule monitors for the addition of an
		     executable bit for scripts that are located in directories
		     which are commonly abused for persistence. An alert of this
		     rule is an indicator that a persistence mechanism is being set
		     up within your environment. Adversaries may create these
		     scripts to execute malicious code at start-up, or at a set
		     interval to gain persistence onto the system.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and event.action in ("exec", "exec_event", "start")
		     and process.args : (   // Misc.   "/etc/rc.local",
		     "/etc/rc.common", "/etc/rc.d/rc.local", "/etc/init.d/*",
		     "/etc/update-motd.d/*",   "/etc/apt/apt.conf.d/*",
		     "/etc/cron*", "/etc/init/*",
		     "/etc/NetworkManager/dispatcher.d/*",
		     "/lib/dracut/modules.d/*", "/usr/lib/dracut/modules.d/*",    //
		     XDG   "/etc/xdg/autostart/*", "/home/*/.config/autostart/*",
		     "/root/.config/autostart/*",
		     "/home/*/.local/share/autostart/*",
		     "/root/.local/share/autostart/*", "/home/*/.config/autostart-
		     scripts/*",   "/root/.config/autostart-scripts/*",
		     "/etc/xdg/autostart/*", "/usr/share/autostart/*",    // udev
		     "/lib/udev/*", "/etc/udev/rules.d/*",
		     "/usr/lib/udev/rules.d/*", "/run/udev/rules.d/*"  ) and (
		     (process.name == "chmod" and process.args : ("+x*", "1*", "3*",
		     "5*", "7*")) or   (process.name == "install" and process.args :
		     "-m*" and process.args : ("7*", "5*", "3*", "1*")) ) and not (
		     process.parent.executable : "/var/lib/dpkg/*" or
		     process.command_line in ("chmod 777 /etc/update-motd.d/",
		     "chmod 755 /etc/update-motd.d/") )

NamE: ESXI Discovery via Grep
	description: 
		     Identifies instances where a process named
		     'grep', 'egrep', or 'pgrep' is started on a Linux system with
		     arguments related to virtual machine (VM) files, such as
		     "vmdk", "vmx", "vmxf", "vmsd", "vmsn", "vswp", "vmss", "nvram",
		     or "vmem". These file extensions are associated with VM-related
		     file formats, and their presence in grep command arguments may
		     indicate that a threat actor is attempting to search for,
		     analyze, or manipulate VM files on the system.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and   event.action in ("exec", "exec_event",
		     "start", "executed", "process_started") and   process.name in
		     ("grep", "egrep", "pgrep") and   process.args in ("vmdk",
		     "vmx", "vmxf", "vmsd", "vmsn", "vswp", "vmss", "nvram", "vmem")
		     and   not process.parent.executable ==
		     "/usr/share/qemu/init/qemu-kvm-init"

NamE: Machine Learning Detected a Suspicious Windows Event with a Low Malicious Probability Score
	description: 
		     A supervised machine learning model
		     (ProblemChild) has identified a suspicious Windows process
		     event with low probability of it being malicious activity.
		     Alternatively, the model's blocklist identified the event as
		     being malicious.
	query: 
		     process where ((problemchild.prediction == 1 and
		     problemchild.prediction_probability <= 0.98) or blocklist_label
		     == 1) and not process.args :
		     ("*C:\\WINDOWS\\temp\\nessus_*.txt*",
		     "*C:\\WINDOWS\\temp\\nessus_*.tmp*")

NamE: Outlook Home Page Registry Modification
	description: 
		     Identifies modifications in registry keys
		     associated with abuse of the Outlook Home Page functionality
		     for command and control or persistence.
	query: 
		     registry where host.os.type == "windows" and
		     event.action != "deletion" and registry.value : "URL" and
		     registry.path : (         "HKCU\\*\\SOFTWARE\\Microsoft\\Office
		     \\*\\Outlook\\Webview\\Inbox\\URL",         "HKEY_USERS\\*\\SOF
		     TWARE\\Microsoft\\Office\\*\\Outlook\\Webview\\Inbox\\URL",
		     "HKU\\*\\SOFTWARE\\Microsoft\\Office\\*\\Outlook\\Webview\\Inbo
		     x\\URL",         "\\REGISTRY\\USER\\*\\SOFTWARE\\Microsoft\\Off
		     ice\\*\\Outlook\\Webview\\Inbox\\URL",         "USER\\*\\SOFTWA
		     RE\\Microsoft\\Office\\*\\Outlook\\Webview\\Inbox\\URL"     )
		     and registry.data.strings : "*http*"

NamE: Modification of Boot Configuration
	description: 
		     Identifies use of bcdedit.exe to delete boot
		     configuration data. This tactic is sometimes used as by malware
		     or an attacker as a destructive technique.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and   (process.name : "bcdedit.exe" or
		     ?process.pe.original_file_name == "bcdedit.exe") and     (
		     (process.args : "/set" and process.args : "bootstatuspolicy"
		     and process.args : "ignoreallfailures") or       (process.args
		     : "no" and process.args : "recoveryenabled")     )

NamE: File Creation by Cups or Foomatic-rip Child
	description: 
		     This detection rule addresses multiple
		     vulnerabilities in the CUPS printing system, including
		     CVE-2024-47176, CVE-2024-47076, CVE-2024-47175, and
		     CVE-2024-47177. Specifically, this rule detects suspicious file
		     creation events executed by child processes of foomatic-rip.
		     These flaws impact components like cups-browsed,
		     libcupsfilters, libppd, and foomatic-rip, allowing remote
		     unauthenticated attackers to manipulate IPP URLs or inject
		     malicious data through crafted UDP packets or network spoofing.
		     This can result in arbitrary command execution when a print job
		     is initiated.
	query: 
		     sequence by host.id with maxspan=10s   [process where
		     host.os.type == "linux" and event.type == "start" and
		     event.action in ("exec", "start") and    process.parent.name ==
		     "foomatic-rip" and    process.name in ("bash", "dash", "sh",
		     "tcsh", "csh", "zsh", "ksh", "fish")] by process.entity_id
		     [file where host.os.type == "linux" and event.type !=
		     "deletion" and    not (process.name == "gs" and file.path like
		     "/tmp/gs_*")] by process.parent.entity_id

NamE: Docker Escape via Nsenter
	description: 
		     This rule identifies a UID change event via
		     `nsenter`. The `nsenter` command is used to enter a namespace,
		     which is a way to isolate processes and resources. Attackers
		     can use `nsenter` to escape from a container to the host, which
		     can lead to privilege escalation and lateral movement.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "change" and event.action == "uid_change" and
		     process.entry_leader.entry_meta.type == "container" and
		     process.args == "nsenter" and process.args in ("-t", "--
		     target") and process.args_count >= 4

NamE: Execution of a Downloaded Windows Script
	description: 
		     Identifies the creation of a Windows script
		     downloaded from the internet followed by the execution of a
		     scripting utility. Adversaries may use Windows script files for
		     initial access and execution.
	query: 
		     sequence by host.id, user.id with maxspan=3m [file
		     where host.os.type == "windows" and event.action == "creation"
		     and user.id != "S-1-5-18" and   process.name : ("chrome.exe",
		     "msedge.exe", "brave.exe", "browser.exe", "dragon.exe",
		     "vivaldi.exe", "explorer.exe", "winrar.exe", "7zFM.exe",
		     "7zG.exe", "Bandizip.exe") and   file.extension in~ ("js",
		     "jse", "vbs", "vbe", "wsh", "hta", "cmd", "bat") and
		     (file.origin_url != null or file.origin_referrer_url != null)]
		     [process where host.os.type == "windows" and event.type ==
		     "start" and  process.parent.name : ("chrome.exe", "msedge.exe",
		     "brave.exe", "firefox.exe", "browser.exe", "dragon.exe",
		     "vivaldi.exe", "explorer.exe", "winrar.exe", "7zFM.exe",
		     "7zG.exe", "Bandizip.exe") and   process.args_count >= 2 and  (
		     process.name in~ ("wscript.exe", "mshta.exe") or
		     (process.name : "cmd.exe" and process.command_line : ("*.cmd*",
		     "*.bat*"))   )]

NamE: Potential Linux Backdoor User Account Creation
	description: 
		     Identifies the attempt to create a new backdoor
		     user by setting the user's UID to 0. Attackers may alter a
		     user's UID to 0 to establish persistence on a system.
	query: 
		     process where host.os.type == "linux" and event.type
		     == "start" and  event.action in ("exec", "exec_event", "start",
		     "ProcessRollup2", "executed", "process_started")  and
		     process.name == "usermod" and process.args : "-u" and
		     process.args : "0" and process.args : "-o"

NamE: Remote Desktop File Opened from Suspicious Path
	description: 
		     Identifies attempts to open a remote desktop
		     file from suspicious paths. Adversaries may abuse RDP files for
		     initial access.
	query: 
		     process where host.os.type == "windows" and event.type
		     == "start" and  process.name : "mstsc.exe" and  process.args :
		     ("?:\\Users\\*\\Downloads\\*.rdp",
		     "?:\\Users\\*\\AppData\\Local\\Temp\\Temp?_*.rdp",
		     "?:\\Users\\*\\AppData\\Local\\Temp\\7z*.rdp",
		     "?:\\Users\\*\\AppData\\Local\\Temp\\Rar$*\\*.rdp",
		     "?:\\Users\\*\\AppData\\Local\\Temp\\BNZ.*.rdp",
		     "C:\\Users\\*\\AppData\\Local\\Microsoft\\Windows\\INetCache\\C
		     ontent.Outlook\\*.rdp")

None
